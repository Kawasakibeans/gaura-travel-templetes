<?php
/**
 * Template Name: User Portal
 * Template Post Type: post, page
 *
 * @package WordPress
 * @subpackage Twenty_Twenty
 * @since Twenty Twenty 1.0
 */

if (isset($_POST['bulk_edit'])) { 
    // Nonce check (must match what you add in JS: wp_create_nonce("bulk_edit_refund"))
    if (empty($_POST['_wpnonce_bulk_edit']) || !wp_verify_nonce($_POST['_wpnonce_bulk_edit'], 'bulk_edit_refund')) {
        wp_die('Security check failed.');
    }

    $case_id = isset($_POST['case_id']) ? (int)$_POST['case_id'] : 0;
    if ($case_id <= 0) wp_die('Missing case_id.');

    $data = isset($_POST['data']) && is_array($_POST['data']) ? $_POST['data'] : [];
    if (!$data) {
        // nothing to update; PRG anyway
        wp_safe_redirect(add_query_arg(['saved' => '0']));
        exit;
    }

    global $wpdb;
    $T = 'wpk4_backend_user_portal_request_meta';

    // IMPORTANT: require UNIQUE(case_id, meta_key) on this table.
    // Normalize a passenger key the same way you render it in the table.
    if (!function_exists('normalize_passenger_key')) {
        function normalize_passenger_key($name) {
            $key = sanitize_title($name);
            return strtolower(trim($key));
        }
    }

    // Which per-passenger fields we accept
    $allowed = [
        'passenger_paid' => 'money',
        'cancellation_fee' => 'money',
        'refund_amount' => 'money',
        'refund_received_from_airline' => 'money',
        'diff' => 'money',
        'account_name' => 'text',
        'bsb' => 'text',
        'account_number' => 'text',
        'refund_received_date' => 'date',
        'vendor' => 'text',
        'booking_type' => 'text',
        'remarks' => 'text',
        'submitted_date' => 'date',
    ];

    foreach ($data as $passenger_key => $fields) {
        $pkey = normalize_passenger_key((string)$passenger_key);
        if ($pkey === '' || !is_array($fields)) continue;

        foreach ($fields as $field => $raw) {
            if (!isset($allowed[$field])) continue; // ignore unknowns

            $type = $allowed[$field];
            $val = (string)$raw;

            // Sanitize by type
            if ($type === 'money') {
                $val = str_replace(',', '.', $val);
                $val = preg_replace('/[^0-9.\-]/', '', $val);
                if ($val === '' || $val === '-' || $val === '.') $val = '0';
                $val = number_format((float)$val, 2, '.', '');
            } elseif ($type === 'date') {
                $ts = strtotime($val);
                $val = $ts ? date('Y-m-d', $ts) : '';
            } else { // text
                $val = sanitize_text_field($val);
            }

            // Compose meta_key exactly like the rest of your code does:
            // e.g. refund_amount--john-doe
            $meta_key = strtolower(trim($field.'--'.$pkey));

            // Upsert (requires UNIQUE(case_id, meta_key))
            $sql = "
                INSERT INTO `$T` (case_id, meta_key, meta_value)
                VALUES (%d, %s, %s)
                ON DUPLICATE KEY UPDATE meta_value = VALUES(meta_value)
            ";
            $wpdb->query($wpdb->prepare($sql, $case_id, $meta_key, $val));
        }
    }

    // Post-Redirect-Get: back to the same page with a flash param
    wp_safe_redirect(add_query_arg(['saved' => '1']));
    exit;
}

get_header();?>

<div class='wpb_column vc_column_container vc_col-sm-12' id='manage_bookings' style='width:80%;margin:auto;padding:20px 0px;'>
<?php
//ini_set('display_errors', '1');
//ini_set('display_startup_errors', '1');
//error_reporting(E_ALL);
date_default_timezone_set("Australia/Melbourne"); 
include "tpl_contralized_functions.php";
include("wp-config-custom.php");
include('vendor/autoload.php');
$current_date_and_time = date("Y-m-d H:i:s");
global $current_user;
$currnt_userlogined = $current_user->user_login;
$user_roles = $current_user->roles;
$user_role = array_shift($user_roles);


$refund_user_roles = array('administrator', 'ho_operations', 'user_portal_refund_editor_admin_2', 'user_portal_refund_editor_admin', 'user_portal_refund_editor', 'user_portal_refund_user');
$refund_user_roles_generic = array('CmbCS','CmbTK');

$complaint_user_roles = array('administrator', 'ho_operations', 'user_portal_complaint_editor_admin', 'user_portal_complaint_editor', 'user_portal_complaint_user');
$complaint_user_roles_generic = array('CmbCS','CmbTK');

$datechange_user_roles = array('administrator', 'ho_operations', 'datechange_manager', 'user_portal_datechange_editor_admin', 'user_portal_datechange_editor', 'user_portal_datechange_user');
$datechange_user_roles_generic = array('CmbCS','CmbTK','CcuDC');

$ssr_request_user_roles = array('administrator', 'ho_operations', 'user_portal_ssrrequest_editor_admin', 'user_portal_ssrrequest_editor', 'user_portal_ssrrequest_user');
$ssr_request_user_roles_generic = array('');

$miscellaneous_user_roles = array('administrator');
$miscellaneous_user_roles_generic = array('');

$datechange_misc_user_roles = array('administrator', 'ho_operations', 'user_portal_datechangemisc_request_editor_admin', 'user_portal_datechangemisc_request_editor', 'user_portal_datechangemisc_request_user', 'user_portal_datechange_editor_admin');
$datechange_misc_user_roles_generic = array('');

$current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
$current_domain = "https://$_SERVER[HTTP_HOST]";

$themepath = get_stylesheet_directory_uri();
$themepath = str_replace("https://gauratravel.com.au","",$themepath);

$current_date_time = date('Y-m-d H:i:s');
global $wpdb; 


function gdeal_name_update_ajax($order_id)
	{
		global $currnt_userlogn; 
		$url = "https://gauratravel.com.au/wp-content/themes/twentytwenty/templates/tpl_amadeus_name_update_backend.php?order_id=" . urlencode($order_id) ."&agent=" . urlencode($currnt_userlogn);

		$curl = curl_init();

		curl_setopt_array($curl, array(
			CURLOPT_URL => $url,
			CURLOPT_RETURNTRANSFER => true,
			CURLOPT_TIMEOUT => 30,
			CURLOPT_FOLLOWLOCATION => true,
			CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
			CURLOPT_CUSTOMREQUEST => 'GET'
		));

		$response = curl_exec($curl);
		$http_code = curl_getinfo($curl, CURLINFO_HTTP_CODE);

		if (curl_errno($curl)) {
			echo "cURL Error: " . curl_error($curl);
		} else {
			echo "Response (HTTP $http_code): " . $response;
		}

		curl_close($curl);

	}

function current_payment_status2($orderid)
    {
        global $mysqli;
        
        $total_paid_amount = 0;
        $query_payment_history = "SELECT trams_received_amount FROM wpk4_backend_travel_payment_history where order_id = '$orderid' and pay_type IN ('deposit', 'balance', 'Balance', 'Unknown', 'deposit_adjustment', 'additional_payment')";
        $result_payment_history = mysqli_query($mysqli, $query_payment_history);
        while ($row_payment_history = mysqli_fetch_assoc($result_payment_history)) 
        {
            $total_paid_amount += (float)$row_payment_history['trams_received_amount'];
        }
        
        $query_bookings = "SELECT total_amount FROM wpk4_backend_travel_bookings where order_id = '$orderid'";
        $result_bookings = mysqli_query($mysqli, $query_bookings);
        $row_bookings = mysqli_fetch_assoc($result_bookings);
        
        $total_booking_amount = (float)$row_bookings['total_amount'];
        

        $is_bpay_paid = 0;
        
        $query_payment_history_bpay_check = "SELECT meta_key_data FROM wpk4_backend_travel_booking_update_history where order_id = '$orderid' and meta_key = 'G360Events' and meta_value = 'bpay_receipt_awaiting_approval'";
        $result_payment_history_bpay_check = mysqli_query($mysqli, $query_payment_history_bpay_check);
        if (mysqli_num_rows($result_payment_history_bpay_check) > 0) 
        {
            $is_bpay_paid = 2;
        }
        
        $query_payment_history_bpay_check = "SELECT meta_key_data FROM wpk4_backend_travel_booking_update_history where order_id = '$orderid' and meta_key = 'G360Events' and meta_value = 'bpay_receipt_approved'";
        $result_payment_history_bpay_check = mysqli_query($mysqli, $query_payment_history_bpay_check);
        if (mysqli_num_rows($result_payment_history_bpay_check) > 0) 
        {
            $is_bpay_paid = 1;
        }

        if($is_bpay_paid == 1)
        {
            return 'BPAY Paid';
        }
        else if($is_bpay_paid == 2)
        {
            return 'BPAY Received';
        }
        else
        {
            if($total_paid_amount == 0 )
            {
                return 'Zero Paid';
            }
            else
            {
                $balance = (float)$total_booking_amount - (float)$total_paid_amount;
                if($balance < 1.00 && $balance > -1.00)
                {
                    return ' Fully Paid';
                }
                else if($balance <= -1.00)
                {
                    return ' Over Paid';
                }
                else if($balance >= 1.00)
                {
                    return ' Partially Paid';
                }
                else
                {
                    return ' Pending';
                }
            }
        }
    }
    
function get_user_fullname($uid)
{
    global $mysqli;
    
    $fullname = 'User';
    $emailid = '';
    $query_pax = "SELECT * FROM wpk4_customer_accounts where uid = '$uid'";
    $result_pax = mysqli_query($mysqli, $query_pax);
    if(mysqli_num_rows($result_pax) > 0)
    {
        $query_px = mysqli_fetch_assoc($result_pax);
    					
        $fullname = $query_px['full_name'];
        $emailid = $query_px['email'];
    }			

	$query_pax_2 = "SELECT * FROM wpk4_backend_user_portal_login where auto_id = '$uid'";
    $result_pax_2 = mysqli_query($mysqli, $query_pax_2);
    if(mysqli_num_rows($result_pax_2) > 0 && is_numeric($uid))
    {
        $query_px_2 = mysqli_fetch_assoc($result_pax_2);
        if($fullname == '')
        {
        	$fullname = $query_px_2['fullname'];
        }
    }
    
    return $fullname;
}

function get_user_emailid($uid)
{
    global $mysqli;
    
    $emailid = '';
    $query_pax = "SELECT * FROM wpk4_customer_accounts where uid = '$uid'";
    $result_pax = mysqli_query($mysqli, $query_pax);
    if(mysqli_num_rows($result_pax) > 0)
    {
        $query_px = mysqli_fetch_assoc($result_pax);
        $emailid = $query_px['email'];
    }			

	$query_pax_2 = "SELECT * FROM wpk4_backend_user_portal_login where auto_id = '$uid'";
    $result_pax_2 = mysqli_query($mysqli, $query_pax_2);
    if(mysqli_num_rows($result_pax_2) > 0)
    {
        $query_px_2 = mysqli_fetch_assoc($result_pax_2);
        if($emailid == '')
        {
        	$emailid = $query_px_2['emailid'];
        }
    }
    
    return $emailid;
}

function transfer_payment_to_customer($orderId, $clientPaymentId, $payeeName, $paymentDescription, $customerDescription, $paymentAmount, $payOptionType, $payIDType, $payID, $bsb, $accountNumber)
        {
            global $mysqli;
            if (class_exists('GuzzleHttp\Client'))
            {
                $client = new \GuzzleHttp\Client();
                $apiUrl = 'https://api.azupay.com.au/v1/payment';
                //$apiUrl = 'https://api-uat.azupay.com.au/v1/payment';

                if ($payOptionType == 'PayID') 
                {
                    $body = [
                        'Payment' => [
                            'clientPaymentId' => $clientPaymentId,
                            'payeeName' => $payeeName,
                            'payIDType' => strtoupper($payIDType),
                            'payID' => $payID,
                            'paymentAmount' => $paymentAmount,
                            'paymentDescription' => $paymentDescription,
                            'paymentReference' => $customerDescription,
                            'ultimatePayerName' => 'Gaura Travel'
                        ]
                    ];
                } 
                else 
                {
                    $body = [
                        'Payment' => [
                            'clientPaymentId' => $clientPaymentId,
                            'payeeName' => $payeeName,
                            'paymentAmount' => $paymentAmount,
                            'paymentDescription' => $paymentDescription,
                            'bsb' => $bsb,
                            'accountNumber' => $accountNumber,
                            'paymentReference' => $customerDescription,
                            'ultimatePayerName' => 'Gaura Travel'
                        ]
                    ];
                }
                $responseBodyAsString = '';
                //SECR7566D1_c4cc3709d612d1e0e677833ffbcef703_9Kz3JvUrYqPECSwl // live
                // SECRB12ADA_3137b12750b376c3b9809e254c35b512_V8hcgQ9RTlK265WL // test
                try 
                {
                    $response = $client->request('POST', $apiUrl, [
                        'body' => json_encode($body),
                        'headers' => [
                            'Authorization' => 'SECR7566D1_c4cc3709d612d1e0e677833ffbcef703_9Kz3JvUrYqPECSwl',
                            'accept' => 'application/json',
                            'content-type' => 'application/json',
                        ],
                    ]);
                    
                    $azupay_data = json_decode($response->getBody(), true);

                    $azupayStatus = $azupay_data['PaymentStatus']['status'];
                    $azupayPaymentID = $azupay_data['PaymentStatus']['paymentId'];
                    $azupayCreatedDate = $azupay_data['PaymentStatus']['createdDatetime'];
                    $azupayNPPTransactionID = $azupay_data['PaymentStatus']['nppTransactionId'];
                    $azupayCurrentBalance = $azupay_data['PaymentStatus']['currentBalance'];
                    
                    
                } catch (\GuzzleHttp\Exception\ClientException $e) {
                    $response = $e->getResponse();
                    $responseBodyAsString = $response->getBody()->getContents();
                    // Getting the response from the exception
                    //
                    //$responseBodyAsString = $response->getBody()->getContents();
                    //echo "HTTP Status Code: " . $response->getStatusCode() . "<br>";
                    //echo "HTTP Reason Phrase: " . $response->getReasonPhrase() . "<br>";
                    //echo "Error Response Body: " . $responseBodyAsString . "<br>";
                    echo 'Error on generating the payment link. Kindly try again.';
                } catch (\GuzzleHttp\Exception\ServerException $e) {
                    echo 'Error on generating the payment link. Kindly try again.';
                } catch (\GuzzleHttp\Exception\GuzzleException $e) {
                    echo 'Error on generating the payment link. Kindly try again.';
                } catch (Exception $e) {
                    echo 'Error on generating the payment link. Kindly try again.';
                }
                
                if(isset($azupayPaymentID) && $azupayPaymentID != '')
                {
                    return [
                        'status' => $azupayStatus,
                        'paymentId' => $azupayPaymentID,
                        'createdDatetime' => $azupayCreatedDate,
                        'nppTransactionId' => $azupayNPPTransactionID,
                        'currentBalance' => $azupayCurrentBalance
                    ];
                }
                else
                {
                    error_log("Azupay Outbound Payment Issue: $responseBodyAsString");
                    return $responseBodyAsString;
                }
            }
        }

    // BPAY Code snipit start
    /* LIVE */
    $apiURL = 'https://api.bpaygroup.com.au';
    $apiInitialAuthCode = 'QlBQLTAxMjI1LU0yVjctZmExODA5OWFjMjkxMWNiYjpla2xSUkh4TGtydUM5a3l4cHF1VExzeEJ6VlFxc2Y=';
    $baseBiller = '33829';
    /* LIVE END */
    // generate auth code for BPAY
    function generateAuthCodeCustomer() 
    {
        global $apiURL; global $apiInitialAuthCode; global $baseBiller;
        
        $curl = curl_init();
        curl_setopt_array($curl, array(
          CURLOPT_URL => $apiURL.'/oauth/token',
          CURLOPT_RETURNTRANSFER => true,
          CURLOPT_ENCODING => '',
          CURLOPT_MAXREDIRS => 10,
          CURLOPT_TIMEOUT => 0,
          CURLOPT_FOLLOWLOCATION => true,
          CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
          CURLOPT_CUSTOMREQUEST => 'POST',
          CURLOPT_POSTFIELDS => 'grant_type=client_credentials&scope=read%3Agenerate-crn%20write%3Agenerate-bpay-bill%20read%3Agenerate-icrn%20read%3Avalidate-biller%20write%3Agenerate-bpay-bill',
          CURLOPT_HTTPHEADER => array(
            'Content-Type: application/x-www-form-urlencoded',
            'Authorization: Basic '.$apiInitialAuthCode
          ),
        ));
        $response = curl_exec($curl);
        curl_close($curl);
        $data = json_decode($response, true);
        // Extract the access_token value
        $authcode = $data['access_token'];
        return $authcode;
    }
    // BPAY CRN CheckDigit finder
    /* Find the BPAY CheckDigit by comparing base CRN and received CRN */
    function findStringDifferencesCustomer($string1, $string2) {
        return substr($string2, strlen($string1));
    }
    // Generate BPAY CRN with Amount
    function generateCRNWithAmountCustomer($authCode, $baseCustomerNumber, $dueAmount, $expiryDate) {
        global $apiURL; global $baseBiller;
        $tid_generated = date("ymdhis");
        $curl = curl_init();
        // Get the length of the original string
        $length = strlen($baseCustomerNumber);
        $desiredLength = 9;
        // Calculate the number of leading zeros needed
        $zerosToAdd = $desiredLength - $length;
        // Add leading zeros using str_repeat and str_pad
        $baseCustomerNumber = str_pad(str_repeat("0", $zerosToAdd) . $baseCustomerNumber, $desiredLength, "0", STR_PAD_LEFT);
        $postData = json_encode(array(
            "baseCRNParams" => array(
                array(
                    "tid" => $tid_generated,
                    "baseCustomerNumber" => $baseCustomerNumber,
                    "dueAmount" => $dueAmount,
                    "expiryDate" => $expiryDate
                )
            )
        ));
        curl_setopt_array($curl, array(
            CURLOPT_URL => $apiURL.'/payments/v1/crncheckdigits/biller/'.$baseBiller,
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_ENCODING => '',
            CURLOPT_MAXREDIRS => 10,
            CURLOPT_TIMEOUT => 0,
            CURLOPT_FOLLOWLOCATION => true,
            CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
            CURLOPT_CUSTOMREQUEST => 'POST',
            CURLOPT_POSTFIELDS => $postData,
            CURLOPT_HTTPHEADER => array(
                'Content-Type: application/json',
                'Authorization: Bearer '.$authCode
            ),
        ));
        $response = curl_exec($curl);
        $error = curl_error($curl);
        curl_close($curl);
        return $response;
    }
    // BPAY Generate Invoice after receive correct CRN and Biller code from G360
    
    // BPAY Generate CheckDigit by calculating the numbers manually (without API for draft usage)
    function calculateChecksum($number) {
        $checkDigit = 0;
        // if order_id is 6 character length
        if (strlen($number) == 6) {
            $number = '000' . $number;
        }
        // Convert the number to a string and iterate through each digit
        $digits = str_split((string) $number);
        foreach ($digits as $index => $digit) {
            $checkDigit += $digit * ($index + 1);
        }
        // Calculate the checksum and return it
        $checkDigit = $checkDigit % 10;
        $bpayCRN = $number . $checkDigit;
        return $bpayCRN;
    }
    // BPAY Code snipit end 
    // Azupay code generate starts
    function generateRandomSecurityCodeCustomer($length = 10) {
        $prefix = uniqid(); // Generate a unique prefix
        $characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        $randomString = '';
                                            
        for ($i = 0; $i < $length; $i++) {
            $randomString .= $characters[rand(0, strlen($characters) - 1)];
        }
        return $prefix . $randomString;$pax_id_received = $row_payment_pax['auto_id'];
    }
    
	function generateAzupayPaymentRequestCustomer($next_3_days2, $clientTransactionId, $paymentAmount, $paymentDescription, $callback_url)
	{
		if (class_exists('GuzzleHttp\Client'))
		{
			$client = new \GuzzleHttp\Client();
			$authorization_code = 'SECR7566D1_c4cc3709d612d1e0e677833ffbcef703_9Kz3JvUrYqPECSwl';

			$access_url = 'https://api.azupay.com.au/v1';

			$clientId = "c4cc3709d612d1e0e677833ffbcef703"; 
			
			$payID = "payments@gauratravel.com.au";
			$payIDSuffix = "gauratravel.com.au";
			
			$full_payment_auth_code = generateRandomSecurityCodeCustomer();
			
			// BUILD REQUEST BODY
			$requestBody = '{"PaymentRequest":{"paymentNotification":{"paymentNotificationEndpointUrl":"'.$callback_url.'","paymentNotificationAuthorizationHeaderValue":"'.$full_payment_auth_code.'"},"variant":"1Click", "clientId":"'.$clientId.'","clientTransactionId":"'.$clientTransactionId.'","paymentExpiryDatetime":"'.$next_3_days2.'","paymentAmount":'.$paymentAmount.',"paymentDescription":"'.$paymentDescription.'"}}';
			
			try 
			{
				$azupay_response = $client->request('POST', $access_url.'/paymentRequest', [
					'body' => $requestBody,
					'headers' => [
						'Authorization' => $authorization_code,
						'accept' => 'application/json',
						'content-type' => 'application/json',
					],
				]);
				
				// LOG THE RESPONSE
				$responseBody = $azupay_response->getBody();
															
				$azupay_data = json_decode($responseBody, true);
				$paymentRequestId = $azupay_data['PaymentRequestStatus']['paymentRequestId'];
				$paymentRequeststatus = $azupay_data['PaymentRequestStatus']['status'];
				$paymentRequestcreatedDateTime = $azupay_data['PaymentRequestStatus']['createdDateTime'];
				$paymentRequestcheckoutUrl = $azupay_data['PaymentRequest']['checkoutUrl'];
				$paymentRequestExpiryDatetime = date("d/m/Y H:i:s", strtotime( $azupay_data['PaymentRequest']['paymentExpiryDatetime']));
				$paymentRequestExpiryDatetime_ymd = date("Y-m-d H:i:s", strtotime( $azupay_data['PaymentRequest']['paymentExpiryDatetime']));
				$paymentRequestpayID = $azupay_data['PaymentRequest']['payID'];
				$paymentRequestpaymentDescription = $azupay_data['PaymentRequest']['paymentDescription'];
				$paymentRequestAmount = $azupay_data['PaymentRequest']['paymentAmount'];
				$paymentRequestvirtualBsb = $azupay_data['PaymentRequestStatus']['virtualBsb'];
				$paymentRequestvirtualAccountNumber = $azupay_data['PaymentRequestStatus']['virtualAccountNumber'];
																
			} 
			catch (\GuzzleHttp\Exception\ClientException $e) { 
				// Log client error with request details
				$errorResponse = $e->hasResponse() ? $e->getResponse()->getBody() : 'No response body';
				error_log('[AZUPAY ERROR] ClientException: ' . $e->getMessage() . PHP_EOL .
						  'Transaction ID: ' . $clientTransactionId . PHP_EOL .
						  'Amount: ' . $paymentAmount . PHP_EOL .
						  'Request Body: ' . $requestBody . PHP_EOL .
						  'Error Response: ' . $errorResponse . PHP_EOL .
						  '-----------------------------------');
				echo 'Error on generating the payment link. Kindly try again.'; 
			}
			catch (\GuzzleHttp\Exception\ServerException $e) { 
				// Log server error with request details
				$errorResponse = $e->hasResponse() ? $e->getResponse()->getBody() : 'No response body';
				error_log('[AZUPAY ERROR] ServerException: ' . $e->getMessage() . PHP_EOL .
						  'Transaction ID: ' . $clientTransactionId . PHP_EOL .
						  'Amount: ' . $paymentAmount . PHP_EOL .
						  'Request Body: ' . $requestBody . PHP_EOL .
						  'Error Response: ' . $errorResponse . PHP_EOL .
						  '-----------------------------------');
				echo 'Error on generating the payment link. Kindly try again.'; 
			}
			catch (\GuzzleHttp\Exception\GuzzleException $e) { 
				// Log Guzzle-specific error with request details
				error_log('[AZUPAY ERROR] GuzzleException: ' . $e->getMessage() . PHP_EOL .
						  'Transaction ID: ' . $clientTransactionId . PHP_EOL .
						  'Amount: ' . $paymentAmount . PHP_EOL .
						  'Request Body: ' . $requestBody . PHP_EOL .
						  '-----------------------------------');
				echo 'Error on generating the payment link. Kindly try again.'; 
			} 
			catch (Exception $e) { 
				// Log general exception with request details
				error_log('[AZUPAY ERROR] Exception: ' . $e->getMessage() . PHP_EOL .
						  'Transaction ID: ' . $clientTransactionId . PHP_EOL .
						  'Amount: ' . $paymentAmount . PHP_EOL .
						  'Request Body: ' . $requestBody . PHP_EOL .
						  '-----------------------------------');
				echo 'Error on generating the payment link. Kindly try again.'; 
			}
			
			if(isset($paymentRequestId))
			{
				
				return [
					'paymentRequestId' => $paymentRequestId,
					'createdDateTime' => $paymentRequestcreatedDateTime,
					'checkoutUrl' => $paymentRequestcheckoutUrl,
					'paymentExpiryDatetime' => $paymentRequestExpiryDatetime,
					'paymentExpiryDatetimeYMD' => $paymentRequestExpiryDatetime_ymd,
					'payID' => $paymentRequestpayID,
					'paymentAmount' => $paymentRequestAmount,
					'paymentAuthCode' => $full_payment_auth_code,
					'virtualBsb' => $paymentRequestvirtualBsb,
					'virtualAccountNumber' => $paymentRequestvirtualAccountNumber
				];
			}
			else
			{
				// Log when paymentRequestId is not set
				$responseData = isset($azupay_response) ? $azupay_response->getBody() : 'No response';
				error_log('[AZUPAY ERROR] Payment Request ID Not Set' . PHP_EOL .
						  'Transaction ID: ' . $clientTransactionId . PHP_EOL .
						  'Amount: ' . $paymentAmount . PHP_EOL .
						  'Request Body: ' . $requestBody . PHP_EOL .
						  'Response: ' . $responseData . PHP_EOL .
						  '-----------------------------------');
				return '';
			}
		}
	}

    function generateAzupayPaymentRequestCustomerd($next_3_days2, $clientTransactionId, $paymentAmount, $paymentDescription, $callback_url)
    {
        if (class_exists('GuzzleHttp\Client'))
        {
            $client = new \GuzzleHttp\Client();
            $authorization_code = 'SECR7566D1_c4cc3709d612d1e0e677833ffbcef703_9Kz3JvUrYqPECSwl';

            $access_url = 'https://api.azupay.com.au/v1';

            $clientId = "c4cc3709d612d1e0e677833ffbcef703"; 
            
            $payID = "payments@gauratravel.com.au";
            $payIDSuffix = "gauratravel.com.au";
            
            $full_payment_auth_code = generateRandomSecurityCodeCustomer();
            
            try 
            {
            
            $azupay_response = $client->request('POST', $access_url.'/paymentRequest', [
                'body' => '{"PaymentRequest":{"paymentNotification":{"paymentNotificationEndpointUrl":"'.$callback_url.'","paymentNotificationAuthorizationHeaderValue":"'.$full_payment_auth_code.'"},"variant":"1Click", "clientId":"'.$clientId.'","clientTransactionId":"'.$clientTransactionId.'","paymentExpiryDatetime":"'.$next_3_days2.'","paymentAmount":'.$paymentAmount.',"paymentDescription":"'.$paymentDescription.'"}}',
                'headers' => [
                'Authorization' => $authorization_code,
                'accept' => 'application/json',
                'content-type' => 'application/json',
                ],
            ]);
                                                		
            $azupay_data = json_decode($azupay_response->getBody(), true);
            $paymentRequestId = $azupay_data['PaymentRequestStatus']['paymentRequestId'];
            $paymentRequeststatus = $azupay_data['PaymentRequestStatus']['status'];
            $paymentRequestcreatedDateTime = $azupay_data['PaymentRequestStatus']['createdDateTime'];
            $paymentRequestcheckoutUrl = $azupay_data['PaymentRequest']['checkoutUrl'];
            $paymentRequestExpiryDatetime = date("d/m/Y H:i:s", strtotime( $azupay_data['PaymentRequest']['paymentExpiryDatetime']));
            $paymentRequestExpiryDatetime_ymd = date("Y-m-d H:i:s", strtotime( $azupay_data['PaymentRequest']['paymentExpiryDatetime']));
            $paymentRequestpayID = $azupay_data['PaymentRequest']['payID'];
            $paymentRequestpaymentDescription = $azupay_data['PaymentRequest']['paymentDescription'];
            $paymentRequestAmount = $azupay_data['PaymentRequest']['paymentAmount'];
            $paymentRequestvirtualBsb = $azupay_data['PaymentRequestStatus']['virtualBsb'];
            $paymentRequestvirtualAccountNumber = $azupay_data['PaymentRequestStatus']['virtualAccountNumber'];
                                                            	
            } 
            catch (\GuzzleHttp\Exception\ClientException $e) { 
				// Log client error (4xx responses)
				error_log('[AZUPAY ERROR] ClientException: ' . $e->getMessage() . ' | Transaction ID: ' . $clientTransactionId . ' | Amount: ' . $paymentAmount);
				echo 'Error on generating the payment link. Kindly try again.'; 
			}
			catch (\GuzzleHttp\Exception\ServerException $e) { 
				// Log server error (5xx responses)
				error_log('[AZUPAY ERROR] ServerException: ' . $e->getMessage() . ' | Transaction ID: ' . $clientTransactionId . ' | Amount: ' . $paymentAmount);
				echo 'Error on generating the payment link. Kindly try again.'; 
			}
			catch (\GuzzleHttp\Exception\GuzzleException $e) { 
				// Log Guzzle-specific error
				error_log('[AZUPAY ERROR] GuzzleException: ' . $e->getMessage() . ' | Transaction ID: ' . $clientTransactionId . ' | Amount: ' . $paymentAmount);
				echo 'Error on generating the payment link. Kindly try again.'; 
			} 
			catch (Exception $e) { 
				// Log general exception
				error_log('[AZUPAY ERROR] Exception: ' . $e->getMessage() . ' | Transaction ID: ' . $clientTransactionId . ' | Amount: ' . $paymentAmount);
				echo 'Error on generating the payment link. Kindly try again.'; 
			}
            
            if(isset($paymentRequestId))
            {
                return [
                    'paymentRequestId' => $paymentRequestId,
                    'createdDateTime' => $paymentRequestcreatedDateTime,
                    'checkoutUrl' => $paymentRequestcheckoutUrl,
                    'paymentExpiryDatetime' => $paymentRequestExpiryDatetime,
                    'paymentExpiryDatetimeYMD' => $paymentRequestExpiryDatetime_ymd,
                    'payID' => $paymentRequestpayID,
                    'paymentAmount' => $paymentRequestAmount,
                    'paymentAuthCode' => $full_payment_auth_code,
                    'virtualBsb' => $paymentRequestvirtualBsb,
                    'virtualAccountNumber' => $paymentRequestvirtualAccountNumber
                ];
            }
            else
            {
                // Log when paymentRequestId is not set (even if no exception was caught)
				$responseBody = isset($azupay_response) ? $azupay_response->getBody() : 'No response';
				error_log('[AZUPAY ERROR] Payment Request ID not set | Transaction ID: ' . $clientTransactionId . ' | Amount: ' . $paymentAmount . ' | Response: ' . $responseBody);
				return '';
            }
        }
    }
    
    function generateSkyPayPaymentRequestCustomer($newSalePrice, $departureDate, $order_id_for_payment_request)
    {
        $callbackURL_sky = 'https://gauratravel.com.au/skypay-post-callback/';
        
        if ( ctype_digit($order_id_for_payment_request) && strlen($order_id_for_payment_request) <= 7 ) 
        {
            $slice_pay_agent_id = 'agent-gaura-41fbn0';
        } 
        elseif (ctype_alpha($order_id_for_payment_request)) 
        {
            $slice_pay_agent_id = 'agent-gaura-41fbn0';
        } 
        else 
        {
            $slice_pay_agent_id = 'agent-gaura-41fbn0';
        }
        
        $href_paylater = '';
        $paylater_link = '';
        $curl_paylater = curl_init();
        curl_setopt_array($curl_paylater, array(
            CURLOPT_URL => 'https://business.paylatertravel.com.au/api/create-link/',
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_ENCODING => '',
            CURLOPT_MAXREDIRS => 10,
            CURLOPT_TIMEOUT => 0,
            CURLOPT_FOLLOWLOCATION => true,
            CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
            CURLOPT_CUSTOMREQUEST => 'POST',
            CURLOPT_POSTFIELDS => 'salePrice='.$newSalePrice.'&currency=AUD&departureDate='.$departureDate.'&bookingReference='.$order_id_for_payment_request.'&agentId='.$slice_pay_agent_id.'&bookingNotificationUrl='.$callbackURL_sky,
            CURLOPT_HTTPHEADER => array(
                'Accept: text/html',
                'Content-Type: application/x-www-form-urlencoded'
            ),
        ));
        $response_paylater = curl_exec($curl_paylater);
        curl_close($curl_paylater);
                                                                        
        if (!empty($response_paylater)) 
        {
            $doc_paylater = new DOMDocument();
            @$doc_paylater->loadHTML($response_paylater);
            $anchors_paylater = $doc_paylater->getElementsByTagName('a');
                                                                            
            if ($anchors_paylater->length > 0) {
                $anchor_paylater = $anchors_paylater->item(0);
                $href_paylater = $anchor_paylater->getAttribute('href');
            }
            if($href_paylater != '')
            {
                $paylater_link = '<a href="'.$href_paylater.'" style="background-color: #26BDD7; border: none; color: white;  padding: 10px 16px; margin: 10px 0px; text-align: center;  text-decoration: none;  display: inline-block;  font-size: 13px;">Pay via PayLater</a>';
            }
        }
        return $paylater_link;
    }
    // Azupay code generate ends

	if((isset($user_role) && (current_user_can( 'administrator' ) || current_user_can( 'ho_operations' ) || current_user_can( 'datechange_manager' ) || current_user_can( 'user_portal_datechange_editor_admin' ) || current_user_can( 'user_portal_datechange_editor' ) || 
	current_user_can( 'user_portal_datechange_user' ) || current_user_can( 'user_portal_complaint_editor' ) || current_user_can( 'user_portal_complaints_admin' ) || current_user_can( 'user_portal_complaint_user' ) || 
	current_user_can( 'user_portal_user' )  || current_user_can( 'user_portal_refund_editor_admin' ) || current_user_can( 'user_portal_refund_editor' ) || current_user_can( 'user_portal_editor' ))) || !isset($user_role))	// allow all users (staffs and customers) - can be removed as it allow everyone
	{
		
			include('data-table-classes.php');
			?>
			<style>
			.itinerarytab td
			{
				border-width: 1px;
			}
			#manage_bookings .vc_col-sm-6
			{
				width:49%;
				top:0px;
				padding:5px;
			}
			.post-99828 .entry-header-inner h1
			{
				display:none
			}
			.redstar
			{
				color:red;
			}
			.descriptiontext
			{
				font-size:11px; 
				line-height:9px;
			}
			.addnotebtn
			{
				height:12px; 
				width:25px;
				font-size:7px;
				padding:2px;
				margin:0px;
			}
			.addnotebtn input[type="text"]
			{
				color:black !important;
				
			}
			.fieldnotelable
			{
				font-size:12px;
			}
			.custom-general-button
			{
				padding:5px 10px; 
				margin:0;
				width:150px; 
				height:40px;
				font-size:11px !important;
			}
			</style>
			<?php
			if(session_id() == '' || !isset($_SESSION) || session_status() === PHP_SESSION_NONE) 
			{
				session_start(); 
			}
			if( $user_role!= '' && !isset($_SESSION['userId']))
			{
			}
			if( $user_role== '' && !isset($_SESSION['userId']))
			{
			}
			
			if(isset($_SESSION['userId']) && isset($_GET['replyto'])) // migrate customer when landing through email reply button
			{
				$req_id = $_GET['replyto'];
				$co = $_GET['co'];
				$t = $_GET['t'];
				if($_GET['t'] == 'refund')
				{
					$full_case_type = 'r';
				}
				else if($_GET['t'] == 'complaint')
				{
					$full_case_type = 'c';
				}
				else if($_GET['t'] == 'datechange')
				{
					$full_case_type = 'd';
				}
				else
				{
					$full_case_type = '';
				}
				echo '<script>window.location.href="?p=my-request-view&id='.$req_id.'&co='.$co.'&casetype='.$t.'&t='.$full_case_type.'";</script>';
			}
			if(isset($_SESSION) && !isset($_SESSION['userId']) ) // signup / login / verify account
			{
				if(!isset($_GET['p']) && !isset($_GET['verify']) && !isset($_GET['forgot']) && !isset($_GET['reset'])) // home page
				{
					if((
					current_user_can( 'administrator' ) || 
					current_user_can( 'ho_operations' ) || 
					current_user_can( 'datechange_manager' ) || 
					current_user_can( 'user_portal_refund_editor_admin' ) || 
					current_user_can( 'user_portal_refund_editor' ) || 
					current_user_can( 'user_portal_refund_user' ) || 
					current_user_can( 'user_portal_complaint_editor_admin' ) || 
					current_user_can( 'user_portal_complaint_editor' ) || 
					current_user_can( 'user_portal_complaint_user' ) || 
					current_user_can( 'user_portal_datechange_editor_admin' ) || 
					current_user_can( 'user_portal_datechange_editor' ) || 
					current_user_can( 'user_portal_datechange_user')
					) && !isset($_SESSION['userId']))
					{
						echo '<div class="wrapper vc_col-sm-12"><center><a href="?p=managebox"><button class="btn btn-primary">Go to Dashboard</button></a></center></div>';
					}
					else
					{
					    echo '<script>window.location.href="/";</script>';
					}
				} 				
			} //end login page
			else if(isset($_SESSION['userId']) && !isset($_GET['p'])) // if customer logged in
			{
				echo '<script>window.location.href="?p=dashboard";</script>';
			}
			// for customer after login start
			if(isset($_SESSION) && isset($_SESSION['userId']) && $_SESSION['userId'] != '' )
			{
				$username = $_SESSION['userEmailID'];
				$fullname = $_SESSION['userFullName'];
				$user_id = $_SESSION['userId'];
				
				$query_pax = "SELECT * FROM wpk4_customer_accounts where uid = '$user_id'";
    			$result_pax = mysqli_query($mysqli, $query_pax);
    			$query_px = mysqli_fetch_assoc($result_pax);

    			$fullname = get_user_fullname($user_id);
				
				if(isset($currnt_userlogined) && $currnt_userlogined == 'sriharshans')
				{
						//echo $fullname;
				}
				
    			$emailid = get_user_emailid($user_id);
    			if(isset($query_px['phonenumber']) && $query_px['phonenumber'] != '')
					{
						$user_phonenumber = $query_px['phonenumber'];
					}
					else
					{
						$user_phonenumber = '0123456789012345';
					}
				
    			$sub_customer_login_id = '';
				$query_pax_2 = "SELECT * FROM wpk4_backend_user_portal_login where emailid = '$emailid'";
    			$result_pax_2 = mysqli_query($mysqli, $query_pax_2);
    			if(mysqli_num_rows($result_pax_2) > 0)
    			{
        			$query_px_2 = mysqli_fetch_assoc($result_pax_2);
        			$sub_customer_login_id = $query_px_2['auto_id'];
        			if($fullname == '')
        			{
        			    $fullname = $query_px_2['fullname'];
        			}
    			}
    			if($sub_customer_login_id == '')
    			{
    				$sub_customer_login_id = '43534534534545';
    			}
    			
    			?>
    			<style>
    /* Main menu container */
    .menu2 {
        list-style-type: none;
        display: flex;
        padding: 0;
        margin: 0;
        background-color: #333;
    }

    /* Menu items */
    .menu2 > li {
        position: relative;
    }

    .menu2 > li > a, .menu2 > li > label {
        display: block;
        padding: 10px 15px;
        color: white;
        text-decoration: none;
        font-size: 16px;
    }

    /* Hover effects */
    .menu2 > li > a:hover, .menu2 > li > label:hover {
        background-color: #555;
    }

    /* Submenu */
    .submenu2 {
        list-style-type: none;
        position: absolute;
        display: none;
        top: 100%;
        left: 0;
        padding: 0;
        margin: 0;
        background-color: #333;
        min-width: 150px;
        z-index:10000;
    }
    
    .submenu2 li
    {
        margin:0 !important;
    }

    .submenu2 li a {
        padding: 10px 15px;
        color: white;
        text-decoration: none;
        display: block;
        font-size: 14px;
    }

    .submenu2 li a:hover {
        background-color: #555;
    }

    /* Show submenu when checkbox is checked */
    #check02:checked + label + .submenu2 {
        display: block;
    }
</style>
                <script>
                    // Close the menu when clicked outside
                    document.addEventListener('click', function(event) {
                        var menu = document.getElementById('menu2');
                        var targetElement = event.target;
                
                        // Check if the clicked element is outside the menu
                        while (targetElement) {
                            if (targetElement === menu) {
                                // Clicked inside the menu, do nothing
                                return;
                            }
                            targetElement = targetElement.parentNode;
                        }
                
                        // Clicked outside the menu, close it
                        var checkbox = document.getElementById('check02');
                        checkbox.checked = false;
                    });
                </script>
                <div style="padding-top:20px; " >
                    <ul id="menu2" class='menu2'>
                        <li><a href="<?php echo site_url(); ?>/customer-portal/?p=my-bookings">Manage Bookings</a></li>
                        <!--<li>
                            <input id="check02" type="checkbox" name="menu" style="display: none;"/>
                            <label for="check02">Manage Service Requests <i class="fa fa-angle-down" style="font-size:16px"></i></label>
                            <ul class="submenu2" >
                                <li><a href="<?php echo site_url(); ?>/customer-portal/?p=refund-request">Apply for refund</a></li> 
                            </ul>
                        </li>-->
                        <?php
                        // Get the current protocol (HTTP or HTTPS)
                        $redirect_protocol = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off' || $_SERVER['SERVER_PORT'] == 443) ? "https://" : "http://";
                        $redirect_host = $_SERVER['HTTP_HOST'];
                        $redirect_request_uri = $_SERVER['REQUEST_URI'];
                        $redirect_current_url = $redirect_protocol . $redirect_host . $redirect_request_uri;
                                                                
                        $logout_url = $redirect_current_url . (strpos($redirect_current_url, '?') === false ? '?logout=true' : '&logout=true');
                        ?>
                        <li><a href="<?php echo $logout_url; ?>">Logout</a></li>
                    </ul>
                </div>
    			</br></br>
    			<?php
				
				if(isset($_GET['p']) && $_GET['p'] =='my-bookings') //customer - my bookings
				{
				    echo '</br><h3>My Bookings</h3></br>';
				    ?>
				    <style>
				        .vc_col-sm-10
				        {
				            width:93%;
				        }
				        .vc_col-sm-2
				        {
				            width:7%;
				            float:right;
				            text-align:right;
				        }
						.view-btn
						{
							background-color: #ffbb00 !important;
							border: none;
							color: black;
							padding: 7px 25px;
							border-radius: 7px;
							text-align: center;
							text-decoration: none;
							display: inline-block;
							font-size: 16px;
							font-weight: 500;
						}
				    </style>
				    <?php
				    $query_pax = "SELECT * FROM wpk4_customer_accounts where uid = '$user_id'";
					$result_pax = mysqli_query($mysqli, $query_pax);
					$query_px = mysqli_fetch_assoc($result_pax);
					$trav_date = date("Y-m-d H:i:s");
					$fullname = $query_px['full_name'] ?? '';
					$emailid = $query_px['email'] ?? 'gt@nouseraccountgt.com';
					if(isset($query_px['phonenumber']) && $query_px['phonenumber'] != '')
					{
						$user_phonenumber = $query_px['phonenumber'];
					}
					else
					{
						$user_phonenumber = $_SESSION['userPhoneCropped'] ?? '';
					}
					
					$processedOrders_search = [];
					$query_bookings = "SELECT booking.order_type, booking.order_id, pax.pnr, date(booking.order_date) as orderdate, booking.trip_code, date(booking.travel_date) as traveldate 
    					FROM wpk4_backend_travel_bookings booking 
    					JOIN wpk4_backend_travel_booking_pax pax ON  
    					booking.order_id = pax.order_id AND 
    					booking.co_order_id = pax.co_order_id AND 
    					booking.product_id = pax.product_id  
    					where ((pax.email_pax != '' AND pax.email_pax='$emailid') OR (pax.phone_pax_cropped != '' AND pax.phone_pax_cropped='$user_phonenumber')) AND (booking.is_hidden is null OR booking.is_hidden = '') order by booking.order_date desc, booking.travel_date desc";
						
						if(isset($currnt_userlogined) && $currnt_userlogined == 'sriharshans')
            				{
								echo $query_pax;
								echo '</br>';
								echo $query_bookings;
							}
    				$result_bookings = mysqli_query($mysqli, $query_bookings);
    				if(mysqli_num_rows($result_bookings) > 0)
    				{
    					while($row_bookings = mysqli_fetch_assoc($result_bookings))
    					{
    					    $order_type = $row_bookings['order_type'];
        					$order_id = $row_bookings['order_id'];
        					$enc_order_id = md5($order_id);
        					$trip_code = $row_bookings['trip_code'];
        					$pnr = $row_bookings['pnr'];
        					$order_date = $row_bookings['orderdate'];
        					
        					$tripKey = $order_id.''.$trip_code;
        					if (in_array($tripKey, $processedOrders_search)) {
    							continue; // Skip to the next iteration if the order ID is already processed
    						}
    						$processedOrders_search[] = $tripKey;
        					?>	
        					<div class="wrapper " style="background-color:#fafbfc; padding:10px 15px 10px 15px; margin:10px 0px 10px 0px; text-align:left; display:flex; ">
        					    <div class="vc_col-sm-10">
        					        <p style="font-size:17px; font-weight:700;">
                    					<?php 
                    					echo $order_id;
                    					?>
            					    </p>
            					    <p style="font-size:13px; font-weight:700;">
                    					<?php 
                    					echo $row_bookings['trip_code'].' | ';
                    					echo date('d/m/Y', strtotime($row_bookings['traveldate']));
                    					?>
            					    </p>
            					</div>
            					<div class="vc_col-sm-2">
            					    <a href="?p=booking&orderID=<?php echo $order_id; ?>&key=<?php echo $enc_order_id; ?>" class="view-btn">View</a>
            					</div>
        					</div>
    					    <?php
    					}
    				}
    				else
    				{
    				    echo 'No booking found under your account.';
    				}
				}
				if(isset($_GET['p']) && $_GET['p'] =='my-bookings-dc') //customer - my bookings
				{
				    echo '</br><h3>My Bookings</h3></br>';
				    ?>
				    <style>
				        .vc_col-sm-10
				        {
				            width:93%;
				        }
				        .vc_col-sm-2
				        {
				            width:7%;
				            float:right;
				            text-align:right;
				        }
				    </style>
				    <?php
				    $query_pax = "SELECT * FROM wpk4_customer_accounts where uid = '$user_id'";
					$result_pax = mysqli_query($mysqli, $query_pax);
					$query_px = mysqli_fetch_assoc($result_pax);
					$trav_date = date("Y-m-d H:i:s");
					$fullname = $query_px['full_name'];
					$emailid = $query_px['email'];
					if($query_px['phonenumber'] != '')
					{
						$user_phonenumber = $query_px['phonenumber'];
					}
					else
					{
						$user_phonenumber = '0123456789012345';
					}
					$processedOrders_search = [];
					$query_bookings = "SELECT booking.order_type, booking.order_id, pax.pnr, date(booking.order_date) as orderdate, booking.trip_code, date(booking.travel_date) as traveldate 
    					FROM wpk4_backend_travel_bookings booking 
    					JOIN wpk4_backend_travel_booking_pax pax ON  
    					booking.order_id = pax.order_id AND 
    					booking.co_order_id = pax.co_order_id AND 
    					booking.product_id = pax.product_id  
    					where pax.email_pax='$emailid' order by booking.order_date desc, booking.travel_date desc";
    				$result_bookings = mysqli_query($mysqli, $query_bookings);
    				if(mysqli_num_rows($result_bookings) > 0)
    				{
    					while($row_bookings = mysqli_fetch_assoc($result_bookings))
    					{
    					    $order_type = $row_bookings['order_type'];
        					$order_id = $row_bookings['order_id'];
        					$enc_order_id = md5($order_id);
        					$trip_code = $row_bookings['trip_code'];
        					$pnr = $row_bookings['pnr'];
        					$order_date = $row_bookings['orderdate'];
        					
        					$tripKey = $order_id.''.$trip_code;
        					if (in_array($tripKey, $processedOrders_search)) {
    							continue;
    						}
    						$processedOrders_search[] = $tripKey;
        					?>	
        					<div class="wrapper " style="background-color:#fafbfc; padding:10px 15px 10px 15px; margin:10px 0px 10px 0px; text-align:left; display:flex; ">
        					    <div class="vc_col-sm-10">
        					        <p style="font-size:17px; font-weight:700;">
                    					<?php 
                    					echo $order_id;
                    					?>
            					    </p>
            					    <p style="font-size:13px; font-weight:700;">
                    					<?php 
                    					echo $row_bookings['trip_code'].' | ';
                    					echo date('d/m/Y', strtotime($row_bookings['traveldate']));
                    					?>
            					    </p>
            					</div>
            					<div class="vc_col-sm-2">
            					    <a href="?p=booking&orderID=<?php echo $order_id; ?>&key=<?php echo $enc_order_id; ?>">View</a>
            					</div>
            					
            					<div class="vc_col-sm-4">
            					    <?php
            					    if(($order_type == 'WPT' || $order_type == '') && date('Y-m-d', strtotime($trav_date . ' +7 day')) < $row_bookings['traveldate'] && ( $trip_code != 'AUS-IND-IN100-IN100' && $trip_code != 'IND-AUS-IN101-IN101' ))
            					    {
                					    ?>
                					    <a href="?p=change-date&id=<?php echo $order_id; ?>&tripid=<?php echo $row_bookings['trip_code']; ?>" style="top:15px; float:right !important;">Request Date Change Online</a>
                					    <?php
            					    }
            					    if(($order_type == 'WPT' || $order_type == '') && date('Y-m-d', strtotime($trav_date . ' +7 day')) < $row_bookings['traveldate'] && ( $trip_code != 'AUS-IND-IN100-IN100' && $trip_code != 'IND-AUS-IN101-IN101' ))
            					    {
                					    ?>
                					    <a href="?p=request-date-change" style="top:15px; float:right !important;">Request Date Change Manually&nbsp;&nbsp;|&nbsp;&nbsp;</a>
                					    <?php
            					    }
            					    if(($order_type != 'WPT' && $order_type != '') && date('Y-m-d', strtotime($trav_date . ' +7 day')) < $row_bookings['traveldate'])
            					    {
                					    ?>
                					    <a href="?p=request-date-change" style="top:15px; float:right !important;">Request Date Change Manually</a>
                					    <?php
            					    }
            					    if(date('Y-m-d', strtotime($trav_date . ' +7 day')) < $row_bookings['traveldate'] && ($trip_code == 'AUS-IND-IN100-IN100' || $trip_code == 'IND-AUS-IN101-IN101'))
            					    {
            					        ?>
                					    <a href="?p=request-date-change" style="top:15px; float:right !important;">Request Date Change Manually</a>
                					    <?php
            					    }
            					    if(date('Y-m-d', strtotime($trav_date . ' +7 day')) > $row_bookings['traveldate'] && date('Y-m-d') < $row_bookings['traveldate'])
            					    {
                					    ?>
                					    <a href="tel:1300359463" style="top:15px; float:right !important;">Call 1300 359 463</a>
                					    <?php
            					    }
            					    ?>
            					</div>
        					</div>
    					    <?php
    					}
    				}
    				else
    				{
    				    echo 'No booking found under your account.';
    				}
				}
				if(isset($_GET['p']) && $_GET['p'] =='booking' && isset($_GET['orderID']) && $_GET['orderID'] != '') //customer - individual booking view
				{
				    $query_pax = "SELECT * FROM wpk4_customer_accounts where uid = '$user_id'";
					$result_pax = mysqli_query($mysqli, $query_pax);
					$query_px = mysqli_fetch_assoc($result_pax);
					$trav_date = date("Y-m-d H:i:s");
					$fullname = $query_px['full_name'] ?? '';
					$emailid = $query_px['email'] ?? 'gt@nouseraccountgt.com';
					if(isset($query_px['phonenumber']) && $query_px['phonenumber'] != '')
					{
						$user_phonenumber = $query_px['phonenumber'];
					}
					else
					{
						$user_phonenumber = $_SESSION['userPhoneCropped'] ?? '0123456789012345';
					}
					
				    $enc_order_id = md5($_GET['orderID']);
				    
    				if($_GET['orderID'] != '' && $enc_order_id == $_GET['key']) // is any values searched
    				{
    				    try 
    				    {
        				    $get_orderID = (int)$_GET['orderID'];
        				    
        				    if ($get_orderID <= 0) {
                                throw new Exception("Invalid Order ID provided.");
                            }
        				    $filter_sql = "wpk4_backend_travel_bookings.order_id = '$get_orderID'";
            				$filter_sql = isset($filter_sql) ? $filter_sql : "1 = 2";
            				
            				$query = "SELECT * FROM wpk4_backend_travel_bookings JOIN wpk4_backend_travel_booking_pax ON  wpk4_backend_travel_bookings.order_id = wpk4_backend_travel_booking_pax.order_id AND 
            				wpk4_backend_travel_bookings.co_order_id = wpk4_backend_travel_booking_pax.co_order_id AND wpk4_backend_travel_bookings.product_id = wpk4_backend_travel_booking_pax.product_id 
            				where wpk4_backend_travel_bookings.order_date < (NOW() - INTERVAL 1 MINUTE) and ((wpk4_backend_travel_booking_pax.email_pax  != '' AND wpk4_backend_travel_booking_pax.email_pax = '$emailid') OR ( wpk4_backend_travel_booking_pax.phone_pax_cropped != '' AND wpk4_backend_travel_booking_pax.phone_pax_cropped = '$user_phonenumber')) AND (wpk4_backend_travel_bookings.is_hidden is null OR wpk4_backend_travel_bookings.is_hidden = '') AND $filter_sql order by wpk4_backend_travel_bookings.order_id desc LIMIT 20";
							
							if(isset($currnt_userlogined) && $currnt_userlogined == 'sriharshans')
            				{
								//echo '</br>';
								//echo $query;
							}
            				$selection_query = $query;

            				if (!$mysqli) {
                                throw new Exception("Database connection failed: " . mysqli_connect_error());
                            }
    
            				$result_book = mysqli_query($mysqli, $query) or die(mysqli_error($mysqli));
            				
            				if (!$result_book) {
                                throw new Exception("SQL Error: " . mysqli_error($mysqli));
                            }
            				
            				$row_count = mysqli_num_rows($result_book);
                            if (mysqli_num_rows($result_book) > 0)
                    		{
                    		    $processedOrders_search = [];
                    		    while($row = mysqli_fetch_assoc($result_book))
                    		    {
                    		        $email_pax_checkup = $row['email_pax'];
                    		        if(true)
                    		        {
                        		    $order_id = $row['order_id'];
                        		    $order_id_api = $row['order_id'];
                        		    $co_order_id_api = $row['co_order_id'];
                        		    $product_id_api = $row['product_id'];
                        		    $new_product_id_api = $row['new_product_id'];
									
									$emailid = $row['email_pax'];
                        		    
                        		    $trip_code_for_order = $row['trip_code'];
                        		    
                                    if (in_array($order_id, $processedOrders_search)) {
        								continue;
        							}
        							$processedOrders_search[] = $order_id;
        							
                            		$pax_remarks=$row['remarks'];
                            		$booking_date_dmy = date('d/m/Y H:i:s', strtotime($row['order_date'])); 
                                    $travel_date_domestic = date('Y-m-d', strtotime($row['travel_date'])); 
                            		$trip_code_domestic = $row['trip_code'];
                            		
                            		$phone_pax = '';
                            		$query_pax_contact_selection_phone = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id' AND phone_pax != ''";
                					$result_pax_contact_selection_phone = mysqli_query($mysqli, $query_pax_contact_selection_phone);
                					$row_pax_contact_selection_phone = mysqli_fetch_assoc($result_pax_contact_selection_phone);
                					if(mysqli_num_rows($result_pax_contact_selection_phone) > 0)
                					{
                                		$phone_pax = $row_pax_contact_selection_phone['phone_pax'];
                                		if($phone_pax == '')
                                		{
                                            $query_pax_contact_from_meta = "SELECT * FROM wpk4_backend_history_of_updates where type_id='$order_id' AND meta_key = 'Billing PrivatePhone'";
                        					$result_pax_contact_from_meta = mysqli_query($mysqli, $query_pax_contact_from_meta);
                        					$row_pax_contact_from_meta = mysqli_fetch_assoc($result_pax_contact_from_meta);
                        					if(mysqli_num_rows($result_pax_contact_from_meta) > 0)
                					        {
                        					    $phone_pax = $row_pax_contact_from_meta['meta_value'];
                					        }
                                		}
                					}
                            		
                            		$email_pax = '';
                            		$query_pax_contact_selection_email = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id' and email_pax = '$emailid' AND email_pax != ''";
                					$result_pax_contact_selection_email = mysqli_query($mysqli, $query_pax_contact_selection_email);
                					$row_pax_contact_selection_email = mysqli_fetch_assoc($result_pax_contact_selection_email);
                					if(mysqli_num_rows($result_pax_contact_selection_email) > 0)
                					{
                                		$email_pax = $row_pax_contact_selection_email['email_pax'];
                                		if($email_pax == '')
                                		{
                                            $query_pax_contact_from_meta = "SELECT * FROM wpk4_backend_history_of_updates where type_id='$order_id' AND meta_key = 'Billing Email'";
                        					$result_pax_contact_from_meta = mysqli_query($mysqli, $query_pax_contact_from_meta);
                        					$row_pax_contact_from_meta = mysqli_fetch_assoc($result_pax_contact_from_meta);
                        					if(mysqli_num_rows($result_pax_contact_from_meta) > 0)
                    					    {
                        				        $email_pax = $row_pax_contact_from_meta['meta_value'];
                    					    }
                                		}
                					}
                            		
                            		$total_pax = $row['total_pax'];
                            		$order_type = $row['order_type'];
                            		$order_type_itinerary = $row['order_type'];
                            		
                            		$query_payment_status = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id'";
                					$result_payment_status = mysqli_query($mysqli, $query_payment_status);
                					$row_payment_status = mysqli_fetch_assoc($result_payment_status);
                					
                    				$payment_status = $row_payment_status['payment_status'];
            				        if($row_payment_status['payment_status'] == 'pending')
            						{
            							$txt_payment_status = 'Pending';
            						}
            						else if($row_payment_status['payment_status'] == 'partially_paid')
            						{
            							$txt_payment_status = 'Partially Paid';
            						}
            						else if($row_payment_status['payment_status'] == 'paid' || $row_payment_status['payment_status'] == 'Paid')
            						{
            							$txt_payment_status = 'Paid';
            						}
            						else if($row_payment_status['payment_status'] == 'canceled')
            						{
            							$txt_payment_status = 'Xxln With Deposit';
            						}
            						else if($row_payment_status['payment_status'] == 'N/A')
            						{
            							$txt_payment_status = 'Failed';
            						}
            						else if($row_payment_status['payment_status'] == 'refund')
            						{
            							$txt_payment_status = 'Refund Done';
            						}
            						else if($row_payment_status['payment_status'] == 'waiting_voucher')
            						{
            							$txt_payment_status = 'Refund Under Process';
            						}
            						else if($row_payment_status['payment_status'] == 'receipt_received')
            						{
            							$txt_payment_status = 'Receipt Received';
            						}
            						else if($row_payment_status['payment_status'] == 'voucher_submited')
            						{
            							$txt_payment_status = 'Rebooked';
            						}
            						else
            						{
            							$txt_payment_status = 'Pending';
            						}
                    				$order_date = $row['order_date'];
                    				
                    				$query_selection_meta = "SELECT * FROM wpk4_backend_history_of_meta_changes WHERE type_id ='$order_id_api' order by auto_id desc";
                                    $result_selection_meta = mysqli_query($mysqli, $query_selection_meta);
                                    $row_selection_meta_existingcount = mysqli_num_rows($result_selection_meta);
                                    if($row_selection_meta_existingcount > 0)
                                    {
                                        $row_selection_meta = mysqli_fetch_assoc($result_selection_meta);
                                        $gds_data_updated_on = date('d/m/Y H:i:s', strtotime($row_selection_meta['updated_on']));
                                        $is_gds_updated_got_updated = '<p class="blink_me">Updated on: '.$gds_data_updated_on.'</br></p>';
                                    }
                                    else
                                    {
                                        $is_gds_updated_got_updated = '';
                                    }
                                    
                                    $billing_email = '';
                                    $query_order_billing_email = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api'";
                                    $result_order_billing_email = mysqli_query($mysqli, $query_order_billing_email) or die(mysqli_error($mysqli));
                                    if(mysqli_num_rows($result_order_billing_email) > 0)
                                    {
                                        $row_order_billing_email = mysqli_fetch_assoc($result_order_billing_email);
                                        $billing_email = $row_order_billing_email['billing_email']; 
                                    }
                                
                    				?>
                    				<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                                    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
                                    <script>
                    				    function openCity(evt, cityName) {
                                		  var i, tabcontent, tablinks;
                                		  tabcontent = document.getElementsByClassName("tabcontent");
                                		  for (i = 0; i < tabcontent.length; i++) {
                                			tabcontent[i].style.display = "none";
                                		  }
                                		  tablinks = document.getElementsByClassName("tablinks");
                                		  for (i = 0; i < tablinks.length; i++) {
                                			tablinks[i].className = tablinks[i].className.replace(" active", "");
                                		  }
                                		  document.getElementById(cityName).style.display = "block";
                                		  evt.currentTarget.className += " active";
                                		  
                                		 
                                		}
                    				</script>
                    				</br>
                    				<div style="margin: auto; font-size:16px;">
                        				<div style="float: left; width:49%;">
                            			    Booking Ref: <?php echo $row['order_id']; ?> <?php if($row['co_order_id'] != '') { echo ' '.$row['co_order_id']; } ?></br>
                            				Agent: <?php echo $row['agent_info']; ?></br>
                            				Booked on: <?php echo $booking_date_dmy; ?></br>
                            				
                            				Travel Type: <?php 
                            				if($row['order_type'] == 'WPT')
                            				{
                            				    if($row_count > 1)
                            				    {
                            				        echo 'return';
													$final_order_type = 'return';
                            				    }
                            				    else
                            				    {
                            				        echo 'oneway';
													$final_order_type = 'oneway';
                            				    }
                            				}
                            				else
                            				{
                            				    echo $row['t_type']; 
												$final_order_type = $row['t_type'];
                            				}
                            				?></br>
                        				</div>
                        				<div style="float: right; width:49%;">
                        				    <?php if( $billing_email != '' && $billing_email != $email_pax ) { echo 'Billing Email: '.$billing_email.'</br>'; } ?>
                            				Email: <?php echo $email_pax; ?></br>
                            				Phone Number: <?php echo $phone_pax; ?></br>
                            				Pax: <?php echo $total_pax; ?></br>
                            				Payment Status: <?php 
                            				if($row_payment_status['payment_status'] == 'partially_paid' || $row_payment_status['payment_status'] == 'paid' || $row_payment_status['payment_status'] == 'Paid' || $row_payment_status['payment_status'] == 'zero_paid')
                                            {
                                                echo current_payment_status2($order_id_api).'</br>';
                                            }
                                            else
                                            {
                                                echo $txt_payment_status.'</br>';
                                            }
                                            ?>
                            				</br>
                            			</div>
                    				</div>
                    				</br></br></br></br></br>
                    				<style>
                    				.blink_me {
                                        animation: blinker 2s linear infinite;
                                        margin:0;
                                        padding:0;
                                    }
                                        
                                    @keyframes blinker {
                                        50% {
                                            opacity: 0;
                                        }
                                    }
                    				.search_bookings button, input[type=submit]
                    				{
                    				    background-color:#ffbb00;
                    				    color:black;
                    				}
                    				.tabnavigation
                    				{
                    				    float:left;
                    				    left:0;
                    				}
                        			.chatcategory
                        			{
                            			padding:7px 10px; 
                            			margin:0;
                            			font-size:13px;
                        			}
                        			.tab .active
                        			{
                        			    color:#FFF !important;
                        			    background-color:#000 !important
                        			}
                        			.ssr_request_radio_button {
                        			    margin-top: 10px; display: block;
                                        flex-wrap: wrap;
                                    }
                                    .ssr_request_radio_button label.radio {
                                     display:inline;
                                     position:relative;
                                     margin-left: 0.2em;
                                     _top:0.2em;
                                     }
                                     
                                     .radio-group {
                                            display: flex;
                                            align-items: center;
                                        }
                                        
                                        .radio-group label {
                                            margin-right: 10px;
                                            margin-top:13px;
                                        }
                                        .badge.badge-primary {
                                            background-color: #149efa;
                                        }
                                        
                                        .badge {
                                            display: inline-block;
                                            min-width: 10px;
                                            padding: 3px 7px;
                                            font-size: 12px;
                                            font-weight: 700;
                                            line-height: 1;
                                            color: #fff;
                                            text-align: center;
                                            white-space: nowrap;
                                            vertical-align: middle;
                                            background-color: #777;
                                            border-radius: 10px;
                                        }
                        			</style>
                        			<div class="tabnavigation search_bookings">
                        				<div class="tab">
        
                            				<button class="tablinks chatcategory active" onclick="openCity(event, 'summary_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">Summary</button>
                            				
                            				<button class="tablinks chatcategory" onclick="openCity(event, 'itinerary_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">Itinerary</button>
                            				<button class="tablinks chatcategory" onclick="openCity(event, 'names_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">Pax Names</button>
                            				<button class="tablinks chatcategory" onclick="openCity(event, 'payments_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">Payments</button>
                            				<button class="tablinks chatcategory" onclick="openCity(event, 'amount_adjustment_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">Amount Adjustment</button>
                            				<button class="tablinks chatcategory" onclick="openCity(event, 'portal_request_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">View Portal Requests</button>
                            				
											<?php
											$query_dc_count = "SELECT case_id FROM wpk4_backend_user_portal_requests where case_type = 'datechange' AND reservation_ref = '$order_id_api' ";
											
											$result_dc_count = mysqli_query($mysqli, $query_dc_count);
											if(mysqli_num_rows($result_dc_count) > 0)
											{
											?>
                            				<button class="tablinks chatcategory" onclick="openCity(event, 'dc_submission_edit_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">Date Change Request</button>
											<?php
											}
											else
											{
											?>
											<button class="tablinks chatcategory" onclick="openCity(event, 'dc_submission_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">Date Change Request</button>
											<?php
											}
											?>
											
                            				<button class="tablinks chatcategory" onclick="openCity(event, 'refund_request_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">Refund Request</button>
                            				<button class="tablinks chatcategory" onclick="openCity(event, 'complaintform_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">Feedback</button>
                            				<?php
                            				$query_is_ticket_submitted = "SELECT * FROM wpk4_backend_travel_booking_eticket_file_log where order_id = '$order_id_api' ";
        					                $result_is_ticket_submitted = mysqli_query($mysqli, $query_is_ticket_submitted);
                                            if(mysqli_num_rows($result_is_ticket_submitted) > 0)
                                            {
                                				{
                                				    ?>
                                				    <button class="tablinks chatcategory" onclick="openCity(event, 'eticketdownload_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">Eticket</button>
                                				    <?php
                                				}
                                            }
                            				if(isset($emailid) )
                            				{
                                				$query_is_refund_submitted = "SELECT * FROM wpk4_backend_travel_payment_outbound_azupay where order_id = '$order_id_api' and request_base_status = 'escalated'";
            					                $result_is_refund_submitted = mysqli_query($mysqli, $query_is_refund_submitted);
                                                if(mysqli_num_rows($result_is_refund_submitted) > 0)
                                                {
                                                    $row_summary_loop = mysqli_fetch_assoc($result_is_refund_submitted);
                                                    ?>
                                                    <a href="?p=edit-request-refund&id=<?php echo $row_summary_loop['auto_id']; ?>&oid=<?php echo $order_id_api; ?>"><button class="tablinks chatcategory">Edit deposit refund</button></a>
                                                    <?php
                                                }
                                                else
                                                {
                                                    $oid_key = md5($order_id_api);
                                                    ?>
                                                    <a href="?p=request-refund&ord=<?php echo $order_id_api; ?>&key=<?php echo $oid_key; ?>"><button class="tablinks chatcategory">Request deposit refund</button></a>
                                                    <?php
                                                }
                            				}
                            				$booking_date_ymd = date('Y-m-d', strtotime($row['order_date'])); 
							                $md5_key_of_order_date = md5($booking_date_ymd);
                                            $order_key = md5($order_id_api);                    
                            				?>
                            				<a href="/invoice/?order_id=<?php echo $order_id_api; ?>&key=<?php echo $order_key; ?>&pass=<?php echo $md5_key_of_order_date; ?>" target="_blank"><button class="tablinks chatcategory" >Invoice</button></a>
                    			    
                            			</div>
                        			</div>
                    				</br></br>
                    				<div id="tabcontent_main" style="font-size:14px;">
                    				    
                    				    <div id="summary_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>" class="tabcontent" >
                                            
                            				</br></br>
                            				<table class="table table-striped" style="width:100%; margin:auto;font-size:14px; margin-top:35px;">
                            					<thead>
                                					<tr>	
                                    					<th>Order ID</th>
                                    					<th style="text-align:center;">PNR</th>
                                    					<th style="text-align:center;">Flight Details</th>
                                    					<th style="text-align:center;">Travel Date</th>
                                				    </tr>
                            				    </thead>
                    				            <tbody>
                                				<?php
                                				$order_id = $order_id_api;
                                				$query_summary_loop = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api' && (order_type = 'WPT' || order_type = '') order by travel_date asc";
                                				$result_summary_loop = mysqli_query($mysqli, $query_summary_loop) or die(mysqli_error($mysqli));
                                				$total_paxs = 0;
                                				while($row_summary_loop = mysqli_fetch_assoc($result_summary_loop))
                                				{
                                					$order_id_summary = $row_summary_loop['order_id'];
                                					$product_id_summary = $row_summary_loop['product_id'];
                                					$co_order_id_summary = $row_summary_loop['co_order_id'];
                                					$pax_remarks=$row_summary_loop['remarks'];
                                
                                					$travel_date_domestic = date('Y-m-d', strtotime($row_summary_loop['travel_date'])); 
                                					$trip_code_domestic = $row_summary_loop['trip_code'];
                                					$tripcode_plus_trav_date_for_domestic_filter = $trip_code_domestic.$travel_date_domestic; //Eg: MEL-AMD-TR019-TR5742023-03-22
                                					
                                					$query_count = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_summary' && co_order_id='$co_order_id_summary' && product_id = '$product_id_summary'";
                                					$result_count = mysqli_query($mysqli, $query_count);
                                					$row_count = mysqli_num_rows($result_count);
                                				   
                                				    $query_movement = "SELECT * FROM wpk4_backend_travel_booking_movements where order_id='$order_id_summary' && product_id='$product_id_summary' && co_order_id='$co_order_id_summary' ";
                                					$result_movement = mysqli_query($mysqli, $query_movement);
                                					$row_movement_count = mysqli_num_rows($result_movement);
                                				   
                                				    $pnr_received = '';
                                					$query_count_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_summary' && co_order_id='$co_order_id_summary' && product_id='$product_id_summary'";
                                					$result_count_pax = mysqli_query($mysqli, $query_count_pax);
                                					if(mysqli_num_rows($result_count_pax) > 0)
                                					{
                                    					$row_count_pax = mysqli_fetch_assoc($result_count_pax);
                                    					$pnr_received = $row_count_pax['pnr'];
                                					}
                        							$total_paxs++;
                        							$x_id = 1;
                        							?>
                        							<tr>
                            							<td width='8%'><b>
                                							<?php echo $row_summary_loop['order_id']; ?> <?php if($co_order_id_summary != '') { echo ' '.$co_order_id_summary; } ?></b>
                                							</br>
                							            </td>
                            							<td width='8%' style="text-align:center;"><?php echo $pnr_received; ?></td>
                            							<td width='10%' style="text-align:center;">
                                                        	<?php echo $row_summary_loop['trip_code']; ?>
                                                        </td>
                            							<td width='5%' style="text-align:center;"> <?php echo date('d/m/Y', strtotime($row_summary_loop['travel_date']));?> </td>
                            							</tr>
                            							<?php
                            							$x_id++;
                                				}
												$order_id = $order_id_api;
                        				$query_summary_loop = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api' AND co_order_id='$co_order_id_api' && (order_type = 'Agent') order by travel_date asc";
                        				$result_summary_loop = mysqli_query($mysqli, $query_summary_loop) or die(mysqli_error($mysqli));
                        				$total_paxs = 0;
                        				while($row_summary_loop = mysqli_fetch_assoc($result_summary_loop))
                        				{
                        					$order_id_summary = $row_summary_loop['order_id'];
                        					$product_id_summary = $row_summary_loop['product_id'];
                        					$co_order_id_summary = $row_summary_loop['co_order_id'];
                        					$pax_remarks=$row_summary_loop['remarks'];
                        
                        					$travel_date_domestic = date('Y-m-d', strtotime($row_summary_loop['travel_date'])); 
                        					$trip_code_domestic = $row_summary_loop['trip_code'];
                        					$tripcode_plus_trav_date_for_domestic_filter = $trip_code_domestic.$travel_date_domestic; //Eg: MEL-AMD-TR019-TR5742023-03-22
                        					
                        					$query_count = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_summary' && co_order_id='$co_order_id_summary' && product_id = '$product_id_summary'";
                        					$result_count = mysqli_query($mysqli, $query_count);
                        					$row_count = mysqli_num_rows($result_count);
                        				   
                        				    $query_movement = "SELECT * FROM wpk4_backend_travel_booking_movements where order_id='$order_id_summary' && product_id='$product_id_summary' && co_order_id='$co_order_id_summary' ";
                        					$result_movement = mysqli_query($mysqli, $query_movement);
                        					$row_movement_count = mysqli_num_rows($result_movement);
                        				   
                        				    $pnr_received = '';
                        					$query_count_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_summary' && co_order_id='$co_order_id_summary' && product_id='$product_id_summary'";
                        					$result_count_pax = mysqli_query($mysqli, $query_count_pax);
                        					if(mysqli_num_rows($result_count_pax) > 0)
                        					{
                            					$row_count_pax = mysqli_fetch_assoc($result_count_pax);
                            					$pnr_received = $row_count_pax['pnr'];
                        					}
                							$total_paxs++;
                							$x_id = 1;
                							?>
                							<tr>
                    							<td width='8%'><b>
                        							<?php echo $row_summary_loop['order_id']; ?> <?php if($co_order_id_summary != '') { echo ' '.$co_order_id_summary; } ?></b>
                        							</br>
        							            </td>
                    							<?php 
                    							 $order_type = $row_summary_loop['order_type'];
                    							 $source_f = $row_summary_loop['source'];
                    							 $sourcebkng = $row_summary_loop['source'];
                    							 $gds_id = '';
                    
                    							$source= '';
                    							
                    							if ($order_type == 'WPT' && substr($trip_code_domestic, 8, 2) === 'SQ') {
                                                    $source = 'Gdeals';
                                                    $gds_id = 'CCUVS32NQ';
                                                }
                                                if ($order_type == 'WPT' && substr($trip_code_domestic, 8, 2) === 'QF') {
                                                    $source = 'Gdeals';
                                                    $gds_id = 'MELA821CV';
                                                }
                    							if($order_type == 'WPT' && $sourcebkng == 'wpwebsite' ){
                    							    $source = 'Gdeals';
                    							    $gds_id = 'CCUVS32NQ';
                    							}
                    						
                    							 if($order_type == 'gds' && $sourcebkng == 'gaurain' ){
                    							    $source = 'Sabre';
                    							    $gds_id = '1BIK';
                    							}
                    							 if($order_type == 'gds' && $sourcebkng == 'gauraaws' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'MELA821CV';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'gaura' ){
                    							    $source = 'Sabre';
                    							    $gds_id = 'I5FC';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'gaurandcx' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'MELA828FN';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'gaurainn' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'CCUVS32NQ';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'shelltechb2bina' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'CCUVS32NQ';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'shelltechb2bndcxau' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'MELA828FN';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'shelltechb2b' ){
                    							    $source = 'Sabre';
                    							    $gds_id = 'I5FC';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'shelltechb2baws' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'MELA828FN';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'shelltechb2bin' ){
                    							    $source = 'SABRE';
                    							    $gds_id = '1BIK';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'shelltechb2bndcxin' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'CCUVS32NQ';
                    							}
                    							
                    							if ($order_type == 'gds' && substr($pnr_received, 0, 3) === 'SQ_') {
                                                    $source = 'SQ NDC';
                                                    $gds_id = 'I5FC';
                                                } 
												
												if($order_type == 'gds' && $sourcebkng == 'import' ){
                    							    $source = 'Import';
                    							    $gds_id = 'MELA821CV';
                    							}
												
												$pnr_received_2 = substr($pnr_received, 0, 6);
												
												
												$query_oid_status = "SELECT OID FROM wpk4_backend_stock_management_sheet where pnr='$pnr_received_2' and OID is not null";
												$result_oid_status = mysqli_query($mysqli, $query_oid_status);
												if(mysqli_num_rows($result_oid_status) > 0)
												{
													$row_oid_status = mysqli_fetch_assoc($result_oid_status);
													$gds_id = $row_oid_status['OID'];
												}
												
                                                $pnrs[] = [
                                                        'pnr' =>$pnr_received_2,
                                                        'source' => $source,
                                                        'gds_id' =>$gds_id
                                                    ];
                    							?>
                    							<td width='8%' style="text-align:center;"><?php echo $pnr_received; ?></td>
                    						
                    							<td width='10%' style="text-align:center;">
                                                	<?php echo $row_summary_loop['trip_code']; ?>
                                                </td>
                    							<td width='5%' style="text-align:center;"> <?php echo date('d/m/Y', strtotime($row_summary_loop['travel_date']));?> </td>
                    							</tr>
                    							<?php
                    							$x_id++;
                        				}
                                				$query_summary_loop = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api' && order_type = 'gds'";
                                				$result_summary_loop = mysqli_query($mysqli, $query_summary_loop) or die(mysqli_error($mysqli));
                                				while($row_summary_loop = mysqli_fetch_assoc($result_summary_loop))
                                				{
                                					$order_id_summary = $row_summary_loop['order_id'];
                                					$product_id_summary = $row_summary_loop['product_id'];
                                					$co_order_id_summary = $row_summary_loop['co_order_id'];
                                					$pax_remarks=$row_summary_loop['remarks'];
                                					$return_date=$row_summary_loop['return_date'];
                                					$travel_date=$row_summary_loop['travel_date'];
                                					
                                					$travel_date_domestic = date('Y-m-d', strtotime($row_summary_loop['travel_date'])); 
                                    					$trip_code_domestic = $row_summary_loop['trip_code'];
                                    					$tripcode_plus_trav_date_for_domestic_filter = $trip_code_domestic.$travel_date_domestic; //Eg: MEL-AMD-TR019-TR5742023-03-22
                                    					
                                    					$query_count = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_summary' && co_order_id='$co_order_id_summary'";
                                    					$result_count = mysqli_query($mysqli, $query_count);
                                    					$row_count = mysqli_num_rows($result_count);
                                    				   
                                    				    $query_movement = "SELECT * FROM wpk4_backend_travel_booking_movements where order_id='$order_id_summary' && product_id='$product_id_summary' && co_order_id='$co_order_id_summary' ";
                                    					$result_movement = mysqli_query($mysqli, $query_movement);
                                    					$row_movement_count = mysqli_num_rows($result_movement);
                                    				   
                                    					$query_count_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_summary' && co_order_id='$co_order_id_summary' && product_id='$product_id_summary'";
                                    					$result_count_pax = mysqli_query($mysqli, $query_count_pax);
                                    					$row_count_pax = mysqli_fetch_assoc($result_count_pax);
                            							$total_paxs++;
                            							$x_id = 1;
                                							 $order_type = $row_summary_loop['order_type'];
                                							 //$source = $row_summary_loop['source'];
                                							 $sourcebkng = $row_summary_loop['source'];
                                							$pnr_received = $row_count_pax['pnr'];
                                							
                                                    if($return_date == $travel_date)
                                					{
                            							?>
                            							<tr>
                                							<td width='8%'><b>
                                    							<?php echo $row_summary_loop['order_id']; ?> <?php if($co_order_id_summary != '') { echo ' '.$co_order_id_summary; } ?></b>
                                    							</br>
                    							            </td>
                                							<td width='8%' style="text-align:center;"><?php echo $row_count_pax['pnr']; ?></td>
                                							<td width='10%' style="text-align:center;">
                                                            	<?php echo $row_summary_loop['trip_code']; ?>
                                                            </td>
                                							<td width='5%' style="text-align:center;"> <?php echo date('d-m-Y', strtotime($row_summary_loop['travel_date']));?> </td>
                                						</tr>
                                						<?php
                                					}
                                					else
                                					{
                                					    ?>
                                					    <tr>
                                							<td width='8%'><b>
                                    							<?php echo $row_summary_loop['order_id']; ?> <?php if($co_order_id_summary != '') { echo ' '.$co_order_id_summary; } ?></b>
                                    							</br>
                    							            </td>
                                							<td width='8%' style="text-align:center;"><?php echo $row_count_pax['pnr']; ?></td>
                                							<td width='10%' style="text-align:center;">
                                                            	<?php echo $row_summary_loop['trip_code']; ?>
                                                            </td>
                                							<td width='5%' style="text-align:center;"> <?php echo date('d-m-Y', strtotime($row_summary_loop['travel_date']));?> </td>
                                						</tr>
                            							<tr>
                                							<td width='8%'><b>
                                    							<?php echo $row_summary_loop['order_id']; ?> <?php if($co_order_id_summary != '') { echo ' '.$co_order_id_summary; } ?></b>
                                    							</br>
                    							            </td>
                                							<td width='8%' style="text-align:center;"><?php echo $row_count_pax['pnr']; ?></td>
                                							<td width='10%' style="text-align:center;">
                                                            <?php
                                                            $parts_trip = explode("-", $row_summary_loop['trip_code']);
        
                                                            if (count($parts_trip) >= 2) {
                                                                $origin_place = $parts_trip[0];
                                                                $destination_place = $parts_trip[1];
                                                            
                                                                echo $destination_place . ' - ' .$origin_place;
                                                            }
                                                            ?>
                                                            </td>
                                							<td width='5%' style="text-align:center;"> <?php echo date('d-m-Y', strtotime($row_summary_loop['return_date']));?> </td>
                                						</tr>
                                						<?php
                                					}
                                					
                                					$x_id++;
                                				}
                                				?>
                            				    </tbody>
                            				</table>
                        				</div>
                        				
                        				<div id="names_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                    				
                        				    <?php
                        				    $order_id = $order_id_api;
                        				    if($order_type_itinerary == 'WPT' || $order_type_itinerary == '' || $order_type_itinerary == 'Agent')
        				                    {
                            				    $total_paxs = 0;
                            				    $query_summary_loop = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api' AND co_order_id='$co_order_id_api'";
                            				    $result_loop = mysqli_query($mysqli, $query_summary_loop) or die(mysqli_error($mysqli));
                                			    while($row_loop = mysqli_fetch_assoc($result_loop))
                            				    {
                            				        $order_id_pax_view = $row_loop['order_id'];
                            				        $co_order_id_pax_view = $row_loop['co_order_id'];
                            				        $product_id_pax_view = $row_loop['product_id'];
													$travel_date_pax_view = date('Y-m-d', strtotime($row_loop['travel_date']));
                            				        echo $row_loop['product_title']. ' | ' .$row_loop['trip_code'];
                            				        ?>
                            				        <table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
                                					<thead>
                                    					<tr>
                                        					<th width='7%'>PNR</th>
                                        					<th width='10%'>Ticket</th>
                                        					<th width='3%'>Salutation</th>
															<th width='12%'>First Name</th>
															<th width='12%'>Last Name</th>
                                        					<th width='7%'>DOB</th>
                                        					<th width='7%'>PPN</th>
                                        					<th width='7%'>PPE</th>
                                        					<th width='8%'>Meal</th>
                                        					<th width='5%'>Wheelchair</th>
                                        					<th width='6%'>Baggage</th>
                                        					
                                    				    </tr>
                                				    </thead>
                                				    <tbody>
                            				        <?php
                            				        $query_summary_loop_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_pax_view' && co_order_id = '$co_order_id_pax_view' && product_id = '$product_id_pax_view'";
                                				    $result_loop_pax = mysqli_query($mysqli, $query_summary_loop_pax) or die(mysqli_error($mysqli));
                                				    $total_amount_from_pax = 0;
                                    			    while($row_loop_pax = mysqli_fetch_assoc($result_loop_pax))
                                    			    {
                                                        $total_paxs++;
                                						?>
                                						<tr>
															<td><?php echo $row_loop_pax['pnr']; ?></td>
															<td><?php echo $row_loop_pax['ticket_number']; 
															
															if($row_loop_pax['ticket_number'] == '' && $row_loop_pax['ticketed_by'] != '')
															{
																echo '</br></br>Ticket issued by '.$row_loop_pax['ticketed_by'];
															}
															
															?></td>
															
															<td><?php echo $row_loop_pax['salutation']; ?></td>
															<td><?php echo $row_loop_pax['fname']; ?></td>
															<td><?php echo $row_loop_pax['lname']; ?></td>
															
															<td><?php echo $row_loop_pax['dob']; ?></td>
															<td><?php echo $row_loop_pax['ppn']; ?></td>
															<td><?php echo $row_loop_pax['ppe']; ?></td>
															<td><?php echo $row_loop_pax['meal']; ?></td>
															<td><?php echo $row_loop_pax['wheelchair']; ?></td>
															<td><?php echo $row_loop_pax['baggage']; ?></td>
															
															
                                						</tr>
                                						<?php
                                    			    }
                                    			    ?>
                                    			    </tbody>
                    				                </table></br></br>
                                    			    <?php
                            				    }
        				                    }
        				                    else
        				                    {
        				                        $total_paxs = 0;
                            				    $query_summary_loop = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api' AND co_order_id='$co_order_id_api'";
                            				    $result_loop = mysqli_query($mysqli, $query_summary_loop) or die(mysqli_error($mysqli));
                                			    while($row_loop = mysqli_fetch_assoc($result_loop))
                            				    {
                            				        $destination_place = '';
                            				        $order_id_pax_view = $row_loop['order_id'];
                            				        $travel_date = $row_loop['travel_date'];
			                                        $return_date = $row_loop['return_date'];
                            				        $co_order_id_pax_view = $row_loop['co_order_id'];
                            				        $product_id_pax_view = $row_loop['product_id'];
                            				        if($return_date != $travel_date) // return trip block
			                                        {
			                                            $origin_place = '';
			                                            $parts_trip = explode("-", $row_loop['trip_code']);
                                				        if (count($parts_trip) >= 2) {
                                                            $origin_place = $parts_trip[0];
                                                            $destination_place = $parts_trip[1];
                                                                echo '<tr><th colspan="6">'. $origin_place . ' - ' . $destination_place . ' - ' . $travel_date .'</th></tr>';
                                                        }
                                				        ?>
                                				        <table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
                                    					<thead>
                                        					<tr>
																<th width='7%'>PNR</th>
                                        					<th width='10%'>Ticket</th>
                                        					<th width='3%'>Salutation</th>
															<th width='12%'>First Name</th>
															<th width='12%'>Last Name</th>
                                        					<th width='7%'>DOB</th>
                                        					<th width='7%'>PPN</th>
                                        					<th width='7%'>PPE</th>
                                        					<th width='8%'>Meal</th>
                                        					<th width='5%'>Wheelchair</th>
                                        					<th width='6%'>Baggage</th>
																
                                        				    </tr>
                                    				    </thead>
                                    				    <tbody>
                                				        <?php
                                				        $query_summary_loop_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_pax_view' && co_order_id = '$co_order_id_pax_view' && product_id = '$product_id_pax_view'";
                                    				    $result_loop_pax = mysqli_query($mysqli, $query_summary_loop_pax) or die(mysqli_error($mysqli));
                                        			    while($row_loop_pax = mysqli_fetch_assoc($result_loop_pax))
                                        			    {
                                        			        $baggage_match_checker = $row_loop_pax['gds_pax_id'] . ' - ' . $origin_place . ' - Baggage';
                                        			        $baggage_value = $row_loop_pax['baggage'];
                                        			        $query_baggage_value = "SELECT * FROM wpk4_backend_history_of_updates where type_id='$order_id_api' AND meta_key = '$baggage_match_checker'";
                                                        	$result_baggage_value = mysqli_query($mysqli, $query_baggage_value);
                                                        	if(mysqli_num_rows($result_baggage_value) > 0)
                                                        	{
                                                            	while($row_baggage_value = mysqli_fetch_assoc($result_baggage_value))
                                                            	{
                                                            	    $baggage_value = $row_baggage_value['meta_value'];
                                                            	}
                                        			        } 
                                                            $total_paxs++;
                                    						?>
                                    						<tr>
                                    						<td><?php echo $row_loop_pax['pnr']; ?></td>
                                    						<td><?php echo $row_loop_pax['ticket_number']; ?></td>
                                    						<td><?php echo $row_loop_pax['salutation']; ?></td>
															<td><?php echo $row_loop_pax['fname']; ?></td>
															<td><?php echo $row_loop_pax['lname']; ?></td>
                                    						<td><?php echo $row_loop_pax['dob']; ?></td>
                                    						<td><?php echo $row_loop_pax['ppn']; ?></td>
                                    						<td><?php echo $row_loop_pax['ppe']; ?></td>
                                    						<td><?php echo $row_loop_pax['meal']; ?></td>
                                    						<td><?php echo $row_loop_pax['wheelchair']; ?></td>
                                    						<td><?php echo $baggage_value; ?></td>
                                    						
                                    						</tr>
                                    						<?php
                                        			    }
                                        			    ?>
                                        			    </tbody>
                        				                </table></br></br>
                        				                <?php
                        				                $parts_trip = explode("-", $row_loop['trip_code']);
                                				        if (count($parts_trip) >= 2) {
                                                            $origin_place = $parts_trip[0];
                                                            $destination_place = $parts_trip[1];
                                                                echo '<tr><th colspan="6">'. $destination_place . ' - ' . $origin_place . ' - ' . $return_date .'</th></tr>';
                                                        }
                                				        ?>
                                				        <table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
                                    					<thead>
                                        					<tr>
                                            					<th width='7%'>PNR</th>
                                        					<th width='10%'>Ticket</th>
                                        					<th width='3%'>Salutation</th>
															<th width='12%'>First Name</th>
															<th width='12%'>Last Name</th>
                                        					<th width='7%'>DOB</th>
                                        					<th width='7%'>PPN</th>
                                        					<th width='7%'>PPE</th>
                                        					<th width='8%'>Meal</th>
                                        					<th width='5%'>Wheelchair</th>
                                        					<th width='6%'>Baggage</th>
																
                                        				    </tr>
                                    				    </thead>
                                    				    <tbody>
                                				        <?php
                                				        $query_summary_loop_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_pax_view' && co_order_id = '$co_order_id_pax_view' && product_id = '$product_id_pax_view'";
                                    				    $result_loop_pax = mysqli_query($mysqli, $query_summary_loop_pax) or die(mysqli_error($mysqli));
                                        			    while($row_loop_pax = mysqli_fetch_assoc($result_loop_pax))
                                        			    {
                                        			        $baggage_match_checker = $row_loop_pax['gds_pax_id'] . ' - ' . $destination_place . ' - Baggage';
                                        			        $baggage_value = $row_loop_pax['baggage'];
                                        			        $query_baggage_value = "SELECT * FROM wpk4_backend_history_of_updates where type_id='$order_id_api' AND meta_key = '$baggage_match_checker'";
                                                        	$result_baggage_value = mysqli_query($mysqli, $query_baggage_value);
                                                        	if(mysqli_num_rows($result_baggage_value) > 0)
                                                        	{
                                                            	while($row_baggage_value = mysqli_fetch_assoc($result_baggage_value))
                                                            	{
                                                            	    $baggage_value = $row_baggage_value['meta_value'];
                                                            	}
                                        			        } 
                                                            $total_paxs++;
                                    						?>
                                    						<tr>
                                    						<td><?php echo $row_loop_pax['pnr']; ?></td>
                                    						<td><?php echo $row_loop_pax['ticket_number']; ?></td>
                                    						<td><?php echo $row_loop_pax['salutation']; ?></td>
															<td><?php echo $row_loop_pax['fname']; ?></td>
															<td><?php echo $row_loop_pax['lname']; ?></td>
                                    						<td><?php echo $row_loop_pax['dob']; ?></td>
                                    						<td><?php echo $row_loop_pax['ppn']; ?></td>
                                    						<td><?php echo $row_loop_pax['ppe']; ?></td>
                                    						<td><?php echo $row_loop_pax['meal']; ?></td>
                                    						<td><?php echo $row_loop_pax['wheelchair']; ?></td>
                                    						<td><?php echo $baggage_value; ?></td>
                                    						
                                    						</tr>
                                    						<?php
                                        			    }
                                        			    ?>
                                        			    </tbody>
                        				                </table></br></br>
                                        			    <?php
			                                        }
			                                        else
			                                        {
			                                            $origin_place = '';
			                                            $parts_trip = explode("-", $row_loop['trip_code']);
                                				        if (count($parts_trip) >= 2) {
                                                            $origin_place = $parts_trip[0];
                                                            $destination_place = $parts_trip[1];
                                                                echo '<tr><th colspan="6">'. $origin_place . ' - ' . $destination_place . ' - ' . $travel_date .'</th></tr>';
                                                        }
			                                            ?>
			                                            <table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
                                    					<thead>
                                        					<tr>
                                            					<th width='7%'>PNR</th>
                                        					<th width='10%'>Ticket</th>
                                        					<th width='3%'>Salutation</th>
															<th width='12%'>First Name</th>
															<th width='12%'>Last Name</th>
                                        					<th width='7%'>DOB</th>
                                        					<th width='7%'>PPN</th>
                                        					<th width='7%'>PPE</th>
                                        					<th width='8%'>Meal</th>
                                        					<th width='5%'>Wheelchair</th>
                                        					<th width='6%'>Baggage</th>
																
                                        				    </tr>
                                    				    </thead>
                                    				    <tbody>
                                				        <?php
                                				        $query_summary_loop_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_pax_view' && co_order_id = '$co_order_id_pax_view' && product_id = '$product_id_pax_view'";
                                    				    $result_loop_pax = mysqli_query($mysqli, $query_summary_loop_pax) or die(mysqli_error($mysqli));
                                        			    while($row_loop_pax = mysqli_fetch_assoc($result_loop_pax))
                                        			    {
                                        			        $baggage_match_checker = $row_loop_pax['gds_pax_id'] . ' - ' . $origin_place . ' - Baggage';
                                        			        $baggage_value = $row_loop_pax['baggage'];
                                        			        $query_baggage_value = "SELECT * FROM wpk4_backend_history_of_updates where type_id='$order_id_api' AND meta_key = '$baggage_match_checker'";
                                                        	$result_baggage_value = mysqli_query($mysqli, $query_baggage_value);
                                                        	if(mysqli_num_rows($result_baggage_value) > 0)
                                                        	{
                                                            	while($row_baggage_value = mysqli_fetch_assoc($result_baggage_value))
                                                            	{
                                                            	    $baggage_value = $row_baggage_value['meta_value'];
                                                            	}
                                        			        } 
                                                            $total_paxs++;
                                    						?>
                                    						<tr>
                                    						<td width='8%'><?php echo $row_loop_pax['pnr']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['ticket_number']; ?></td>
                                    						<td width='3%'><?php echo $row_loop_pax['salutation']; ?></td>
															<td width='8%'><?php echo $row_loop_pax['fname']; ?></td>
															<td width='8%'><?php echo $row_loop_pax['lname']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['dob']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['ppn']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['ppe']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['meal']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['wheelchair']; ?></td>
                                    						<td width='8%'><?php echo $baggage_value; ?></td>
                                    						
                                    						</tr>
                                    						<?php
                                        			    }
                                        			    ?>
                                        			    </tbody>
                        				                </table></br></br>
			                                            <?php
			                                        }
                            				    }
        				                    }
                        				    ?>
    				            </div>

    				            <div id="payments_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>" class="tabcontent" style="display:none;">
                        				    <?php
                				    $order_id = $order_id_api;
                				    $query_initial_order = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api'";
                                	$result_initial_order = mysqli_query($mysqli, $query_initial_order);
                                	$row_initial_order = mysqli_fetch_assoc($result_initial_order);
                                    $order_date = $row_initial_order['order_date'];
                                    $order_type_paymentblock = $row_initial_order['order_type'];
									$source_paymentblock = $row_initial_order['source'];
                                    $payment_status = $row_initial_order['payment_status'];
                                    $late_modified = $row_initial_order['late_modified'];
                                    $modified_by = $row_initial_order['modified_by'];
                                    $payment_modified = $row_initial_order['payment_modified'];
                                    $payment_modified_by = $row_initial_order['payment_modified_by'];
                                    $deposit_amount = '';
                                    if($order_type_paymentblock != 'gds' )
                                        {
                                            
                                        $total_amount = $row_initial_order['total_amount'];
                                        $total_amount_from_postmeta = $total_amount;
                                        $deposit_amount = $row_initial_order['deposit_amount'];
                                        $balance = $row_initial_order['balance'];
                                        
                                        
                                            $wpt_coupon_code_array = get_post_meta($order_id_api, 'wp_travel_applied_coupon_data', true);
                                            if(isset($wpt_coupon_code_array) && $wpt_coupon_code_array != '' && isset($wpt_coupon_code_array['coupon_code']) && $wpt_coupon_code_array['coupon_code'] != '')
                                            {
                                                $ordertotal__query = $wpdb->get_results( "SELECT * FROM wpk4_postmeta where post_id='$order_id_api' && meta_key='order_totals'"); 
                                                foreach($ordertotal__query as $row_2){ 
                                                    $order_total_amount = $row_2->meta_value;
                                                }
                                                $orderData = unserialize($order_total_amount);
                                                //$total_amount = $orderData['sub_total'];
                                                $total_amount_from_postmeta = $orderData['cart_total'];
                                                $balance = $total_amount - $deposit_amount;
                                            }
                                            
                                        }
                                    
                                    $total_amount_gds = 0;
                                    if($order_type_paymentblock == 'gds' && $deposit_amount == '' )
                                    {
										$total_amount = $row_initial_order['total_amount'];
                                        $deposit_amount = $row_initial_order['deposit_amount'];
                                        $total_amount_gds = get_meta_from_history_of_updates($order_id_api, 'Transaction TotalTurnover');
                                        $total_amount_temp = (float)get_meta_from_history_of_updates($order_id_api, 'Transaction TotalTurnover');
										
										if($total_amount_temp > 0)
										{
											$total_amount = $total_amount_temp;
										}
                                        $total_amount_from_postmeta = $total_amount;
                                        if($deposit_amount == '')
                                        {
                                            
                                            $deposit_amount_temp = 0;
                                            $query_initial_order_meta = "SELECT * FROM wpk4_backend_history_of_updates where type_id='$order_id_api' && meta_key = 'Payments Amount'";
                                        	$result_initial_order_meta = mysqli_query($mysqli, $query_initial_order_meta);
                                        	while($row_initial_order_meta = mysqli_fetch_assoc($result_initial_order_meta))
                                        	{
                                        	    $deposit_amount_temp = $deposit_amount_temp + (float)$row_initial_order_meta['meta_value'];
                                        	}
                                    	    $deposit_amount = $deposit_amount_temp;
                                        }
                                        $balance = (float)$total_amount - (float)$deposit_amount;
                                    }
									
									if($source_paymentblock == 'datechange')
									{
										$total_amount = $row_initial_order['total_amount'];
                                        $total_amount_from_postmeta = $total_amount;
                                        //$deposit_amount = $row_initial_order['deposit_amount'];
                                        $balance = '';
									}
                                    
                                    /* Intermediate code added to resolve the issue on G360 GDS total amount shown as 0 after use Update from GDS option. */
                                    if($currnt_userlogn == 'sriharshans' && 1 == 3)
                                    {
                                    if((float)$total_amount_gds == 0 && $order_type_paymentblock == 'gds')
                                    {
                                        $total_amount = $row_initial_order['total_amount'];
                                        
                                        $deposit_amount = $row_initial_order['deposit_amount'];

                                        if($deposit_amount == '')
                                        {
                                            
                                            $deposit_amount_temp = 0;
                                            $query_initial_order_meta = "SELECT * FROM wpk4_backend_history_of_updates where type_id='$order_id_api' && meta_key = 'Payments Amount'";
                                        	$result_initial_order_meta = mysqli_query($mysqli, $query_initial_order_meta);
											if(mysqli_num_rows($result_initial_order_meta) > 0)
											{
                                        	while($row_initial_order_meta = mysqli_fetch_assoc($result_initial_order_meta))
                                        	{
                                        	    $deposit_amount_temp = $deposit_amount_temp + (float)$row_initial_order_meta['meta_value'];
                                        	}
											}
                                    	    $deposit_amount = $deposit_amount_temp;
                                        }
                                        $balance = (float)$total_amount - (float)$deposit_amount;
                                        
                                    }
                                    }
                                    /* Intermediate code ends */
                                    
                                    $query_pnr_for_total_paid = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api'";
                                    $result_pnr_for_total_paid = mysqli_query($mysqli, $query_pnr_for_total_paid);
                                    $row_pnr_for_total_paid = mysqli_fetch_assoc($result_pnr_for_total_paid);
                                	$received_pnr_for_total_paid = $row_pnr_for_total_paid['pnr'];
                                	$processedPaymentsPaid = array();	
                            		$query_payment_paid_amount = "SELECT * FROM wpk4_backend_travel_payment_history where (pay_type = 'deposit' OR pay_type LIKE 'balance' 
                            		OR pay_type LIKE 'Balance' OR pay_type = 'deposit_adjustment' OR pay_type = 'Refund' OR pay_type = 'additional_payment') 
                            		AND order_id='$order_id_api' order by process_date desc";
                                    $result_payment_paid_amount = mysqli_query($mysqli, $query_payment_paid_amount);
                                    $total_paid_for_booking = 0;
                                    if($result_payment_paid_amount && mysqli_num_rows($result_payment_paid_amount) > 0)
                                    {
                                        while($row_payment_paid_amount = mysqli_fetch_assoc($result_payment_paid_amount))
                                        {
                                            $payment_identifier = $row_payment_paid_amount['process_date'].'^'.$row_payment_paid_amount['trams_received_amount'].'^'.$row_payment_paid_amount['reference_no']; // defined value to restric duplicate amount + ref no combination on G360
                                			if (in_array($payment_identifier, $processedPaymentsPaid)) 
                                			{
                                			    continue; // Skip to the next value
                                			}
                                				
                                				
                                			$processedPaymentsPaid[] = $payment_identifier;
                                					
                                            $total_paid_for_booking += (float)$row_payment_paid_amount['trams_received_amount'];
                                        }
                                        
                                        if($total_paid_for_booking < 0)
                                        {
                                            $total_paid_for_booking = 0;
                                        }
                                        
                                        $balance = (float)$total_amount - (float)$total_paid_for_booking; 
                                    }
                                    
                                    if($balance == '')
                            		{
                            		    $balance = (float)$total_amount - (float)$deposit_amount;
                            		}
                				    ?>
                				    <?php
                				    $discount_given_amount = 0;
                				    if($order_type_paymentblock == 'WPT' )
                                    {
                                        $wpt_coupon_code_array = get_post_meta($order_id_api, 'wp_travel_applied_coupon_data', true);
                                        if(isset($wpt_coupon_code_array) && $wpt_coupon_code_array != '' && isset($wpt_coupon_code_array['coupon_code']) && $wpt_coupon_code_array['coupon_code'] != '')
                                        {
                                            $wpt_coupon_code_type = '';
                                            if($wpt_coupon_code_array['type'] == 'percentage')
                                            {
                                                $wpt_coupon_code_type = '%';
                                            }
                                            $discount_given_amount = $total_amount_from_postmeta - $total_amount;
                                            ?>
                                            </br></br>
                                            Total amount before discount: <b><?php echo number_format((float)$total_amount_from_postmeta, 2, '.', ''); ?></b></br>
                                            Discount given: <b><?php echo number_format((float)$discount_given_amount, 2, '.', ''); ?></b></br>
                                            Coupon applied: <b><?php echo $wpt_coupon_code_array['coupon_code']; ?> (Discount: <?php echo $wpt_coupon_code_array['value'].$wpt_coupon_code_type; ?>)</b></br>
                                            <?php
                                        }
                                    }
                				    ?>
                				    </br>
                				    <?php
                				    if($discount_given_amount != 0)
                				    {
                				        echo 'Total Amount after discount: ';
                				    }
                				    else
                				    {
                				         echo 'Total Amount: ';
                				    }
                				    ?>
                                        <b><?php echo number_format((float)$total_amount, 2, '.', ''); ?></b>
                                    
                                    <?php
                                    if($total_paid_for_booking < 0)
                                    {
                                        $total_paid_for_booking = 0;
                                    }
                                    
                                    ?>
                                    </br>
                                    Amount paid: <b><?php echo number_format((float)$total_paid_for_booking, 2, '.', ''); ?></b></br>
                                    Balance: <b><?php echo number_format((float)$balance, 2, '.', ''); ?></b>
                                            </br></br>
                                            <?php
                                            $is_past_payment_link_active = 0;
                                            $query_paymentrequest_history_check = "SELECT * FROM wpk4_backend_travel_booking_custom_payments where order_id='$order_id_api' and 
                                            type_of_payment = 'Balance Payment' and status = 'waiting' and date(requested_on) = DATE(CURRENT_DATE()) order by auto_id desc limit 4;";
                                            $result_paymentrequest_history_check = mysqli_query($mysqli, $query_paymentrequest_history_check);
                                            if(mysqli_num_rows($result_paymentrequest_history_check) > 3)
                                            {
                                                $is_past_payment_link_active = 1;
                                            }
                                            // reshare the existing payment link
                                            if(($row_payment_status['payment_status'] == 'partially_paid' && $is_past_payment_link_active == 1) )
                                            {
                                                $row_previous_payment = mysqli_fetch_assoc($result_paymentrequest_history_check);
                                                
                                                $paymentRequestcheckoutUrl = $row_previous_payment['azupay_link'];
                                                $virtualBsb = $row_previous_payment['azupay_bsb'];
                                                $virtualAccountNumber = $row_previous_payment['azupay_account_number'];
                                                $paymentRequestAmount = $row_previous_payment['amount'];
                                                $paylater_link = $row_previous_payment['skypay_link'];
                                                $crn = $row_previous_payment['bpay_crn'];
                                                $payment_type_numbering = 1;
                                                $bankDetails = '';
                    
                                                $azupayDetails = "
                                                    {$payment_type_numbering}. Pay by bank transfer by clicking on the below link for immediate booking confirmation.
                                                    </br>
                                                    &nbsp;&nbsp;&nbsp;<a target='_blank' href='{$paymentRequestcheckoutUrl}' style='background-color: #ffbb00; border: none; color: white; padding: 10px 16px; margin: 10px 0px; text-align: center; text-decoration: none; display: inline-block; font-size: 13px;'>Pay via PayID (Recommended)</a>
                                                ";
                                            
                                            
                                            if ($virtualBsb != '' && $virtualAccountNumber != '') {
                                                $payment_type_numbering++;
                                                $bankDetails = "
                                                    <div style='display: flex; align-items: center; text-align: center; margin-bottom: 0px; margin-top:10px;'>
                                                        <hr style='flex: 1; border-top: 1px solid #623f3f; margin: 0;'>
                                                        <span style='padding: 0 10px; color: #623f3f;'>OR</span>
                                                        <hr style='flex: 1; border-top: 1px solid #623f3f; margin: 0;'>
                                                    </div>
                                                    </br>
                                                    {$payment_type_numbering}. Pay to Bank account.</br>
                                                    &nbsp;&nbsp;&nbsp;&#9656; Amount: $$paymentRequestAmount (Pay the exact amount)</br>
                                                    &nbsp;&nbsp;&nbsp;&#9656; Account Name: Gaura Travel</br> 
                                                    &nbsp;&nbsp;&nbsp;&#9656; BSB: $virtualBsb </br>
                                                    &nbsp;&nbsp;&nbsp;&#9656; Account Number: $virtualAccountNumber </br>
                                                ";
                                            }
                                            
                                            if($paylater_link != '')
                                            {
                                                $payment_type_numbering++;
                                                $paylater_link = '<div style="display: flex; align-items: center; text-align: center; margin-bottom: 0px; margin-top:10px;">
                                                    <hr style="flex: 1; border-top: 1px solid #623f3f; margin: 0;">
                                                    <span style="padding: 0 10px; color: #623f3f;">OR</span>
                                                    <hr style="flex: 1; border-top: 1px solid #623f3f; margin: 0;">
                                                </div></br>
                                                '.$payment_type_numbering.'. Pay 10% now and settle the remaining amount in weekly installments. Please click on the above link.</br>&nbsp;&nbsp;&nbsp;'.$paylater_link.'</br>';
                                            }
                                            else
                                            {
                                                $paylater_link = '';
                                            }
                                            
                                            if($crn != '')
                                            {
                                                $payment_type_numbering++;
                                                $bpay_logo = "https://gauratravel.com.au/wp-content/uploads/2024/01/bpay-icon.png";
                                                $bpay_msg = '<div style="display: flex; align-items: center; text-align: center; margin-bottom: 0px; margin-top:10px;">
                                                    <hr style="flex: 1; border-top: 1px solid #623f3f; margin: 0;">
                                                    <span style="padding: 0 10px; color: #623f3f;">OR</span>
                                                    <hr style="flex: 1; border-top: 1px solid #623f3f; margin: 0;">
                                                </div></br>
                                                '.$payment_type_numbering.'. 
                                                Pay with your credit card via BPAY.</br>
                                                            &nbsp;&nbsp;&nbsp;&#9656; Log into your internet banking </br> 
                                                            &nbsp;&nbsp;&nbsp;&#9656; Go to BPAY </br>
                                                            &nbsp;&nbsp;&nbsp;&#9656; Enter the biller code (33829) and ref no ('.$crn.')</br>
                                                            &nbsp;&nbsp;&nbsp;&#9656; Enter the balance amount of $'.$paymentRequestAmount.'</br>
                                                <div class="row ">
                                                    <div class="col-sm-auto image-1" style="width: 276px; height: 134px; background: url('.$bpay_logo.') no-repeat center center; background-size: cover; display: flex;  justify-content: center; color: black; font-weight: 500; font-size: 14px;">
                                                        <p class="text-header" style="margin-top: -10%; margin-left: 60%; color: black; font-weight:500; font-size: 14px; transform: translate(0%, 26%); text-align: center;">33829</br>'. htmlspecialchars($crn).'</p>
                                                    </div>
                                                </div>
                                                ';
                                            }
                                            else
                                            {
                                                $bpay_msg = '';
                                            }
                                            $paymentInfo = "
                                            Here are your payment options: 
                                            </br></br>
                                            {$azupayDetails}
                                            {$bankDetails}
                                            {$paylater_link}
                                            {$bpay_msg}
                                            ";
                                            
                                            // Define the unique ID for the Payments tab
                                            $paymentsTabId = "payments_{$order_id_api}{$co_order_id_api}{$product_id_api}";
        
                    	                    echo "
                                            <script>
                                                // Construct payment information
                                                const paymentInfo = `{$paymentInfo}`;
                                                const paymentsTabId = '{$paymentsTabId}';
                                                
                                                // Function to show the modal
                                                function showPaymentModal2() {
                                                
                                                    document.getElementById('paymentOptions').innerHTML = paymentInfo;
                                                    document.getElementById('paymentModal').style.display = 'flex';
                                                    
                                                    openCity(event, paymentsTabId);
                                                    
                                                }
                                            </script>
                                            ";
                                            echo '
                                                <div style="border:1px solid #e0dada; margin-top:15px; padding:15px 15px;">
                                                
                                                    <!-- Checkbox -->
                                                    <label style="font-weight:400; font-size:13px;">
                                                        <input type="checkbox" id="checkbox1" onclick="checkCheckboxes()">
                                                        &nbsp;&nbsp;I have read and accepted the itinerary information. the <a target="_blank" href="terms-and-conditions/">terms & conditions of the travel agency</a>, the airline&#39;s ticket rules & itinerary information.
                                                    </label><br>
                                            
                                                    <!-- Wrapper for Pay Now Button -->
                                                    <div onclick="handleButtonClick()">
                                                        <!-- Pay Now Button (Initially Disabled) -->
                                                        <button id="payNowButton" style="padding:15px; background-color: #ffbb00; margin:0; font-size:11px; font-weight:600;" disabled>PAY NOW</button>
                                                    </div>
                                            
                                                    <script>
                                                        // Function to check if the checkbox is checked
                                                        function checkCheckboxes() {
                                                            const checkbox1 = document.getElementById("checkbox1");
                                                            const payNowButton = document.getElementById("payNowButton");
                                            
                                                            // Enable the button if the checkbox is checked
                                                            if (checkbox1.checked) {
                                                                payNowButton.disabled = false;
                                                            } else {
                                                                payNowButton.disabled = true;
                                                            }
                                                        }
                                            
                                                        // Function to handle button click through the wrapper div
                                                        function handleButtonClick() {
                                                            const payNowButton = document.getElementById("payNowButton");
                                            
                                                            // Check if the button is disabled and show an alert if it is
                                                            if (payNowButton.disabled) {
                                                                alert("Please check the box to enable the PAY NOW button.");
                                                            } else {
                                                                // If enabled, open the payment modal
                                                                showPaymentModal2();
                                                            }
                                                        }
                                                    </script>
                                                </div>
                                            ';
                                            }
                                            // create new payment links
                                            if( ($row_payment_status['payment_status'] == 'partially_paid' && $is_past_payment_link_active == 0 ) )
                                            {
                                            ?>
                                                <div style="border:1px solid #e0dada; margin-top:15px; padding:15px 15px;">
                                                <form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                                    <?php
                                                    
                                                    $received_pnr_for_azupay_receipt = '';
                                                    $query_pnr_case = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id'";
                                                	$result_pnr_case = mysqli_query($mysqli, $query_pnr_case);
                                                	while($row_pnr_case = mysqli_fetch_assoc($result_pnr_case))
                                                	{
                                        				$received_pnr_for_azupay_receipt = $row_pnr_case['pnr']; // get one PNR for azupay customer viewing
                                                	}
                                                    ?>
                                                    <input type="hidden" readonly name="order_id" required value="<?php echo $order_id; ?>">
                                        			<input type="hidden" name="emailid" value="<?php echo $email_pax; ?>" required>
													<input type="hidden" name="source_of_booking_form" value="<?php echo $source_of_booking; ?>" required>
                                                	<input type="hidden" name="pnr" value="<?php echo $received_pnr_for_azupay_receipt; ?>">
                                                    <input type="hidden" name="payment_amount" value="<?php echo $balance; ?>" required>
                                                    <label style="font-weight:400; font-size:13px;">
                                                        <input type="checkbox" id="checkbox1" required>
                                                        &nbsp;&nbsp;I have read and accepted the itinerary information. the <a target="_blank" href="terms-and-conditions/">terms & conditions of the travel agency</a>, the airline&#39;s ticket rules & itinerary information.
                                                    </label><br>
                                                    <input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='make_general_payment_request' value='Pay Balance Now ($<?php echo $balance; ?>)'>
                                        		</form>
                                        		</br>
                                        		
                                        		</div>
                                            <?php
                                            }
											
                                            if( ($row_payment_status['payment_status'] == 'partially_paid' || $row_payment_status['payment_status'] == 'zero_paid') && ( number_format((float)$total_paid_for_booking, 2, '.', '') == 0.00 || $total_paid_for_booking == 0 ))
                                                {
                                                    $payment_partial_value_deposit = 0;
                                                    
                                                    //if($payment_partial_value_deposit == '' || empty($payment_partial_value_deposit) || $payment_partial_value_deposit = 0)
                                                    {
                                                        $query_payment_amount_deposit = "SELECT total_amount, total_pax FROM wpk4_backend_travel_bookings where order_id='$order_id'";
                                                        $result_payment_amount_deposit = mysqli_query($mysqli, $query_payment_amount_deposit);
                                                        $row_payment_amount_deposit = mysqli_fetch_assoc($result_payment_amount_deposit);
                                                        //$payment_partial_value_deposit = $row_payment_amount_deposit['total_amount'] * 0.05;
														
														$payment_partial_value_deposit = (int)$row_payment_amount_deposit['total_pax'] * 5;
                                                    }
                                                    
                                                    $payment_partial_value_deposit = number_format((float)$payment_partial_value_deposit, 2, '.', '');
                                                    
													if($payment_partial_value_deposit > 0)
													{
                                                    ?>
													</br>
                                                    <div>
                                                        <a href="?p=make-deposit&orderID=<?php echo $order_id_api; ?>&key=<?php echo $_GET['key']; ?>"><button id="payDepositNowButton" style="padding:15px; color:black; background-color: #ffbb00; margin:0; font-size:11px; font-weight:600;">PAY $<?php echo $payment_partial_value_deposit; ?> DEPOSIT NOW</button></a>
                                                    </div>
                                                    <?php
													}
                                                }
                                                ?>
                                            </br>
											<?php 
											if( $row_payment_status['payment_status'] == 'partially_paid' )
                                            {
											?>
                                            <div style="border:1px solid #e0dada; margin-top:15px; padding:15px 15px;">
                                            <h6>Add BPAY Receipt</h6>
                                    		    <form action="#" name="statusupdate" method="post" enctype="multipart/form-data" >
                                        		<style>
                                        		    .myattachmentchat_g360
                                        		    {
                                        		        display:block;
                                        		    }
                                        		</style>
                                        		<input type="file" accept=".jpg,.jpeg,.png,.pdf,.txt" class='myattachmentchat_g360' name="myattachmentchat" id="myattachmentchat"></br>
                                        		<p style="font-size:11px;">Allowed file types are .jpg, .png, .pdf</p>
                                			    <input type='submit' name='updateattachment_bpay' id='updateattachment_bpay' class='btn btn-success' style='padding:15px; margin:0;font-size:11px;' value='Upload'>
                                		    </form>
                                		    </div>
											<?php
											}
											?>
                                		    <?php
                                		    if(isset($_POST['updateattachment_bpay']))
                            				{
                                                if($_FILES['myattachmentchat']['name'] != '')
                                                {
                                				    $type = 'g360paymentattachments'; //type
                                                    $fileName = $_FILES['myattachmentchat']['name'];
                                            		$temp = explode(".", $_FILES["myattachmentchat"]["name"]);
                                            		$ext = end((explode(".", $_FILES["myattachmentchat"]["name"])));
                                            		$filename_time = date('ymdHis');
                                            		$newfilename =  'g360paymentattachments_'. $filename_time . '.' .$ext;
                                            	
                                
                                                    $currentDirectory = getcwd();
                                            		$uploadDirectory = "wp-content/uploads/customized_function_uploads/";
                                            		$errors = []; // Store errors here
                                            		$fileExtensionsAllowed = ['jpeg','jpg','png','pdf','JPEG','JPG','PNG','PDF']; // These will be the only file extensions allowed 
                                            						
                                            		$fileSize = $_FILES['myattachmentchat']['size'];
                                            		$fileTmpName  = $_FILES['myattachmentchat']['tmp_name'];
                                            		$fileType = $_FILES['myattachmentchat']['type'];
                                            		$fileExtension = strtolower(end(explode('.',$fileName)));
                                            		$uploadPath = $uploadDirectory . basename($newfilename); 
                                            						
                                            		if (! in_array($fileExtension,$fileExtensionsAllowed)) {
                                            			$errors[] = "This file extension is not allowed. Please upload a JPEG, PNG or PDF file";
                                            			}
                                            		if ($fileSize > 4000000) {
                                            			$errors[] = "File exceeds maximum size (4MB)";
                                            			 }
                                            		if (empty($errors)) {
                                                		    $didUpload = move_uploaded_file($fileTmpName, $uploadPath);
                                                			if ($didUpload) {
                                                			//echo "The file has been uploaded";
                                                		} else {
                                                			echo "An error occurred. Please contact the Admin.";
                                                		}
                                            		} else {
                                            				foreach ($errors as $error) {
                                            				echo $error . "" . "\n";
                                            			}
                                            		}
                                            		
                                            		$type2 = 'bpay_receipt_awaiting_approval';
                                            		
                                            		$sql_subpayment_store ="UPDATE wpk4_backend_travel_bookings
                                                            SET sub_payment_status = 'BPAY Received'
                                                        WHERE order_id='$order_id_api'";
                                                    $results_subpayment_store = $wpdb->query($sql_subpayment_store);
                                            		add_g360_event_history($order_id_api, $co_order_id_api, $product_id_api, $type2, $newfilename , 'Customer', $current_date_and_time);  
													$current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                                    echo '<script>window.location.href="'.$current_url.'";</script>';
                            				    }
                            				}
                            				?>
                                            <style>
                                                    /* Basic styles for the modal */
                                                    .modal-payment {
                                                        display: none;
                                                        position: fixed;
                                                        z-index: 10000;
                                                        left: 0;
                                                        top: 0;
                                                        width: 100%;
                                                        height: 100%;
                                                        overflow: auto;
                                                        background-color: rgba(0, 0, 0, 0.5);
                                                        justify-content: center;
                                                        align-items: center;
                                                    }
                                                    .modal-payment-content {
                                                        background-color: white;
                                                        padding: 20px;
                                                        border-radius: 5px;
                                                        width: 80%;
                                                        max-width: 600px;
                                                    }
                                                    .close-payment {
                                                        color: #aaa;
                                                        float: right;
                                                        font-size: 28px;
                                                        font-weight: bold;
                                                        cursor: pointer;
                                                    }
                                                </style>
                                                <div id="paymentModal" class="modal-payment">
                                                    <div class="modal-payment-content">
                                                        <span class="close-payment">&times;</span>
                                                        <p id="paymentOptions"></p>
                                                    </div>
                                                </div>
                                                
                                                <script>
                                                    // JavaScript to close the modal when clicking outside or on the close button
                                                    document.querySelector('.close-payment').onclick = function() {
                                                        document.getElementById('paymentModal').style.display = "none";
                                                    };
                                                    window.onclick = function(event) {
                                                        if (event.target == document.getElementById('paymentModal')) {
                                                            //document.getElementById('paymentModal').style.display = "none";
                                                        }
                                                    };
                                                </script>
                                            <?php
                                            // DC total charge section
                                    		$query_payment_dc_amount = "SELECT * FROM wpk4_backend_travel_payment_history WHERE (pay_type = 'Datechange' OR pay_type LIKE 'dc_charge') AND order_id='$order_id_api' AND order_id != '' ORDER BY process_date DESC";
                                            $result_payment_dc_amount = mysqli_query($mysqli, $query_payment_dc_amount);
                                            // Initialize an array to hold the sums of trams_received_amount for each reference_no
                                            $sums_by_reference = array();
                                            // Initialize an array to track processed payments (to avoid duplicates)
                                            $processedPaymentsDC = array();
                                            if (mysqli_num_rows($result_payment_dc_amount) > 0) {
                                                echo '</br></br>';
                                                while ($row_payment_dc_amount = mysqli_fetch_assoc($result_payment_dc_amount)) {
                                                    $temp_ref_no = explode("_", $row_payment_dc_amount['reference_no']);
                                                    if(!isset($temp_ref_no[1]) || ( isset($temp_ref_no[1]) && $temp_ref_no[1] == '') )
                                                    {
                                                        $temp_ref_no[1] = 'N/A';
                                                    }
                                                    $payment_identifier = $row_payment_dc_amount['process_date'] . '^' . $row_payment_dc_amount['trams_received_amount'] . '^' . $row_payment_dc_amount['reference_no'];
                                                    // Skip duplicate entries
                                                    if (in_array($payment_identifier, $processedPaymentsDC)) {
                                                        continue;
                                                    }
                                                    $processedPaymentsDC[] = $payment_identifier;
                                                    // Add the trams_received_amount to the total for the current reference_no
                                                    if (!isset($sums_by_reference[$temp_ref_no[1]])) {
                                                        $sums_by_reference[$temp_ref_no[1]] = 0.0;
                                                    }
                                                    $sums_by_reference[$temp_ref_no[1]] += (float)$row_payment_dc_amount['trams_received_amount'];
                                                }
                                                // Display the total trams_received_amount for each reference_no
                                                foreach ($sums_by_reference as $reference_no => $totalpaid_case) {
                                                    
                                                    
                                                    $query_dc_pay_status = "SELECT * FROM wpk4_backend_travel_booking_custom_payments where payment_client_id LIKE '%$reference_no%'";
                                                    $result_dc_pay_status = mysqli_query($mysqli, $query_dc_pay_status);
                                                    $dc_total_payment_for_case = 0;
                                                    if(mysqli_num_rows($result_dc_pay_status) > 0)
                                            		{
                                                		while($count_dc_pay_status = mysqli_fetch_assoc($result_dc_pay_status))
                                                		{
                                    					    $dc_total_payment_for_case += (float)$count_dc_pay_status['amount'];
                                                		}
                                            		}
                                            		$dc_balance_for_case = $dc_total_payment_for_case - $totalpaid_case;
                                            		
                                            		// assiging dummy 0.00 to avoid negative value as there are no requested amount found.
                                            		if($dc_total_payment_for_case == 0)
                                            		{
                                            		    $dc_balance_for_case = 0.00;
                                            		}
                                            				
                                                    echo 'Case: <b>' . $reference_no . '</b><br>
                                                    Requested: <b>' . number_format($dc_total_payment_for_case, 2, '.', '') . '</b><br>
                                                    Paid: <b>' . number_format($totalpaid_case, 2, '.', '') . '</b><br>
                                                    Balance: <b>' . number_format($dc_balance_for_case, 2, '.', '') . '</b><br><br>';
                                                    
                                                }
                                                
                                            }
                                            else
                                            {
                                                echo '<br/><br/>';
                                            }
                                            
                                                $query_pnr_for_payments = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api'";
                                                $result_pnr_for_payments = mysqli_query($mysqli, $query_pnr_for_payments);
                                                $row_pnr_for_payments = mysqli_fetch_assoc($result_pnr_for_payments);
                                                $received_order_type_for_payments = $row_pnr_for_payments['order_type'];
                                        		$received_pnr_for_payments = $row_pnr_for_payments['pnr'];
                                                $processedPayments = array();
                                                if($received_order_type_for_payments == 'WPT')
                                                {
                                                    ?>
                                                    <h6>Booking Payment</h6>
                                                    <table class="table" style="font-size:13px;">
                                                        <tr>
                                                            <th>Payment Date</th><th>Type</th><th>Paid Amount</th><th>Reference No</th><th>Remark</th><th>Method</th>
                                                        </tr>
                                                        <?php
                                                        $query_payment_history = "SELECT * FROM wpk4_backend_travel_payment_history where order_id='$order_id_api' AND (pay_type IN ('deposit', 'balance', 'balance ', 'Balance', 'deposit_adjustment', 'Refund', 'additional_payment') OR pay_type IS NULL OR pay_type = '') order by process_date desc";
                                                    	$result_payment_history = mysqli_query($mysqli, $query_payment_history);
                                                    	if(mysqli_num_rows($result_payment_history) > 0)
                                                    	{
                                                    	    
                                                        	while($row_payment_history = mysqli_fetch_assoc($result_payment_history))
                                                        	{
                                                                $payment_identifier = $row_payment_history['process_date'].'^'.$row_payment_history['trams_received_amount'].'^'.$row_payment_history['reference_no']; // defined value to restric duplicate amount + ref no combination on G360
                                            					if (in_array($payment_identifier, $processedPayments)) 
                                            					{
                                            					   continue; // Skip to the next value
                                            					}
                                            							
                                            					$processedPayments[] = $payment_identifier;
                                            						
                                                        	    $current_pay_method_id = $row_payment_history['payment_method'];
                                                        	    $query_payment_method_finder = "SELECT * FROM wpk4_backend_accounts_bank_account where bank_id='$current_pay_method_id'";
                                                            	$result_payment_method_finder = mysqli_query($mysqli, $query_payment_method_finder);
                                                            	$row_payment_method_finder = mysqli_fetch_assoc($result_payment_method_finder);
                                                            	$row_payment_method_finder_count = mysqli_num_rows($result_payment_method_finder);
                                                            	$bank_account_type_name = '';
                                                            	if($row_payment_method_finder_count > 0)
                                                            	{
                                                            	    $bank_account_type_name = $row_payment_method_finder['account_name'];
                                                            	}
                                                                ?>
                                                                <tr>
                                                                    <td><?php echo date('d/m/Y H:i:s', strtotime($row_payment_history['process_date'])); ?></td>
                                                                    <td>
                                                                        <?php 
                                                                        if($row_payment_history['pay_type'] == 'deposit')
                                                                        {
                                                                            echo "Booking Deposit"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'balance' || $row_payment_history['pay_type'] == 'balance ' || $row_payment_history['pay_type'] == 'Balance')
                                                                        {
                                                                            echo "Booking Balance"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'deposit_adjustment')
                                                                        {
                                                                            echo "Booking Deposit Adjustment"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'dc_charge')
                                                                        {
                                                                            echo "Datechange"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'Datechange')
                                                                        {
                                                                            echo "Datechange"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'additional_payment')
                                                                        {
                                                                            echo "Additional Payment"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'Refund')
                                                                        {
                                                                            echo "Refund"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'other')
                                                                        {
                                                                            echo "Other"; 
                                                                        }
                                                                        else
                                                                        {
                                                                            echo "Unknown"; 
                                                                        }
                                                                        ?>
                                                                    </td>
                                                                    <td><?php echo $row_payment_history['trams_received_amount']; ?></td>
                                                                    <td><?php echo $row_payment_history['reference_no']; ?></td>
                                                                    <td><?php echo $row_payment_history['trams_remarks']; ?></td>
                                                                    <td><?php echo $bank_account_type_name; ?></td> 
                                                                </tr>
                                                                <?php
                                                            }
                                                    	}
                                                    	else
                                                		{
                                                		    echo '<td colspan="6">No record found</td>';
                                                		}
                                                    	?>
                                                	</table>
                                                	
                                                	<h6>Other Payment</h6>
                                                	<table class="table" style="font-size:13px;">
                                                        <tr>
                                                            <th>Payment Date</th><th>Type</th><th>Paid Amount</th><th>Reference No</th><th>Remark</th><th>Method</th>
                                                        </tr>
                                                    	<?php
                                                    	$query_payment_history = "SELECT * FROM wpk4_backend_travel_payment_history where order_id='$order_id_api' AND pay_type IN ('dc_charge', 'Datechange', 'other') order by process_date desc";
                                                    	$result_payment_history = mysqli_query($mysqli, $query_payment_history);
                                                    	if(mysqli_num_rows($result_payment_history) > 0)
                                                    	{
                                                    	    
                                                        	while($row_payment_history = mysqli_fetch_assoc($result_payment_history))
                                                        	{
                                                                $payment_identifier = $row_payment_history['process_date'].'^'.$row_payment_history['trams_received_amount'].'^'.$row_payment_history['reference_no']; // defined value to restric duplicate amount + ref no combination on G360
                                            					if (in_array($payment_identifier, $processedPayments)) 
                                            					{
                                            					   continue; // Skip to the next value
                                            					}
                                            							
                                            					$processedPayments[] = $payment_identifier;
                                            						
                                                        	    $current_pay_method_id = $row_payment_history['payment_method'];
                                                        	    $query_payment_method_finder = "SELECT * FROM wpk4_backend_accounts_bank_account where bank_id='$current_pay_method_id'";
                                                            	$result_payment_method_finder = mysqli_query($mysqli, $query_payment_method_finder);
                                                            	$row_payment_method_finder = mysqli_fetch_assoc($result_payment_method_finder);
                                                            	$row_payment_method_finder_count = mysqli_num_rows($result_payment_method_finder);
                                                            	$bank_account_type_name = '';
                                                            	if($row_payment_method_finder_count > 0)
                                                            	{
                                                            	    $bank_account_type_name = $row_payment_method_finder['account_name'];
                                                            	}
                                                                ?>
                                                                <tr>
                                                                    <td><?php echo date('d/m/Y H:i:s', strtotime($row_payment_history['process_date'])); ?></td>
                                                                    <td>
                                                                        <?php 
                                                                        if($row_payment_history['pay_type'] == 'deposit')
                                                                        {
                                                                            echo "Booking Deposit"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'balance' || $row_payment_history['pay_type'] == 'balance ' || $row_payment_history['pay_type'] == 'Balance')
                                                                        {
                                                                            echo "Booking Balance"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'deposit_adjustment')
                                                                        {
                                                                            echo "Booking Deposit Adjustment"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'dc_charge')
                                                                        {
                                                                            echo "Datechange"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'Datechange')
                                                                        {
                                                                            echo "Datechange"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'additional_payment')
                                                                        {
                                                                            echo "Additional Payment"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'other')
                                                                        {
                                                                            echo "Other"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'Refund')
                                                                        {
                                                                            echo "Refund"; 
                                                                        }
                                                                        else
                                                                        {
                                                                            echo "Unknown"; 
                                                                        }
                                                                        ?>
                                                                    </td>
                                                                    <td><?php echo $row_payment_history['trams_received_amount']; ?></td>
                                                                    <td><?php echo $row_payment_history['reference_no']; ?></td>
                                                                    <td><?php echo $row_payment_history['trams_remarks']; ?></td>
                                                                    <td><?php echo $bank_account_type_name; ?></td> 
                                                                    
                                                                </tr>
                                                                <?php
                                                            }
                                                    	}
                                                    	else
                                                		{
                                                		    echo '<td colspan="6">No record found</td>';
                                                		}
                                                	?>
                                                	</table>
                                                	<?php
                                                }
                                                else
                                                {
                                                    ?>
                                                    <h6>Booking Payment</h6>
                                                    <table class="table" style="font-size:13px;">
                                                        <tr>
                                                            <th>Payment Date</th><th>Type</th><th>Paid Amount</th><th>Reference No</th><th>Remark</th><th>Method</th>
                                                        </tr>
                                                        <?php
                                                        $payment_history_count = 0;
                                                        $query_payment_history = "SELECT * FROM wpk4_backend_travel_payment_history where order_id='$order_id_api' AND order_id != '' AND (pay_type IN ('deposit', 'balance', 'balance ', 'Balance', 'deposit_adjustment', 'Refund') OR pay_type IS NULL OR pay_type = '') order by process_date desc";
                                                    	$result_payment_history = mysqli_query($mysqli, $query_payment_history);
                                                    	if(mysqli_num_rows($result_payment_history) > 0)
                                                    	{
                                                        	while($row_payment_history = mysqli_fetch_assoc($result_payment_history))
                                                        	{
                                                        	    
                                                        	    $payment_identifier = $row_payment_history['process_date'].'^'.$row_payment_history['trams_received_amount'].'^'.$row_payment_history['reference_no']; // defined value to restric duplicate amount + ref no combination on G360
                                            					if (in_array($payment_identifier, $processedPayments)) 
                                            					{
                                            					   continue; // Skip to the next value
                                            					}
                                            							
                                            					$processedPayments[] = $payment_identifier;
                                            					
                                                        	    $current_pay_method_id = $row_payment_history['payment_method'];
                                                        	    $query_payment_method_finder = "SELECT * FROM wpk4_backend_accounts_bank_account where bank_id='$current_pay_method_id'";
                                                            	$result_payment_method_finder = mysqli_query($mysqli, $query_payment_method_finder);
                                                            	$row_payment_method_finder = mysqli_fetch_assoc($result_payment_method_finder);
                                                            	$row_payment_method_finder_count = mysqli_num_rows($result_payment_method_finder);
                                                            	$bank_account_type_name = '';
                                                            	if($row_payment_method_finder_count > 0)
                                                            	{
                                                            	    $bank_account_type_name = $row_payment_method_finder['account_name'];
                                                            	}
                                                        	    
                                                        	    $payment_history_count++;
                                                                ?>
                                                                <tr>
                                                                    <td><?php echo date('d/m/Y H:i:s', strtotime($row_payment_history['process_date'])); ?></td>
                                                                    <td>
                                                                        <?php 
                                                                        if($row_payment_history['pay_type'] == 'deposit')
                                                                        {
                                                                            echo "Booking Deposit"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'balance' || $row_payment_history['pay_type'] == 'balance ' || $row_payment_history['pay_type'] == 'Balance')
                                                                        {
                                                                            echo "Booking Balance"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'deposit_adjustment')
                                                                        {
                                                                            echo "Booking Deposit Adjustment"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'dc_charge')
                                                                        {
                                                                            echo "Datechange"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'Datechange')
                                                                        {
                                                                            echo "Datechange"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'additional_payment')
                                                                        {
                                                                            echo "Additional Payment"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'other')
                                                                        {
                                                                            echo "Other"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'Refund')
                                                                        {
                                                                            echo "Refund"; 
                                                                        }
                                                                        else
                                                                        {
                                                                            echo "Unknown"; 
                                                                        }
                                                                        ?>
                                                                    </td>
                                                                    <td><?php echo $row_payment_history['trams_received_amount']; ?></td>
                                                                    <td><?php echo $row_payment_history['reference_no']; ?></td>
                                                                    <td><?php echo $row_payment_history['trams_remarks']; ?></td>
                                                                    <td><?php echo $bank_account_type_name; ?></td> 
                                                                </tr>
                                                                <?php
                                                        	}
                                                    	}
                                                    	else
                                                		{
                                                		    echo '<td colspan="6">No record found</td>';
                                                		}
                                                    	?>
                                                    </table>
                                                    
                                                    <h6>Other Payment</h6>
                                                	<table class="table" style="font-size:13px;">
                                                        <tr>
                                                            <th>Payment Date</th><th>Type</th><th>Paid Amount</th><th>Reference No</th><th>Remark</th><th>Method</th>
                                                        </tr>
                                                    	<?php
                                                        $query_payment_history = "SELECT * FROM wpk4_backend_travel_payment_history where order_id='$order_id_api' AND order_id != '' AND pay_type IN ('dc_charge', 'Datechange', 'additional_payment', 'other') order by process_date desc";
                                                    	$result_payment_history = mysqli_query($mysqli, $query_payment_history);
                                                    	if(mysqli_num_rows($result_payment_history) > 0)
                                                    	{
                                                        	while($row_payment_history = mysqli_fetch_assoc($result_payment_history))
                                                        	{
                                                        	    
                                                        	    $payment_identifier = $row_payment_history['process_date'].'^'.$row_payment_history['trams_received_amount'].'^'.$row_payment_history['reference_no']; // defined value to restric duplicate amount + ref no combination on G360
                                            					if (in_array($payment_identifier, $processedPayments)) 
                                            					{
                                            					   continue; // Skip to the next value
                                            					}
                                            							
                                            					$processedPayments[] = $payment_identifier;
                                            					
                                                        	    $current_pay_method_id = $row_payment_history['payment_method'];
                                                        	    $query_payment_method_finder = "SELECT * FROM wpk4_backend_accounts_bank_account where bank_id='$current_pay_method_id'";
                                                            	$result_payment_method_finder = mysqli_query($mysqli, $query_payment_method_finder);
                                                            	$row_payment_method_finder = mysqli_fetch_assoc($result_payment_method_finder);
                                                            	$row_payment_method_finder_count = mysqli_num_rows($result_payment_method_finder);
                                                            	$bank_account_type_name = '';
                                                            	if($row_payment_method_finder_count > 0)
                                                            	{
                                                            	    $bank_account_type_name = $row_payment_method_finder['account_name'];
                                                            	}
                                                        	    
                                                                ?>
                                                                <tr>
                                                                    <td><?php echo date('d/m/Y H:i:s', strtotime($row_payment_history['process_date'])); ?></td>
                                                                    <td>
                                                                        <?php 
                                                                        if($row_payment_history['pay_type'] == 'deposit')
                                                                        {
                                                                            echo "Booking Deposit"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'balance' || $row_payment_history['pay_type'] == 'balance ' || $row_payment_history['pay_type'] == 'Balance')
                                                                        {
                                                                            echo "Booking Balance"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'deposit_adjustment')
                                                                        {
                                                                            echo "Booking Deposit Adjustment"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'dc_charge')
                                                                        {
                                                                            echo "Datechange"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'Datechange')
                                                                        {
                                                                            echo "Datechange"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'additional_payment')
                                                                        {
                                                                            echo "Additional Payment"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'other')
                                                                        {
                                                                            echo "Other"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'Refund')
                                                                        {
                                                                            echo "Refund"; 
                                                                        }
                                                                        else
                                                                        {
                                                                            echo "Unknown"; 
                                                                        }
                                                                        ?>
                                                                    </td>
                                                                    <td><?php echo $row_payment_history['trams_received_amount']; ?></td>
                                                                    <td><?php echo $row_payment_history['reference_no']; ?></td>
                                                                    <td><?php echo $row_payment_history['trams_remarks']; ?></td>
                                                                    <td><?php echo $bank_account_type_name; ?></td> 
                                                                    
                                                                </tr>
                                                                <?php
                                                        	}
                                                    	}
                                                    	else
                                                		{
                                                		    echo '<td colspan="6">No record found</td>';
                                                		}
                                                    	?>
                                                	</table>
                                                    <?php
                                                }
                                            	
                                            	
                                            if(isset($_POST['make_general_payment_request']))
                                            {
                            				    $order_id_for_payment_request = $_POST['order_id'];
                                                $emailid_for_payment_request = $_POST['emailid'];
												$source_of_booking_form = $_POST['source_of_booking_form'];
                                                $type_of_payment_for_payment_request = 'Balance Payment';
                                                $pnr_for_payment_request = $_POST['pnr'];
                                                $paymentAmount = $_POST['payment_amount'];
                                                $customer_case_id_for_payment_request = '0';
                                                
                                                $paymentAmount_2Decimal = number_format((float)$_POST['payment_amount'], 2, '.', '') ;
                                                //if(!in_array($paymentAmount_2Decimal, $amount_list))
                                                {
                                                    
                                                    if($order_id_for_payment_request && $paymentAmount && $type_of_payment_for_payment_request)
                                                    {
                                				        if (class_exists('GuzzleHttp\Client'))
                                				        {
                                                            if($type_of_payment_for_payment_request == 'Balance Payment')
                                                            {
                                                                $callback_url = 'https://gauratravel.com.au/azupay-post-receiver/';
                                                                $clientTransactionId = $order_id_for_payment_request.'_RE_'.date("is");
                                                            }
                                                            else if($type_of_payment_for_payment_request == 'Less Amount')
                                                            {
                                                                $callback_url = 'https://gauratravel.com.au/azupay-callback-custom/';
                                                                $clientTransactionId = $order_id_for_payment_request.'_'.date("dis");
                                                            }
                                                            else
                                                            {
                                                                $callback_url = 'https://gauratravel.com.au/azupay-post-receiver-dc/';
                                                                $clientTransactionId = $order_id_for_payment_request."_".date("dis");
                                                            }
															
															
                                                            
                                                            if($paymentAmount_2Decimal > 0.01)
                                                            {
                                                                $query_pnr_case_ = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_for_payment_request'";
                                                                $result_pnr_case_ = mysqli_query($mysqli, $query_pnr_case_);
                                                                $row_pnr_case_ = mysqli_fetch_assoc($result_pnr_case_);
                                                                $order_type_for_azupay = $row_pnr_case_['order_type'];
                                                        		$received_pnr_for_azupay = trim($row_pnr_case_['pnr']);
                                                                if($order_type_for_azupay == 'WPT')
                                                                {
                                                                    $paymentDescription = $type_of_payment_for_payment_request. " for Booking #".$order_id_for_payment_request;
                                                                }
                                                                else
                                                                {
                                                                    if($received_pnr_for_azupay != '')
                                                                    {
                                                                        $paymentDescription = $type_of_payment_for_payment_request . " for Booking #".$received_pnr_for_azupay;
                                                                    }
                                                                    else
                                                                    {
                                                                        $paymentDescription = $type_of_payment_for_payment_request . " for Booking #".$order_id_for_payment_request;
                                                                    }
                                                                }
                                                                
                                                                $query_get_travel_date = "SELECT travel_date, trip_code FROM wpk4_backend_travel_bookings where order_id = '$order_id_for_payment_request' order by travel_date asc limit 1";
                                                                $result_get_travel_date = mysqli_query($mysqli, $query_get_travel_date);
                                                                $row_get_travel_date = mysqli_fetch_assoc($result_get_travel_date);
                                                                $departureDate = date('Y-m-d', strtotime($row_get_travel_date['travel_date']));
                                                                
                                                                $start_day = strtotime(date('Y-m-d', strtotime($row_get_travel_date['travel_date'])));
                                                                $current_day = strtotime(date('Y-m-d'));
                                                                
                                                                $travel_vs_current_date_difference = ( $start_day - $current_day ) / (60 * 60 * 24);
                                                                
                                                                if( $travel_vs_current_date_difference > 10 )
                                                                {
                                                                    $next_3_days = date("Y-m-d", strtotime("+4 days"));
                                                                    $current_time = date("H:i:s");
                                                                    $next_3_days2 = $next_3_days."T".$current_time."Z";
                                                                }
                                                                else
                                                                {
                                                                    $next_1_days_24hrs = date('d/m/Y').' 23:59';
                                                                    $next_3_days2 = date("Y-m-d")."T23:59:59Z";
                                                                }
                                                                
                                                                
            
                                                                $day_of_after_24_hrs = date("d") + 1;
                                                                if($day_of_after_24_hrs < 10) {
                                                                    $day_of_after_24_hrs = "0".$day_of_after_24_hrs;
                                                                }
                                                                $current_time_plus_24_hrs = date($day_of_after_24_hrs."/m/Y H:i:s");
                                                                
                                                                $paymentDetails = generateAzupayPaymentRequestCustomer($next_3_days2, $clientTransactionId, $paymentAmount, $paymentDescription, $callback_url);
                                                               
                                                                // Extract individual values
                                                                if(isset($paymentDetails) && isset($paymentDetails['paymentRequestId']))
                                                                {
                                                                    $paymentRequestId = $paymentDetails['paymentRequestId'];
                                                                    $paymentRequestcreatedDateTime = $paymentDetails['createdDateTime'];
                                                                    $paymentRequestcheckoutUrl = $paymentDetails['checkoutUrl'];
                                                                    $paymentRequestExpiryDatetime = $paymentDetails['paymentExpiryDatetime'];
                                                                    $paymentRequestExpiryDatetime_ymd = $paymentDetails['paymentExpiryDatetimeYMD'];
                                                                    $paymentRequestpayID = $paymentDetails['payID'];
                                                                    $paymentRequestAmount = $paymentDetails['paymentAmount'];
                                                                    $full_payment_auth_code = $paymentDetails['paymentAuthCode'];
                                                                    $virtualBsb = $paymentDetails['virtualBsb'];
                                                                    $virtualAccountNumber = $paymentDetails['virtualAccountNumber'];
                                                                    
                                                                    $sql_authcode_store ="UPDATE wpk4_backend_travel_bookings
                                                                        SET full_payment_auth_code = '$full_payment_auth_code'
                                                                    WHERE order_id='$order_id_for_payment_request'";
                                                                    $results_authcode_store = $wpdb->query($sql_authcode_store);
                                                                    
                                                                    if(isset($paymentRequestId) && $paymentRequestId != '')
                                    							    {
                                    							        // SkyPay Request Starts
                                    							        $paymentAmount = floatval($paymentAmount);
                                    							        $paymentAmount = number_format($paymentAmount, 2, '.', '');
                                    							        // Check if the price contains a decimal point
                                    							        if (strpos($paymentAmount, '.') !== false) {
                                    							            $newSalePrice = (int) str_replace('.', '', $paymentAmount);
                                    							        } else {
                                    							            $newSalePrice = (int) $paymentAmount * 100;
                                                                        }
                                                                        $query_get_travel_date = "SELECT travel_date, trip_code FROM wpk4_backend_travel_bookings where order_id = '$order_id_for_payment_request' order by travel_date asc limit 1";
                                                                        $result_get_travel_date = mysqli_query($mysqli, $query_get_travel_date);
                                                                        $row_get_travel_date = mysqli_fetch_assoc($result_get_travel_date);
                                                                        $departureDate = date('Y-m-d', strtotime($row_get_travel_date['travel_date']));
                                                                        $limitTimestamp = date("Y-m-d H:i:s", strtotime("+14 days", strtotime(date("Y-m-d").' 23:59:59')));
                                                                        //echo '<script>alert("azupay: '.$paymentRequestId.'")</script>';
                                                                        // PAY LATER START
                                                                        
                                                                        $paylater_link = '';
                                                                        if($departureDate > $limitTimestamp && $type_of_payment_for_payment_request == 'Balance Payment' && $travel_vs_current_date_difference >= 10 )
                                                                        {
                                                                            $paylater_link = generateSkyPayPaymentRequestCustomer($newSalePrice, $departureDate, $order_id_for_payment_request);
                                        							    }
                                        							    //echo '<script>alert("skypay: '.$paylater_link.'")</script>';
                                                                        // SkyPay Request Ends
                                                                        // BPAY Request Starts
                                                                        $bpay = true;
																		
																		if(isset($source_of_booking_form) && $source_of_booking_form == 'datechange')
																		{
																			$bpay = false;
																			$paylater_link = '';
																		}
															
                                                                        $bpay_logo = "https://gauratravel.com.au/wp-content/uploads/2024/01/bpay-icon.png";
                                                                        $crn = '';
                                                                        $exp_date = '';
                                                                        $limitTimestamp_bpay = date("Y-m-d", strtotime("+10 days", strtotime(date("Y-m-d").' 23:59:59')));
                                                                        $is_bpay_enabled_with_travel_date = false;
                                                                        if(isset($bpay) && $type_of_payment_for_payment_request == 'Balance Payment' && $departureDate >= $limitTimestamp_bpay && $travel_vs_current_date_difference >= 10 )
                                                                        {
                                                                            $is_bpay_enabled_with_travel_date = true;
                                                                            $order_id = $order_id_for_payment_request; // baseCustomerNumber
                                                                            $exp_date = date("Y-m-d", strtotime("+1 days"));
                                                                            $amount = $paymentAmount_2Decimal;
                                                                            $authcode = generateAuthCodeCustomer();
                                                                            $response_generateCRNValidation = generateCRNWithAmountCustomer($authcode, $order_id, $amount, $exp_date);
                                                                            $data_generateCRNValidation = json_decode($response_generateCRNValidation, true);
                                                                            //echo '<pre>';
                                                                            //print_r($data_generateCRNValidation);
                                                                            //echo '</pre>';
                                                                            //echo '<script>alert("bpay draft: '.$response_generateCRNValidation.'")</script>';
                                                                            if (isset($data_generateCRNValidation['crnResults'])) 
                                                                            {
                                                                                foreach ($data_generateCRNValidation['crnResults'] as $resultcrn) 
                                                                                {
                                                                                    if($resultcrn['crn'] != '') 
                                                                                    {
                                                                                        // Extract the data
                                                                                        $tid = $resultcrn['tid'];
                                                                                        $customerNumber = $resultcrn['baseCustomerNumber'];
                                                                                        $crn = $resultcrn['crn'];
                                                                                                
                                                                                        $tid_sql = mysqli_real_escape_string($mysqli, $tid);
                                                                                        $baseCustomerNumber_sql = mysqli_real_escape_string($mysqli, $customerNumber);
                                                                                        $crn_sql = mysqli_real_escape_string($mysqli, $crn);
                                                                                                                    
                                                                                        $check_digit_difference = findStringDifferencesCustomer($baseCustomerNumber_sql, $crn_sql);
                                                                                                            
                                                                                        mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_bpay_request (order_id, tid, base_customer_number, final_customer_number, check_digit, created_on, created_by, amount, expirydate)
                                                                                        values ('$order_id', '$tid_sql', '$baseCustomerNumber_sql', '$crn_sql', '$check_digit_difference', '$current_date_and_time', 'Generate Payment in G360', '$amount', '$exp_date' )") or die(mysqli_error($mysqli));
                                                                                                                    
                                                                                        //$path = generateInvoice( $order_id, $crn_sql, $amount, $exp_date );
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        echo 'BaseCRN not matching with API';
                                                                                    }
                                                                                }
                                                                            }
                                                                            //echo '<script>alert("CRN: '.$crn.'")</script>';
                                                                        }
                                                                        
                                                                        $enable_bank_account = false;
                                                                        if($departureDate <= $limitTimestamp_bpay)
                                                                        {
                                                                            $enable_bank_account = true;
                                                                        }
                                                                        // BPAY Request Ends
                                                                        
                                                                        // azupay bank option start
                                                                        $azupayBank = false;
                                                                        if(isset($virtualBsb) && $virtualBsb != '')
                                                                        {
                                                                            $azupayBank = true;
                                                                        }
                                                                        // azupay bank option ends
                                                                        
                                                                        $paymentRequestAmount = number_format((float)$paymentRequestAmount, 2, '.', '');
                                                				        $current_date_time = date("Y-m-d H:i:s");
                                        							    $orderid_added = $order_id_for_payment_request;
                                        							    
                                    							        mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_custom_payments (order_id, case_id, type_of_payment, amount, status, payment_client_id, auth_code, requested_on, requested_by, payment_request_id, azupay_expiry_date, azupay_link, azupay_payid, azupay_bsb, azupay_account_number, skypay_link, skypay_expiry_date, bpay_crn, bpay_expiry_date) 
                        							                    values ('$order_id_for_payment_request', '$customer_case_id_for_payment_request', '$type_of_payment_for_payment_request' ,'$paymentAmount' ,'waiting' ,'$clientTransactionId' ,'$full_payment_auth_code' ,'$current_date_time' ,'$username', '$paymentRequestId', '$paymentRequestExpiryDatetime_ymd', '$paymentRequestcheckoutUrl', '$paymentRequestpayID', '$virtualBsb', '$virtualAccountNumber', '$paylater_link', '$paymentRequestExpiryDatetime_ymd', '$crn', '$exp_date')") or die(mysqli_error($mysqli));
                        							                    
                        							                    //echo 'Visit: '.$paymentRequestcheckoutUrl .'</br></br>';
                        							                    
                        							                    //echo 'BPAY: '.$crn .'</br></br>';
                        							                    
                        							                    //echo 'SlicePay: '.$paylater_link .'</br></br>';
                        							                    
                        							                    //echo 'Bank: '.$virtualBsb . ' - Account:'. $virtualAccountNumber .'</br></br>';
                        							                    $payment_type_numbering = 1;
                        							                    $bankDetails = '';
                        							                    $azupayDetails = "
                                                                                ".$payment_type_numbering.". Pay by bank transfer by clicking on the below link for immediate booking confirmation.
                                                                                </br>
                                                                                &nbsp;&nbsp;&nbsp;<a target='_blank' href='{$paymentRequestcheckoutUrl}' style='background-color: #ffbb00; border: none; color: white; padding: 10px 16px; margin: 10px 0px; text-align: center; text-decoration: none; display: inline-block; font-size: 13px;'>Pay via PayID (Recommended)</a>
                                                                        
                                                                            ";
                                                                            
                                                                        if ($virtualBsb != '' && $virtualAccountNumber != '') {
                                                                            $payment_type_numbering++;
                                                                            $bankDetails = "
                                                                                ".$payment_type_numbering.". </br></br>Pay to Bank account.</br>
                                                                                &nbsp;&nbsp;&nbsp;&#9656; Amount: $$paymentRequestAmount (Pay the exact amount)</br>
                                                                                &nbsp;&nbsp;&nbsp;&#9656; Account Name: Gaura Travel</br> 
                                                                                &nbsp;&nbsp;&nbsp;&#9656; BSB: $virtualBsb </br>
                                                                                &nbsp;&nbsp;&nbsp;&#9656; Account Number: $virtualAccountNumber </br></br>
                                                                            ";
                                                                        }
                                                                        
                                                                        if($paylater_link != '')
                                                                        {
                                                                            $payment_type_numbering++;
                                                                            $paylater_link = ''.$payment_type_numbering.'. Pay 10% now and settle the remaining amount in weekly installments. Please click on the above link.</br>&nbsp;&nbsp;&nbsp;'.$paylater_link.'</br></br>';
                                                                        }
                                                                        else
                                                                        {
                                                                            $paylater_link = '';
                                                                        }
                                                                        
                                                                        if($crn != '')
                                                                        {
                                                                            $payment_type_numbering++;
                                                                            $bpay_msg = ''.$payment_type_numbering.'. Pay with your credit card via BPAY.</br>
                                                                                        &nbsp;&nbsp;&nbsp;&#9656; Log into your internet banking </br> 
                                                                                        &nbsp;&nbsp;&nbsp;&#9656; Go to BPAY </br>
                                                                                        &nbsp;&nbsp;&nbsp;&#9656; Enter the biller code (33829) and ref no ('.$crn.')</br>
                                                                                        &nbsp;&nbsp;&nbsp;&#9656; Enter the balance amount of $'.$paymentRequestAmount.'</br></br>';
                                                                        }
                                                                        else
                                                                        {
                                                                            $bpay_msg = '';
                                                                        }
                                                                        $paymentInfo = "
                                                                        Here are your payment options: 
                                                                        </br></br>
                                                                        {$azupayDetails}
                                                                        {$bankDetails}
                                                                        {$paylater_link}
                                                                        {$bpay_msg}
                                                                        ";
                                                                        
                                                                        // Define the unique ID for the Payments tab
                                                                        $paymentsTabId = "payments_{$order_id_api}{$co_order_id_api}{$product_id_api}";
        
                        							                    echo "
                                                                        <script>
                                                                            // Construct payment information
                                                                            const paymentInfo = `{$paymentInfo}`;
                                                                            const paymentsTabId = '{$paymentsTabId}';
                                                                            
                                                                            // Function to show the modal
                                                                            function showPaymentModal() {
                                                                                document.getElementById('paymentOptions').innerHTML = paymentInfo;
                                                                                document.getElementById('paymentModal').style.display = 'flex';
                                                                                
                                                                                openCity(event, paymentsTabId);
                                                                            }
                                                                    
                                                                            // Trigger the modal to open on form submission
                                                                            window.onload = function() {
                                                                                showPaymentModal();
                                                                            };
                                                                        </script>
                                                                        ";
        
                                        							    $type_of_history = $type_of_payment_for_payment_request . ' payment link';
                                                                        add_g360_event_history($order_id_for_payment_request, $co_order_id_api, $product_id_api, $type_of_history, "", $username, $current_date_time);
                                    							    }
                                                                }
                                                                else
                                                                {
                                                                    echo '<script>alert("Error during the payment generation. Contact HO.");</script>';
                                                                }
                                							    
                            							        $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                                                //echo '<script>window.location.href="'.$current_url.'";</script>';
                                    				        }
                                    				        else
                                    				        {
                                    				            echo '<script>alert("Payment amount is less than 0.");</script>';
                                    				        }
                                				        }
                                				        else
                                                        {
                                                            echo '<script>alert("Error on payment link. Contact HO.");</script>';
                                                        }
                                                    }
                                                    else
                                                    {
                                                        echo '<script>alert("Error during the request. Kindly try again later.");</script>';
                                                    }
                                                }
                                            }
                                            	?>
                                           
                                    		    <h6>Attachments</h6>
                                    		    <?php
                                    		    $query_all_refunds_latest_chat = "SELECT * FROM wpk4_backend_travel_booking_update_history where order_id = '$order_id_api' && co_order_id = '$co_order_id_api' && merging_id = '$product_id_api' && meta_key like 'G360Events' && meta_value like 'g360paymentattachments' order by auto_id desc";
                                        		$result_all_refunds_latest_chat = mysqli_query($mysqli, $query_all_refunds_latest_chat);
                                        		$row_all_refunds_latest_chat_count = mysqli_num_rows($result_all_refunds_latest_chat);
                                        		if($row_all_refunds_latest_chat_count > 0)
                                        		{
                                        		    ?>
                                        		    <table style="font-size:13px;">
                                    		        <tr><td width="70%">Attachment</td><td>Date uploaded</td></tr>
                                    		        <?php
                                            		while($row_all_refunds_latest_chat = mysqli_fetch_assoc($result_all_refunds_latest_chat))
                                            		{
                                            		    $payment_file_extension = pathinfo($row_all_refunds_latest_chat['meta_key_data'], PATHINFO_EXTENSION);
                                            		    if($payment_file_extension == 'pdf' || $payment_file_extension == 'txt')
                                            		    {
                                            		        echo '<tr><td><a target="_blank" href="https://gauratravel.com.au/wp-content/uploads/customized_function_uploads/'.$row_all_refunds_latest_chat['meta_key_data'].'">'.$row_all_refunds_latest_chat['meta_key_data'].'</a></td><td>'.$row_all_refunds_latest_chat['updated_time'].'</td></tr>';
                                            		    }
                                            		    else
                                            		    {
                                            		        echo '<tr><td><a target="_blank" href="https://gauratravel.com.au/wp-content/uploads/customized_function_uploads/'.$row_all_refunds_latest_chat['meta_key_data'].'"><img src="https://gauratravel.com.au/wp-content/uploads/customized_function_uploads/'.$row_all_refunds_latest_chat['meta_key_data'].'" style="width:200px;"></a></td><td>'.$row_all_refunds_latest_chat['updated_time'].'</td></tr>';
                                            		    }
                                            		}
                                            		?>
                                            		</table>
                                            		<?php
                                        		}
                                        		else
                                        		{
                                        		    echo 'No attachment found';
                                        		}
                                        		echo '</br></br>';
                                        		?>
                                        		
                        				</div>
                        				
                        				<div id="amount_adjustment_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>" class="tabcontent" style="display:none;">
											<table class='table' style="font-size:13px;">
                        				    <?php
                        				    $order_id = $order_id_api;
        									
                                            ?>
											<style>
											.hidethis {
												display: none;
											}
											</style>
                                            <form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                                <tr class="hide_previous_orderlist">
													<td colspan='2'>
													Previous Orders available to transfer (Booked after <?php echo date('d/m/Y', strtotime('-1 year')); ?>)
													<table class='table' style="font-size:13px;">
													<?php
													if($emailid != '')
													{
														$query_bookings = "SELECT booking.order_id, booking.total_amount, booking.order_date, booking.travel_date, booking.payment_status 
														FROM wpk4_backend_travel_bookings booking 
														JOIN wpk4_backend_travel_booking_pax pax ON  
														booking.order_id = pax.order_id AND 
														booking.co_order_id = pax.co_order_id AND 
														booking.product_id = pax.product_id  
														where booking.payment_status IN ('partially_paid', 'canceled') and booking.order_id != '$order_id' AND pax.email_pax='$emailid' and DATE(booking.order_date) >= CURDATE() - INTERVAL 1 YEAR  order by booking.order_date desc, booking.travel_date desc";
													}
													else if(isset($_SESSION['userPhoneCropped']) && $_SESSION['userPhoneCropped'] != '')
													{
														$user_phonenumber = $_SESSION['userPhoneCropped'];
														$query_bookings = "SELECT booking.order_id, booking.total_amount, booking.order_date, booking.travel_date, booking.payment_status 
														FROM wpk4_backend_travel_bookings booking 
														JOIN wpk4_backend_travel_booking_pax pax ON  
														booking.order_id = pax.order_id AND 
														booking.co_order_id = pax.co_order_id AND 
														booking.product_id = pax.product_id  
														where booking.payment_status IN ('partially_paid', 'canceled') and booking.order_id != '$order_id' AND pax.phone_pax_cropped='$user_phonenumber' and DATE(booking.order_date) >= CURDATE() - INTERVAL 1 YEAR  order by booking.order_date desc, booking.travel_date desc";
													}
													
													$result_bookings = mysqli_query($mysqli, $query_bookings);
													if(mysqli_num_rows($result_bookings) > 0)
													{
														echo '<tr><td width="15%">Order ID</td><td width="15%">Order Date</td><td width="15%">Travel Date</td>
														<td width="15%">Total amount for booking</td><td width="15%">Total paid</td><td width="15%">Available to transfer</td>
														<td>&nbsp;</td></tr>';
														$processedOrders = [];
														while($row_bookings = mysqli_fetch_assoc($result_bookings))
														{
															$total_amount_for_order = $row_bookings['total_amount'];
															$booking_order_id_for_transfer = $row_bookings['order_id'];
															
															if (in_array($booking_order_id_for_transfer, $processedOrders)) {
                                    							continue; // Skip to the next iteration if the order ID is already processed
                                    						}
                                    							
                                    						$processedOrders[] = $booking_order_id_for_transfer;
															
															$payment_received_for_previous_order = 0;
															$payment_available_for_previous_order = 0;
															
															$payment_ref_partial = $wpdb->get_results( "SELECT payments.trams_received_amount, payments.process_date, payments.order_id FROM wpk4_backend_travel_payment_history payments 
															 where payments.order_id = '$booking_order_id_for_transfer'"); 
															foreach($payment_ref_partial as $row_2) 
															{ 
																$payment_received_for_previous_order += (float)$row_2->trams_received_amount;
															}
															
															$payment_available_for_previous_order = (float)$payment_received_for_previous_order;
															
															if($row_bookings['payment_status'] == 'paid')
															{
																$payment_available_for_previous_order = (float)$total_amount_for_order - (float)$payment_received_for_previous_order;
																$payment_available_for_previous_order = abs($payment_available_for_previous_order);

																//$payment_available_for_previous_order = abs((float)$total_amount_for_order - (float)$payment_received_for_previous_order);

															}
															
															$total_amount_for_order = number_format((float)$total_amount_for_order, 2, '.', '');
															$payment_received_for_previous_order = number_format((float)$payment_received_for_previous_order, 2, '.', '');
															$payment_available_for_previous_order = number_format((float)$payment_available_for_previous_order, 2, '.', '');
															if($payment_available_for_previous_order != 0 && $payment_received_for_previous_order != 0)
															{
																echo '<tr>';
																echo '<td>'. $row_bookings['order_id'] . '</td>';
																echo '<td>'. date("d/m/Y", strtotime($row_bookings['order_date'])) . '</td>';
																echo '<td>'. date("d/m/Y", strtotime($row_bookings['travel_date'])) . '</td>';
																echo '<td>'. $total_amount_for_order . '</td>';
																echo '<td>'. $payment_received_for_previous_order . '</td>';
																echo '<td>'. $payment_available_for_previous_order . '</td>';
																echo '<td><a style="background: #ffbb00; border: none; border-radius: 5px; color: #fff; cursor: pointer; display: inline-block; font-size: 13px; font-weight: 500; margin: 0; opacity: 1; padding: 6px 14px; text-align: center; text-decoration: none; transition: opacity .15s linear;" 
																id="transfer_this" data-order-id="'. $booking_order_id_for_transfer . '" data-total-amount="'. $total_amount_for_order . '" data-paid-amount="'. $payment_received_for_previous_order . '" data-balance-amount="'. $payment_available_for_previous_order . '">Use this</a></td>';
																echo '</tr>';
															}
														}
													}
													?>
													</table>
													</td>
												</tr>
												<tr class="hidethis">
                                                    <td colspan='2'><center><a id="reset_button" style="background: #ffbb00; border: none; border-radius: 5px; color: #fff; cursor: pointer; display: none; font-size: 13px; font-weight: 500; padding: 6px 14px; text-align: center;">View previous order list</a></center></td>
                                                    
                                                </tr>
												    


												<tr class="hidethis">
                                                    <td>Current Order ID *</td>
                                                    <td>
                                                        <input type="text" name='new_order_id' id="new_order_id" onkeypress="return isNumberKey(event)" value="<?php echo $order_id; ?>" required readonly></td>
                                                    </td>
                                                </tr>
                                                </br>
												<tr class="hidethis">
                                                    <td>Previous Order ID *</td>
                                                    <td>
        											<input type="text" name="old_order_id" onkeypress="return isNumberKey(event)" required></td>
                                                </tr>
                                                </br>
                                                <tr class="hidethis">
                                                    <td>Transfer Amount *</td>
                                                    <td><input type="hidden" name="changing_amount" id="changing_amount" readonly required>
                                                    <input type="text" name="changing_amount2" id="changing_amount2" readonly required></td>
                                                </tr>
                                                </br>
                                                <tr class="hidethis">
                                                    <td>Remark</td>
                                                    <td><textarea name="reason_for_transfer"></textarea></td>
                                                </tr>
												<tr class="hidethis">
												<td colspan="2">
                                                </br>
                                                <center><input type='submit' name='update_user_payment_transfer_g' class='btn btn-success' style='padding:15px; margin:0;font-size:11px;' value='Save'></center>
												</td>
												</tr>
                                            </form>
											
									<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get all "Use this" buttons
    const transferButtons = document.querySelectorAll('#transfer_this');

    // Attach event listener for each button
    transferButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Hide the previous orders table (with class 'hide_previous_orderlist')
            const previousOrderList = document.querySelector('.hide_previous_orderlist');
            if (previousOrderList) {
                previousOrderList.style.display = 'none'; // Hide the element
            }

            // Show the reset button
            const resetButton = document.getElementById('reset_button');
            if (resetButton) {
                resetButton.style.display = 'inline-block'; // Show the reset button
            }

            // Show all 'hidethis' rows
            const elementsToToggle = document.querySelectorAll('.hidethis');
            elementsToToggle.forEach(function(element) {
                element.classList.remove('hidethis'); // Remove the 'hidethis' class to show
            });

            // Get the data attributes from the clicked button
            const oldOrderId = this.getAttribute('data-order-id');
            const changingAmount = this.getAttribute('data-balance-amount');
            const changingAmount2 = this.getAttribute('data-balance-amount'); 
            const totalAmount = this.getAttribute('data-total-amount');
            const paidAmount = this.getAttribute('data-paid-amount');
            const availableAmount = this.getAttribute('data-balance-amount');

            // Populate the input fields with the retrieved values
            document.querySelector('input[name="old_order_id"]').value = oldOrderId;
            document.querySelector('#changing_amount').value = changingAmount;
            document.querySelector('#changing_amount2').value = changingAmount2;
        });
    });

    // Reset button functionality to show 'hide_previous_orderlist' and hide 'hidethis' rows
    const resetButton = document.getElementById('reset_button');
    if (resetButton) {
        resetButton.addEventListener('click', function() {
            // Show the 'hide_previous_orderlist' table again
            const previousOrderList = document.querySelector('.hide_previous_orderlist');
            if (previousOrderList) {
                previousOrderList.style.display = ''; // Show the element
            }

            // Hide all elements with the 'hidethis' class
            const elementsToHide = document.querySelectorAll('.hidethis');
            elementsToHide.forEach(function(element) {
                element.classList.add('hidethis'); // Add the 'hidethis' class back to hide
				elementsToHide.style.display = 'none';
            });

            // Hide the reset button
            resetButton.style.display = 'none';
        });
    }
});
</script>



                                            <?php
                                            if (isset($_POST['update_user_payment_transfer_g']))
                                            {
                                                if(isset($_POST['old_order_id']) && $_POST['old_order_id'] != '')
                                                {
                                                    $current_date_and_time = date("Y-m-d H:i:s");
                                                    $previous_order_id_for_adjustment_full = $_POST['old_order_id'];
                                                    $new_order_id = $_POST['new_order_id'];
													
                                                    if ( ctype_digit($new_order_id) && strlen($new_order_id) <= 7 ) {
                                            			$source = 'WPT';
                                                	} elseif (ctype_alpha($new_order_id)) {
                                                		$source = 'gds';
                                                	} else {
                                                		$source = 'gds';
                                                	}
                                                	
                                                	if ( ctype_digit($previous_order_id_for_adjustment_full) && strlen($previous_order_id_for_adjustment_full) <= 7 ) {
                                            			$source_previous = 'WPT';
                                                	} elseif (ctype_alpha($previous_order_id_for_adjustment_full)) {
                                                		$source_previous = 'gds';
                                                	} else {
                                                		$source_previous = 'gds';
                                                	}
                                                	
                                                    $previous_amount_for_adjustment_full = $_POST['changing_amount'];
                                                    $reason_for_transfer = $_POST['reason_for_transfer'];
            
                                                    $payment_received_for_previous_order = 0;
                                                    $payment_ref_partial = $wpdb->get_results( "SELECT * FROM wpk4_backend_travel_payment_history where order_id = '$previous_order_id_for_adjustment_full'"); 
                                    				foreach($payment_ref_partial as $row_2) { 
                                    				    $payment_received_for_previous_order += $row_2->trams_received_amount;
                                    				    $payment_process_date_of_previous_order = $row_2->process_date;
                                    				}
                                    				$payment_received_for_previous_order = number_format((float)$payment_received_for_previous_order, 2, '.', '');
                                    				$previous_amount_for_adjustment_full = number_format((float)$previous_amount_for_adjustment_full, 2, '.', '');
                                    				
                                    				$payment_partial_value_for_booking = '';
                                    				
                                                    if($reason_for_transfer == '' )
                                                    {
                                                        $reason_for_transfer = 'Adjustment';
                                                    }
                                                    
                                                    $previous_order_date = date("Y-m-d H:i:s");
                                                    $query_select_booking_order_date = "SELECT order_date FROM wpk4_backend_travel_bookings where order_id='$previous_order_id_for_adjustment_full'";
                                                    $result_select_booking_order_date = mysqli_query($mysqli, $query_select_booking_order_date);
                                                    if(mysqli_num_rows($result_select_booking_order_date) > 0)
                                                    {
                                                    	$row_select_booking_order_date = mysqli_fetch_assoc($result_select_booking_order_date);
                                                    	$previous_order_date = $row_select_booking_order_date['order_date'];
                                                    }
                                                    
                                                    $payment_refund_deadline = date('Y-m-d H:i:s', strtotime($previous_order_date . ' +96 hours'));
                                                    
                                                    $invoice_id = '';
                                                    $query_select_order_invoice_id = "SELECT * FROM wpk4_backend_travel_payment_invoice where order_id='$new_order_id' order by invoice_id desc limit 1";
                                                    $result_select_order_invoice_id = mysqli_query($mysqli, $query_select_order_invoice_id) or die(mysqli_error($mysqli));
                                                    if(mysqli_num_rows($result_select_order_invoice_id) > 0)
                                                    {
                                                    	$row_select_order_invoice_id = mysqli_fetch_assoc($result_select_order_invoice_id);
                                                    	$invoice_id = $row_select_order_invoice_id['invoice_id'];
                                                    						
                                                    	
                                                    }
                                                    
                                                    $invoice_id_old = '';
                                                    $query_select_order_invoice_id = "SELECT * FROM wpk4_backend_travel_payment_invoice where order_id='$previous_order_id_for_adjustment_full' order by invoice_id desc limit 1";
                                                    $result_select_order_invoice_id = mysqli_query($mysqli, $query_select_order_invoice_id) or die(mysqli_error($mysqli));
                                                    if(mysqli_num_rows($result_select_order_invoice_id) > 0)
                                                    {
                                                    	$row_select_order_invoice_id = mysqli_fetch_assoc($result_select_order_invoice_id);
                                                    	$invoice_id_old = $row_select_order_invoice_id['invoice_id'];
                                                    						
                                                    	
                                                    }

                                    				if($payment_received_for_previous_order >= $previous_amount_for_adjustment_full && ($payment_received_for_previous_order != '0.00' && $previous_amount_for_adjustment_full != '0.00') 
                                    				&& $reason_for_transfer != '')
                                                    {
                                                            $deposit_adjustment_note = $reason_for_transfer. ' - ' . $previous_amount_for_adjustment_full . ' transfered from ' . $previous_order_id_for_adjustment_full . ' to ' . $new_order_id;
                                                            
                                                            $wpdb->insert('wpk4_backend_history_of_updates', array(
                                                                    'type_id' =>$previous_order_id_for_adjustment_full,
                                                                    'meta_key' =>'deposit_adjustment_in_g360',
                                                                    'meta_value' => $deposit_adjustment_note,
                                                                    'updated_by' =>'customer',
                                                                    'updated_on' => $current_date_and_time,
                                                            ));
                                                                
                                                            $wpdb->insert('wpk4_backend_history_of_updates', array(
                                                                    'type_id' =>$new_order_id,
                                                                    'meta_key' =>'deposit_adjustment_in_g360',
                                                                    'meta_value' => $deposit_adjustment_note,
                                                                    'updated_by' =>'customer',
                                                                    'updated_on' => $current_date_and_time,
                                                            ));
                                                                
                                                            $previous_payment_history_reference_note = $payment_received_for_previous_order . ' has been transfered to '. $new_order_id;
                                                                
                                                            $wpdb->insert('wpk4_backend_travel_payment_history', array(
                                                                    'order_id' =>$previous_order_id_for_adjustment_full,
                                                                    'source' => $source_previous,
                                                                    'profile_no'=>'',
                                                                    'total_amount' =>'',
                                                                    'trams_received_amount' => '-'.$previous_amount_for_adjustment_full,
                                                                    'reference_no' =>'amount transfered to '.$new_order_id . ' - ' . $reason_for_transfer,
                                                                    'balance_amount' =>'',
                                                                    'payment_method' =>'14',
                                                                    'pay_type' =>'deposit_adjustment',
                                                        			'process_date' => $current_date_and_time,
                                                        			'payment_change_deadline' => $payment_refund_deadline,
                                                        			'gaura_invoice_id' => $invoice_id_old,
                                                        			'added_on' => $current_date_and_time,
                                                        			'added_by' => 'customer',
                                                            ));
                                                            
                                                           
            
                                                            $wpdb->insert('wpk4_backend_travel_payment_history', array(
                                                                    'order_id' =>$new_order_id,
                                                                    'source' => $source,
                                                                    'profile_no'=>'',
                                                                    'total_amount' =>'',
                                                                    'trams_received_amount' =>$previous_amount_for_adjustment_full,
                                                                    'reference_no' =>'deposit transfered from '.$previous_order_id_for_adjustment_full . ' - ' . $reason_for_transfer,
                                                                    'balance_amount' =>'',
                                                                    'payment_method' =>'14',
                                                                    'pay_type' =>'deposit_adjustment',
                                                        			'process_date' => $current_date_and_time,
                                                        			'payment_change_deadline' => $payment_refund_deadline,
                                                        			'gaura_invoice_id' => $invoice_id,
                                                        			'added_on' => $current_date_and_time,
                                                        			'added_by' => 'customer',
                                                            ));
                                                            
                                                            
                                                            
                                                            $total_amount_from_booking_table_old_booking = 0.00;
                                                            $query_select_old_booking_order_original_status = "SELECT total_amount FROM wpk4_backend_travel_bookings where order_id='$previous_order_id_for_adjustment_full'";
                                                            $result_select_old_booking_original_status = mysqli_query($mysqli, $query_select_old_booking_order_original_status);
                                                            $row_select_old_booking_original_status = mysqli_fetch_assoc($result_select_old_booking_original_status);
                                                            if(mysqli_num_rows($result_select_old_booking_original_status) > 0)
                                                            {
                                                                $total_amount_from_booking_table_old_booking = number_format((float)$row_select_old_booking_original_status['total_amount'], 2, '.', '');
                                                            }
                                                            
                                                            if( $payment_received_for_previous_order == $previous_amount_for_adjustment_full )
                                                            {
                                                                if ( ctype_digit($previous_order_id_for_adjustment_full) && strlen($previous_order_id_for_adjustment_full) == 6 )
                                                                {
                                                                    $is_first_loop_for_availability_update = 0;
                                                                    
                                                                    $query_select_order = "SELECT * FROM wpk4_backend_travel_bookings where order_id = '$previous_order_id_for_adjustment_full'";
                                                                    $result_select_order = mysqli_query($mysqli, $query_select_order);
                                                                    while($row_select_order = mysqli_fetch_assoc($result_select_order))
                                                                    {
                                                                        $payment_status_stock = $row_select_order['payment_status'];
                                                                        if($payment_status_stock == 'partially_paid')
                                                                        {
                                                                            $trip_code = $row_select_order['trip_code'];
                                                                            $travel_date = $row_select_order['travel_date'];
                                                                            $total_pax = $row_select_order['total_pax'];
                                                    			            update_stock_in_pricing_table($trip_code, $travel_date, $total_pax, 'positive');
                                                    			            
                                                    			            if($is_first_loop_for_availability_update == 0)
                                                    			            {
                                                        			            $by_user = 'amount_transfer_in_customer_portal';
                                                                        
                                                                                availability_table_pax_update($previous_order_id_for_adjustment_full, $by_user);
                                                                                $is_first_loop_for_availability_update = 1;
                                                    			            }
                                                                        }
                                                                    }
                                                                    
                                                                }
                                                            
                                                                $sql_update_past_booking ="UPDATE wpk4_backend_travel_bookings
                                                                    SET payment_status = 'voucher_submited', payment_modified = '$current_date_and_time', payment_modified_by = 'customer_portal_adjustment'
                                                                WHERE order_id = '$previous_order_id_for_adjustment_full' and payment_status != 'paid'";
                                                                $results_update_past_booking = $wpdb->query($sql_update_past_booking);
                                                                
                                                                if ($results_update_past_booking > 0) 
                                                                {
                                                                    mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
    					                                            values ('$previous_order_id_for_adjustment_full','','','payment_status','Rebooked','$current_date_and_time','customer')") or die(mysqli_error($mysqli));
                                                                } 
                                                            }
                                                            
                                                            $total_amount_from_booking_table = 0.00;
                                                            $query_select_booking_order_original_status = "SELECT total_amount FROM wpk4_backend_travel_bookings where order_id='$new_order_id'";
                                                            $result_select_booking_original_status = mysqli_query($mysqli, $query_select_booking_order_original_status);
                                                            $row_select_booking_original_status = mysqli_fetch_assoc($result_select_booking_original_status);
                                                            if(mysqli_num_rows($result_select_booking_original_status) > 0)
                                                            {
                                                                $total_amount_from_booking_table = number_format((float)$row_select_booking_original_status['total_amount'], 2, '.', '');
                                                            }
															
                                                            $processedPayments = array();
                                                            $total_paid_for_booking_transfer = 0.00;
                                                            $total_differ_from_total_and_paid = 1.10;
                                                            $query_total_paid_for_requestid = "SELECT * FROM wpk4_backend_travel_payment_history where order_id = '$new_order_id' AND (pay_type = 'deposit' OR pay_type = 'balance' 
                                                                        		OR pay_type = 'Balance' OR pay_type = 'deposit_adjustment' OR pay_type = 'additional_payment')";
                                                            $result_total_paid_for_requestid = mysqli_query($mysqli, $query_total_paid_for_requestid);
                                                            while($row_total_paid_for_requestid = mysqli_fetch_assoc($result_total_paid_for_requestid))
                                                            {
																$payment_identifier = $row_total_paid_for_requestid['trams_received_amount'].'^'.$row_total_paid_for_requestid['reference_no']; 
																if (in_array($payment_identifier, $processedPayments)) 
																{
																	continue; // Skip to the next value
																}
																
																$processedPayments[] = $payment_identifier;						

                                                                $total_paid_for_booking_transfer += (float)$row_total_paid_for_requestid['trams_received_amount'];
                                                            }
                                                            $total_paid_for_booking_transfer = number_format((float)$total_paid_for_booking_transfer, 2, '.', '');
                                                            
                                                            $total_differ_from_total_and_paid = $total_amount_from_booking_table - $total_paid_for_booking_transfer;
                                                            $total_differ_from_total_and_paid = number_format((float)$total_differ_from_total_and_paid, 2, '.', '');
                        			
                                                            if($total_amount_from_booking_table != 0.00 && $total_paid_for_booking_transfer != 0.00 && ( $total_differ_from_total_and_paid != 1.10 && $total_differ_from_total_and_paid <= 1.00 && $total_differ_from_total_and_paid >= -1.00 ))
                                                            {
                                                                $sql_update_booking_main = "UPDATE wpk4_backend_travel_bookings SET payment_status='paid', balance='$total_differ_from_total_and_paid', payment_modified='$current_date_and_time', payment_modified_by='customer' 
                                                			                WHERE order_id='$new_order_id' AND payment_status='partially_paid'";
                                                        		$result_booking_main= mysqli_query($mysqli,$sql_update_booking_main) or die(mysqli_error($mysqli));
                                                        		
                                                        		mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
    					                                        values ('$new_order_id','','','payment_status','paid','$current_date_and_time','customer')") or die(mysqli_error($mysqli));
																
																
																if($source == 'WPT') // from other status to paid
																{
																		
																	gdeal_name_update_ajax($new_order_id);	
																		
																	mysqli_query($mysqli,"insert into wpk4_amadeus_name_update_payment_status_log (order_id, order_type, updated_by, updated_on, is_processed_amadeus, amadeus_processed_on, page_title ) 
																	values ('$new_order_id', '$source', 'Customer', '$current_date_and_time', 'yes', '$current_date_and_time', 'Customer Portal Amount Adjustment')") or die(mysqli_error($mysqli));
																}
                                                            }
                                                       
                                                        $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";    
                                                        echo '<script>
                                                                    alert("Amount transfer has been completed."); 
                                                                    window.location.href="' . $current_url . '";
                                                            </script>';
                                                    }
                                                    else
                                                    {
                                                        echo '<script>alert("Error during the process. Kindly try again. Below can be the issue,\n\n Transfer amount is higher than the paid amount\n Remark not provided");</script>';
                                                    }
                                                }
                                                else
                                                {
                                                    echo '<script>alert("Error during the process. Kindly try again with correct order id.");</script>';
                                                }
                                            }
                        				    ?>
											</table>
                        				</div>
        
                        				<div id="portal_request_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>" class="tabcontent" style="display:none;">
                                                <?php
                                                $order_id = $order_id_api;
                                                
                                                $array_pax_pnr = array();
                                                $query_summary_loop_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id'";
                                        		$result_loop_pax = mysqli_query($mysqli, $query_summary_loop_pax) or die(mysqli_error($mysqli));
                                            	while($row_loop_pax = mysqli_fetch_assoc($result_loop_pax))
                                            	{
                                            	    $array_pax_pnr[] = $row_loop_pax['pnr'];
                                            	}
                                            	$array_pax_pnr = array_unique($array_pax_pnr);		        
                                            	$array_pax_pnr_separated = implode(", ", $array_pax_pnr);
        
                                                $query_task_history = "SELECT * FROM wpk4_backend_user_portal_requests where reservation_ref != '' AND (reservation_ref='$order_id_api' OR reservation_ref IN ('$array_pax_pnr_separated'))";
                                            	$result_task_history = mysqli_query($mysqli, $query_task_history) or die(mysqli_error($mysqli));
                                				$count_task_history_userportal = mysqli_num_rows($result_task_history);
                                				
                                				if($count_task_history_userportal > 0)
                                				{
                                					?>
                                					<h5>Portal Requests <span class="badge badge-primary"><?php echo $count_task_history_userportal; ?></span></h5>
                                					<table class='table' style="font-size:13px;">
                                						<tr><th>CaseID</th><th>Task Type</th><th>Initiated on</th><th>Status</th><th></th></tr>
                                						<?php
                                						while($row_task_history_user = mysqli_fetch_assoc($result_task_history))
                                						{
                                							//$task_order_id = $row_task_history_user['order_id'];
                                							$task_case_type = $row_task_history_user['case_type'];
                                							$case_date = $row_task_history_user['case_date'];
                                								$case_id = $row_task_history_user['case_id'];
                                							$gstatus = $row_task_history_user['status'];
                                							$enc_auto_id = md5($case_id);
                                							$request_type_first_letter = substr($task_case_type,0,1);
        
                                    						    ?>
                                    						    <tr><td><?php echo $case_id; ?></td><td><?php echo $task_case_type; ?></td><td><?php echo $case_date; ?></td><td><?php echo $gstatus; ?></td>
                                    						    <td><a href="?p=my-request-view&id=<?php echo $case_id; ?>&co=<?php echo $enc_auto_id; ?>&t=<?php echo $request_type_first_letter; ?>&casetype=<?php echo $task_case_type; ?>" class="btn btn-success">View</a></td></tr>
                                    						    <?php
                                    						  
                                						}
                                						?>
                                					</table>
                                					<?php
                                				}
                                				else
                                				{
                                				    
                                					echo '<h5>Customer Portal Requests</h5>
                                					    No task created';
                                				}
                                            ?>
                        				</div>
                        				
                                        <div id="emails_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>" class="tabcontent" style="display:none;">
                        				    <?php
                        				    $filePath = '';
                        				    $order_id = $order_id_api;
                                        		$query_select_order_email = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' order by auto_id limit 1";
                                        		$result_select_order_email = mysqli_query($mysqli, $query_select_order_email);
                                        		$row_select_order_email = mysqli_fetch_assoc($result_select_order_email);
                                        		$customer_email = $row_select_order_email['email_pax'];
                                        		
                                        		$query_select_order_status = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api'";
                                        		$result_select_order_status = mysqli_query($mysqli, $query_select_order_status);
                                        		$row_select_order_status = mysqli_fetch_assoc($result_select_order_status);
                                        		$order_payment_status = $row_select_order_status['payment_status'];
                                        		
                                        		$query_count_bookingemail = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='Booking Email' order by auto_id desc limit 1";
                                        		$result_count_bookingemail = mysqli_query($mysqli, $query_count_bookingemail);
                                        		$row_count_bookingemail = mysqli_num_rows($result_count_bookingemail);
                                        		$row_bookingemail = mysqli_fetch_assoc($result_count_bookingemail);
                                        		if($row_count_bookingemail==0)
                                        		{
                                        			$is_bookingemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_bookingemail_sent[]" value="'.$order_id_api.'">';
                                        			$bookingemail_sent_on = '';
                                        		}
                                        		else
                                        		{
                                        			$is_bookingemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_bookingemail_sent[]" value="'.$order_id_api.'">';
                                        			$bookingemail_sent_on = ' on '.$row_bookingemail['initiated_date'];
                                        		}
                                        		
                                        		
                                        		
                                        		
                                        		$query_count_mhpplemail = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='MH PPL Voucher' order by auto_id desc limit 1";
                                        		$result_count_mhpplemail = mysqli_query($mysqli, $query_count_mhpplemail);
                                        		$row_count_mhpplemail = mysqli_num_rows($result_count_mhpplemail);
                                        		$row_mhpplemail = mysqli_fetch_assoc($result_count_mhpplemail);
                                        		if($row_count_mhpplemail==0)
                                        		{
                                        			$is_mhpplemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_itineraryemail_sent[]" value="'.$order_id_api.'">';
                                        			$mhppl_sent_on = '';
                                        		}
                                        		else
                                        		{
                                        			$is_mhpplemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_itineraryemail_sent[]" value="'.$order_id.'">';
                                        			$mhppl_sent_on = ' on '.$row_mhpplemail['initiated_date'];
                                        		}
                                        		
                                        		
                                        		
                                        		$query_count_itineraryemail = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='Itinerary Email' order by auto_id desc limit 1";
                                        		$result_count_itineraryemail = mysqli_query($mysqli, $query_count_itineraryemail);
                                        		$row_count_itineraryemail = mysqli_num_rows($result_count_itineraryemail);
                                        		$row_itineraryemail = mysqli_fetch_assoc($result_count_itineraryemail);
                                        		if($row_count_itineraryemail==0)
                                        		{
                                        			$is_itineraryemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_itineraryemail_sent[]" value="'.$order_id_api.'">';
                                        			$itineraryemail_sent_on = '';
                                        		}
                                        		else
                                        		{
                                        			$is_itineraryemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_itineraryemail_sent[]" value="'.$order_id.'">';
                                        			$itineraryemail_sent_on = ' on '.$row_itineraryemail['initiated_date'];
                                        		}	
                                        		
                                        		$query_count_taxinvoice = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='Tax Invoice' order by auto_id desc limit 1";
                                        		$result_count_taxinvoice = mysqli_query($mysqli, $query_count_taxinvoice);
                                        		$row_count_taxinvoice = mysqli_num_rows($result_count_taxinvoice);
                                        		$row_taxinvoice = mysqli_fetch_assoc($result_count_taxinvoice);
                                        		if($row_count_taxinvoice==0)
                                        		{
                                        			$is_tax_invoice_sent = '<input type="checkbox" onclick="return false;" id="inv" name="is_tax_invoice_sent[]" value="'.$order_id_api.'">'; $tax_invoice_sent_on = '';
                                        		}
                                        		else
                                        		{
                                        			$is_tax_invoice_sent = '<input type="checkbox" checked onclick="return false;" id="inv" name="is_tax_invoice_sent[]" value="'.$order_id_api.'">'; 
                                        			$tax_invoice_sent_on = ' on '.$row_taxinvoice['initiated_date'];
                                        		}
                                        		
                                        		$query_count_payment_update = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='Payment Update' order by auto_id desc limit 1";
                                        		$result_count_payment_update = mysqli_query($mysqli, $query_count_payment_update);
                                        		$row_count_payment_update = mysqli_num_rows($result_count_payment_update);
                                        		$row_paymentupdate = mysqli_fetch_assoc($result_count_payment_update);
                                        		if($row_count_payment_update==0)
                                        		{
                                        			$is_payment_update_sent = '<input type="checkbox" onclick="return false;" id="pay" name="is_payment_update_sent[]" value="'.$order_id_api.'">'; $payment_update_sent_on = '';
                                        		}
                                        		else
                                        		{
                                        			$is_payment_update_sent = '<input type="checkbox" checked onclick="return false;" id="pay" name="is_payment_update_sent[]" value="'.$order_id_api.'">'; 
                                        			$payment_update_sent_on = ' on '.$row_paymentupdate['initiated_date'];
                                        		}
                                        		
                                        		$query_count_eticket_update = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='Eticket Email' order by auto_id desc limit 1";
                                        		$result_count_eticket_update = mysqli_query($mysqli, $query_count_eticket_update);
                                        		$row_count_eticket_update = mysqli_num_rows($result_count_eticket_update);
                                        		$row_eticketupdate = mysqli_fetch_assoc($result_count_eticket_update);
                                        		if($row_count_eticket_update==0)
                                        		{
                                        			$is_eticket_update_sent = '<input type="checkbox" onclick="return false;" id="pay" name="is_payment_update_sent[]" value="'.$order_id_api.'">'; $eticket_update_sent_on = '';
                                        		}
                                        		else
                                        		{
                                        			$is_eticket_update_sent = '<input type="checkbox" checked onclick="return false;" id="pay" name="is_payment_update_sent[]" value="'.$order_id_api.'">'; 
                                        			$eticket_update_sent_on = ' on '.$row_eticketupdate['initiated_date'];
                                        		}
                                        		?>
                                        			<table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
                                        				<tr>
                                        					<td>Itinerary Email</td>
                                        					<td>
                                        					    <!--<form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                            						<input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='sent_itinerary_email' value='Sent Itinerary Email'>
                                            					</form>-->
                                            					<form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                            						<input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='download_itinerary_email' value='Download Itinerary'>
                                            					</form>
                                        					</td>
                                        					<td>
                                        						<button id="toggleButton_email_itinerary_<?php echo $order_id_api; ?>" style='background-color:#ffbb00; padding:15px; margin:0;font-size:11px; '>Show Preview</button>
                                        					</td>
                                        				</tr>
                                        				
                                            			<?php
                                            			
                                            			$query_pax_eticket_loop = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' && product_id='$product_id_api'";
                                                		$result_pax_eticket_loop = mysqli_query($mysqli, $query_pax_eticket_loop);
                                                		$row_pax_eticket_loop_count = mysqli_num_rows($result_pax_eticket_loop);
                                            			?>
                                            			<tr>
                                            				<td rowspan = '<?php echo $row_pax_eticket_loop_count; ?>'>Eticket Email</td>
                                            				<?php
                                            				$loop_count_pax = 0;
                                            				while($row_pax_eticket_loop = mysqli_fetch_assoc($result_pax_eticket_loop))
                                                		    {
                                                		        $loop_count_pax ++;
                                                		        $pax_id = $row_pax_eticket_loop['auto_id'];
                                                		        ?>
                                                				<td>
                                                					<?php
                                                    				if($loop_count_pax == 1)
                                                    				{
                                                    				?>
                                                        				<form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                                    						<input type='submit' style='padding:15px; margin:0;font-size:11px;' name='sent_bulk_eticket_email' value='Download Eticket'>
                                                    			        </form>
                                                    				<?php
                                                    				}
                                                    				?>
                                                				</td>
                                                				
                                                				<td><button id="toggleButton_email_eticket_<?php echo $order_id_api; ?><?php echo $pax_id; ?>" style='background-color:#ffbb00; padding:15px; margin:0;font-size:11px; '>Show Preview</button></td>
                                            				    <?php
                                            				    echo '</tr>';
                    		                                    }
                    		                                ?>
                                            			</tr>
                                            			
                                            			
        				                                
                                        			</table>
                                                    <?php
                                        			$today_date = date("Y-m-d H:i:s");
                                        			?>
                                        			
        
                                            		<div id="email_itineraryPreview_<?php echo $order_id_api; ?>" style="display: none;">
                                                        <?php
                                            			$emailsubject = "Itinerary Information - ".$order_id_api;
                                                        if($order_type_itinerary == 'WPT' || $order_type_itinerary == '')
                				                        {
                                            			    include(get_template_directory().'/templates/email/tpl_email_itinerary_preview.php');
                				                        }
                				                        else if($order_type_itinerary == 'gds')
                				                        {
                                            			    include(get_template_directory().'/templates/email/tpl_email_itinerary_preview_gds.php');
                				                        }
                				                        else
                				                        {
                				                            echo 'No system email found';
                				                        }    
                                            			
                                                        ?>
                                                    </div>
                                                    
                                                    
                                                    
                                                    <?php
                                            		$query_pax_eticket_loop = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api'";
                                                	$result_pax_eticket_loop = mysqli_query($mysqli, $query_pax_eticket_loop);
                                                	$row_pax_eticket_loop_count = mysqli_num_rows($result_pax_eticket_loop);
                                            		while($row_pax_eticket_loop = mysqli_fetch_assoc($result_pax_eticket_loop))
                    		                        {
                    		                            $pax_id = $row_pax_eticket_loop['auto_id'];
                    		                            ?>
                    		                            <div id="email_eticketPreview_<?php echo $order_id_api; ?><?php echo $pax_id; ?>" style="display: none;">
                                                            <?php
                                                    		$emailsubject = "Eticket Information - ".$order_id_api;
                                                            include(get_template_directory().'/templates/email/tpl_email_eticket_preview.php');
                                                            ?>
                                                        </div>
                    		                            <?php
                    		                        }
                    		                        ?>
                                                    <?php
                                            		$query_pax_eticket_loop = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api'";
                                                	$result_pax_eticket_loop = mysqli_query($mysqli, $query_pax_eticket_loop);
                                                	$row_pax_eticket_loop_count = mysqli_num_rows($result_pax_eticket_loop);
                                            		while($row_pax_eticket_loop = mysqli_fetch_assoc($result_pax_eticket_loop))
                    		                        {
                    		                            $pax_id = $row_pax_eticket_loop['auto_id'];
                    		                            ?>
                    		                            <script>
                    		                                document.getElementById("toggleButton_email_eticket_<?php echo $order_id_api; ?><?php echo $pax_id; ?>").addEventListener("click", function() {
                                                              var myDiv_payment = document.getElementById("email_eticketPreview_<?php echo $order_id_api; ?><?php echo $pax_id; ?>");
                                                              if (myDiv_payment.style.display === "none") {
                                                                myDiv_payment.style.display = "block";
                                                                this.textContent = "Hide Preview";
                                                              } else {
                                                                myDiv_payment.style.display = "none";
                                                                this.textContent = "Show Preview";
                                                              }
                                                            });
                    		                            </script>
                    		                            <?php
                    		                        }
                    		                        ?>    
                    		                            
                                                    
                                                    
                                            		<script>
                                            		    document.getElementById("toggleButton_email_itinerary_<?php echo $order_id_api; ?>").addEventListener("click", function() {
                                                          var myDiv_itinerary = document.getElementById("email_itineraryPreview_<?php echo $order_id_api; ?>");
                                                          if (myDiv_itinerary.style.display === "none") {
                                                            myDiv_itinerary.style.display = "block";
                                                            this.textContent = "Hide Preview";
                                                          } else {
                                                            myDiv_itinerary.style.display = "none";
                                                            this.textContent = "Show Preview";
                                                          }
                                                        });
                                                        
                                                        document.getElementById("toggleButton_email_payment_<?php echo $order_id_api; ?>").addEventListener("click", function() {
                                                          var myDiv_payment = document.getElementById("email_paymentPreview_<?php echo $order_id_api; ?>");
                                                          if (myDiv_payment.style.display === "none") {
                                                            myDiv_payment.style.display = "block";
                                                            this.textContent = "Hide Preview";
                                                          } else {
                                                            myDiv_payment.style.display = "none";
                                                            this.textContent = "Show Preview";
                                                          }
                                                        });
                                                        
                                                        
                                                        
                                                        
        
                                                      function confirmSubmit() {
                                                        var confirmed = confirm("Do you want to submit the form?");
                                                        return confirmed;
                                                      }
                                                    </script>
                                            		<?php
                                            		$themepath = get_stylesheet_directory_uri();
                                                    $themepath = str_replace("https://gauratravel.com.au/","",$themepath);
                                                    
                                                    if(isset($_POST['sent_itinerary_email']))
                                            		{
                                            			$today_date = date("Y-m-d H:i:s");
                                            			
                                            			if($order_type_itinerary == 'WPT' || $order_type_itinerary == '')
                				                        {
                				                            $emailsubject = "Itinerary Information - ".$order_id_api;
                                            			    include(get_template_directory().'/templates/email/tpl_email_itinerary.php');
                				                        }
                				                        else if($order_type_itinerary == 'gds')
                				                        {
                				                            $query_pax_lead_traveller = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' order by auto_id asc limit 1";
                                                    		$result_pax_lead_traveller = mysqli_query($mysqli, $query_pax_lead_traveller);
                                                    		$row_pax_lead_traveller = mysqli_fetch_assoc($result_pax_lead_traveller);
                                                                $pnr_for_email = $row_pax_lead_traveller['pnr'];
                    
                				                            $emailsubject = "Itinerary Information - ".$pnr_for_email;
                                            			    include(get_template_directory().'/templates/email/tpl_email_itinerary_gds.php');
                				                        }
                				                        else
                				                        {
                				                            echo 'No system email found';
                				                        }
                				                        
                                            			global $wpdb;
                                            			$email_subject = 'Itinerary Information';
                                            			$wpdb->insert('wpk4_backend_order_email_history', array(
                                                            'email_type' =>'Itinerary Email',
                                                            'order_id' =>$order_id_api,
                                                            'email_address' => $customer_email,
                                                            'initiated_date' => $today_date,
                                            				'initiated_by' => 'customer',
                                                            'email_subject' => $email_subject,
                                                        ));
                                                        $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                            			echo '<script>window.location.href="'.$current_url.'";</script>';
                                            		}
                                                    
                                                    
                                            		if(isset($_POST['download_itinerary_email']))
                                            		{
                                            			$today_date = date("Y-m-d H:i:s");
                                            			
                                            			if($order_type_itinerary == 'WPT' || $order_type_itinerary == '')
                				                        {
                				                            $emailsubject = "Itinerary Information - ".$order_id_api;
                                            			    include(get_template_directory().'/templates/email/tpl_download_itinerary.php');
                				                        }
                				                        else if($order_type_itinerary == 'gds')
                				                        {
                				                            $query_pax_lead_traveller = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' order by auto_id asc limit 1";
                                                    		$result_pax_lead_traveller = mysqli_query($mysqli, $query_pax_lead_traveller);
                                                    		$row_pax_lead_traveller = mysqli_fetch_assoc($result_pax_lead_traveller);
                                                                $pnr_for_email = $row_pax_lead_traveller['pnr'];
                    
                				                            $emailsubject = "Itinerary Information - ".$pnr_for_email;
                                            			    include(get_template_directory().'/templates/email/tpl_download_itinerary_gds.php');
                				                        }
                				                        else
                				                        {
                				                            echo 'No itinerary found';
                				                        }
                				                        
                                            			global $wpdb;
                                            			$email_subject = 'Itinerary Information';
                                            			$wpdb->insert('wpk4_backend_order_email_history', array(
                                                            'email_type' =>'Itinerary Email',
                                                            'order_id' =>$order_id_api,
                                                            'email_address' => $customer_email,
                                                            'initiated_date' => $today_date,
                                            				'initiated_by' => 'customer',
                                                            'email_subject' => $email_subject,
                                                        ));
                                                        $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                            			//echo '<script>window.location.href="'.$current_url.'";</script>';
                                            		}
                                            		
                                            		
                                            		if(isset($_POST['sent_bulk_eticket_email']))
                                            		{
                                            			$today_date = date("Y-m-d H:i:s");
                                            			
                                            			$product_id_for_limit_loop = $product_id_api;
                                            			$order_id = $order_id_api;
                                            			$email_subject = 'Eticket';
                                            			include(get_template_directory().'/templates/email/tpl_download_eticket_bulk.php');
                                            			global $wpdb;
                                            			$wpdb->insert('wpk4_backend_order_email_history', array(
                                                            'email_type' =>'Eticket Email',
                                                            'order_id' =>$order_id,
                                                            'email_address' => $customer_email,
                                                            'initiated_date' => $today_date,
                                            				'initiated_by' => 'customer',
                                                            'email_subject' => $email_subject,
                                                        ));
                                                        $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                            			echo '<script>window.location.href="'.$current_url.'";</script>';
                                            			
                                            		}
                                            		
                                            		
                                            		
                				            
                				            ?>
                        				</div>
                        				
            		    				<div id="itinerary_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>" class="tabcontent" style="display:none;">
                				            <?php
                				            $order_id = $order_id_api;
                				            
                				            
                				            if($order_type_itinerary == 'WPT' || $order_type_itinerary == '' || $order_type_itinerary == 'Agent')
                				            {
                				                
                				                ?>
                				                </br>
                				                <form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                                	<input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='download_itinerary_email' value='Download Itinerary'>
                                                </form>
                				                <?php
                				                echo '<h5>Current Itinerary</h5>';
                				                
                				                $order_id_for_itinerary = $order_id_api;
                            				    $query_order_booking_info_itinerary = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_for_itinerary' order by travel_date asc";
                                        		$result_order_booking_info_itinerary = mysqli_query($mysqli, $query_order_booking_info_itinerary) or die(mysqli_error($mysqli));
                                        		while($row_order_booking_info_itinerary = mysqli_fetch_assoc($result_order_booking_info_itinerary))
                                        		{
                                			$traveldate_fxed = $row_order_booking_info_itinerary['travel_date'];
                                			$product_title = $row_order_booking_info_itinerary['product_title'];
                                			$trip_code = $row_order_booking_info_itinerary['trip_code'];
                                			$product_id_itinerary = $row_order_booking_info_itinerary['product_id'];
                                			$new_product_id_itinerary = $row_order_booking_info_itinerary['new_product_id'];
                                			
                                			if($new_product_id_itinerary == '' || $new_product_id_itinerary == NULL )
                                			{
                                			    $wptravel_itineraries_r = get_post_meta( $product_id_itinerary, 'wp_travel_trip_itinerary_data', true );
                                    			$trip_wp_title = get_post_field( 'post_title', $product_id_itinerary );
                                    			$wptravel_travel_outline = get_post_meta( $product_id_itinerary, 'wp_travel_outline', true );
                                    			$productid_for_wptravel_product = $product_id_itinerary;
                                			}
                                			else
                                			{
                                			    $wptravel_itineraries_r = get_post_meta( $new_product_id_itinerary, 'wp_travel_trip_itinerary_data', true );
                                    			$trip_wp_title = get_post_field( 'post_title', $new_product_id_itinerary );
                                    			$wptravel_travel_outline = get_post_meta( $new_product_id_itinerary, 'wp_travel_outline', true );
                                    			$productid_for_wptravel_product = $new_product_id_itinerary;
                                			}
			
                                			


                                			if ( isset( $wptravel_itineraries_r ) && ! empty( $wptravel_itineraries_r ) ) : 
                                				$wptravel_index = 1;
                                				$itinerary_location_array = array();
                                				$itinerary_time_array = array();
                                				$itinerary_flight_array = array();
                                				$itinerary_date_array = array();
                                				$itinerary_datedecider_array = array();
                                				$itinerary_array_counter = 0;
                                				$itinerary_counter=0;	
                                				foreach ( $wptravel_itineraries_r as $wptravel_itinerary ) : 
                                					$wptravel_time_format = get_option( 'time_format' );
                                					$wptravel_itinerary_label = '';
                                					$wptravel_itinerary_title = '';
                                					$wptravel_itinerary_desc  = '';
                                					$wptravel_itinerary_date  = '';
                                					$wptravel_itinerary_time  = '';
                                					$itinerary_counter = 1;
                                					$is_itinerary_available = 1;
                                						$wptravel_itinerary_label = stripslashes( $wptravel_itinerary['label'] );
                                					
                                						$wptravel_itinerary_title = stripslashes( $wptravel_itinerary['title'] );
                                					
                                						$wptravel_itinerary_desc = stripslashes( $wptravel_itinerary['desc'] );
                                					
                                						$wptravel_itinerary_date = wptravel_format_date( $wptravel_itinerary['date'] );
                                					
                                						$wptravel_itinerary_time = stripslashes( $wptravel_itinerary['time'] );
                                						$wptravel_itinerary_time = date( $wptravel_time_format, strtotime( $wptravel_itinerary_time ) ); 
                                				    $itinerary_location_array[$itinerary_array_counter] = $wptravel_itinerary_label; // destination
                                					$itinerary_time_array[$itinerary_array_counter] = $wptravel_itinerary_time; // flight time
                                					$itinerary_flight_array[$itinerary_array_counter] = $wptravel_itinerary_title; // flight number
                                					$itinerary_date_array[$itinerary_array_counter] = $traveldate_fxed; // flight date
                                					$itinerary_datedecider_array[$itinerary_array_counter] = strip_tags($wptravel_itinerary_desc); // arrival or departure define
                                							
                                					$wptravel_index++;
                                					$itinerary_array_counter++;
                                					
                                				endforeach;
                                			endif; 
                                			// DEFINE EXTRA DAYS
                                            $itinerary_vals = '';
                                			$departure_date_plus_one = date("d/m/Y", strtotime("1 day", strtotime($traveldate_fxed))); 
                                			$departure_date_plus_two = date("d/m/Y", strtotime("2 day", strtotime($traveldate_fxed)));
                                			$departure_date_plus_three = date("d/m/Y", strtotime("3 day", strtotime($traveldate_fxed)));
                                			$departure_date_plus_four = date("d/m/Y", strtotime("4 day", strtotime($traveldate_fxed)));
                                			$length_aray = 0;
                                            if ( isset($itinerary_location_array) && is_array( $itinerary_location_array ) ) {
                                			$length_aray = count($itinerary_location_array);
                                			$itinerary_vals .= '<center><table class="m_-8969220568537220410 tripitinerary wp-travel-table-content trip_'.$product_id_itinerary.'" cellpadding="0" cellspacing="0" style="width:100%; text-align:left; border: 1px solid #e1e1e; border-collapse: collapse; margin:10px 0px 10px 0px; font-size:14px;">
                                			<thead>
                                			  <tr style="background: #f0f0f0; border:none;">
                                				 <th style="width:20%">From</th>
                                				 <th style="width:20%">To</th>
                                				 <th style="width:20%">Flight</th>
                                				 <th style="width:20%">Departure</th>
                                				 <th style="width:20%">Arrival</th>
                                			  </tr>
                                			</thead>
                                			<tbody>';
                                                    }
                                                    else {
                                            // Handle the case when $itinerary_location_array is null
                                            $itinerary_vals .= '<p>No itinerary locations found.</p>';
                                            }
                                			// SECTION TO DIVIDE WAITING, SELF TRANSFER AND FLIGHT INFO
                                			$is_printed_destination = '';
                                			for ($i = 0; $i < $length_aray; $i++) {
                                				if($itinerary_location_array[$i] == 'WAIT')
                                				{
                                					//$itinerary_vals .= "<tr>";
                                					//$itinerary_vals .= '<td colspan="5" style="width:30%">'.$itinerary_location_array[$i].' - '.$itinerary_flight_array[$i].'</td>';
                                					//$itinerary_vals .= "</tr>"; 
                                					
                                					$is_printed_destination = '';
                                				}
                                				else if($itinerary_location_array[$i] == 'SELF-TRANSFER')
                                				{
                                					//$itinerary_vals .= "<tr>";
                                					//$itinerary_vals .= '<td colspan="5" style="width:30%">'.$itinerary_datedecider_array[$i].' - '.$itinerary_flight_array[$i].'</td>';
                                					//$itinerary_vals .= "</tr>"; 
                                					
                                					$is_printed_destination = '';
                                				}
                                				else
                                				{
                                					if ($is_printed_destination == '') 
                            			            {
                            			                 
                            			                $date1 = date("Y-m-d", strtotime($itinerary_datedecider_array[$i]))." ".date("H:i:s", strtotime($itinerary_time_array[$i]));
                            			                if(isset($itinerary_datedecider_array[$i+1]) && isset($itinerary_time_array[$i+1]))
                            			                {
                                                            $date2 = date("Y-m-d", strtotime($itinerary_datedecider_array[$i+1]))." ".date("H:i:s", strtotime($itinerary_time_array[$i+1]));
                                                            $dateDiff = intval((strtotime($date2) - strtotime($date1)) / 60);
                            			                }
                            			                else
                            			                {
                            			                    $dateDiff = intval((strtotime($date1) - strtotime($date1)) / 60);
                            			                }
                                                        
                                                        $hours = intval($dateDiff / 60); 
                                                        $minutes = $dateDiff % 60;
                                                        
                                                        $time_duration = $hours.":".$minutes;
                                                        $airline_from_itinerary = substr($itinerary_flight_array[$i],0,2);
                                            
                                    					$itinerary_vals .= "<tr>";
                                    					$itinerary_vals .= '<td style="width:20%">'.$itinerary_location_array[$i].'</td>';
                                    					if(isset($itinerary_location_array[$i+1])) { 
                                    					    $itinerary_vals .= '<td style="width:20%">'.$itinerary_location_array[$i+1].'</td>';
                                    					}
                                    					$itinerary_vals .= '<td style="width:20%">'.$itinerary_flight_array[$i].'</td>';
                                    					$itinerary_vals .= '<td style="width:20%">'.$itinerary_time_array[$i].'</br>'.$itinerary_datedecider_array[$i].'</td>';
                                    					if(isset($itinerary_time_array[$i+1]) && isset($itinerary_datedecider_array[$i+1])) { 
                                    					    $itinerary_vals .= '<td style="width:20%">'.$itinerary_time_array[$i+1].'</br>'.$itinerary_datedecider_array[$i+1].'</td>';
                                    					}
                                    					$itinerary_vals .= "</tr>";
                                    					$empty = '';
                                    					$itinerary_vals .= "<tr style='border:none;'>";
                                    					$itinerary_vals .= '<td colspan="2" style="border:none;">   Class: Economy
                                    					           </td>';
                                    					$itinerary_vals .= '<td colspan="2" style="border:none;">Operated by: '.$airline_from_itinerary.'</td>';
                                    					$itinerary_vals .= '<td style="border:none;">Duration: </td>';
                                    					$itinerary_vals .= "</tr>";
                                    					
                                    					$is_printed_destination = 'yes';
                            			            }
                            			            else
                            			            {
                            			                $is_printed_destination = '';
                            			            }
                                				}
                                			}
                                    		$itinerary_vals .= "</tbody></table></center></br></br>";
                                    		
                                    		$wptravel_travel_outline = get_post_meta( $productid_for_wptravel_product, 'wp_travel_outline', true );
                                            $pattern_to_remove_itinerary_table = '/<table class="tg">(.*?)<\/table>/s';
                                            $wptravel_travel_outline = preg_replace($pattern_to_remove_itinerary_table, '', $wptravel_travel_outline);
                                    		$itinerary_vals .= $wptravel_travel_outline;
                                    		
                                    		// REPLACE ALL THE FIXED WORDS AS DEPARTURE AND ARRIVAL ON BACKEND
                                    		$itinerary_vals = str_replace("Departure Date", '' ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Arrival Date", '' ,$itinerary_vals);
                                    		
                                    		$itinerary_vals = str_replace("Selected Date +4", $departure_date_plus_four ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Selected Date+4", $departure_date_plus_four ,$itinerary_vals);
                                    		
                                    		$itinerary_vals = str_replace("Selected Date +3", $departure_date_plus_three ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Selected Date+3", $departure_date_plus_three ,$itinerary_vals);
                                    		
                                    		$itinerary_vals = str_replace("Selected Date +2", $departure_date_plus_two ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Selected Date+2", $departure_date_plus_two ,$itinerary_vals);
                                    		
                                    		$itinerary_vals = str_replace("Selected Date+1", $departure_date_plus_one ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Selected Date +1", $departure_date_plus_one ,$itinerary_vals);
                                    		
                                    		$traveldate_fxed_1 = date("d/m/Y", strtotime($traveldate_fxed)); 
                                			$dep_date_ymd = date("Y-m-d", strtotime($traveldate_fxed)); 
                                			
                                    		$itinerary_vals = str_replace("Selected Date", $traveldate_fxed_1 ,$itinerary_vals);
                                			
                                			
                                    		$itinerary_vals = str_replace("Selected Date", $traveldate_fxed_1 ,$itinerary_vals);
                                    		
                                    		
                                    		$trip_code_post = get_post_meta($productid_for_wptravel_product, 'wp_travel_trip_code', true);
	                                        $itinerary_details = getGDealFlightItinerary($trip_code_post, $dep_date_ymd);
	                                        if($itinerary_details != '')
	                                        {
	                                            echo $itinerary_details;
	                                            echo $wptravel_travel_outline;
	                                        }
	                                        else
	                                        {
	                                           echo $itinerary_vals; 
	                                        }
	                                        

                                    		$wptravel_product_information_ordered = get_post_meta( $order_id_for_itinerary, 'order_items_data', true ); // get order product info for trip extras
                                            if (is_array($wptravel_product_information_ordered) || is_object($wptravel_product_information_ordered)) 
                                            {
                                                foreach ($wptravel_product_information_ordered as $key => $value) {
                                                    // Check if the 'trip_extras' key and 'id' key exist
                                                    if (isset($value['trip_extras']['id'])) {
                                                        // Extract "trip_extras" IDs
                                                        $tripExtrasIds = $value['trip_extras']['id'];
                                                        echo '<h6>Additional services</h6>';
                                                        // Print or use the values as needed
                                                        foreach ($tripExtrasIds as $value) {
                                                            echo '<li>'.get_the_title( $value ).'</li>';
                                                        }
                                                    } else {
                                                        echo "No additional services available.";
                                                    }
                                                }
                                    		}
                                    		echo '<hr>';
                                		}
                                        		
                        		                
                        		                
                        		                echo '</br></br>';
                        		                
                        		                
                        		                
                				            }
                				            else if($order_type_itinerary == 'gds')
                				            {
                				                ?>
                				                </br>
                				                <form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                                	<input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='download_itinerary_email' value='Download Itinerary'>
                                                </form>
                				                <?php
                				                echo '<h5>Current Itinerary</h5>';
                				                $carrier = get_meta_from_history_of_updates($order_id_api, "Flightlegs MarketingCarrier");
                				                $flight_number = get_meta_from_history_of_updates($order_id_api, "Flightlegs FlNr");
                				                $departure_airport = get_meta_from_history_of_updates($order_id_api, "Flightlegs DepApt");
                				                $destination_airport = get_meta_from_history_of_updates($order_id_api, "Flightlegs DestApt");
                				                $departure_time = get_meta_from_history_of_updates($order_id_api, "Flightlegs DepTime");
                				                $destination_time = get_meta_from_history_of_updates($order_id_api, "Flightlegs DestTime");
                				                $flight_class = get_meta_from_history_of_updates($order_id_api, "Flightlegs CosDescription");
                				                $flight_class_code = get_meta_from_history_of_updates($order_id_api, "Flightlegs Class");
                				                $flight_elapsed_time = get_meta_from_history_of_updates($order_id_api, "Flightlegs Elapsed");
                				                $flight_meals = get_meta_from_history_of_updates($order_id_api, "Flightlegs Meal");
                				                $flight_departure_terminal = get_meta_from_history_of_updates($order_id_api, "Flightlegs DepTerminal");
                				                $flight_destination_terminal = get_meta_from_history_of_updates($order_id_api, "Flightlegs DestTerminal");
                				                
                                                
                                                $carrier_array = explode(' | ', $carrier);
                                                $flight_number_array = explode(' | ', $flight_number);
                                                $departure_airport_array = explode(' | ', $departure_airport);
                                                $destination_airport_array = explode(' | ', $destination_airport);
                                                $departure_time_array = explode(' | ', $departure_time);
                                                $destination_time_array = explode(' | ', $destination_time);
                                                $flight_class_array = explode(' | ', $flight_class);
                                                $flight_class_code_array = explode(' | ', $flight_class_code);
                                                $flight_elapsed_time_array = explode(' | ', $flight_elapsed_time);
                                                $flight_meals_array = explode(' | ', $flight_meals);
                                                $flight_departure_terminal_array = explode(' | ', $flight_departure_terminal);
                                                $flight_destination_terminal_array = explode(' | ', $flight_destination_terminal);
                                                
                                                $combined_array = array();
                                                for ($i = 0; $i < count($carrier_array); $i++) {
                                                    $combined_array[] = array(
                                                        'carrier' => $carrier_array[$i] ?? '',
                                                        'flightnumber' => $flight_number_array[$i] ?? '',
                                                        'departureairport' => $departure_airport_array[$i] ?? '',
                                                        'destinationairport' => $destination_airport_array[$i] ?? '',
                                                        'departuretime' => $departure_time_array[$i] ?? '',
                                                        'destinationtime' => $destination_time_array[$i] ?? '',
                                                        'flightclass' => $flight_class_array[$i] ?? '',
                                                        'flightclasscode' => $flight_class_code_array[$i] ?? '',
                                                        'flightelapedtime' => $flight_elapsed_time_array[$i] ?? '',
                                                        'flightdepartureterminal' => $flight_departure_terminal_array[$i] ?? '',
                                                        'flightdestinationterminal' => $flight_destination_terminal_array[$i] ?? '',
                                                        'flightmeals' => $flight_meals_array[$i] ?? ''
                                                    );
                                                }
                                                
                                                echo '<table class="table m_-8969220568537220410 tripitinerary wp-travel-table-content trip_'.$order_id.'" cellpadding="0" cellspacing="0" style="width:100%; margin:auto;font-size:14px; width:100%; text-align:left; border: 1px solid #e1e1e; border-collapse: collapse; margin:10px 0px 10px 0px; font-size:14px;">';
                                                echo '<tr><th width="10%">Dep Airport</th><th width="15%">Dep Date</th><th width="10%">Flight</th><th width="10%">Dest Airport</th><th width="15%">Destination Time</th><th width="10%">Class</th><th width="10%">Meal</th><th width="10%">Duration</th></tr>';
                                                $waitTime = '';
                                                $waitHours = '';
                                                $previousDepTime = null;
                    
                                                foreach ($combined_array as $index => $item) {
                                                    $totalMinutes = (int)$item['flightelapedtime'] * 60;
                                                    $hours = floor($totalMinutes / 60);
                                                    $minutes = $totalMinutes % 60;
                                                    $timeFormatted = sprintf("%dh %dmin", $hours, $minutes);
                                                    if ($index > 0) {
                                                        $currentDepTime = strtotime($item['departuretime']);
                                                        $previousDestTime = strtotime($combined_array[$index - 1]['destinationtime']);
                                                        $waitTimeMinutes = round(($currentDepTime - $previousDestTime) / 60);
                                                        $waitHours = floor($waitTimeMinutes / 60);
                                                        $waitMinutes = $waitTimeMinutes % 60;
                                                        $waitTime = sprintf("%dh %dmin", $waitHours, $waitMinutes);
                                                    } else {
                                                        $waitTime = '';
                                                    }
                                                    if ($waitTime !== '' && $waitHours < 24) {
                                                        echo '<tr>';
                                                        echo '<td colspan="7">WAIT: ' . $waitTime . '</td>';
                                                        echo '</tr>';
                                                    }
                                                    if ($waitHours >= 24 && $waitTime !== '') {
                                                        echo '</table></br><table cellpadding="0" cellspacing="0" style="width:100%; text-align:left; border: 1px solid #e1e1e; border-collapse: collapse; margin:10px 0px 10px 0px; font-size:14px;">
                                                        <tr><th width="10%">Dep Airport</th><th width="15%">Dep Date</th><th width="10%">Flight</th><th width="10%">Dest Airport</th><th width="15%">Destination Time</th><th width="10%">Class</th><th width="10%">Meal</th><th width="10%">Duration</th></tr>';
                                                    }
                                                    echo '<tr>';
                                                    echo '<td>' . $item['departureairport'] . '</br>' . $item['flightdepartureterminal'] . '</td>';
                                                    echo '<td>' . $item['departuretime'] . '</td>';
                                                    echo '<td>' . $item['carrier'] . $item['flightnumber'] . '</td>';
                                                    echo '<td>' . $item['destinationairport'] . '</br>' . $item['flightdestinationterminal'] . '</td>';
                                                    echo '<td>' . $item['destinationtime'] . '</td>';
                                                    echo '<td>' . $item['flightclasscode'] . ' - ' . $item['flightclass'] . '</td>';
                                                    echo '<td>' . $item['flightmeals'] . '</td>';
                                                    echo '<td>' . $timeFormatted . '</td>'; // flight time
                                                    echo '</tr>';
                                                    $previousDepTime = strtotime($item['departuretime']);
                                                }
                                                echo '</table>';
                				                
                				            }
											else if($order_type_itinerary == 'Agent' )
        				            {
        				                echo '<h5>Current Itinerary</h5>';
        				                
        				                $order_id_for_itinerary = $order_id_api;
                    				    $query_order_booking_info_itinerary = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_for_itinerary' AND co_order_id='$co_order_id_api' order by travel_date asc";
                                		$result_order_booking_info_itinerary = mysqli_query($mysqli, $query_order_booking_info_itinerary) or die(mysqli_error($mysqli));
                                		while($row_order_booking_info_itinerary = mysqli_fetch_assoc($result_order_booking_info_itinerary))
                                		{
                                			$traveldate_fxed = $row_order_booking_info_itinerary['travel_date'];
                                			$product_title = $row_order_booking_info_itinerary['product_title'];
                                			$trip_code = $row_order_booking_info_itinerary['trip_code'];
                                			$product_id_itinerary = $row_order_booking_info_itinerary['product_id'];
                                			$new_product_id_itinerary = $row_order_booking_info_itinerary['new_product_id'];
                                			
                                			if($new_product_id_itinerary == '' || $new_product_id_itinerary == NULL )
                                			{
                                			    $wptravel_itineraries_r = get_post_meta( $product_id_itinerary, 'wp_travel_trip_itinerary_data', true );
                                    			$trip_wp_title = get_post_field( 'post_title', $product_id_itinerary );
                                    			$wptravel_travel_outline = get_post_meta( $product_id_itinerary, 'wp_travel_outline', true );
                                    			$productid_for_wptravel_product = $product_id_itinerary;
                                			}
                                			else
                                			{
                                			    $wptravel_itineraries_r = get_post_meta( $new_product_id_itinerary, 'wp_travel_trip_itinerary_data', true );
                                    			$trip_wp_title = get_post_field( 'post_title', $new_product_id_itinerary );
                                    			$wptravel_travel_outline = get_post_meta( $new_product_id_itinerary, 'wp_travel_outline', true );
                                    			$productid_for_wptravel_product = $new_product_id_itinerary;
                                			}
			
                                			


                                			if ( isset( $wptravel_itineraries_r ) && ! empty( $wptravel_itineraries_r ) ) : 
                                				$wptravel_index = 1;
                                				$itinerary_location_array = array();
                                				$itinerary_time_array = array();
                                				$itinerary_flight_array = array();
                                				$itinerary_date_array = array();
                                				$itinerary_datedecider_array = array();
                                				$itinerary_array_counter = 0;
                                				$itinerary_counter=0;	
                                				foreach ( $wptravel_itineraries_r as $wptravel_itinerary ) : 
                                					$wptravel_time_format = get_option( 'time_format' );
                                					$wptravel_itinerary_label = '';
                                					$wptravel_itinerary_title = '';
                                					$wptravel_itinerary_desc  = '';
                                					$wptravel_itinerary_date  = '';
                                					$wptravel_itinerary_time  = '';
                                					$itinerary_counter = 1;
                                					$is_itinerary_available = 1;
                                						$wptravel_itinerary_label = stripslashes( $wptravel_itinerary['label'] );
                                					
                                						$wptravel_itinerary_title = stripslashes( $wptravel_itinerary['title'] );
                                					
                                						$wptravel_itinerary_desc = stripslashes( $wptravel_itinerary['desc'] );
                                					
                                						$wptravel_itinerary_date = wptravel_format_date( $wptravel_itinerary['date'] );
                                					
                                						$wptravel_itinerary_time = stripslashes( $wptravel_itinerary['time'] );
                                						$wptravel_itinerary_time = date( $wptravel_time_format, strtotime( $wptravel_itinerary_time ) ); 
                                				    $itinerary_location_array[$itinerary_array_counter] = $wptravel_itinerary_label; // destination
                                					$itinerary_time_array[$itinerary_array_counter] = $wptravel_itinerary_time; // flight time
                                					$itinerary_flight_array[$itinerary_array_counter] = $wptravel_itinerary_title; // flight number
                                					$itinerary_date_array[$itinerary_array_counter] = $traveldate_fxed; // flight date
                                					$itinerary_datedecider_array[$itinerary_array_counter] = strip_tags($wptravel_itinerary_desc); // arrival or departure define
                                							
                                					$wptravel_index++;
                                					$itinerary_array_counter++;
                                					
                                				endforeach;
                                			endif; 
                                			// DEFINE EXTRA DAYS
                                            $itinerary_vals = '';
                                			$departure_date_plus_one = date("d/m/Y", strtotime("1 day", strtotime($traveldate_fxed))); 
                                			$departure_date_plus_two = date("d/m/Y", strtotime("2 day", strtotime($traveldate_fxed)));
                                			$departure_date_plus_three = date("d/m/Y", strtotime("3 day", strtotime($traveldate_fxed)));
                                			$departure_date_plus_four = date("d/m/Y", strtotime("4 day", strtotime($traveldate_fxed)));
                                			$length_aray = 0;
                                            if ( isset($itinerary_location_array) && is_array( $itinerary_location_array ) ) {
                                			$length_aray = count($itinerary_location_array);
                                			$itinerary_vals .= '<center><table class="m_-8969220568537220410 tripitinerary wp-travel-table-content trip_'.$product_id_itinerary.'" cellpadding="0" cellspacing="0" style="width:100%; text-align:left; border: 1px solid #e1e1e; border-collapse: collapse; margin:10px 0px 10px 0px; font-size:14px;">
                                			<thead>
                                			  <tr style="background: #f0f0f0; border:none;">
                                				 <th style="width:20%">From</th>
                                				 <th style="width:20%">To</th>
                                				 <th style="width:20%">Flight</th>
                                				 <th style="width:20%">Departure</th>
                                				 <th style="width:20%">Arrival</th>
                                			  </tr>
                                			</thead>
                                			<tbody>';
                                                    }
                                                    else {
                                            // Handle the case when $itinerary_location_array is null
                                            $itinerary_vals .= '<p>No itinerary locations found.</p>';
                                            }
                                			// SECTION TO DIVIDE WAITING, SELF TRANSFER AND FLIGHT INFO
                                			$is_printed_destination = '';
                                			for ($i = 0; $i < $length_aray; $i++) {
                                				if($itinerary_location_array[$i] == 'WAIT')
                                				{
                                					//$itinerary_vals .= "<tr>";
                                					//$itinerary_vals .= '<td colspan="5" style="width:30%">'.$itinerary_location_array[$i].' - '.$itinerary_flight_array[$i].'</td>';
                                					//$itinerary_vals .= "</tr>"; 
                                					
                                					$is_printed_destination = '';
                                				}
                                				else if($itinerary_location_array[$i] == 'SELF-TRANSFER')
                                				{
                                					//$itinerary_vals .= "<tr>";
                                					//$itinerary_vals .= '<td colspan="5" style="width:30%">'.$itinerary_datedecider_array[$i].' - '.$itinerary_flight_array[$i].'</td>';
                                					//$itinerary_vals .= "</tr>"; 
                                					
                                					$is_printed_destination = '';
                                				}
                                				else
                                				{
                                					if ($is_printed_destination == '') 
                            			            {
                            			                 
                            			                $date1 = date("Y-m-d", strtotime($itinerary_datedecider_array[$i]))." ".date("H:i:s", strtotime($itinerary_time_array[$i]));
                            			                if(isset($itinerary_datedecider_array[$i+1]) && isset($itinerary_time_array[$i+1]))
                            			                {
                                                            $date2 = date("Y-m-d", strtotime($itinerary_datedecider_array[$i+1]))." ".date("H:i:s", strtotime($itinerary_time_array[$i+1]));
                                                            $dateDiff = intval((strtotime($date2) - strtotime($date1)) / 60);
                            			                }
                            			                else
                            			                {
                            			                    $dateDiff = intval((strtotime($date1) - strtotime($date1)) / 60);
                            			                }
                                                        
                                                        $hours = intval($dateDiff / 60); 
                                                        $minutes = $dateDiff % 60;
                                                        
                                                        $time_duration = $hours.":".$minutes;
                                                        $airline_from_itinerary = substr($itinerary_flight_array[$i],0,2);
                                            
                                    					$itinerary_vals .= "<tr>";
                                    					$itinerary_vals .= '<td style="width:20%">'.$itinerary_location_array[$i].'</td>';
                                    					if(isset($itinerary_location_array[$i+1])) { 
                                    					    $itinerary_vals .= '<td style="width:20%">'.$itinerary_location_array[$i+1].'</td>';
                                    					}
                                    					$itinerary_vals .= '<td style="width:20%">'.$itinerary_flight_array[$i].'</td>';
                                    					$itinerary_vals .= '<td style="width:20%">'.$itinerary_time_array[$i].'</br>'.$itinerary_datedecider_array[$i].'</td>';
                                    					if(isset($itinerary_time_array[$i+1]) && isset($itinerary_datedecider_array[$i+1])) { 
                                    					    $itinerary_vals .= '<td style="width:20%">'.$itinerary_time_array[$i+1].'</br>'.$itinerary_datedecider_array[$i+1].'</td>';
                                    					}
                                    					$itinerary_vals .= "</tr>";
                                    					$empty = '';
                                    					$itinerary_vals .= "<tr style='border:none;'>";
                                    					$itinerary_vals .= '<td colspan="2" style="border:none;">   Class: Economy
                                    					           </td>';
                                    					$itinerary_vals .= '<td colspan="2" style="border:none;">Operated by: '.$airline_from_itinerary.'</td>';
                                    					$itinerary_vals .= '<td style="border:none;">Duration: </td>';
                                    					$itinerary_vals .= "</tr>";
                                    					
                                    					$is_printed_destination = 'yes';
                            			            }
                            			            else
                            			            {
                            			                $is_printed_destination = '';
                            			            }
                                				}
                                			}
                                    		$itinerary_vals .= "</tbody></table></center></br></br>";
                                    		
                                    		$wptravel_travel_outline = get_post_meta( $productid_for_wptravel_product, 'wp_travel_outline', true );
                                            $pattern_to_remove_itinerary_table = '/<table class="tg">(.*?)<\/table>/s';
                                            $wptravel_travel_outline = preg_replace($pattern_to_remove_itinerary_table, '', $wptravel_travel_outline);
                                    		$itinerary_vals .= $wptravel_travel_outline;
                                    		
                                    		// REPLACE ALL THE FIXED WORDS AS DEPARTURE AND ARRIVAL ON BACKEND
                                    		$itinerary_vals = str_replace("Departure Date", '' ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Arrival Date", '' ,$itinerary_vals);
                                    		
                                    		$itinerary_vals = str_replace("Selected Date +4", $departure_date_plus_four ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Selected Date+4", $departure_date_plus_four ,$itinerary_vals);
                                    		
                                    		$itinerary_vals = str_replace("Selected Date +3", $departure_date_plus_three ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Selected Date+3", $departure_date_plus_three ,$itinerary_vals);
                                    		
                                    		$itinerary_vals = str_replace("Selected Date +2", $departure_date_plus_two ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Selected Date+2", $departure_date_plus_two ,$itinerary_vals);
                                    		
                                    		$itinerary_vals = str_replace("Selected Date+1", $departure_date_plus_one ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Selected Date +1", $departure_date_plus_one ,$itinerary_vals);
                                    		
                                    		$traveldate_fxed_1 = date("d/m/Y", strtotime($traveldate_fxed)); 
                                			$dep_date_ymd = date("Y-m-d", strtotime($traveldate_fxed)); 
                                			
                                    		$itinerary_vals = str_replace("Selected Date", $traveldate_fxed_1 ,$itinerary_vals);
                                			
                                			
                                    		$itinerary_vals = str_replace("Selected Date", $traveldate_fxed_1 ,$itinerary_vals);
                                    		
                                    		
                                    		$trip_code_post = get_post_meta($productid_for_wptravel_product, 'wp_travel_trip_code', true);
	                                        $itinerary_details = getGDealFlightItinerary($trip_code_post, $dep_date_ymd);
	                                        if($itinerary_details != '')
	                                        {
	                                            echo $itinerary_details;
	                                            echo $wptravel_travel_outline;
	                                        }
	                                        else
	                                        {
	                                           echo $itinerary_vals; 
	                                        }
	                                        

                                    		$wptravel_product_information_ordered = get_post_meta( $order_id_for_itinerary, 'order_items_data', true ); // get order product info for trip extras
                                            if (is_array($wptravel_product_information_ordered) || is_object($wptravel_product_information_ordered)) 
                                            {
                                                foreach ($wptravel_product_information_ordered as $key => $value) {
                                                    // Check if the 'trip_extras' key and 'id' key exist
                                                    if (isset($value['trip_extras']['id'])) {
                                                        // Extract "trip_extras" IDs
                                                        $tripExtrasIds = $value['trip_extras']['id'];
                                                        echo '<h6>Additional services</h6>';
                                                        // Print or use the values as needed
                                                        foreach ($tripExtrasIds as $value) {
                                                            echo '<li>'.get_the_title( $value ).'</li>';
                                                        }
                                                    } else {
                                                        echo "No additional services available.";
                                                    }
                                                }
                                    		}
                                    		echo '<hr>';
                                		}
                                		
                		                
                		                
                		                echo '</br></br>';
                		                
                		                
                		                
        				            }
                				            else
                				            {
                				                echo '<p>No itinerary locations found..</p>';
                				            }
                        				    ?>
                        				</div>
                        				
                        				<div id="history_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>" class="tabcontent" style="display:none;">
                                            <?php
                                                $order_id = $order_id_api;
                                                
                                                $query_ticketing_history = "SELECT * FROM wpk4_backend_travel_booking_update_history where order_id='$order_id_api' && meta_key = 'G360Events' order by updated_time DESC limit 10";
                                            	$result_ticketing_history = mysqli_query($mysqli, $query_ticketing_history);
                                            	$count_ticketing_history = mysqli_num_rows($result_ticketing_history);
                                				if($count_ticketing_history > 0)
                                				{
                                            	?>
                                            	<h5>G360 History</h5>
                                            	<table style="font-size:13px;">
                                                    <tr><th>Type</th><th>on</th><th>By</th></tr>
                                            	    <?php
                                                	while($row_payment_history = mysqli_fetch_assoc($result_ticketing_history))
                                                	{
                                                	    if( $row_payment_history['updated_user'] != 'sriharshans')
                                                	    {
                                    						?>	
                                    							<tr>
                                    								<td><?php echo $row_payment_history['meta_value']; ?> <?php echo $row_payment_history['meta_key_data']; ?></td>
                                    								<td><?php echo $row_payment_history['updated_time']; ?></td>
                                    								<td><?php echo $row_payment_history['updated_user']; ?></td>
                                    							</tr>
                                    						<?php
                                                	    }	   
                                                	}
                                				}
                                				else
                                				{
                                				    echo '<h5>Ticketing History</h5>';
                                				    echo 'No record found';
                                				}
                                            	?>
                                                </table>
                                                
                                                
                                                <?php
                                                $processedOrders = []; // processed meta_key and merge with updated date to skip duplicates
                                				$processedPax = []; // skip the posted pax details
                                				
                                                
                                                $query_ticketing_history = "SELECT * FROM wpk4_backend_travel_booking_update_history where order_id='$order_id_api' && meta_key != 'G360Events' order by pax_auto_id, updated_time ASC";
                                            	$result_ticketing_history = mysqli_query($mysqli, $query_ticketing_history);
                                            	$count_ticketing_history = mysqli_num_rows($result_ticketing_history);
                                				if($count_ticketing_history > 0)
                                				{
                                            	?>
                                            	<h5>Ticketing History</h5>
                                            	<table style="font-size:13px;">
                                                    <tr><th>Type</th><th>Content</th><th>Updated on</th><th> Updated By</th></tr>
                                            	    
                                            	<?php
                                                	while($row_payment_history = mysqli_fetch_assoc($result_ticketing_history))
                                                	{
                                    					$pax_auto_id = $row_payment_history['pax_auto_id'];
                                    					$query_payment_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' && auto_id = '$pax_auto_id'";
                                    					$result_payment_pax = mysqli_query($mysqli, $query_payment_pax);
                                    					$row_payment_pax = mysqli_fetch_assoc($result_payment_pax);
                                        					
                                        					if(mysqli_num_rows($result_payment_pax) > 0)
                                        					{
                                        					    $pax_id_received = $row_payment_pax['auto_id'];
                                        						if (!in_array($pax_id_received, $processedPax)) {
                                        								//continue; // Skip to the next publish of pax row
                                        								$is_pax_name_posted = 1;
                                        							}
                                        							else
                                        							{
                                        								$is_pax_name_posted = 0;
                                        							}
                                        							
                                        						$processedPax[] = $pax_id_received;
                                        						if($is_pax_name_posted == 1)
                                        						{
                                        						    if($row_payment_history['meta_key'] == 'pnr')
                                        						    {
                                        						    ?>
                                        							<tr>
                                        								<td colspan="4"><b><?php echo $row_payment_pax['salutation']; ?> <?php echo $row_payment_pax['fname']; ?> <?php echo $row_payment_pax['lname']; ?></b></td>
                                        							</tr>
                                        						    <?php
                                        						    }
                                        						}
                                        					}
                                    							$updating_value = $row_payment_history['meta_key'].$row_payment_history['pax_auto_id'].$row_payment_history['updated_time'];
                                    							
                                    							if (in_array($updating_value, $processedOrders)) {
                                    								continue; // Skip to the next iteration if the order ID is already processed
                                    							}
                                    							
                                    							$processedOrders[] = $updating_value;
                                    							
                                    							if 
                                    							(
                                    							$row_payment_history['meta_key'] != 'payment_status' &&
                                    							$row_payment_history['meta_key'] != 'eticket_emailed' &&
                                    							$row_payment_history['meta_key'] != 'invoice_raised' &&
                                    							$row_payment_history['meta_key'] != 'payment amount' &&
                                    							$row_payment_history['meta_key'] != 'payment profile' &&
                                    							$row_payment_history['meta_key'] != 'pnr_status'
                                    							)
                                    							{
                                    							    
                                    							
                                    						?>
                                    							<tr>
                                    								<td><?php echo $row_payment_history['meta_key']; ?></td>
                                    								<td><?php echo $row_payment_history['meta_value']; ?></td>
                                    								<td><?php echo $row_payment_history['updated_time']; ?></td>
                                    								<td><?php echo $row_payment_history['updated_user']; ?></td>
                                    							</tr>
                                    						
                                    						<?php
                                    							}
                                    					
                                                	}
                                				}
                                				else
                                				{
                                				    echo '<h5>Ticketing History</h5>';
                                				    echo 'No record found';
                                				}
                                            	?>
                                                </table>
                                                
                                                <?php
                                                $query_movement_history = "SELECT * FROM wpk4_backend_travel_booking_movements where order_id='$order_id_api' order by product_id";
                                            	$result_movement_history = mysqli_query($mysqli, $query_movement_history);
                                				$count_movement_history = mysqli_num_rows($result_movement_history);
                                				if($count_movement_history > 0)
                                				{
                                					?>
                                					<h5>Movement History</h5>
                                					<table style="font-size:13px;">
                                						<tr><th>Original Product ID</th><th>New Product ID</th><th>TripCode</th><th>Travel Date</th><th>Pax</th><th>Moved on</th><th>By</th></tr>
                                						<?php
                                						while($row_movement_history = mysqli_fetch_assoc($result_movement_history))
                                						{
                                						?>
                                						<tr><td><?php echo $row_movement_history['product_id']; ?></td><td><?php echo $row_movement_history['new_product_id']; ?></td><td><?php echo $row_movement_history['trip_code']; ?></td><td><?php echo $row_movement_history['travel_date_int']; ?></td><td><?php echo $row_movement_history['pax']; ?></td><td><?php echo $row_movement_history['updated_on']; ?></td><td><?php echo $row_movement_history['updated_by']; ?></td></tr>
                                						<?php
                                						}
                                						?>
                                					</table>
                                					<?php
                                				}
                                				else
                                				{
                                				    echo '<h5>Movement History</h5>';
                                					echo 'No movement happened';
                                				}
                                            	?>
                                            
                    
                        				    </div>
                        				    
                        				<div id="dc_submission_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>" class="tabcontent" style="display:none;">
                                            <?php
                                            $order_id = $order_id_api;
                                            
        						?>
        						<h4>Date Change Request</h4>
        						<h5>Basic Information</h5>	
								<?php
									$username = $row['email_pax'];
									$phonepx = $row['phone_pax'];
								?>
        
        						<form action="#" id="dcSubmitForm" method="post" enctype="multipart/form-data">
        						<p class='fieldnotelable'>Email Address <font class='redstar'>*</font></p>		
        						<input type='text' name='emailid' placeholder='E-mail' required <?php if($username != '') { echo 'readonly'; } ?>  value='<?php echo $username; ?>'>
        						</br>
        						<p class='fieldnotelable'>Phone Number <font class='redstar'>*</font></p>
        						<input type='text' name='phonenumber' id="phonenumber" onblur="validatePhoneNumber()" onkeypress="return isNumberKey(event)"  required placeholder='Phone' value="<?php echo $phonepx; ?>" >
        						</br>
        						<p class='fieldnotelable'>Reason for the date change <font class='redstar'>*</font></p>
        							<select name='reasonforchange' required id='reasonforchange' style="width:100%; padding:10px; border-color: #dcd7ca;">
        								<option selected disabled value=''>Select</option>
        								<option value='Family Emergency'>Family Emergency</option>
        								<option value='Work Commitment/ Leave Rejection'>Work Commitment/ Leave Rejection</option>
        								<option value='Health Issue/ Concern'>Health Issue/ Concern</option>
        								<option value='Personal Reason'>Personal Reason</option>
        								<option value='Medical Reason'>Medical Reason</option>
        								<option value='Cancellation of Travel Plan'>Cancellation of Travel Plan</option>
        								<option value='Flight Transit Time/ Layover Time'>Flight Transit Time/ Layover Time</option>
        								<option value='Due to travel/ visa restrictions'>Due to travel/ visa restrictions</option>
        								<option value='Name change request'>Name change request</option>
        								<option value='Urgency of travel'>Urgency of travel</option>
        								<option value='Incorrect information/ booking made'>Incorrect information/ booking made</option>
        								<option value='Extend the travel plan'>Extend the travel plan</option>
        							</select>
        						</br></br>
        						<p class='fieldnotelable'>Order ID <font class='redstar'>*</font></p>	
        						<input type='text' name='order_number' onkeypress="return isNumberKey(event)" required placeholder='Reservation Code/Order ID' id='pnr' <?php if($order_id_api != '') echo 'readonly'; ?> value="<?php echo $order_id_api; ?>" onblur="validatePNR()">
        						</br>
        						<h5>Current Travel Information </h5>
        						<p class='fieldnotelable'>Change Type <font class='redstar'>*</font></p>
        							<input type="radio" id="oneway" <?php if($final_order_type == 'oneway') { echo 'checked'; } ?> name="traveltype" value="oneway"> <label for="oneway">One-way (Partial-ticket change)</label>&nbsp;&nbsp;
        							<input type="radio" id="return" name="traveltype" <?php if($final_order_type == 'return') { echo 'checked'; } ?> value="return"> <label for="return">Return (Full-ticket change)</label><br>
        						</br>
        						<p class='fieldnotelable'>Travel Date <font class='redstar'>*</font></p>
        						<table style="border:0px; padding:0px; margin:0px;">
        						<tr><td style='width:50%'>
        							<input type='text' name='prev_traveldate' id='traveldate_going' placeholder='Travel Date' value="<?php echo !empty($row['travel_date']) ? date('d/m/Y', strtotime($row['travel_date'])) : ''; ?>">
        							</td><td style='width:49%'>
        							<input type='text' name='prev_traveldate_return' disabled id='traveldate_return' placeholder='Travel Date' value="<?php echo !empty($row['return_date']) ? date('d/m/Y', strtotime($row['return_date'])) : ''; ?>">
        							</td></tr></table>
        						</br>
        						<p class='fieldnotelable'>Number of Pax <font class='redstar'>*</font></p>
        							<select name='numberofpax_previous' required style="width:100%; padding:10px; border-color: #dcd7ca;">
        								<option selected disabled value=''>0</option>
        								<?php
        								for($i = 1; $i <= 10; $i++)
        								{
        									?>
        									<option <?php if($total_pax == $i ) { echo 'selected'; } ?> value='<?php echo $i; ?>'><?php echo $i; ?></option>
        									<?php
        								}
        								?>
        							</select>
        						</br></br>
        						<p class='fieldnotelable'>Airline <font class='redstar'>*</font></p>
        						<select name='airline' required id='airline' style="width:100%; padding:10px; border-color: #dcd7ca;">
        						<option selected disabled value=''>Airline</option>
        						<option value='Air India'>Air India</option>
        						<option value='Cathay Pacific Airways'>Cathay Pacific Airways</option>
        						<option value='China Airlines'>China Airlines</option>
        						<option value='China Southern'>China Southern</option>
        						<option value='Emirates'>Emirates</option>
        						<option value='Etihad Airways'>Etihad Airways</option>
        						<option value='Garuda Indonesia'>Garuda Indonesia</option>
        						<option value='Jet Airways'>Jet Airways</option>
        						<option value='Malaysia Airlines'>Malaysia Airlines</option>
        						<option value='Qantas Airways'>Qantas Airways</option>
        						<option value='Qatar Airways'>Qatar Airways</option>
        						<option value='Saudi Arabian Airlines'>Saudi Arabian Airlines</option>
        						<option value='Scoot Airlines'>Scoot Airlines</option>
        						<option value='Singapore Airlines'>Singapore Airlines</option>
        						<option value='South African Airways'>South African Airways</option>
        						<option value='Srilankan Airlines'>Srilankan Airlines</option>
        						<option value='Thai Airways'>Thai Airways</option>
        						<option value='Vietnam Airlines'>Vietnam Airlines</option>
        						<option value='Air Asia'>Air Asia</option>
        						<option value='Others'>Others</option>
        						</select>
        						</br></br>
        						<h5>Preferred Travel Information</h5>	
        						
        						<p class='fieldnotelable'>Travel Date <font class='redstar'>*</font></p>
        						
        						<table style="border:0px; padding:0px; margin:0px;">
        						<tr><td style='width:50%'>
        							<input type='text' name='new_traveldate' id='traveldate1' placeholder='Travel Date' >
        							</td><td style='width:49%'>
        							<input type='text' disabled name='new_traveldate_both' id='traveldate1_both' placeholder='Travel Date' >
        							</td></tr></table>
        						</br>
        						<p class='fieldnotelable'>Number of Pax</p>
        							<select name='numberofpax_new' required style="width:100%; padding:10px; border-color: #dcd7ca;">
        								<option selected disabled value=''>0</option>
        								<?php
        								for($i = 1; $i <= 10; $i++)
        								{
        									?>
        									<option <?php if($total_pax == $i ) { echo 'selected'; } ?> value='<?php echo $i; ?>'><?php echo $i; ?></option>
        									<?php
        								}
        								?>
        							</select>
        						</br></br>
        						<p class='fieldnotelable'>From</p>
        						<input type='text' name='future_departure' placeholder='Departure Airport' value="<?php echo substr($row['trip_code'], 0, 3) ?>">
        						</br>
        						<p class='fieldnotelable'>To</p>
        						<input type='text' name='future_arrival' placeholder='Arrival Airport' value="<?php echo substr($row['trip_code'], 4, 3) ?>">
        						</br>
        						<hr>
        						<p class='fieldnotelable'>Additional Document</p>
        						<input type='file' name='inputfile' accept=".jpg,.jpeg,.png,.pdf" placeholder='Add Attachments'  >
        						</br>
        						</br>
        						<input type="checkbox" id="terms" required name="termsconditions" value="agreed"><label for="terms"> By clicking a submission button, <a target='_blank' href='https://gauratravel.com.au/terms-and-conditions/'>I agree to Consent <font class='redstar'>*</font></a></label><br>
        						</br>
        						<center><input type='submit' name='btn_book_pax_dcs' style="width: 200px; font-size: 25px;" onclick="if(this.form.checkValidity()){ this.style.pointerEvents='none'; this.style.opacity='0.6'; this.value='Processing...'; }" class='btn btn-success' id='dcSubmitBtn' value='Submit'></center>
        						</form>
								
        						<?php
        						if (isset($_POST['btn_book_pax_dcs']))
        						{
        							$query_count = "SELECT * FROM wpk4_backend_user_portal_requests ORDER BY case_id DESC LIMIT 1";
        								$result_count = mysqli_query($mysqli, $query_count);
        								$row_count_assoc = mysqli_fetch_assoc($result_count);
        								$row_count = mysqli_num_rows($result_count);
        								if($row_count>0)
        								{
        									$case_id = intval($row_count_assoc['case_id']);
        									$case_id = $case_id+1;
        								}
        								else
        								{
        									$case_id = '1';
        								}
        							$emailid = $_POST['emailid'];
        							$phonenumber = $_POST['phonenumber'];
        							$reasonforchange = $_POST['reasonforchange'];
        							
        							$order_number = $_POST['order_number'];
        							$traveltype = $_POST['traveltype'];
        							$prev_traveldate = $_POST['prev_traveldate'];
        							
        							$prev_traveldate_return = '';
        							$new_traveldate_both = '';
        							if($traveltype == 'return')
        							{
        								$prev_traveldate_return = ($_POST['prev_traveldate_return'] ?? false) ? $_POST['prev_traveldate_return'] : '' ; //current - return
        								
        								$new_traveldate_both = ($_POST['new_traveldate_both'] ?? false) ? $_POST['new_traveldate_both'] : '' ; // preferred - return
        								$future_departure_start = substr($new_traveldate_both, 0, 10); // 14/04/2023 - 17/04/2023
        								$future_departure_end = substr($new_traveldate_both, 13, 23);
        								
        								if($future_departure_start == $future_departure_end)
        								{
        									$new_traveldate_both = $future_departure_start;
        								}
        								else
        								{
        									$new_traveldate_both = $future_departure_start . " - " .  $future_departure_end;
        								}
        							}
        							$numberofpax_previous = $_POST['numberofpax_previous'];
        							$airline = ($_POST['airline'] ?? false)? $_POST['airline'] : '';
        							$new_traveldate = $_POST['new_traveldate'];
        							$future_departure_start = substr($new_traveldate, 0, 10); // 14/04/2023 - 17/04/2023
        							$future_departure_end = substr($new_traveldate, 13, 23);
        							
        							if($future_departure_start == $future_departure_end)
        							{
        								$new_traveldate = $future_departure_start;
        							}
        							else
        							{
        								$new_traveldate = $future_departure_start . " - " .  $future_departure_end;
        							}
        							$future_departure = $_POST['future_departure'];
        							$future_arrival = $_POST['future_arrival'];
        							$numberofpax_new = $_POST['numberofpax_new'];
        									
        							$current_date_time = date('Y-m-d H:i:s');
        							
        							$fileName = $_FILES['inputfile']['name'];
        							if($_FILES['inputfile']['name'] != '')
        							{
        								$temp = explode(".", $_FILES["inputfile"]["name"]);
        								$ext = end($temp);
        								$filename_time = date('ymdHis');
        								$newfilename =  'datechange_'. $filename_time . '.' .$ext;
        							}
        							else
        							{
        								$newfilename = '';
        							}
        							$subject = 'Date change Request '. $order_number;
        							
        							mysqli_query($mysqli,"insert into wpk4_backend_user_portal_requests (case_id, case_type, reservation_ref, last_response_by, last_response_on, is_seen_by_gt, user_id, status, case_date, priority) 
        							values ('$case_id','datechange','$order_number' ,'customer' ,'$current_date_time' ,'0' ,'$user_id' ,'open' ,'$current_date_time' ,'P4')") or die(mysqli_error($mysqli));
        							
        							add_userportal_post_meta($case_id, 'subject', $subject);	add_userportal_post_meta($case_id, 'reason', $reasonforchange);
        							add_userportal_post_meta($case_id, 'email_address', $emailid);
        							add_userportal_post_meta($case_id, 'phone_number', $phonenumber);
        							add_userportal_post_meta($case_id, 'current_travel_date', $prev_traveldate);
        							add_userportal_post_meta($case_id, 'current_no_of_pax', $numberofpax_previous);
        							add_userportal_post_meta($case_id, 'current_airline', $airline);
        							add_userportal_post_meta($case_id, 'preferred_travel_date', $new_traveldate);
        							add_userportal_post_meta($case_id, 'from', $future_departure);
        							add_userportal_post_meta($case_id, 'to', $future_arrival);
        							add_userportal_post_meta($case_id, 'no_of_pax', $numberofpax_new);
        							add_userportal_post_meta($case_id, 'attachment', $newfilename);
        							if($_FILES['inputfile']['name'] != '')
        							{
        								$currentDirectory = getcwd();
        								$uploadDirectory = "wp-content/uploads/customized_function_uploads/";
        								
        								$errors = []; // Store errors here
        								$fileExtensionsAllowed = ['jpeg','jpg','png','pdf','JPEG','JPG','PNG','PDF']; // These will be the only file extensions allowed 
        								
        								$fileSize = $_FILES['inputfile']['size'];
        								$fileTmpName  = $_FILES['inputfile']['tmp_name'];
        								$fileType = $_FILES['inputfile']['type'];
        								$fileExtension_explode = explode('.',$fileName);
        								$fileExtension = strtolower(end($fileExtension_explode));
        								$uploadPath = $uploadDirectory . basename($newfilename); 
        								
        								if (! in_array($fileExtension,$fileExtensionsAllowed)) 
        								{
        									$errors[] = "This file extension is not allowed. Please upload a JPEG, PNG or PDF file";
        								}
        								if ($fileSize > 4000000) {
        									$errors[] = "File exceeds maximum size (4MB)";
        								}
        								if (empty($errors)) 
        								{
        										$didUpload = move_uploaded_file($fileTmpName, $uploadPath);
        									if ($didUpload) {
        										//echo "The file " . basename($fileName) . " has been uploaded";
        									} else {
        										//echo "An error occurred. Please contact the administrator.";
        									}
        								}
        								else
        								{
        									foreach ($errors as $error) {
        									  echo $error . "These are the errors" . "\n";
        									}
        								}				
        							}
        							$mailbody= '<!DOCTYPE html>
        						<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office">
        						<head>
        						<meta charset="utf-8"> <!-- utf-8 works for most cases -->
        						<meta name="viewport" content="width=device-width"> <!-- Forcing initial-scale shouldnt be necessary -->
        						<meta http-equiv="X-UA-Compatible" content="IE=edge"> <!-- Use the latest (edge) version of IE rendering engine -->
        						<meta name="x-apple-disable-message-reformatting">  <!-- Disable auto-scale in iOS 10 Mail entirely -->
        						<title></title> <!-- The title tag shows in email notifications, like Android 4.4. -->
        						<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
        						<!-- CSS Reset : BEGIN -->
        						<style>
        						/* What it does: Stops email clients resizing small text. */
        						* {
        							-ms-text-size-adjust: 100%;
        							-webkit-text-size-adjust: 100%;
        						}
        
        						/* What it does: Centers email on Android 4.4 */
        						div[style*="margin: 16px 0"] {
        							margin: 0 !important;
        						}
        
        						/* What it does: Stops Outlook from adding extra spacing to tables. */
        						table,
        						td {
        							mso-table-lspace: 0pt !important;
        							mso-table-rspace: 0pt !important;
        						}
        
        						/* What it does: Fixes webkit padding issue. */
        						table {
        							border-spacing: 0 !important;
        							border-collapse: collapse !important;
        							table-layout: fixed !important;
        							margin: 0 auto !important;
        						}
        
        						/* What it does: Prevents Windows 10 Mail from underlining links despite inline CSS. Styles for underlined links should be inline. */
        						a {
        							text-decoration: none;
        							color: #30e3ca;
        						}
        
        						h1,h2,h3,h4,h5,h6{
        							font-family: "Lato", sans-serif;
        							color: #000000;
        							margin-top: 0;
        							font-weight: 400;
        						}
        
        						body{
        							font-family: "Lato", sans-serif;
        							font-weight: 400;
        							font-size: 13px;
        							line-height: 1.8;
        							color: rgba(0,0,0,.4);
        						}
        
        						.hero .text{
        							color: rgba(0,0,0,.3);
        						}
        						.hero .text h2{
        							color: #000;
        							font-size: 20px;
        							margin-bottom: 0;
        							font-weight: 400;
        							line-height: 1.4;
        						}
        						.hero .text h3{
        							font-size: 17px;
        							font-weight: 300;
        						}
        						.hero .text h2 span{
        							font-weight: 600;
        							color: #30e3ca;
        						}
        
        
        						ul.social{
        							padding: 0;
        						}
        						ul.social li{
        							display: inline-block;
        							margin-right: 10px;
        						}
        						</style>
        						</head>
        						<body width="100%" style="margin: 0; padding: 0 !important; mso-line-height-rule: exactly; background-color: #f1f1f1;">
        							<center style="width: 100%; background-color: #f1f1f1;">
        							<div style="display: none; font-size: 1px;max-height: 0px; max-width: 0px; opacity: 0; overflow: hidden; mso-hide: all; font-family: sans-serif;">
        							  &zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;
        							</div>
        							<div style="max-width: 600px; margin: 0 auto;" class="email-container">
        							
        							
        						<table class="wp-travel-wrapper" style="color: #5d5d5d; font-family: Roboto, sans-serif; margin: auto;" width="100%" cellspacing="0" cellpadding="0">
        						<tbody>
        						<tr class="wp-travel-content" style="background: #fff;">
        						<td class="wp-travel-content-top" style="background: #fff; margin: 0; padding: 30px 25px;" colspan="2" align="left">
        							<table role="presentation" border="0" cellpadding="0" cellspacing="0" width="100%">
        							<tr>
        							<td class="logo" style="text-align: center;">
        							<img src="https://gauratravel.com.au/wp-content/uploads/2022/01/cropped-GauraTravel_logo_small_2.png" style="width:200px; text-align:center;"/>
        							</td>
        							</tr>
        							</table>
        						</td>
        						</tr>
        						<tr class="wp-travel-content" style="background: #fff;">
        						<td class="wp-travel-content-top" style="background: #fff; margin: 0; padding: 20px 25px;" colspan="2" align="left">
        						<p style="line-height: 1.55; font-size: 14px;">Hi,</p>
        						<p style="line-height: 1.55; font-size: 14px;">Thank you for submitting your date change form with required information as below:</p>
        						<p style="line-height: 1.55; font-size: 14px;"><b></b></p>
        						</td></tr>';
        
        						if($order_number != '')
        						{
        							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Reservation code/ Order ID: '.$order_number.'</td></tr>';
        						}
        						if($reasonforchange != '')
        						{
        							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Reason: '.$reasonforchange.'</td></tr>';
        						}
        						if($prev_traveldate != '')
        						{
        							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Current Travel Date: '.$prev_traveldate.'</td></tr>';
        						}
        						if($numberofpax_previous != '')
        						{
        							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Current No. of pax: '.$numberofpax_previous.'</td></tr>';
        						}	
        						if($airline != '')
        						{
        							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Current Airline: '.$airline.'</td></tr>';
        						}
        						if($new_traveldate != '')
        						{
        							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Preferred Travel Date: '.$new_traveldate.'</td></tr>';
        						}
        						if($future_departure != '')
        						{
        							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Preferred Departure Airport: '.$future_departure.'</b></td></tr>';
        						}
        						if($future_arrival != '')
        						{
        							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Preferred Arrival Airport: '.$future_arrival.'</td></tr>';
        						}
        						if($numberofpax_new != '')
        						{
        							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Preferred No. of pax:'.$numberofpax_new.'</td></tr>';
        						}
        						$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left"> </td></tr>';
        							
        						$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">
        							If your travel date within 96 hours, we will get back to you today, or else our team will get back to you within 48 hours of your submissions.</td></tr>';
        							
        						$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 40px 25px;" colspan="2" align="left">
        							Thank you!</td></tr>';
        						$mailbody .=  '</tbody>
        						</table>
        						</div>
        						</center>
        						</body>
        						</html>';
        							$mailbody=stripslashes($mailbody);
        							$emailsubject="Request Submitted - Gaura Travel";  
        							$path = '';
        							$sentto = $emailid;
        							include('email/tpl_dispatch_userportal_emails.php');
        							
        							echo '<script>alert("Thank you for your submission. Our team will contact you shortly.");</script>';
        							echo '<script>window.location.href="'.$current_url.'";</script>';
        						}
        						?>
        						
        						        				
                                        </div>
                                        
										<div id="dc_submission_edit_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>" class="tabcontent" style="display:none;">
								<?php

								  // ---------- helpers ----------
								  if (!function_exists('gtx_dc_find_today_case_id')) {
									  function gtx_dc_find_today_case_id(mysqli $mysqli, string $order_id_api): ?int {
										  $sql = "
											  SELECT case_id
											  FROM wpk4_backend_user_portal_requests
											  WHERE case_type='datechange'
												AND reservation_ref=?
											  ORDER BY case_id DESC
											  LIMIT 1
										  ";
										  if ($stmt=$mysqli->prepare($sql)) {
											  $stmt->bind_param('s',$order_id_api);
											  $stmt->execute();
											  $stmt->bind_result($cid);
											  if ($stmt->fetch()) { $stmt->close(); return (int)$cid; }
											  $stmt->close();
										  }
										  return null;
									  }
								  }
								  if (!function_exists('gtx_dc_get_meta_map')) {
									  function gtx_dc_get_meta_map(mysqli $mysqli, int $case_id): array {
										  $out=[];
										  $sql="SELECT meta_key, meta_value FROM wpk4_backend_user_portal_request_meta WHERE case_id=? ORDER BY auto_id ASC";
										  if ($stmt=$mysqli->prepare($sql)) {
											  $stmt->bind_param('s',$case_id);
											  $stmt->execute();
											  $res=$stmt->get_result();
											  while($r=$res->fetch_assoc()){ $out[$r['meta_key']]=$r['meta_value']; }
											  $stmt->close();
										  }
										  return $out;
									  }
								  }

								  // ---------- determine mode / prefill ----------
								  $order_id = $order_id_api;
								  $existing_case_id = gtx_dc_find_today_case_id($mysqli, $order_id_api);
								  $has_today = !empty($existing_case_id);

								  $prefill = [];
								  if ($has_today) {
									  $prefill = gtx_dc_get_meta_map($mysqli, $existing_case_id);
								  }

								  $username = $prefill['email_address']  ?? ($row['email_pax']  ?? '');
								  $phonepx  = $prefill['phone_number']   ?? ($row['phone_pax']  ?? '');
								  $cur_go   = $prefill['current_travel_date'] ?? (!empty($row['travel_date']) ? date('d/m/Y', strtotime($row['travel_date'])) : '');
								  $cur_rt   = $prefill['current_travel_date_return'] ?? (!empty($row['return_date']) ? date('d/m/Y', strtotime($row['return_date'])) : '');
								  $pref_go  = $prefill['preferred_travel_date'] ?? '';
								  $pref_rt  = $prefill['preferred_travel_date_return'] ?? '';
								  $air_pref = $prefill['current_airline'] ?? '';
								  $from_pref= $prefill['from'] ?? substr($row['trip_code'], 0, 3);
								  $to_pref  = $prefill['to']   ?? substr($row['trip_code'], 4, 3);
								  $reason_pref = $prefill['reason'] ?? '';
								  $pax_prev    = $prefill['current_no_of_pax'] ?? ($total_pax ?? '');
								  $pax_new     = $prefill['no_of_pax'] ?? ($total_pax ?? '');
								?>

								  <style>
									.dc-hide { display:none; }
									.dc-chooser { border:1px solid #e5e5e5; padding:12px; background:#fafafa; margin:10px 0 16px; }
									.dc-chooser .btn { display:inline-block; padding:8px 12px; border:1px solid #ffbb00; cursor:pointer; margin-right:8px; border-radius:6px; background:#fff; }
									.dc-chooser .btn:hover { background:#f4f4f4; }
									.dc-summary { font-size:14px; line-height:1.5; margin-top:10px; }
									.dc-summary table { width:100%; border-collapse:collapse; }
									.dc-summary td { border-top:1px solid #eee; padding:6px 4px; vertical-align:top; }
									.fieldnotelable { margin-bottom:6px; }
								  </style>

								  <h4>Date Change Request</h4>
								  <h5>Basic Information</h5>

								  <?php if ($has_today): ?>
									<div class="dc-chooser" id="dc_choice_box">
									  <div style="margin-bottom:8px;">
										You already have a submission for this Order ID (Case #<?php echo (int)$existing_case_id; ?>).
										What would you like to do?
									  </div>
									  <div>
										<button type="button" class="btn" id="dc_btn_update_prev" style="background-color:#ffbb00; color: black;">Update Previous</button>
										
										<button class="tablinks chatcategory btn" onclick="openCity(event, 'dc_submission_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')" id="dc_btn_new_submit" style="border:2px solid #ffbb00;">Start New</button>
									  </div>

									  <!-- quick summary of previous (today) -->
									  <div class="dc-summary">
										<table>
										  <tr><td><strong>Case ID</strong></td><td>#<?php echo (int)$existing_case_id; ?></td></tr>
										  <tr><td><strong>Email</strong></td><td><?php echo htmlspecialchars($username); ?></td></tr>
										  <tr><td><strong>Phone</strong></td><td><?php echo htmlspecialchars($phonepx); ?></td></tr>
										  <tr><td><strong>Reason</strong></td><td><?php echo htmlspecialchars($reason_pref ?: ''); ?></td></tr>
										  <tr><td><strong>Current Travel</strong></td><td><?php echo htmlspecialchars(trim($cur_go . ($cur_rt ? " | ".$cur_rt : '')) ?: ''); ?></td></tr>
										  <tr><td><strong>Preferred Travel</strong></td><td><?php echo htmlspecialchars(trim($pref_go . ($pref_rt ? " | ".$pref_rt : '')) ?: ''); ?></td></tr>
										  <tr><td><strong>Route</strong></td><td><?php echo htmlspecialchars(($from_pref ?: '') . '  ' . ($to_pref ?: '')); ?></td></tr>
										  <tr><td><strong>Airline</strong></td><td><?php echo htmlspecialchars($air_pref ?: ''); ?></td></tr>
										</table>
									  </div>
									</div>
								  <?php endif; ?>

								  <!-- form container (hidden if has_today until a choice is made) -->
								  <div id="dc_form_box" class="<?php echo $has_today ? 'dc-hide' : ''; ?>">
									<form action="#" id="dcSubmitForm" method="post" enctype="multipart/form-data">
									  <!-- mode + existing case id (filled by JS if user picks Update Previous) -->
									  <input type="hidden" name="dc_mode" id="dc_mode" value="<?php echo $has_today ? '' : 'new'; ?>">
									  <?php if ($has_today): ?>
										<input type="hidden" name="existing_case_id" id="existing_case_id" value="<?php echo (int)$existing_case_id; ?>">
									  <?php endif; ?>

									  <p class='fieldnotelable'>Email Address <font class='redstar'>*</font></p>
									  <input type='text' name='emailid' placeholder='E-mail' required <?php if($username != '') { echo 'readonly'; } ?> value='<?php echo htmlspecialchars($username); ?>'>
									  </br>

									  <p class='fieldnotelable'>Phone Number <font class='redstar'>*</font></p>
									  <input type='text' name='phonenumber' id="phonenumber" onblur="validatePhoneNumber()" onkeypress="return isNumberKey(event)" required placeholder='Phone' value="<?php echo htmlspecialchars($phonepx); ?>">
									  </br>

									  <p class='fieldnotelable'>Reason for the date change <font class='redstar'>*</font></p>
									  <select name='reasonforchange' required id='reasonforchange' style="width:100%; padding:10px; border-color: #dcd7ca;">
										<option disabled value='' <?php echo $reason_pref===''?'selected':''; ?>>Select</option>
										<?php
										  $reasons = [
											  'Family Emergency','Work Commitment/ Leave Rejection','Health Issue/ Concern','Personal Reason',
											  'Medical Reason','Cancellation of Travel Plan','Flight Transit Time/ Layover Time',
											  'Due to travel/ visa restrictions','Name change request','Urgency of travel',
											  'Incorrect information/ booking made','Extend the travel plan'
										  ];
										  foreach ($reasons as $r) {
											  $sel = ($reason_pref===$r)?'selected':'';
											  echo "<option value='".htmlspecialchars($r,ENT_QUOTES)."' $sel>".htmlspecialchars($r)."</option>";
										  }
										?>
									  </select>
									  </br></br>

									  <p class='fieldnotelable'>Order ID <font class='redstar'>*</font></p>
									  <input type='text' name='order_number' onkeypress="return isNumberKey(event)" required placeholder='Reservation Code/Order ID' id='pnr' <?php if($order_id_api != '') echo 'readonly'; ?> value="<?php echo htmlspecialchars($order_id_api); ?>" onblur="validatePNR()">
									  </br>

									  <h5>Current Travel Information </h5>
									  <p class='fieldnotelable'>Change Type <font class='redstar'>*</font></p>
										<input type="radio" id="oneway" <?php if($final_order_type == 'oneway') { echo 'checked'; } ?> name="traveltype_t" value="oneway"> <label for="oneway">One-way (Partial-ticket change)</label>&nbsp;&nbsp;
										<input type="radio" id="return" name="traveltype_t" <?php if($final_order_type == 'return') { echo 'checked'; } ?> value="return"> <label for="return">Return (Full-ticket change)</label><br>
									  </br>

									  <p class='fieldnotelable'>Travel Date <font class='redstar'>*</font></p>
									  <table style="border:0; padding:0; margin:0;">
										<tr>
										  <td style='width:50%'>
											<input type='text' name='prev_traveldate' id='traveldate_going' placeholder='Travel Date' value="<?php echo htmlspecialchars($cur_go); ?>">
										  </td>
										  <td style='width:49%'>
											<input type='text'  name='prev_traveldate_return' <?php echo ($final_order_type==='return')?'':'disabled'; ?> id='traveldate_return' placeholder='Travel Date' value="<?php echo htmlspecialchars($cur_rt); ?>">
										  </td>
										</tr>
									  </table>
									  </br>

									  <p class='fieldnotelable'>Number of Pax <font class='redstar'>*</font></p>
									  <select name='numberofpax_previous' required style="width:100%; padding:10px; border-color: #dcd7ca;">
										<option disabled value='' <?php echo empty($pax_prev)?'selected':''; ?>>0</option>
										<?php for ($i=1;$i<=10;$i++):
										  $sel = ((string)$pax_prev === (string)$i) ? 'selected' : '';
										?>
										  <option value='<?php echo $i; ?>' <?php echo $sel; ?>><?php echo $i; ?></option>
										<?php endfor; ?>
									  </select>
									  </br></br>

									  <p class='fieldnotelable'>Airline <font class='redstar'>*</font></p>
									  <?php
										$airlines = ['Air India','Cathay Pacific Airways','China Airlines','China Southern','Emirates','Etihad Airways','Garuda Indonesia','Jet Airways','Malaysia Airlines','Qantas Airways','Qatar Airways','Saudi Arabian Airlines','Scoot Airlines','Singapore Airlines','South African Airways','Srilankan Airlines','Thai Airways','Vietnam Airlines','Air Asia','Others'];
									  ?>
									  <select name='airline' required id='airline' style="width:100%; padding:10px; border-color: #dcd7ca;">
										<option disabled value='' <?php echo empty($air_pref)?'selected':''; ?>>Airline</option>
										<?php foreach($airlines as $a):
										  $sel = ($air_pref===$a)?'selected':'';
										?>
										  <option value='<?php echo htmlspecialchars($a,ENT_QUOTES); ?>' <?php echo $sel; ?>><?php echo htmlspecialchars($a); ?></option>
										<?php endforeach; ?>
									  </select>
									  </br></br>

									  <h5>Preferred Travel Information</h5>

									  <p class='fieldnotelable'>Travel Date <font class='redstar'>*</font></p>
									  <table style="border:0; padding:0; margin:0;">
										<tr>
										  <td style='width:50%'>
											<input type='text' name='new_traveldate' id='traveldate1' placeholder='Travel Date' value="<?php echo htmlspecialchars($pref_go); ?>">
										  </td>
										  <td style='width:49%'>
											<input type='text' <?php echo ($final_order_type==='return')?'':'disabled'; ?>  name='new_traveldate_both' id='traveldate1_both' placeholder='Travel Date' value="<?php echo htmlspecialchars($pref_rt); ?>">
										  </td>
										</tr>
									  </table>
									  </br>

									  <p class='fieldnotelable'>Number of Pax</p>
									  <select name='numberofpax_new' required style="width:100%; padding:10px; border-color: #dcd7ca;">
										<option disabled value='' <?php echo empty($pax_new)?'selected':''; ?>>0</option>
										<?php for ($i=1;$i<=10;$i++):
										  $sel = ((string)$pax_new === (string)$i) ? 'selected' : '';
										?>
										  <option value='<?php echo $i; ?>' <?php echo $sel; ?>><?php echo $i; ?></option>
										<?php endfor; ?>
									  </select>
									  </br></br>

									  <p class='fieldnotelable'>From</p>
									  <input type='text' name='future_departure' placeholder='Departure Airport' value="<?php echo htmlspecialchars($from_pref); ?>">
									  </br>

									  <p class='fieldnotelable'>To</p>
									  <input type='text' name='future_arrival' placeholder='Arrival Airport' value="<?php echo htmlspecialchars($to_pref); ?>">
									  </br>

									  <input type="checkbox" id="terms" required name="termsconditions" value="agreed">
									  <label for="terms"> By clicking a submission button, <a target='_blank' href='https://gauratravel.com.au/terms-and-conditions/'>I agree to Consent <font class='redstar'>*</font></a></label><br>
									  </br>

									  <center>
										<input type='submit' name='btn_book_pax_dcs_update' style="width: 200px; font-size: 25px;"
											   onclick="if(this.form.checkValidity()){ this.style.pointerEvents='none'; this.style.opacity='0.6'; this.value='Processing...'; }"
											   class='btn btn-success' id='dcSubmitBtn' value='Submit'>
									  </center>
									</form>
									
								  </div><!-- /dc_form_box -->
									<?php
									if (isset($_POST['btn_book_pax_dcs_update'])) {

									// 1) Resolve existing case (prefer POSTed id; else fallback to today's case for this order)
									$existing_case_id = isset($_POST['existing_case_id']) ? $_POST['existing_case_id'] : '';

									// 2) Gather fields (use posted values; keep labels user-friendly)
									$pairs = [];
									$pairs['Note:']                = 'Updated case.';
									$pairs['Email Address']                = $_POST['emailid']               ?? '';
									$pairs['Phone Number']                 = $_POST['phonenumber']           ?? '';
									$pairs['Reason']                       = $_POST['reasonforchange']       ?? '';
									$pairs['Order ID']                     = $_POST['order_number']          ?? '';
									$pairs['Change Type']                  = $_POST['traveltype_t']            ?? '';

									$pairs['Current Travel Date']     = $_POST['prev_traveldate']       ?? '';
									$pairs['Current Travel Date'] = $_POST['prev_traveldate_return']?? '';

									$pairs['Current Pax Count']            = $_POST['numberofpax_previous']  ?? '';
									$pairs['Airline']                      = $_POST['airline']               ?? '';

									$pairs['Preferred Travel Date']   = $_POST['new_traveldate']        ?? '';
									$pairs['Preferred Travel Date']= $_POST['new_traveldate_both']  ?? '';

									$pairs['From']                         = $_POST['future_departure']      ?? '';
									$pairs['To']                           = $_POST['future_arrival']        ?? '';

									// 3) Handle optional attachment (upload + add filename to response)
									$upload_note = '';
									
									if ($upload_note !== '') {
										$pairs['Attachment'] = $upload_note;
									}

									// 4) Build the multi-line response text
									$lines = [];
									foreach ($pairs as $label => $value) {
										// Normalize line breaks and trim
										$value = trim(str_replace(["\r\n","\r"], "\n", (string)$value));
										$lines[] = $label . ': ' . $value;
									}
									$response_text = implode(PHP_EOL, $lines);

									// 5) Who is responding?
									// Prefer your existing $user_id; else try session; else 0
									if (!isset($user_id)) {
										if (session_status() === PHP_SESSION_NONE) { @session_start(); }
										$user_id = $_SESSION['userId'] ?? 0;
									}
									$response_by = $user_id;

									// 6) Insert chat row
									$sql = "
										INSERT INTO wpk4_backend_user_portal_request_chats
											(request_id, request_type, response, response_time, response_by, status, chat_or_note)
										VALUES
											(?, 'datechange', ?, NOW(), ?, 'open', 'chat')
									";
									if ($stmt = $mysqli->prepare($sql)) {
										$stmt->bind_param('sss', $existing_case_id, $response_text, $response_by);
										$ok = $stmt->execute();
										$stmt->close();

										if ($ok) {
											echo '<script>alert("Your update has been added to the existing case (#'.$existing_case_id.').");</script>';
											echo '<script>window.location.href="'.$current_url.'";</script>';
											exit;
										} else {
											echo '<script>alert("Unable to save your update. Please try again.");</script>';
										}
									} else {
										echo '<script>alert("Database error while preparing save. Please try again.");</script>';
									}
								}
																
																?>
																
								  <script>
									(function(){
									  var hasToday = <?php echo $has_today ? 'true':'false'; ?>;
									  if(!hasToday) return;

									  var btnUpdate = document.getElementById('dc_btn_update_prev');
									  var btnNew    = document.getElementById('dc_btn_new_submit');
									  var boxChoice = document.getElementById('dc_choice_box');
									  var boxForm   = document.getElementById('dc_form_box');
									  var dcMode    = document.getElementById('dc_mode');
									  var submitBtn = document.getElementById('dcSubmitBtn');

									  function showForm(mode){
										if (dcMode) dcMode.value = mode;  // 'update' or 'new'
										if (submitBtn) submitBtn.value = (mode==='update' ? 'Update' : 'Submit');
										boxChoice.classList.add('dc-hide');
										boxForm.classList.remove('dc-hide');
									  }

									  btnUpdate && btnUpdate.addEventListener('click', function(){
										showForm('update');
									  });
									  btnNew && btnNew.addEventListener('click', function(){
										showForm('new');
									  });
									})();
								  </script>
								</div>

										
										<script src="https://cdn.jsdelivr.net/gh/alumuko/vanilla-datetimerange-picker@latest/dist/vanilla-datetimerange-picker.js"></script>
        						<script>
        						
        						var currentdate = new Date(); 
        						var date_tomorrow = new Date((new Date()).valueOf() + 1000*3600*24);
        						window.addEventListener("load", function (event) {
        								let drp = new DateRangePicker('traveldate_going',
        										{
        											timePicker: false,
        											alwaysShowCalendars: true,
        											singleDatePicker: true,
        											autoApply: true,
        											autoUpdateInput: true,
        											
        											locale: {
        												format: "DD/MM/YYYY",
        											}
        										},
        										function (start) {
        											document.getElementById("traveldate_going").value = start.format();
        											
        										})
        								});
        						
        						var travel_date_going = new Date((document.getElementById("traveldate_going").value).valueOf() + 1000*3600*24);
        						window.addEventListener("load", function (event) {
        								let drp = new DateRangePicker('traveldate_return',
        										{
        											timePicker: false,
        											alwaysShowCalendars: true,
        											singleDatePicker: true,
        											autoApply: true,
        											autoUpdateInput: true,
        											
        											locale: {
        												format: "DD/MM/YYYY",
        											}
        										},
        										function (start) {
        											document.getElementById("traveldate_return").value = start.format();
        											
        										})
        								});
        						window.addEventListener("load", function (event) {
        								let drp = new DateRangePicker('traveldate1',
        										{
        											minDate: date_tomorrow,
        											endDate: date_tomorrow,
        											timePicker: false,
        											alwaysShowCalendars: true,
        											//singleDatePicker: true,
        											autoApply: true,
        											autoUpdateInput: true,
        											maxSpan: { "days": 3 },
        											locale: {
        												format: "DD/MM/YYYY",
        											}
        										},
        										function (start,end) {
        											document.getElementById("traveldate1").value = '';
        											var startdate = start.format().substring(0,10); // 2023-04-11T00:00:00+10:00 -> 2023-04-11
        											var enddate = end.format().substring(0,10); // 2023-04-13T23:59:59+10:00 -> 2023-04-13
        										   
        											var isstartdate = startdate + 'T00:00:00+10:00';
        											var isenddate = startdate + 'T23:59:59+10:00';
        											if(startdate != enddate)
        											{
        												document.getElementById("traveldate1").value = startdate + ' - ' + enddate;
        											}
        											else
        											{
        												document.getElementById("traveldate1").value = startdate;
        											}
        										})
        								});		
        							window.addEventListener("load", function (event) {
        								let drp = new DateRangePicker('traveldate1_both',
        										{
        											minDate: date_tomorrow,
        											endDate: date_tomorrow,
        											timePicker: false,
        											alwaysShowCalendars: true,
        											autoApply: true,
        											autoUpdateInput: true,
        											maxSpan: { "days": 3 },
        											locale: {
        												format: "DD/MM/YYYY",
        											}
        										},
        										function (start,end) {
        											document.getElementById("traveldate1_both").value = '';
        											var startdate = start.format().substring(0,10);
        											var enddate = end.format().substring(0,10);
        											var isstartdate = startdate + 'T00:00:00+10:00';
        											var isenddate = startdate + 'T23:59:59+10:00';
        											if(startdate != enddate)
        											{
        												document.getElementById("traveldate1_both").value = startdate + ' - ' + enddate;
        											}
        											else
        											{
        												document.getElementById("traveldate1_both").value = startdate;
        											}
        										})
        								});	
        							document.getElementById("traveldate_return").value = '';
        							document.getElementById("traveldate1_both").value = '';
        							$(document).ready(function(){
        								$('input[name="traveltype"]').on('change', function(){
        								   if($(this).val() === 'return') {
        									 $('#traveldate_return').prop('disabled', false);  
        									 $('#traveldate1_both').prop('disabled', false);  
        								   }
        								   else {
        									 $('#traveldate_return').prop('disabled', true);  
        									 document.getElementById("traveldate_return").value = '';
        									 $('#traveldate1_both').prop('disabled', true);  
        									 document.getElementById("traveldate1_both").value = '';
        								   }
        								});
        							});
        							</script>
										
										
										
										
										<div id="refund_request_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>" class="tabcontent" style="display:none;">
                            <?php
                            $order_id = $order_id_api;
        					?>	
        					<form action="#" method="post" id="refundSubmitForm" enctype="multipart/form-data">
        					<h2>Apply for Refunds</h2>	
							<?php
									$username = $row['email_pax'];
									$phonepx = $row['phone_pax'];
								?>
        						<h4>Gerneral Information</h4>
        					<p class='fieldnotelable'>Email Address</p>	
        							<input type='text' name='emailid' placeholder='E-mail' required <?php if($username != '') { echo 'readonly'; } ?> value='<?php echo $username; ?>'>
        							</br>
        							<p class='fieldnotelable'>Reason</p>
        							<textarea name='reasonforcancellation' placeholder='Reason' required></textarea>
        							</br>
        							<p class='fieldnotelable'>Order ID</p>
        							<input type='text' name='order_number' onkeypress="return isNumberKey(event)" required value="<?php echo $order_id_api; ?>" <?php if($order_id_api != '') echo 'readonly'; ?>  placeholder='Reservation Code/ Order ID'  >
        							</br>
        							<p class='fieldnotelable'>Phone Number</p>
        							<input type='text' id="phonenumber" onblur="validatePhoneNumber()" onkeypress="return isNumberKey(event)" name='phonenumber' required placeholder='Phone' value="<?php echo $phonepx; ?>"	 >        						
        						<h4>Ticket Information</h4>	
        					<fieldset id="paxcontainer">
        					  <div class="paxbox" style='display:flex;'>
        					  
        						<div style='width:100%;'><p class='fieldnotelable'>Name of Passenger</p></br>
        						<input type="text" onkeypress="return isTextKey(event)" required placeholder='Name of Passenger' id="pax_name" name="pax_name[]"></div>
        					  </div>
        					</fieldset>
        					<button type="button" id="add_pax" class='btn_add_remove'>+ Add more</button>
        					</br></br>
        					<fieldset id="ticketcontainer">
        					  <div class="ticketbox" style='display:flex;'>
        					  
        						<div style='width:100%;'><p class='fieldnotelable'>Ticket Number</p></br><input type="text" placeholder='Ticket Number' onkeypress="return isNumberKey(event)" id="ticket_number" name="ticket_number[]"></div>
        					  </div>
        					</fieldset>
        					<button type="button" id="add_ticket" class='btn_add_remove'>+ Add more</button>
        					</br>
        					<p class='fieldnotelable'>Reservation Code</p>
        					<input type='text' name='reservationcode' placeholder='Reservation Code' id='pnr' onblur="validatePNR()">
        					</br>
        					<p class='fieldnotelable'>Airline Reservation Code</p>
        					<input type='text' name='airlinereservationcode' placeholder='Airline Reservation Code' id='airline_pnr' onblur="validateAirlinePNR()">
        					</br>
        					<p class='fieldnotelable'>Airline</p>
        					<select name='airline' required id='airline' style="width:100%; padding:10px; border-color: #dcd7ca;">
        					<option selected disabled>Airline</option>
            					<option value='Malaysia Airlines'>Malaysia Airlines</option>
            					<option value='Qantas Airways'>Qantas Airways</option>
            					<option value='Singapore Airlines'>Singapore Airlines</option>
            					<option value='Scoot Airlines'>Scoot Airlines</option>
            					<option value='Air India'>Air India</option>
            					<option value='Air India'>Air India</option>
            					<option value='Cathay Pacific Airways'>Cathay Pacific Airways</option>
            					<option value='China Airlines'>China Airlines</option>
            					<option value='China Southern'>China Southern</option>
            					<option value='Emirates'>Emirates</option>
            					<option value='Etihad Airways'>Etihad Airways</option>
            					<option value='Garuda Indonesia'>Garuda Indonesia</option>
            					<option value='Jet Airways'>Jet Airways</option>
            					<option value='Malaysia Airlines'>Malaysia Airlines</option>
            					<option value='Qantas Airways'>Qantas Airways</option>
            					<option value='Qatar Airways'>Qatar Airways</option>
            					<option value='Saudi Arabian Airlines'>Saudi Arabian Airlines</option>
            					<option value='Scoot Airlines'>Scoot Airlines</option>
            					<option value='Singapore Airlines'>Singapore Airlines</option>
            					<option value='South African Airways'>South African Airways</option>
            					<option value='Srilankan Airlines'>Srilankan Airlines</option>
            					<option value='Thai Airways'>Thai Airways</option>
            					<option value='Vietnam Airlines'>Vietnam Airlines</option>
            					<option value='Air Asia'>Air Asia</option>
            					<option value='Others'>Others</option>
        					</select>
        					</br></br>
        					<p class='fieldnotelable'>Travel Date</p>
        					<input type='text' required name='traveldate' id='traveldate' placeholder='Travel Date' value="<?php echo !empty($row['travel_date']) ? date('d/m/Y', strtotime($row['travel_date'])) : ''; ?>">
        					<h4>Bank Details</h4>
        					<p class='fieldnotelable'>Account Name</p>	
        					<input type='text' name='accountname' onkeypress="return isTextKey(event)" required placeholder='Account Name'  >
        					</br>
        					<p class='fieldnotelable'>BSB</p>
        					<input type='text' name='bsb' id='bsb' required onkeypress="return isNumberKey(event)" placeholder='BSB'  >
        					</br>
        					<p class='fieldnotelable'>Account Number</p>
        					<input type='text' name='accountnumber' onkeypress="return isNumberKey(event)" required placeholder='Account Number'  >
        					</br>
        					<hr>
        					<p class='fieldnotelable'>Additional Document</p>
        					<input type='file' name='inputfile' accept=".jpg,.jpeg,.png,.pdf" placeholder='Add Attachments'  >
        					</br></br>
        					<input type="checkbox" id="terms" required name="termsconditions" value="agreed"><label for="terms"> By clicking a submission button, <a target='_blank' href='https://gauratravel.com.au/terms-and-conditions/'>I agree to Consent *</a></label><br>
        
        					</br></br>
        					<center><input type='submit' name='btn_book_pax_refund' class='btn btn-success' style="width: 200px; font-size: 25px;" onclick="if(this.form.checkValidity()){ this.style.pointerEvents='none'; this.style.opacity='0.6'; this.value='Processing...'; }" id='refundSubmitBtn' value='Submit'></center>
        					</form>
        					<script>
        					  var input = document.getElementById("bsb");
        					  input.addEventListener("input", function() {
        						let value = input.value;
        						value = value.replace(/-/g, ""); // remove existing hyphens
        						if (value.length > 3) {
        						  value = value.slice(0, 3) + "-" + value.slice(3); // insert hyphen after third character
        						}
        						input.value = value;
        					  });
        					</script>
							

							
        					<?php
        					if(isset($_POST['btn_book_pax_refund']))
        					{
        						$query_count = "SELECT * FROM wpk4_backend_user_portal_requests ORDER BY case_id DESC LIMIT 1";
        						$result_count = mysqli_query($mysqli, $query_count);
        						$row_count_assoc = mysqli_fetch_assoc($result_count);
        						$row_count = mysqli_num_rows($result_count);
        						if($row_count>0)
        						{
        							$case_id = intval($row_count_assoc['case_id']);
        							$case_id = $case_id+1;
        						}
        						else
        						{
        							$case_id = '1';
        						}
        						$emailid = $_POST['emailid'];
        						$order_number = $_POST['order_number'];
        						$fileName = $_FILES['inputfile']['name'];
        						$temp = explode(".", $_FILES["inputfile"]["name"]);
        						
        						$reasonforcancellation = $_POST['reasonforcancellation'];
        						$phonenumber = $_POST['phonenumber'];
        						$reservationcode = $_POST['reservationcode'];
        						$airlinereservationcode = $_POST['airlinereservationcode'];
        						$airline = ($_POST['airline'] ?? false)? $_POST['airline'] : '';
        						$traveldate = $_POST['traveldate'];
        						$accountname = $_POST['accountname'];
        						$bsb = $_POST['bsb'];
        						$accountnumber = $_POST['accountnumber'];
        						mysqli_query($mysqli,"insert into wpk4_backend_user_portal_requests (case_id, case_type, reservation_ref, last_response_by, last_response_on, is_seen_by_gt, user_id, status, case_date, priority) 
        						values ('$case_id','refund','$order_number' ,'customer' ,'$current_date_time' ,'0' ,'$user_id' ,'open' ,'$current_date_time' ,'P4')") or die(mysqli_error($mysqli));
        						$subject = 'Refund Request '. $order_number;
        						$fileName = $_FILES['inputfile']['name'];
        							if($_FILES['inputfile']['name'] != '')
        							{
        								$temp = explode(".", $fileName);
        								$ext = end($temp);
        								$filename_time = date('ymdHis');
        								$newfilename =  'refund_'. $filename_time . '.' .$ext;
        							}
        							else
        							{
        								$newfilename = '';
        							}
        							
        						$pax_name = $_POST['pax_name'];
        						$ticket_number = $_POST['ticket_number'];
        						$pax_names = '';
        						
        						foreach( $pax_name as $key => $n ) 
        						{
        							$pax_names .= $n . ', ';
        						}
        						
        						$ticket_numbers = '';
        						foreach( $ticket_number as $key => $n ) 
        						{
        							$ticket_numbers .= $n . ', ';
        						}
        						add_userportal_post_meta($case_id, 'subject', $subject);
        						add_userportal_post_meta($case_id, 'reason', $reasonforcancellation);
        						add_userportal_post_meta($case_id, 'reservation_code', $reservationcode);
        						add_userportal_post_meta($case_id, 'airline_reservation_code', $airlinereservationcode);
        						add_userportal_post_meta($case_id, 'airline', $airline);
        						add_userportal_post_meta($case_id, 'travel_date', $traveldate);
        						add_userportal_post_meta($case_id, 'attachment', $newfilename);
        						add_userportal_post_meta($case_id, 'phone_number', $phonenumber);
        						add_userportal_post_meta($case_id, 'email_address', $emailid);
        						add_userportal_post_meta($case_id, 'account_name', $accountname);
        						add_userportal_post_meta($case_id, 'bsb', $bsb);
        						add_userportal_post_meta($case_id, 'account_number', $accountnumber);
        						add_userportal_post_meta($case_id, 'passenger_names', $pax_names);
        						add_userportal_post_meta($case_id, 'ticket_numbers', $ticket_numbers);
        						
        						$array_of_rows = array("cancellation_fee", "refund_amount" ,"refund_received_from_airline", "diff" ,"refund_received_date", "submitted_date", "booking_type", "remarks", "profile_number", "total_paid_by_customer", "gt_cancellation_fees", "airline_cancellation_fees", "consolidator_fees", "type_of_refund", "stage", "refund_applied_to_airline_date", "refund_received_from_airline_date", "pcc", "consolidator", "oneway_return", "rejected", "refund_received_from_consolidator","refund_processed_date");

        						
        						foreach ($array_of_rows as $value) // adding dummy record for refund team's records.
        						{
        							$value = mysqli_real_escape_string($mysqli, $value);
        							$insert_query = "INSERT INTO wpk4_backend_user_portal_request_meta (`case_id`,`meta_key`) VALUES ('$case_id','$value')";
        
        							$result = mysqli_query($mysqli, $insert_query);
        							if (!$result) 
        							{
        								die("Error: " . mysqli_error($mysqli));
        							}
        						}
        						if($_FILES['inputfile']['name'] != '')
        							{
        								$currentDirectory = getcwd();
        								$uploadDirectory = "wp-content/uploads/customized_function_uploads/";
        								
        								$errors = []; // Store errors here
        								$fileExtensionsAllowed = ['jpeg','jpg','png','pdf','JPEG','JPG','PNG','PDF']; // These will be the only file extensions allowed 
        								
        								$fileSize = $_FILES['inputfile']['size'];
        								$fileTmpName  = $_FILES['inputfile']['tmp_name'];
        								$fileType = $_FILES['inputfile']['type'];
        								$extension_explode = explode('.',$fileName);
        								$fileExtension = strtolower(end($extension_explode));
        								$uploadPath = $uploadDirectory . basename($newfilename); 
        							
        								if (! in_array($fileExtension,$fileExtensionsAllowed)) 
        								{
        									$errors[] = "This file extension is not allowed. Please upload a JPEG, PNG or PDF file";
        								}
        								if ($fileSize > 4000000) {
        									$errors[] = "File exceeds maximum size (4MB)";
        								}
        								if (empty($errors)) 
        								{
        										$didUpload = move_uploaded_file($fileTmpName, $uploadPath);
        									if ($didUpload) {
        										//echo "The file " . basename($fileName) . " has been uploaded";
        									} else {
        										//echo "An error occurred. Please contact the administrator.";
        									}
        								}
        								else
        								{
        									foreach ($errors as $error) {
        									  echo $error . "These are the errors" . "\n";
        									}
        								}
        							}
        						
        						$mailbody= '<!DOCTYPE html>
        							<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office">
        							<head>
        							<meta charset="utf-8"> <!-- utf-8 works for most cases -->
        							<meta name="viewport" content="width=device-width"> <!-- Forcing initial-scale shouldnt be necessary -->
        							<meta http-equiv="X-UA-Compatible" content="IE=edge"> <!-- Use the latest (edge) version of IE rendering engine -->
        							<meta name="x-apple-disable-message-reformatting">  <!-- Disable auto-scale in iOS 10 Mail entirely -->
        							<title></title> <!-- The title tag shows in email notifications, like Android 4.4. -->
        							<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
        							<!-- CSS Reset : BEGIN -->
        							<style>
        							/* What it does: Stops email clients resizing small text. */
        							* {
        								-ms-text-size-adjust: 100%;
        								-webkit-text-size-adjust: 100%;
        							}
        
        							/* What it does: Centers email on Android 4.4 */
        							div[style*="margin: 16px 0"] {
        								margin: 0 !important;
        							}
        
        							/* What it does: Stops Outlook from adding extra spacing to tables. */
        							table,
        							td {
        								mso-table-lspace: 0pt !important;
        								mso-table-rspace: 0pt !important;
        							}
        
        							/* What it does: Fixes webkit padding issue. */
        							table {
        								border-spacing: 0 !important;
        								border-collapse: collapse !important;
        								table-layout: fixed !important;
        								margin: 0 auto !important;
        							}
        
        							/* What it does: Prevents Windows 10 Mail from underlining links despite inline CSS. Styles for underlined links should be inline. */
        							a {
        								text-decoration: none;
        								color: #30e3ca;
        							}
        
        							h1,h2,h3,h4,h5,h6{
        								font-family: "Lato", sans-serif;
        								color: #000000;
        								margin-top: 0;
        								font-weight: 400;
        							}
        
        							body{
        								font-family: "Lato", sans-serif;
        								font-weight: 400;
        								font-size: 13px;
        								line-height: 1.8;
        								color: rgba(0,0,0,.4);
        							}
        
        							.hero .text{
        								color: rgba(0,0,0,.3);
        							}
        							.hero .text h2{
        								color: #000;
        								font-size: 20px;
        								margin-bottom: 0;
        								font-weight: 400;
        								line-height: 1.4;
        							}
        							.hero .text h3{
        								font-size: 17px;
        								font-weight: 300;
        							}
        							.hero .text h2 span{
        								font-weight: 600;
        								color: #30e3ca;
        							}
        
        
        							ul.social{
        								padding: 0;
        							}
        							ul.social li{
        								display: inline-block;
        								margin-right: 10px;
        							}
        							</style>
        							</head>
        							<body width="100%" style="margin: 0; padding: 0 !important; mso-line-height-rule: exactly; background-color: #f1f1f1;">
        								<center style="width: 100%; background-color: #f1f1f1;">
        								<div style="display: none; font-size: 1px;max-height: 0px; max-width: 0px; opacity: 0; overflow: hidden; mso-hide: all; font-family: sans-serif;">
        								  &zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;
        								</div>
        								<div style="max-width: 600px; margin: 0 auto;" class="email-container">
        								
        								
        							<table class="wp-travel-wrapper" style="color: #5d5d5d; font-family: Roboto, sans-serif; margin: auto;" width="100%" cellspacing="0" cellpadding="0">
        							<tbody>
        							<tr class="wp-travel-content" style="background: #fff;">
        							<td class="wp-travel-content-top" style="background: #fff; margin: 0; padding: 30px 25px;" colspan="2" align="left">
        								<table role="presentation" border="0" cellpadding="0" cellspacing="0" width="100%">
        								<tr>
        								<td class="logo" style="text-align: center;">
        								<img src="https://gauratravel.com.au/wp-content/uploads/2022/01/cropped-GauraTravel_logo_small_2.png" style="width:200px; text-align:center;"/>
        								</td>
        								</tr>
        								</table>
        							</td>
        							</tr>
        							<tr class="wp-travel-content" style="background: #fff;">
        							<td class="wp-travel-content-top" style="background: #fff; margin: 0; padding: 20px 25px;" colspan="2" align="left">
        							<p style="line-height: 1.55; font-size: 14px;">Hi,</p>
        							<p style="line-height: 1.55; font-size: 14px;">Thank you for providing the information.</p>
        							<p style="line-height: 1.55; font-size: 14px;"><b></b></p>
        							</td></tr>';
        							if($subject != '')
        							{
        								$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Subject: '.$subject.'</td></tr>';
        							}
        							if($reasonforcancellation != '')
        							{
        								$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Reason for cancellation: '.$reasonforcancellation.'</td></tr>';
        							}
        							if($order_number != '')
        							{
        								$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Reservation code/ Order ID: '.$order_number.'</td></tr>';
        							}	
        							if($reservationcode != '')
        							{
        								$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Reservation Code: '.$reservationcode.'</td></tr>';
        							}
        
        							if($airlinereservationcode != '')
        							{
        								$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Airline Reservation Code: '.$airlinereservationcode.'</td></tr>';
        							}
        							if($airline != '')
        							{
        								$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Airline: '.$airline.'</td></tr>';
        							}
        							if($traveldate != '')
        							{
        								$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Travel Date: '.$traveldate.'</td></tr>';
        							}
        							if($phonenumber != '')
        							{
        								$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Phone Number: '.$phonenumber.'</td></tr>';
        							}
        							if($accountname != '')
        							{
        								$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Account Name: '.$accountname.'</td></tr>';
        							}
        							if($bsb != '')
        							{
        								$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">BSB: '.$bsb.'</td></tr>';
        							}
        							if($accountnumber != '')
        							{
        								$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Account Number: '.$accountnumber.'</td></tr>';
        							}
        							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left"> </td></tr>';
        								
        							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">
        								We will get back to you within 48 hours of your submissions.</td></tr>';
        								
        							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
        								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 40px 25px;" colspan="2" align="left">
        								Thank you!</td></tr>';
        							$mailbody .=  '</tbody>
        							</table>
        							</div>
        							</center>
        							</body>
        							</html>';
        						$mailbody=stripslashes($mailbody);
        						$emailsubject="Request Submitted - Gaura Travel";  
        						$path = '';
        						$sentto = $emailid;
        						include('email/tpl_dispatch_userportal_emails.php');
        					
        						
        						echo '<script>alert("Thank you for submitting refund request. One representative will contact you soon.");</script>';
        						echo '<script>window.location.href="'.$current_url.'";</script>';
        					}
        					?>
        					<script src="https://cdn.jsdelivr.net/gh/alumuko/vanilla-datetimerange-picker@latest/dist/vanilla-datetimerange-picker.js"></script>
        					<script>
        						window.addEventListener("load", function (event) {
        							let drp = new DateRangePicker('traveldate',
        									{
        										
        										timePicker: false,
        										alwaysShowCalendars: true,
        										singleDatePicker: true,
        										autoApply: true,
        										autoUpdateInput: true,
        										
        										locale: {
        											format: "YYYY-MM-DD",
        										}
        									},
        									function (start) {
        										document.getElementById("traveldate").value = start.format();
        										
        									})
        							});
        						$('#add_pax').on('click', function() {
        						  $('#paxcontainer').append('<div class="paxbox" style="display:flex;"><div style="width:96%;"><input type="text" placeholder="Name of Passenger" required onkeypress="return isTextKey(event)" name="pax_name[]"></div><div><button type="button" class="remove">x</button></div></div>');
        						});
        
        						$('#paxcontainer').on('click', '.remove', function() {
        						  $(this).closest(".paxbox").remove();
        						});
        
        
        						$('#add_ticket').on('click', function() {
        						  $('#ticketcontainer').append('<div class="ticketbox" style="display:flex;"><div style="width:96%;"><input type="text" placeholder="Ticket Number" name="ticket_number[]"></div><div><button type="button" class="remove">x</button></div></div>');
        						});
        
        						$('#ticketcontainer').on('click', '.remove', function() {
        						  $(this).closest(".ticketbox").remove();
        						});
        					</script>
                                       </div>
                                        <div id="complaintform_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>" class="tabcontent" style="display:none;">
                                            <?php
                                            $order_id = $order_id_api;
                                             
                					?>
                						<style>
                						#otherissues, #otherissuesbreak  { display: none; }
                						</style>	
                							<h3>Complaint Submission Form</h3>
                							<p>We are unhappy to see you dissatisfied. Please elaborate more to make us try our best to resolve the matter.</p>
                						</br>
										<?php
											$username = $row['email_pax'];
											$phonepx = $row['phone_pax'];
										?>
                						<form action="#" method="post" id="complaintSubmitForm" enctype="multipart/form-data">
                							<p class='fieldnotelable'>Customer Name <font class='redstar'>*</font></p>
                							<input type='text' required onkeypress="return isTextKey(event)" name='customername' placeholder='Name' >
                								</br>
                							<p class='fieldnotelable'>Order ID <font class='redstar'>*</font></p>
                							<input type='text' required name='ordernumber' onkeypress="return isNumberKey(event)" value="<?php echo $order_id_api; ?>" <?php if($order_id_api != '') echo 'readonly'; ?> placeholder='Reservation Code/ Order ID' id='pnr' onblur="validatePNR()">
                								</br>
                							<p class='fieldnotelable'>Phone Number <font class='redstar'>*</font></p>
                							<input type='text' name='phonenumber' required id="phonenumber" onblur="validatePhoneNumber()" onkeypress="return isNumberKey(event)"  placeholder='Phone Number' value="<?php echo $phonepx; ?>"	>
                								</br>
                							<p class='fieldnotelable'>Email ID <font class='redstar'>*</font></p>
                							<input type='text' name='emailid' placeholder='E-mail' required <?php if($username != '') { echo 'readonly'; } ?> value='<?php echo $username; ?>'>
                								</br>
                							<p class='fieldnotelable'>Booking Ref# / Air Ticket Number (If created)</p>
                							<input type='text' name='bookingref' placeholder='Booking Ref# / Air Ticket Number (If created)' id='airline_pnr' onblur="validateAirlinePNR()">
                							<input type='hidden' name='flighttype' >
                								</br>
                							
                							<p class='fieldnotelable'>Complaint Type</p>
                							<select name='complainttype' id='complainttype' required style="width:100%; padding:10px; border-color: #dcd7ca;">
                							<option selected disabled value=''>Complaint Category</option>
                							<option value='Products or Services'>Products or Services</option>
                							<option value='Complaint Handling'>Complaint Handling</option>
                							<option value='Customer Service/Advice'>Customer Service/Advice</option>
                							<option value='Misleading Conduct'>Misleading Conduct</option>
                							<option value='Documentation'>Documentation</option>
                							<option value='Deposit / Pre-Payment / Cancellation'>Deposit / Pre-Payment / Cancellation</option>
                							<option value='Refunds'>Refunds</option>
                							<option value='Ticket / Itinerary'>Ticket / Itinerary</option>
                							<option value='Visa / Passport'>Visa / Passport</option>
                							<option value='Other, Please specify below'>Other, Please specify below</option>
                							</select>
                								</br></br>
                							<p class='fieldnotelable'>Airline</p>
                							<select name='airline' id='airline' style="width:100%; padding:10px; border-color: #dcd7ca;">
                							<option selected disabled value=''>Airline</option>
                							<option value='Air India'>Air India</option>
                							<option value='Cathay Pacific Airways'>Cathay Pacific Airways</option>
                							<option value='China Airlines'>China Airlines</option>
                							<option value='China Southern'>China Southern</option>
                							<option value='Emirates'>Emirates</option>
                							<option value='Etihad Airways'>Etihad Airways</option>
                							<option value='Garuda Indonesia'>Garuda Indonesia</option>
                							<option value='Jet Airways'>Jet Airways</option>
                							<option value='Malaysia Airlines'>Malaysia Airlines</option>
                							<option value='Qantas Airways'>Qantas Airways</option>
                							<option value='Qatar Airways'>Qatar Airways</option>
                							<option value='Saudi Arabian Airlines'>Saudi Arabian Airlines</option>
                							<option value='Scoot Airlines'>Scoot Airlines</option>
                							<option value='Singapore Airlines'>Singapore Airlines</option>
                							<option value='South African Airways'>South African Airways</option>
                							<option value='Srilankan Airlines'>Srilankan Airlines</option>
                							<option value='Thai Airways'>Thai Airways</option>
                							<option value='Vietnam Airlines'>Vietnam Airlines</option>
                							<option value='Air Asia'>Air Asia</option>
                							<option value='Others'>Others</option>
                							</select>
                								</br></br>
                								<p class='fieldnotelable'>Travel Date</p>
                							<input type='text' name='traveldate' id='traveldate' placeholder='Travel Date' value="<?php echo !empty($row['travel_date']) ? date('d/m/Y', strtotime($row['travel_date'])) : ''; ?>" >
                								</br>
                								<p class='fieldnotelable'>Agent Name</p>
                							<input type='text' name='agentname' onkeypress="return isTextKey(event)" placeholder='Agent Name'  >
                								</br>
                								<p class='fieldnotelable'>Other Issues</p>
                							<input type='text' name='otherissue' id='otherissues' onkeypress="return isTextKey(event)" placeholder='Other'  >
                								<div id='otherissuesbreak'></br></div>
                								<p class='fieldnotelable'>Please explain what makes you unhappy?</p>
                							<textarea placeholder='Please explain what makes you unhappy?' name='explanation'></textarea>
                								</br>
                								<p class='fieldnotelable'>Resolution or Outcome you are seeking?</p>
                							<textarea placeholder='Resolution or Outcome you are seeking?' name='expectedresponse'></textarea>
                							</br>
                							<hr>
                							<input type='file' name='inputfile' accept=".jpg,.jpeg,.png,.pdf" placeholder='Please provide any additional files if needed'  >
                							</br></br>
											<input type="checkbox" id="terms" required name="termsconditions" value="agreed"><label for="terms"> By clicking a submission button, <a target='_blank' href='https://gauratravel.com.au/terms-and-conditions/'>I agree to Consent *</a></label><br>
						
											</br></br>
                							<center><input type='submit' name='btn_book_pax_complaints' id='bookingForm' style="width: 200px; font-size: 25px;" onclick="if(this.form.checkValidity()){ this.style.pointerEvents='none'; this.style.opacity='0.6'; this.value='Processing...'; }" id='complaintSubmitBtn' class='btn btn-success' value='Submit'></center>
                							</form>
                
                							<script>
                							$(function(){
                								$('#complainttype').change(function(){
                								   var opt = $(this).val();
                									if(opt == 'Other, Please specify below'){
                										$('#otherissues').show();
                										$('#otherissuesbreak').show();
                									}else{
                										$('#otherissues').hide();
                										$('#otherissuesbreak').hide();
                									}
                								});
                							});
                							</script>
									
                						<?php
                						if(isset($_POST['btn_book_pax_complaints']))
                						{
                							$query_count = "SELECT * FROM wpk4_backend_user_portal_requests ORDER BY case_id DESC LIMIT 1";
                							$result_count = mysqli_query($mysqli, $query_count);
                							$row_count_assoc = mysqli_fetch_assoc($result_count);
                							$row_count = mysqli_num_rows($result_count);
                							if($row_count>0)
                							{
                								$case_id = intval($row_count_assoc['case_id']);
                								$case_id = $case_id+1;
                							}
                							else
                							{
                								$case_id = '1';
                							}
                							
                							$customername = $_POST['customername'];
                							$order_number = $_POST['ordernumber'];
                							$phonenumber = $_POST['phonenumber'];
                							$emailid = $_POST['emailid'];
                							$bookingref = $_POST['bookingref'];
                							$flighttype = $_POST['flighttype'];
                							if($_POST['complainttype'] == 'Other, Please specify below')
                							{
                								$complainttype = $_POST['otherissue'];
                							}
                							else
                							{
                								$complainttype = $_POST['complainttype'];
                							}
                							
                							$airline = ($_POST['airline'] ?? false)? $_POST['airline'] : '';
                							$traveldate = $_POST['traveldate'];
                							$agentname = $_POST['agentname'];
                							$explanation = $_POST['explanation'];
                							$expectedresponse = $_POST['expectedresponse'];
                							
                							
                							$fileName = $_FILES['inputfile']['name'];
                							if($_FILES['inputfile']['name'] != '')
                							{
                								$temp = explode(".", $fileName);
                								$ext = end($temp);
                								$filename_time = date('ymdHis');
                								$newfilename =  'complaint_'. $filename_time . '.' .$ext;
                							}
                							else
                							{
                								$newfilename = '';
                							}
                						
                							mysqli_query($mysqli,"insert into wpk4_backend_user_portal_requests (case_id, case_type, reservation_ref, last_response_by, last_response_on, is_seen_by_gt, user_id, status, case_date, priority) 
                							values ('$case_id','complaint','$order_number' ,'customer' ,'$current_date_time' ,'0' ,'$user_id' ,'open' ,'$current_date_time' ,'P4')") or die(mysqli_error($mysqli));
                							
                							$subject = 'Complaint '. $order_number;
                							
                							add_userportal_post_meta($case_id, 'subject', $subject);
                							add_userportal_post_meta($case_id, 'customer_name', $customername);
                							add_userportal_post_meta($case_id, 'phone_number', $phonenumber);
                							add_userportal_post_meta($case_id, 'email_address', $emailid);
                							add_userportal_post_meta($case_id, 'booking_ref', $bookingref);
                							add_userportal_post_meta($case_id, 'flight_type', $flighttype);
                							add_userportal_post_meta($case_id, 'complaint_type', $complainttype);
                							add_userportal_post_meta($case_id, 'airline', $airline);
                							add_userportal_post_meta($case_id, 'travel_date', $traveldate);
                							add_userportal_post_meta($case_id, 'agent', $agentname);
                							add_userportal_post_meta($case_id, 'explanation', $explanation);
                							add_userportal_post_meta($case_id, 'outcome_expected', $expectedresponse);
                							add_userportal_post_meta($case_id, 'attachment', $newfilename);
                
                							if($_FILES['inputfile']['name'] != '')
                								{
                									$currentDirectory = getcwd();
                									$uploadDirectory = "wp-content/uploads/customized_function_uploads/";
                									
                									$errors = []; // Store errors here
                									$fileExtensionsAllowed = ['jpeg','jpg','png','pdf','JPEG','JPG','PNG','PDF']; // These will be the only file extensions allowed 
                									
                									$fileSize = $_FILES['inputfile']['size'];
                									$fileTmpName  = $_FILES['inputfile']['tmp_name'];
                									$fileType = $_FILES['inputfile']['type'];
                									$fileExtension_explode = explode('.',$fileType);
                									$fileExtension = strtolower(end($fileExtension_explode));
                									$uploadPath = $uploadDirectory . basename($newfilename); 
                								
                									if (! in_array($fileExtension,$fileExtensionsAllowed)) 
                									{
                										$errors[] = "This file extension is not allowed. Please upload a JPEG, PNG or PDF file";
                									}
                									if ($fileSize > 4000000) {
                										$errors[] = "File exceeds maximum size (4MB)";
                									}
                									if (empty($errors)) 
                									{
                											$didUpload = move_uploaded_file($fileTmpName, $uploadPath);
                										if ($didUpload) {
                											//echo "The file " . basename($fileName) . " has been uploaded";
                										} else {
                											//echo "An error occurred. Please contact the administrator.";
                										}
                									}
                									else
                									{
                										foreach ($errors as $error) {
                										  echo $error . "These are the errors" . "\n";
                										}
                									}
                								}                						 
                						 $mailbody= '<!DOCTYPE html>
                						<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office">
                						<head>
                						<meta charset="utf-8"> <!-- utf-8 works for most cases -->
                						<meta name="viewport" content="width=device-width"> <!-- Forcing initial-scale shouldnt be necessary -->
                						<meta http-equiv="X-UA-Compatible" content="IE=edge"> <!-- Use the latest (edge) version of IE rendering engine -->
                						<meta name="x-apple-disable-message-reformatting">  <!-- Disable auto-scale in iOS 10 Mail entirely -->
                						<title></title> <!-- The title tag shows in email notifications, like Android 4.4. -->
                
                						<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
                
                						<!-- CSS Reset : BEGIN -->
                						<style>
                						/* What it does: Stops email clients resizing small text. */
                						* {
                							-ms-text-size-adjust: 100%;
                							-webkit-text-size-adjust: 100%;
                						}
                
                						/* What it does: Centers email on Android 4.4 */
                						div[style*="margin: 16px 0"] {
                							margin: 0 !important;
                						}
                
                						/* What it does: Stops Outlook from adding extra spacing to tables. */
                						table,
                						td {
                							mso-table-lspace: 0pt !important;
                							mso-table-rspace: 0pt !important;
                						}
                
                						/* What it does: Fixes webkit padding issue. */
                						table {
                							border-spacing: 0 !important;
                							border-collapse: collapse !important;
                							table-layout: fixed !important;
                							margin: 0 auto !important;
                						}
                
                						/* What it does: Prevents Windows 10 Mail from underlining links despite inline CSS. Styles for underlined links should be inline. */
                						a {
                							text-decoration: none;
                							color: #30e3ca;
                						}
                
                						h1,h2,h3,h4,h5,h6{
                							font-family: "Lato", sans-serif;
                							color: #000000;
                							margin-top: 0;
                							font-weight: 400;
                						}
                
                						body{
                							font-family: "Lato", sans-serif;
                							font-weight: 400;
                							font-size: 13px;
                							line-height: 1.8;
                							color: rgba(0,0,0,.4);
                						}
                
                						.hero .text{
                							color: rgba(0,0,0,.3);
                						}
                						.hero .text h2{
                							color: #000;
                							font-size: 20px;
                							margin-bottom: 0;
                							font-weight: 400;
                							line-height: 1.4;
                						}
                						.hero .text h3{
                							font-size: 17px;
                							font-weight: 300;
                						}
                						.hero .text h2 span{
                							font-weight: 600;
                							color: #30e3ca;
                						}
                
                
                						ul.social{
                							padding: 0;
                						}
                						ul.social li{
                							display: inline-block;
                							margin-right: 10px;
                						}
                						</style>
                
                
                						</head>
                						<body width="100%" style="margin: 0; padding: 0 !important; mso-line-height-rule: exactly; background-color: #f1f1f1;">
                							<center style="width: 100%; background-color: #f1f1f1;">
                							<div style="display: none; font-size: 1px;max-height: 0px; max-width: 0px; opacity: 0; overflow: hidden; mso-hide: all; font-family: sans-serif;">
                							  &zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;
                							</div>
                							<div style="max-width: 600px; margin: 0 auto;" class="email-container">
                							
                							
                						<table class="wp-travel-wrapper" style="color: #5d5d5d; font-family: Roboto, sans-serif; margin: auto;" width="100%" cellspacing="0" cellpadding="0">
                						<tbody>
                						<tr class="wp-travel-content" style="background: #fff;">
                						<td class="wp-travel-content-top" style="background: #fff; margin: 0; padding: 30px 25px;" colspan="2" align="left">
                							<table role="presentation" border="0" cellpadding="0" cellspacing="0" width="100%">
                							<tr>
                							<td class="logo" style="text-align: center;">
                							<img src="https://gauratravel.com.au/wp-content/uploads/2022/01/cropped-GauraTravel_logo_small_2.png" style="width:200px; text-align:center;"/>
                							</td>
                							</tr>
                							</table>
                						</td>
                						</tr>
                						<tr class="wp-travel-content" style="background: #fff;">
                						<td class="wp-travel-content-top" style="background: #fff; margin: 0; padding: 20px 25px;" colspan="2" align="left">
                						<p style="line-height: 1.55; font-size: 14px;">Hi,</p>
                						<p style="line-height: 1.55; font-size: 14px;">Thank you for providing the information.</p>
                						<p style="line-height: 1.55; font-size: 14px;"><b></b></p>
                						</td></tr>';
                						if($order_number != '')
                						{
                							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Reservation Code/Order ID: '.$order_number.'</td></tr>';
                						}
                						if($bookingref != '')
                						{
                							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Booking Ref: '.$bookingref.'</td></tr>';
                						}
                						if($flighttype != '')
                						{
                							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Flight Type: '.$flighttype.'</td></tr>';
                						}	
                						if($complainttype != '')
                						{
                							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Complaint Type: '.$complainttype.'</td></tr>';
                						}
                						if($airline != '')
                						{
                							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Airline: '.$airline.'</td></tr>';
                						}
                						if($traveldate != '')
                						{
                							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Travel Date: '.$traveldate.'</td></tr>';
                						}
                						if($agentname != '')
                						{
                							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Agent Name: '.$agentname.'</td></tr>';
                						}
                						if($explanation != '')
                						{
                							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">'.$explanation.'</td></tr>';
                						}
                						if($expectedresponse != '')
                						{
                							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">'.$expectedresponse.'</td></tr>';
                						}
                						$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left"> </td></tr>';
                							
                						$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">
                							We will get back to you within 48 hours of your submissions.</td></tr>';
                							
                						$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 40px 25px;" colspan="2" align="left">
                							Thank you. </td></tr>';
                							
                						$mailbody .=  '</tbody>
                						</table>
                						</div>
                						</center>
                						</body>
                						</html>';
                						
                						$mailbody=stripslashes($mailbody);
                						$emailsubject="Request Submitted - Gaura Travel";  
                						$path = '';
                						$sentto = $emailid;
                						include('email/tpl_dispatch_userportal_emails.php');
                						 
                						 
                						echo '<script>alert("Thank you for your submission.");</script>';
                						echo '<script>window.location.href="'.$current_url.'";</script>';
                						}
                						?>
                					
                							<script src="https://cdn.jsdelivr.net/gh/alumuko/vanilla-datetimerange-picker@latest/dist/vanilla-datetimerange-picker.js"></script>
                							<script>
                							window.addEventListener("load", function (event) {
                									let drp = new DateRangePicker('traveldate',
                											{
                												
                												timePicker: false,
                												alwaysShowCalendars: true,
                												singleDatePicker: true,
                												autoApply: true,
                												autoUpdateInput: true,
                												
                												locale: {
                													format: "YYYY-MM-DD",
                												}
                											},
                											function (start) {
                												document.getElementById("traveldate").value = start.format();
                												
                											})
                									});
                									
                
                							</script>	
                                        </div>
                                        <div id="eticketdownload_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>" class="tabcontent" style="display:none;">
                        				    <?php
                        				    $filePath = '';
                        				    $order_id = $order_id_api;
                                        		$query_select_order_email = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' order by auto_id limit 1";
                                        		$result_select_order_email = mysqli_query($mysqli, $query_select_order_email);
                                        		$row_select_order_email = mysqli_fetch_assoc($result_select_order_email);
                                        		$customer_email = $row_select_order_email['email_pax'];
                                        		
                                        		$query_select_order_status = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api'";
                                        		$result_select_order_status = mysqli_query($mysqli, $query_select_order_status);
                                        		$row_select_order_status = mysqli_fetch_assoc($result_select_order_status);
                                        		$order_payment_status = $row_select_order_status['payment_status'];
                                        		
                                        		$query_count_bookingemail = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='Booking Email' order by auto_id desc limit 1";
                                        		$result_count_bookingemail = mysqli_query($mysqli, $query_count_bookingemail);
                                        		$row_count_bookingemail = mysqli_num_rows($result_count_bookingemail);
                                        		$row_bookingemail = mysqli_fetch_assoc($result_count_bookingemail);
                                        		if($row_count_bookingemail==0)
                                        		{
                                        			$is_bookingemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_bookingemail_sent[]" value="'.$order_id_api.'">';
                                        			$bookingemail_sent_on = '';
                                        		}
                                        		else
                                        		{
                                        			$is_bookingemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_bookingemail_sent[]" value="'.$order_id_api.'">';
                                        			$bookingemail_sent_on = ' on '.$row_bookingemail['initiated_date'];
                                        		}
                                        		$query_count_mhpplemail = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='MH PPL Voucher' order by auto_id desc limit 1";
                                        		$result_count_mhpplemail = mysqli_query($mysqli, $query_count_mhpplemail);
                                        		$row_count_mhpplemail = mysqli_num_rows($result_count_mhpplemail);
                                        		$row_mhpplemail = mysqli_fetch_assoc($result_count_mhpplemail);
                                        		if($row_count_mhpplemail==0)
                                        		{
                                        			$is_mhpplemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_itineraryemail_sent[]" value="'.$order_id_api.'">';
                                        			$mhppl_sent_on = '';
                                        		}
                                        		else
                                        		{
                                        			$is_mhpplemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_itineraryemail_sent[]" value="'.$order_id.'">';
                                        			$mhppl_sent_on = ' on '.$row_mhpplemail['initiated_date'];
                                        		}
                                        		$query_count_itineraryemail = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='Itinerary Email' order by auto_id desc limit 1";
                                        		$result_count_itineraryemail = mysqli_query($mysqli, $query_count_itineraryemail);
                                        		$row_count_itineraryemail = mysqli_num_rows($result_count_itineraryemail);
                                        		$row_itineraryemail = mysqli_fetch_assoc($result_count_itineraryemail);
                                        		if($row_count_itineraryemail==0)
                                        		{
                                        			$is_itineraryemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_itineraryemail_sent[]" value="'.$order_id_api.'">';
                                        			$itineraryemail_sent_on = '';
                                        		}
                                        		else
                                        		{
                                        			$is_itineraryemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_itineraryemail_sent[]" value="'.$order_id.'">';
                                        			$itineraryemail_sent_on = ' on '.$row_itineraryemail['initiated_date'];
                                        		}	
                                        		
                                        		$query_count_taxinvoice = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='Tax Invoice' order by auto_id desc limit 1";
                                        		$result_count_taxinvoice = mysqli_query($mysqli, $query_count_taxinvoice);
                                        		$row_count_taxinvoice = mysqli_num_rows($result_count_taxinvoice);
                                        		$row_taxinvoice = mysqli_fetch_assoc($result_count_taxinvoice);
                                        		if($row_count_taxinvoice==0)
                                        		{
                                        			$is_tax_invoice_sent = '<input type="checkbox" onclick="return false;" id="inv" name="is_tax_invoice_sent[]" value="'.$order_id_api.'">'; $tax_invoice_sent_on = '';
                                        		}
                                        		else
                                        		{
                                        			$is_tax_invoice_sent = '<input type="checkbox" checked onclick="return false;" id="inv" name="is_tax_invoice_sent[]" value="'.$order_id_api.'">'; 
                                        			$tax_invoice_sent_on = ' on '.$row_taxinvoice['initiated_date'];
                                        		}
                                        		
                                        		$query_count_payment_update = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='Payment Update' order by auto_id desc limit 1";
                                        		$result_count_payment_update = mysqli_query($mysqli, $query_count_payment_update);
                                        		$row_count_payment_update = mysqli_num_rows($result_count_payment_update);
                                        		$row_paymentupdate = mysqli_fetch_assoc($result_count_payment_update);
                                        		if($row_count_payment_update==0)
                                        		{
                                        			$is_payment_update_sent = '<input type="checkbox" onclick="return false;" id="pay" name="is_payment_update_sent[]" value="'.$order_id_api.'">'; $payment_update_sent_on = '';
                                        		}
                                        		else
                                        		{
                                        			$is_payment_update_sent = '<input type="checkbox" checked onclick="return false;" id="pay" name="is_payment_update_sent[]" value="'.$order_id_api.'">'; 
                                        			$payment_update_sent_on = ' on '.$row_paymentupdate['initiated_date'];
                                        		}
                                        		
                                        		$query_count_eticket_update = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='Eticket Email' order by auto_id desc limit 1";
                                        		$result_count_eticket_update = mysqli_query($mysqli, $query_count_eticket_update);
                                        		$row_count_eticket_update = mysqli_num_rows($result_count_eticket_update);
                                        		$row_eticketupdate = mysqli_fetch_assoc($result_count_eticket_update);
                                        		if($row_count_eticket_update==0)
                                        		{
                                        			$is_eticket_update_sent = '<input type="checkbox" onclick="return false;" id="pay" name="is_payment_update_sent[]" value="'.$order_id_api.'">'; $eticket_update_sent_on = '';
                                        		}
                                        		else
                                        		{
                                        			$is_eticket_update_sent = '<input type="checkbox" checked onclick="return false;" id="pay" name="is_payment_update_sent[]" value="'.$order_id_api.'">'; 
                                        			$eticket_update_sent_on = ' on '.$row_eticketupdate['initiated_date'];
                                        		}
                                        		?>
                                        			<table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
                                        			
                                            			<?php
                                            			$query_pax_eticket_ = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api' ";
                                                		$result_pax_eticket_ = mysqli_query($mysqli, $query_pax_eticket_);
                                            			while($row_pax_eticket_ = mysqli_fetch_assoc($result_pax_eticket_))
                                                		{
                                                		    $order_id_ticketing = $row_pax_eticket_['order_id'];
                                                		    $product_id_ticketing = $row_pax_eticket_['product_id'];
                                                		    $tripcode_ticketing = $row_pax_eticket_['trip_code'];

                                                			$query_pax_eticket_loop = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' and product_id = '$product_id_ticketing' ";
                                                    		$result_pax_eticket_loop = mysqli_query($mysqli, $query_pax_eticket_loop);
                                                    		$row_pax_eticket_loop_count = mysqli_num_rows($result_pax_eticket_loop);
                                                			?>
                                            			    <tr>
                                            				<td rowspan = '<?php echo $row_pax_eticket_loop_count; ?>'><b><?php echo $tripcode_ticketing; ?></b> </br> Eticket Email</td>
                                            				<?php
                                            				$loop_count_pax = 0;
                                            				while($row_pax_eticket_loop = mysqli_fetch_assoc($result_pax_eticket_loop))
                                                		    {
                                                		        $loop_count_pax ++;
                                                		        $pax_id = $row_pax_eticket_loop['auto_id'];
                                                		        ?>
                                                		        <td>
                                                		            <?php echo $row_pax_eticket_loop['fname']; ?> <?php echo $row_pax_eticket_loop['lname']; ?>
                                                		        </td>
                                                				<td>
                                                					<form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                                        				    <input type='hidden' name='productidnew' value="<?php echo $product_id_ticketing; ?>" >
                                                    						<input type='submit' style='padding:15px; margin:0;font-size:11px;' name='sent_bulk_eticket_email_v2' value='Download Eticket'>
                                                    			        </form>
                                                				</td>
                                            				    <?php
                                            				    echo '</tr>';
                    		                                    }
                        		                                ?>
                                                			</tr>
                                            			<?php
                                                		}
                                            			?>        				                                
                                        			</table>
                                                    <?php
                                        			$today_date = date("Y-m-d H:i:s");
                                        			
                                            		$query_pax_eticket_loop = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api'";
                                                	$result_pax_eticket_loop = mysqli_query($mysqli, $query_pax_eticket_loop);
                                                	$row_pax_eticket_loop_count = mysqli_num_rows($result_pax_eticket_loop);
                                            		while($row_pax_eticket_loop = mysqli_fetch_assoc($result_pax_eticket_loop))
                    		                        {
                    		                            $pax_id = $row_pax_eticket_loop['auto_id'];
                    		                            ?>
                    		                            <div id="email_eticketPreview_<?php echo $order_id_api; ?><?php echo $pax_id; ?>" style="display: none;">
                                                            <?php
                                                    		$emailsubject = "Eticket Information - ".$order_id_api;
                                                            include(get_template_directory().'/templates/email/tpl_email_eticket_preview.php');
                                                            ?>
                                                        </div>
                    		                            <?php
                    		                        }
                    		                        ?>
                                                    <?php
                                            		$query_pax_eticket_loop = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api'";
                                                	$result_pax_eticket_loop = mysqli_query($mysqli, $query_pax_eticket_loop);
                                                	$row_pax_eticket_loop_count = mysqli_num_rows($result_pax_eticket_loop);
                                            		while($row_pax_eticket_loop = mysqli_fetch_assoc($result_pax_eticket_loop))
                    		                        {
                    		                            $pax_id = $row_pax_eticket_loop['auto_id'];
                    		                            ?>
                    		                            <script>
                    		                                document.getElementById("toggleButton_email_eticket_<?php echo $order_id_api; ?><?php echo $pax_id; ?>").addEventListener("click", function() {
                                                              var myDiv_payment = document.getElementById("email_eticketPreview_<?php echo $order_id_api; ?><?php echo $pax_id; ?>");
                                                              if (myDiv_payment.style.display === "none") {
                                                                myDiv_payment.style.display = "block";
                                                                this.textContent = "Hide Preview";
                                                              } else {
                                                                myDiv_payment.style.display = "none";
                                                                this.textContent = "Show Preview";
                                                              }
                                                            });
                    		                            </script>
                    		                            <?php
                    		                        }
                    		                        ?>    
                    		                        <script>
                                            		    document.getElementById("toggleButton_email_itinerary_<?php echo $order_id_api; ?>").addEventListener("click", function() {
                                                          var myDiv_itinerary = document.getElementById("email_itineraryPreview_<?php echo $order_id_api; ?>");
                                                          if (myDiv_itinerary.style.display === "none") {
                                                            myDiv_itinerary.style.display = "block";
                                                            this.textContent = "Hide Preview";
                                                          } else {
                                                            myDiv_itinerary.style.display = "none";
                                                            this.textContent = "Show Preview";
                                                          }
                                                        });
                                                        
                                                        document.getElementById("toggleButton_email_payment_<?php echo $order_id_api; ?>").addEventListener("click", function() {
                                                          var myDiv_payment = document.getElementById("email_paymentPreview_<?php echo $order_id_api; ?>");
                                                          if (myDiv_payment.style.display === "none") {
                                                            myDiv_payment.style.display = "block";
                                                            this.textContent = "Hide Preview";
                                                          } else {
                                                            myDiv_payment.style.display = "none";
                                                            this.textContent = "Show Preview";
                                                          }
                                                        });
                                                       function confirmSubmit() {
                                                        var confirmed = confirm("Do you want to submit the form?");
                                                        return confirmed;
                                                      }
                                                    </script>
                                            		<?php
                                            		$themepath = get_stylesheet_directory_uri();
                                                    $themepath = str_replace("https://gauratravel.com.au/","",$themepath);
                                                    
                                                    if(isset($_POST['sent_itinerary_email']))
                                            		{
                                            			$today_date = date("Y-m-d H:i:s");
                                            			
                                            			if($order_type_itinerary == 'WPT' || $order_type_itinerary == '')
                				                        {
                				                            $emailsubject = "Itinerary Information - ".$order_id_api;
                                            			    include(get_template_directory().'/templates/email/tpl_email_itinerary.php');
                				                        }
                				                        else if($order_type_itinerary == 'gds')
                				                        {
                				                            $query_pax_lead_traveller = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' order by auto_id asc limit 1";
                                                    		$result_pax_lead_traveller = mysqli_query($mysqli, $query_pax_lead_traveller);
                                                    		$row_pax_lead_traveller = mysqli_fetch_assoc($result_pax_lead_traveller);
                                                                $pnr_for_email = $row_pax_lead_traveller['pnr'];
                    
                				                            $emailsubject = "Itinerary Information - ".$pnr_for_email;
                                            			    include(get_template_directory().'/templates/email/tpl_email_itinerary_gds.php');
                				                        }
                				                        else
                				                        {
                				                            echo 'No system email found';
                				                        }
                				                        
                                            			global $wpdb;
                                            			$email_subject = 'Itinerary Information';
                                            			$wpdb->insert('wpk4_backend_order_email_history', array(
                                                            'email_type' =>'Itinerary Email',
                                                            'order_id' =>$order_id_api,
                                                            'email_address' => $customer_email,
                                                            'initiated_date' => $today_date,
                                            				'initiated_by' => 'customer',
                                                            'email_subject' => $email_subject,
                                                        ));
                                                        $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                            			echo '<script>window.location.href="'.$current_url.'";</script>';
                                            		}
                                                    if(isset($_POST['download_itinerary_email']))
                                            		{
                                            			$today_date = date("Y-m-d H:i:s");
                                            			
                                            			if($order_type_itinerary == 'WPT' || $order_type_itinerary == '')
                				                        {
                				                            $emailsubject = "Itinerary Information - ".$order_id_api;
                                            			    include(get_template_directory().'/templates/email/tpl_download_itinerary.php');
                				                        }
                				                        else if($order_type_itinerary == 'gds')
                				                        {
                				                            $query_pax_lead_traveller = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' order by auto_id asc limit 1";
                                                    		$result_pax_lead_traveller = mysqli_query($mysqli, $query_pax_lead_traveller);
                                                    		$row_pax_lead_traveller = mysqli_fetch_assoc($result_pax_lead_traveller);
                                                                $pnr_for_email = $row_pax_lead_traveller['pnr'];
                    
                				                            $emailsubject = "Itinerary Information - ".$pnr_for_email;
                                            			    include(get_template_directory().'/templates/email/tpl_download_itinerary_gds.php');
                				                        }
                				                        else
                				                        {
                				                            echo 'No itinerary found';
                				                        }
                				                        
                                            			global $wpdb;
                                            			$email_subject = 'Itinerary Information';
                                            			$wpdb->insert('wpk4_backend_order_email_history', array(
                                                            'email_type' =>'Itinerary Email',
                                                            'order_id' =>$order_id_api,
                                                            'email_address' => $customer_email,
                                                            'initiated_date' => $today_date,
                                            				'initiated_by' => 'customer',
                                                            'email_subject' => $email_subject,
                                                        ));
                                                        $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                            		}
                                            		
                                            		
                                            		if(isset($_POST['sent_bulk_eticket_email_v2']))
                                            		{
                                            			$today_date = date("Y-m-d H:i:s");
                                            			
                                            			$product_id_for_limit_loop = $_POST['productidnew'];
                                            			$order_id = $order_id_api;
                                            			$email_subject = 'Eticket';
                                            			include(get_template_directory().'/templates/email/tpl_download_eticket_bulk_v2.php');
                                            			global $wpdb;
                                            			$wpdb->insert('wpk4_backend_order_email_history', array(
                                                            'email_type' =>'Eticket Email',
                                                            'order_id' =>$order_id,
                                                            'email_address' => $customer_email,
                                                            'initiated_date' => $today_date,
                                            				'initiated_by' => 'customer',
                                                            'email_subject' => $email_subject,
                                                        ));
                                                        $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                            			echo '<script>window.location.href="'.$current_url.'";</script>';
                                            		}
                                            ?>
                        				</div>
                        				</div>
                        			    <?php
                        			    echo '<hr>';
                    		        }
                    		        else
                    		        {
                    		            throw new Exception("Login user is not authorized to check this booking. ".$email_pax_checkup . " - ". $emailid);
                    		        }
                        		}
            				}
            				else 
            				{
                                throw new Exception("No records found. Please try again later.");
                            }
    				    }
    				    catch (Exception $e) {
                            echo "<p>Error occured. Kindly try again later.</p>";
                        }
                	}
                	else
                	{
                		echo 'Kindly proceed with correct OrderID';
                	}
				}
				
				if( isset($_GET['p']) && $_GET['p'] =='make-deposit' && isset($_GET['orderID']) && $_GET['orderID'] != '' ) //customer - make deposit with asiapay
				{
				    // Check if this is an AJAX request to fetch session data
                    if (isset($_POST['action']) && $_POST['action'] === 'fetch_session_data_customerportal') {
                        // Handle the AJAX request
                        if (isset($_SESSION['payment_status']) && $_SESSION['payment_status'] === 'success') {
                            $response = array(
                                'status' => 'success',
                                'data' => $_SESSION['payment_status'],
                                'reference' => $_SESSION['payment_status'] // Include reference if needed
                            );
                        } elseif (isset($_SESSION['payment_status']) && $_SESSION['payment_status'] === 'failed') {
                            $response = array(
                                'status' => 'failed',
                                'data' => $_SESSION['payment_status']
                            );
                        } else {
                            $response = array(
                                'status' => 'no_data',
                                'data' => null
                            );
                        }
                        header('Content-Type: application/json');
                        echo json_encode($response);
                        exit;
                    }

				    function generatePaymentSecureHash($merchantId, $merchantReferenceNumber, $currencyCode, $amount, $paymentType, $secureHashSecret) 
                    {
                		$buffer = $merchantId . '|' . $merchantReferenceNumber . '|' . $currencyCode . '|' . $amount . '|' . $paymentType . '|' . $secureHashSecret;
                		return sha1($buffer);
                	}
                
                	function verifyPaymentDatafeed($src, $prc, $successCode, $merchantReferenceNumber, $paydollarReferenceNumber, $currencyCode, $amount, $payerAuthenticationStatus, $secureHashSecret, $secureHash) 
                	{
                		$buffer = $src . '|' . $prc . '|' . $successCode . '|' . $merchantReferenceNumber . '|' . $paydollarReferenceNumber . '|' . $currencyCode . '|' . $amount . '|' . $payerAuthenticationStatus . '|' . $secureHashSecret;
                		$verifyData = sha1($buffer);
                		if ($secureHash == $verifyData) {
                			return true;
                		}
                		return false;
                	}
                	
                	if ( ctype_digit($_GET['orderID']) && strlen($_GET['orderID']) <= 7 ) 
                	{
                        $orderType = 'WPT';
                    } 
                    elseif (ctype_alpha($_GET['orderID'])) 
                    {
                        $orderType = 'gds';
                    } 
                    else 
                    {
                        $orderType = 'gds';
                    }
                    
                	if($orderType == 'WPT')
                	{
                        $merchantId='16001455'; // live
                        
                        $secureHashSecret = 'kYLMLkdK8IMMgMuYOqaTgij9PbBROMHP'; // live
                	}
                	else
                	{
                        $merchantId='16001202'; // live
                        
                        $secureHashSecret = 'lAsNDUJ73S6FE62bB4Ael9IqPpiy28r9'; // live
                	}
                	
                	$microtime = sprintf('%.0f', microtime(true) * 1000);
                    $orderRef = uniqid().bin2hex(random_bytes(4)).$microtime;
                    
                    $org_order_id = $_GET['orderID'];
                    
                    $orderRef = $_GET['orderID'].$microtime;
                    $payment_partial_value = '';
                    $query_payments_postmeta = "SELECT meta_value FROM wpk4_postmeta where post_id='$org_order_id' && meta_key='order_totals'";
                    $result_payments_postmeta = mysqli_query($mysqli, $query_payments_postmeta);
                    if(mysqli_num_rows($result_payments_postmeta) > 0)
                    {
                        $row_postmeta = mysqli_fetch_assoc($result_payments_postmeta);
                        $order_total_amount = $row_postmeta['meta_value'];
                        
                        $orderData = unserialize($order_total_amount);
                                    
                        $payment_partial_value = $orderData['total_partial'];
                    }
                    if($payment_partial_value == '')
                    {
                        $query_payment_amount = "SELECT total_amount, total_pax FROM wpk4_backend_travel_bookings where order_id='$org_order_id'";
                    	$result_payment_amount = mysqli_query($mysqli, $query_payment_amount);
                    	$row_payment_amount = mysqli_fetch_assoc($result_payment_amount);
                    	//$payment_partial_value = $row_payment_amount['total_amount'] * 0.05;
														
						$payment_partial_value = (int)$row_payment_amount['total_pax'] * 5;
                    }
                    
                    $currCode = '036';
                    $paymentType = 'N';
                    $mpsMode = "NIL";
                    $payMethod = "ALL";
                    $lang = "E";
                    $amount = number_format((float)$payment_partial_value, 2, '.', '');
                    $successUrl = "https://gauratravel.com.au/customer-portal-deposit-success/";//success
                    $failUrl = "https://gauratravel.com.au/customer-portal-deposit-failed/";//failed
                    $cancelUrl="https://gauratravel.com.au/";
                    
                    $secureHash = generatePaymentSecureHash($merchantId, $orderRef, $currCode, $amount, $paymentType, $secureHashSecret); // $secureHash
    
                    ?>
                    <script>
                        openAsiaPayPopup();
                        function openAsiaPayPopup() 
                        {
                            // https://www.paydollar.com/b2c2/eng/payment/payForm.jsp  // live
                            window.location.href = 'https://www.paydollar.com/b2c2/eng/payment/payForm.jsp?merchantId=<?php echo $merchantId; ?>&amount=<?php echo $amount; ?>&orderRef=<?php echo $orderRef; ?>&currCode=<?php echo $currCode; ?>&successUrl=<?php echo $successUrl; ?>&failUrl=<?php echo $failUrl; ?>&cancelUrl=<?php echo $cancelUrl; ?>&payType=<?php echo $paymentType; ?>&lang=<?php echo $lang; ?>&mpsMode=<?php echo $mpsMode; ?>&payMethod=<?php echo $payMethod; ?>&secureHash=<?php echo $secureHash; ?>&redirect=0';
                        }
                        
                        let paymentStatusInterval;
                        function fetchSessionDataCs() 
                        {
                            $.ajax({
                                url: '', // Same file for AJAX
                                method: 'POST',
                                dataType: 'json',
                                data: {
                                    action: 'fetch_session_data_customerportal' // Specify the action
                                },
                                success: function(response) {
                                    if (response.status === "success") {
                                        clearInterval(paymentStatusInterval); // Stop polling
                                        const currentUrl = new URL(window.location.href);
                                        const queryParams = new URLSearchParams(currentUrl.search);
                        
                                        // Replace 'p=make-deposit' with 'p=booking'
                                        if (queryParams.has('p') && queryParams.get('p') === 'make-deposit') {
                                            queryParams.set('p', 'booking');
                                        }
                        
                                        window.location.href = "?" + queryParams.toString();
                                    } else if (response.status === "failed") {
                                        // Optional: Handle failure case, e.g., show a message
                                        clearInterval(paymentStatusInterval); // Stop polling
                                        alert("Payment failed. Please try again.");
                                    }
                                },
                                error: function(xhr, status, error) {
                                    console.error("Error fetching session data:", error);
                                }
                            });
                        }
                        $(document).ready(function() {
                            paymentStatusInterval = setInterval(fetchSessionDataCs, 2000); // Poll every 2 seconds
                        });
                    </script>
                    <?php
				}
				
				if(isset($_GET['p']) && $_GET['p'] =='my-profiles') 
				{
				    ?>
				    <style>
				        .vc_col-sm-8
				        {
				            width:70%;
				        }
				        .vc_col-sm-4
				        {
				            width:30%;
				        }
				    </style>
				    <?php
				    $query_pax = "SELECT * FROM wpk4_customer_accounts where uid = '$user_id'";
					$result_pax = mysqli_query($mysqli, $query_pax);
					$query_px = mysqli_fetch_assoc($result_pax);
					$trav_date = date("Y-m-d H:i:s");
					$fullname = $query_px['full_name'];
					$emailid = $query_px['email'];
					if($query_px['phonenumber'] != '')
					{
						$user_phonenumber = $query_px['phonenumber'];
					}
					else
					{
						$user_phonenumber = '0123456789012345';
					}

					$query_bookings = "SELECT * 
    					FROM wpk4_backend_travel_passenger passenger 
    					where passenger.email_address='$emailid'";
    				$result_bookings = mysqli_query($mysqli, $query_bookings);
    				$row_bookings = mysqli_fetch_assoc($result_bookings);
    				$family_id = $row_bookings['family_id'];
    				
    				$query_bookings2 = "SELECT * 
    					FROM wpk4_backend_travel_passenger passenger 
    					where passenger.family_id='$family_id'";
    				$result_bookings2 = mysqli_query($mysqli, $query_bookings2);
    				?>
    				<table class="table table-striped accounts_general_table">
    					<thead>
        					<tr>
            					<th>Full Name</th>
            					<th>Email</th>
            					<th>DOB</th>
            					<th>Gender</th>
        				    </tr>
        				</thead>
    				    <tbody>
        				<?php
    					
    					while($row_bookings2 = mysqli_fetch_assoc($result_bookings2))
    					{
        					?>
        		            <tr>
                				<td><?php echo $row_bookings2['salutation']; ?> <?php echo $row_bookings2['fname']; ?> <?php echo $row_bookings2['lname']; ?></td>
                				<td><?php echo $row_bookings2['email_address']; ?></td>
                				<td><?php echo $row_bookings2['dob']; ?></td>
                				<td><?php echo $row_bookings2['gender']; ?></td>
                				<td>
                				    <a href="?p=view-profile&editprofile=996bd20996bd20ad8fc325954e6d1d63fc06fb7996bd20ad8fc996bdfc06fb7&i=<?php echo $row_bookings2['customer_id']; ?>&eda=9966bd20ad8fc325954e6d16bd20ad8fc325954e6d0ad8fc6f&f=<?php echo $row_bookings2['family_id']; ?>">View</a>
                				    <a href="?p=edit-profile&editprofile=996bd20996bd20ad8fc325954e6d1d63fc06fb7996bd20ad8fc996bdfc06fb7&i=<?php echo $row_bookings2['customer_id']; ?>&eda=9966bd20ad8fc325954e6d16bd20ad8fc325954e6d0ad8fc6f&f=<?php echo $row_bookings2['family_id']; ?>">Edit</a>
                				    <a href="?p=delete-profile&editprofile=996bd20996bd20ad8fc325954e6d1d63fc06fb7996bd20ad8fc996bdfc06fb7&i=<?php echo $row_bookings2['customer_id']; ?>&eda=9966bd20ad8fc325954e6d16bd20ad8fc325954e6d0ad8fc6f&f=<?php echo $row_bookings2['family_id']; ?>">Delete</a>
                				</td>
            				</tr>
        		            <?php
    					}
    					?>
					    </tbody>
    				</table>
					<?php
				}
				
				if(isset($_GET['p']) && $_GET['p'] =='change-date') //customer - manage booking - DC apply
				{
				    function get_itinerary_by_order_id( $order_id )
				    {
				        global $mysqli;
                        $query_order_booking_info_itinerary = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id' order by travel_date asc";
                        $result_order_booking_info_itinerary = mysqli_query($mysqli, $query_order_booking_info_itinerary) or die(mysqli_error($mysqli));
                        while($row_order_booking_info_itinerary = mysqli_fetch_assoc($result_order_booking_info_itinerary))
                        {
                        	$traveldate_fxed = $row_order_booking_info_itinerary['travel_date'];
                        	$product_title = $row_order_booking_info_itinerary['product_title'];
                        	$trip_code = $row_order_booking_info_itinerary['trip_code'];
                        	$product_id_itinerary = $row_order_booking_info_itinerary['product_id'];
                        	$new_product_id_itinerary = $row_order_booking_info_itinerary['new_product_id'];
                        	
                        	if($new_product_id_itinerary == '' || $new_product_id_itinerary == NULL )
                        	{
                        	    $wptravel_itineraries_r = get_post_meta( $product_id_itinerary, 'wp_travel_trip_itinerary_data', true );
                        		$trip_wp_title = get_post_field( 'post_title', $product_id_itinerary );
                        		$wptravel_travel_outline = get_post_meta( $product_id_itinerary, 'wp_travel_outline', true );
                        		$productid_for_wptravel_product = $product_id_itinerary;
                        	}
                        	else
                        	{
                        	    $wptravel_itineraries_r = get_post_meta( $new_product_id_itinerary, 'wp_travel_trip_itinerary_data', true );
                        		$trip_wp_title = get_post_field( 'post_title', $new_product_id_itinerary );
                        		$wptravel_travel_outline = get_post_meta( $new_product_id_itinerary, 'wp_travel_outline', true );
                        		$productid_for_wptravel_product = $new_product_id_itinerary;
                        	}

                        	if ( isset( $wptravel_itineraries_r ) && ! empty( $wptravel_itineraries_r ) ) : 
                        		$wptravel_index = 1;
                        		$itinerary_location_array = array();
                        		$itinerary_time_array = array();
                        		$itinerary_flight_array = array();
                        		$itinerary_date_array = array();
                        		$itinerary_datedecider_array = array();
                        		$itinerary_array_counter = 0;
                        		$itinerary_counter=0;	
                        		foreach ( $wptravel_itineraries_r as $wptravel_itinerary ) : 
                        			$wptravel_time_format = get_option( 'time_format' );
                        			$wptravel_itinerary_label = '';
                        			$wptravel_itinerary_title = '';
                        			$wptravel_itinerary_desc  = '';
                        			$wptravel_itinerary_date  = '';
                        			$wptravel_itinerary_time  = '';
                        			$itinerary_counter = 1;
                        			$is_itinerary_available = 1;
                        				$wptravel_itinerary_label = stripslashes( $wptravel_itinerary['label'] );
                        			
                        				$wptravel_itinerary_title = stripslashes( $wptravel_itinerary['title'] );
                        			
                        				$wptravel_itinerary_desc = stripslashes( $wptravel_itinerary['desc'] );
                        			
                        				$wptravel_itinerary_date = wptravel_format_date( $wptravel_itinerary['date'] );
                        			
                        				$wptravel_itinerary_time = stripslashes( $wptravel_itinerary['time'] );
                        				$wptravel_itinerary_time = date( $wptravel_time_format, strtotime( $wptravel_itinerary_time ) ); 
                        		    $itinerary_location_array[$itinerary_array_counter] = $wptravel_itinerary_label; // destination
                        			$itinerary_time_array[$itinerary_array_counter] = $wptravel_itinerary_time; // flight time
                        			$itinerary_flight_array[$itinerary_array_counter] = $wptravel_itinerary_title; // flight number
                        			$itinerary_date_array[$itinerary_array_counter] = $traveldate_fxed; // flight date
                        			$itinerary_datedecider_array[$itinerary_array_counter] = strip_tags($wptravel_itinerary_desc); // arrival or departure define
                        					
                        			$wptravel_index++;
                        			$itinerary_array_counter++;
                        			
                        		endforeach;
                        	endif; 
                        	// DEFINE EXTRA DAYS
                            $itinerary_vals = '';
                        	$departure_date_plus_one = date("d/m/Y", strtotime("1 day", strtotime($traveldate_fxed))); 
                        	$departure_date_plus_two = date("d/m/Y", strtotime("2 day", strtotime($traveldate_fxed)));
                        	$departure_date_plus_three = date("d/m/Y", strtotime("3 day", strtotime($traveldate_fxed)));
                        	$departure_date_plus_four = date("d/m/Y", strtotime("4 day", strtotime($traveldate_fxed)));
                        	$length_aray = 0;
                            if ( isset($itinerary_location_array) && is_array( $itinerary_location_array ) ) {
                            	$length_aray = count($itinerary_location_array);
                            	$itinerary_vals .= '<center><table class="m_-8969220568537220410 tripitinerary wp-travel-table-content trip_'.$product_id_itinerary.'" cellpadding="0" cellspacing="0" style="width:100%; text-align:left; border: 1px solid #e1e1e; border-collapse: collapse; margin:10px 0px 10px 0px; padding:5px 7px 5px 7px; font-size:14px;">
                            	<thead>
                            	  <tr style="background: #f0f0f0; border:none; padding:5px 7px 5px 7px;">
                            		 <th style="width:20%; padding:7px 7px 7px 7px;">From</th>
                            		 <th style="width:20%; padding:7px 7px 7px 7px;">To</th>
                            		 <th style="width:20%; padding:7px 7px 7px 7px;">Flight</th>
                            		 <th style="width:20%; padding:7px 7px 7px 7px;">Departure</th>
                            		 <th style="width:20%; padding:7px 7px 7px 7px;">Arrival</th>
                            	  </tr>
                            	</thead>
                            	<tbody>';
                            }
                            else {
                                // Handle the case when $itinerary_location_array is null
                                $itinerary_vals .= '';
                            }
                        	// SECTION TO DIVIDE WAITING, SELF TRANSFER AND FLIGHT INFO
                        	$is_printed_destination = '';
                        	for ($i = 0; $i < $length_aray; $i++) 
                        	{
                        		if($itinerary_location_array[$i] == 'WAIT')
                        		{
                        			$is_printed_destination = '';
                        		}
                        		else if($itinerary_location_array[$i] == 'SELF-TRANSFER')
                        		{
                        			$is_printed_destination = '';
                        		}
                        		else
                        		{
                        			if ($is_printed_destination == '') 
                                    {
                                         
                                        $date1 = date("Y-m-d", strtotime($itinerary_datedecider_array[$i]))." ".date("H:i:s", strtotime($itinerary_time_array[$i]));
                                        if(isset($itinerary_datedecider_array[$i+1]) && isset($itinerary_time_array[$i+1]))
                                        {
                                            $date2 = date("Y-m-d", strtotime($itinerary_datedecider_array[$i+1]))." ".date("H:i:s", strtotime($itinerary_time_array[$i+1]));
                                            $dateDiff = intval((strtotime($date2) - strtotime($date1)) / 60);
                                        }
                                        else
                                        {
                                            $dateDiff = intval((strtotime($date1) - strtotime($date1)) / 60);
                                        }
                                        
                                        $hours = intval($dateDiff / 60); 
                                        $minutes = $dateDiff % 60;
                                        
                                        $time_duration = $hours.":".$minutes;
                                        $airline_from_itinerary = substr($itinerary_flight_array[$i],0,2);
                            
                        				$itinerary_vals .= "<tr style=''>";
                        				$itinerary_vals .= '<td style="border:1px solid #dcd7ca; padding:5px 7px 5px 7px; width:20%;">'.$itinerary_location_array[$i].'</td>';
                        				if(isset($itinerary_location_array[$i+1])) { 
                        				    $itinerary_vals .= '<td style="border:1px solid #dcd7ca; padding:5px 7px 5px 7px; width:20%;">'.$itinerary_location_array[$i+1].'</td>';
                        				}
                        				$itinerary_vals .= '<td style="border:1px solid #dcd7ca; padding:5px 7px 5px 7px; width:20%;">'.$itinerary_flight_array[$i].'</td>';
                        				$itinerary_vals .= '<td style="border:1px solid #dcd7ca; padding:5px 7px 5px 7px; width:20%;">'.$itinerary_time_array[$i].'</br>'.$itinerary_datedecider_array[$i].'</td>';
                        				if(isset($itinerary_time_array[$i+1]) && isset($itinerary_datedecider_array[$i+1])) { 
                        				    $itinerary_vals .= '<td style="border:1px solid #dcd7ca; padding:5px 7px 5px 7px; width:20%;">'.$itinerary_time_array[$i+1].'</br>'.$itinerary_datedecider_array[$i+1].'</td>';
                        				}
                        				$itinerary_vals .= "</tr>";
                        				$empty = '';
                        				$itinerary_vals .= "<tr style='border:none;'>";
                        				$itinerary_vals .= '<td colspan="2" style="padding:5px 7px 5px 7px; border:none;">   Class: Economy
                        				           </td>';
                        				$itinerary_vals .= '<td colspan="2" style="padding:5px 7px 5px 7px; border:none;">Operated by: '.$airline_from_itinerary.'</td>';
                        				$itinerary_vals .= '<td style="border:none;"></td>';
                        				$itinerary_vals .= "</tr>";
                        				
                        				$is_printed_destination = 'yes';
                                    }
                                    else
                                    {
                                        $is_printed_destination = '';
                                    }
                        		}
                        	}
                        	$itinerary_vals .= "</tbody></table></center></br>";
                        	// REPLACE ALL THE FIXED WORDS AS DEPARTURE AND ARRIVAL ON BACKEND
                        	$itinerary_vals = str_replace("Departure Date", '' ,$itinerary_vals);
                        	$itinerary_vals = str_replace("Arrival Date", '' ,$itinerary_vals);
                        	
                        	$itinerary_vals = str_replace("Selected Date +4", $departure_date_plus_four ,$itinerary_vals);
                        	$itinerary_vals = str_replace("Selected Date+4", $departure_date_plus_four ,$itinerary_vals);
                        	
                        	$itinerary_vals = str_replace("Selected Date +3", $departure_date_plus_three ,$itinerary_vals);
                        	$itinerary_vals = str_replace("Selected Date+3", $departure_date_plus_three ,$itinerary_vals);
                        	
                        	$itinerary_vals = str_replace("Selected Date +2", $departure_date_plus_two ,$itinerary_vals);
                        	$itinerary_vals = str_replace("Selected Date+2", $departure_date_plus_two ,$itinerary_vals);
                        	
                        	$itinerary_vals = str_replace("Selected Date+1", $departure_date_plus_one ,$itinerary_vals);
                        	$itinerary_vals = str_replace("Selected Date +1", $departure_date_plus_one ,$itinerary_vals);
                        	
                        	$traveldate_fxed_1 = date("d/m/Y", strtotime($traveldate_fxed)); 
                        	
                        	$itinerary_vals = str_replace("Selected Date", $traveldate_fxed_1 ,$itinerary_vals);
                        	
                        	$itinerary_vals = str_replace("Selected Date", $traveldate_fxed_1 ,$itinerary_vals);                        	
                            $wptravel_product_information_ordered = get_post_meta( $order_id, 'order_items_data', true ); // get order product info for trip extras
                            foreach ($wptravel_product_information_ordered as $key => $value) {
                                if (isset($value['trip_extras']['id'])) {
                                    // Extract "trip_extras" IDs
                                    $tripExtrasIds = $value['trip_extras']['id'];
                                    $itinerary_vals .= '<h6>Additional services</h6>';
                                    // Print or use the values as needed
                                    foreach ($tripExtrasIds as $value) {
                                        $itinerary_vals .= '<li>'.get_the_title( $value ).'</li>';
                                    }
                                } else {
                                    $itinerary_vals .= "No additional services available.";
                                }
                            }
                        	$itinerary_vals .=  '<hr>';
                        }
                        return $itinerary_vals;
				    }
				    if(!isset($_GET['msg'])) // if form not submitted
				    {
    				    $query_pax = "SELECT * FROM wpk4_customer_accounts where uid = '$user_id'";
    					$result_pax = mysqli_query($mysqli, $query_pax);
    					$query_px = mysqli_fetch_assoc($result_pax);
    					
    					$fullname = $query_px['full_name'];
    					$emailid = $query_px['email'];
						if($query_px['phonenumber'] != '')
					{
						$user_phonenumber = $query_px['phonenumber'];
					}
					else
					{
						$user_phonenumber = '0123456789012345';
					}
    					
    				    ?>
    				    <style>
    				        .vc_col-sm-2
    				        {
    				            width:16.6%;
    				        }
                            .customer-portal-carousel-dc {
                              display: flex;
                              justify-content: center;
                              align-items: center;
                              padding-bottom: 64px;
                            }
                            
                            .customer-portal-carousel-dc .carousel-arrow {
                              position: absolute;
                              display: flex;
                              justify-content: center;
                              top: 0;
                              bottom: 64px;
                              margin-block: auto;
                              height: fit-content;
                              width: 48px;
                              background-color: white;
                              border: none;
                              font-size: 3rem;
                              padding: 0;
                              cursor: pointer;
                              opacity: 0.5;
                              transition: opacity 100ms;
                            }
                            
                            .customer-portal-carousel-dc .carousel-arrow:hover,
                            .customer-portal-carousel-dc .carousel-arrow:focus {
                              opacity: 1;
                            }
                            
                            .customer-portal-carousel-dc .carousel-arrow--prev {
                              left: 0;
                            }
                            
                            .customer-portal-carousel-dc .carousel-arrow--next {
                              right: 0;
                            }
                            
                            .customer-portal-carousel-dc .carousel-container {
                              width: 100%;
                              padding-block: 16px 32px;
                              margin: 16px 48px;
                              overflow-x: auto;
                              display: flex;
                              width: 100%;
                              gap: 8px;
                              align-items: center;
                              scroll-snap-type: x mandatory;
                              flex-flow: row nowrap;
                              scroll-behavior: smooth;
                            }
                            
                            .customer-portal-carousel-dc .carousel-container::-webkit-scrollbar {
                              height: 14px;
                              width: calc(100% - 48px);
                            }
                            
                            .customer-portal-carousel-dc .carousel-container::-webkit-scrollbar-track {
                              background: #b1b3b399;
                            }
                            
                            .customer-portal-carousel-dc .carousel-container::-webkit-scrollbar-thumb {
                              background: #29AB87;
                            }
                            
                            .customer-portal-carousel-dc .carousel-container::-webkit-scrollbar-track-piece:start {
                              background: #29AB87;
                            }
                            
                            .customer-portal-carousel-dc .carousel-slide {
                                height:200px;
                                
                              /*min-height:200px; flex: 1 0 10%;*/
                              aspect-ratio: 1;
                              flex-flow: column nowrap;
                              display: flex;
                              justify-content: center;
                              align-items: center;
                              text-align:center;
                              background-color: #e8ebed;
                              scroll-snap-align: center;
                            }
                            
                            @media (max-width: 600px) {
                              .customer-portal-carousel-dc .carousel-slide {
                                flex: 1 0 90%;
                              }
                            }
                            .dc_select_btn
                            {
                                height:30px;
                                width:70px;
                                font-size:12px;
                                padding:7px;
                                margin:0px;
                                color:white;
                            }
                        </style>
                        <script>
                            const carousel = document.querySelector(".carousel-container");
                            const slide = document.querySelector(".carousel-slide");
                        
                            function handleCarouselMove(positive = true) {
                              const slideWidth = slide.clientWidth;
                              carousel.scrollLeft = positive ? carousel.scrollLeft + slideWidth : carousel.scrollLeft - slideWidth;
                            }
                        </script>
    				    <?php
    				    $booking_id = $_GET['id'];
    				    $trip_code = $_GET['tripid'];
    				    
    				    $query_bookings = "SELECT booking.order_type, booking.order_id, booking.product_id, booking.total_amount, pax.pnr, date(booking.order_date) as orderdate, booking.trip_code, date(booking.travel_date) as traveldate, booking.total_pax
        					FROM wpk4_backend_travel_bookings booking 
        					JOIN wpk4_backend_travel_booking_pax pax ON  
        					booking.order_id = pax.order_id AND 
        					booking.co_order_id = pax.co_order_id AND 
        					booking.product_id = pax.product_id  
        					where booking.order_id ='$booking_id' AND trip_code = '$trip_code' order by booking.order_date desc, booking.travel_date desc";
    					$result_bookings = mysqli_query($mysqli, $query_bookings);
    					$row_bookings = mysqli_fetch_assoc($result_bookings);

    					$order_type = $row_bookings['order_type'];
        				$order_id = $row_bookings['order_id'];
        				$pnr = $row_bookings['pnr'];
        				$order_date = $row_bookings['orderdate'];
        				$travel_date = $row_bookings['traveldate'];
        				$dc_pax_count = $row_bookings['total_pax'];
        				$total_amount = $row_bookings['total_amount'];
        				$product_id = $row_bookings['product_id'];

    				    $query_price_id_original = "SELECT pricing_id FROM wpk4_backend_stock_product_manager where trip_code='$trip_code' AND date(travel_date)='$travel_date'";
                        $result_price_id_original = mysqli_query($mysqli, $query_price_id_original) or die(mysqli_error($mysqli));
                        $row_price_id_original = mysqli_fetch_assoc($result_price_id_original);
                        if(mysqli_num_rows($result_price_id_original) > 0)
                        {
                            echo '4';
                            $pricing_id_original = $row_price_id_original['pricing_id'];
                                
                            $query_price_original = "SELECT sale_price FROM wpk4_wt_price_category_relation where pricing_id='$pricing_id_original' && pricing_category_id='954'";
                            $result_price_original = mysqli_query($mysqli, $query_price_original) or die(mysqli_error($mysqli));
                            $row_price_original = mysqli_fetch_assoc($result_price_original);
                            $price_for_trip_original = $row_price_original['sale_price'];
                            if($price_for_trip_original != '')
                            {
                                echo '<h3>Current Itinerary</h3>';
                                echo '</br>';
                				echo '<h4>' . substr($trip_code, 0, 3) . ' to ' . substr($trip_code, 4, 3).'</h4>';
                				echo '</br>';
                				echo '<h4>Travel Date: '.  $row_bookings['traveldate'].'</h4>'; 
                                echo '</br>';
                                echo '<h4>Pax: '.  $dc_pax_count.'</h4>'; 
                                echo '</br>';
                                echo get_itinerary_by_order_id($order_id);
                                
                				echo '<h4>Available options</h4>';
                				?>
                				Select your preferred month to travel..</br>
                				<select id="availablemonths" style='width:140px; padding:10px;'>
                				    <option value="" selected disabled>Select Month</option>
                    				<?php
                    				$availableMonths = array(); // to have the customer selection short by month
                    				$is_seat_found = 0;
                    				$query_stock = "SELECT trip_id, dep_date, current_stock FROM wpk4_backend_stock_management_sheet where trip_id ='$trip_code' AND date(dep_date) > CURDATE() order by dep_date asc";
                                    $result_stock = mysqli_query($mysqli, $query_stock) or die(mysqli_error($mysqli));
                                    while($row_stock = mysqli_fetch_assoc($result_stock))
                                    {
                                        $stock_trip_id = $row_stock['trip_id'];
                                        $stock_departure_date = $row_stock['dep_date'];
                                                                                        
                                        $pax_count = 0;
                                        $query_pax = "SELECT total_pax FROM wpk4_backend_travel_bookings where trip_code='$stock_trip_id' AND travel_date='$stock_departure_date' AND (payment_status = 'paid' || payment_status = 'partially_paid')";
                                        $result_pax = mysqli_query($mysqli, $query_pax) or die(mysqli_error($mysqli));
                                        while($row_pax = mysqli_fetch_assoc($result_pax))
                                        {    
                                            $pax_count = $pax_count + (int)$row_pax['total_pax'];
                                        }
                                        
                                        if( ( (int)$row_stock['current_stock'] - (int)$pax_count ) >= $dc_pax_count)
                                        {
                                            $query_price_id = "SELECT pricing_id FROM wpk4_backend_stock_product_manager where trip_code='$stock_trip_id' AND travel_date='$stock_departure_date'";
                                            $result_price_id = mysqli_query($mysqli, $query_price_id) or die(mysqli_error($mysqli));
                                            $row_price_id = mysqli_fetch_assoc($result_price_id);
                                            $pricing_id = $row_price_id['pricing_id'];
                                            
                                            $query_price = "SELECT sale_price FROM wpk4_wt_price_category_relation where pricing_id='$pricing_id' && pricing_category_id='954'";
                                            $result_price = mysqli_query($mysqli, $query_price) or die(mysqli_error($mysqli));
                                            $row_price = mysqli_fetch_assoc($result_price);
                                            $price_for_trip = $row_price['sale_price'];
                                            if($price_for_trip != '')
                                            {
                                                $is_seat_found = 1;
                                                if (in_array(date('m', strtotime($stock_departure_date)), $availableMonths)) {
                                        			continue; // Skip to the next publish of pax row
                                        		}
                                        		$availableMonths[] = date('m', strtotime($stock_departure_date));
                                        		?>
                                        		<option value="<?php echo date('m', strtotime($stock_departure_date)); ?>" <?php if(isset($_GET['month']) && date('m', strtotime($stock_departure_date)) == $_GET['month']) { echo 'selected'; } ?>><?php echo date('F', strtotime($stock_departure_date)); ?></option>
                                        		<?php
                                            }
                                        }
                                    }
                                    if($is_seat_found == 0)
                                    {
                                        echo 'Sorry, No seat available. Kindly contact our agents. <a href="tel:1300359463" style="top:15px; float:right !important;">Call 1300 359 463</a>';
                                    }
                    				?>
                				</select>
                				<button class="dc_select_btn" id="submit_available_options" onclick="reloadAvailableSelection();">Search</button>
                				<?php
                				if(isset($_GET['month']))
                				{
                				    $selectedMonth = $_GET['month'];
                    				echo '<main class="customer-portal-carousel-dc">
                    				    <!--<button class="carousel-arrow carousel-arrow--prev" onclick="handleCarouselMove(false)">
                                            &#8249;
                                        </button>
                                        
                                        <button class="carousel-arrow carousel-arrow--next" onclick="handleCarouselMove()">
                                            &#8250;
                                        </button>-->
                                        <div class="carousel-container" dir="ltr">
                    				';
                    				
                    				$column_counter = 0;
                                    $query_stock = "SELECT trip_id, dep_date, current_stock FROM wpk4_backend_stock_management_sheet where trip_id ='$trip_code' AND date(dep_date) > CURDATE() AND month(dep_date) = '$selectedMonth' order by dep_date asc limit 20";
                                    $result_stock = mysqli_query($mysqli, $query_stock) or die(mysqli_error($mysqli));
                                    while($row_stock = mysqli_fetch_assoc($result_stock))
                                    {
                                                                                    
                                        $stock_trip_id = $row_stock['trip_id'];
                                        $stock_departure_date = $row_stock['dep_date'];
                                                                                        
                                        $pax_count = 0;
                                        $query_pax = "SELECT total_pax FROM wpk4_backend_travel_bookings where trip_code='$stock_trip_id' AND travel_date='$stock_departure_date' AND (payment_status = 'paid' || payment_status = 'partially_paid')";
                                        $result_pax = mysqli_query($mysqli, $query_pax) or die(mysqli_error($mysqli));
                                        while($row_pax = mysqli_fetch_assoc($result_pax))
                                        {    
                                            $pax_count = $pax_count + (int)$row_pax['total_pax'];
                                        }
                                        
                                        if( ( (int)$row_stock['current_stock'] - (int)$pax_count ) >= $dc_pax_count)
                                        {
                                            $query_price_id = "SELECT pricing_id FROM wpk4_backend_stock_product_manager where trip_code='$stock_trip_id' AND travel_date='$stock_departure_date'";
                                            $result_price_id = mysqli_query($mysqli, $query_price_id) or die(mysqli_error($mysqli));
                                            $row_price_id = mysqli_fetch_assoc($result_price_id);
                                            $pricing_id = $row_price_id['pricing_id'];
                                            
                                            $query_price = "SELECT sale_price FROM wpk4_wt_price_category_relation where pricing_id='$pricing_id' && pricing_category_id='954'";
                                            $result_price = mysqli_query($mysqli, $query_price) or die(mysqli_error($mysqli));
                                            $row_price = mysqli_fetch_assoc($result_price);
                                            $price_for_trip = $row_price['sale_price'];
                                            if($price_for_trip != '')
                                            {
                                            ?>
                        					<div class="carousel-slide">
                                    			<?php 
                                    			    echo '<p style="font-size:13px; font-weight:600;">'.date('d/m/Y', strtotime($stock_departure_date)).'</p>';
                                    			    echo '<p>'.strftime("%A",strtotime($stock_departure_date)).'</p>';
                                    			?>
                                    			<?php 
                                    			echo '<p style="font-size:15px; color: green; font-weight:700;">$'.$price_for_trip.'</p>';
                                    			?>
                                    			<?php
                                    			if($row_bookings['traveldate'] == date('Y-m-d', strtotime($stock_departure_date)))
                                    			{
                                    			    echo '<button disabled class="dc_select_btn" style="border: 1px solid #999999; background-color: #cccccc; color: #666666; width:100px;">Current Trip</button>';
                                    			}
                                    			else
                                    			{
                                    			    echo '<button onclick="dc_selectdate(this.id, this.name);" name="'.$price_for_trip.'" id="'.date('Y-m-d', strtotime($stock_departure_date)).'" class="dc_select_btn">Select</button>';
                                    			}
                                    			?>
                                    			
                            			    </div>
                                            <?php 
                                            }
                                        }
                                    }
                                    echo '</div></main>';
                                    ?>
                                    <form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                        <input type="hidden" id="original_travel_date" name="original_travel_date" value="<?php echo $row_bookings['traveldate']; ?>">
                                        Selected Date: 
                                        <input type="text" id="selected_date" readonly name="new_travel_date">
                                        </br>
                                        Selected Price (per pax):
                                        <input type="text" id="selected_price_pp" readonly name="selected_price_pp">
                                        </br>
                                        No of Pax:
                                        <input type="text" id="no_of_pax" readonly name="no_of_pax" value="<?php echo $dc_pax_count; ?>">
                                        </br>
                                        Trip Price (for all pax):
                                        <input type="text" id="selected_price" readonly name="selected_price">
                                        </br>
                                        Fare difference for all pax (Note: Fare difference will be 0, if the original trip fare is lower than the new fare as it is already reserved with the airline.):
                                        <input type="text" id="fare_price" readonly name="fare_difference">
                                        </br>
                                        Datechange charge (per pax):
                                        <input type="text" value="$350" readonly name="datechange_charge">
                                        </br>
                                        Final fare with DC charge (for all pax):
                                        <input type="text" id="fee_price" readonly name="amount_to_be_paid">
                                        </br>
                                        <center><input type='submit' style='padding:10px; margin:0;font-size:12px; ' name='submit_datechange_request' value='Request Date Change'></center>
                                    </form>
                                    <?php
                				}
                                if(isset($_POST['submit_datechange_request']))
            				    {
            				        $current_booking_id = $_GET['id'];
            				        $current_booking_tripcode = $_GET['tripid'];
            				        
            				        $query_select_get_booking = "SELECT * FROM wpk4_backend_travel_bookings where order_id = '$current_booking_id' AND trip_code = '$current_booking_tripcode'";
                                    $result_select_get_booking = mysqli_query($mysqli, $query_select_get_booking) or die(mysqli_error($mysqli));
                                    $row_select_get_booking = mysqli_fetch_assoc($result_select_get_booking);
    
                                    $original_co_order_id = $row_select_get_booking['co_order_id'];
                                    $original_product_id = $row_select_get_booking['product_id'];
                                    
            				        $original_no_of_pax = $row_select_get_booking['total_pax'];
                                    $original_tripcode = $current_booking_tripcode;
                                    $original_travel_date = $row_select_get_booking['travel_date'];
                                    $new_no_of_pax = $row_select_get_booking['total_pax'];
                                    $new_tripcode = $current_booking_tripcode;
                                    
                                    $payment_received = "no";
                                    $ticket_issued = "-";
                                    
                                    
                                    $new_travel_date = $_POST['new_travel_date']; // new package travel date
                                    $selected_price_pp = $_POST['selected_price_pp']; // new package price per pax
                                    $ticket_cost =  $_POST['selected_price']; // new package price for all pax
                                    
                                    $no_of_pax =  $_POST['no_of_pax'];
                                    $fare_difference = $_POST['fare_difference']; // for all fare difference
                                    $datechange_charge = $_POST['datechange_charge']; // per pax
                                    
                                    $dc_cost_taken = $_POST['amount_to_be_paid']; // final amount to be paid for all pax
                                    
    
                                    $agent = '';
                                    $remark = '';
                                    $partial_change = 'no';
                        			$initial_request_date = date("Y-m-d H:i:s");
                        			$requested_by = $username;
                        			$requested_on = $initial_request_date;
                        			$status = 'new';
                        			
        			
                    			    if ($original_no_of_pax != '' && $original_tripcode != '' && $original_travel_date != '' && $new_no_of_pax != '' && $new_tripcode != '' && $new_travel_date != '' && $dc_cost_taken != '')
                    			    {
                    			        $new_travel_date_c = date('Y-m-d', strtotime($new_travel_date));
                                        
                                        //fetch the pricing id of the new trip code
                                        $query_select_pricing_new = "SELECT spm.pricing_id, p.max_pax FROM wpk4_backend_stock_product_manager spm
                                        INNER JOIN wpk4_wt_pricings p ON p.id = spm.pricing_id
                                        WHERE spm.trip_code = '$new_tripcode' AND spm.travel_date = '$new_travel_date_c'";
                                        $result_select_pricing_new = mysqli_query($mysqli, $query_select_pricing_new) or die(mysqli_error($mysqli));
                                        $row_select_pricing_new = mysqli_fetch_assoc($result_select_pricing_new);
                                        $pricing_id_new = $row_select_pricing_new['pricing_id'];
                                        $current_pax_new = $row_select_pricing_new['max_pax'];
                                        
                                        if ($new_no_of_pax > $current_pax_new) {
                                        
                                            $msg = "Sold-out - No seats are available on the selected option";
                                            echo '<script>alert("' . $msg . '");</script>';
                                        }
                                        else 
                                        {
                                            mysqli_query($mysqli, "insert into wpk4_backend_todo_tasks (order_id, comment_by, comment_date_time, comment_type,
                                                status, status_updated_on, payment_received) 
                                                values ('$current_booking_id', '$requested_by', '$requested_on', 'date change',
                                                'open', '$requested_on', '$payment_received')") or die(mysqli_error($mysqli));
                                                
                                            // block the seat for the request
                                            $update_pax_count_new = $current_pax_new - $new_no_of_pax;
                                            $sql_update_pax_new = "UPDATE wpk4_wt_pricings SET max_pax='$update_pax_count_new' WHERE id='$pricing_id_new'";
                                            $result_status_new = mysqli_query($mysqli, $sql_update_pax_new) or die(mysqli_error($mysqli));
                                            
                                            $query = "SELECT spm.product_id as old_product_id,
                                                (SELECT spm.product_id FROM wpk4_backend_stock_product_manager spm WHERE spm.trip_code='" . $new_tripcode . "' AND
                                                DATE(spm.travel_date) = '" . $new_travel_date . "') as new_product_id
                                                FROM wpk4_backend_stock_product_manager spm
                                                WHERE spm.trip_code='" . $original_tripcode . "' AND DATE(spm.travel_date) = '" . $original_travel_date . "';";
                                            $result = mysqli_query($mysqli, $query) or die(mysqli_error($mysqli));
                                            $row = mysqli_fetch_assoc($result);
                                            
                                            $old_product_id = $row['old_product_id'];
                                            $new_product_id = $row['new_product_id'];
                                            
                                            $old_trip_code = explode('-', $original_tripcode);
                                            $new_trip_code = explode('-', $new_tripcode);
                                            
                                            $old_travel_date_depart = $original_travel_date;
                                            $new_travel_date_depart = $new_travel_date;
                                            
                                            $orderid = $_GET['id'];
                                            $co_orderid = $original_co_order_id;
                                            $productid = $original_product_id;
                                            $original_travel_date = $original_travel_date;
                                            $original_tripcode = $original_tripcode;
                                            $total_pax_old = $original_no_of_pax;
                                            $new_travel_date = $new_travel_date;
                                            $new_tripcode = $new_tripcode;
											$travel_date_old = date('Y-m-d', strtotime($original_travel_date));
                                            $original_tripcode = $original_tripcode;
                                            
                                            $query_select_pricing_old = "SELECT * FROM wpk4_backend_stock_product_manager where trip_code = '$original_tripcode' AND travel_date = '$travel_date_old'";
                                            $result_select_pricing_old = mysqli_query($mysqli, $query_select_pricing_old) or die(mysqli_error($mysqli));
                                            $row_select_pricing_old = mysqli_fetch_assoc($result_select_pricing_old);
                                            $pricing_ids_old = $row_select_pricing_old['pricing_id'];
                                            
                                            $query_select_stock_old = "SELECT * FROM wpk4_wt_pricings where id = '$pricing_ids_old'";
                                            $result_select_stock_old = mysqli_query($mysqli, $query_select_stock_old) or die(mysqli_error($mysqli));
                                            $row_select_stock_old = mysqli_fetch_assoc($result_select_stock_old);
                                            $current_pax_old = $row_select_stock_old['max_pax'];
                                            
                                            $update_pax_count_old = $current_pax_old + $total_pax_old;
                                            
                                            $sql_update_pax_old = "UPDATE wpk4_wt_pricings SET max_pax='$update_pax_count_old' WHERE id='$pricing_ids_old'";
                                            $result_status_old= mysqli_query($mysqli,$sql_update_pax_old) or die(mysqli_error($mysqli));
                                            
                                            $is_customer_chat_required = true;
                                            // to create DC Customer portal chat 
                                            if($is_customer_chat_required)
                                            {
                                                $query_count = "SELECT * FROM wpk4_backend_user_portal_requests ORDER BY case_id DESC LIMIT 1";
                        						$result_count = mysqli_query($mysqli, $query_count);
                        						$row_count_assoc = mysqli_fetch_assoc($result_count);
                        						$row_count = mysqli_num_rows($result_count);
                        						if($row_count>0)
                        						{
                        							$case_id = intval($row_count_assoc['case_id']);
                        							$case_id = $case_id+1;
                        						}
                        						else
                        						{
                        							$case_id = '1';
                        						}
                        						$emailid = $emailid;
                        						$order_number = $orderid;
                        						$original_travel_date = $_POST['original_travel_date'];
                        						$new_travel_date = $new_travel_date_c;
                        						$amount_to_be_paid = $_POST['amount_to_be_paid'];
                        						$current_date_time = date("Y-m-d H:i:s");
    
                        						mysqli_query($mysqli,"insert into wpk4_backend_user_portal_requests (case_id, case_type, reservation_ref, last_response_by, last_response_on, is_seen_by_gt, user_id, status, case_date, priority) 
                        						values ('$case_id','datechange','$order_number' ,'customer' ,'$current_date_time' ,'0' ,'$user_id' ,'open' ,'$current_date_time' ,'P4')") or die(mysqli_error($mysqli));
                        						
                        						$subject = 'Date change Request '. $order_number;
                                                add_userportal_post_meta($case_id, 'subject', $subject);
                                                add_userportal_post_meta($case_id, 'current_tripcode', $new_tripcode);	
                        						add_userportal_post_meta($case_id, 'current_travel_date', $original_travel_date);	
                        						add_userportal_post_meta($case_id, 'current_no_of_pax', $new_no_of_pax);
                        						add_userportal_post_meta($case_id, 'new_tripcode', $new_tripcode);	
                        						add_userportal_post_meta($case_id, 'new_travel_date', $new_travel_date);
                        						add_userportal_post_meta($case_id, 'new_no_of_pax', $new_no_of_pax);
                        						add_userportal_post_meta($case_id, 'selected_package_price_per_person', $selected_price_pp);
                        						add_userportal_post_meta($case_id, 'selected_package_price_for_all_pax', $ticket_cost);
                        						add_userportal_post_meta($case_id, 'fare_difference', $fare_difference);
                        						add_userportal_post_meta($case_id, 'datechange_charge', $datechange_charge);
                        						add_userportal_post_meta($case_id, 'datechange_amount_to_be_paid', $amount_to_be_paid);
                        						add_userportal_post_meta($case_id, 'email_address', $emailid);
                        						add_userportal_post_meta($case_id, 'remark', "Requested through DC automation");
                        
                        						$mailbody= '<!DOCTYPE html>
                        						<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office">
                        						<head>
                        						<meta charset="utf-8"> <!-- utf-8 works for most cases -->
                        						<meta name="viewport" content="width=device-width"> <!-- Forcing initial-scale shouldnt be necessary -->
                        						<meta http-equiv="X-UA-Compatible" content="IE=edge"> <!-- Use the latest (edge) version of IE rendering engine -->
                        						<meta name="x-apple-disable-message-reformatting">  <!-- Disable auto-scale in iOS 10 Mail entirely -->
                        						<title></title> <!-- The title tag shows in email notifications, like Android 4.4. -->
                        						<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
                        						<!-- CSS Reset : BEGIN -->
                        						<style>
                        						/* What it does: Stops email clients resizing small text. */
                        						* {
                        							-ms-text-size-adjust: 100%;
                        							-webkit-text-size-adjust: 100%;
                        						}
                        
                        						/* What it does: Centers email on Android 4.4 */
                        						div[style*="margin: 16px 0"] {
                        							margin: 0 !important;
                        						}
                        
                        						/* What it does: Stops Outlook from adding extra spacing to tables. */
                        						table,
                        						td {
                        							mso-table-lspace: 0pt !important;
                        							mso-table-rspace: 0pt !important;
                        						}
                        
                        						/* What it does: Fixes webkit padding issue. */
                        						table {
                        							border-spacing: 0 !important;
                        							border-collapse: collapse !important;
                        							table-layout: fixed !important;
                        							margin: 0 auto !important;
                        						}
                        
                        						/* What it does: Prevents Windows 10 Mail from underlining links despite inline CSS. Styles for underlined links should be inline. */
                        						a {
                        							text-decoration: none;
                        							color: #30e3ca;
                        						}
                        
                        						h1,h2,h3,h4,h5,h6{
                        							font-family: "Lato", sans-serif;
                        							color: #000000;
                        							margin-top: 0;
                        							font-weight: 400;
                        						}
                        
                        						body{
                        							font-family: "Lato", sans-serif;
                        							font-weight: 400;
                        							font-size: 13px;
                        							line-height: 1.8;
                        							color: rgba(0,0,0,.4);
                        						}
                        
                        						.hero .text{
                        							color: rgba(0,0,0,.3);
                        						}
                        						.hero .text h2{
                        							color: #000;
                        							font-size: 20px;
                        							margin-bottom: 0;
                        							font-weight: 400;
                        							line-height: 1.4;
                        						}
                        						.hero .text h3{
                        							font-size: 17px;
                        							font-weight: 300;
                        						}
                        						.hero .text h2 span{
                        							font-weight: 600;
                        							color: #30e3ca;
                        						}
                        
                        
                        						ul.social{
                        							padding: 0;
                        						}
                        						ul.social li{
                        							display: inline-block;
                        							margin-right: 10px;
                        						}
                        						</style>
                        						</head>
                        						<body width="100%" style="margin: 0; padding: 0 !important; mso-line-height-rule: exactly; background-color: #f1f1f1;">
                        							<center style="width: 100%; background-color: #f1f1f1;">
                        							<div style="display: none; font-size: 1px;max-height: 0px; max-width: 0px; opacity: 0; overflow: hidden; mso-hide: all; font-family: sans-serif;">
                        							  &zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;
                        							</div>
                        							<div style="max-width: 600px; margin: 0 auto;" class="email-container">
                        							
                        							
                        						<table class="wp-travel-wrapper" style="color: #5d5d5d; font-family: Roboto, sans-serif; margin: auto;" width="100%" cellspacing="0" cellpadding="0">
                        						<tbody>
                        						<tr class="wp-travel-content" style="background: #fff;">
                        						<td class="wp-travel-content-top" style="background: #fff; margin: 0; padding: 30px 25px;" colspan="2" align="left">
                        							<table role="presentation" border="0" cellpadding="0" cellspacing="0" width="100%">
                        							<tr>
                        							<td class="logo" style="text-align: center;">
                        							<img src="https://gauratravel.com.au/wp-content/uploads/2022/01/cropped-GauraTravel_logo_small_2.png" style="width:200px; text-align:center;"/>
                        							</td>
                        							</tr>
                        							</table>
                        						</td>
                        						</tr>
                        						<tr class="wp-travel-content" style="background: #fff;">
                        						<td class="wp-travel-content-top" style="background: #fff; margin: 0; padding: 20px 25px;" colspan="2" align="left">
                        						<p style="line-height: 1.55; font-size: 14px;">Hi,</p>
                        						<p style="line-height: 1.55; font-size: 14px;">Thank you for submitting your date change form with required information as below:</p>
                        						<p style="line-height: 1.55; font-size: 14px;"><b></b></p>
                        						</td></tr>';
                    
                        						if($order_number != '')
                        						{
                        							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                        							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Reservation code/ Order ID: '.$order_number.'</td></tr>';
                        						}
                        						if($original_travel_date != '')
                        						{
                        							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                        							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Current Travel Date: '.$original_travel_date.'</td></tr>';
                        						}
                        						if($new_travel_date != '')
                        						{
                        							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                        							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">New Travel Date: '.$new_travel_date.'</td></tr>';
                        						}
                        						if($amount_to_be_paid != '')
                        						{
                        							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                        							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Date change fee: '.$amount_to_be_paid.'</td></tr>';
                        						}
                        						
                        						$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                        							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left"> </td></tr>';
                        							
                        						$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                        							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">
                        							If your travel date within 96 hours, we will get back to you today, or else our team will get back to you within 48 hours of your submissions.</td></tr>';
                        							
                        						$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                        							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 40px 25px;" colspan="2" align="left">
                        							Thank you!</td></tr>';
                        						$mailbody .=  '</tbody>
                        						</table>
                        						</div>
                        						</center>
                        						</body>
                        						</html>';
                    							$mailbody=stripslashes($mailbody);
                    							$emailsubject="Request Submitted - Gaura Travel";  
                    							$path = '';
                    							$sentto = $emailid;
                    							include('email/tpl_dispatch_userportal_emails.php');
                                            }
    							            
    							            $new_travel_date = $new_travel_date.' 00:00:00';
                                            mysqli_query($mysqli, "insert into wpk4_backend_travel_datechange_request (order_id, original_no_of_pax,
                                                original_tripcode, original_travel_date, new_no_of_pax, new_tripcode, new_travel_date, payment_received, ticket_issued,
                                                ticket_cost, dc_cost_taken, agent, remark, partial_change, initial_request_date, requested_by, requested_on, status, requested_by_type, portal_case_id)
                                                values ('$current_booking_id', '$original_no_of_pax', '$original_tripcode', '$original_travel_date', '$new_no_of_pax',
                                                '$new_tripcode', '$new_travel_date', '$payment_received', '$ticket_issued', '$ticket_cost', '$amount_to_be_paid', '$agent',
                                                '$remark', '$partial_change', '$initial_request_date', '$requested_by', '$requested_on', '$status', 'customer', '$case_id')") or die(mysqli_error($mysqli));
                                                
                                            echo '<script>alert("Datechange request has been submitted to Gaura Travel. One of our agent will proceed this change. Thank you.");</script>';
                                        }
                                    }
                                    else 
                                    {
                                        echo '<script>alert("Kindly add all the required information");</script>';
                                    }
                                    echo '<script>window.location.href="?";</script>';
            					}
            					?>
                                <script>
                                    function reloadAvailableSelection()
                                    {
                                        selected_month = document.getElementById("availablemonths").value;
                                        var currentLocation = window.location;
    
                                        window.location.href= currentLocation + "&month=" + selected_month;
                                    }
                                    function dc_selectdate(sel_date, sel_price)
                                    {
                                        var bookingPrice = <?php echo json_encode($price_for_trip_original) ?>;
                                        var noOfPax = <?php echo json_encode($dc_pax_count) ?>;
                                        
                                        document.getElementById("selected_date").value = sel_date;
                                        document.getElementById("selected_price_pp").value = "$" + sel_price;
                                        document.getElementById("selected_price").value = "$" + ( sel_price * noOfPax );
                                        
                                        var balance =  sel_price - bookingPrice ; // fare difference
                                        if(balance > 0)
                                        {
                                            document.getElementById("fare_price").value = "$" + balance * noOfPax;
                                        }
                                        else
                                        {
                                            balance = 0; // overwriting balance if face difference in negative
                                            document.getElementById("fare_price").value = "$" + balance;
                                        }
                                        
                                        
                                        var fare_with_fee = (balance + 350) * noOfPax; // adding with DC charge
                                        document.getElementById("fee_price").value = "$" + fare_with_fee;
                                    }
                                </script>
                                <?php
                            }
                        }
				    }
				    else // if form submitted successfully
				    {
				        if($_GET['msg'] == 'success')
				        {
				            
				        }
				    }
				}
				
				if( isset($_GET['p']) && $_GET['p'] == 'request-refund')
                {
                    $order_id = $_GET['ord'];
                    
                    if(md5($order_id) != $_GET['key'])
                    {
                        exit;
                    }
                    
                    $query_pax = "SELECT * FROM wpk4_customer_accounts where uid = '$user_id'";
					$result_pax = mysqli_query($mysqli, $query_pax);
					$query_px = mysqli_fetch_assoc($result_pax);
					$trav_date = date("Y-m-d H:i:s");
					$fullname = $query_px['full_name'] ?? '';
					$emailid = $query_px['email'] ?? 'gt@nouseraccountgt.com';
					if(mysqli_num_rows($result_pax) > 0 && $query_px['phonenumber'] != '')
					{
						$user_phonenumber = $query_px['phonenumber'];
					}
					else
					{
						$user_phonenumber = '0123456789012345';
					}
					
					if(isset($emailid) && $emailid != '' && isset($user_id) && $user_id != '')
					{
                        ?>
                        <h4>Request deposit refund</h4>
                        <style>
                        .accounts_general_button
                        {
                            width: 130px;
                            padding:8px 12px;
                            font-size: 11px;
                            float:right;
                            margin:0px 5px;
                        }
                        .form-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 10px;
                        }
                        .form-group {
                            display: flex;
                            flex-direction: column;
                            flex-basis: 48%;
                        }
                        .form-group-full-width {
                            display: flex;
                            flex-direction: column;
                            flex-basis: 100%; 
                        }
                        label {
                            margin-bottom: 5px;
                        }
                        input, select {
                            width: 100%;
                            padding: 8px;
                            box-sizing:
                        }
                        </style>
                        <?php
                        $query_bookings_checkup = "
                                                				SELECT
                                                                    booking.order_id,
                                                                    booking.order_date,
                                                                    (
                                                                        SELECT SUM(pays.trams_received_amount)
                                                                        FROM wpk4_backend_travel_payment_history pays
                                                                        WHERE pays.order_id = booking.order_id
                                                                        AND pays.payment_change_deadline > NOW()
                                                                    ) AS total_received_amount
                                                                FROM wpk4_backend_travel_bookings booking
                                                                WHERE booking.order_id = '$order_id'
                                                                AND booking.order_id IN (
                                                                    SELECT DISTINCT order_id
                                                                    FROM wpk4_backend_travel_payment_history
                                                                    WHERE trams_received_amount > 0
                                                                    AND payment_change_deadline > NOW()
                                                                )
                                                                AND booking.payment_status IN ('partially_paid', 'canceled')
                                                                HAVING total_received_amount > 0 and total_received_amount < 400
                                                                ORDER BY booking.order_date DESC;
                                                			    ";
                        //echo $query_bookings_checkup;                       				
                        $result_bookings_checkup = mysqli_query($mysqli, $query_bookings_checkup) or die(mysqli_error($mysqli));
                        if(mysqli_num_rows($result_bookings_checkup) > 0)
                        {
                            ?>
                            <form id="paymentForm" action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="clientPaymentId">OrderID:</label>
                                    <select name='clientPaymentId' id="clientPaymentId" style="width:100%; padding:10px; border-color: #dcd7ca;">
                                        <option selected disabled value="DUMMYGT">Select Order ID</option>
                                            <?php
                                            while($row_bookings = mysqli_fetch_assoc($result_bookings_checkup))
                                            {
                                            $orderid_previous = $row_bookings['order_id'];
                                            echo '<option value="'.$orderid_previous.'">'.$orderid_previous.'</option>';
                                            }
                                            ?>
                                    </select>
                                    <input type="hidden" id="paymentDescription" name="paymentDescription" required>
                                    <input type="hidden" id="customerReference" name="customerReference">
                                    <input type="hidden" id="payOptionType" value='PayID' name="payOptionType">
                                    <input type="hidden" id="paymentAmount" name="paymentAmount" required pattern="^\d*(\.\d{0,2})?$">
                                </div>
                                <div class="form-group">
                                    <label for="returnAmount">Refund Amount:</label>
                                    <span id="returnAmount" style="font-size:17px;" name="returnAmount"></span>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="payeeName">Payee Name:</label>
                                    <input type="text" id="payeeName" name="payeeName" value="<?php echo $fullname; ?>" required>
                                </div>
                            </div>
                            
                            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                                        <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
                                        <script>
                        				    function openCity(evt, cityName) {
                                    		  var i, tabcontent, tablinks;
                                    		  tabcontent = document.getElementsByClassName("tabcontent");
                                    		  for (i = 0; i < tabcontent.length; i++) {
                                    			tabcontent[i].style.display = "none";
                                    		  }
                                    		  tablinks = document.getElementsByClassName("tablinks");
                                    		  for (i = 0; i < tablinks.length; i++) {
                                    			tablinks[i].className = tablinks[i].className.replace(" active", "");
                                    		  }
                                    		  document.getElementById(cityName).style.display = "block";
                                    		  evt.currentTarget.className += " active";
                                    		  
                                    		    document.getElementById('payOptionType').value = cityName;
                                    		}
                        				</script>
                                        <style>
                        				.blink_me {
                                            animation: blinker 2s linear infinite;
                                            margin:0;
                                            padding:0;
                                        }
                                            
                                        @keyframes blinker {
                                            50% {
                                                opacity: 0;
                                            }
                                        }
                        				.search_bookings a, button, input[type=submit]
                        				{
                        				    background-color:#ffbb00;
                        				    color:black;
                        				}
                        				.tabnavigation
                        				{
                        				    float:left;
                        				    left:0;
                        				}
                            			.chatcategory
                            			{
                                			padding:7px 10px; 
                                			margin:0;
                                			font-size:13px;
                            			}
                            			.tab .active
                            			{
                            			    color:#FFF !important;
                            			    background-color:#000 !important
                            			}
                            			.ssr_request_radio_button {
                            			    margin-top: 10px; display: block;
                                            flex-wrap: wrap;
                                        }
                                        .ssr_request_radio_button label.radio {
                                         display:inline;
                                         position:relative;
                                         margin-left: 0.2em;
                                         _top:0.2em;
                                         }
                                         
                                         .radio-group {
                                                display: flex;
                                                align-items: center;
                                            }
                                            
                                            .radio-group label {
                                                margin-right: 10px;
                                                margin-top:13px;
                                            }
                                            .badge.badge-primary {
                                                background-color: #149efa;
                                            }
                                            
                                            .badge {
                                                display: inline-block;
                                                min-width: 10px;
                                                padding: 3px 7px;
                                                font-size: 12px;
                                                font-weight: 700;
                                                line-height: 1;
                                                color: #fff;
                                                text-align: center;
                                                white-space: nowrap;
                                                vertical-align: middle;
                                                background-color: #777;
                                                border-radius: 10px;
                                            }
            
            
                            			</style>
                            			<div class="tabnavigation search_bookings">
                            				<div class="tab">
            
                                				<a class="tablinks chatcategory active" onclick="openCity(event, 'PayID')">PayID</a>
                                				
                                				<a class="tablinks chatcategory" onclick="openCity(event, 'BSB')">BSB & Account</a>
                                				
                                			</div>
                            			</div>
                        				</br></br>
                        				<div id="tabcontent_main" style="font-size:14px;">
                        				    <div id="PayID" class="tabcontent" >
                        				        <div class="form-row">
                                                    <div class="form-group">
                                                        <label for="payIDType">PayID Type:</label>
                                                        <select id="payIDType" name="payIDType">
                                                            <option value="" selected disabled>Select</option>
                                                            <option value="PHONE">Phone</option>
                                                            <option value="EMAIL">Email</option>
                                                        </select>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="payID">PayID:</label>
                                                        <input type="text" placeholder="+61-123456789 / testuser@gmail.com" id="payID" name="payID">
                                                    </div>
                                                </div>
                        				    </div>
                        				    
                        				    <div id="BSB" class="tabcontent" style="display:none;">
                        				        <div class="form-row">
                                                    <div class="form-group">
                                                        <label for="bsb">BSB:</label>
                                                        <input type="text" id="bsb" placeholder="123456" name="bsb">
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="accountNumber">Account Number:</label>
                                                        <input type="text" placeholder="12345678" id="accountNumber" name="accountNumber">
                                                    </div>
                                                </div>
                        				    </div>
                        				</div>
                        				
                        			</br>
                        		<span style="font-size:11px;">* Please recheck the name and order information before proceeding the transfer.</span>	    
                        		</br>		        
                            </br>
                            <input type="submit" name="transfer_to_pax" id="transfer_to_pax" value="Transfer Payment">
                        </form>
                        <?php
                        }
                        else
                        {
                            $query_is_refund_submitted = "SELECT payment_status FROM wpk4_backend_travel_bookings where order_id = '$order_id'";
        					$result_is_refund_submitted = mysqli_query($mysqli, $query_is_refund_submitted);
                            $row_bookings_submitted = mysqli_fetch_assoc($result_is_refund_submitted);
                            $previous_order_payment_status = $row_bookings_submitted['payment_status'];
                            ?>
                            <center>
                                <h5>We are unable to process your request due to one of the following reasons:</h5>
                                <p>1. Your payment date is more than 96 hours, or</p>
                                <p>2. Your booking status is: <?php echo $previous_order_payment_status; ?></p>
                                <p>3. Your refund request amount exceeds $400 - in this case, please contact our Refund Team for further assistance.</p>
                                </br>
                                <h6>If you have any questions, feel free to call us at 1300 459 463</h6>
                            </center>
                            <?php
                        }
                        ?>
                        
                        <script>
            									$(document).ready(function() {
            									    
            									    $(document).on('change', '#clientPaymentId', function(){
                                						var oldOrderId = $(this).val();
                                						var customerReference = 'Refund for '+ oldOrderId;
                                						var paymentDescription = 'CP Refund for '+ oldOrderId;
                                						var form_data = new FormData();
                                						form_data.append('get_paid_amount_for_adjustment', 'deposit_amount_adjustment_from_customerportal');
                                						form_data.append('old_order_id', oldOrderId);
                                						$.ajax({
                                							url: "/wp-content/themes/twentytwenty/templates/tpl_backend_functions.php",
                                							method: "POST",
                                							dataType: "json",
                                							data: form_data,
                                							contentType: false,
                                							cache: false,
                                							processData: false,
                                							success: function (response) {
                                								$('#paymentAmount').val(response);
                                								document.getElementById("returnAmount").innerHTML = '$'+response;
                                								$('#customerReference').val(customerReference);
                                								$('#paymentDescription').val(paymentDescription);
                                							},
                                							error: function(xhr, textStatus, errorThrown) {
                                								console.log(errorThrown);
                                							}
                                						});
                                					});
            					
            									});
            									</script>
                        <script>
                        $(document).ready(function() {
                            $('#payOptionType').change(function() {
                                var selectedOption = $(this).val();
                                if (selectedOption === 'PayID') {
                                    $('#bsb, #accountNumber').prop('readonly', true).val('');
                                    $('#payID, #payIDType').prop('readonly', false);
                                } else if (selectedOption === 'BSB') {
                                    $('#bsb, #accountNumber').prop('readonly', false);
                                    $('#payID, #payIDType').prop('readonly', true).val('');
                                }
                            });
                        });
                        document.getElementById('transfer_to_pax').addEventListener('click', function() {
                            var clientPaymentId = document.getElementById('clientPaymentId').value;
                            var payeeName = document.getElementById('payeeName').value;
                            var payID = document.getElementById('payID').value;
                            var payOptionType = document.getElementById('payOptionType').value;
                            var payIDType = document.getElementById('payIDType').value;
                            var bsb = document.getElementById('bsb').value;
                            var accountNumber = document.getElementById('accountNumber').value;
                            var paymentDescription = document.getElementById('paymentDescription').value;
                            var customerReference = document.getElementById('customerReference').value;
                
                            // Validate lengths and patterns
                            if (payeeName.length < 5 || payeeName.length > 140) {
                                alert('Payee Name must be between 5 and 140 characters.');
                                event.preventDefault();
                            }
                            
                            if (payOptionType === '') {
                                alert('Payment type needs to be selected');
                                event.preventDefault();
                            }
                            
                            if (payOptionType === 'PayID' && payIDType === '' ) {
                                alert('PayID type needs to be selected');
                                event.preventDefault();
                            }
                
                            if (payOptionType === 'PayID' && (payID.length < 5 || payID.length > 50)) {
                                alert('PayID must be between 5 and 50 characters.');
                                event.preventDefault();
                            }
                
                            if (payOptionType === 'PayID' && payIDType === 'PHONE' && !payID.match(/^\+61-\d{9}$/)) {
                                alert('PayID must be a valid Australian phone number (+61-400000000).');
                                event.preventDefault();
                            }
                
                            if (payOptionType === 'PayID' && payIDType === 'EMAIL' && !payID.match(/^[^@\s]+@[^@\s]+\.[^@\s]+$/)) {
                                alert('PayID must be a valid email address.');
                                event.preventDefault();
                            }
                
                            if (payOptionType === 'BSB' && bsb.length !== 6) {
                                alert('BSB must be exactly 6 characters.');
                                event.preventDefault();
                            }
                
                            if (payOptionType === 'BSB' && (accountNumber.length < 4 || accountNumber.length > 12)) {
                                alert('Account Number must be between 4 and 12 characters.');
                                event.preventDefault();
                            }
                            
                            if (customerReference.length < 5 || customerReference.length > 35) {
                                alert('Customer Reference must be between 5 and 35 characters.');
                                event.preventDefault();
                            }
                            
                            if (paymentDescription.length < 5 || paymentDescription.length > 35) {
                                alert('Payment Description must be between 5 and 35 characters.');
                                event.preventDefault();
                            }
                        });
    
                        </script>
                        <?php
                        if(isset($_POST['transfer_to_pax']) )
                        {
                            $orderId = $_POST['clientPaymentId'];
							$key_md5 = md5($orderId);
							
                            $clientPaymentId = $_POST['clientPaymentId'].date("is"); // unique id
                            $payeeName = $_POST['payeeName']; // customer name
                            $paymentDescription = $_POST['paymentDescription']; // payment description
                            $customerDescription = $_POST['customerReference']; // payment description
                            $paymentAmount = number_format((float)$_POST['paymentAmount'], 2, '.', ''); // amount
                            
                            $query_is_refund_submitted = "SELECT * FROM wpk4_backend_travel_payment_outbound_azupay where order_id = '$orderId'";
        					$result_is_refund_submitted = mysqli_query($mysqli, $query_is_refund_submitted);
                            if(mysqli_num_rows($result_is_refund_submitted) == 0)
                            {
                                $payOptionType = $_POST['payOptionType']; // either payid or bsb
                                
                                $payIDType = $_POST['payIDType'] ?? ''; // payid type
                                $payID = $_POST['payID']; // email or phone
                                
                                $bsb = $_POST['bsb'];
                                $accountNumber = $_POST['accountNumber'];
                                {

                                    mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_outbound_azupay ( order_id, client_payment_id, payee_name, payment_description, customer_reference, payment_amount, payment_option_type, pay_id_type, payid, bsb, account, added_by, request_base_status ) 
                                	   values ( '$orderId', '$clientPaymentId', '$payeeName', '$paymentDescription', '$customerDescription', '$paymentAmount', '$payOptionType', '$payIDType', '$payID', '$bsb', '$accountNumber', '$emailid', 'escalated')") or die(mysqli_error($mysqli));
                                    
                                    $inserted_id = mysqli_insert_id($mysqli);
                                    $current_date_and_time = date("Y-m-d H:i:s");

                                    $payment_confirmation = transfer_payment_to_customer($orderId, $clientPaymentId, $payeeName, $paymentDescription, $customerDescription, $paymentAmount, $payOptionType, $payIDType, $payID, $bsb, $accountNumber);
                                    
                                    
                                    $mailbody= '<!DOCTYPE html>
                					<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office">
                					<head>
                					<meta charset="utf-8"> <!-- utf-8 works for most cases -->
                					<meta name="viewport" content="width=device-width"> <!-- Forcing initial-scale shouldnt be necessary -->
                					<meta http-equiv="X-UA-Compatible" content="IE=edge"> <!-- Use the latest (edge) version of IE rendering engine -->
                					<meta name="x-apple-disable-message-reformatting">  <!-- Disable auto-scale in iOS 10 Mail entirely -->
                					<title></title> <!-- The title tag shows in email notifications, like Android 4.4. -->
                					<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
                					<!-- CSS Reset : BEGIN -->
                					<style>
                					/* What it does: Stops email clients resizing small text. */
                					* {
                						-ms-text-size-adjust: 100%;
                						-webkit-text-size-adjust: 100%;
                					}
                
                					/* What it does: Centers email on Android 4.4 */
                					div[style*="margin: 16px 0"] {
                						margin: 0 !important;
                					}
                
                					/* What it does: Stops Outlook from adding extra spacing to tables. */
                					table,
                					td {
                						mso-table-lspace: 0pt !important;
                						mso-table-rspace: 0pt !important;
                					}
                
                					/* What it does: Fixes webkit padding issue. */
                					table {
                						border-spacing: 0 !important;
                						border-collapse: collapse !important;
                						table-layout: fixed !important;
                						margin: 0 auto !important;
                					}
                
                					/* What it does: Prevents Windows 10 Mail from underlining links despite inline CSS. Styles for underlined links should be inline. */
                					a {
                						text-decoration: none;
                						color: #30e3ca;
                					}
                
                					h1,h2,h3,h4,h5,h6{
                						font-family: "Lato", sans-serif;
                						color: #000000;
                						margin-top: 0;
                						font-weight: 400;
                					}
                
                					body{
                						font-family: "Lato", sans-serif;
                						font-weight: 400;
                						font-size: 13px;
                						line-height: 1.8;
                						color: rgba(0,0,0,.4);
                					}
                
                					.hero .text{
                						color: rgba(0,0,0,.3);
                					}
                					.hero .text h2{
                						color: #000;
                						font-size: 20px;
                						margin-bottom: 0;
                						font-weight: 400;
                						line-height: 1.4;
                					}
                					.hero .text h3{
                						font-size: 17px;
                						font-weight: 300;
                					}
                					.hero .text h2 span{
                						font-weight: 600;
                						color: #30e3ca;
                					}
                
                
                					ul.social{
                						padding: 0;
                					}
                					ul.social li{
                						display: inline-block;
                						margin-right: 10px;
                					}
                					</style>
                					</head>
                					<body width="100%" style="margin: 0; padding: 0 !important; mso-line-height-rule: exactly; background-color: #f1f1f1;">
                						<center style="width: 100%; background-color: #f1f1f1;">
                						<div style="display: none; font-size: 1px;max-height: 0px; max-width: 0px; opacity: 0; overflow: hidden; mso-hide: all; font-family: sans-serif;">
                						  &zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;
                						</div>
                						<div style="max-width: 600px; margin: 0 auto;" class="email-container">
                						
                						
                					<table class="wp-travel-wrapper" style="color: #5d5d5d; font-family: Roboto, sans-serif; margin: auto;" width="100%" cellspacing="0" cellpadding="0">
                					<tbody>
                					<tr class="wp-travel-content" style="background: #fff;">
                					<td class="wp-travel-content-top" style="background: #fff; margin: 0; padding: 30px 25px;" colspan="2" align="left">
                						<table role="presentation" border="0" cellpadding="0" cellspacing="0" width="100%">
                						<tr>
                						<td class="logo" style="text-align: center;">
                						<img src="https://gauratravel.com.au/wp-content/uploads/2022/01/cropped-GauraTravel_logo_small_2.png" style="width:200px; text-align:center;"/>
                						</td>
                						</tr>
                						</table>
                					</td>
                					</tr>
                					<tr class="wp-travel-content" style="background: #fff;">
                					<td class="wp-travel-content-top" style="background: #fff; margin: 0; padding: 20px 25px;" colspan="2" align="left">
                					Dear Valued Customer,
                					</td></tr>';
                					//echo '<pre>';
                					//print_r($payment_confirmation);
                					//echo '</pre>';
                                    if(isset($payment_confirmation) && isset($payment_confirmation['paymentId']))
                                    {
                                        echo '<script>alert("Payment has been processed.");</script>';
                                         
                                        $azupayStatus = $payment_confirmation['status'];
                                        $azupayPaymentID = $payment_confirmation['paymentId'];
                                        $azupayCreatedDate = date("Y-m-d H:i:s", strtotime( $payment_confirmation['createdDatetime'] ));
                                        $azupayNPPTransactionID = $payment_confirmation['nppTransactionId'];
                                        $azupayCurrentBalance = $payment_confirmation['currentBalance'];
                                        
                                        $sql_update ="UPDATE wpk4_backend_travel_payment_outbound_azupay
                                                        SET azupay_status = '$azupayStatus', azupay_payment_id = '$azupayPaymentID', azupay_created_time = '$azupayCreatedDate', azupay_npp_id = '$azupayNPPTransactionID', azupay_current_balance = '$azupayCurrentBalance', second_confirmed_by = 'customer', request_base_status = 'processed', second_confirmed_on = '$current_date_and_time'
                                                        WHERE auto_id = '$inserted_id'";
                                        $results_update = $wpdb->query($sql_update);  
                                        
                                        $paymentAmountNegative = '-'.$paymentAmount;
                                        
                                        $existing_deadline_for_deposit = date("Y-m-d H:i:s", strtotime("+4 days", strtotime(date("Y-m-d").' 23:59:59')));
                                        
                                        $query_get_deadline = "SELECT * FROM wpk4_backend_travel_payment_history where order_id = '$orderId' and CAST(trams_received_amount AS DECIMAL(10,2)) = CAST($paymentAmount AS DECIMAL(10,2)) ";
                    					$result_get_deadline = mysqli_query($mysqli, $query_get_deadline);
                                        if(mysqli_num_rows($result_get_deadline) > 0)
                                        {
                                            $row_get_deadline = mysqli_fetch_assoc($result_get_deadline);
                                            $existing_deadline_for_deposit = $row_get_deadline['payment_change_deadline'];
                                        }
                                        
										
										$query_get_deadline2 = "SELECT auto_id FROM wpk4_backend_travel_bookings where order_id = '$orderId' and payment_status = 'partially_paid' ";
                    					$result_get_deadline2 = mysqli_query($mysqli, $query_get_deadline2);
                                        if(mysqli_num_rows($result_get_deadline2) > 0)
                                        {
											availability_table_pax_update($orderId, 'customer');
										}
                                        
                                        $sql_update2 ="UPDATE wpk4_backend_travel_bookings
                                                        SET payment_status = 'refund', late_modified = '$current_date_and_time', modified_by = 'customer'
                                                        WHERE order_id = '$orderId'";
                                        $results_update2 = $wpdb->query($sql_update2); 

										
                                        
                                        mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history ( order_id, reference_no, trams_remarks, payment_method, trams_received_amount, process_date, added_on, added_by, payment_request_id, pay_type, payment_change_deadline) 
                                	    values ( '$orderId', '$clientPaymentId', '$paymentDescription', '7', '$paymentAmountNegative', '$current_date_and_time', '$current_date_and_time', 'customer', '$azupayPaymentID', 'Refund', '$existing_deadline_for_deposit')") or die(mysqli_error($mysqli));
                                        
                                       
                                        //echo '<script>window.location.href="?p=my-bookings";</script>';   
                                        
                                        $mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                            						<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 25px 8px 25px;" colspan="2" align="left">
                            						Thank you for your recent interest in our services.	
                            						</td></tr>';
                            						
                                		$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                                						<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 25px 8px 25px;" colspan="2" align="left">
                                						We wish to inform you that our deposit refund has been processed and credited to your account.	
                                						</td></tr>';
                                						
                                        $mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                                						<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 25px 8px 25px;" colspan="2" align="left">
                                						If you do not receive your refund, please contact our customer service department at 1300 359 463 or gaura.customercare@gmail.com , and we will promptly investigate the matter.	
                                						</td></tr>';
                                						
                                		$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                                						<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 25px 8px 25px;" colspan="2" align="left">
                                						Sorry we could not serve you this time. Visit again soon!	
                                						</td></tr>';
                                		
                                		$emailsubject = 'Confirmation of Your Deposit Refund - #' . $orderId;  
                                		
                                    }
                                    else
                                    {
                                        echo '<script>alert("Payment processing failed. Kindly contact our refund agents.");</script>';
                                        
                                        //error_log("Azupay Outbound Payment Issue: $payment_confirmation");
                                        $sql_update ="UPDATE wpk4_backend_travel_payment_outbound_azupay
                                                        SET error_response = '$payment_confirmation', second_confirmed_by = 'customer', request_base_status = 'failed', second_confirmed_on = '$current_date_and_time'
                                                        WHERE auto_id = '$inserted_id'";
                                        $results_update = $wpdb->query($sql_update); 
                                        
                                        
                                        $mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                            						<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 25px 8px 25px;" colspan="2" align="left">
                            						Thank you for your recent interest in our services. 	
                            						</td></tr>';
                            						
                                		$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                                						<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 25px 8px 25px;" colspan="2" align="left">
                                						Due to the error, refund is not processed. 	
                                						</td></tr>';
                                						
                                        $mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                                						<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 25px 8px 25px;" colspan="2" align="left">
                                						Please contact our customer service department at 1300 359 463 or gaura.customercare@gmail.com , and we will promptly investigate the matter.	
                                						</td></tr>';
                                						
                                		$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                                						<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 25px 8px 25px;" colspan="2" align="left">
                                						We appreciate your understanding and hope to have the opportunity to serve you in the future. Please don&apos;t hesitate to reach out if you have any questions or require further assistance.	
                                						</td></tr>';
                                						
                                		$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                                						<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 25px 8px 25px;" colspan="2" align="left">
                                						Sorry we could not serve you this time. Visit again soon!	
                                						</td></tr>';
                                						
                                		$emailsubject = 'Failed Refund - #' . $orderId;  
                            						
                                    }

                            		$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                            						<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 25px 8px 25px;" colspan="2" align="left">
                            						Sincerely,</br>
                                                    Customer Care</br>
                                                    Gaura Travel	
                            						</td></tr>';
                            		
                					$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                						<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left"> </td></tr>';
                							
                					$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
                						<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 40px 25px;" colspan="2" align="left">
                						</td></tr>';
                					$mailbody .=  '</tbody>
                					</table>
                					</div>
                					</center>
                					</body>
                					</html>';
                					$mailbody=stripslashes($mailbody);
                					
                					$path = '';
                					
    
                // 						include_once (ABSPATH . WPINC . '/class-phpmailer.php');
                //                         include_once (ABSPATH . WPINC . '/PHPMailer/SMTP.php');
                                                
                // 						$mail = new PHPMailer ();
                // 						$mail->IsSMTP();								//Sets Mailer to send message using SMTP
                // 						$mail->Host = 'tls://smtp.office365.com:587';		//Sets the SMTP hosts of your Email 
                // 						$mail->Port = '587';								//Sets the default SMTP server port
                // 						$mail->SMTPAuth = true;							//Sets SMTP authentication. Utilizes the Username and Password variables
                // 						$mail->Username = 'donotreply@gauratravel.com.au';					//Sets SMTP username
                // 						$mail->Password = 'P/738625763818ob';					//Sets SMTP password
                // 						$mail->SMTPSecure = 'tls';							//Sets connection prefix. Options are "", "ssl" or "tls"
                // 						$mail->From = 'donotreply@gauratravel.com.au';			//Sets the From email address for the message
                // 						$mail->FromName = 'Gaura Travel';			//Sets the From name of the message
                // 						$mail->AddAddress($emailid, "");		//Adds a "To" address $orderemailid
                // 						$mail->WordWrap = 50;							//Sets word wrapping on the body of the message to a given number of characters
                // 						$mail->IsHTML(true);							//Sets message type to HTML
                // 						$mail->Subject = $emailsubject;			//Sets the Subject of the message
                // 						$mail->Body = $mailbody;
    
                // 						if($mail->Send())							 
            				// 			{
            								
            				// 			}
                                        
										
										echo '<script>window.location.href="?p=booking&orderID='.$orderId.'&key='.$key_md5.'";</script>';
                                }
								echo '<script>window.location.href="?p=booking&orderID='.$orderId.'&key='.$key_md5.'";</script>';
                            }
                            
                            echo '<script>window.location.href="?p=booking&orderID='.$orderId.'&key='.$key_md5.'";</script>';
                        }
                    }
                    else
                    {
                        echo 'Kindly try again later.';
                    }
                }
                
                if( isset($_GET['p']) && $_GET['p'] == 'edit-request-refund')
                {
                    $query_pax = "SELECT * FROM wpk4_customer_accounts where uid = '$user_id'";
					$result_pax = mysqli_query($mysqli, $query_pax);
					$query_px = mysqli_fetch_assoc($result_pax);
					$trav_date = date("Y-m-d H:i:s");
					$fullname = $query_px['full_name'];
					$emailid = $query_px['email'];
					$orderId = $_GET['oid'];
					if($query_px['phonenumber'] != '')
					{
						$user_phonenumber = $query_px['phonenumber'];
					}
					else
					{
						$user_phonenumber = '0123456789012345';
					}
					if(isset($emailid) && $emailid != '' && isset($user_id) && $user_id != '')
					{
					   
                    $query_is_refund_submitted = "SELECT * FROM wpk4_backend_travel_payment_outbound_azupay where order_id = '$orderId' and request_base_status = 'escalated'";
                    $result_is_refund_submitted = mysqli_query($mysqli, $query_is_refund_submitted);
                    if(mysqli_num_rows($result_is_refund_submitted) > 0)
                    {
                        $row_payments = mysqli_fetch_assoc($result_is_refund_submitted); 
                        ?>
                        <h4>Edit deposit refund request</h4>
                        <style>
                        .accounts_general_button
                        {
                            width: 130px;
                            padding:8px 12px;
                            font-size: 11px;
                            float:right;
                            margin:0px 5px;
                        }
                        .form-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 10px;
                        }
                        .form-group {
                            display: flex;
                            flex-direction: column;
                            flex-basis: 48%;
                        }
                        .form-group-full-width {
                            display: flex;
                            flex-direction: column;
                            flex-basis: 100%; 
                        }
                        label {
                            margin-bottom: 5px;
                        }
                        input, select {
                            width: 100%;
                            padding: 8px;
                            box-sizing:
                        }
                        </style>
                        <form id="paymentForm" action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="payeeName">Payee Name:</label>
                                    <input type="text" id="payeeName" name="payeeName" value="<?php echo $row_payments['payee_name']; ?>" required>
                                </div>
                            </div>
                            
                            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                                        <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
                                        <script>
                        				    function openCity(evt, cityName) {
                                    		  var i, tabcontent, tablinks;
                                    		  tabcontent = document.getElementsByClassName("tabcontent");
                                    		  for (i = 0; i < tabcontent.length; i++) {
                                    			tabcontent[i].style.display = "none";
                                    		  }
                                    		  tablinks = document.getElementsByClassName("tablinks");
                                    		  for (i = 0; i < tablinks.length; i++) {
                                    			tablinks[i].className = tablinks[i].className.replace(" active", "");
                                    		  }
                                    		  document.getElementById(cityName).style.display = "block";
                                    		  evt.currentTarget.className += " active";
                                    		  
                                    		    document.getElementById('payOptionType').value = cityName;
                                    		}
                        				</script>
                                        <style>
                        				.blink_me {
                                            animation: blinker 2s linear infinite;
                                            margin:0;
                                            padding:0;
                                        }
                                            
                                        @keyframes blinker {
                                            50% {
                                                opacity: 0;
                                            }
                                        }
                        				.search_bookings a, button, input[type=submit]
                        				{
                        				    background-color:#ffbb00;
                        				    color:black;
                        				}
                        				.tabnavigation
                        				{
                        				    float:left;
                        				    left:0;
                        				}
                            			.chatcategory
                            			{
                                			padding:7px 10px; 
                                			margin:0;
                                			font-size:13px;
                            			}
                            			.tab .active
                            			{
                            			    color:#FFF !important;
                            			    background-color:#000 !important
                            			}
                            			.ssr_request_radio_button {
                            			    margin-top: 10px; display: block;
                                            flex-wrap: wrap;
                                        }
                                        .ssr_request_radio_button label.radio {
                                         display:inline;
                                         position:relative;
                                         margin-left: 0.2em;
                                         _top:0.2em;
                                         }
                                         
                                         .radio-group {
                                                display: flex;
                                                align-items: center;
                                            }
                                            
                                            .radio-group label {
                                                margin-right: 10px;
                                                margin-top:13px;
                                            }
                                            .badge.badge-primary {
                                                background-color: #149efa;
                                            }
                                            
                                            .badge {
                                                display: inline-block;
                                                min-width: 10px;
                                                padding: 3px 7px;
                                                font-size: 12px;
                                                font-weight: 700;
                                                line-height: 1;
                                                color: #fff;
                                                text-align: center;
                                                white-space: nowrap;
                                                vertical-align: middle;
                                                background-color: #777;
                                                border-radius: 10px;
                                            }
            
            
                            			</style>
                            			<div class="tabnavigation search_bookings">
                            				<div class="tab">
            
                                				<a class="tablinks chatcategory active" onclick="openCity(event, 'PayID')">PayID</a>
                                				
                                				<a class="tablinks chatcategory" onclick="openCity(event, 'BSB')">BSB & Account</a>
                                				
                                			</div>
                            			</div>
                        				</br></br>
                        				<div id="tabcontent_main" style="font-size:14px;">
                        				    <div id="PayID" class="tabcontent" >
                        				        <div class="form-row">
                                                    <div class="form-group">
                                                        <label for="payIDType">PayID Type:</label>
                                                        <select id="payIDType" name="payIDType">
                                                            <option value="" selected disabled>Select</option>
                                                            <option value="PHONE">Phone</option>
                                                            <option value="EMAIL">Email</option>
                                                        </select>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="payID">PayID:</label>
                                                        <input type="text" placeholder="+61-123456789 / testuser@gmail.com" value="<?php echo $row_payments['payid']; ?>" id="payID" name="payID">
                                                    </div>
                                                </div>
                        				    </div>
                        				    
                        				    <div id="BSB" class="tabcontent" style="display:none;">
                        				        <div class="form-row">
                                                    <div class="form-group">
                                                        <label for="bsb">BSB:</label>
                                                        <input type="text" id="bsb" placeholder="123456" value="<?php echo $row_payments['bsb']; ?>" name="bsb">
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="accountNumber">Account Number:</label>
                                                        <input type="text" placeholder="12345678" id="accountNumber" value="<?php echo $row_payments['account']; ?>" name="accountNumber">
                                                    </div>
                                                </div>
                        				    </div>
                        				</div>
                        			</br>
                        		<span style="font-size:11px;">* Please recheck the name and order information before proceeding the transfer.</span>	    
                        		</br>		        
                            </br>
                            <input type="submit" name="transfer_to_pax2" id="transfer_to_pax2" value="Transfer Payment">
                        </form>
                        <?php
                        }
                        ?>
                        <script>
$(document).ready(function() {
    
    $(document).on('change', '#clientPaymentId', function(){
		var oldOrderId = $(this).val();
		var customerReference = 'Refund for '+ oldOrderId;
		var paymentDescription = 'CP Refund for '+ oldOrderId;
		var form_data = new FormData();
		form_data.append('get_paid_amount_for_adjustment', 'deposit_amount_adjustment_from_customerportal');
		form_data.append('old_order_id', oldOrderId);
		$.ajax({
			url: "/wp-content/themes/twentytwenty/templates/tpl_backend_functions.php",
			method: "POST",
			dataType: "json",
			data: form_data,
			contentType: false,
			cache: false,
			processData: false,
			success: function (response) {
				$('#paymentAmount').val(response);
				document.getElementById("returnAmount").innerHTML = '$'+response;
				$('#customerReference').val(customerReference);
				$('#paymentDescription').val(paymentDescription);
			},
			error: function(xhr, textStatus, errorThrown) {
				console.log(errorThrown);
			}
		});
	});

});
$(document).ready(function() {
    $('#payOptionType').change(function() {
        var selectedOption = $(this).val();
        if (selectedOption === 'PayID') {
            $('#bsb, #accountNumber').prop('readonly', true).val('');
            $('#payID, #payIDType').prop('readonly', false);
        } else if (selectedOption === 'BSB') {
            $('#bsb, #accountNumber').prop('readonly', false);
            $('#payID, #payIDType').prop('readonly', true).val('');
        }
    });
});
document.getElementById('transfer_to_pax').addEventListener('click', function() {
    var clientPaymentId = document.getElementById('clientPaymentId').value;
    var payeeName = document.getElementById('payeeName').value;
    var payID = document.getElementById('payID').value;
    var payOptionType = document.getElementById('payOptionType').value;
    var payIDType = document.getElementById('payIDType').value;
    var bsb = document.getElementById('bsb').value;
    var accountNumber = document.getElementById('accountNumber').value;
    var paymentDescription = document.getElementById('paymentDescription').value;
    var customerReference = document.getElementById('customerReference').value;

    // Validate lengths and patterns
    if (payeeName.length < 5 || payeeName.length > 140) {
        alert('Payee Name must be between 5 and 140 characters.');
        event.preventDefault();
    }
    
    if (payOptionType === '') {
        alert('Payment type needs to be selected');
        event.preventDefault();
    }
    
    if (payOptionType === 'PayID' && payIDType === '' ) {
        alert('PayID type needs to be selected');
        event.preventDefault();
    }

    if (payOptionType === 'PayID' && (payID.length < 5 || payID.length > 50)) {
        alert('PayID must be between 5 and 50 characters.');
        event.preventDefault();
    }

    if (payOptionType === 'PayID' && payIDType === 'PHONE' && !payID.match(/^\+61-\d{9}$/)) {
        alert('PayID must be a valid Australian phone number (+61-400000000).');
        event.preventDefault();
    }

    if (payOptionType === 'PayID' && payIDType === 'EMAIL' && !payID.match(/^[^@\s]+@[^@\s]+\.[^@\s]+$/)) {
        alert('PayID must be a valid email address.');
        event.preventDefault();
    }

    if (payOptionType === 'BSB' && bsb.length !== 6) {
        alert('BSB must be exactly 6 characters.');
        event.preventDefault();
    }

    if (payOptionType === 'BSB' && (accountNumber.length < 4 || accountNumber.length > 12)) {
        alert('Account Number must be between 4 and 12 characters.');
        event.preventDefault();
    }
    
    if (customerReference.length < 5 || customerReference.length > 35) {
        alert('Customer Reference must be between 5 and 35 characters.');
        event.preventDefault();
    }
    
    if (paymentDescription.length < 5 || paymentDescription.length > 35) {
        alert('Payment Description must be between 5 and 35 characters.');
        event.preventDefault();
    }
});

</script>
                        <?php
                        if(isset($_POST['transfer_to_pax2']) )
                        {
                            $orderId = $_GET['oid'];
                            
                            
                            $payeeName = $_POST['payeeName']; // customer name

                            $query_is_refund_submitted = "SELECT * FROM wpk4_backend_travel_payment_outbound_azupay where order_id = '$orderId'";
        					$result_is_refund_submitted = mysqli_query($mysqli, $query_is_refund_submitted);
                            if(mysqli_num_rows($result_is_refund_submitted)  > 0)
                            {
                                $autoId = $_GET['id'];
                                $payOptionType = $_POST['payOptionType'] ?? 'PayID'; // either payid or bsb
                                $payIDType = $_POST['payIDType'] ?? ''; // payid type
                                $payID = $_POST['payID']; // email or phone
                                $bsb = $_POST['bsb'];
                                $accountNumber = $_POST['accountNumber'];
                                $sql_update_pax_new = "UPDATE wpk4_backend_travel_payment_outbound_azupay SET payee_name = '$payeeName', payment_option_type = '$payOptionType', pay_id_type = '$payIDType', payid = '$payID', bsb = '$bsb', account = '$accountNumber' 
                                    WHERE auto_id = '$autoId'";
                                $result_status_new = mysqli_query($mysqli, $sql_update_pax_new) or die(mysqli_error($mysqli));
                            }
                             echo '<script>alert("Update has been done");</script>';
                             echo '<script>window.location.href="?";</script>';
                        }
                    }
                    else
                    {
                        echo 'Kindly try again later.';
                    }
                }
					
				if(isset($_GET['p']) && $_GET['p'] =='dashboard' && $_SESSION['userId'] != '') //customer dashboard
				{
					$user_id = $_SESSION['userId'];
					$query_pax = "SELECT * FROM wpk4_customer_accounts where uid = '$user_id'";
    				$result_pax = mysqli_query($mysqli, $query_pax);
    				$query_px = mysqli_fetch_assoc($result_pax);
    					
    				$fullname = get_user_fullname($user_id);
    			    $emailid = get_user_emailid($user_id);

    				if(mysqli_num_rows($result_pax) > 0 && $query_px['phonenumber'] != '')
					{
						$user_phonenumber = $query_px['phonenumber'];
					}
					else
					{
						$user_phonenumber = '0123456789012345';
					}
					?>
					Hi <?php echo $fullname; ?>,
					Please click on the relevant section to proceed your request further. </br></br>
					<div class="row">
					  <div class="col-sm-12" >	
						<?php
						$array_case_types = array();
						$query = "SELECT case_type FROM wpk4_backend_user_portal_requests where user_id='$user_id' OR user_id='1'";
						$result = mysqli_query($mysqli, $query);
						while($row = mysqli_fetch_assoc($result))
						{
							$array_case_types[] = $row['case_type'];
						}
						$array_case_types = array_unique($array_case_types);

						foreach($array_case_types as $order_array_cae_type)
						{
							$request_type_first_letter = substr($order_array_cae_type,0,1);
						
							?>
						<h4>My <?php echo ucfirst($order_array_cae_type); ?> Requests </h4>
						<table class="table" style="width:100%;">
							<thead>
							<tr>
							<th width='25%'>Request Date</th>
							<th width='35%'>Subject</th>
							<th width='30%'>Status</th>
							<th></th>
						  </tr>
						  </thead>
						  <tbody>
						<?php
						$x_id = 1;
						$query = "SELECT * FROM wpk4_backend_user_portal_requests where case_type = '$order_array_cae_type' AND (user_id = '$user_id' OR user_id = '$sub_customer_login_id' ) order by case_id DESC limit 10";
						$result = mysqli_query($mysqli, $query);
						while($row = mysqli_fetch_assoc($result))
						{
							
							$case_id = $row['case_id'];
							$case_type = $row['case_type'];
							$enc_auto_id = md5($case_id);
							$reservation_ref = $row['reservation_ref'];
							$status = $row['status'];
							$case_date = $row['case_date'];
							$last_response_by = $row['last_response_by'];
								?>
								<tr>
									<td><?php echo $row['case_date']; ?></td>
									<td><?php echo $row['reservation_ref']; ?></td>
									<td>
									<?php
									if($status == 'open' )
									{
									?>
									<?php if($last_response_by =='admin') { echo '<span class="badge badge-primary">Awaiting for reply</span>'; } else { echo '<span class="badge badge-warning">Awaiting for GT Reply</span>'; } ?>
									<?php
									}
									?>
									<?php
									if($status == 'open' || $status == 'success')
									{
									?>
									<span class="badge badge-success"><?php echo $row['status']; ?></span> 
									<?php
									}
									else
									{
									?>
									<span class="badge badge-danger"><?php echo $row['status']; ?></span> 
									<?php	
									}
									?>
									</td>
									<td><a href="?p=my-request-view&id=<?php echo $case_id; ?>&co=<?php echo $enc_auto_id; ?>&t=<?php echo $request_type_first_letter; ?>&casetype=<?php echo $case_type; ?>" class="btn btn-success">View</a></a>
									</td>
								</tr>
								<?php
							 $x_id++;
						}
						?>
						</tbody>
						</table>
						</br>
						<?php
						}
						?>
		</div></div>
				<?php	
				}
				
				if(isset($_GET['p']) && $_GET['p'] == 'my-request-view') //customer view perticular request
				{
					$case_id = $_GET['id'];	
					$enc_auto_id = md5($case_id);	
					$enc_auto_id_url = $_GET['co'];	
					$casetype = '';
					if(isset($_GET['casetype']))
					{
					    $casetype = $_GET['casetype'];
					}
					?>
					<h5>My Request</h5>
					<?php
					$x_id = 1;
					if($enc_auto_id == $enc_auto_id_url)
					{
						$query = "SELECT * FROM wpk4_backend_user_portal_requests where case_id = '$case_id' AND ( user_id='$user_id' OR user_id='$sub_customer_login_id' )";
						$result = mysqli_query($mysqli, $query);
						$row = mysqli_fetch_assoc($result);
                        if(mysqli_num_rows($result) > 0)
                        {
								$user_id = $row['user_id'];
								$order_id = $row['reservation_ref'];
								$status = $row['status'];
								$sub_status = $row['sub_status'];
								$request_date = $row['case_date'];
								if(strlen($row['updated_by']) < 20 )
        						{
        						    $updated_by = $row['updated_by'];
        						}
        						else
        						{
        						    $updated_by = get_user_fullname($row['updated_by']);
        						}
								$last_response_by = $row['last_response_by'];
								$priority = $row['priority'];
								
								$subject = get_userportal_post_meta($case_id, 'subject');
							$user_fullname = '';
							$emailid = '';
							$query_userfinder = "SELECT * FROM wpk4_customer_accounts where uid = '$user_id'";
							$result_userfinder = mysqli_query($mysqli, $query_userfinder);
							if(mysqli_num_rows($result_userfinder) > 0)
							{
							    $row_userfinder = mysqli_fetch_assoc($result_userfinder);
    							$user_fullname = $row_userfinder['full_name'];
    							$emailid = $row_userfinder['email'];
								if($query_px['phonenumber'] != '')
					{
						$user_phonenumber = $query_px['phonenumber'];
					}
					else
					{
						$user_phonenumber = '0123456789012345';
					}
							}
							?>	
							<div class="tab-pane message-body active" id="inbox-message-1">
									<div class="message-chat">
										<div class="chat-body">

								<div class="table-responsive margin-bottom-2x header-msgbox" style='background-color: #f3f8fb; padding: 20px 5px;'>
								<div class="wpb_wrapper">
								<div class="vc_row wpb_row vc_inner vc_row-fluid vc_row-o-equal-height " style="display: flex;">
									<div class="wpb_column vc_column_container vc_col-sm-6">
										<div class="vc_column-inner">
											<div class="wpb_wrapper">
												<div class="wpb_text_column wpb_content_element ">
													<div class="wpb_wrapper">
									<h5>Case ID #<?php echo $case_id; ?> - <?php echo $casetype; ?></h5>
									<h4><?php echo (strlen($subject) > 70 ? substr($subject, 0, 70).'...' : $subject); ?></h4>
								</div>
												</div>
											</div>
										</div>
									</div>
									<div class="wpb_column vc_column_container vc_col-sm-6" >
										<div class="vc_column-inner">
											<div class="wpb_wrapper">
												<div class="wpb_text_column wpb_content_element">
													<div class="wpb_wrapper" style='float:right;'>
									<?php
								if($row['status'] == 'open' || $row['status'] == 'success')
								{
								?>
								<span class="badge badge-success"><?php echo $row['status']; ?></span> 
								<?php
								}
								else
								{
								?>
								<span class="badge badge-danger"><?php echo $row['status']; ?></span> 
								<?php	
								}
								if($last_response_by =='admin') { echo '<span class="badge badge-primary">Awaiting for reply</span>'; } else { echo '<span class="badge badge-warning">Awaiting for GT Reply</span>'; } ?>			
								<h5 style="margin-top:10px;">on <?php echo $request_date; ?> by <?php if($user_fullname != '') { echo $user_fullname; } else { echo $user_id; } ?></h5>
								<h6><?php if($updated_by !='') { echo 'Handled by '.$updated_by; } else { echo 'Not Assigned Staff'; } ?></h6>
								</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
								</div></br>
							<br><br>

							<div id='reloadornot'></div>
							<div id='chatboxwindow'></div>
							</div>
							<div class='messagebox'>
							Add Reply..</br>
							<?php
								if($status == 'open')
								{
								?>
							<form action="#" method="post" enctype="multipart/form-data">
							<div class="chat-footer">
							<textarea rows='9' name='replymessage' id='replymessage'  class="send-message-text" style='height:190px;'></textarea>

							<button type="submit" name='make_reply' id='make_reply' class="send-message-button btn-info"> <i class="fa fa-send"></i> </button>
							<button type="submit" onclick="uploadFile();" name='attachfile_id' id='attachfile_id' class="send-message-button2 btn-success" > <i class="fa fa-paperclip"></i> </button>
							<input type="file" style="visibility: hidden;opacity:0;z-index: -1;" accept=".jpg,.jpeg,.png,.pdf" class='myattachmentchat' name="myattachmentchat" id="myattachmentchat">
							<div id='uploaded_image'></div>
							</div>
							</form>
							<?php
							}
							else
							{
							?>
							<div class="chat-footer">
							<textarea rows='7' disabled name='replymessage' required class="send-message-text"></textarea>
							<button type="submit" disabled name='make_reply' class="send-message-button btn-info"> <i class="fa fa-send"></i> </button>
							<button type="submit" disabled onclick="uploadFile();" name='attachfile_id' id='attachfile_id' class="send-message-button2 btn-success" > <i class="fa fa-paperclip"></i> </button>
							<input type="file" disabled accept=".jpg,.jpeg,.png,.pdf" class='myattachmentchat' name="myattachmentchat" id="myattachmentchat">
										<div id='uploaded_image'></div>
							</div>
							<?php	
							}
							?>
							</div>
							</div>
							</div>
 <style>
									#myattachmentchat 
									{ 
										visibility: hidden; 
									}
		</style>
		<script>
			$('#attachfile_id').click(function(){
				$('#myattachmentchat').click();
			});
			
			
			

	$(document).ready(function(){
	 $(document).on('change', '#myattachmentchat', function(){
		//alert('checking');
	  var name = document.getElementById("myattachmentchat").files[0].name;
	  
	  var form_data = new FormData();
	  var ext = name.split('.').pop().toLowerCase();
	  if(jQuery.inArray(ext, ['png','jpg','jpeg','pdf']) == -1) 
	  {
	   alert("Invalid Image File");
	  }
	  var oFReader = new FileReader();
	  oFReader.readAsDataURL(document.getElementById("myattachmentchat").files[0]);
	  var f = document.getElementById("myattachmentchat").files[0];
	  var fsize = f.size||f.fileSize;
	  if(fsize > 2000000)
	  {
	   alert("Image File Size is very big");
	  }
	  else
	  {
		
	var urlParams = new URLSearchParams(window.location.search);
	var request_id = urlParams.get('id');

	var reply_type_for = urlParams.get('casetype');
	var response_by = <?php echo json_encode($user_id) ?>;
	
	form_data.append( "image_submit" , "yes" );
	form_data.append( "request_id" , request_id );
	form_data.append( "responsetypenote" , 'chat' );
	form_data.append( "teammembers" , '' );
	form_data.append( "reply_type_for" , reply_type_for );
	form_data.append( "response_by" , response_by );
	form_data.append( "usertype_u" , "customer" );
	
	form_data.append("myattachmentchat", document.getElementById('myattachmentchat').files[0]);
	   $.ajax({
		url:"/wp-content/themes/twentytwenty/templates/tpl_user_portal_backend.php",
		method:"POST",
		dataType: "json",
		data: form_data,
		contentType: false,
		cache: false,
		processData: false,
		beforeSend:function(){
			//$('#uploaded_image').html("<label class='text-success'>Image Uploading...</label>");
		},   
		success:function(data)
		{
			//$('#uploaded_image').html(data);
		}
	   });
	  }
	 });
	});

window.setInterval( function isnewupdate() {
var urlParams = new URLSearchParams(window.location.search);
var str = urlParams.get('id');
var chattype = urlParams.get('casetype');
var last_updated_value = $("#last_updated_id").val();
  if (str == "") {
	return;
  } else {
	var xmlhttp = new XMLHttpRequest();
	xmlhttp.onreadystatechange = function() {
	  if (this.readyState == 4 && this.status == 200) {
		var reloadchecker = $("#reloadchecker").val();
		document.getElementById("reloadornot").innerHTML = this.responseText;
		if(reloadchecker=='reload') // have new update_priority
		{
			showChats();
		}
	  }
	};
	xmlhttp.open("GET","<?php echo $themepath; ?>/templates/tpl_user_portal_backend.php/?checknewupdate="+str+"&reply_type_for="+chattype+"&lastvalue="+last_updated_value,true);
	xmlhttp.send();
  }
}, 5000);

$(document).ready(function() {
	showChats();
});

function showChats() {
var urlParams = new URLSearchParams(window.location.search);
var str = urlParams.get('id');
var chattype = urlParams.get('casetype');
  if (str == "") {
	return;
  } else {
	var xmlhttp = new XMLHttpRequest();
	xmlhttp.onreadystatechange = function() {
	  if (this.readyState == 4 && this.status == 200) {
		document.getElementById("chatboxwindow").innerHTML = this.responseText;
	  }
	};
	xmlhttp.open("GET","<?php echo $themepath; ?>/templates/tpl_user_portal_backend.php/?view_responses="+str+"&usertype_u=customer&reply_type_for="+chattype,true);
	xmlhttp.send();
  }
}
</script>
<script type="text/javascript">
$( "form" ).submit(function( event ) {
  event.preventDefault();
});

$("#make_reply").click(function(){
 //get the form values
var form_data = new FormData();
var urlParams = new URLSearchParams(window.location.search);
var request_id = urlParams.get('id');
var responsetypenote = 'chat';
var replymessage = $("#replymessage").val();
//var replymessage_2 = replymessage.replace(/([<>*()?])/g, "\$1");
if(replymessage != '' && replymessage != ' ')
{
var replymessage_2 = replymessage.replace(/[<>*()?'"]/g, function(match) { return '\\' + match;
});

var reply_type_for = urlParams.get('casetype');
var response_by = <?php echo json_encode($user_id) ?>;
var make_reply = $("#make_reply").val();

	form_data.append( "usertype_u" , "customer" );
	form_data.append( "request_id" , request_id );
	form_data.append( "responsetypenote" , responsetypenote );
	form_data.append( "replymessage" , replymessage_2 );
	form_data.append( "make_reply" , make_reply );
	form_data.append( "response_by" , response_by );
	form_data.append( "reply_type_for" , reply_type_for );
	
 $.ajax({
	url : "<?php echo $themepath; ?>/templates/tpl_user_portal_backend.php",
	type: "POST",
	data : form_data,
	dataType: "json",
	contentType: false,
	cache: false,
	processData: false,
	success: function(data)
	{
		//if success then just output the text to the status div then clear the form inputs to prepare for new data
		$("#status_text").html('');
		$('#replymessage').val('');
		document.getElementById("status_text").value = '';
		document.getElementById("replymessage").value = '';
	},
	error: function (jqXHR, status, errorThrown)
	{
		$("#status_text").html('there was an error updating the message');
	}
});

	clearchatbox();
}
});
function clearchatbox()
{
	$("#status_text").html('');
	$('#replymessage').val('');
	document.getElementById("status_text").value = '';
	document.getElementById("replymessage").value = '';
}
</script>
					    <?php
                        }
					}
					?>

							</br>
							<script>
							$('#bankinfo').on('shown.bs.modal', function () {
							  $('#bankinfo').trigger('focus')
							})
							</script>
							<?php	
				}
				// END VIEW PAGES
				// START COMPLAINT PAGES
				if(isset($_GET['p']) && $_GET['p'] =='complaint-submission') //customer submit complaint
				{ 
					?>
						<style>
						#otherissues, #otherissuesbreak  { display: none; }
						</style>	
							<h3>Complaint Submission Form</h3>
							<p>We are unhappy to see you dissatisfied. Please elaborate more to make us try our best to resolve the matter.</p>
						</br>
						<form action="#" method="post" enctype="multipart/form-data">
							<p class='fieldnotelable'>Customer Name <font class='redstar'>*</font></p>
							<input type='text' required onkeypress="return isTextKey(event)" name='customername' placeholder='Name' >
								</br>
							<p class='fieldnotelable'>Reservation Code/ Order ID <font class='redstar'>*</font></p>
							<input type='text' required name='ordernumber'  placeholder='Reservation Code/ Order ID' id='pnr' onblur="validatePNR()">
								</br>
							<p class='fieldnotelable'>Phone Number <font class='redstar'>*</font></p>
							<input type='text' name='phonenumber' required id="phonenumber" onblur="validatePhoneNumber()" onkeypress="return isNumberKey(event)"  placeholder='Phone Number' >
								</br>
							<p class='fieldnotelable'>Email ID <font class='redstar'>*</font></p>
							<input type='text' name='emailid' placeholder='E-mail' required readonly value='<?php echo $username; ?>'>
								</br>
							<p class='fieldnotelable'>Booking Ref# / Air Ticket Number (If created)</p>
							<input type='text' name='bookingref' placeholder='Booking Ref# / Air Ticket Number (If created)' id='airline_pnr' onblur="validateAirlinePNR()">
							<input type='hidden' name='flighttype' >
								</br>
							
							<p class='fieldnotelable'>Complaint Type</p>
							<select name='complainttype' id='complainttype' required style="width:100%; padding:10px; border-color: #dcd7ca;">
							<option selected disabled value=''>Complaint Category</option>
							<option value='Products or Services'>Products or Services</option>
							<option value='Complaint Handling'>Complaint Handling</option>
							<option value='Customer Service/Advice'>Customer Service/Advice</option>
							<option value='Misleading Conduct'>Misleading Conduct</option>
							<option value='Documentation'>Documentation</option>
							<option value='Deposit / Pre-Payment / Cancellation'>Deposit / Pre-Payment / Cancellation</option>
							<option value='Refunds'>Refunds</option>
							<option value='Ticket / Itinerary'>Ticket / Itinerary</option>
							<option value='Visa / Passport'>Visa / Passport</option>
							<option value='Other, Please specify below'>Other, Please specify below</option>
							
							</select>
								</br></br>
								
							<p class='fieldnotelable'>Airline</p>
							<select name='airline' id='airline' style="width:100%; padding:10px; border-color: #dcd7ca;">
							<option selected disabled value=''>Airline</option>
							<option value='Air India'>Air India</option>
							<option value='Cathay Pacific Airways'>Cathay Pacific Airways</option>
							<option value='China Airlines'>China Airlines</option>
							<option value='China Southern'>China Southern</option>
							<option value='Emirates'>Emirates</option>
							<option value='Etihad Airways'>Etihad Airways</option>
							<option value='Garuda Indonesia'>Garuda Indonesia</option>
							<option value='Jet Airways'>Jet Airways</option>
							<option value='Malaysia Airlines'>Malaysia Airlines</option>
							<option value='Qantas Airways'>Qantas Airways</option>
							<option value='Qatar Airways'>Qatar Airways</option>
							<option value='Saudi Arabian Airlines'>Saudi Arabian Airlines</option>
							<option value='Scoot Airlines'>Scoot Airlines</option>
							<option value='Singapore Airlines'>Singapore Airlines</option>
							<option value='South African Airways'>South African Airways</option>
							<option value='Srilankan Airlines'>Srilankan Airlines</option>
							<option value='Thai Airways'>Thai Airways</option>
							<option value='Vietnam Airlines'>Vietnam Airlines</option>
							<option value='Air Asia'>Air Asia</option>
							<option value='Others'>Others</option>
							</select>
								</br></br>
								<p class='fieldnotelable'>Travel Date</p>
							<input type='text' name='traveldate' id='traveldate' placeholder='Travel Date'  >
								</br>
								<p class='fieldnotelable'>Agent Name</p>
							<input type='text' name='agentname' onkeypress="return isTextKey(event)" placeholder='Agent Name'  >
								</br>
								<p class='fieldnotelable'>Other Issues</p>
							<input type='text' name='otherissue' id='otherissues' onkeypress="return isTextKey(event)" placeholder='Other'  >
								<div id='otherissuesbreak'></br></div>
								<p class='fieldnotelable'>Please explain what makes you unhappy?</p>
							<textarea placeholder='Please explain what makes you unhappy?' name='explanation'></textarea>
								</br>
								<p class='fieldnotelable'>Resolution or Outcome you are seeking?</p>
							<textarea placeholder='Resolution or Outcome you are seeking?' name='expectedresponse'></textarea>
							</br>
							<hr>
							<input type='file' name='inputfile' accept=".jpg,.jpeg,.png,.pdf" placeholder='Please provide any additional files if needed'  >
							</br></br>
							<center><input type='submit' name='btn_book_pax_complaint' class='btn btn-success' value='Submit'></center>
							</form>

							<script>
							$(function(){
								$('#complainttype').change(function(){
								   var opt = $(this).val();
									if(opt == 'Other, Please specify below'){
										$('#otherissues').show();
										$('#otherissuesbreak').show();
									}else{
										$('#otherissues').hide();
										$('#otherissuesbreak').hide();
									}
								});
							});
							</script>

						<?php
						if(isset($_POST['btn_book_pax_complaint']))
						{
							$query_count = "SELECT * FROM wpk4_backend_user_portal_requests ORDER BY case_id DESC LIMIT 1";
							$result_count = mysqli_query($mysqli, $query_count);
							$row_count_assoc = mysqli_fetch_assoc($result_count);
							$row_count = mysqli_num_rows($result_count);
							if($row_count>0)
							{
								$case_id = intval($row_count_assoc['case_id']);
								$case_id = $case_id+1;
							}
							else
							{
								$case_id = '1';
							}
							
							$customername = $_POST['customername'];
							$order_number = $_POST['ordernumber'];
							$phonenumber = $_POST['phonenumber'];
							$emailid = $_POST['emailid'];
							$bookingref = $_POST['bookingref'];
							$flighttype = $_POST['flighttype'];
							if($_POST['complainttype'] == 'Other, Please specify below')
							{
								$complainttype = $_POST['otherissue'];
							}
							else
							{
								$complainttype = $_POST['complainttype'];
							}
							
							$airline = ($_POST['airline'] ?? false)? $_POST['airline'] : '';
							$traveldate = $_POST['traveldate'];
							$agentname = $_POST['agentname'];
							$explanation = $_POST['explanation'];
							$expectedresponse = $_POST['expectedresponse'];
							
							
							$fileName = $_FILES['inputfile']['name'];
							if($_FILES['inputfile']['name'] != '')
							{
								$temp = explode(".", $fileName);
								$ext = end($temp);
								$filename_time = date('ymdHis');
								$newfilename =  'complaint_'. $filename_time . '.' .$ext;
							}
							else
							{
								$newfilename = '';
							}
						
							mysqli_query($mysqli,"insert into wpk4_backend_user_portal_requests (case_id, case_type, reservation_ref, last_response_by, last_response_on, is_seen_by_gt, user_id, status, case_date, priority) 
							values ('$case_id','complaint','$order_number' ,'customer' ,'$current_date_time' ,'0' ,'$user_id' ,'open' ,'$current_date_time' ,'P4')") or die(mysqli_error($mysqli));
							
							$subject = 'Complaint '. $order_number;
							
							add_userportal_post_meta($case_id, 'subject', $subject);
							add_userportal_post_meta($case_id, 'customer_name', $customername);
							add_userportal_post_meta($case_id, 'phone_number', $phonenumber);
							add_userportal_post_meta($case_id, 'email_address', $emailid);
							add_userportal_post_meta($case_id, 'booking_ref', $bookingref);
							add_userportal_post_meta($case_id, 'flight_type', $flighttype);
							add_userportal_post_meta($case_id, 'complaint_type', $complainttype);
							add_userportal_post_meta($case_id, 'airline', $airline);
							add_userportal_post_meta($case_id, 'travel_date', $traveldate);
							add_userportal_post_meta($case_id, 'agent', $agentname);
							add_userportal_post_meta($case_id, 'explanation', $explanation);
							add_userportal_post_meta($case_id, 'outcome_expected', $expectedresponse);
							add_userportal_post_meta($case_id, 'attachment', $newfilename);

							if($_FILES['inputfile']['name'] != '')
								{
									$currentDirectory = getcwd();
									$uploadDirectory = "wp-content/uploads/customized_function_uploads/";
									
									$errors = []; // Store errors here
									$fileExtensionsAllowed = ['jpeg','jpg','png','pdf','JPEG','JPG','PNG','PDF']; // These will be the only file extensions allowed 
									
									$fileSize = $_FILES['inputfile']['size'];
									$fileTmpName  = $_FILES['inputfile']['tmp_name'];
									$fileType = $_FILES['inputfile']['type'];
									$fileExtension_explode = explode('.',$fileType);
									$fileExtension = strtolower(end($fileExtension_explode));
									$uploadPath = $uploadDirectory . basename($newfilename); 
								
									if (! in_array($fileExtension,$fileExtensionsAllowed)) 
									{
										$errors[] = "This file extension is not allowed. Please upload a JPEG, PNG or PDF file";
									}
									if ($fileSize > 4000000) {
										$errors[] = "File exceeds maximum size (4MB)";
									}
									if (empty($errors)) 
									{
											$didUpload = move_uploaded_file($fileTmpName, $uploadPath);
										if ($didUpload) {
											//echo "The file " . basename($fileName) . " has been uploaded";
										} else {
											//echo "An error occurred. Please contact the administrator.";
										}
									}
									else
									{
										foreach ($errors as $error) {
										  echo $error . "These are the errors" . "\n";
										}
									}
								}

						 
						 $mailbody= '<!DOCTYPE html>
						<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office">
						<head>
						<meta charset="utf-8"> <!-- utf-8 works for most cases -->
						<meta name="viewport" content="width=device-width"> <!-- Forcing initial-scale shouldnt be necessary -->
						<meta http-equiv="X-UA-Compatible" content="IE=edge"> <!-- Use the latest (edge) version of IE rendering engine -->
						<meta name="x-apple-disable-message-reformatting">  <!-- Disable auto-scale in iOS 10 Mail entirely -->
						<title></title> <!-- The title tag shows in email notifications, like Android 4.4. -->

						<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">

						<!-- CSS Reset : BEGIN -->
						<style>
						/* What it does: Stops email clients resizing small text. */
						* {
							-ms-text-size-adjust: 100%;
							-webkit-text-size-adjust: 100%;
						}

						/* What it does: Centers email on Android 4.4 */
						div[style*="margin: 16px 0"] {
							margin: 0 !important;
						}

						/* What it does: Stops Outlook from adding extra spacing to tables. */
						table,
						td {
							mso-table-lspace: 0pt !important;
							mso-table-rspace: 0pt !important;
						}

						/* What it does: Fixes webkit padding issue. */
						table {
							border-spacing: 0 !important;
							border-collapse: collapse !important;
							table-layout: fixed !important;
							margin: 0 auto !important;
						}

						/* What it does: Prevents Windows 10 Mail from underlining links despite inline CSS. Styles for underlined links should be inline. */
						a {
							text-decoration: none;
							color: #30e3ca;
						}

						h1,h2,h3,h4,h5,h6{
							font-family: "Lato", sans-serif;
							color: #000000;
							margin-top: 0;
							font-weight: 400;
						}

						body{
							font-family: "Lato", sans-serif;
							font-weight: 400;
							font-size: 13px;
							line-height: 1.8;
							color: rgba(0,0,0,.4);
						}

						.hero .text{
							color: rgba(0,0,0,.3);
						}
						.hero .text h2{
							color: #000;
							font-size: 20px;
							margin-bottom: 0;
							font-weight: 400;
							line-height: 1.4;
						}
						.hero .text h3{
							font-size: 17px;
							font-weight: 300;
						}
						.hero .text h2 span{
							font-weight: 600;
							color: #30e3ca;
						}


						ul.social{
							padding: 0;
						}
						ul.social li{
							display: inline-block;
							margin-right: 10px;
						}
						</style>


						</head>
						<body width="100%" style="margin: 0; padding: 0 !important; mso-line-height-rule: exactly; background-color: #f1f1f1;">
							<center style="width: 100%; background-color: #f1f1f1;">
							<div style="display: none; font-size: 1px;max-height: 0px; max-width: 0px; opacity: 0; overflow: hidden; mso-hide: all; font-family: sans-serif;">
							  &zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;
							</div>
							<div style="max-width: 600px; margin: 0 auto;" class="email-container">
							
							
						<table class="wp-travel-wrapper" style="color: #5d5d5d; font-family: Roboto, sans-serif; margin: auto;" width="100%" cellspacing="0" cellpadding="0">
						<tbody>
						<tr class="wp-travel-content" style="background: #fff;">
						<td class="wp-travel-content-top" style="background: #fff; margin: 0; padding: 30px 25px;" colspan="2" align="left">
							<table role="presentation" border="0" cellpadding="0" cellspacing="0" width="100%">
							<tr>
							<td class="logo" style="text-align: center;">
							<img src="https://gauratravel.com.au/wp-content/uploads/2022/01/cropped-GauraTravel_logo_small_2.png" style="width:200px; text-align:center;"/>
							</td>
							</tr>
							</table>
						</td>
						</tr>
						<tr class="wp-travel-content" style="background: #fff;">
						<td class="wp-travel-content-top" style="background: #fff; margin: 0; padding: 20px 25px;" colspan="2" align="left">
						<p style="line-height: 1.55; font-size: 14px;">Hi,</p>
						<p style="line-height: 1.55; font-size: 14px;">Thank you for providing the information.</p>
						<p style="line-height: 1.55; font-size: 14px;"><b></b></p>
						</td></tr>';
						if($order_number != '')
						{
							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Reservation Code/Order ID: '.$order_number.'</td></tr>';
						}
						if($bookingref != '')
						{
							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Booking Ref: '.$bookingref.'</td></tr>';
						}
						if($flighttype != '')
						{
							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Flight Type: '.$flighttype.'</td></tr>';
						}	
						if($complainttype != '')
						{
							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Complaint Type: '.$complainttype.'</td></tr>';
						}
						if($airline != '')
						{
							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Airline: '.$airline.'</td></tr>';
						}
						if($traveldate != '')
						{
							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Travel Date: '.$traveldate.'</td></tr>';
						}
						if($agentname != '')
						{
							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Agent Name: '.$agentname.'</td></tr>';
						}
						if($explanation != '')
						{
							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">'.$explanation.'</td></tr>';
						}
						if($expectedresponse != '')
						{
							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">'.$expectedresponse.'</td></tr>';
						}
						$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left"> </td></tr>';
							
						$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">
							We will get back to you within 48 hours of your submissions.</td></tr>';
							
						$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 40px 25px;" colspan="2" align="left">
							Thank you. </td></tr>';
							
						$mailbody .=  '</tbody>
						</table>
						</div>
						</center>
						</body>
						</html>';
						
						$mailbody=stripslashes($mailbody);
						$emailsubject="Request Submitted - Gaura Travel";  
						$path = '';
						$sentto = $emailid;
						include('email/tpl_dispatch_userportal_emails.php');
						 
						 
						echo '<script>alert("Thank you for your submission.");</script>';
						echo '<script>window.location.href="?p=dashboard";</script>';
						}
						?>
					
							<script src="https://cdn.jsdelivr.net/gh/alumuko/vanilla-datetimerange-picker@latest/dist/vanilla-datetimerange-picker.js"></script>
							<script>
							window.addEventListener("load", function (event) {
									let drp = new DateRangePicker('traveldate',
											{
												
												timePicker: false,
												alwaysShowCalendars: true,
												singleDatePicker: true,
												autoApply: true,
												autoUpdateInput: true,
												
												locale: {
													format: "YYYY-MM-DD",
												}
											},
											function (start) {
												document.getElementById("traveldate").value = start.format();
												
											})
									});
									

							</script>	
							<?php	
					}
				// END COMPLAINT
				// START DATE CHANGE
				if(isset($_GET['p']) && $_GET['p'] =='request-date-change') //customer request date change
				{
						?>
						<h4>Date Change Request</h4>
						<h5>Basic Information</h5>	

						<form action="#" method="post" enctype="multipart/form-data">
						<p class='fieldnotelable'>Email Address <font class='redstar'>*</font></p>		
						<input type='text' name='emailid' placeholder='E-mail' required readonly value='<?php echo $username; ?>'>
						</br>
						<p class='fieldnotelable'>Phone Number <font class='redstar'>*</font></p>
						<input type='text' name='phonenumber' id="phonenumber" onblur="validatePhoneNumber()" onkeypress="return isNumberKey(event)"  required placeholder='Phone'  >
						</br>
						<p class='fieldnotelable'>Reason for the date change <font class='redstar'>*</font></p>
							<select name='reasonforchange' required id='reasonforchange' style="width:100%; padding:10px; border-color: #dcd7ca;">
								<option selected disabled value=''>Select</option>
								<option value='Family Emergency'>Family Emergency</option>
								<option value='Work Commitment/ Leave Rejection'>Work Commitment/ Leave Rejection</option>
								<option value='Health Issue/ Concern'>Health Issue/ Concern</option>
								<option value='Personal Reason'>Personal Reason</option>
								<option value='Medical Reason'>Medical Reason</option>
								<option value='Cancellation of Travel Plan'>Cancellation of Travel Plan</option>
								<option value='Flight Transit Time/ Layover Time'>Flight Transit Time/ Layover Time</option>
								<option value='Due to travel/ visa restrictions'>Due to travel/ visa restrictions</option>
								<option value='Name change request'>Name change request</option>
								<option value='Urgency of travel'>Urgency of travel</option>
								<option value='Incorrect information/ booking made'>Incorrect information/ booking made</option>
								<option value='Extend the travel plan'>Extend the travel plan</option>
							</select>
						</br></br>
						<p class='fieldnotelable'>Reservation code/ Order ID <font class='redstar'>*</font></p>	
						<input type='text' name='order_number'  required placeholder='Reservation Code/Order ID' id='pnr' onblur="validatePNR()">
						</br>
						<h5>Current Travel Information </h5>
						<p class='fieldnotelable'>Change Type <font class='redstar'>*</font></p>
							<input type="radio" id="oneway" checked name="traveltype" value="oneway"> <label for="oneway">One-way (Partial-ticket change)</label>&nbsp;&nbsp;
							<input type="radio" id="return" name="traveltype" value="return"> <label for="return">Return (Full-ticket change)</label><br>
						</br>
						<p class='fieldnotelable'>Travel Date <font class='redstar'>*</font></p>
						<table style="border:0px; padding:0px; margin:0px;">
						<tr><td style='width:50%'>
							<input type='text' required name='prev_traveldate' id='traveldate_going' placeholder='Travel Date' >
							</td><td style='width:49%'>
							<input type='text' required name='prev_traveldate_return' disabled id='traveldate_return' placeholder='Travel Date'>
							</td></tr></table>
						</br>
						<p class='fieldnotelable'>Number of Pax <font class='redstar'>*</font></p>
							<select name='numberofpax_previous' required style="width:100%; padding:10px; border-color: #dcd7ca;">
								<option selected disabled value=''>0</option>
								<?php
								for($i = 1; $i <= 10; $i++)
								{
									?>
									<option value='<?php echo $i; ?>'><?php echo $i; ?></option>
									<?php
								}
								?>
							</select>
						</br></br>
						<p class='fieldnotelable'>Airline <font class='redstar'>*</font></p>
						<select name='airline' required id='airline' style="width:100%; padding:10px; border-color: #dcd7ca;">
						<option selected disabled value=''>Airline</option>
						<option value='Air India'>Air India</option>
						<option value='Cathay Pacific Airways'>Cathay Pacific Airways</option>
						<option value='China Airlines'>China Airlines</option>
						<option value='China Southern'>China Southern</option>
						<option value='Emirates'>Emirates</option>
						<option value='Etihad Airways'>Etihad Airways</option>
						<option value='Garuda Indonesia'>Garuda Indonesia</option>
						<option value='Jet Airways'>Jet Airways</option>
						<option value='Malaysia Airlines'>Malaysia Airlines</option>
						<option value='Qantas Airways'>Qantas Airways</option>
						<option value='Qatar Airways'>Qatar Airways</option>
						<option value='Saudi Arabian Airlines'>Saudi Arabian Airlines</option>
						<option value='Scoot Airlines'>Scoot Airlines</option>
						<option value='Singapore Airlines'>Singapore Airlines</option>
						<option value='South African Airways'>South African Airways</option>
						<option value='Srilankan Airlines'>Srilankan Airlines</option>
						<option value='Thai Airways'>Thai Airways</option>
						<option value='Vietnam Airlines'>Vietnam Airlines</option>
						<option value='Air Asia'>Air Asia</option>
						<option value='Others'>Others</option>
						</select>
						</br></br>
						<h5>Preferred Travel Information</h5>	
						
						<p class='fieldnotelable'>Travel Date <font class='redstar'>*</font></p>
						
						<table style="border:0px; padding:0px; margin:0px;">
						<tr><td style='width:50%'>
							<input type='text' required name='new_traveldate' id='traveldate1' placeholder='Travel Date' >
							</td><td style='width:49%'>
							<input type='text' disabled required name='new_traveldate_both' id='traveldate1_both' placeholder='Travel Date' >
							</td></tr></table>
						</br>
						<p class='fieldnotelable'>Number of Pax</p>
							<select name='numberofpax_new' required style="width:100%; padding:10px; border-color: #dcd7ca;">
								<option selected disabled value=''>0</option>
								<?php
								for($i = 1; $i <= 10; $i++)
								{
									?>
									<option value='<?php echo $i; ?>'><?php echo $i; ?></option>
									<?php
								}
								?>
							</select>
						</br></br>
						<p class='fieldnotelable'>From</p>
						<input type='text' name='future_departure' placeholder='Departure Airport'  >
						</br>
						<p class='fieldnotelable'>To</p>
						<input type='text' name='future_arrival' placeholder='Arrival Airport'  >
						</br>
						<hr>
						<p class='fieldnotelable'>Additional Document</p>
						<input type='file' name='inputfile' accept=".jpg,.jpeg,.png,.pdf" placeholder='Add Attachments'  >
						</br>
						</br>
						<input type="checkbox" id="terms" required name="termsconditions" value="agreed"><label for="terms"> By clicking a submission button, <a target='_blank' href='https://gauratravel.com.au/terms-and-conditions/'>I agree to Consent <font class='redstar'>*</font></a></label><br>
						</br>
						<center><input type='submit' name='btn_book_pax_dc' class='btn btn-success' value='Submit'></center>
						</form>
						<?php
						if(isset($_POST['btn_book_pax_dc']))
						{
							$query_count = "SELECT * FROM wpk4_backend_user_portal_requests ORDER BY case_id DESC LIMIT 1";
								$result_count = mysqli_query($mysqli, $query_count);
								$row_count_assoc = mysqli_fetch_assoc($result_count);
								$row_count = mysqli_num_rows($result_count);
								if($row_count>0)
								{
									$case_id = intval($row_count_assoc['case_id']);
									$case_id = $case_id+1;
								}
								else
								{
									$case_id = '1';
								}
								
							$emailid = $_POST['emailid'];
							$phonenumber = $_POST['phonenumber'];
							$reasonforchange = $_POST['reasonforchange'];
							
							$order_number = $_POST['order_number'];
							$traveltype = $_POST['traveltype'];
							$prev_traveldate = $_POST['prev_traveldate'];
							
							$prev_traveldate_return = '';
							$new_traveldate_both = '';
							if($traveltype == 'return')
							{
								$prev_traveldate_return = ($_POST['prev_traveldate_return'] ?? false) ? $_POST['prev_traveldate_return'] : '' ; //current - return
								
								$new_traveldate_both = ($_POST['new_traveldate_both'] ?? false) ? $_POST['new_traveldate_both'] : '' ; // preferred - return
								$future_departure_start = substr($new_traveldate_both, 0, 10); // 14/04/2023 - 17/04/2023
								$future_departure_end = substr($new_traveldate_both, 13, 23);
								
								if($future_departure_start == $future_departure_end)
								{
									$new_traveldate_both = $future_departure_start;
								}
								else
								{
									$new_traveldate_both = $future_departure_start . " - " .  $future_departure_end;
								}
							}
							
							
							$numberofpax_previous = $_POST['numberofpax_previous'];
							
							$airline = ($_POST['airline'] ?? false)? $_POST['airline'] : '';
							$new_traveldate = $_POST['new_traveldate'];
							$future_departure_start = substr($new_traveldate, 0, 10); // 14/04/2023 - 17/04/2023
							$future_departure_end = substr($new_traveldate, 13, 23);
							
							if($future_departure_start == $future_departure_end)
							{
								$new_traveldate = $future_departure_start;
							}
							else
							{
								$new_traveldate = $future_departure_start . " - " .  $future_departure_end;
							}
							
							
							
							$future_departure = $_POST['future_departure'];
							$future_arrival = $_POST['future_arrival'];
							$numberofpax_new = $_POST['numberofpax_new'];
									
							$current_date_time = date('Y-m-d H:i:s');
							
							$fileName = $_FILES['inputfile']['name'];
							if($_FILES['inputfile']['name'] != '')
							{
								$temp = explode(".", $_FILES["inputfile"]["name"]);
								$ext = end($temp);
								$filename_time = date('ymdHis');
								$newfilename =  'datechange_'. $filename_time . '.' .$ext;
							}
							else
							{
								$newfilename = '';
							}
							$subject = 'Date change Request '. $order_number;
							
							mysqli_query($mysqli,"insert into wpk4_backend_user_portal_requests (case_id, case_type, reservation_ref, last_response_by, last_response_on, is_seen_by_gt, user_id, status, case_date, priority) 
							values ('$case_id','datechange','$order_number' ,'customer' ,'$current_date_time' ,'0' ,'$user_id' ,'open' ,'$current_date_time' ,'P4')") or die(mysqli_error($mysqli));
							
							add_userportal_post_meta($case_id, 'subject', $subject);	add_userportal_post_meta($case_id, 'reason', $reasonforchange);
							add_userportal_post_meta($case_id, 'email_address', $emailid);
							add_userportal_post_meta($case_id, 'phone_number', $phonenumber);
							add_userportal_post_meta($case_id, 'current_travel_date', $prev_traveldate);
							add_userportal_post_meta($case_id, 'current_no_of_pax', $numberofpax_previous);
							add_userportal_post_meta($case_id, 'current_airline', $airline);
							add_userportal_post_meta($case_id, 'preferred_travel_date', $new_traveldate);
							add_userportal_post_meta($case_id, 'from', $future_departure);
							add_userportal_post_meta($case_id, 'to', $future_arrival);
							add_userportal_post_meta($case_id, 'no_of_pax', $numberofpax_new);
							add_userportal_post_meta($case_id, 'attachment', $newfilename);
							
							if($_FILES['inputfile']['name'] != '')
							{
								$currentDirectory = getcwd();
								$uploadDirectory = "wp-content/uploads/customized_function_uploads/";
								
								$errors = []; // Store errors here
								$fileExtensionsAllowed = ['jpeg','jpg','png','pdf','JPEG','JPG','PNG','PDF']; // These will be the only file extensions allowed 
								
								$fileSize = $_FILES['inputfile']['size'];
								$fileTmpName  = $_FILES['inputfile']['tmp_name'];
								$fileType = $_FILES['inputfile']['type'];
								$fileExtension_explode = explode('.',$fileName);
								$fileExtension = strtolower(end($fileExtension_explode));
								$uploadPath = $uploadDirectory . basename($newfilename); 
								
								if (! in_array($fileExtension,$fileExtensionsAllowed)) 
								{
									$errors[] = "This file extension is not allowed. Please upload a JPEG, PNG or PDF file";
								}
								if ($fileSize > 4000000) {
									$errors[] = "File exceeds maximum size (4MB)";
								}
								if (empty($errors)) 
								{
										$didUpload = move_uploaded_file($fileTmpName, $uploadPath);
									if ($didUpload) {
										//echo "The file " . basename($fileName) . " has been uploaded";
									} else {
										//echo "An error occurred. Please contact the administrator.";
									}
								}
								else
								{
									foreach ($errors as $error) {
									  echo $error . "These are the errors" . "\n";
									}
								}				
							
							}
							
							$mailbody= '<!DOCTYPE html>
						<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office">
						<head>
						<meta charset="utf-8"> <!-- utf-8 works for most cases -->
						<meta name="viewport" content="width=device-width"> <!-- Forcing initial-scale shouldnt be necessary -->
						<meta http-equiv="X-UA-Compatible" content="IE=edge"> <!-- Use the latest (edge) version of IE rendering engine -->
						<meta name="x-apple-disable-message-reformatting">  <!-- Disable auto-scale in iOS 10 Mail entirely -->
						<title></title> <!-- The title tag shows in email notifications, like Android 4.4. -->
						<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
						<!-- CSS Reset : BEGIN -->
						<style>
						/* What it does: Stops email clients resizing small text. */
						* {
							-ms-text-size-adjust: 100%;
							-webkit-text-size-adjust: 100%;
						}

						/* What it does: Centers email on Android 4.4 */
						div[style*="margin: 16px 0"] {
							margin: 0 !important;
						}

						/* What it does: Stops Outlook from adding extra spacing to tables. */
						table,
						td {
							mso-table-lspace: 0pt !important;
							mso-table-rspace: 0pt !important;
						}

						/* What it does: Fixes webkit padding issue. */
						table {
							border-spacing: 0 !important;
							border-collapse: collapse !important;
							table-layout: fixed !important;
							margin: 0 auto !important;
						}

						/* What it does: Prevents Windows 10 Mail from underlining links despite inline CSS. Styles for underlined links should be inline. */
						a {
							text-decoration: none;
							color: #30e3ca;
						}

						h1,h2,h3,h4,h5,h6{
							font-family: "Lato", sans-serif;
							color: #000000;
							margin-top: 0;
							font-weight: 400;
						}

						body{
							font-family: "Lato", sans-serif;
							font-weight: 400;
							font-size: 13px;
							line-height: 1.8;
							color: rgba(0,0,0,.4);
						}

						.hero .text{
							color: rgba(0,0,0,.3);
						}
						.hero .text h2{
							color: #000;
							font-size: 20px;
							margin-bottom: 0;
							font-weight: 400;
							line-height: 1.4;
						}
						.hero .text h3{
							font-size: 17px;
							font-weight: 300;
						}
						.hero .text h2 span{
							font-weight: 600;
							color: #30e3ca;
						}


						ul.social{
							padding: 0;
						}
						ul.social li{
							display: inline-block;
							margin-right: 10px;
						}
						</style>
						</head>
						<body width="100%" style="margin: 0; padding: 0 !important; mso-line-height-rule: exactly; background-color: #f1f1f1;">
							<center style="width: 100%; background-color: #f1f1f1;">
							<div style="display: none; font-size: 1px;max-height: 0px; max-width: 0px; opacity: 0; overflow: hidden; mso-hide: all; font-family: sans-serif;">
							  &zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;
							</div>
							<div style="max-width: 600px; margin: 0 auto;" class="email-container">
							
							
						<table class="wp-travel-wrapper" style="color: #5d5d5d; font-family: Roboto, sans-serif; margin: auto;" width="100%" cellspacing="0" cellpadding="0">
						<tbody>
						<tr class="wp-travel-content" style="background: #fff;">
						<td class="wp-travel-content-top" style="background: #fff; margin: 0; padding: 30px 25px;" colspan="2" align="left">
							<table role="presentation" border="0" cellpadding="0" cellspacing="0" width="100%">
							<tr>
							<td class="logo" style="text-align: center;">
							<img src="https://gauratravel.com.au/wp-content/uploads/2022/01/cropped-GauraTravel_logo_small_2.png" style="width:200px; text-align:center;"/>
							</td>
							</tr>
							</table>
						</td>
						</tr>
						<tr class="wp-travel-content" style="background: #fff;">
						<td class="wp-travel-content-top" style="background: #fff; margin: 0; padding: 20px 25px;" colspan="2" align="left">
						<p style="line-height: 1.55; font-size: 14px;">Hi,</p>
						<p style="line-height: 1.55; font-size: 14px;">Thank you for submitting your date change form with required information as below:</p>
						<p style="line-height: 1.55; font-size: 14px;"><b></b></p>
						</td></tr>';

						if($order_number != '')
						{
							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Reservation code/ Order ID: '.$order_number.'</td></tr>';
						}
						if($reasonforchange != '')
						{
							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Reason: '.$reasonforchange.'</td></tr>';
						}
						if($prev_traveldate != '')
						{
							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Current Travel Date: '.$prev_traveldate.'</td></tr>';
						}
						if($numberofpax_previous != '')
						{
							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Current No. of pax: '.$numberofpax_previous.'</td></tr>';
						}	
						if($airline != '')
						{
							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Current Airline: '.$airline.'</td></tr>';
						}
						if($new_traveldate != '')
						{
							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Preferred Travel Date: '.$new_traveldate.'</td></tr>';
						}
						if($future_departure != '')
						{
							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Preferred Departure Airport: '.$future_departure.'</b></td></tr>';
						}
						if($future_arrival != '')
						{
							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Preferred Arrival Airport: '.$future_arrival.'</td></tr>';
						}
						if($numberofpax_new != '')
						{
							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Preferred No. of pax:'.$numberofpax_new.'</td></tr>';
						}
						$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left"> </td></tr>';
							
						$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">
							If your travel date within 96 hours, we will get back to you today, or else our team will get back to you within 48 hours of your submissions.</td></tr>';
							
						$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
							<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 40px 25px;" colspan="2" align="left">
							Thank you!</td></tr>';
						$mailbody .=  '</tbody>
						</table>
						</div>
						</center>
						</body>
						</html>';
							$mailbody=stripslashes($mailbody);
							$emailsubject="Request Submitted - Gaura Travel";  
							$path = '';
							$sentto = $emailid;
							include('email/tpl_dispatch_userportal_emails.php');
							
							echo '<script>alert("Thank you for your submission. Our team will contact you shortly.");</script>';
							echo '<script>window.location.href="?p=dashboard";</script>';
						}
						?>
						
						<script src="https://cdn.jsdelivr.net/gh/alumuko/vanilla-datetimerange-picker@latest/dist/vanilla-datetimerange-picker.js"></script>
						<script>
						
						var currentdate = new Date(); 
						var date_tomorrow = new Date((new Date()).valueOf() + 1000*3600*24);
						window.addEventListener("load", function (event) {
								let drp = new DateRangePicker('traveldate_going',
										{
											minDate: date_tomorrow,
											timePicker: false,
											alwaysShowCalendars: true,
											singleDatePicker: true,
											autoApply: true,
											autoUpdateInput: true,
											
											locale: {
												format: "DD/MM/YYYY",
											}
										},
										function (start) {
											document.getElementById("traveldate_going").value = start.format();
											
										})
								});
						
						var travel_date_going = new Date((document.getElementById("traveldate_going").value).valueOf() + 1000*3600*24);
						window.addEventListener("load", function (event) {
								let drp = new DateRangePicker('traveldate_return',
										{
											minDate: travel_date_going,
											timePicker: false,
											alwaysShowCalendars: true,
											singleDatePicker: true,
											autoApply: true,
											autoUpdateInput: true,
											
											locale: {
												format: "DD/MM/YYYY",
											}
										},
										function (start) {
											document.getElementById("traveldate_return").value = start.format();
											
										})
								});
						window.addEventListener("load", function (event) {
								let drp = new DateRangePicker('traveldate1',
										{
											minDate: date_tomorrow,
											endDate: date_tomorrow,
											timePicker: false,
											alwaysShowCalendars: true,
											//singleDatePicker: true,
											autoApply: true,
											autoUpdateInput: true,
											maxSpan: { "days": 3 },
											locale: {
												format: "DD/MM/YYYY",
											}
										},
										function (start,end) {
											document.getElementById("traveldate1").value = '';
											var startdate = start.format().substring(0,10); // 2023-04-11T00:00:00+10:00 -> 2023-04-11
											var enddate = end.format().substring(0,10); // 2023-04-13T23:59:59+10:00 -> 2023-04-13
										   
											var isstartdate = startdate + 'T00:00:00+10:00';
											var isenddate = startdate + 'T23:59:59+10:00';
											//alert(isenddate + ' - ' + end.format() )
											if(startdate != enddate)
											{
												document.getElementById("traveldate1").value = startdate + ' - ' + enddate;
											}
											else
											{
												document.getElementById("traveldate1").value = startdate;
											}
										})
								});		
							window.addEventListener("load", function (event) {
								let drp = new DateRangePicker('traveldate1_both',
										{
											minDate: date_tomorrow,
											endDate: date_tomorrow,
											timePicker: false,
											alwaysShowCalendars: true,
											//singleDatePicker: true,
											autoApply: true,
											autoUpdateInput: true,
											maxSpan: { "days": 3 },
											locale: {
												format: "DD/MM/YYYY",
											}
										},
										function (start,end) {
											document.getElementById("traveldate1_both").value = '';
											var startdate = start.format().substring(0,10); // 2023-04-11T00:00:00+10:00 -> 2023-04-11
											var enddate = end.format().substring(0,10); // 2023-04-13T23:59:59+10:00 -> 2023-04-13
										   
											var isstartdate = startdate + 'T00:00:00+10:00';
											var isenddate = startdate + 'T23:59:59+10:00';
											//alert(isenddate + ' - ' + end.format() )
											if(startdate != enddate)
											{
												document.getElementById("traveldate1_both").value = startdate + ' - ' + enddate;
											}
											else
											{
												document.getElementById("traveldate1_both").value = startdate;
											}
										})
								});	
							document.getElementById("traveldate_return").value = '';
							document.getElementById("traveldate1_both").value = '';
							$(document).ready(function(){
								$('input[name="traveltype"]').on('change', function(){
								   if($(this).val() === 'return') {
									 $('#traveldate_return').prop('disabled', false);  
									 $('#traveldate1_both').prop('disabled', false);  
								   }
								   else {
									 $('#traveldate_return').prop('disabled', true);  
									 document.getElementById("traveldate_return").value = '';
									 $('#traveldate1_both').prop('disabled', true);  
									 document.getElementById("traveldate1_both").value = '';
								   }
								});
							});
							</script>
						
				<?php	
				}
				if(isset($_GET['p']) && $_GET['p'] =='refund-request') //customer refund request
				{
					?>	
					<form action="#" method="post" enctype="multipart/form-data">
					<h2>Apply for Refunds</h2>	
						<h4>Gerneral Information</h4>
					<p class='fieldnotelable'>Email Address</p>	
							<input type='text' name='emailid' placeholder='E-mail' required readonly value='<?php echo $username; ?>'>
							</br>
							<p class='fieldnotelable'>Reason</p>
							<textarea name='reasonforcancellation' placeholder='Reason' required></textarea>
							</br>
							<p class='fieldnotelable'>Reservation code/ Order ID</p>
							<input type='text' name='order_number' required placeholder='Reservation Code/ Order ID'  >
							</br>
							<p class='fieldnotelable'>Phone Number</p>
							<input type='text' id="phonenumber" onblur="validatePhoneNumber()" onkeypress="return isNumberKey(event)" name='phonenumber' required placeholder='Phone'  >
						
						
						<h4>Ticket Information</h4>	

					<fieldset id="paxcontainer">
					  <div class="paxbox" style='display:flex;'>
					  
						<div style='width:100%;'><p class='fieldnotelable'>Name of Passenger</p></br>
						<input type="text" onkeypress="return isTextKey(event)" required placeholder='Name of Passenger' id="pax_name" name="pax_name[]"></div>
						
					  </div>
					</fieldset>

					<button type="button" id="add_pax" class='btn_add_remove'>+ Add more</button>

					</br></br>

					<fieldset id="ticketcontainer">
					  <div class="ticketbox" style='display:flex;'>
					  
						<div style='width:100%;'><p class='fieldnotelable'>Ticket Number</p></br><input type="text" placeholder='Ticket Number' onkeypress="return isNumberKey(event)" id="ticket_number" name="ticket_number[]"></div>
						
					  </div>
					</fieldset>

					<button type="button" id="add_ticket" class='btn_add_remove'>+ Add more</button>
					</br>
					<p class='fieldnotelable'>Reservation Code</p>
					<input type='text' name='reservationcode' placeholder='Reservation Code' id='pnr' onblur="validatePNR()">
					</br>
					<p class='fieldnotelable'>Airline Reservation Code</p>
					<input type='text' name='airlinereservationcode' placeholder='Airline Reservation Code' id='airline_pnr' onblur="validateAirlinePNR()">
					</br>
					<p class='fieldnotelable'>Airline</p>
					<select name='airline' required id='airline' style="width:100%; padding:10px; border-color: #dcd7ca;">
					<option selected disabled>Airline</option>
    					<option value='Malaysia Airlines'>Malaysia Airlines</option>
    					<option value='Qantas Airways'>Qantas Airways</option>
    					<option value='Singapore Airlines'>Singapore Airlines</option>
    					<option value='Scoot Airlines'>Scoot Airlines</option>
    					<option value='Air India'>Air India</option>
    					<option value='Air India'>Air India</option>
    					<option value='Cathay Pacific Airways'>Cathay Pacific Airways</option>
    					<option value='China Airlines'>China Airlines</option>
    					<option value='China Southern'>China Southern</option>
    					<option value='Emirates'>Emirates</option>
    					<option value='Etihad Airways'>Etihad Airways</option>
    					<option value='Garuda Indonesia'>Garuda Indonesia</option>
    					<option value='Jet Airways'>Jet Airways</option>
    					<option value='Malaysia Airlines'>Malaysia Airlines</option>
    					<option value='Qantas Airways'>Qantas Airways</option>
    					<option value='Qatar Airways'>Qatar Airways</option>
    					<option value='Saudi Arabian Airlines'>Saudi Arabian Airlines</option>
    					<option value='Scoot Airlines'>Scoot Airlines</option>
    					<option value='Singapore Airlines'>Singapore Airlines</option>
    					<option value='South African Airways'>South African Airways</option>
    					<option value='Srilankan Airlines'>Srilankan Airlines</option>
    					<option value='Thai Airways'>Thai Airways</option>
    					<option value='Vietnam Airlines'>Vietnam Airlines</option>
    					<option value='Air Asia'>Air Asia</option>
    					<option value='Others'>Others</option>
					</select>
					</br></br>
					<p class='fieldnotelable'>Travel Date</p>
					<input type='text' required name='traveldate' id='traveldate' placeholder='Travel Date'  >

					<h4>Bank Details</h4>
					<p class='fieldnotelable'>Account Name</p>	
					<input type='text' name='accountname' onkeypress="return isTextKey(event)" required placeholder='Account Name'  >
					</br>
					<p class='fieldnotelable'>BSB</p>
					<input type='text' name='bsb' id='bsb' required onkeypress="return isNumberKey(event)" placeholder='BSB'  >
					</br>
					<p class='fieldnotelable'>Account Number</p>
					<input type='text' name='accountnumber' onkeypress="return isNumberKey(event)" required placeholder='Account Number'  >
					</br>
					<hr>
					<p class='fieldnotelable'>Additional Document</p>
					<input type='file' name='inputfile' accept=".jpg,.jpeg,.png,.pdf" placeholder='Add Attachments'  >
					</br></br>
					<input type="checkbox" id="terms" required name="termsconditions" value="agreed"><label for="terms"> By clicking a submission button, <a target='_blank' href='https://gauratravel.com.au/terms-and-conditions/'>I agree to Consent *</a></label><br>

					</br></br>
					<center><input type='submit' name='btn_book_pax_refund' class='btn btn-success' value='Submit'></center>
					</form>
					<script>
					  var input = document.getElementById("bsb");
					  input.addEventListener("input", function() {
						let value = input.value;
						value = value.replace(/-/g, ""); // remove existing hyphens
						if (value.length > 3) {
						  value = value.slice(0, 3) + "-" + value.slice(3); // insert hyphen after third character
						}
						input.value = value;
					  });
					</script>
					<?php
					if(isset($_POST['btn_book_pax_refund']))
					{
						$query_count = "SELECT * FROM wpk4_backend_user_portal_requests ORDER BY case_id DESC LIMIT 1";
						$result_count = mysqli_query($mysqli, $query_count);
						$row_count_assoc = mysqli_fetch_assoc($result_count);
						$row_count = mysqli_num_rows($result_count);
						if($row_count>0)
						{
							$case_id = intval($row_count_assoc['case_id']);
							$case_id = $case_id+1;
						}
						else
						{
							$case_id = '1';
						}
				
						$emailid = $_POST['emailid'];
						$order_number = $_POST['order_number'];
						$fileName = $_FILES['inputfile']['name'];
						$temp = explode(".", $_FILES["inputfile"]["name"]);
						
						$reasonforcancellation = $_POST['reasonforcancellation'];
						$phonenumber = $_POST['phonenumber'];
						$reservationcode = $_POST['reservationcode'];
						$airlinereservationcode = $_POST['airlinereservationcode'];
						$airline = ($_POST['airline'] ?? false)? $_POST['airline'] : '';
						$traveldate = $_POST['traveldate'];
						$accountname = $_POST['accountname'];
						$bsb = $_POST['bsb'];
						$accountnumber = $_POST['accountnumber'];
						
						
						mysqli_query($mysqli,"insert into wpk4_backend_user_portal_requests (case_id, case_type, reservation_ref, last_response_by, last_response_on, is_seen_by_gt, user_id, status, case_date, priority) 
						values ('$case_id','refund','$order_number' ,'customer' ,'$current_date_time' ,'0' ,'$user_id' ,'open' ,'$current_date_time' ,'P4')") or die(mysqli_error($mysqli));
						
						$subject = 'Refund Request '. $order_number;
						
						$fileName = $_FILES['inputfile']['name'];
							if($_FILES['inputfile']['name'] != '')
							{
								$temp = explode(".", $fileName);
								$ext = end($temp);
								$filename_time = date('ymdHis');
								$newfilename =  'refund_'. $filename_time . '.' .$ext;
							}
							else
							{
								$newfilename = '';
							}
							
						$pax_name = $_POST['pax_name'];
						$ticket_number = $_POST['ticket_number'];

						$pax_names = '';
						
						foreach( $pax_name as $key => $n ) 
						{
							$pax_names .= $n . ', ';
						}
						
						$ticket_numbers = '';
						foreach( $ticket_number as $key => $n ) 
						{
							$ticket_numbers .= $n . ', ';
						}
						
						add_userportal_post_meta($case_id, 'subject', $subject);
						add_userportal_post_meta($case_id, 'reason', $reasonforcancellation);
						add_userportal_post_meta($case_id, 'reservation_code', $reservationcode);
						add_userportal_post_meta($case_id, 'airline_reservation_code', $airlinereservationcode);
						add_userportal_post_meta($case_id, 'airline', $airline);
						add_userportal_post_meta($case_id, 'travel_date', $traveldate);
						add_userportal_post_meta($case_id, 'attachment', $newfilename);
						add_userportal_post_meta($case_id, 'phone_number', $phonenumber);
						add_userportal_post_meta($case_id, 'email_address', $emailid);
						add_userportal_post_meta($case_id, 'account_name', $accountname);
						add_userportal_post_meta($case_id, 'bsb', $bsb);
						add_userportal_post_meta($case_id, 'account_number', $accountnumber);
						add_userportal_post_meta($case_id, 'passenger_names', $pax_names);
						add_userportal_post_meta($case_id, 'ticket_numbers', $ticket_numbers);
						
						$array_of_rows = array("cancellation_fee", "refund_amount" ,"refund_received_from_airline" ,"diff", "refund_received_date","submitted_date", "booking_type", "remarks", "profile_number", "total_paid_by_customer", "gt_cancellation_fees", "airline_cancellation_fees", "consolidator_fees", "type_of_refund", "stage", "refund_applied_to_airline_date", "refund_received_from_airline_date", "pcc", "consolidator", "oneway_return", "rejected", "refund_received_from_consolidator","refund_processed_date");

						foreach ($array_of_rows as $value) // adding dummy record for refund team's records.
						{
							$value = mysqli_real_escape_string($mysqli, $value);
							$insert_query = "INSERT INTO wpk4_backend_user_portal_request_meta (`case_id`,`meta_key`) VALUES ('$case_id','$value')";

							$result = mysqli_query($mysqli, $insert_query);
							if (!$result) 
							{
								die("Error: " . mysqli_error($mysqli));
							}
						}

						if($_FILES['inputfile']['name'] != '')
							{
								$currentDirectory = getcwd();
								$uploadDirectory = "wp-content/uploads/customized_function_uploads/";
								
								$errors = []; // Store errors here
								$fileExtensionsAllowed = ['jpeg','jpg','png','pdf','JPEG','JPG','PNG','PDF']; // These will be the only file extensions allowed 
								
								$fileSize = $_FILES['inputfile']['size'];
								$fileTmpName  = $_FILES['inputfile']['tmp_name'];
								$fileType = $_FILES['inputfile']['type'];
								$extension_explode = explode('.',$fileName);
								$fileExtension = strtolower(end($extension_explode));
								$uploadPath = $uploadDirectory . basename($newfilename); 
							
								if (! in_array($fileExtension,$fileExtensionsAllowed)) 
								{
									$errors[] = "This file extension is not allowed. Please upload a JPEG, PNG or PDF file";
								}
								if ($fileSize > 4000000) {
									$errors[] = "File exceeds maximum size (4MB)";
								}
								if (empty($errors)) 
								{
										$didUpload = move_uploaded_file($fileTmpName, $uploadPath);
									if ($didUpload) {
										//echo "The file " . basename($fileName) . " has been uploaded";
									} else {
										//echo "An error occurred. Please contact the administrator.";
									}
								}
								else
								{
									foreach ($errors as $error) {
									  echo $error . "These are the errors" . "\n";
									}
								}
							}
						
						$mailbody= '<!DOCTYPE html>
							<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office">
							<head>
							<meta charset="utf-8"> <!-- utf-8 works for most cases -->
							<meta name="viewport" content="width=device-width"> <!-- Forcing initial-scale shouldnt be necessary -->
							<meta http-equiv="X-UA-Compatible" content="IE=edge"> <!-- Use the latest (edge) version of IE rendering engine -->
							<meta name="x-apple-disable-message-reformatting">  <!-- Disable auto-scale in iOS 10 Mail entirely -->
							<title></title> <!-- The title tag shows in email notifications, like Android 4.4. -->
							<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
							<!-- CSS Reset : BEGIN -->
							<style>
							/* What it does: Stops email clients resizing small text. */
							* {
								-ms-text-size-adjust: 100%;
								-webkit-text-size-adjust: 100%;
							}

							/* What it does: Centers email on Android 4.4 */
							div[style*="margin: 16px 0"] {
								margin: 0 !important;
							}

							/* What it does: Stops Outlook from adding extra spacing to tables. */
							table,
							td {
								mso-table-lspace: 0pt !important;
								mso-table-rspace: 0pt !important;
							}

							/* What it does: Fixes webkit padding issue. */
							table {
								border-spacing: 0 !important;
								border-collapse: collapse !important;
								table-layout: fixed !important;
								margin: 0 auto !important;
							}

							/* What it does: Prevents Windows 10 Mail from underlining links despite inline CSS. Styles for underlined links should be inline. */
							a {
								text-decoration: none;
								color: #30e3ca;
							}

							h1,h2,h3,h4,h5,h6{
								font-family: "Lato", sans-serif;
								color: #000000;
								margin-top: 0;
								font-weight: 400;
							}

							body{
								font-family: "Lato", sans-serif;
								font-weight: 400;
								font-size: 13px;
								line-height: 1.8;
								color: rgba(0,0,0,.4);
							}

							.hero .text{
								color: rgba(0,0,0,.3);
							}
							.hero .text h2{
								color: #000;
								font-size: 20px;
								margin-bottom: 0;
								font-weight: 400;
								line-height: 1.4;
							}
							.hero .text h3{
								font-size: 17px;
								font-weight: 300;
							}
							.hero .text h2 span{
								font-weight: 600;
								color: #30e3ca;
							}


							ul.social{
								padding: 0;
							}
							ul.social li{
								display: inline-block;
								margin-right: 10px;
							}
							</style>
							</head>
							<body width="100%" style="margin: 0; padding: 0 !important; mso-line-height-rule: exactly; background-color: #f1f1f1;">
								<center style="width: 100%; background-color: #f1f1f1;">
								<div style="display: none; font-size: 1px;max-height: 0px; max-width: 0px; opacity: 0; overflow: hidden; mso-hide: all; font-family: sans-serif;">
								  &zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;&zwnj;&nbsp;
								</div>
								<div style="max-width: 600px; margin: 0 auto;" class="email-container">
								
								
							<table class="wp-travel-wrapper" style="color: #5d5d5d; font-family: Roboto, sans-serif; margin: auto;" width="100%" cellspacing="0" cellpadding="0">
							<tbody>
							<tr class="wp-travel-content" style="background: #fff;">
							<td class="wp-travel-content-top" style="background: #fff; margin: 0; padding: 30px 25px;" colspan="2" align="left">
								<table role="presentation" border="0" cellpadding="0" cellspacing="0" width="100%">
								<tr>
								<td class="logo" style="text-align: center;">
								<img src="https://gauratravel.com.au/wp-content/uploads/2022/01/cropped-GauraTravel_logo_small_2.png" style="width:200px; text-align:center;"/>
								</td>
								</tr>
								</table>
							</td>
							</tr>
							<tr class="wp-travel-content" style="background: #fff;">
							<td class="wp-travel-content-top" style="background: #fff; margin: 0; padding: 20px 25px;" colspan="2" align="left">
							<p style="line-height: 1.55; font-size: 14px;">Hi,</p>
							<p style="line-height: 1.55; font-size: 14px;">Thank you for providing the information.</p>
							<p style="line-height: 1.55; font-size: 14px;"><b></b></p>
							</td></tr>';
							if($subject != '')
							{
								$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Subject: '.$subject.'</td></tr>';
							}
							if($reasonforcancellation != '')
							{
								$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Reason for cancellation: '.$reasonforcancellation.'</td></tr>';
							}
							if($order_number != '')
							{
								$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Reservation code/ Order ID: '.$order_number.'</td></tr>';
							}	
							if($reservationcode != '')
							{
								$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Reservation Code: '.$reservationcode.'</td></tr>';
							}

							if($airlinereservationcode != '')
							{
								$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Airline Reservation Code: '.$airlinereservationcode.'</td></tr>';
							}
							if($airline != '')
							{
								$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Airline: '.$airline.'</td></tr>';
							}
							if($traveldate != '')
							{
								$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Travel Date: '.$traveldate.'</td></tr>';
							}
							if($phonenumber != '')
							{
								$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Phone Number: '.$phonenumber.'</td></tr>';
							}
							if($accountname != '')
							{
								$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Account Name: '.$accountname.'</td></tr>';
							}
							if($bsb != '')
							{
								$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">BSB: '.$bsb.'</td></tr>';
							}
							if($accountnumber != '')
							{
								$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">Account Number: '.$accountnumber.'</td></tr>';
							}
							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left"> </td></tr>';
								
							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 8px 25px;" colspan="2" align="left">
								We will get back to you within 48 hours of your submissions.</td></tr>';
								
							$mailbody .=  '<tr class="wp-travel-content" style="background: #fff;">
								<td style="font-size: 14px; background: #fff; margin: 0; padding: 0px 0px 40px 25px;" colspan="2" align="left">
								Thank you!</td></tr>';
							$mailbody .=  '</tbody>
							</table>
							</div>
							</center>
							</body>
							</html>';
						$mailbody=stripslashes($mailbody);
						$emailsubject="Request Submitted - Gaura Travel";  
						$path = '';
						$sentto = $emailid;
						include('email/tpl_dispatch_userportal_emails.php');
					
						
						echo '<script>alert("Thank you for submitting refund request. One representative will contact you soon.");</script>';
						echo '<script>window.location.href="?p=dashboard";</script>';
					}
					?>
					<script src="https://cdn.jsdelivr.net/gh/alumuko/vanilla-datetimerange-picker@latest/dist/vanilla-datetimerange-picker.js"></script>
					<script>
						window.addEventListener("load", function (event) {
							let drp = new DateRangePicker('traveldate',
									{
										
										timePicker: false,
										alwaysShowCalendars: true,
										singleDatePicker: true,
										autoApply: true,
										autoUpdateInput: true,
										
										locale: {
											format: "YYYY-MM-DD",
										}
									},
									function (start) {
										document.getElementById("traveldate").value = start.format();
										
									})
							});
						$('#add_pax').on('click', function() {
						  $('#paxcontainer').append('<div class="paxbox" style="display:flex;"><div style="width:96%;"><input type="text" placeholder="Name of Passenger" required onkeypress="return isTextKey(event)" name="pax_name[]"></div><div><button type="button" class="remove">x</button></div></div>');
						});

						$('#paxcontainer').on('click', '.remove', function() {
						  $(this).closest(".paxbox").remove();
						});


						$('#add_ticket').on('click', function() {
						  $('#ticketcontainer').append('<div class="ticketbox" style="display:flex;"><div style="width:96%;"><input type="text" placeholder="Ticket Number" name="ticket_number[]"></div><div><button type="button" class="remove">x</button></div></div>');
						});

						$('#ticketcontainer').on('click', '.remove', function() {
						  $(this).closest(".ticketbox").remove();
						});
					</script>
				<?php	
				}
				
				
				
				
			}
			// customer section end
				
			// staff section start
			if  ( isset($user_role) || (	current_user_can( 'administrator' ) || 
					current_user_can( 'ho_operations' ) ||
					current_user_can( 'datechange_manager' ) || 
					current_user_can( 'user_portal_refund_editor_admin' ) || 
					current_user_can( 'user_portal_refund_editor' ) || 
					current_user_can( 'user_portal_refund_user' ) || 
					current_user_can( 'user_portal_complaint_editor_admin' ) || 
					current_user_can( 'user_portal_complaint_editor' ) || 
					current_user_can( 'user_portal_complaint_user' ) || 
					current_user_can( 'user_portal_datechange_editor_admin' ) || 
					current_user_can( 'user_portal_datechange_editor' ) || 
					current_user_can( 'user_portal_datechange_user' ) || 
					current_user_can( 'user_portal_ssrrequest_editor_admin' ) || 
					current_user_can( 'user_portal_ssrrequest_editor' ) || 
					current_user_can( 'user_portal_ssrrequest_user' ) || 
					current_user_can( 'user_portal_ssrrequest_editor_admin' ) || 
					current_user_can( 'user_portal_ssrrequest_editor' ) || 
					current_user_can( 'user_portal_ssrrequest_user' ) ||
					current_user_can( 'user_portal_datechangemisc_request_editor_admin' ) || 
					current_user_can( 'user_portal_datechangemisc_request_editor' ) || 
					current_user_can( 'user_portal_datechangemisc_request_user' )
					)					
				)
				{	
				    
				    if(isset($_GET['p']) && $_GET['p'] =='review-refund-request-approved')
                    {
                        $auto_id = $_GET['id'];
                        $query_return_transfer = "SELECT * FROM wpk4_backend_travel_payment_outbound_azupay where auto_id = '$auto_id'";
                        $result_return_transfer = mysqli_query($mysqli, $query_return_transfer);
                        $row_return_transfer = mysqli_fetch_assoc($result_return_transfer);
                        
                            $orderId = $row_return_transfer['order_id'];
                            $clientPaymentId = $row_return_transfer['client_payment_id']; // unique id
                            $payeeName = $row_return_transfer['payee_name']; // customer name
                            $paymentDescription = $row_return_transfer['payment_description']; // payment description
                            $customerDescription = $row_return_transfer['customer_reference']; // payment description
                            $paymentAmount = number_format((float)$row_return_transfer['payment_amount'], 2, '.', ''); // amount
                                
                            $payOptionType = $row_return_transfer['payment_option_type']; // either payid or bsb
                                
                            $payIDType = $row_return_transfer['pay_id_type']; // payid type
                            $payID = $row_return_transfer['payid']; // email or phone
                                
                            $bsb = $row_return_transfer['bsb'];
                            $accountNumber = $row_return_transfer['account'];
                            
                            $current_date_and_time = date("Y-m-d H:i:s");
                                $payment_confirmation = transfer_payment_to_customer($orderId, $clientPaymentId, $payeeName, $paymentDescription, $customerDescription, $paymentAmount, $payOptionType, $payIDType, $payID, $bsb, $accountNumber);
                                
                                if(isset($payment_confirmation) && isset($payment_confirmation['paymentId']))
                                {
                                    $azupayStatus = $payment_confirmation['status'];
                                    $azupayPaymentID = $payment_confirmation['paymentId'];
                                    $azupayCreatedDate = date("Y-m-d H:i:s", strtotime( $payment_confirmation['createdDatetime'] ));
                                    $azupayNPPTransactionID = $payment_confirmation['nppTransactionId'];
                                    $azupayCurrentBalance = $payment_confirmation['currentBalance'];
                                    
                                    $sql_update ="UPDATE wpk4_backend_travel_payment_outbound_azupay
                                                    SET azupay_status = '$azupayStatus', azupay_payment_id = '$azupayPaymentID', azupay_created_time = '$azupayCreatedDate', azupay_npp_id = '$azupayNPPTransactionID', 
                                                    azupay_current_balance = '$azupayCurrentBalance', 
                                                    second_confirmed_by = '$currnt_userlogined', request_base_status = 'processed', second_confirmed_on = '$current_date_and_time'
                                                    WHERE auto_id = '$auto_id'";
                                    $results_update = $wpdb->query($sql_update);  
                                    
                                    $paymentAmountNegative = '-'.$paymentAmount;
                                    
                                    // add cancellation here
                                    
                                   
                                                                $is_first_loop_for_availability_update = 0;
                                                                
                                                                $query_select_order = "SELECT * FROM wpk4_backend_travel_bookings where order_id = '$orderId'";
                                                                $result_select_order = mysqli_query($mysqli, $query_select_order);
                                                                while($row_select_order = mysqli_fetch_assoc($result_select_order))
                                                                {
                                                                    $payment_status_stock = $row_select_order['payment_status'];
                                                                    if($payment_status_stock == 'partially_paid')
                                                                    {
                                                                        $trip_code = $row_select_order['trip_code'];
                                                                        $travel_date = $row_select_order['travel_date'];
                                                                        $total_pax = $row_select_order['total_pax'];
                                                			            update_stock_in_pricing_table($trip_code, $travel_date, $total_pax, 'positive');
                                                			            
                                                			            if($is_first_loop_for_availability_update == 0)
                                                			            {
                                                    			            $by_user = 'refund_in_customer_portal';
                                                                    
                                                                            availability_table_pax_update($orderId, $by_user);
                                                                            $is_first_loop_for_availability_update = 1;
                                                			            }
                                                                    }
                                                                }
                                                                
                                                            
                                                        
                                                            $sql_update_past_booking ="UPDATE wpk4_backend_travel_bookings
                                                                SET payment_status = 'waiting_voucher', payment_modified = '$current_date_and_time', payment_modified_by = 'refund_in_customer_portal'
                                                            WHERE order_id = '$orderId' and payment_status IN ('partially_paid', 'canceled')";
                                                            $results_update_past_booking = $wpdb->query($sql_update_past_booking);
                                                            
                                                            if ($results_update_past_booking > 0) 
                                                            {
                                                                mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
					                                            values ('$orderId','','','payment_status','waiting_voucher','$current_date_and_time','customer')") or die(mysqli_error($mysqli));
                                                            } 
                                                            
                                    
                                    mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history ( order_id, reference_no, trams_remarks, payment_method, trams_received_amount, process_date, added_on, added_by, payment_request_id, pay_type ) 
                            	    values ( '$orderId', '$clientPaymentId', '$paymentDescription', '7', '$paymentAmountNegative', '$current_date_and_time', '$current_date_and_time', '$currnt_userlogined', '$azupayPaymentID', 'Refund')") or die(mysqli_error($mysqli));
                                    
                                    echo '<script>alert("Payment has been processed.");</script>';
                                    echo '<script>window.location.href="?p=review-refund-request";</script>';   
                                }
                                else
                                {
                                    echo '<script>alert("Payment processing failed.");</script>';
                                    //error_log("Azupay Outbound Payment Issue: $payment_confirmation");
                                    $sql_update ="UPDATE wpk4_backend_travel_payment_outbound_azupay
                                                    SET error_response = '$payment_confirmation', second_confirmed_by = '$currnt_userlogined', request_base_status = 'failed', second_confirmed_on = '$current_date_and_time'
                                                    WHERE auto_id = '$auto_id'";
                                    $results_update = $wpdb->query($sql_update); 
                                    echo '<script>window.location.href="?p=review-refund-request";</script>';  
                                }
                            
                         
                    }
                    
                    if(isset($_GET['p']) && $_GET['p'] =='review-refund-request')
                    {
                        ?>
                        <script src="https://cdn.jsdelivr.net/gh/alumuko/vanilla-datetimerange-picker@latest/dist/vanilla-datetimerange-picker.js"></script>
                		<script>
                                        window.addEventListener("load", function (event) {
                                    	    var currentdate = new Date(); 
                                    		var end_maxtime = currentdate.getFullYear() + "-" + (currentdate.getMonth()+1)  + "-" + currentdate.getDate();
                                    		let drp = new DateRangePicker('payment_date',
                                            {
                                                maxDate: end_maxtime,
                                                timePicker: false,
                                                alwaysShowCalendars: true,
                                    			singleDatePicker: true,
                                                autoApply: false,
                                    			autoUpdateInput: false,
                                                locale: {
                                                    format: "YYYY-MM-DD",
                                                }
                                            },
                                    		function (start) {
                                    			document.getElementById("payment_date").value = start.format().slice(0,10);
                                            })
                                        });
                        </script>
                        <script>
                        function searchordejs() 
                        {
                            var payment_date = document.getElementById("payment_date").value;
                            var order_id = document.getElementById("order_id").value;
                            window.location='?p=review-refund-request&payment_date=' + payment_date + '&order_id=' + order_id ;
                        }
                        </script>
                        <style>
                        .accounts_general_button_table
                        {
                            width: 90px;
                            padding:8px 12px;
                            font-size: 11px;
                            float:right;
                            margin:0px 5px;
                        }
                        .accounts_general_button
                        {
                            width: 130px;
                            padding:8px 12px;
                            font-size: 11px;
                            float:right;
                            margin:0px 5px;
                        }
                        </style>
                        </br>
                        </br>
                        <table class="table" style="width:100%; margin:auto; border:1px solid #adadad;">
                                	    <tr>
                                	        <td width='8%'>
                                			    Payment Date</br>
                                			    <input type='text' name='payment_date' value='<?php if(isset($_GET['payment_date'])) { echo substr($_GET['payment_date'], 0, 10); } ?>' id='payment_date'>
                                		    </td>
                                		    <td width='8%'>
                                			    Order ID</br>
                                			    <input type='text' name='order_id' value='<?php if(isset($_GET['order_id'])) { echo $_GET['order_id']; } ?>' id='order_id'>
                                		    </td>
                                		</tr>
                                		<tr>
                                			<td colspan="6" style='text-align:center;'>
                                				<button style='padding:10px; margin:0;font-size:11px; ' id='search_orders' onclick="searchordejs()">Search</button>
                                			</td>
                            			</tr>
                            		</table>
                        <?php
                        if(isset($_GET['payment_date']) && $_GET['payment_date'] != '')
                        {
                            $searched_payment_date = $_GET['payment_date'];
                            $payment_date_sql = "date(added_on) = '".$searched_payment_date."' AND ";
                        }
                        else
                        {
                        	//$payment_date_sql = "date(added_on) = CURRENT_DATE() AND ";
                        	$payment_date_sql = "order_id IS NOT NULL AND ";
                        }
                            		
                        if(isset($_GET['order_id']) && $_GET['order_id'] != '')
                        {
                            $searched_order_id = $_GET['order_id'];
                            $order_sql = "order_id = '".$searched_order_id."' AND ";
                        }
                        else
                        {
                            $order_sql = "order_id IS NOT NULL AND ";
                        }
                        
                        if((isset($_GET['order_id']) && $_GET['order_id'] != '') || (isset($_GET['payment_date']) && $_GET['payment_date'] != ''))
                        {
                            $status_sql = "order_id IS NOT NULL ";
                        }
                        else
                        {
                            $status_sql = "request_base_status = 'escalated'  ";
                        }
                        
                        
                        
                        ?>
                        
                        <table class="table table-striped accounts_general_table">
                            <thead>
                                <tr style="font-size:15px;">
                                    <th>OrderID</th>
                                    <th>ClientID</th>
                                    <th>Customer Name</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>Paid to</th>
                                    <th>Generated on</th>
                                    <th>Generated by</th>
                                    <th>Status</th>
                                    <th width="25%"></th>
                                </tr>
                            </thead>
                            <tbody>
                            <?php
                            $query_return_transfer = "SELECT * FROM wpk4_backend_travel_payment_outbound_azupay where $payment_date_sql $order_sql $status_sql order by added_on desc limit 30";
                            if($currnt_userlogined == 'sriharshans' || $currnt_userlogined == 'lee')
            				{
            				    echo $query_return_transfer;
                            }
                            $result_return_transfer = mysqli_query($mysqli, $query_return_transfer);
                            while($row_return_transfer = mysqli_fetch_assoc($result_return_transfer))
                            {
                                if($row_return_transfer['request_base_status'] == 'pending')
                                {
                                    $frontend_status = 'Pending';
                                }
                                else if($row_return_transfer['request_base_status'] == 'firstapproved')
                                {
                                    $frontend_status = 'First Approved';
                                }
                                else if($row_return_transfer['request_base_status'] == 'processed')
                                {
                                    $frontend_status = 'Processed';
                                }
                                else if($row_return_transfer['request_base_status'] == 'failed')
                                {
                                    $frontend_status = 'Failed';
                                }
                                else if($row_return_transfer['request_base_status'] == 'declined')
                                {
                                    $frontend_status = 'Declined';
                                }
                                else if($row_return_transfer['request_base_status'] == 'escalated')
                                {
                                    $frontend_status = 'Escalated by Customer';
                                }
                                else
                                {
                                    $frontend_status = 'Unknown';
                                }
                                ?>
                                <tr style="font-size:13px;">
                                    <td><?php echo $row_return_transfer['order_id']; ?></td>
                                    <td><?php echo $row_return_transfer['client_payment_id']; ?></td>
                                    <td><?php echo $row_return_transfer['payee_name']; ?></td>
                                    <td><?php echo $row_return_transfer['payment_description']; ?></td>
                                    <td><?php echo $row_return_transfer['payment_amount']; ?></td>
                                    <td>
                                        <?php echo $row_return_transfer['payid']; ?>
                                        <?php if($row_return_transfer['bsb'] != '' ) { echo $row_return_transfer['bsb'] .' - ' . $row_return_transfer['account']; } ?>
                                    </td>
                                    <td><?php echo $row_return_transfer['added_on']; ?></td>
                                    <td><?php echo $row_return_transfer['added_by']; ?></td>
                                    <td><?php echo $frontend_status; ?>
                                    </td>
                                    <td>
                                        <?php
                                        if($row_return_transfer['request_base_status'] == 'escalated' && isset($currnt_userlogined) && $currnt_userlogined == 'joyce' && current_user_can( 'administrator' ))
                                        {
                                            ?>
                                            <a href="?p=review-refund-request-approved&id=<?php echo $row_return_transfer['auto_id']; ?>"><button style="background-color:green; color:white; width:120px;" class="accounts_general_button_table">Approve</button></a>
                                            <?php
                                        }
                                        ?>
                                    </td>  	
                                </tr>
                                <?php
                            }
                            ?>
                            </tbody>
                        </table>
                        <?php
                    }
    
					if(isset($_GET['p']) && $_GET['p'] =='flag-chat') // admin flag chats
						{
							$convoid = $_GET['convoid'];
							$chatid = $_GET['chatid'];
							$co = $_GET['co'];
							$t = $_GET['t'];
							$casetype = $_GET['casetype'];
							
							$sql_update = "UPDATE wpk4_backend_user_portal_request_chats SET helpful='1' WHERE auto_id='$convoid'";
							$result= mysqli_query($mysqli,$sql_update);
							
							echo '<script>window.location.href="?p=admin-request-view&id='.$chatid.'&co='.$co.'&t='.$t.'&casetype='.$casetype.'";</script>';
						}
						if(isset($_GET['p']) && $_GET['p'] =='unflag-chat') // admin flag chats
						{
							$convoid = $_GET['convoid'];
							$chatid = $_GET['chatid'];
							$co = $_GET['co'];
							$t = $_GET['t'];
							$casetype = $_GET['casetype'];
							
							$sql_update = "UPDATE wpk4_backend_user_portal_request_chats SET helpful='' WHERE auto_id='$convoid'";
							$result= mysqli_query($mysqli,$sql_update);
							
							echo '<script>window.location.href="?p=admin-request-view&id='.$chatid.'&co='.$co.'&t='.$t.'&casetype='.$casetype.'";</script>';
						}
						
						if(isset($_GET['p']) && $_GET['p'] =='view-cases' && isset($_GET['casetype'])) // admin view all cases
						{
							$user_roles = $current_user->roles;
							$casetype = $_GET['casetype'];
							
							$case_type_role_name_array = $casetype.'_user_roles';
							
							//print_r($user_roles);
							//	echo '</br>';							
							//print_r(${$case_type_role_name_array});
							//	echo '</br>';
							//	echo count(array_intersect($user_roles, ${$case_type_role_name_array}));
								
								
							if ( isset($user_role) || count(array_intersect($user_roles, ${$case_type_role_name_array})) > 0) 
							{
							    if(count(array_intersect($user_roles, ${$case_type_role_name_array})) == 0)
							    {
							       ?> 
							        <style>
							            .view_hidden_options
							            {
							                display:none !important;
							            }
							        </style>
							        <?php
							    }
								$req_today_start = date('Y-m-d').' 00:00:00';
								$req_today_end = date('Y-m-d').' 23:59:59';
					            
					            if($casetype != 'refund')
					            {
								    $query_cases = "SELECT * FROM wpk4_backend_user_portal_requests where status='open' && case_type = '$casetype'";
									$result_cases = mysqli_query($mysqli, $query_cases);
									$row_cases = mysqli_num_rows($result_cases);
									
									$query_cases_today = "SELECT * FROM wpk4_backend_user_portal_requests where case_date>='$req_today_start' && case_date<='$req_today_end' && status='open' && case_type = '$casetype'";
									$result_cases_today = mysqli_query($mysqli, $query_cases_today);
									$row_cases_today = mysqli_num_rows($result_cases_today);
									
								?>
								<center><h6>Total Pendings : <?php echo $row_cases; ?> &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp; Total Received Today : <?php echo $row_cases_today; ?></h6></center></br>
							
							    <?php
					            }
					            else
					            {
    					                $query_cases = "SELECT * FROM wpk4_backend_user_portal_requests where case_type='$casetype' && status='open' && (sub_status IS NULL || sub_status NOT IN ('Refund Received','Refund Applied','Refund FUP with Airline')) ";
    									$result_cases = mysqli_query($mysqli, $query_cases);
    									$row_cases = mysqli_num_rows($result_cases);
    								
    								    $query_refund_airline = "SELECT * FROM wpk4_backend_user_portal_requests where case_type='$casetype' && status='open' && sub_status IN ('Refund Received','Refund Applied','Refund FUP with Airline')";
					                    $result_refund_airline = mysqli_query($mysqli, $query_refund_airline);
					                    $row_refund_airline = mysqli_num_rows($result_refund_airline);
    									
    									$query_cases_today = "SELECT * FROM wpk4_backend_user_portal_requests where case_date>='$req_today_start' && case_date<='$req_today_end' && status='open' && case_type = '$casetype'";
    									$result_cases_today = mysqli_query($mysqli, $query_cases_today);
    									$row_cases_today = mysqli_num_rows($result_cases_today);
    									
    								?>
    								<center><h6>Total Pendings : <?php echo $row_cases; ?> &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp; Total Awaiting Airlines : <?php echo $row_refund_airline; ?> &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp; Total Received Today : <?php echo $row_cases_today; ?></h6></center></br>
    							
    							    <?php  
					            }
							    ?>
							<style>
							td
							{
								height:60px;
								vertical-align: middle;
							}
							</style>
							<h5>Manage <?php echo $casetype; ?> requests</h5>
							<script src="https://cdn.jsdelivr.net/gh/alumuko/vanilla-datetimerange-picker@latest/dist/vanilla-datetimerange-picker.js"></script>
							<script>
								window.addEventListener("load", function (event) {
								var currentdate = new Date(); 					
									let drp = new DateRangePicker('tripdate_selector_1',
										{
											timePicker: false,
											alwaysShowCalendars: true,
											singleDatePicker: true,
											autoApply: false,
											autoUpdateInput: false,
											
											locale: {
												format: "YYYY-MM-DD",
											}
										},
										//function (start, end) {
										function (start) {
											document.getElementById("tripdate_selector_1").value = start.format();	
											if(document.getElementById("tripdate_selector_2").value == '')
											{
											document.getElementById("tripdate_selector_2").value = start.format();
											}						
										})
									});
								window.addEventListener("load", function (event) {
								var maxdate_1 = document.getElementById("tripdate_selector_1").value;
								let drp = new DateRangePicker('tripdate_selector_2',
										{
											timePicker: false,
											alwaysShowCalendars: true,
											singleDatePicker: true,
											autoApply: false,
											autoUpdateInput: false,                        
											locale: {
												format: "YYYY-MM-DD",
											}
										},
										function (start) {
											
											if(document.getElementById("tripdate_selector_1").value != '')
											{
											document.getElementById("tripdate_selector_2").value = start.format();
											}
											else
											{
												document.getElementById("tripdate_selector_1").value = start.format();
											}
										
											
										})
									});
							</script>
							<script type="text/javascript">
							function searchordejs() {
								var casetype = $("#case_type").val();
								var date_1 = document.getElementById("tripdate_selector_1").value;
								var date_2 = document.getElementById("tripdate_selector_2").value;
								var status = document.getElementById("status_selector").value;
								var id_selector = document.getElementById("id_selector").value;	
								var reply_selector = document.getElementById("reply_selector").value;
								var caseid_selector = document.getElementById("caseid_selector").value;	
								window.location='?p=view-cases&start=' + date_1 + '&end=' + date_2 + '&status=' + status +'&cid=' + caseid_selector + '&id=' + id_selector + '&reply=' + reply_selector + '&casetype=' + casetype;
							}
							</script>
							<table class="table" style="width:100%; margin:auto; border:1px solid #adadad;">
							<tr>
							<td width='16.5%'>Start Date
							<input type='text' name='tripdate_selector_1' value='<?php if(isset($_GET['start'])) { echo $_GET['start']; } ?>' id='tripdate_selector_1'>
							</td>
							<td width='16.5%'>End Date
							<input type='text' name='tripdate_selector_2' value='<?php if(isset($_GET['end'])) { echo $_GET['end']; } ?>' id='tripdate_selector_2'>
							</td>
							<td width='16.5%'>Case ID</br>
							<input type='text' name='caseid_selector' value='<?php if(isset($_GET['cid'])) { echo $_GET['cid']; } ?>' id='caseid_selector'></td>
							<td width='16.5%'>Reservation Code</br>
							<input type='text' name='id_selector' value='<?php if(isset($_GET['id'])) { echo $_GET['id']; } ?>' id='id_selector'></td>

							<td width='16.5%'>Status
							<select name='status_selector' id='status_selector' style="width:100%; padding:10px;">
								<option value='' <?php if(isset($_GET['status']) && $_GET['status']=='') { echo 'selected'; } ?>>All</option>
								<?php
								if($casetype == 'refund')
								{
								    ?>
									<option value='All Pending' <?php if(isset($_GET['status']) && $_GET['status']=="All Pending") { echo 'selected'; } ?>>All Pending</option>
									<option value='All Airline Pending' <?php if(isset($_GET['status']) && $_GET['status']=="All Airline Pending") { echo 'selected'; } ?>>All Airline Pending</option>
								<?php
							    }
							    ?>
								<?php
								$casetype_status_filter = $casetype.'_filter'; 
								$query = "SELECT * FROM wpk4_backend_term_keys where category = '$casetype_status_filter' && option_type = 'status'";
								$result = mysqli_query($mysqli, $query);
								while($row = mysqli_fetch_assoc($result))
								{
								?>
									<option value='<?php echo $row['option_value']; ?>' <?php if(isset($_GET['status']) && $_GET['status']==$row['option_value']) { echo 'selected'; } ?>><?php echo $row['option_value']; ?></option>
								<?php
								}
								?>
								<?php
								if($casetype == 'datechange_misc')
    											{
    												?>
													<option value='open' <?php if(isset($_GET['status']) && $_GET['status']=='open') { echo 'selected'; } ?>>Open</option>
													<option value='accept' <?php if(isset($_GET['status']) && $_GET['status']=='accept') { echo 'selected'; } ?>>Accept</option>
    												<?php
												}
								?>
								<option value='invalid' <?php if(isset($_GET['status']) && $_GET['status']=='invalid') { echo 'selected'; } ?>>Invalid</option>
								
								
							</select>
							</td>
							<td width='16.5%'>Reply
							<select name='reply_selector' id='reply_selector' style="width:100%; padding:10px;">
							<option value='' <?php if(isset($_GET['reply']) && $_GET['reply']=='') { echo 'selected'; } ?>>All</option>
							<option value='customer' <?php if(isset($_GET['reply']) && $_GET['reply']=='customer') { echo 'selected'; } ?>>Awaiting for reply</option>
							<option value='gtx' <?php if(isset($_GET['reply']) && $_GET['reply']=='gtx') { echo 'selected'; } ?>>Awaiting for GT reply</option>
							</select>
							</td>
							</tr>
							<tr>
							<td colspan='6' style='text-align:center;'>
							<button style='padding:10px; margin:0;font-size:11px; ' id='search_orders' onclick="searchordejs()">Search</button>
							</td>
							</tr>
							</table>
							</br>
							<?php
							if($casetype == 'complaint')
							{
							?>
							<style>
                            ol {
                                margin: 0;
                                padding-left: 20px;
                                line-height: 1.6;
                            }
                            li {
                                margin-bottom: 10px;
                            }
                            
                            </style>
							<h5>Convincing Skills:</h5>
							<ol>
							    <li>Investigate the case, Listen the call recordings.</li>
                                <li>Pax acknowledged T&C so that it is pax responsibility to check all fare rules with T&C before ticking the box.</li>
                                <li>Stick to the policies & Keep referring to T&C.</li>
                                <li>Cross Question / Argument - Why the Pax did not check with the Agent.</li>
                                <li>You booked the ticket from your side and the Agent does not see your screen.</li>
                                <li>Itinerary email sent to pax, pax need to check all the details from their end.</li>
                                <li>If the agent did not inform you regarding any type of query, then just explain that if you want to know anything specific about the conditions then you must check with the agent from your end before holding the reservations.</li>
							</ol><br />
							<?php
							}
							$x_id = 1;

							$req_start = $_GET['start'];
							$req_end = $_GET['end'];

							$req_start_1 = $_GET['start'];
							$req_start_1 = substr($req_start_1, 0, 10).' 00:00:00';

							$req_end_1 = $_GET['end'];
							$req_end_1 = substr($req_end_1, 0, 10).' 23:59:59';

							$req_today_start_1 = date('Y-m-d').' 00:00:00';
							$req_today_end_1 = date('Y-m-d').' 23:59:59';
							$req_caseid = $_GET['cid'];
							$req_status = $_GET['status'];
							$req_id = $_GET['id'];
							$req_reply = $_GET['reply'];
							
							if($req_start !='')
							{
								$date_query = " case_date>='".$req_start_1 ."' AND case_date<='".$req_end_1."' AND ";
							}
							else
							{
								$date_query = "case_id !='0' AND ";
							}
							
							if($_GET['status'] !='')
							{
								if($_GET['status'] == 'open' || $_GET['status'] == 'Open' || $_GET['status'] == 'Processing' || $_GET['status'] == 'Following Up' || $_GET['status'] == 'Follow-up rejected' || $_GET['status'] == 'Follow-up accepted' || $_GET['status'] == 'Awaiting HO' || $_GET['status'] == 'Refund Applied' || $_GET['status'] == 'Refund FUP with Airline' || $_GET['status'] == 'Refund Received')
									{
										if($_GET['status'] == 'open' || $_GET['status'] == 'Open')
											{
												$main_status = 'open';
												$sub_status = '';
												$status_query = "status='".$main_status."' AND ";
											}
											else
											{
												$main_status = 'open';
												$sub_status = $_GET['status'];
												$status_query = "status='".$main_status."' AND sub_status='".$sub_status."' AND ";
											}
									}
									else if($_GET['status'] == 'All Pending')
									{
										$main_status = 'open';
										$sub_status = '';
										$status_query = "status='".$main_status."' AND (sub_status IS NULL || sub_status='' || sub_status='Processing' || sub_status='Following Up' || sub_status='Follw-up rejected' || sub_status='Follow-up accepted' || sub_status='Awaiting HO') AND ";
									}
									else if($_GET['status'] == 'All Airline Pending')
									{
										$main_status = 'open';
										$sub_status = '';
										$status_query = "status='".$main_status."' AND (sub_status='Refund Applied' || sub_status='Refund FUP with Airline' || sub_status='Refund Received') AND ";
									}
									else if($_GET['status'] == 'fail' || $_GET['status'] == 'Fail')
									{
										$main_status = 'fail';
										$sub_status = '';
										$status_query = "status='".$main_status."' AND ";
									}
									else if($_GET['status'] == 'invalid' || $_GET['status'] == 'Invalid')
									{
										$main_status = 'invalid';
										$sub_status = '';
										$status_query = "status='".$main_status."' AND ";
									}
									else if($_GET['status'] == 'accept')
									{
										$main_status = 'accept';
										$sub_status = '';
										$status_query = "status='".$main_status."' AND ";
									}
									else if($_GET['status'] == 'Success' || $_GET['status'] == 'success')
									{
										$main_status = 'success';
										$sub_status = '';
										$status_query = "status='".$main_status."' AND ";
									}
							}
							else
							{
								$status_query = "case_id!='0' AND ";
							}
							
							if($req_id !='')
							{
								$id_query = "reservation_ref='".$req_id."' AND ";
							}
							else
							{
								$id_query = "case_id !='0' AND ";
							}
							
							if($req_caseid !='')
							{
								$cid_query = "case_id ='".$req_caseid."' AND ";
							}
							else
							{
								$cid_query = "case_id !='0' AND ";
							}
							
							if($req_reply !='')
							{
								if($req_reply == 'customer')
								{
									$reply_query = "last_response_by='admin'";
								}
								else if($req_reply == 'gtx')
								{
									$reply_query = "(last_response_by='customer' || last_response_by='NULL')";
								}
								else
								{
									$reply_query = "last_response_by!='0' ";
								}
								
							}
							else
							{
								$reply_query = "case_id!='0'";
							}
							
							$case_type_query = "case_type ='".$casetype."' AND ";
							
							if($casetype == 'ssr_request' || $casetype == 'datechange')
							{
							    $list_count = 300;
							}
							else
							{
							    $list_count = 100;
							}
							
							if($req_start !='' || $req_status !='' || $req_id !='' || $cid_query !='')
							{
								$query = "SELECT * FROM wpk4_backend_user_portal_requests where $case_type_query $date_query $status_query $cid_query $id_query $reply_query order by last_response_on DESC limit $list_count"; //run with main table
							}
							else
							{
								$query = "SELECT * FROM wpk4_backend_user_portal_requests where $case_type_query requested_time>='$req_today_start_1 ' && requested_time<='$req_today_end_1' order by last_response_on DESC limit $list_count";
							}
							//echo $query;
							if($currnt_userlogined == 'sriharshans' || $currnt_userlogined == 'lee')
            				{
            				    echo $query;
                            }
							$query = str_replace("&&","|@|",$query);
							
								echo '<input type="hidden" id="formquery" value="'.$query.'">';
								echo '<input type="hidden" id="case_type" value="'.$_GET['casetype'].'">';
								echo '<input type="hidden" id="user_role" value="'.$user_role.'">';
								echo '<input type="hidden" id="user_name_value" value="'.$currnt_userlogined.'">';
								echo "<div id='reloadornot'></div>
								<div id='chatboxwindow'></div>";
							?>
							<script>
							window.setInterval( function isnewupdate() {
							var str = $("#case_type").val();
							var last_updated_value = $("#last_updated_id").val();
							  if (str == "") {
								return;
							  } else {
								var xmlhttp = new XMLHttpRequest();
								xmlhttp.onreadystatechange = function() {
								  if (this.readyState == 4 && this.status == 200) {
									var reloadchecker = $("#reloadchecker").val();
									document.getElementById("reloadornot").innerHTML = this.responseText;
									if(reloadchecker=='reload') // have new update_priority
									{
										showChats();
									}
								  }
								};
								xmlhttp.open("GET","<?php echo $themepath; ?>/templates/tpl_user_portal_backend.php/?checknewrequests="+str+"&lastvalue="+last_updated_value,true);
								xmlhttp.send();
							  }
							}, 60000);

							$(document).ready(function() {
								showChats();
							});
                            /*
							function showChats() {
								
								var str = $("#case_type").val();
								var userrole = $("#user_role").val();
								var formquery_selection = $("#formquery").val();
								var xmlhttp = new XMLHttpRequest();
								xmlhttp.onreadystatechange = function() {
								  if (this.readyState == 4 && this.status == 200) {
									document.getElementById("chatboxwindow").innerHTML = this.responseText;
								  }
								};
								xmlhttp.open("GET","<?php echo $themepath; ?>/templates/tpl_user_portal_backend.php/?view_requests="+str+"&query="+formquery_selection+"&user="+userrole,true);
								xmlhttp.send();
							  
							}
							*/
							function showChats() 
							{
                                var str = $("#case_type").val();
                                var userrole = $("#user_role").val();
                                var formquery_selection = $("#formquery").val();
                                var user_name_value = $("#user_name_value").val();
                        
                                $.ajax({
                                    url: "<?php echo $themepath; ?>/templates/tpl_user_portal_backend.php",
                                    type: "GET",
                                    data: {
                                        view_requests: str,
                                        query: formquery_selection,
                                        userlogined: user_name_value,
                                        user: userrole
                                    },
                                    success: function(response) {
                                        // Load the response inside the chatbox window
                                        $("#chatboxwindow").html(response);
                        
                                        // Destroy existing DataTable (if any)
                                        if ($.fn.DataTable.isDataTable("#example1")) {
                                            $('#example1').DataTable().destroy();
                                        }
                                        if(str == 'ssr_request' || str == 'datechange')
                                        {
                                            // Reinitialize DataTable after new content is loaded
                                            $("#example1").DataTable({
                                                order: [[3, 'asc']], // Sort by the 4th column (adjust index as needed)
                                                paging: false, // Enable pagination
                                                searching: false, // Enable search filter
                                                responsive: true // Make it mobile-friendly
                                            });
                                        }
                                    }
                                });
                            }
							</script>	
							</br>
							<?php
							}
						}
						
						
						
						
						
						
						
						
						if(isset($_GET['p']) && $_GET['p'] =='manage-datechange-v2' && !isset($_GET['part']))
					{
						echo '</br></br></br>';
						    $order_id = $_GET['oid'];
													    
                    		$query_pax = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id' order by travel_date asc limit 1;";
                    		$result_pax = mysqli_query($mysqli, $query_pax);
                    		?>
                    		<h6>Order ID : <?php echo $order_id; ?></h6>
                    		<?php
                    		if(!empty($result_pax))
                    		{
                    			while($row_pax = mysqli_fetch_assoc($result_pax))
                    			{
                    			?>
                    				<form action="#" name="statusupdate" id="divideForm" method="post" enctype="multipart/form-data" style='font-size:13px;'>
                    				    <table class="table table-striped" style="width:100%;"><thead><tr><th width='10%'>Check</th><th>Name</th><th>Passport</th><th>DOB</th></tr></thead><tbody>
                    				<?php
                    				$order_id = $row_pax['order_id'];
                    				$co_order_id_db = $row_pax['co_order_id'];
                    				$product_id = $row_pax['product_id'];
                    				$order_type = $row_pax['order_type'];
                    				
									echo '<input type="hidden" name="id" id="teammembers_status" value="'.$order_id.'">';
									echo '<input type="hidden" name="co_orderid" id="teammembers_status" value="'.$co_order_id_db.'">';
									echo '<input type="hidden" name="productid" id="teammembers_status" value="'.$product_id.'">';
									echo '<input type="hidden" name="order_type" id="teammembers_status" value="'.$order_type.'">';
									
                    				if($order_type != 'gds') // wpt
                    				{
                    				    $query_paxc = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id' and co_order_id = '$co_order_id_db' AND product_id = '$product_id' ";
                        				$result_paxc = mysqli_query($mysqli, $query_paxc);
                        				$row_pax_count = mysqli_num_rows($result_paxc);
                        				while($row_paxc = mysqli_fetch_assoc($result_paxc))
                        				{
                        					$salutation = $row_paxc['salutation']; 
                        					$fname = $row_paxc['fname']; 
                        					$lname = $row_paxc['lname']; 
                        					$ppn = $row_paxc['ppn']; 
                        					$dob = $row_paxc['dob']; 
                        					$auto_id = $row_paxc['auto_id'];
                        					?>
                        					<tr><td>
                        					<?php
                        					if($row_pax_count > 1)
                        					{
                        					?>
                        						<input type="checkbox" checked id="pxe" name="pax_ids_for_new_order[]" class="pxe" value="<?php echo $auto_id; ?>">
                        					<?php
                        					}
                        					else
                        					{
                        					
                        					}
                        					?>
                        					</td><td><?php echo $salutation; ?> <?php echo $fname; ?> <?php echo $lname; ?></td><td><?php echo $ppn; ?></td><td><?php echo $dob; ?></td></tr>
                        				<?php
                        				}
                    				}
                    				else // gds
                    				{
                    				    $query_paxc = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id' and co_order_id = '$co_order_id_db' ";
                        				$result_paxc = mysqli_query($mysqli, $query_paxc);
                        				$row_pax_count = mysqli_num_rows($result_paxc);
                        				while($row_paxc = mysqli_fetch_assoc($result_paxc))
                        				{
                        					$salutation = $row_paxc['salutation']; 
                        					$fname = $row_paxc['fname']; 
                        					$lname = $row_paxc['lname']; 
                        					$ppn = $row_paxc['ppn']; 
                        					$dob = $row_paxc['dob']; 
                        					$auto_id = $row_paxc['auto_id'];
                        					?>
                        					<tr><td>
                        					<?php
                        					if($row_pax_count > 1)
                        					{
                        					?>
                        						<input type="checkbox" checked id="pxe" name="pax_ids_for_new_order[]" class="pxe"  value="<?php echo $auto_id; ?>">
                        					<?php
                        					}
                        					
                        					?>
                        					</td><td><?php echo $salutation; ?> <?php echo $fname; ?> <?php echo $lname; ?></td><td><?php echo $ppn; ?></td><td><?php echo $dob; ?></td></tr>
                        				<?php
                        				}
                    				}
                    				?>
                    				<tr><td colspan='4'></td></tr></tbody>
                    				</table>
                    			<?php
                    			}
								?>
								<div id="divide_submit" style="display:none;">
									<input type="submit" style="padding:15px; margin:0; font-size:11px;" name="divideorder" value="Divide & Next">
								</div>
								<div id="next_without_divide" >
									<input type="submit" style="padding:15px; margin:0; font-size:11px;" name="without_divideorder" value="Clone & Next">
								</div>
								</form>
								<script>
                                document.getElementById('divideForm').addEventListener('submit', function (e) {
                                    // Identify which submit button was clicked
                                    const clickedButton = document.activeElement;
                                
                                    // Only show confirmation for divide or clone actions
                                    if (
                                        clickedButton &&
                                        (clickedButton.name === 'divideorder' || clickedButton.name === 'without_divideorder')
                                    ) {
                                        const confirmMsg = "Do you want to continue with the passenger(s) selected?";
                                        if (!confirm(confirmMsg)) {
                                            e.preventDefault(); // Stop the form from submitting
                                        }
                                    }
                                });
                                </script>
								<script>
								function updateButtonVisibility() {
									const checkboxes = Array.from(document.querySelectorAll('.pxe'));
									const total = checkboxes.length;
									const checkedCount = checkboxes.filter(cb => cb.checked).length;

									if (checkedCount === 0 || checkedCount === total) {
										// All or none are selected
										document.getElementById('next_without_divide').style.display = 'block';
										document.getElementById('divide_submit').style.display = 'none';
									} else {
										// Some but not all are selected
										document.getElementById('next_without_divide').style.display = 'none';
										document.getElementById('divide_submit').style.display = 'block';
									}
								}

								// Attach listener to all checkboxes
								document.querySelectorAll('.pxe').forEach(function(checkbox) {
									checkbox.addEventListener('change', updateButtonVisibility);
								});

								// Run once on page load in case of pre-checked boxes
								updateButtonVisibility();
								</script>
								<?php
                    	}	
                    	if (isset($_POST['divideorder'])) 
						{
								$order_id = $_GET['oid'];
								$case_id = $_GET['cid'];
								$orderid = $_POST['id'];
								$co_orderid = $_POST['co_orderid'] ?? '';
								$productid = $_POST['productid'] ?? '';
								//$order_type = $_POST['order_type'] ?? '';
								$selected_ids = $_POST['pax_ids_for_new_order'] ?? [];
								
								if(empty($selected_ids))
								{
								    $all_pax_query = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
    								$result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));
    								while ($pax = mysqli_fetch_assoc($result_all_pax)) 
    								{
    								    $pax_a_id = $pax['auto_id'];
    								    $selected_ids[] = $pax_a_id;
    								}
								}
								
								$all_pax_query = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
								$result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));
								while ($pax = mysqli_fetch_assoc($result_all_pax)) 
								{
									if (in_array($pax['auto_id'], $selected_ids))
									{
									    $pax_a_id = $pax['auto_id'];
									    $fname = $pax['fname'];
									    $lname = $pax['lname'];
										$dob = $pax['dob'];
										$salutation = $pax['salutation'];
									    
									    $all_pax_query_inner = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE auto_id != '$pax_a_id' and order_id = '$orderid' and salutation = '$salutation' and fname = '$fname' and lname = '$lname' and dob = '$dob'";
								        $result_all_pax_inner = mysqli_query($mysqli, $all_pax_query_inner) or die(" Pax query failed: " . mysqli_error($mysqli));
										if(mysqli_num_rows($result_all_pax_inner) > 0)
										{
											$pax_inner = mysqli_fetch_assoc($result_all_pax_inner);
											$inner_a_id = $pax_inner['auto_id'];
											$selected_ids[] = $inner_a_id;
										}
									}
								}
								

						        //print_r($selected_ids);
						        $selected_ids = array_unique($selected_ids);	

								// Enable error reporting for mysqli
								mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT);

								// Get new order_id
								$res_max_order = mysqli_query($mysqli, "SELECT MAX(order_id) AS max_order_id FROM wpk4_backend_travel_bookings");
								$max_row = mysqli_fetch_assoc($res_max_order);
								$new_order_id = $max_row['max_order_id'] + 1;
								
								$res_max_order = mysqli_query($mysqli, "SELECT MAX(order_id) AS max_order_id FROM wpk4_backend_travel_bookings");
								$max_row = mysqli_fetch_assoc($res_max_order);
								$divided_order_id = $max_row['max_order_id'] + 2;

								$pax_in_non_divided = 0;
                                $pax_in_divided = 0;
                                $all_pax_query = "SELECT auto_id FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
								$result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));

								while ($pax = mysqli_fetch_assoc($result_all_pax)) {
								    
									if (in_array($pax['auto_id'], $selected_ids)) 
									{
									    $pax_in_divided++;
									}
									
									if (!in_array($pax['auto_id'], $selected_ids)) 
									{
									    $pax_in_non_divided++;
									}
								}
								
								if ($order_type != 'gds') // NOT GDS
                                {
									if($pax_in_divided > 1)
									{
										$pax_in_divided = $pax_in_divided / 2;
									}
									if($pax_in_non_divided > 1)
									{
										$pax_in_non_divided = $pax_in_non_divided / 2;
									}
								}
								
								if ($order_type == 'gds') // GDS
                                {
									$divided_pax_to_be_paid_total = 0;
									$non_divided_pax_to_be_paid_total = 0;
									
									$all_pax_query_paid_calculator = "SELECT auto_id, pnr, gds_pax_id FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid'";
									$result_all_pax_paid_calculator = mysqli_query($mysqli, $all_pax_query_paid_calculator) or die(" Pax query failed: " . mysqli_error($mysqli));
									while ($pax_paid_calculator = mysqli_fetch_assoc($result_all_pax_paid_calculator)) 
									{
										if (in_array($pax_paid_calculator['auto_id'], $selected_ids)) 
										{
											$pnr_pax_amt = $pax_paid_calculator['pnr'];
											$gds_id_pax_amt = $pax_paid_calculator['gds_pax_id'];
												
											$all_pax_query_fit_amt = "SELECT PriceSell FROM `wpk4_ypsilon_bookings_table_fare` WHERE PaxId = '$gds_id_pax_amt'";
											$result_pax_query_fit_amt = mysqli_query($mysqli, $all_pax_query_fit_amt) or die(" Pax query failed: " . mysqli_error($mysqli));
											$pax_pax_query_fit_amt = mysqli_fetch_assoc($result_pax_query_fit_amt);
											$pax_PriceSell = $pax_pax_query_fit_amt['PriceSell'];
											
											$all_pax_query_fit_amt2 = "SELECT Amount FROM `wpk4_ypsilon_bookings_table_tax` WHERE PaxId = '$gds_id_pax_amt'";
											$result_pax_query_fit_amt2 = mysqli_query($mysqli, $all_pax_query_fit_amt2) or die(" Pax query failed: " . mysqli_error($mysqli));
											$pax_pax_query_fit_amt2 = mysqli_fetch_assoc($result_pax_query_fit_amt2);
											$pax_TaxAmount = $pax_pax_query_fit_amt2['Amount'];
											
											$divided_pax_to_be_paid_total += (float)$pax_PriceSell + (float)$pax_TaxAmount;
										}
										
										if (!in_array($pax_paid_calculator['auto_id'], $selected_ids)) 
										{
											$pnr_pax_amt = $pax_paid_calculator['pnr'];
											$gds_id_pax_amt = $pax_paid_calculator['gds_pax_id'];
												
											$all_pax_query_fit_amt = "SELECT PriceSell FROM `wpk4_ypsilon_bookings_table_fare` WHERE PaxId = '$gds_id_pax_amt'";
											$result_pax_query_fit_amt = mysqli_query($mysqli, $all_pax_query_fit_amt) or die(" Pax query failed: " . mysqli_error($mysqli));
											$pax_pax_query_fit_amt = mysqli_fetch_assoc($result_pax_query_fit_amt);
											$pax_PriceSell = $pax_pax_query_fit_amt['PriceSell'];
											
											$all_pax_query_fit_amt2 = "SELECT Amount FROM `wpk4_ypsilon_bookings_table_tax` WHERE PaxId = '$gds_id_pax_amt'";
											$result_pax_query_fit_amt2 = mysqli_query($mysqli, $all_pax_query_fit_amt2) or die(" Pax query failed: " . mysqli_error($mysqli));
											$pax_pax_query_fit_amt2 = mysqli_fetch_assoc($result_pax_query_fit_amt2);
											$pax_TaxAmount = $pax_pax_query_fit_amt2['Amount'];
											
											$non_divided_pax_to_be_paid_total += (float)$pax_PriceSell + (float)$pax_TaxAmount;
										}
									}
								}
								else
								{
									
									$divided_pax_to_be_paid_total = 0;
									$non_divided_pax_to_be_paid_total = 0;
									
									$all_pax_query_paid_calculator = "SELECT auto_id, trip_price_individual  FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
									$result_all_pax_paid_calculator = mysqli_query($mysqli, $all_pax_query_paid_calculator) or die(" Pax query failed: " . mysqli_error($mysqli));

									while ($pax_paid_calculator = mysqli_fetch_assoc($result_all_pax_paid_calculator)) 
									{
										if (in_array($pax_paid_calculator['auto_id'], $selected_ids)) 
										{
											$divided_pax_to_be_paid_total += $pax_paid_calculator['trip_price_individual'];
										}
										
										if (!in_array($pax_paid_calculator['auto_id'], $selected_ids)) 
										{
											$non_divided_pax_to_be_paid_total += $pax_paid_calculator['trip_price_individual'];
										}
									}
								}	
																
								// Fetch existing bookings
                                $res_booking = mysqli_query($mysqli, "SELECT * FROM wpk4_backend_travel_bookings WHERE order_id = '$order_id'");
                                if (!$res_booking || mysqli_num_rows($res_booking) === 0) {
                                    die(" No booking found for order_id = $order_id");
                                }
                                
                                // Store all booking rows into array
                                $all_booking_rows = [];
                                while ($row = mysqli_fetch_assoc($res_booking)) {
                                    $all_booking_rows[] = $row;
                                }
                                
                                // First loop: insert with new_order_id
                                foreach ($all_booking_rows as $booking_data) {
                                    $booking_data['previous_order_id'] = $order_id;
                                    $booking_data['order_id'] = $new_order_id;
                                    unset($booking_data['auto_id']);
                                
                                    if (empty($booking_data['divided_date'])) unset($booking_data['divided_date']);
                                    if (empty($booking_data['late_modified'])) unset($booking_data['late_modified']);
                                    if (empty($booking_data['airline_ttl_deadline'])) unset($booking_data['airline_ttl_deadline']);
                                    if (empty($booking_data['price_time_limit'])) unset($booking_data['price_time_limit']);
                                    if (empty($booking_data['ticketing_timelimit'])) unset($booking_data['ticketing_timelimit']);
                                    if (empty($booking_data['return_date'])) unset($booking_data['return_date']);
									if (empty($booking_data['family_id'])) unset($booking_data['family_id']);
									if (empty($booking_data['journal_date'])) unset($booking_data['journal_date']);
                                    
									unset($booking_data['payment_modified']);
									$booking_data['source'] = "datechange"; 
									$booking_data['agent_info'] = $currnt_userlogined;
									 
                                    //$booking_data['payment_status'] = "partially_paid";
									//$booking_data['deposit_deadline'] = date("Y-m-d") . ' 23:59:59';
									//$booking_data['full_payment_deadline'] = date("Y-m-d") . ' 23:59:59';
									$booking_data['deposit_deadline'] = date("Y-m-d H:i:s", strtotime("+1 day"));
									$booking_data['full_payment_deadline'] = date("Y-m-d H:i:s", strtotime("+1 day"));

                                
                                    $booking_data['total_pax'] = $pax_in_non_divided;
									
									$booking_data['total_amount'] = $non_divided_pax_to_be_paid_total;
									unset($booking_data['balance']);
									
									$booking_data['added_on'] = date("Y-m-d H:i:s");
                                
                                    $columns = array_keys($booking_data);
                                    $values = array_map(function ($val) use ($mysqli) {
                                        if (!empty($val))
											{
												return "'" . mysqli_real_escape_string($mysqli, $val) . "'";
											}
											else
											{
												return "'" . $val . "'";
											}
                                    }, array_values($booking_data));
                                
                                    $insert_booking = "INSERT INTO wpk4_backend_travel_bookings (" . implode(',', $columns) . ") VALUES (" . implode(',', $values) . ")";
                                    if (!mysqli_query($mysqli, $insert_booking)) {
                                        die(" Booking insert failed (new_order_id): " . mysqli_error($mysqli));
                                    }
                                }
                                
                                // Second loop: insert with divided_order_id
                                foreach ($all_booking_rows as $booking_data) {
                                    $booking_data['previous_order_id'] = $order_id;
                                    $booking_data['order_id'] = $divided_order_id;
                                    unset($booking_data['auto_id']);
                                
                                    if (empty($booking_data['divided_date'])) unset($booking_data['divided_date']);
                                    if (empty($booking_data['late_modified'])) unset($booking_data['late_modified']);
                                    if (empty($booking_data['airline_ttl_deadline'])) unset($booking_data['airline_ttl_deadline']);
                                    if (empty($booking_data['price_time_limit'])) unset($booking_data['price_time_limit']);
                                    if (empty($booking_data['ticketing_timelimit'])) unset($booking_data['ticketing_timelimit']);
                                    if (empty($booking_data['return_date'])) unset($booking_data['return_date']);
									if (empty($booking_data['family_id'])) unset($booking_data['family_id']);
									if (empty($booking_data['journal_date'])) unset($booking_data['journal_date']);
									
									unset($booking_data['payment_modified']);
									$booking_data['source'] = "datechange";
                                    $booking_data['payment_status'] = "partially_paid";
									//$booking_data['deposit_deadline'] = date("Y-m-d") . ' 23:59:59';
									//$booking_data['full_payment_deadline'] = date("Y-m-d") . ' 23:59:59';
									
									$booking_data['deposit_deadline'] = date("Y-m-d H:i:s", strtotime("+1 day"));
									$booking_data['full_payment_deadline'] = date("Y-m-d H:i:s", strtotime("+1 day"));
									
									$booking_data['agent_info'] = $currnt_userlogined;
                                
                                    $booking_data['total_pax'] = $pax_in_divided;
									
									$booking_data['total_amount'] = $divided_pax_to_be_paid_total;
									unset($booking_data['balance']);
									$booking_data['added_on'] = date("Y-m-d H:i:s");
                                
                                    $columns = array_keys($booking_data);
                                    $values = array_map(function ($val) use ($mysqli) {
                                        if (!empty($val))
											{
												return "'" . mysqli_real_escape_string($mysqli, $val) . "'";
											}
											else
											{
												return "'" . $val . "'";
											}
                                    }, array_values($booking_data));
                                
                                    $insert_booking = "INSERT INTO wpk4_backend_travel_bookings (" . implode(',', $columns) . ") VALUES (" . implode(',', $values) . ")";
                                    if (!mysqli_query($mysqli, $insert_booking)) {
                                        die(" Booking insert failed (divided_order_id): " . mysqli_error($mysqli));
                                    }
                                }

                                
                                

								// Process unselected passengers
								$all_pax_query = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid'";
                                $result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));
                                
                                // Store all pax in array
                                $all_pax = [];
                                while ($row = mysqli_fetch_assoc($result_all_pax)) {
                                    $all_pax[] = $row;
                                }
                                
                                // Loop 1: for pax NOT in selected_ids  assign to $new_order_id
                                foreach ($all_pax as $pax) {
                                    if (!in_array($pax['auto_id'], $selected_ids)) {
                                        $original_auto_id = $pax['auto_id'];
										$booking_data['previous_order_id'] = $order_id;
                                        $pax['order_id'] = $new_order_id;
                                
                                        unset($pax['auto_id']);
                                        if (empty($pax['trams_profile_id'])) unset($pax['trams_profile_id']);
                                        
										if (empty($pax['customer_id'])) unset($pax['customer_id']);
										
										unset($pax['ticketed_on']);
										unset($pax['ticketing_audit_on']);
										unset($pax['name_audit_on']);
										unset($pax['ticketing_remarks_on']);
										unset($pax['ticketing_in_progress_on']);
										unset($pax['ticketed_by']);
										
										unset($pax['name_update_check']);
										unset($pax['name_update_check_on']);
										
										$pax['added_on'] = date("Y-m-d H:i:s");
                                
                                        $columns = array_keys($pax);
                                        $values = array_map(function ($val) use ($mysqli) {
                                            if (!empty($val))
											{
												return "'" . mysqli_real_escape_string($mysqli, $val) . "'";
											}
											else
											{
												return "'" . $val . "'";
											}
                                        }, array_values($pax));
                                
                                        $insert_pax = "INSERT INTO wpk4_backend_travel_booking_pax (" . implode(',', $columns) . ") VALUES (" . implode(',', $values) . ")";
                                        if (!mysqli_query($mysqli, $insert_pax)) {
                                            echo " PAX insert failed (new order): " . mysqli_error($mysqli);
                                        }
                                    }
                                }
                                
                                // Loop 2: for pax IN selected_ids  assign to $divided_order_id
                                foreach ($all_pax as $pax2) {
                                    if (in_array($pax2['auto_id'], $selected_ids)) {
                                        $original_auto_id = $pax2['auto_id'];
                                        $pax2['order_id'] = $divided_order_id;
                                
                                        unset($pax2['auto_id']);
                                        if (empty($pax2['trams_profile_id'])) unset($pax2['trams_profile_id']);
										if (empty($pax2['customer_id'])) unset($pax2['customer_id']);
										unset($pax2['ticketed_on']);
										unset($pax2['ticketed_by']);
										unset($pax2['ticket_number']);
										unset($pax2['ticketing_audit_on']);
										unset($pax2['name_audit_on']);
										unset($pax2['ticketing_remarks_on']);
										unset($pax2['ticketing_in_progress_on']);
										
										unset($pax2['name_update_check']);
										unset($pax2['name_update_check_on']);
										
										$pax['added_on'] = date("Y-m-d H:i:s");
                                
                                        $columns = array_keys($pax2);
                                        $values = array_map(function ($val) use ($mysqli) {
											if (!empty($val))
											{
												return "'" . mysqli_real_escape_string($mysqli, $val) . "'";
											}
											else
											{
												return "'" . $val . "'";
											}
                                        }, array_values($pax2));
                                
                                        $insert_pax2 = "INSERT INTO wpk4_backend_travel_booking_pax (" . implode(',', $columns) . ") VALUES (" . implode(',', $values) . ")";
                                        if (!mysqli_query($mysqli, $insert_pax2)) {
                                            echo " PAX insert failed (divided order): " . mysqli_error($mysqli);
                                        }
                                    }
                                }
                                
                                //echo 'divide booking '.$divided_pax_to_be_paid_total . '</br></br>';
								
								//echo 'non divide booking '.$non_divided_pax_to_be_paid_total. '</br></br>';
								
                                if ($order_type == 'gds') // GDS
                                {
                                    // Step 4: Copy all related history updates
                                    $res_hist = $mysqli->query("SELECT * FROM wpk4_backend_history_of_updates WHERE type_id = '$orderid'");
                                    if (!$res_hist) {
                                        echo "History Error: " . $mysqli->error;
                                        exit;
                                    }
                                
                                    // Store all history rows
                                    $all_hist_rows = [];
                                    while ($row = $res_hist->fetch_assoc()) {
                                        $all_hist_rows[] = $row;
                                    }
                                
                                    // First loop: insert with new_order_id
                                    foreach ($all_hist_rows as $hist) {
                                        $hist['type_id'] = $new_order_id;
                                        unset($hist['auto_id']);
                                
                                        // Remove null or empty values
                                        $hist = array_filter($hist, function($value) {
                                            return $value !== null && $value !== '';
                                        });
                                
                                        $columns = implode(", ", array_keys($hist));
                                        $values = implode("', '", array_map([$mysqli, 'real_escape_string'], array_values($hist)));
                                
                                        $insert_hist = "INSERT INTO wpk4_backend_history_of_updates ($columns) VALUES ('$values')";
                                        if (!$mysqli->query($insert_hist)) {
                                            echo " Error inserting history update (new_order_id): " . $mysqli->error . "<br>Query: $insert_hist";
                                            exit;
                                        }
                                    }
                                
                                    // Second loop: insert with finalco_order_id
                                    foreach ($all_hist_rows as $hist) {
                                        $hist['type_id'] = $divided_order_id;
                                        unset($hist['auto_id']);
                                
                                        // Remove null or empty values
                                        $hist = array_filter($hist, function($value) {
                                            return $value !== null && $value !== '';
                                        });
                                
                                        $columns = implode(", ", array_keys($hist));
                                        $values = implode("', '", array_map([$mysqli, 'real_escape_string'], array_values($hist)));
                                
                                        $insert_hist = "INSERT INTO wpk4_backend_history_of_updates ($columns) VALUES ('$values')";
                                        if (!$mysqli->query($insert_hist)) {
                                            echo " Error inserting history update (finalco_order_id): " . $mysqli->error . "<br>Query: $insert_hist";
                                            exit;
                                        }
                                    }
                                }
								
								$sql_update_past_booking2 ="UPDATE wpk4_backend_travel_bookings
                                                 SET total_amount = '$non_divided_pax_to_be_paid_total', payment_modified = '$current_date_and_time', payment_modified_by = 'customer_portal_dc'
                                                WHERE order_id = '$new_order_id'";
                                $results_update_past_booking2 = $mysqli->query($sql_update_past_booking2);
								
								if ($order_type == 'gds')
								{
									$sql_update_past_booking3 ="UPDATE wpk4_backend_history_of_updates
                                                 SET meta_value = '$non_divided_pax_to_be_paid_total', updated_by = 'DC Amount Change'
                                                WHERE type_id = '$new_order_id' AND meta_key = 'Transaction TotalTurnover'";
									$results_update_past_booking3 = $mysqli->query($sql_update_past_booking3);
									
									$sql_update_past_booking3 ="UPDATE wpk4_backend_history_of_updates
                                                 SET meta_value = '$divided_pax_to_be_paid_total', updated_by = 'DC Amount Change'
                                                WHERE type_id = '$divided_order_id' AND meta_key = 'Transaction TotalTurnover'";
									$results_update_past_booking3 = $mysqli->query($sql_update_past_booking3);
								}
								
								$reduce_past_dc_amount = 0;
								$query_booking_for_dc_history = "select total_amount from wpk4_backend_travel_bookings_datechange_cost_breakdown c 
								where c.order_id = '$orderid'";
								$result_booking_for_dc_history = mysqli_query($mysqli, $query_booking_for_dc_history) or die(" Booking query failed: " . mysqli_error($mysqli));
								if(mysqli_num_rows($result_booking_for_dc_history) > 0 )
								{
									$pax_booking_for_dc_history = mysqli_fetch_assoc($result_booking_for_dc_history); 
									$reduce_past_dc_amount = (float)$pax_booking_for_dc_history['total_amount'];
								}
								
								

                                $query_booking_for_payment_history = "SELECT payment_status, total_amount FROM wpk4_backend_travel_bookings WHERE order_id = '$orderid' ";
								$result_booking_for_payment_history = mysqli_query($mysqli, $query_booking_for_payment_history) or die(" Booking query failed: " . mysqli_error($mysqli));
								while ($pax_booking_for_payment_history = mysqli_fetch_assoc($result_booking_for_payment_history)) 
								{
									//echo '</br>In Pay Loop</br>';
									//if($pax_booking_for_payment_history['payment_status'] == 'paid')
									{
										$total_paid_for_booking_transfer = 0.00;
										$processedPayments = array();
										$query_total_paid_for_requestid = "SELECT * FROM wpk4_backend_travel_payment_history where order_id = '$orderid' AND (pay_type = 'deposit' OR pay_type = 'balance' 
														OR pay_type = 'Balance' OR pay_type = 'deposit_adjustment' OR pay_type = 'additional_payment' OR pay_type = 'Refund')";
										$result_total_paid_for_requestid = mysqli_query($mysqli, $query_total_paid_for_requestid);
										while($row_total_paid_for_requestid = mysqli_fetch_assoc($result_total_paid_for_requestid))
										{
											$payment_identifier = $row_total_paid_for_requestid['trams_received_amount'].'^'.$row_total_paid_for_requestid['reference_no']; 
                                    		if (in_array($payment_identifier, $processedPayments)) 
                                    		{
												continue; // Skip to the next value
                                    		}
											$processedPayments[] = $payment_identifier;	
											
											$total_paid_for_booking_transfer += (float)$row_total_paid_for_requestid['trams_received_amount'];
										}
										//echo '</br>Total paid . ' . $total_paid_for_booking_transfer .'</br>';
										//&& $pax_booking_for_payment_history['total_amount'] == $total_paid_for_booking_transfer
										
										$total_paid_for_booking_transfer = (float)$total_paid_for_booking_transfer - (float)$reduce_past_dc_amount;
										
										if($total_paid_for_booking_transfer > 0 )
										{
											//echo '</br>In amount check condition</br>';
											$total_balance_after_reduce_non_divided_booking_amount = $total_paid_for_booking_transfer - $non_divided_pax_to_be_paid_total;
											
											// non divide amount transfer
											if( $total_paid_for_booking_transfer >= $non_divided_pax_to_be_paid_total )
											{
												///echo '</br>Inserting transfer 1</br>';
												$total_paid_for_booking_transfer_minus = '-'.$non_divided_pax_to_be_paid_total;
												
												$remark_for_past_booking = 'amount transfered to - '. $new_order_id . ' by Customer Portal DC';
												$remark_for_new_booking = 'amount transfered from - '. $orderid . ' by Customer Portal DC';
												
												mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history (order_id, source, trams_received_amount, reference_no, payment_method, process_date, pay_type, added_on, added_by) 
												values ('$orderid', '$order_type', '$total_paid_for_booking_transfer_minus', '$remark_for_past_booking', '14', '$current_date_and_time', 'deposit_adjustment', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
												
												mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history (order_id, source, trams_received_amount, reference_no, payment_method, process_date, pay_type, added_on, added_by) 
												values ('$new_order_id', '$order_type', '$non_divided_pax_to_be_paid_total', '$remark_for_new_booking', '14', '$current_date_and_time', 'deposit_adjustment', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
											}
											
											//if($total_balance_after_reduce_non_divided_booking_amount == $divided_pax_to_be_paid_total)
											{
												//echo '</br>Inserting transfer 2</br>';
												$total_paid_for_booking_transfer_minus2 = '-'.$total_balance_after_reduce_non_divided_booking_amount;
												
												$remark_for_past_booking2 = 'amount transfered to - '. $divided_order_id . ' by Customer Portal DC';
												$remark_for_new_booking2 = 'amount transfered from - '. $orderid . ' by Customer Portal DC';
												
												mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history (order_id, source, trams_received_amount, reference_no, payment_method, process_date, pay_type, added_on, added_by) 
												values ('$orderid', '$order_type', '$total_paid_for_booking_transfer_minus2', '$remark_for_past_booking2', '14', '$current_date_and_time', 'deposit_adjustment', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
												
												mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history (order_id, source, trams_received_amount, reference_no, payment_method, process_date, pay_type, added_on, added_by) 
												values ('$divided_order_id', '$order_type', '$total_balance_after_reduce_non_divided_booking_amount', '$remark_for_new_booking2', '14', '$current_date_and_time', 'deposit_adjustment', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
											}
										}
									}
								}
								
								if($order_type != 'gds' && $new_order_id != '')
								{
									$query_stock_check = "SELECT trip_code, travel_date, total_pax FROM wpk4_backend_travel_bookings where order_id = '$new_order_id' and order_type != 'gds'";
									$result_stock_check = mysqli_query($mysqli, $query_stock_check);
									if(mysqli_num_rows($result_stock_check) > 0 )
									{
										while($row_stock_check = mysqli_fetch_assoc($result_stock_check))
										{
											$trip_code = $row_stock_check['trip_code'];
											$travel_date = $row_stock_check['travel_date'];
											$total_pax = $row_stock_check['total_pax'];
																															
											update_stock_in_pricing_table($trip_code, $travel_date, $total_pax, 'positive');
										}
										$by_user = 'dc_in_customer_portal';
										availability_table_pax_update_positive($order_id, $by_user);
									}
								}
								
								//echo '</br>updating status</br>';
                                $sql_update_past_booking ="UPDATE wpk4_backend_travel_bookings
                                                                    SET payment_status = 'voucher_submited', payment_modified = '$current_date_and_time', payment_modified_by = 'customer_portal_dc'
                                                                WHERE order_id = '$orderid'";
                                                                $results_update_past_booking = $mysqli->query($sql_update_past_booking);
                                                                
                                                                if ($results_update_past_booking > 0) 
                                                                {
																	if($order_type != 'gds')
																	{
																		$query_stock_check = "SELECT trip_code, travel_date, total_pax FROM wpk4_backend_travel_bookings where order_id = '$orderid' and order_type != 'gds'";
																		$result_stock_check = mysqli_query($mysqli, $query_stock_check);
																		if(mysqli_num_rows($result_stock_check) > 0 )
																		{
																			while($row_stock_check = mysqli_fetch_assoc($result_stock_check))
																			{
																					
																				$trip_code = $row_stock_check['trip_code'];
																				$travel_date = $row_stock_check['travel_date'];
																				$total_pax = $row_stock_check['total_pax'];
																				
																				update_stock_in_pricing_table($trip_code, $travel_date, $total_pax, 'negative');
																				
																				$by_user = 'dc_in_customer_portal';
																																						
																				availability_table_pax_update($order_id, $by_user);
																			}
																		}
																	}
																	
                                                                    mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
    					                                            values ('$orderid','','','payment_status','Rebooked','$current_date_and_time','$currnt_userlogined')") or die(mysqli_error($mysqli));
                                                                }

								mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
    					         values ('$orderid','','','DC Initiated','','$current_date_and_time','$currnt_userlogined')") or die(mysqli_error($mysqli));
								//echo $divided_order_id . ' - ' . $new_order_id;
								
								$sql_update = "UPDATE wpk4_backend_user_portal_requests SET change_done = '$divided_order_id', original_order_id='$order_id', reservation_ref='$divided_order_id', change_done_by = '$currnt_userlogined', change_done_on = '$current_date_and_time' WHERE case_id='$case_id'";
								$result_update= mysqli_query($mysqli,$sql_update);

								$finalco_order_id = $co_orderid;
								
								
								$count_pax_query_1 = "SELECT order_id, fname, lname, dob FROM wpk4_backend_travel_booking_pax WHERE order_id = '$divided_order_id'";
                                $result_count_pax_query_1 = mysqli_query($mysqli, $count_pax_query_1) or die(" Pax query failed: " . mysqli_error($mysqli));
                                $count_pax_array_1 = [];
                                while ($row_count_pax_query_1 = mysqli_fetch_assoc($result_count_pax_query_1)) 
								{
                                    $count_pax_array_1[] = $row_count_pax_query_1['order_id'].$row_count_pax_query_1['fname'].$row_count_pax_query_1['lname'].$row_count_pax_query_1['dob'];
                                }
								$count_pax_array_1 = array_unique($count_pax_array_1);	
								$count_divided_pax = count($count_pax_array_1);

								$sql_update_past_booking ="UPDATE wpk4_backend_travel_bookings
                                        SET total_pax = '$count_divided_pax'
                                        WHERE order_id = '$divided_order_id'";
                                $results_update_past_booking = $mysqli->query($sql_update_past_booking);
								
								
								$count_pax_query_2 = "SELECT order_id, fname, lname, dob FROM wpk4_backend_travel_booking_pax WHERE order_id = '$new_order_id'";
                                $result_count_pax_query_2 = mysqli_query($mysqli, $count_pax_query_2) or die(" Pax query failed: " . mysqli_error($mysqli));
                                $count_pax_array_2 = [];
                                while ($row_count_pax_query_2 = mysqli_fetch_assoc($result_count_pax_query_2)) 
								{
                                    $count_pax_array_2[] = $row_count_pax_query_2['order_id'].$row_count_pax_query_2['fname'].$row_count_pax_query_2['lname'].$row_count_pax_query_2['dob'];
                                }
								$count_pax_array_2 = array_unique($count_pax_array_2);	
								$count_non_divided_pax = count($count_pax_array_2);
								
								$sql_update_past_booking ="UPDATE wpk4_backend_travel_bookings
                                        SET total_pax = '$count_non_divided_pax'
                                        WHERE order_id = '$new_order_id'";
                                $results_update_past_booking = $mysqli->query($sql_update_past_booking);
																

								if($order_type != 'gds')
								{
									echo "<script>window.location.href='?p=manage-datechange-v2&part=booking-info-update&oid={$divided_order_id}&coid={$finalco_order_id}&new_oid={$new_order_id}';</script>";
								}
								else
								{
									echo "<script>window.location.href='?p=manage-datechange-v2&part=booking-info-update-fit&oid={$divided_order_id}&coid={$finalco_order_id}&new_oid={$new_order_id}';</script>";
								}
								exit;
						}
						
						if (isset($_POST['without_divideorder'])) 
						{
								$order_id = $_GET['oid'];
								$case_id = $_GET['cid'];
								$orderid = $_POST['id'];
								$co_orderid = $_POST['co_orderid'] ?? '';
								$productid = $_POST['productid'] ?? '';
								//$order_type = $_POST['order_type'] ?? '';
								$selected_ids = $_POST['pax_ids_for_new_order'] ?? [];

								// Enable error reporting for mysqli
								mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT);
								
								if(empty($selected_ids))
								{
								    $all_pax_query = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
    								$result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));
    								while ($pax = mysqli_fetch_assoc($result_all_pax)) 
    								{
    								    $pax_a_id = $pax['auto_id'];
    								    $selected_ids[] = $pax_a_id;
    								}
								}
								
								$all_pax_query = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
								$result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));
								while ($pax = mysqli_fetch_assoc($result_all_pax)) 
								{
									if (in_array($pax['auto_id'], $selected_ids))
									{
									    $pax_a_id = $pax['auto_id'];
									    $fname = $pax['fname'];
									    $lname = $pax['lname'];
										$dob = $pax['dob'];
										$salutation = $pax['salutation'];
									    
									    $all_pax_query_inner = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE auto_id != '$pax_a_id' and order_id = '$orderid' and salutation = '$salutation' and fname = '$fname' and lname = '$lname' and dob = '$dob'";
								        $result_all_pax_inner = mysqli_query($mysqli, $all_pax_query_inner) or die(" Pax query failed: " . mysqli_error($mysqli));
										if( mysqli_num_rows($result_all_pax_inner) > 0)
										{
											$pax_inner = mysqli_fetch_assoc($result_all_pax_inner);
											$inner_a_id = $pax_inner['auto_id'];
											$selected_ids[] = $inner_a_id;
										}
									}
								}
								//print_r($selected_ids);
								$selected_ids = array_unique($selected_ids);	

								$res_max_order = mysqli_query($mysqli, "SELECT MAX(order_id) AS max_order_id FROM wpk4_backend_travel_bookings");
								$max_row = mysqli_fetch_assoc($res_max_order);
								$divided_order_id = $max_row['max_order_id'] + 1;

								// Fetch existing booking
								$res_booking = mysqli_query($mysqli, "SELECT * FROM wpk4_backend_travel_bookings WHERE order_id = '$order_id'");
                                if (!$res_booking || mysqli_num_rows($res_booking) === 0) {
                                    die(" No booking found for order_id = $order_id");
                                }

                                while ($booking_data = mysqli_fetch_assoc($res_booking)) {
                                    // Store current order_id as previous
                                    $booking_data['previous_order_id'] = $order_id;
                                
                                    // Remove auto-increment key
                                    unset($booking_data['auto_id']);
                                
                                    // Conditionally unset specific fields
                                    if (empty($booking_data['divided_date'])) unset($booking_data['divided_date']);
                                    if (empty($booking_data['late_modified'])) unset($booking_data['late_modified']);
                                    if (empty($booking_data['airline_ttl_deadline'])) unset($booking_data['airline_ttl_deadline']);
                                    if (empty($booking_data['price_time_limit'])) unset($booking_data['price_time_limit']);
                                    if (empty($booking_data['ticketing_timelimit'])) unset($booking_data['ticketing_timelimit']);
                                    if (empty($booking_data['return_date'])) unset($booking_data['return_date']);
									
									if (empty($booking_data['family_id'])) unset($booking_data['family_id']);
									if (empty($booking_data['journal_date'])) unset($booking_data['journal_date']);
									
									unset($booking_data['payment_modified']);
									$booking_data['source'] = "datechange";
                                    $booking_data['payment_status'] = "partially_paid";
									//$booking_data['deposit_deadline'] = date("Y-m-d") . ' 23:59:59';
									//$booking_data['full_payment_deadline'] = date("Y-m-d") . ' 23:59:59';
									
									$booking_data['deposit_deadline'] = date("Y-m-d H:i:s", strtotime("+1 day"));
									$booking_data['full_payment_deadline'] = date("Y-m-d H:i:s", strtotime("+1 day"));
									
									$booking_data['agent_info'] = $currnt_userlogined;
									
									$booking_data['added_on'] = date("Y-m-d H:i:s");
                                
                                    // Change to divided_order_id and insert again
                                    $booking_data['order_id'] = $divided_order_id;
                                    
                                    $columns = array_keys($booking_data);
                                    $values = array_map(function ($val) use ($mysqli) {
                                        if (!empty($val))
											{
												return "'" . mysqli_real_escape_string($mysqli, $val) . "'";
											}
											else
											{
												return "'" . $val . "'";
											}
                                    }, array_values($booking_data));
                                
                                    $insert_booking = "INSERT INTO wpk4_backend_travel_bookings (" . implode(',', $columns) . ") VALUES (" . implode(',', $values) . ")";
                                    if (!mysqli_query($mysqli, $insert_booking)) {
                                        die(" Booking insert failed (divided_order_id): " . mysqli_error($mysqli));
                                    }
                                }


								// Process unselected passengers
								$all_pax_query = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
								$result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));

								while ($pax = mysqli_fetch_assoc($result_all_pax)) {
								    
									if (in_array($pax['auto_id'], $selected_ids)) {
										$original_auto_id = $pax['auto_id']; // store before unset
										$pax['order_id'] = $divided_order_id;

										unset($pax['auto_id']);
										if (empty($pax['trams_profile_id'])) unset($pax['trams_profile_id']);
										if (empty($pax['customer_id'])) unset($pax['customer_id']);
										unset($pax['ticket_number']);
										unset($pax['ticketed_by']);
										unset($pax['ticketed_on']);
										unset($pax['ticketing_audit_on']);
										unset($pax['name_audit_on']);
										unset($pax['ticketing_remarks_on']);
										unset($pax['ticketing_in_progress_on']);
										
										unset($pax['name_update_check']);
										unset($pax['name_update_check_on']);
										
										$booking_data['added_on'] = date("Y-m-d H:i:s");

										$columns = array_keys($pax);
										$values = array_map(function ($val) use ($mysqli) {
											if (!empty($val))
											{
												return "'" . mysqli_real_escape_string($mysqli, $val) . "'";
											}
											else
											{
												return "'" . $val . "'";
											}
										}, array_values($pax));

										$insert_pax = "INSERT INTO wpk4_backend_travel_booking_pax (" . implode(',', $columns) . ") VALUES (" . implode(',', $values) . ")";
										if (!mysqli_query($mysqli, $insert_pax)) {
											echo " PAX insert failed: " . mysqli_error($mysqli);
										}
									}
								}
								//echo $order_type;
								if ($order_type == 'gds') // GDS
                                {
                                    // Step 4: Copy all related history updates
                                    $res_hist = $mysqli->query("SELECT * FROM wpk4_backend_history_of_updates WHERE type_id = '$orderid'");
                                    if (!$res_hist) {
                                        echo "History Error: " . $mysqli->error;
                                        exit;
                                    }
                                
                                    // Store all history rows
                                    $all_hist_rows = [];
                                    while ($row = $res_hist->fetch_assoc()) {
                                        $all_hist_rows[] = $row;
                                    }
                                    // First loop: insert with new_order_id
                                    foreach ($all_hist_rows as $hist) {
                                        $hist['type_id'] = $divided_order_id;
                                        unset($hist['auto_id']);
                                
                                        // Remove null or empty values
                                        $hist = array_filter($hist, function($value) {
                                            return $value !== null && $value !== '';
                                        });
                                
                                        $columns = implode(", ", array_keys($hist));
                                        $values = implode("', '", array_map([$mysqli, 'real_escape_string'], array_values($hist)));
                                
                                        $insert_hist = "INSERT INTO wpk4_backend_history_of_updates ($columns) VALUES ('$values')";
                                        if (!$mysqli->query($insert_hist)) {
                                            echo " Error inserting history update (new_order_id): " . $mysqli->error . "<br>Query: $insert_hist";
                                            exit;
                                        }
                                    }
                                }
								
								
								$is_ticketed = 0;
								$all_pax_query_ticket_finder = "SELECT ticket_number FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' and ticket_number is not null";
								$result_all_pax_ticket_finder = mysqli_query($mysqli, $all_pax_query_ticket_finder) or die(" Pax query failed: " . mysqli_error($mysqli));
								while ($pax_ticket_finder = mysqli_fetch_assoc($result_all_pax_ticket_finder)) 
								{
									if($pax_ticket_finder['ticket_number'] != '')
									{
										$is_ticketed = 1;
										break;
									}
								}
								
								$reduce_past_dc_amount = 0;
								$query_booking_for_dc_history = "select total_amount from wpk4_backend_travel_bookings_datechange_cost_breakdown c 
								where c.order_id = '$orderid'";
								$result_booking_for_dc_history = mysqli_query($mysqli, $query_booking_for_dc_history) or die(" Booking query failed: " . mysqli_error($mysqli));
								if(mysqli_num_rows($result_booking_for_dc_history) > 0 )
								{
									$pax_booking_for_dc_history = mysqli_fetch_assoc($result_booking_for_dc_history); 
									$reduce_past_dc_amount = (float)$pax_booking_for_dc_history['total_amount'];
								}
								echo 'reduce amount '. $reduce_past_dc_amount . '</br>';
								
								if($is_ticketed == 0)
								{
									$total_paid_for_booking_transfer = 0.00;
									$processedPayments = array();
									$query_total_paid_for_requestid = "SELECT * FROM wpk4_backend_travel_payment_history where order_id = '$orderid' AND (pay_type = 'deposit' OR pay_type = 'balance' 
													OR pay_type = 'Balance' OR pay_type = 'deposit_adjustment' OR pay_type = 'additional_payment')";
									$result_total_paid_for_requestid = mysqli_query($mysqli, $query_total_paid_for_requestid);
									while($row_total_paid_for_requestid = mysqli_fetch_assoc($result_total_paid_for_requestid))
									{
										$payment_identifier = $row_total_paid_for_requestid['trams_received_amount'].'^'.$row_total_paid_for_requestid['reference_no']; 
                                    	if (in_array($payment_identifier, $processedPayments)) 
                                    	{
											continue; // Skip to the next value
                                    	}
										$processedPayments[] = $payment_identifier;
										
										$total_paid_for_booking_transfer += (float)$row_total_paid_for_requestid['trams_received_amount'];
									}
									echo 'total to transfer '. $total_paid_for_booking_transfer .'</br>';
									
									$total_paid_for_booking_transfer = (float)$total_paid_for_booking_transfer - (float)$reduce_past_dc_amount;
									echo 'reduce amount '. $total_paid_for_booking_transfer . '</br>';
									
									if($total_paid_for_booking_transfer > 0) 
									{
										$total_paid_for_booking_transfer_minus = '-'.$total_paid_for_booking_transfer;
										
										$remark_for_past_booking = 'amount transfered to - '. $divided_order_id . ' by Customer Portal DC';
										$remark_for_new_booking = 'amount transfered from - '. $orderid . ' by Customer Portal DC';
										
										mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history (order_id, source, trams_received_amount, reference_no, payment_method, process_date, pay_type, added_on, added_by) 
										values ('$orderid', '$order_type', '$total_paid_for_booking_transfer_minus', '$remark_for_past_booking', '14', '$current_date_and_time', 'deposit_adjustment', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
										
										mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history (order_id, source, trams_received_amount, reference_no, payment_method, process_date, pay_type, added_on, added_by) 
										values ('$divided_order_id', '$order_type', '$total_paid_for_booking_transfer', '$remark_for_new_booking', '14', '$current_date_and_time', 'deposit_adjustment', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
										
									}
								
								}
								
                                $sql_update_past_booking ="UPDATE wpk4_backend_travel_bookings
                                                                    SET payment_status = 'voucher_submited', payment_modified = '$current_date_and_time', payment_modified_by = 'customer_portal_dc'
                                                                WHERE order_id = '$orderid'";
                                                                $results_update_past_booking = $wpdb->query($sql_update_past_booking);
                                                                
                                                                if ($results_update_past_booking > 0) 
                                                                {
																	
																	if($order_type != 'gds')
																	{
																		$query_stock_check = "SELECT trip_code, travel_date, total_pax FROM wpk4_backend_travel_bookings where order_id = '$orderid' and order_type != 'gds'";
																		$result_stock_check = mysqli_query($mysqli, $query_stock_check);
																		if(mysqli_num_rows($result_stock_check) > 0 )
																		{
																			while($row_stock_check = mysqli_fetch_assoc($result_stock_check))
																			{
																					
																				$trip_code = $row_stock_check['trip_code'];
																				$travel_date = $row_stock_check['travel_date'];
																				$total_pax = $row_stock_check['total_pax'];
																				
																				update_stock_in_pricing_table($trip_code, $travel_date, $total_pax, 'negative');
																				
																				$by_user = 'dc_in_customer_portal';
																																						
																				availability_table_pax_update($order_id, $by_user);
																			}
																		}
																	}
																	
																	
                                                                    mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
    					                                            values ('$orderid','','','payment_status','Rebooked','$current_date_and_time','$currnt_userlogined')") or die(mysqli_error($mysqli));
                                                                } 

								mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
    					         values ('$orderid','','','DC Initiated','','$current_date_and_time','$currnt_userlogined')") or die(mysqli_error($mysqli));

								$sql_update = "UPDATE wpk4_backend_user_portal_requests SET change_done = '$divided_order_id', original_order_id='$order_id', reservation_ref='$divided_order_id', change_done_by = '$currnt_userlogined', change_done_on = '$current_date_and_time' WHERE case_id='$case_id'";
								$result_update= mysqli_query($mysqli,$sql_update);

								$finalco_order_id = $co_orderid;

								if($order_type != 'gds')
								{
									echo "<script>window.location.href='?p=manage-datechange-v2&part=booking-info-update&oid={$divided_order_id}&coid={$finalco_order_id}&new_oid=';</script>";
								}
								else
								{
									echo "<script>window.location.href='?p=manage-datechange-v2&part=booking-info-update-fit&oid={$divided_order_id}&coid={$finalco_order_id}&new_oid=';</script>";
								}
								exit;
						}
					}
					
					if(isset($_GET['p']) && $_GET['p'] =='manage-datechange-v2' && isset($_GET['part']) && $_GET['part'] == 'booking-info-update-fit')
						{
						    echo '</br></br></br>';
						    $order_id = $_GET['oid'];
							$co_order_id = $_GET['coid'] ?? '';
							
						    
						    $query_pax = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id' order by travel_date asc limit 1";
							//echo $query_pax;
                    		$result_pax = mysqli_query($mysqli, $query_pax);
                    		?>
                    		<h6>Order ID : <?php echo $order_id; ?></h6>
                    		<?php
                    		if(!empty($result_pax))
                    		{
                    		    ?>
								<script src="https://cdn.jsdelivr.net/gh/alumuko/vanilla-datetimerange-picker@latest/dist/vanilla-datetimerange-picker.js"></script>
								<script>
									window.addEventListener("load", function (event) {
									let drp = new DateRangePicker('travel_date_int',
											{
												
												timePicker: false,
												alwaysShowCalendars: true,
												singleDatePicker: true,
												autoApply: true,
												autoUpdateInput: true,
												
												locale: {
													format: "YYYY-MM-DD 00:00:00",
												}
											},
											function (start) {
												document.getElementById("travel_date_int").value = start.format();
												
											})
									});
									
									window.addEventListener("load", function (event) {
									let drp = new DateRangePicker('travel_date_fit',
											{
												
												timePicker: false,
												alwaysShowCalendars: true,
												singleDatePicker: true,
												autoApply: true,
												autoUpdateInput: true,
												
												locale: {
													format: "YYYY-MM-DD HH:mm:ss",
												}
											},
											function (start) {
												document.getElementById("travel_date_fit").value = start.format();
												
											})
									});
									
									window.addEventListener("load", function (event) {
									let drp = new DateRangePicker('return_date_fit',
											{
												
												timePicker: false,
												alwaysShowCalendars: true,
												singleDatePicker: true,
												autoApply: true,
												autoUpdateInput: true,
												
												locale: {
													format: "YYYY-MM-DD HH:mm:ss",
												}
											},
											function (start) {
												document.getElementById("return_date_fit").value = start.format();
												
											})
									});
								</script>
                    		    <form action="#" name="statusupdate" method="post" enctype="multipart/form-data" style='font-size:13px;'>
                    		    <?php
                    			$row_pax = mysqli_fetch_assoc($result_pax);
                    			{
                    			    $auto_id = $row_pax['auto_id'];
                    				$order_id = $row_pax['order_id'];
                    				$co_order_id_db = $row_pax['co_order_id'];
                    				$product_id = $row_pax['product_id'];
                    				$order_type = $row_pax['order_type'];
                    				$t_type = $row_pax['t_type'];
                    				$total_pax = $row_pax['total_pax'];
									$previous_order_id_sql = $row_pax['previous_order_id'];
									
									$query_pax_2 = "SELECT pnr FROM wpk4_backend_travel_booking_pax where order_id='$previous_order_id_sql' and (product_id = '$product_id' OR product_id = '') order by auto_id asc limit 1";
									$result_pax_2 = mysqli_query($mysqli, $query_pax_2);
									$row_pax_2 = mysqli_fetch_assoc($result_pax_2);
									$pnr = $row_pax_2['pnr'];
                    				?>
                    			    Airline Change Fee
									<input type='text' name='airline_change_fee' required id='airline_change_fee'></br>
									
									Fare Difference
									<input type='text' name='fare_difference' required id='fare_difference'></br>
									
									Gaura Travel Service Fee
									<input type='text' name='gaura_service_fee' required id='gaura_service_fee'></br>
									
									Buffer
									<input type='text' name='buffer' required id='buffer'></br>
									
									Cost Given / Datechange Amount (Amount to be requested from customer)
                        			<input type='text' name='total_amount' required id='dc_amount'></br>

									Tripcode / Route</br>
									<b>One-way</b>: Enter the route in the format <b>MEL-DEL-SQ</b></br>
									<b>Return</b>: Enter only the first main route, e.g., <b>MEL-DEL-SQ</b>. Systemetically we cover the return leg (DEL-MEL-SQ).</br>
									<b>Multi-city</b>: Enter the main route in sequence, e.g., <b>DEL-MEL-SYD-HYD</b></br>
                        			<input type='text' name='tripcode_route_<?php echo $auto_id; ?>' required id='tripcode'></br>
									
                    			    <h6>Current Tripcode : <?php echo $row_pax['trip_code']; ?></h6>
									<input type="hidden" name="manual_fields_log" id="manual_fields_log" value="">
                    				<?php
                    				
                    				echo "<input type='hidden' name='order_type_<?php echo $auto_id; ?>' value='".$order_type."' id='searchkeyvalue'>";
                    				echo "<input type='hidden' name='total_pax_<?php echo $auto_id; ?>' value='".$total_pax."' id='total_pax'>";
                    				{
                    			
											global $wpdb;

											// $query_pax_2 = "SELECT * FROM `wpk4_backend_history_of_updates` WHERE `type_id` LIKE '900114055'";
											// 									$result_pax_2 = mysqli_query($mysqli, $query_pax_2);
											// 									while($row_pax_2 = mysqli_fetch_assoc($result_pax_2))
											// 									{
											// 										echo $row_pax_2['meta_key'] . ': ' . $row_pax_2['meta_value'] . '</br>';
											// 									}



											$existing_data = [];
											$meta_keys = [
												'Flightlegs MarketingCarrier', 'Flightlegs DepApt', 'Flightlegs DestApt', 'Flightlegs Equipment',
												'Flightlegs FlNr', 'Flightlegs Status', 'Flightlegs Meal',
												'Flightlegs Class', 'Flightlegs CrFileKey', 'Flightlegs DepTerminal',
												'Flightlegs DestTerminal', 'Flightlegs DepTime', 'Flightlegs DestTime'
											];

											foreach ($meta_keys as $key) {
												$existing_data[$key] = '';
												$res = $wpdb->get_var($wpdb->prepare(
													"SELECT meta_value FROM wpk4_backend_history_of_updates WHERE type_id = %s AND meta_key = %s",
													$order_id, $key
												));
												if ($res !== null) {
													$existing_data[$key] = explode(' | ', $res);
												}
											}

											// Use one key to determine number of rows
											//$row_count = count($existing_data['Flightlegs DepApt']) ?? 0;

											$row_count = is_array($existing_data['Flightlegs DepApt']) ? count($existing_data['Flightlegs DepApt']) : 0;

											?>
											<style>
											.switch-to-manual {
												display: inline-block;
												font-size: 11px;
												color: #0073aa;
												margin-top: 4px;
												text-decoration: underline;
												cursor: pointer;
											}
											.switch-to-manual:hover {
												color: #005177;
											}
											</style>
											<table id="flight_table" border="0" style="border:none; width:100%; margin-bottom:15px;">
												<thead>
													<tr><th colspan="16">Flight Details</th></tr>
												</thead>

												<?php 
												if($row_count > 0)
												{
													for ($i = 0; $i < $row_count; $i++): 
													
													$dep_datetime_raw = $existing_data['Flightlegs DepTime'][$i] ?? '';
													$dep_date = '';
													$dep_time = '';

													if (!empty($dep_datetime_raw)) {
														$datetime = DateTime::createFromFormat('Y-m-d H:i:s', $dep_datetime_raw) ?: DateTime::createFromFormat('Y-m-d H:i', $dep_datetime_raw);
														if ($datetime) {
															$dep_date = $datetime->format('Y-m-d');
															$dep_time = $datetime->format('H:i');
														}
													}
													
													$arr_datetime_raw = $existing_data['Flightlegs DestTime'][$i] ?? '';
													$arr_date = '';
													$arr_time = '';

													if (!empty($arr_datetime_raw)) {
														$datetime = DateTime::createFromFormat('Y-m-d H:i:s', $arr_datetime_raw) ?: DateTime::createFromFormat('Y-m-d H:i', $arr_datetime_raw);
														if ($datetime) {
															$arr_date = $datetime->format('Y-m-d');
															$arr_time = $datetime->format('H:i');
														}
													}
													?>
													<tbody class="flight-row" data-index="<?= $i ?>">
														<tr>
												<td width="16%">
													Flight<br>
													<div class="select-or-input">
														<a href="#" class="switch-to-manual" style="display:block; font-size:11px; margin-bottom:2px;">Switch to Manual</a>
														<select required name="flight_code[]" class="flight_code" style="width:100%; height:40px;">
															<option value="" disabled <?= empty($existing_data['Flightlegs MarketingCarrier'][$i]) ? 'selected' : '' ?>>Airline</option>
															<?php
															$airlines = $wpdb->get_results("
																SELECT DISTINCT LEFT(Flight, 2) AS airline_code
																FROM wpk4_backend_FIT_flight_schedule
																WHERE Flight IS NOT NULL AND Flight != ''
																ORDER BY airline_code
															");
															$flight_code_val = substr($existing_data['Flightlegs MarketingCarrier'][$i] ?? '', 0, 2);
															foreach ($airlines as $row_airline) {
																$code = $row_airline->airline_code;
																$selected = ($code === $flight_code_val) ? 'selected' : 'disabled';
																echo "<option value='{$code}' {$selected}>{$code}</option>";
															}
															?>
														</select>
													</div>
												</td>

												<td width="32%" colspan="2">
													Origin<br>
													<div class="select-or-input">
														<a href="#" class="switch-to-manual" style="display:block; font-size:11px; margin-bottom:2px;">Switch to Manual</a>
														<select required name="Origin_Code[]" class="Origin_Code" style="width:100%; height:40px;">
															<?php if (!empty($existing_data['Flightlegs DepApt'][$i])): ?>
																<option selected value="<?= esc_attr($existing_data['Flightlegs DepApt'][$i]) ?>"><?= esc_html($existing_data['Flightlegs DepApt'][$i]) ?></option>
															<?php else: ?>
																<option value="" selected disabled>Select Origin</option>
															<?php endif; ?>
														</select>
													</div>
												</td>

												<td width="32%" colspan="2">
													Destination<br>
													<div class="select-or-input">
														<a href="#" class="switch-to-manual" style="display:block; font-size:11px; margin-bottom:2px;">Switch to Manual</a>
														<select required name="destination_code[]" class="destination_code" style="width:100%; height:40px;">
															<?php if (!empty($existing_data['Flightlegs DestApt'][$i])): ?>
																<option selected value="<?= esc_attr($existing_data['Flightlegs DestApt'][$i]) ?>"><?= esc_html($existing_data['Flightlegs DestApt'][$i]) ?></option>
															<?php else: ?>
																<option value="" selected disabled>Select Destination</option>
															<?php endif; ?>
														</select>
													</div>
												</td>

												<td width="16%">
													Flight Number<br>
													<div class="select-or-input">
														<a href="#" class="switch-to-manual" style="display:block; font-size:11px; margin-bottom:2px;">Switch to Manual</a>
														<?php
														$flight_no = ($existing_data['Flightlegs FlNr'][$i] ?? '');
														$airline = substr($existing_data['Flightlegs MarketingCarrier'][$i] ?? '', 0, 2);
														$full_flight_number = $airline . $flight_no;
														?>
														<select required name="flight_number[]" class="flight_number" style="width:100%; height:40px;">
															<option selected value="<?= esc_attr($full_flight_number) ?>"><?= esc_html($full_flight_number) ?></option>
														</select>
													</div>
												</td>
											</tr>


														<tr>
															<td>
																Dep Date<br>
																<input required readonly type="text" class="Dep_date" name="Dep_date[]" value="<?= esc_attr($dep_date) ?>">
															</td>
															<td>
																Dep Time<br>
																<input required type="text" class="Dep_Time" name="Dep_Time[]" value="<?= esc_attr($dep_time) ?>">
															</td>
															<td>
																Dep Terminal<br>
																<input required type="text" class="Dep_Terminal" name="Dep_Terminal[]" value="<?= esc_attr($existing_data['Flightlegs DepTerminal'][$i] ?? '') ?>">
															</td>

															<td>
																Arr Date<br>
																<input required readonly type="text" class="Arr_date" name="Arr_date[]" value="<?= esc_attr($arr_date) ?>">
															</td>
															<td>
																Arr Time<br>
																<input required type="text" class="Arr_Time" name="Arr_Time[]" value="<?= esc_attr($arr_time) ?>">
															</td>
															<td>
																Arr Terminal<br>
																<input required type="text" class="Arr_Terminal" name="Arr_Terminal[]" value="<?= esc_attr($existing_data['Flightlegs DestTerminal'][$i] ?? '') ?>">
															</td>
														</tr>

														<tr>
															<td>
																PNR<br>
																<input required type="text" class="PNRarray" name="PNRarray[]" value="<?= esc_attr($existing_data['Flightlegs CrFileKey'][$i] ?? '') ?>">
															</td>
															<td>
																Equ Code<br>
																<input required type="text" class="Equipment_Code" name="Equipment_Code[]" value="<?= esc_attr($existing_data['Flightlegs Equipment'][$i] ?? '') ?>">
															</td>
															<td>
																Equ Name<br>
																<input required type="text" class="Equipment_Name" name="Equipment_Name[]" value="<?= esc_attr($existing_data['Equipment_Name'][$i] ?? '') ?>">
															</td>
															<td>
																Status<br>
																<input required type="text" class="Status" name="Status[]" value="<?= esc_attr($existing_data['Flightlegs Status'][$i] ?? '') ?>">
															</td>
															<td>
																Meal<br>
																<input required type="text" class="Meal" name="Meal[]" value="<?= esc_attr($existing_data['Flightlegs Meal'][$i] ?? '') ?>">
															</td>
															<td>
																Class<br>
																<input required type="text" class="Class" name="Class[]" value="<?= esc_attr($existing_data['Flightlegs Class'][$i] ?? '') ?>">
															</td>
														</tr>

														<tr>
															<td colspan="6" style="text-align:right;">
																<button type="button" class="removeFlightBtn" style="background:red; color:white; border:none; padding:5px 10px; cursor:pointer;">X Remove</button>
															</td>
														</tr>

														<tr><td colspan="6"></td></tr>
													</tbody>
												<?php endfor; 
												}
												else
												{
													?>
													<tbody class="flight-row" data-index="0">
														<tr>
															<td width="16%">
																Flight<br>
																<div class="select-or-input">
																	<a href="#" class="switch-to-manual" style="display:block; font-size:11px; margin-bottom:2px;">Switch to Manual</a>
																	<select required name="flight_code[]" class="flight_code" style="width:100%; height:40px;">
																		<option value="" selected disabled>Airline</option>
																		<?php
																		global $wpdb;
																		$results = $wpdb->get_results("
																			SELECT DISTINCT LEFT(Flight, 2) AS airline_code
																			FROM wpk4_backend_FIT_flight_schedule
																			WHERE Flight IS NOT NULL AND Flight != ''
																			ORDER BY airline_code
																		");
																		foreach ($results as $row) {
																			echo "<option value='{$row->airline_code}'>{$row->airline_code}</option>";
																		}
																		?>
																	</select>
																</div>
															</td>

															<td width="32%" colspan="2">
																Origin<br>
																<div class="select-or-input">
																	<a href="#" class="switch-to-manual" style="display:block; font-size:11px; margin-bottom:2px;">Switch to Manual</a>
																	<select required name="Origin_Code[]" class="Origin_Code" style="width:100%; height:40px;">
																		<option value="" selected disabled>Select Origin</option>
																	</select>
																</div>
															</td>

															<td width="32%" colspan="2">
																Destination<br>
																<div class="select-or-input">
																	<a href="#" class="switch-to-manual" style="display:block; font-size:11px; margin-bottom:2px;">Switch to Manual</a>
																	<select required name="destination_code[]" class="destination_code" style="width:100%; height:40px;">
																		<option value="" selected disabled>Select Destination</option>
																	</select>
																</div>
															</td>

															<td width="16%">
																Flight Number<br>
																<div class="select-or-input">
																	<a href="#" class="switch-to-manual" style="display:block; font-size:11px; margin-bottom:2px;">Switch to Manual</a>
																	<?php $full_flight_number = ''; ?>
																	<select required name="flight_number[]" class="flight_number" style="width:100%; height:40px;">
																		<option selected value="<?= esc_attr($full_flight_number) ?>"><?= esc_html($full_flight_number) ?></option>
																	</select>
																</div>
															</td>
														</tr>

														<tr>
															<td width="16%">
																Dep Date<br>
																<input required readonly type="text" class="Dep_date" name="Dep_date[]">
															</td>
															<td width="16%">
																Dep Time<br>
																<input required type="text" class="Dep_Time" name="Dep_Time[]" >
															</td>
															<td width="16%">
																Dep Terminal<br>
																<input required type="text" class="Dep_Terminal" name="Dep_Terminal[]" >
															</td>
															
															<td width="16%">
																Arr Date<br>
																<input required readonly type="text" class="Arr_date" name="Arr_date[]">
															</td>
															<td width="16%">
																Arr Time<br>
																<input required type="text" class="Arr_Time" name="Arr_Time[]" >
															</td>
															<td width="16%">
																Arr Terminal<br>
																<input required type="text" class="Arr_Terminal" name="Arr_Terminal[]" >
															</td>
														</tr>
														<tr>
															<td>
																PNR<br><input required type="text" class="PNRarray" name="PNRarray[]" >
															</td>
															<td width="16%">
																Equ Code<br><input required type="text" class="Equipment_Code" name="Equipment_Code[]" >
															</td>
															<td>
																Equ Name<br><input required type="text" class="Equipment_Name" name="Equipment_Name[]">
															</td>
															<td width="16%">
																Status<br><input required type="text" class="Status" name="Status[]" >
															</td>
															<td width="16%">
																Meal<br><input required type="text" class="Meal" name="Meal[]" >
															</td>
															<td width="16%">
																Class<br><input required type="text" class="Class" name="Class[]" >
															</td>
														</tr>
														<tr>
														<td colspan="6" style="text-align:right;">
																<button type="button" class="removeFlightBtn" style="background:red; color:white; border:none; padding:5px 10px; cursor:pointer;">X Remove</button>
														</td>
													</tr>
													<tr><td colspan="6"></td></tr>
													</tbody>
													<?php
												}	
												?>
											</table>





											<button type="button" id="addFlightBtn">+ Add Flights</button>
											</br></br>
											<script>
											jQuery(document).ready(function($) {
												$(document).on('click', '.switch-to-manual', function(e) {
													e.preventDefault();
													
													const $container = $(this).closest('.select-or-input');
													const $select = $container.find('select');
													const selectedVal = $select.val();
													const selectName = $select.attr('name');
													const selectClass = $select.attr('class');

													// Replace select with input
													const $input = $(`<input type="text" style="width:100%; height:40px;">`)
														.attr('name', selectName)
														.attr('class', selectClass)
														.val(selectedVal);

													$select.remove();
													$(this).remove();
													$container.prepend($input);

													// Append to hidden field
													const $hiddenField = $('#manual_fields_log');  
													let currentVal = $hiddenField.val().split(',').filter(v => v.trim() !== '');
													if (!currentVal.includes(selectName)) {
														currentVal.push(selectName);
													}
													$hiddenField.val(currentVal.join(','));

												});
											});
											</script>

											<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
											<script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
											<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">

											<script>

											function initializeDatePickers(row) {
											row.find('.Dep_date').each(function () {
												$(this).datepicker('destroy'); // Destroy previous instances
												$(this).datepicker({
												dateFormat: 'yy-mm-dd',
												onSelect: function (selectedDate) {
													const input = $(this);
													const flightRow = input.closest('.flight-row');
													const flightNumber = flightRow.find('.flight_number').val();

													if (flightNumber && selectedDate) {
														fetch('/wp-content/themes/twentytwenty/templates/tpl_backend_functions.php', {
														method: 'POST',
														headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
														body: new URLSearchParams({
															action: 'get_flight_details_by_date',
															flight_number: flightNumber,
															departure_date: selectedDate
														})
														})
														.then(res => res.json())
														.then(data => {
														// Set values in the current row
														//flightRow.find('.Origin_Code').val(data.Origin);
														//flightRow.find('.destination_code').val(data.Destination);
														flightRow.find('.Dep_Time').val(data.DepartureTime);
														flightRow.find('.Arr_Time').val(data.ArrivalTime);
														flightRow.find('.Dep_Terminal').val(data.DepartureTerminal);
														flightRow.find('.Arr_Terminal').val(data.ArrivalTerminal);
														flightRow.find('.Equipment_Code').val(data.EquipmentCode);
														flightRow.find('.Equipment_Name').val(data.EquipmentName);

														// Determine correct arrival date
														const depTime = data.DepartureTime;
														const arrTime = data.ArrivalTime;

														if (depTime && arrTime) {
															const depParts = depTime.split(':');
															const arrParts = arrTime.split(':');

															const depMinutes = parseInt(depParts[0]) * 60 + parseInt(depParts[1]);
															const arrMinutes = parseInt(arrParts[0]) * 60 + parseInt(arrParts[1]);

															const depDateObj = new Date(selectedDate);
															if (arrMinutes < depMinutes) {
															depDateObj.setDate(depDateObj.getDate() + 1); // Next day
															}
															const yyyy = depDateObj.getFullYear();
															const mm = String(depDateObj.getMonth() + 1).padStart(2, '0');
															const dd = String(depDateObj.getDate()).padStart(2, '0');
															const finalArrDate = `${yyyy}-${mm}-${dd}`;

															flightRow.find('.Arr_date').val(finalArrDate);
														}
														});
													}
													}



												});
											});

											row.find('.Arr_date').each(function () {
												$(this).datepicker('destroy');
												$(this).datepicker({
												dateFormat: 'yy-mm-dd'
												});
											});
											}



											let flightIndex = 1;

											$(document).ready(function () {
												
												
												
											// Initialize datepicker for existing row
											initializeDatePickers($('.flight-row'));

											$(document).on('click', '.removeFlightBtn', function () {
											if ($('.flight-row').length > 1) {
												$(this).closest('.flight-row').remove();
											} else {
												alert('At least one flight row is required.');
											}
											});

											$('#addFlightBtn').on('click', function () {
											const table = $('#flight_table');
											const newRow = $('.flight-row:first').clone();
											newRow.attr('data-index', flightIndex);

											// Clear all inputs and dropdowns inside the cloned block
											newRow.find('input').val('');
											newRow.find('.flight_code').val('');
											newRow.find('.flight_number').html('<option value="">Select Flight Number</option>');

											// Reset datepickers (remove leftover data)
											newRow.find('.Dep_date, .Arr_date').each(function () {
												$(this).removeClass('hasDatepicker').removeAttr('id');
											});

											// Append the entire tbody (as a full block of two rows)
											table.append(newRow);
											initializeDatePickers(newRow);
											flightIndex++;
											});


											$(document).on('change', '.flight_code', function () {
											const row = $(this).closest('.flight-row');
											const existing_origin = row.find('.Origin_Code').val()?.trim().toUpperCase();
											const airlineCode = $(this).val();

											fetch('/wp-content/themes/twentytwenty/templates/tpl_backend_functions.php', {
												method: 'POST',
												headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
												body: new URLSearchParams({
												action: 'get_origins_by_airline',
												airline_code: airlineCode
												})
											})
											.then(res => res.json())
											.then(data => {
												const originField = row.find('.Origin_Code');
												originField.html('<option value="">Select Origin</option>');
												data.forEach(o => {
												const oVal = o.trim().toUpperCase();
												const selected = (existing_origin === oVal) ? 'selected' : '';
												originField.append(`<option value="${o}" ${selected}>${o}</option>`);
												});
											});
											});





											$('.flight_code').each(function () {
													const val = $(this).val();
													if (val && val.trim() !== '') {
													$(this).trigger('change');
													}
												});


											$(document).on('change', '.Origin_Code', function () {
											const row = $(this).closest('.flight-row');
											const origin = $(this).val();
											const airlineCode = row.find('.flight_code').val();

											fetch('/wp-content/themes/twentytwenty/templates/tpl_backend_functions.php', {
												method: 'POST',
												headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
												body: new URLSearchParams({
												action: 'get_destinations_by_airline_origin',
												airline_code: airlineCode,
												origin: origin
												})
											})
											.then(res => res.json())
											.then(data => {
												const destField = row.find('.destination_code');
												destField.html('<option value="">Select Destination</option>');
												data.forEach(d => {
												destField.append(`<option value="${d}">${d}</option>`);
												});
											});
											});

											$(document).on('change', '.destination_code', function () {
											const row = $(this).closest('.flight-row');
											const airlineCode = row.find('.flight_code').val();
											const origin = row.find('.Origin_Code').val();
											const destination = $(this).val();
											
											// Reset next .flight-row (not previous)
											const currentIndex = parseInt(row.attr('data-index'));
											const nextRow = $(`.flight-row[data-index="${currentIndex + 1}"]`);
											if (nextRow.length > 0) {
												//nextRow.find('.Origin_Code').val('');
												//nextRow.find('.destination_code').val('');
												//nextRow.find('.flight_number').html('<option value="">Select Flight</option>');
											}

											fetch('/wp-content/themes/twentytwenty/templates/tpl_backend_functions.php', {
												method: 'POST',
												headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
												body: new URLSearchParams({
												action: 'get_flights_by_route',
												airline_code: airlineCode,
												origin: origin,
												destination: destination
												})
											})
											.then(res => res.json())
											.then(data => {
												if (data.length > 0) {
												// Extract unique flight numbers and sort them
												const uniqueFlights = [...new Set(data.map(f => f.Flight))].sort();

												const options = uniqueFlights.map(flight => `<option value="${flight}">${flight}</option>`).join('');
												row.find('.flight_number').html('<option value="">Select Flight</option>' + options);
												}

												// Pre-fill the rest (just use the first result by default)
												const flight = data[0];
												if (flight) {
												row.find('.Dep_Time').val(flight.DepartureTime);
												row.find('.Arr_Time').val(flight.ArrivalTime);
												row.find('.Dep_Terminal').val(flight.DepartureTerminal);
												row.find('.Arr_Terminal').val(flight.ArrivalTerminal);
												row.find('.Equipment_Code').val(flight.EquipmentCode);
												row.find('.Equipment_Name').val(flight.EquipmentName);
												}
											});
											});

											$(document).on('change', '.flight_number', function () {
												const row = $(this).closest('.flight-row');
												const flightNumber = $(this).val();

												fetch('/wp-content/themes/twentytwenty/templates/tpl_backend_functions.php', {
												method: 'POST',
												headers: {'Content-Type': 'application/x-www-form-urlencoded'},
												body: new URLSearchParams({
													action: 'get_flight_details',
													flight_number: flightNumber
												})
												})
												.then(res => res.json())
												.then(data => {
												row.find('.Origin_Code').val(data.Origin);
												row.find('.destination_code').val(data.Destination);
												row.find('.Dep_Time').val(data.DepartureTime);
												row.find('.Arr_Time').val(data.ArrivalTime);
												row.find('.Dep_Terminal').val(data.DepartureTerminal);
												row.find('.Arr_Terminal').val(data.ArrivalTerminal);
												row.find('.Equipment_Code').val(data.EquipmentCode);
												row.find('.Equipment_Name').val(data.EquipmentName);
												});
											});



											});
											</script>
											
                        				    
                        				    <input type='hidden' readonly name='product_id_<?php echo $auto_id; ?>' id='new_product_id' value="">
											
                    				    <?php
                    				}
                    			}
								?>
                    			<input type='submit' style='padding:15px; margin:0;font-size:11px;' id="submit_gds_updates" name='submit_gds_changes' value='Next'>
                        		</form>
								<?php
                    		}
                    		
                    		?>
							<script>
							document.addEventListener('DOMContentLoaded', function () {
							  const submitBtn = document.getElementById('submit_gds_updates');

							  function getDateFields() {
								// Covers inputs/selects/textareas with these classes
								return Array.from(document.querySelectorAll('.Dep_date, .Arr_date'));
							  }

							  function hasValue(el) {
								// Treats whitespace-only as empty
								return typeof el.value === 'string' && el.value.trim() !== '';
							  }

							  function updateButtonState() {
								const fields = getDateFields();
								const allFilled = fields.length > 0 && fields.every(hasValue);
								submitBtn.disabled = !allFilled;
								submitBtn.title = allFilled ? '' : 'Please fill all Dep_date and Arr_date fields';
								// Optional: subtle visual cue
								submitBtn.style.opacity = submitBtn.disabled ? '0.6' : '';
								submitBtn.style.pointerEvents = submitBtn.disabled ? 'none' : '';
							  }

							  function bindFieldEvents() {
								getDateFields().forEach(el => {
								  // Avoid rebinding
								  if (el._dateWatcherBound) return;
								  el.addEventListener('input', updateButtonState);
								  el.addEventListener('change', updateButtonState);
								  el._dateWatcherBound = true;
								});
							  }

							  // Initial bind + state
							  bindFieldEvents();
							  updateButtonState();

							  // Watch for dynamically added/removed fields
							  const mo = new MutationObserver(() => {
								bindFieldEvents();
								updateButtonState();
							  });
							  mo.observe(document.body, { childList: true, subtree: true, attributes: true, attributeFilter: ['class', 'value'] });

							  // Safety net if something updates value without firing events
							  setInterval(updateButtonState, 2000);
							});
							</script>

                    		<script>
        					$(document).on('change', '#travel_date_int', function(){
        					    
        					    var dc_amount = document.getElementById('dc_amount').value;
        					    if(dc_amount != '')
        					    {
        					        var responsemsg_received = '';
            						var form_data = new FormData(); // create a new FormData object
            						// add any data to the form_data object, as needed
            						form_data.append('req_type', 'movements_getproductid');
            						form_data.append('date', $('#travel_date_int').val());
            						form_data.append('tripcode', $('#trip_code').val());
            						$.ajax({
            							url: "/wp-content/themes/twentytwenty/templates/tpl_backend_functions.php",
            							method: "POST",
            							dataType: "json",
            							data: form_data,
            							contentType: false,
            							cache: false,
            							processData: false,
            							success: function (response) {
            								var id = response.id;
            								var title = response.title;
            								var pnr = response.pnr;
            								var pricingid = response.pricingid;
            								document.getElementById('new_product_id').value = id;
            								document.getElementById('product_title').value = title;
            								document.getElementById('pnr').value = pnr;
            								console.log(response);
            								change_total_price(pricingid);
            							},
            							error: function(xhr, textStatus, errorThrown) {
            								console.log(errorThrown);
            							}
            						});
        					    }
        					    else
        					    {
        					        alert("Please add the Datechange amount to proceed further.");
        					        document.getElementById('travel_date_int').value = '';
        					    }
        						
        					});
        					$(document).on('change', '#trip_code', function(){
        					    
        					    var dc_amount = document.getElementById('dc_amount').value;
        					    if(dc_amount != '')
        					    {
            						var responsemsg_received = '';
            						var form_data = new FormData(); // create a new FormData object
            						// add any data to the form_data object, as needed
            						form_data.append('req_type', 'movements_getproductid');
            						form_data.append('date', $('#travel_date_int').val());
            						form_data.append('tripcode', $('#trip_code').val());
            						$.ajax({
            							url: "/wp-content/themes/twentytwenty/templates/tpl_backend_functions.php",
            							method: "POST",
            							dataType: "json",
            							data: form_data,
            							contentType: false,
            							cache: false,
            							processData: false,
            							success: function (response) {
            								var id = response.id;
            								var title = response.title;
            								var pnr = response.pnr;
            								var pricingid = response.pricingid;
            								document.getElementById('new_product_id').value = id;
            								document.getElementById('product_title').value = title;
            								document.getElementById('pnr').value = pnr;
            								console.log(response);
            								change_total_price(pricingid);
            							},
            							error: function(xhr, textStatus, errorThrown) {
            								console.log(errorThrown);
            							}
            						});
        					    }
        					    else
        					    {
        					        alert("Please add the Datechange amount to proceed further.");
        					        document.getElementById('trip_code').value = '';
        					    }
        					    
        					});
				            </script>
                    		
                    		<?php
                    		
						   if (isset($_POST['submit_gds_changes'])) 
						   {
							
								//echo '<pre>'; print_r($_POST); echo '</pre>';

								// Combine all flight field arrays into pipe-separated strings
								$pnr_array = $_POST['PNRarray'] ?? [];
								$origin_codes = $_POST['Origin_Code'] ?? [];
								$destination_codes = $_POST['destination_code'] ?? [];
								$dep_dates = $_POST['Dep_date'] ?? [];
								$dep_times = $_POST['Dep_Time'] ?? [];
								$arr_dates = $_POST['Arr_date'] ?? [];
								$arr_times = $_POST['Arr_Time'] ?? [];
								$equipment_codes = $_POST['Equipment_Code'] ?? [];
								$equipment_names = $_POST['Equipment_Name'] ?? [];
								$flight_codes = $_POST['flight_code'] ?? [];
								$flight_numbers = $_POST['flight_number'] ?? [];
								$Dep_Terminal = $_POST['Dep_Terminal'] ?? [];
								$Arr_Terminal = $_POST['Arr_Terminal'] ?? [];
								
								$flight_Status = $_POST['Status'] ?? [];
								$flight_Meal = $_POST['Meal'] ?? [];
								$flight_Class = $_POST['Class'] ?? [];
								
								$total_amount = $_POST['total_amount'];

								
								$dep_datetime_combined = [];
								$arr_datetime_combined = [];

								foreach ($dep_dates as $i => $date) {
									$time = $dep_times[$i] ?? '00:00';
									$datetime = DateTime::createFromFormat('Y-m-d H:i', "$date $time");
									$dep_datetime_combined[] = $datetime ? $datetime->format('Y-m-d H:i:s') : '';
								}
								$travel_date_combined = $dep_datetime_combined[0];
								
								$return_date_combined = $dep_datetime_combined[0];
								foreach ($arr_dates as $i => $date) {
									$time = $arr_times[$i] ?? '00:00';
									$datetime = DateTime::createFromFormat('Y-m-d H:i', "$date $time");
									$arr_datetime_combined[] = $datetime ? $datetime->format('Y-m-d H:i:s') : '';
									$return_date_combined = $datetime ? $datetime->format('Y-m-d H:i:s') : '';
								}

								$manualFields = $_POST['manual_fields_log'] ?? '';
								$manualFieldsArray = array_filter(array_map('trim', explode(',', $manualFields)));

								foreach ($manualFieldsArray as $fieldName) {
									mysqli_query($mysqli,"insert into wpk4_backend_history_of_updates (type_id, meta_key, meta_value, updated_by, updated_on ) 
									values ('$order_id', 'Manually Updated Field', '$manualFields', '$currnt_userlogined', '$current_date_and_time')") or die(mysqli_error($mysqli));
								}

								$combined_flight_no = implode(' | ', array_map(fn($f) => substr($f, 2), $flight_numbers));
								$combined_airlinecode = implode(' | ', array_map(fn($f) => substr($f, 0, 2), $flight_numbers));


								// Combine fields
								$combined_data = [
									'Flightlegs DepApt'       => implode(' | ', $origin_codes),
									'Flightlegs DestApt' => implode(' | ', $destination_codes),
									'Flightlegs Equipment'   => implode(' | ', $equipment_codes),
									//'Equipment_Name_combined'   => implode(' | ', $equipment_names),
									//'Flight_Code_combined'      => implode(' | ', $flight_codes),
									'Flightlegs FlNr'    => $combined_flight_no,
									'Flightlegs OperatingCarrier'    => implode(' | ', $flight_codes),
									'Flightlegs MarketingCarrier'    => implode(' | ', $flight_codes),
									'Flightlegs Status'    => implode(' | ', $flight_Status),
									'Flightlegs Elapsed'    => implode(' | ', []),
									'Flightlegs Meal'    => implode(' | ', $flight_Meal),
									'Flightlegs Class'    => implode(' | ', $flight_Class),
									'Flightlegs CrFileKey'    => implode(' | ', $pnr_array),
									'Flightlegs DepTerminal'    => implode(' | ', $Dep_Terminal),
									'Flightlegs DestTerminal'    => implode(' | ', $Arr_Terminal),
								];
								
								// Add to main array
								$combined_data['Flightlegs DepTime'] = implode(' | ', $dep_datetime_combined);
								$combined_data['Flightlegs DestTime'] = implode(' | ', $arr_datetime_combined);

								// Get first origin and last destination
								$first_origin = $origin_codes[0] ?? '';
								$last_destination = end($destination_codes) ?: '';
								$pnr_final = $pnr_array[0];

								// Get first dep datetime and last arr datetime
								$first_dep_date = $dep_dates[0] ?? '';
								$first_dep_time = $dep_times[0] ?? '';
								$last_arr_date = end($arr_dates) ?: '';
								$last_arr_time = end($arr_times) ?: '';

								// Convert to datetime strings
								$first_dep_datetime = $first_dep_date . ' ' . $first_dep_time;
								$last_arr_datetime = $last_arr_date . ' ' . $last_arr_time;

								// Parse datetime objects
								$start = DateTime::createFromFormat('Y-m-d H:i:s', $travel_date_combined);
								$end = DateTime::createFromFormat('Y-m-d H:i:s', $return_date_combined);

								// Calculate trip type
								$trip_type = 'oneway';
								$return_point_found = false;
								$return_point_index = null;

								// Parse first departure datetime
								

								// Loop through all arrival datetimes to find a gap of more than 3 days
								foreach ($dep_datetime_combined as $i => $arr_datetime_str) {
									$arr_datetime_obj = DateTime::createFromFormat('Y-m-d H:i:s', $arr_datetime_str);
									$first_dep_datetime_obj = DateTime::createFromFormat('Y-m-d H:i:s', $arr_datetime_combined[$i - 1] ?? '');

									if ($first_dep_datetime_obj && $arr_datetime_obj) {
										$diff_days = $first_dep_datetime_obj->diff($arr_datetime_obj)->days;

										if ($diff_days > 3) {
											$trip_type = 'return';
											$return_point_found = true;
											$return_point_index = $i;
											break; // Stop at first segment with 3+ day gap
										}
									}
								}

								// Set return_date_combined only if return found
								if ($return_point_found && isset($dep_datetime_combined[$return_point_index])) {
									$return_date_combined = $dep_datetime_combined[$return_point_index];
								}

								// Optional: identify return destination code
								$return_destination_code = $return_point_found && isset($origin_codes[$return_point_index])
									? $origin_codes[$return_point_index]
									: '';
								
								$tripcode_combined = $first_origin . '-' . $return_destination_code;

								//echo "Trip Type: $trip_type\n";
								if ($trip_type === 'return') {

									//echo "Return starts at segment $return_point_index to: $return_destination_code\n";
									//echo "Return date: $return_date_combined\n";
								}


								// Output for verification
								/*echo "<pre>";
								echo "PNR: $pnr_final\n";
								echo "First Origin: $first_origin\n";
								echo "Last Destination: $last_destination\n";
								echo "Departure: $first_dep_datetime\n";
								echo "Arrival: $last_arr_datetime\n";
								echo "Trip Type: $trip_type\n";
								//print_r($combined_data);
								echo "</pre>";*/
								
								
								
								
								$product_id = '';
								$order_type = 'gds';
								
								echo $tripcode_combined . ' tripcode</br>';
								echo $travel_date_combined . ' travel</br>';
								echo $return_date_combined . ' return</br>';
								
								//echo '<pre>';
								//print_r($combined_data);
								//echo '</pre>';
								
								foreach ($combined_data as $key => $value)
								{
									// Escape key and value for safety
									$safe_key   = mysqli_real_escape_string($mysqli, $key);
									$safe_value = mysqli_real_escape_string($mysqli, $value);
									$safe_order_id = mysqli_real_escape_string($mysqli, $order_id);

									// Try to update
									$sql_update = "
										UPDATE wpk4_backend_history_of_updates
										SET meta_value = '$safe_value'
										WHERE type_id = '$safe_order_id' AND meta_key = '$safe_key'
									";

									$result = mysqli_query($mysqli, $sql_update);

									if (!$result) {
										error_log("Failed to update $safe_key: " . mysqli_error($mysqli));
										continue;
									}

									// If no rows were updated, insert instead
									if (mysqli_affected_rows($mysqli) === 0) {
										$sql_insert = "
											INSERT INTO wpk4_backend_history_of_updates (type_id, meta_key, meta_value)
											VALUES ('$safe_order_id', '$safe_key', '$safe_value')
										";

										$insert_result = mysqli_query($mysqli, $sql_insert);

										if (!$insert_result) {
											error_log("Failed to insert $safe_key: " . mysqli_error($mysqli));
										}
									}
								}

								
								$trip_price_value = '0';
								foreach ($_POST as $key2 => $value2) 
								{
									if (strpos($key2, 'total_amount') === 0) 
									{
										$trip_price_value = $value2;
									}
								}
								


								$tripcode_entered = $tripcode_combined;
								foreach ($_POST as $key3 => $value3) 
								{
									if (strpos($key3, 'tripcode_route_') === 0) 
									{
										$tripcode_entered = $value3;
									}
								}
								
								$dc_amount = '0';
								$total_amount_dc = '0';
								foreach ($_POST as $key2 => $value2) 
								{
									if (strpos($key2, 'total_amount') === 0) 
									{
										$total_amount_dc = $value2;
										$dc_amount = $value2;
										
										$total_amount_dc = number_format((float)$total_amount_dc, 2, '.', '') ;
										$dc_amount = number_format((float)$dc_amount, 2, '.', '') ;
									}
								}
								
								
								$all_pax_query_ticket_finder_booking = "SELECT previous_order_id FROM wpk4_backend_travel_bookings WHERE order_id = '$order_id' ";
								$result_all_pax_ticket_finder_booking = mysqli_query($mysqli, $all_pax_query_ticket_finder_booking) or die(" Pax query failed: " . mysqli_error($mysqli));
								$pax_ticket_finder_booking = mysqli_fetch_assoc($result_all_pax_ticket_finder_booking);
								$previous_order_id_new = $pax_ticket_finder_booking['previous_order_id'];
								
								$all_pax_query_ticket_finder_booking2 = "SELECT order_id, product_id FROM wpk4_backend_travel_bookings WHERE order_id = '$previous_order_id_new' ";
								echo $all_pax_query_ticket_finder_booking2.'</br>';
								$result_all_pax_ticket_finder_booking2 = mysqli_query($mysqli, $all_pax_query_ticket_finder_booking2) or die(" Pax query failed: " . mysqli_error($mysqli));
								$pax_ticket_finder_booking2 = mysqli_fetch_assoc($result_all_pax_ticket_finder_booking2);
								$previous_product_id_new = $pax_ticket_finder_booking2['product_id'];
								
								
								$is_ticketed = 0;
								$all_pax_query_ticket_finder = "SELECT ticket_number FROM wpk4_backend_travel_booking_pax WHERE order_id = '$previous_order_id_new' ";
								$result_all_pax_ticket_finder = mysqli_query($mysqli, $all_pax_query_ticket_finder) or die(" Pax query failed: " . mysqli_error($mysqli));
								while ($pax_ticket_finder = mysqli_fetch_assoc($result_all_pax_ticket_finder)) 
								{
									if($pax_ticket_finder['ticket_number'] != '')
									{
										$is_ticketed = 1;
										break;
									}
								}
								
								$reduce_past_dc_amount = 0;
								$query_booking_for_dc_history = "select total_amount from wpk4_backend_travel_bookings_datechange_cost_breakdown c 
								where c.order_id = '$previous_order_id_new'";
								$result_booking_for_dc_history = mysqli_query($mysqli, $query_booking_for_dc_history) or die(" Booking query failed: " . mysqli_error($mysqli));
								if(mysqli_num_rows($result_booking_for_dc_history) > 0 )
								{
									$pax_booking_for_dc_history = mysqli_fetch_assoc($result_booking_for_dc_history); 
									$reduce_past_dc_amount = (float)$pax_booking_for_dc_history['total_amount'];
								}
								
								if($total_amount > 0)
								{
									$total_calculated = $total_amount;
									if(isset($_GET['new_oid']) && $_GET['new_oid'] != '') // Partial DC
									{										
										$query_amt_check2 = "SELECT meta_value FROM wpk4_backend_history_of_updates where type_id = '$order_id' and meta_key = 'Transaction TotalTurnover'";
										$result_amt_check2 = mysqli_query($mysqli, $query_amt_check2);
										if(mysqli_num_rows($result_amt_check2) > 0 )
										{
											$row_amt_check2 = mysqli_fetch_assoc($result_amt_check2);
											$total_amount_existing = $row_amt_check2['meta_value'];
											
											$total_amount_existing = (float)$total_amount_existing - (float)$reduce_past_dc_amount;
											
											$total_calculated = (float)$total_amount + (float)$total_amount_existing;
											$total_calculated = number_format((float)$total_calculated, 2, '.', '') ;
														
										}
										
										
									}
									else // Full dc
									{
										if($is_ticketed == 0) // no ticket issued
										{
											$query_amt_check2 = "SELECT meta_value FROM wpk4_backend_history_of_updates where type_id = '$order_id' and meta_key = 'Transaction TotalTurnover'";
											$result_amt_check2 = mysqli_query($mysqli, $query_amt_check2);
											if(mysqli_num_rows($result_amt_check2) > 0 )
											{
												$row_amt_check2 = mysqli_fetch_assoc($result_amt_check2);
												$total_amount_existing = $row_amt_check2['meta_value'];
												
												$total_amount_existing = (float)$total_amount_existing - (float)$reduce_past_dc_amount;
												
												$total_calculated = (float)$total_amount + (float)$total_amount_existing;
												$total_calculated = number_format((float)$total_calculated, 2, '.', '') ;
											}
											
										}
										else
										{
											$total_calculated = $total_amount;
										}
									}
									
									$update_query5 = "UPDATE wpk4_backend_travel_bookings SET total_amount = '$total_calculated', deposit_amount='0', balance = '0' WHERE order_id = '$order_id'";
									//echo $update_query5.'</br>';
									$result5 = mysqli_query($mysqli, $update_query5);
									
									$update_query_turnover = "UPDATE wpk4_backend_history_of_updates SET meta_value = '$total_calculated' WHERE type_id = '$order_id' and meta_key = 'Transaction TotalTurnover'";
									$result_turnover = mysqli_query($mysqli, $update_query_turnover);
									
									$update_query_amt = "UPDATE wpk4_backend_history_of_updates SET meta_value = '$total_calculated' WHERE type_id = '$order_id' and meta_key = 'Payments Amount'";
									$result_amt = mysqli_query($mysqli, $update_query_amt);
									
									mysqli_query($mysqli,"insert into wpk4_backend_travel_bookings_datechange (order_id, dc_amount, total_amount, added_by, added_on ) 
									values ('$order_id', '$total_amount', '$total_calculated', 'date_change', '$current_date_and_time')") or die(mysqli_error($mysqli));
									
									
									//mysqli_query($mysqli,"insert into wpk4_backend_travel_bookings_datechange (order_id, dc_amount, total_amount, added_by, added_on ) 
									//values ('$order_id', '$dc_amount', '$total_amount_dc', 'date_change', '$current_date_and_time')") or die(mysqli_error($mysqli));
									
									//$update_query5 = "UPDATE wpk4_backend_travel_bookings SET total_amount = '$dc_amount', deposit_amount='0', balance = '$dc_amount' WHERE order_id = '$order_id'";
									//echo $update_query5.'</br>';
									//$result5 = mysqli_query($mysqli, $update_query5);
								}
								
								
								
								$update_query3 = "UPDATE wpk4_backend_travel_booking_pax SET pnr = '$pnr_final' WHERE order_id = '$order_id' and ( product_id = '$product_id' OR product_id = '' )";
								//echo $update_query3.'</br>';
								$result3 = mysqli_query($mysqli, $update_query3);
								
								
								
								$totalAmountRequest = $_POST['total_amount'];
								$airline_change_fee = $_POST['airline_change_fee'];
								$fare_difference = $_POST['fare_difference'];
								$gaura_service_fee = $_POST['gaura_service_fee'];
								$buffer = $_POST['buffer'];
								
								$row_case_id = '';
								$query_case_checker = "SELECT case_id FROM wpk4_backend_user_portal_requests WHERE reservation_ref = '$order_id'";
								$result_case_checker = mysqli_query($mysqli, $query_case_checker);	
								if(mysqli_num_rows($result_case_checker) > 0)
								{
									$row_case_checker = mysqli_fetch_assoc($result_case_checker);
									$row_case_id = $row_case_checker['case_id'] ;
								}

								mysqli_query($mysqli,"insert into wpk4_backend_travel_bookings_datechange_cost_breakdown (case_id, order_id, airline_change_fee, fare_difference, gaura_service_fee, buffer, total_amount, added_by, submit_source ) 
								values ('$row_case_id', '$order_id', '$airline_change_fee', '$fare_difference', '$gaura_service_fee', '$buffer', '$totalAmountRequest', '$currnt_userlogined', 'CS DC')") or die(mysqli_error($mysqli));
								
								
								$update_query = "UPDATE wpk4_backend_travel_bookings SET trip_code = '$tripcode_entered', travel_date = '$travel_date_combined', return_date = '$return_date_combined', product_id = '', t_type = '$trip_type' WHERE order_id = $order_id";
								//echo $update_query.'</br>';
								$result = mysqli_query($mysqli, $update_query);
								
								$update_query4 = "UPDATE wpk4_backend_travel_booking_pax SET product_id = '' WHERE order_id = '$order_id'";
								$result4 = mysqli_query($mysqli, $update_query4);

								$update_query5 = "UPDATE wpk4_backend_travel_bookings SET product_id = '' WHERE order_id = '$order_id'";
								$result5 = mysqli_query($mysqli, $update_query5);

								//echo $update_query4.'</br>';
								$new_order_id = $_GET['new_oid'] ?? '';
								
								echo '<script>window.location.href="?p=manage-datechange-v2&part=generate-payment-link&oid='.$order_id.'&coid='.$co_order_id.'&new_oid='.$new_order_id.'";</script>';

							}

						}
						
						if(isset($_GET['p']) && $_GET['p'] =='manage-datechange-v2' && isset($_GET['part']) && $_GET['part'] == 'booking-info-update')
						{
						    echo '</br></br></br>';
						    $order_id = $_GET['oid'];
							$co_order_id = $_GET['coid'] ?? '';
							
						    
						    $query_pax = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id' order by travel_date asc limit 1";
							//echo $query_pax;
                    		$result_pax = mysqli_query($mysqli, $query_pax);
                    		?>
                    		<h6>Order ID : <?php echo $order_id; ?></h6>
                    		<?php
                    		if(!empty($result_pax))
                    		{
                    		    ?>
								<script src="https://cdn.jsdelivr.net/gh/alumuko/vanilla-datetimerange-picker@latest/dist/vanilla-datetimerange-picker.js"></script>
								<script>
									window.addEventListener("load", function (event) {
									let drp = new DateRangePicker('travel_date_int',
											{
												
												timePicker: false,
												alwaysShowCalendars: true,
												singleDatePicker: true,
												autoApply: true,
												autoUpdateInput: true,
												
												locale: {
													format: "YYYY-MM-DD 00:00:00",
												}
											},
											function (start) {
												var startdate = start.format().substring(0,10);
												document.getElementById("travel_date_int").value = startdate;
												
											})
									});
									
									window.addEventListener("load", function (event) {
									let drp = new DateRangePicker('travel_date_fit',
											{
												
												timePicker: false,
												alwaysShowCalendars: true,
												singleDatePicker: true,
												autoApply: true,
												autoUpdateInput: true,
												
												locale: {
													format: "YYYY-MM-DD HH:mm:ss",
												}
											},
											function (start) {
												document.getElementById("travel_date_fit").value = start.format();
												
											})
									});
									
									window.addEventListener("load", function (event) {
									let drp = new DateRangePicker('return_date_fit',
											{
												
												timePicker: false,
												alwaysShowCalendars: true,
												singleDatePicker: true,
												autoApply: true,
												autoUpdateInput: true,
												
												locale: {
													format: "YYYY-MM-DD HH:mm:ss",
												}
											},
											function (start) {
												document.getElementById("return_date_fit").value = start.format();
												
											})
									});
								</script>
                    		    <form action="#" name="statusupdate" method="post" enctype="multipart/form-data" style='font-size:13px;'>
                    		    <?php
                    			$row_pax = mysqli_fetch_assoc($result_pax);
                    			{
                    			    $auto_id = $row_pax['auto_id'];
                    				$order_id = $row_pax['order_id'];
                    				$co_order_id_db = $row_pax['co_order_id'];
                    				$product_id = $row_pax['product_id'];
                    				$order_type = $row_pax['order_type'];
                    				$t_type = $row_pax['t_type'];
                    				$total_pax = $row_pax['total_pax'];
									$previous_order_id_sql = $row_pax['previous_order_id'];
									
									$query_pax_2 = "SELECT pnr FROM wpk4_backend_travel_booking_pax where order_id='$previous_order_id_sql' and (product_id = '$product_id' OR product_id = '') order by auto_id asc limit 1";
									$result_pax_2 = mysqli_query($mysqli, $query_pax_2);
									$row_pax_2 = mysqli_fetch_assoc($result_pax_2);
									$pnr = $row_pax_2['pnr'];
                    				?>
                    			    Airline Change Fee
									<input type='text' name='airline_change_fee' required id='airline_change_fee'></br>
									
									Fare Difference
									<input type='text' name='fare_difference' required id='fare_difference'></br>
									
									Gaura Travel Service Fee
									<input type='text' name='gaura_service_fee' required id='gaura_service_fee'></br>
									
									Buffer
									<input type='text' name='buffer' required id='buffer'></br>
									
									Cost Given / Datechange Amount (Amount to be requested from customer)
                        			<input type='text' name='total_amount' required id='dc_amount'></br>
									
                    			    <h6>Tripcode : <?php echo $row_pax['trip_code']; ?></h6>
                    				<?php
                    				
                    				echo "<input type='hidden' name='order_type_<?php echo $auto_id; ?>' value='".$order_type."' id='searchkeyvalue'>";
                    				echo "<input type='hidden' name='total_pax_<?php echo $auto_id; ?>' value='".$total_pax."' id='total_pax'>";
                    				if($order_type != 'gds') // wpt
                    				{
                    				    ?>
                        				    Trip code
                        				    <input type='text' name='trip_code_<?php echo $auto_id; ?>' required id='trip_code' value="<?php echo $row_pax['trip_code']; ?>"></br>
                        				    Travel date
                        				    <input type='text' name='travel_date_<?php echo $auto_id; ?>' required id='travel_date_int' value="<?php echo $row_pax['travel_date']; ?>"></br>
                        				    Product ID
                        				    <input type='text' readonly name='product_id_<?php echo $auto_id; ?>' required id='new_product_id' value="<?php echo $row_pax['product_id']; ?>"></br>
                        				    Product Title
                        				    <input type='text' readonly name='product_title_<?php echo $auto_id; ?>' required id='product_title' value="<?php echo $row_pax['product_title']; ?>">
                        				    <input type='hidden' readonly name='current_product_id_<?php echo $auto_id; ?>' id='searchkeyvalue' value="<?php echo $product_id; ?>">
                        				    </br>
                        				    PNR
                        				    <input type='text' name='pnr_<?php echo $auto_id; ?>' required id='pnr' value="<?php echo $pnr; ?>">
                        				    </br>
                        				    
                    				    <?php
                    				}
                    				
									if(1 == 2)
                    				{
                    				?>
                    				        Trip code
                        				    <input type='text' name='trip_code_<?php echo $auto_id; ?>' required id='searchkeyvalue' value="<?php echo $row_pax['trip_code']; ?>"></br>
                        				    Travel Date
                        				    <input type='text' name='travel_date_<?php echo $auto_id; ?>'required id='travel_date_fit' value="<?php echo $row_pax['travel_date']; ?>"></br>
                        				    Return Date
                        				    <input type='text' name='return_date_<?php echo $auto_id; ?>' required id='return_date_fit' value="<?php echo $row_pax['return_date']; ?>"></br>
                        				    
                        				    Trip Type
                        				    <input type='text' name='t_type_<?php echo $auto_id; ?>' required value="<?php echo $t_type; ?>"  id='searchkeyvalue'></br>
                        				    
                        				    PNR
                        				    <input type='text' name='pnr_<?php echo $auto_id; ?>' required id='pnr' value="<?php echo $pnr; ?>"></br>
                        				    <input type='hidden' readonly name='product_id_<?php echo $auto_id; ?>' id='new_product_id' value="">
											<!--
											Total Amount
                        				    <input type='text' readonly name='total_amount_<?php echo $auto_id; ?>' id='total_amount'></br>
                        				    </br>-->
                    				    <?php
                    				}
                    			}
                    			echo "<input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='submit_gds_changes' id='submit_gds_changes' value='Next'>
                        		</form>";
                    		}
                    		
                    		?>
                    		
        					<script>
document.addEventListener('DOMContentLoaded', function () {
    const travelInput = document.getElementById('travel_date_int');
    const tripCode = document.getElementById('trip_code');
    const submitBtn = document.getElementById('submit_gds_changes');
    const dcAmount = document.getElementById('dc_amount');

    let previousValue = '';

    // --- Add Fetch Product button after travel date field ---
    const fetchBtn = document.createElement('button');
    fetchBtn.type = 'button';
	fetchBtn.id = 'fetch_product_btn';
	fetchBtn.textContent = 'Fetch Product';
	fetchBtn.className = 'button button-primary';
	fetchBtn.style.fontSize = '12px';
	fetchBtn.style.margin = '15px 0';
	fetchBtn.style.marginLeft = '8px';
    travelInput.insertAdjacentElement('afterend', fetchBtn);

    // --- Utility to toggle button visibility ---
    function checkFields() {
        const pnr = document.getElementById('pnr').value.trim();
        const title = document.getElementById('product_title').value.trim();
        const product = document.getElementById('new_product_id').value.trim();

        if (pnr !== '' && title !== '' && product !== '') {
            submitBtn.style.display = 'inline-block'; // show button
        } else {
            submitBtn.style.display = 'none'; // hide button
        }
    }

    // --- AJAX function for reuse ---
    function fetchProductData(dateVal, tripVal) {
        const dc_amount = dcAmount.value;
        if (dc_amount === '') {
            alert("Please add the Datechange amount to proceed further.");
            if (dateVal) travelInput.value = '';
            if (tripVal) tripCode.value = '';
            return;
        }

        const form_data = new FormData();
        form_data.append('req_type', 'movements_getproductid');
        form_data.append('date', dateVal);
        form_data.append('tripcode', tripVal);

        // Hide submit button until update completes
        submitBtn.style.display = 'none';

        $.ajax({
            url: "/wp-content/themes/twentytwenty/templates/tpl_backend_functions.php",
            method: "POST",
            dataType: "json",
            data: form_data,
            contentType: false,
            cache: false,
            processData: false,
            success: function (response) {
                $('#new_product_id').val(response.id);
                $('#product_title').val(response.title);
                $('#pnr').val(response.pnr);
                console.log(response);
                checkFields(); // Show submit button if ready
            },
            error: function (xhr, textStatus, errorThrown) {
                console.log(errorThrown);
                checkFields();
            }
        });
    }

    // --- Handle Fetch Button click ---
    fetchBtn.addEventListener('click', function () {
        const dateVal = travelInput.value.trim();
        const tripVal = tripCode.value.trim();

        if (dateVal === '' || tripVal === '') {
            alert('Please select both Travel Date and Trip Code before fetching.');
            return;
        }

        fetchProductData(dateVal, tripVal);
    });

    // --- Just recheck submit visibility when typing ---
    travelInput.addEventListener('input', checkFields);
    tripCode.addEventListener('change', checkFields);
});
</script>


                    		
                    		<?php
                    		
                    		if (isset($_POST['submit_gds_changes'])) 
                    		{
								
								$totalAmount = $_POST['total_amount'];
								
                                foreach ($_POST as $key => $value) {
                                    // Match field pattern like trip_code_123, travel_date_123 etc.
                                    if (preg_match('/^(trip_code|travel_date|return_date|product_id|t_type|total_amount|product_title)_(\d+)$/', $key, $matches)) {
                                        $field = $matches[1];            // e.g., trip_code
                                        $auto_id = $matches[2];          // e.g., 123
                                        $safe_value = mysqli_real_escape_string($mysqli, $value);
                            
                                        // Organize values for each auto_id
                                        $update_data[$auto_id][$field] = $safe_value;
                                    }
                                    
                                }
                                
                                								
								$dc_amount = '0';
								$total_amount_dc = '0';
                                foreach ($_POST as $key2 => $value2) 
                                {
                                    if (strpos($key2, 'total_amount') === 0) 
                                    {
                                        $total_amount_dc = $value2;
										$dc_amount = $value2;
										
										$total_amount_dc = number_format((float)$total_amount_dc, 2, '.', '') ;
										$dc_amount = number_format((float)$dc_amount, 2, '.', '') ;
                                    }
                                }
								
								$all_pax_query_ticket_finder_booking = "SELECT previous_order_id FROM wpk4_backend_travel_bookings WHERE order_id = '$order_id' ";
								//echo $all_pax_query_ticket_finder_booking.'</br>';
								$result_all_pax_ticket_finder_booking = mysqli_query($mysqli, $all_pax_query_ticket_finder_booking) or die(" Pax query failed: " . mysqli_error($mysqli));
								$pax_ticket_finder_booking = mysqli_fetch_assoc($result_all_pax_ticket_finder_booking);
								$previous_order_id_new = $pax_ticket_finder_booking['previous_order_id'];
								
								$all_pax_query_ticket_finder_booking2 = "SELECT order_id, product_id FROM wpk4_backend_travel_bookings WHERE order_id = '$previous_order_id_new' ";
								//echo $all_pax_query_ticket_finder_booking2.'</br>';
								$result_all_pax_ticket_finder_booking2 = mysqli_query($mysqli, $all_pax_query_ticket_finder_booking2) or die(" Pax query failed: " . mysqli_error($mysqli));
								$pax_ticket_finder_booking2 = mysqli_fetch_assoc($result_all_pax_ticket_finder_booking2);
								$previous_product_id_new = $pax_ticket_finder_booking2['product_id'];
								
								$is_ticketed = 0;
								$all_pax_query_ticket_finder = "SELECT ticket_number FROM wpk4_backend_travel_booking_pax WHERE order_id = '$previous_order_id_new' ";
								//echo $all_pax_query_ticket_finder.'</br>';
								$result_all_pax_ticket_finder = mysqli_query($mysqli, $all_pax_query_ticket_finder) or die(" Pax query failed: " . mysqli_error($mysqli));
								while ($pax_ticket_finder = mysqli_fetch_assoc($result_all_pax_ticket_finder)) 
								{
									if($pax_ticket_finder['ticket_number'] != '')
									{
										$is_ticketed = 1;
										break;
									}
								}
								
								$reduce_past_dc_amount = 0;
								$query_booking_for_dc_history = "select total_amount from wpk4_backend_travel_bookings_datechange_cost_breakdown c 
								where c.order_id = '$previous_order_id_new'";
								$result_booking_for_dc_history = mysqli_query($mysqli, $query_booking_for_dc_history) or die(" Booking query failed: " . mysqli_error($mysqli));
								if(mysqli_num_rows($result_booking_for_dc_history) > 0 )
								{
									$pax_booking_for_dc_history = mysqli_fetch_assoc($result_booking_for_dc_history); 
									$reduce_past_dc_amount = (float)$pax_booking_for_dc_history['total_amount'];
								}
								
								//echo '1</br>';
								if($totalAmount > 0)
								{
									//echo '2</br>';
									if(isset($_GET['new_oid']) && $_GET['new_oid'] != '') // Partial DC
									{
										//echo '3</br>';
										$query_amt_check = "SELECT total_amount FROM wpk4_backend_travel_bookings where order_id = '$order_id'";
										$result_amt_check = mysqli_query($mysqli, $query_amt_check);
										if(mysqli_num_rows($result_amt_check) > 0 )
										{
											//echo '4</br>';
											$row_amt_check = mysqli_fetch_assoc($result_amt_check);
											$total_amount_existing = $row_amt_check['total_amount'];
											
											$total_amount_existing = (float)$total_amount_existing - (float)$reduce_past_dc_amount;
											
											$total_calculated = (float)$dc_amount + (float)$total_amount_existing;
											$total_calculated = number_format((float)$total_calculated, 2, '.', '') ;
										}
										
										
									}
									else
									{
										//echo '5</br>';
										if($is_ticketed == 0) // no ticket issued
										{
											//echo '6</br>';
											$query_amt_check = "SELECT total_amount FROM wpk4_backend_travel_bookings where order_id = '$order_id'";
											$result_amt_check = mysqli_query($mysqli, $query_amt_check);
											if(mysqli_num_rows($result_amt_check) > 0 )
											{
												//echo '7</br>';
												$row_amt_check = mysqli_fetch_assoc($result_amt_check);
												$total_amount_existing = $row_amt_check['total_amount'];
												
												$total_amount_existing = (float)$total_amount_existing - (float)$reduce_past_dc_amount;
												
												$total_calculated = (float)$dc_amount + (float)$total_amount_existing;
												$total_calculated = number_format((float)$total_calculated, 2, '.', '') ;
											}
										}
										else 
										{
											//echo '8</br>';
											$total_calculated = $dc_amount;
										}
									}
									//echo '9</br>';
									
									$update_query5 = "UPDATE wpk4_backend_travel_bookings SET total_amount = '$total_calculated', deposit_amount='0', balance = '0' WHERE order_id = '$order_id'";
									echo $update_query5.'</br>';
									$result5 = mysqli_query($mysqli, $update_query5);
									
									mysqli_query($mysqli,"insert into wpk4_backend_travel_bookings_datechange (order_id, dc_amount, total_amount, added_by, added_on ) 
									values ('$order_id', '$dc_amount', '$total_calculated', 'date_change', '$current_date_and_time')") or die(mysqli_error($mysqli));
									
									
								}
								
								$pnr = '';
								foreach ($_POST as $key3 => $value3) 
                                {
                                    if (strpos($key3, 'pnr_') === 0) 
                                    {
										$pnr = $value3;
                                    }
                                }
								//if($pnr != '')
								{
									$update_query3 = "UPDATE wpk4_backend_travel_booking_pax SET pnr = '$pnr' WHERE order_id = '$order_id' and ( product_id = '$product_id' OR product_id = '' )";
									//echo $update_query3.'</br>';
                                    $result3 = mysqli_query($mysqli, $update_query3);
								}
								
								$product_id_pax = '';
								foreach ($_POST as $key4 => $value4) 
                                {
                                    if (strpos($key4, 'product_id_') === 0) 
                                    {
										$product_id_pax = $value4;
                                    }
                                }
								if($product_id_pax != '' && $order_type != 'gds')
								{
									$update_query4 = "UPDATE wpk4_backend_travel_booking_pax SET product_id = '$product_id_pax' WHERE order_id = '$order_id' and ( product_id = '$product_id' OR product_id = '' )";
									//echo $update_query4.'</br>';
                                    $result4 = mysqli_query($mysqli, $update_query4);
								}
								
								if($order_type == 'gds')
								{
									$update_query4 = "UPDATE wpk4_backend_travel_booking_pax SET product_id = '' WHERE order_id = '$order_id'";
                                    $result4 = mysqli_query($mysqli, $update_query4);
									//echo $update_query4.'</br>';
								}
								
								
								$totalAmountRequest = $_POST['total_amount'];
								
								$airline_change_fee = $_POST['airline_change_fee'];
								$fare_difference = $_POST['fare_difference'];
								$gaura_service_fee = $_POST['gaura_service_fee'];
								$buffer = $_POST['buffer'];
								
								$row_case_id = '';
								$query_case_checker = "SELECT case_id FROM wpk4_backend_user_portal_requests WHERE reservation_ref = '$order_id'";
								$result_case_checker = mysqli_query($mysqli, $query_case_checker);	
								if(mysqli_num_rows($result_case_checker) > 0)
								{
									$row_case_checker = mysqli_fetch_assoc($result_case_checker);
									$row_case_id = $row_case_checker['case_id'] ;
								}

								mysqli_query($mysqli,"insert into wpk4_backend_travel_bookings_datechange_cost_breakdown (case_id, order_id, airline_change_fee, fare_difference, gaura_service_fee, buffer, total_amount, added_by, submit_source ) 
								values ('$row_case_id', '$order_id', '$airline_change_fee', '$fare_difference', '$gaura_service_fee', '$buffer', '$totalAmountRequest', '$currnt_userlogined', 'CS DC')") or die(mysqli_error($mysqli));
								
								// Now run update query for each auto_id
                                foreach ($update_data as $auto_id => $fields) {
                                    $set_clause_parts = [];
                                    foreach ($fields as $field => $value) {
                                        $set_clause_parts[] = "$field = '$value'";
                                    }
                                    $set_clause = implode(", ", $set_clause_parts);
                                    $update_query = "UPDATE wpk4_backend_travel_bookings SET $set_clause WHERE auto_id = $auto_id";
									//echo $update_query.'</br>';
                                    $result = mysqli_query($mysqli, $update_query);
                                    
                                    
                                    foreach ($fields as $field => $value) 
                                    {
                                        if($field == 'product_id' && $order_type == 'gds')
        								{
        									$update_query5 = "UPDATE wpk4_backend_travel_bookings SET product_id = '' WHERE auto_id = $auto_id";
                                            $result5 = mysqli_query($mysqli, $update_query5);
        								}
                                    }
    								
                                    if (!$result) 
                                    {
                                        echo "Error updating auto_id $auto_id: " . mysqli_error($mysqli) . "<br>";
                                    } 
                                    else 
                                    {
										
                                    }
                                }
								
								if($order_type != 'gds')
								{
									$query_stock_check = "SELECT trip_code, travel_date, total_pax FROM wpk4_backend_travel_bookings where auto_id = $auto_id and order_type != 'gds'";
									$result_stock_check = mysqli_query($mysqli, $query_stock_check);
									if(mysqli_num_rows($result_stock_check) > 0 )
                                    {
										$row_stock_check = mysqli_fetch_assoc($result_stock_check);
												
										$trip_code = $row_stock_check['trip_code'];
										$travel_date = $row_stock_check['travel_date'];
										$total_pax = $row_stock_check['total_pax'];
										
										update_stock_in_pricing_table($trip_code, $travel_date, $total_pax, 'positive');
										
										$by_user = 'dc_in_customer_portal';
																												
										availability_table_pax_update_positive($order_id, $by_user);
									}
								}
								
								$new_order_id = $_GET['new_oid'] ?? '';
                                $query_pax2 = "SELECT auto_id FROM wpk4_backend_travel_bookings where order_id='$order_id' and order_type != 'gds' and t_type = 'return'";
								$result_pax2 = mysqli_query($mysqli, $query_pax2);
								if(mysqli_num_rows($result_pax2) > 0 )
                                {
                                   echo '<script>window.location.href="?p=manage-datechange-v2&part=booking-info-update-return&oid='.$order_id.'&coid='.$co_order_id.'&new_oid='.$new_order_id.'";</script>';
                                }
                                else
                                {
                                   echo '<script>window.location.href="?p=manage-datechange-v2&part=generate-payment-link&oid='.$order_id.'&coid='.$co_order_id.'&new_oid='.$new_order_id.'";</script>';
                                }
                            }
						}
						
						if(isset($_GET['p']) && $_GET['p'] =='manage-datechange-v2' && isset($_GET['part']) && $_GET['part'] == 'booking-info-update-return')
						{
						    echo '</br></br></br>';
						    $order_id = $_GET['oid'];
						    $co_order_id = $_GET['coid'] ?? '';
							
						    $query_pax = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id' and co_order_id = '$co_order_id' order by travel_date desc limit 1";
                    		$result_pax = mysqli_query($mysqli, $query_pax);
                    		?>
                    		<h6>Order ID : <?php echo $order_id; ?></h6>
                    		<?php
                    		if(!empty($result_pax))
                    		{
                    		    ?>
								<script src="https://cdn.jsdelivr.net/gh/alumuko/vanilla-datetimerange-picker@latest/dist/vanilla-datetimerange-picker.js"></script>
								<script>
									window.addEventListener("load", function (event) {
									let drp = new DateRangePicker('travel_date_int',
											{
												
												timePicker: false,
												alwaysShowCalendars: true,
												singleDatePicker: true,
												autoApply: true,
												autoUpdateInput: true,
												
												locale: {
													format: "YYYY-MM-DD 00:00:00",
												}
											},
											function (start) {
												var startdate = start.format().substring(0,10);
												document.getElementById("travel_date_int").value = startdate;
												
											})
									});
								</script>
                    		    <form action="#" name="statusupdate" method="post" enctype="multipart/form-data" style='font-size:13px;'>
                    		    <?php
                    			$row_pax = mysqli_fetch_assoc($result_pax);
                    			{
                    			?>
                    			    <h6>Tripcode : <?php echo $row_pax['trip_code']; ?></h6>
                    				<?php
                    				$auto_id = $row_pax['auto_id'];
                    				$order_id = $row_pax['order_id'];
                    				$co_order_id_db = $row_pax['co_order_id'];
                    				$product_id = $row_pax['product_id'];
                    				$order_type = $row_pax['order_type'];
                    				$t_type = $row_pax['t_type'];
                    				$total_pax = $row_pax['total_pax'];
									$previous_order_id_sql = $row_pax['previous_order_id'];
									
									$query_pax_2 = "SELECT pnr FROM wpk4_backend_travel_booking_pax where order_id='$previous_order_id_sql' and (product_id = '$product_id' OR product_id = '') order by auto_id asc limit 1";
									$result_pax_2 = mysqli_query($mysqli, $query_pax_2);
									$row_pax_2 = mysqli_fetch_assoc($result_pax_2);
									$pnr = $row_pax_2['pnr'];
                    				
                    				echo "<input type='hidden' name='order_type_<?php echo $auto_id; ?>' value='".$order_type."' id='searchkeyvalue'>";
                    				echo "<input type='hidden' name='total_pax_<?php echo $auto_id; ?>' value='".$total_pax."' id='total_pax'>";
									
                    				if($order_type != 'gds') // wpt
                    				{
                    				    ?>
                        				    Trip code
                        				    <input type='text' name='trip_code_<?php echo $auto_id; ?>' required id='trip_code' value="<?php echo $row_pax['trip_code']; ?>"></br>
                        				    Travel date
                        				    <input type='text' name='travel_date_<?php echo $auto_id; ?>' required id='travel_date_int' value="<?php echo $row_pax['travel_date']; ?>"></br>
                        				    Product ID
                        				    <input type='text' name='product_id_<?php echo $auto_id; ?>' required id='new_product_id' value="<?php echo $row_pax['product_id']; ?>"></br>
                        				    Product Title
                        				    <input type='text' name='product_title_<?php echo $auto_id; ?>' required id='product_title' value="<?php echo $row_pax['product_title']; ?>">
                        				    <input type='hidden' name='current_product_id_<?php echo $auto_id; ?>' required id='searchkeyvalue' value="<?php echo $product_id; ?>">
                        				    </br>
                        				    PNR
                        				    <input type='text' name='pnr_<?php echo $auto_id; ?>' id='pnr' required value="<?php echo $row_pax_2['pnr']; ?>"></br>
                        				    <?php
                        				    $query_pax3 = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id' order by travel_date asc limit 1";
                    		                $result_pax3 = mysqli_query($mysqli, $query_pax3);
                                            $row_pax3 = mysqli_fetch_assoc($result_pax3);
                        				    ?>
                        				    
                        				    <input type='hidden' readonly name='total_amount_<?php echo $auto_id; ?>' id='total_amount' value="<?php echo $row_pax3['total_amount']; ?>"></br>
                    				    <?php
                    				}
                    			}
                    			echo "<input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='submit_gds_changes' id='submit_gds_changes' value='Next'>
                        		</form>";
                    		}
                    		
                    		?>
                    		<script>
document.addEventListener('DOMContentLoaded', function () {
    const travelInput = document.getElementById('travel_date_int');
    const tripCode = document.getElementById('trip_code');
    const submitBtn = document.getElementById('submit_gds_changes');

    let previousValue = '';

    // --- Insert Fetch button after travel date input ---
    const fetchBtn = document.createElement('button');
    fetchBtn.type = 'button';
	fetchBtn.id = 'fetch_product_btn';
	fetchBtn.textContent = 'Fetch Product';
	fetchBtn.className = 'button button-primary';
	fetchBtn.style.fontSize = '12px';
	fetchBtn.style.margin = '15px 0';
	fetchBtn.style.marginLeft = '8px';
    travelInput.insertAdjacentElement('afterend', fetchBtn);

    // --- Utility to toggle button visibility ---
    function checkFields() {
        const pnr = document.getElementById('pnr').value.trim();
        const title = document.getElementById('product_title').value.trim();
        const product = document.getElementById('new_product_id').value.trim();

        if (pnr !== '' && title !== '' && product !== '') {
            submitBtn.style.display = 'inline-block'; // show button
        } else {
            submitBtn.style.display = 'none'; // hide button
        }
    }

    // --- AJAX function ---
    function fetchProductData(dateVal, tripVal) {
        if (dateVal === '' || tripVal === '') {
            alert('Please select both Travel Date and Trip Code.');
            return;
        }

        const form_data = new FormData();
        form_data.append('req_type', 'movements_getproductid');
        form_data.append('date', dateVal);
        form_data.append('tripcode', tripVal);

        submitBtn.style.display = 'none';

        $.ajax({
            url: "/wp-content/themes/twentytwenty/templates/tpl_backend_functions.php",
            method: "POST",
            dataType: "json",
            data: form_data,
            contentType: false,
            cache: false,
            processData: false,
            success: function (response) {
                $('#new_product_id').val(response.id);
                $('#product_title').val(response.title);
                $('#pnr').val(response.pnr);
                console.log(response);
                checkFields();
            },
            error: function (xhr, textStatus, errorThrown) {
                console.log(errorThrown);
                checkFields();
            }
        });
    }

    // --- When Fetch button clicked ---
    fetchBtn.addEventListener('click', function () {
        const dateVal = $('#travel_date_int').val();
        const tripVal = $('#trip_code').val();
        fetchProductData(dateVal, tripVal);
    });

    // --- Recheck on manual edits ---
    travelInput.addEventListener('input', checkFields);
    tripCode.addEventListener('change', checkFields);
});
</script>

                    		<?php
                    		
                    		if (isset($_POST['submit_gds_changes'])) 
                    		{
                                foreach ($_POST as $key => $value) {
                                    // Match field pattern like trip_code_123, travel_date_123 etc.
                                    if (preg_match('/^(trip_code|travel_date|return_date|product_id|t_type|product_title)_(\d+)$/', $key, $matches)) {
                                        $field = $matches[1];            // e.g., trip_code
                                        $auto_id = $matches[2];          // e.g., 123
                                        $safe_value = mysqli_real_escape_string($mysqli, $value);
                            
                                        // Organize values for each auto_id
                                        $update_data[$auto_id][$field] = $safe_value;
                                    }
                                }
								
								$product_id_pax = '';
								foreach ($_POST as $key4 => $value4) 
                                {
                                    if (strpos($key4, 'product_id_') === 0) 
                                    {
										$product_id_pax = $value4;
                                    }
                                }
								if($product_id_pax != '' && $order_type != 'gds')
								{
									$update_query4 = "UPDATE wpk4_backend_travel_booking_pax SET product_id = '$product_id_pax' WHERE order_id = '$order_id' and ( product_id = '$product_id' OR product_id = '' )";
									//echo $update_query4.'</br>';
                                    $result4 = mysqli_query($mysqli, $update_query4);
								}
								
								
								$pnr = '';
								foreach ($_POST as $key3 => $value3) 
                                {
                                    if (strpos($key3, 'pnr_') === 0) 
                                    {
										$pnr = $value3;
                                    }
                                }
								if($pnr != '')
								{
									$update_query3 = "UPDATE wpk4_backend_travel_booking_pax SET pnr = '$pnr' WHERE order_id = '$order_id' and ( product_id = '$product_id' OR product_id = '' )";
									//echo $update_query3.'</br>';
                                    $result3 = mysqli_query($mysqli, $update_query3);
								}
								
								
								if($order_type == 'gds')
								{
									$update_query4 = "UPDATE wpk4_backend_travel_booking_pax SET product_id = '' WHERE order_id = '$order_id'";
                                    $result4 = mysqli_query($mysqli, $update_query4);
									//echo $update_query4.'</br>';
								}
								
								
								
                            
                                // Now run update query for each auto_id
                                foreach ($update_data as $auto_id => $fields) {
                                    $set_clause_parts = [];
                                    foreach ($fields as $field => $value) {
                                        $set_clause_parts[] = "$field = '$value'";
                                    }
                                    $set_clause = implode(", ", $set_clause_parts);
                                    $update_query = "UPDATE wpk4_backend_travel_bookings SET $set_clause WHERE auto_id = $auto_id";
									//echo $update_query.'</br>';
                                    $result = mysqli_query($mysqli, $update_query);
                                    if (!$result) 
                                    {
                                        echo "Error updating auto_id $auto_id: " . mysqli_error($mysqli) . "<br>";
                                    } 
                                    else 
                                    {
										
                                    }
                                }
								
								$query_stock_check = "SELECT trip_code, travel_date, total_pax FROM wpk4_backend_travel_bookings where auto_id = $auto_id and order_type != 'gds'";
									//echo $query_stock_check.'</br>';
									$result_stock_check = mysqli_query($mysqli, $query_stock_check);
									if(mysqli_num_rows($result_stock_check) > 0 )
                                    {
										$row_stock_check = mysqli_fetch_assoc($result_stock_check);
												
										$trip_code = $row_stock_check['trip_code'];
										$travel_date = $row_stock_check['travel_date'];
										$total_pax = $row_stock_check['total_pax'];
										
										update_stock_in_pricing_table($trip_code, $travel_date, $total_pax, 'positive');
										
										$by_user = 'dc_in_customer_portal';
																												
										availability_table_pax_update_positive($order_id, $by_user);
									}
								
								$new_order_id = $_GET['new_oid'] ?? '';
                                echo '<script>window.location.href="?p=manage-datechange-v2&part=generate-payment-link&oid='.$order_id.'&coid='.$co_order_id.'&new_oid='.$new_order_id.'";</script>';
                            }
						}
						
						if(isset($_GET['p']) && $_GET['p'] =='manage-datechange-v2' && isset($_GET['part']) && $_GET['part'] == 'generate-payment-link')
						{
						    
						    echo '</br></br></br>';
						    $order_id = $_GET['oid'];
							$co_order_id = $_GET['coid'] ?? '';
						    ?>
							<center>
							<h5>Date change process is done.</h5>
							<h5>Please instruct customer to make their balance payment through Customer Portal.</h5>
							</br></br>
							<h3>Datechange Order ID: <?php echo $order_id; ?></h3>
							</center>
							<?php
							$query_booking_check = "SELECT trip_code, travel_date, total_pax, product_id FROM wpk4_backend_travel_bookings where order_id = $order_id";
							$result_booking_check = mysqli_query($mysqli, $query_booking_check);
							if(mysqli_num_rows($result_booking_check) > 0 )
                            {
                                while($row_bookings = mysqli_fetch_assoc($result_booking_check))
                                {
                                    $product_id = $row_bookings['product_id'];
                                    echo '</br><h5>'.$row_bookings['trip_code'] . ' - ' . date("d/m/Y", strtotime( $row_bookings['travel_date'] )) . '</h5>';
                                    
                                    $query_pax_check = "SELECT fname, lname, dob FROM wpk4_backend_travel_booking_pax where order_id = $order_id and product_id = '$product_id'";
        							$result_pax_check = mysqli_query($mysqli, $query_pax_check) or die("Pax query failed: " . mysqli_error($mysqli));
        							if(mysqli_num_rows($result_pax_check) > 0 )
                                    {
                                        echo '<table class="table table-striped" style="width:100%; margin:auto;font-size:14px; margin-top:35px;"><tr>
                                            <th>Pax Name</th>
                                            <th>DOB</th>
                                            </tr>';
                                        while($row_pax = mysqli_fetch_assoc($result_pax_check))
                                        {
                                            echo '<tr>
                                                    <td style="height:40px;">'.$row_pax['fname'] . ' ' . $row_pax['lname'] .'</td>
                                                    <td style="height:40px;">'.$row_pax['dob'].'</td>
                                                </tr>';
                                        }
                                    }
                                    
                                    echo '</table>';
                                }
                            }
							?>
                            </br></br>
							<?php
							if(isset($_GET['new_oid']) && $_GET['new_oid'] != '')
							{
							    $new_order_id = $_GET['new_oid'];
								?>
								<center>
								<h3>Non Datechange Order ID: <?php echo $_GET['new_oid']; ?></h3>
								</center>
								<?php
								
								$query_booking_check = "SELECT trip_code, travel_date, total_pax, product_id FROM wpk4_backend_travel_bookings where order_id = $new_order_id";
    							$result_booking_check = mysqli_query($mysqli, $query_booking_check);
    							if(mysqli_num_rows($result_booking_check) > 0 )
                                {
                                    while($row_bookings = mysqli_fetch_assoc($result_booking_check))
                                    {
                                        $product_id = $row_bookings['product_id'];
                                        echo '</br><h5>'.$row_bookings['trip_code'] . ' - ' . date("d/m/Y", strtotime( $row_bookings['travel_date'] )) . '</h5>';
                                        $query_pax_check = "SELECT fname, lname, dob FROM wpk4_backend_travel_booking_pax where order_id = $new_order_id and product_id = '$product_id'";
            							$result_pax_check = mysqli_query($mysqli, $query_pax_check) or die("Pax query failed: " . mysqli_error($mysqli));
            							if(mysqli_num_rows($result_pax_check) > 0 )
                                        {
                                            echo '<table class="table table-striped" style="width:100%; margin:auto;font-size:14px; margin-top:35px;"><tr>
                                                <th>Pax Name</th>
                                                <th>DOB</th>
                                                </tr>';
                                            while($row_pax = mysqli_fetch_assoc($result_pax_check))
                                            {
                                                echo '<tr>
                                                        <td style="height:40px;">'.$row_pax['fname'] . ' ' . $row_pax['lname'] .'</td>
                                                        <td style="height:40px;">'.$row_pax['dob'].'</td>
                                                    </tr>';
                                            }
                                        }
                                        
                                        echo '</table>';
                                    }
                                }
							}
							?>
							
							
												<?php
												if(isset($_POST['request_clone_booking_payment']))
                                                {
                                				    $order_id_for_payment_request = $_POST['order_id'];
                                                    $emailid_for_payment_request = $_POST['emailid'];
                                                    $type_of_payment_for_payment_request = 'Payment';
                                                    $pnr_for_payment_request = $_POST['pnr'];
                                                    $paymentAmount = $_POST['payment_amount'];
                                                    $customer_case_id_for_payment_request = '0';
                                                    
                                                    $paymentAmount_2Decimal = number_format((float)$_POST['payment_amount'], 2, '.', '') ;
                                                    {
                                                        
                                                        if($order_id_for_payment_request && $paymentAmount && $type_of_payment_for_payment_request)
                                                        {
                                    				        if (class_exists('GuzzleHttp\Client'))
                                    				        {}
                                    				        else
                                                            {
                                                                echo '<script>alert("Error on payment link. Contact HO.");</script>';
                                                            }
                                                        }
                                                        else
                                                        {
                                                            echo '<script>alert("Error during the request. Kindly try again later.");</script>';
                                                        }
                                                    }
                                                }
						}
						
						
						
						
						
						
						
						
						if(isset($_GET['p']) && $_GET['p'] =='manage-datechange-update-name-v2' && !isset($_GET['part']))
					{
						echo '</br></br></br>';
						    $order_id = $_GET['oid'];
													    
                    		$query_pax = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id' order by travel_date asc limit 1;";
                    		$result_pax = mysqli_query($mysqli, $query_pax);
                    		?>
                    		<h6>Order ID : <?php echo $order_id; ?></h6>
                    		<?php
                    		if(!empty($result_pax))
                    		{
                    			while($row_pax = mysqli_fetch_assoc($result_pax))
                    			{
                    			?>
                    				<form action="#" name="statusupdate" id="divideForm" method="post" enctype="multipart/form-data" style='font-size:13px;'>
                    				    <table class="table table-striped" style="width:100%;"><thead><tr><th width='10%'>Check</th><th>Name</th><th>Passport</th><th>DOB</th></tr></thead><tbody>
                    				<?php
                    				$order_id = $row_pax['order_id'];
                    				$co_order_id_db = $row_pax['co_order_id'];
                    				$product_id = $row_pax['product_id'];
                    				$order_type = $row_pax['order_type'];
                    				
									echo '<input type="hidden" name="id" id="teammembers_status" value="'.$order_id.'">';
									echo '<input type="hidden" name="co_orderid" id="teammembers_status" value="'.$co_order_id_db.'">';
									echo '<input type="hidden" name="productid" id="teammembers_status" value="'.$product_id.'">';
									echo '<input type="hidden" name="order_type" id="teammembers_status" value="'.$order_type.'">';
									
                    				if($order_type != 'gds') // wpt
                    				{
                    				    $query_paxc = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id' and co_order_id = '$co_order_id_db' AND product_id = '$product_id' ";
                        				$result_paxc = mysqli_query($mysqli, $query_paxc);
                        				$row_pax_count = mysqli_num_rows($result_paxc);
                        				while($row_paxc = mysqli_fetch_assoc($result_paxc))
                        				{
                        					$salutation = $row_paxc['salutation']; 
                        					$fname = $row_paxc['fname']; 
                        					$lname = $row_paxc['lname']; 
                        					$ppn = $row_paxc['ppn']; 
                        					$dob = $row_paxc['dob']; 
                        					$auto_id = $row_paxc['auto_id'];
                        					?>
                        					<tr><td>
                        					<?php
                        					if($row_pax_count > 1)
                        					{
                        					?>
                        						<input type="checkbox" checked id="pxe" name="pax_ids_for_new_order[]" class="pxe" value="<?php echo $auto_id; ?>">
                        					<?php
                        					}
                        					else
                        					{
                        					
                        					}
                        					?>
                        					</td><td><?php echo $salutation; ?> <?php echo $fname; ?> <?php echo $lname; ?></td><td><?php echo $ppn; ?></td><td><?php echo $dob; ?></td></tr>
                        				<?php
                        				}
                    				}
                    				else // gds
                    				{
                    				    $query_paxc = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id' and co_order_id = '$co_order_id_db' ";
                        				$result_paxc = mysqli_query($mysqli, $query_paxc);
                        				$row_pax_count = mysqli_num_rows($result_paxc);
                        				while($row_paxc = mysqli_fetch_assoc($result_paxc))
                        				{
                        					$salutation = $row_paxc['salutation']; 
                        					$fname = $row_paxc['fname']; 
                        					$lname = $row_paxc['lname']; 
                        					$ppn = $row_paxc['ppn']; 
                        					$dob = $row_paxc['dob']; 
                        					$auto_id = $row_paxc['auto_id'];
                        					?>
                        					<tr><td>
                        					<?php
                        					if($row_pax_count > 1)
                        					{
                        					?>
                        						<input type="checkbox" checked id="pxe" name="pax_ids_for_new_order[]" class="pxe"  value="<?php echo $auto_id; ?>">
                        					<?php
                        					}
                        					
                        					?>
                        					</td><td><?php echo $salutation; ?> <?php echo $fname; ?> <?php echo $lname; ?></td><td><?php echo $ppn; ?></td><td><?php echo $dob; ?></td></tr>
                        				<?php
                        				}
                    				}
                    				?>
                    				<tr><td colspan='4'></td></tr></tbody>
                    				</table>
                    			<?php
                    			}
								?>
								<div id="divide_submit" style="display:none;">
									<input type="submit" style="padding:15px; margin:0; font-size:11px;" name="divideorder" value="Divide & Next">
								</div>
								<div id="next_without_divide" >
									<input type="submit" style="padding:15px; margin:0; font-size:11px;" name="without_divideorder" value="Clone & Next">
								</div>
								</form>
								<script>
                                document.getElementById('divideForm').addEventListener('submit', function (e) {
                                    // Identify which submit button was clicked
                                    const clickedButton = document.activeElement;
                                
                                    // Only show confirmation for divide or clone actions
                                    if (
                                        clickedButton &&
                                        (clickedButton.name === 'divideorder' || clickedButton.name === 'without_divideorder')
                                    ) {
                                        const confirmMsg = "Do you want to continue with the passenger(s) selected?";
                                        if (!confirm(confirmMsg)) {
                                            e.preventDefault(); // Stop the form from submitting
                                        }
                                    }
                                });
                                </script>
								<script>
								function updateButtonVisibility() {
									const checkboxes = Array.from(document.querySelectorAll('.pxe'));
									const total = checkboxes.length;
									const checkedCount = checkboxes.filter(cb => cb.checked).length;

									if (checkedCount === 0 || checkedCount === total) {
										// All or none are selected
										document.getElementById('next_without_divide').style.display = 'block';
										document.getElementById('divide_submit').style.display = 'none';
									} else {
										// Some but not all are selected
										document.getElementById('next_without_divide').style.display = 'none';
										document.getElementById('divide_submit').style.display = 'block';
									}
								}

								// Attach listener to all checkboxes
								document.querySelectorAll('.pxe').forEach(function(checkbox) {
									checkbox.addEventListener('change', updateButtonVisibility);
								});

								// Run once on page load in case of pre-checked boxes
								updateButtonVisibility();
								</script>
								<?php
                    	}	
                    	if (isset($_POST['divideorder'])) 
						{
								$order_id = $_GET['oid'];
								$case_id = $_GET['cid'];
								$orderid = $_POST['id'];
								$co_orderid = $_POST['co_orderid'] ?? '';
								$productid = $_POST['productid'] ?? '';
								//$order_type = $_POST['order_type'] ?? '';
								$selected_ids = $_POST['pax_ids_for_new_order'] ?? [];
								
								if(empty($selected_ids))
								{
								    $all_pax_query = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
    								$result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));
    								while ($pax = mysqli_fetch_assoc($result_all_pax)) 
    								{
    								    $pax_a_id = $pax['auto_id'];
    								    $selected_ids[] = $pax_a_id;
    								}
								}
								
								$all_pax_query = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
								$result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));
								while ($pax = mysqli_fetch_assoc($result_all_pax)) 
								{
									if (in_array($pax['auto_id'], $selected_ids))
									{
									    $pax_a_id = $pax['auto_id'];
									    $fname = $pax['fname'];
									    $lname = $pax['lname'];
										$dob = $pax['dob'];
										$salutation = $pax['salutation'];
									    
									    $all_pax_query_inner = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE auto_id != '$pax_a_id' and order_id = '$orderid' and salutation = '$salutation' and fname = '$fname' and lname = '$lname' and dob = '$dob'";
								        $result_all_pax_inner = mysqli_query($mysqli, $all_pax_query_inner) or die(" Pax query failed: " . mysqli_error($mysqli));
										if( mysqli_num_rows($result_all_pax_inner) > 0)
										{
								        $pax_inner = mysqli_fetch_assoc($result_all_pax_inner);
								        $inner_a_id = $pax_inner['auto_id'];
								        $selected_ids[] = $inner_a_id;
										}
									}
								}
						        //print_r($selected_ids);
						        $selected_ids = array_unique($selected_ids);	

								// Enable error reporting for mysqli
								mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT);

								// Get new order_id
								$res_max_order = mysqli_query($mysqli, "SELECT MAX(order_id) AS max_order_id FROM wpk4_backend_travel_bookings");
								$max_row = mysqli_fetch_assoc($res_max_order);
								$new_order_id = $max_row['max_order_id'] + 1;
								
								$res_max_order = mysqli_query($mysqli, "SELECT MAX(order_id) AS max_order_id FROM wpk4_backend_travel_bookings");
								$max_row = mysqli_fetch_assoc($res_max_order);
								$divided_order_id = $max_row['max_order_id'] + 2;

								$pax_in_non_divided = 0;
                                $pax_in_divided = 0;
                                $all_pax_query = "SELECT auto_id FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
								$result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));

								while ($pax = mysqli_fetch_assoc($result_all_pax)) {
								    
									if (in_array($pax['auto_id'], $selected_ids)) 
									{
									    $pax_in_divided++;
									}
									
									if (!in_array($pax['auto_id'], $selected_ids)) 
									{
									    $pax_in_non_divided++;
									}
								}
								if ($order_type != 'gds') // GDS
                                {
									if($pax_in_divided > 1)
									{
										$pax_in_divided = $pax_in_divided / 2;
									}
									if($pax_in_non_divided > 1)
									{
										$pax_in_non_divided = $pax_in_non_divided / 2;
									}
								}
								
								if ($order_type == 'gds') // GDS
                                {
									$divided_pax_to_be_paid_total = 0;
									$non_divided_pax_to_be_paid_total = 0;
									
									$all_pax_query_paid_calculator = "SELECT auto_id, pnr, gds_pax_id FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid'";
									$result_all_pax_paid_calculator = mysqli_query($mysqli, $all_pax_query_paid_calculator) or die(" Pax query failed: " . mysqli_error($mysqli));
									while ($pax_paid_calculator = mysqli_fetch_assoc($result_all_pax_paid_calculator)) 
									{
										if (in_array($pax_paid_calculator['auto_id'], $selected_ids)) 
										{
											$pnr_pax_amt = $pax_paid_calculator['pnr'];
											$gds_id_pax_amt = $pax_paid_calculator['gds_pax_id'];
												
											$all_pax_query_fit_amt = "SELECT PriceSell FROM `wpk4_ypsilon_bookings_table_fare` WHERE PaxId = '$gds_id_pax_amt'";
											$result_pax_query_fit_amt = mysqli_query($mysqli, $all_pax_query_fit_amt) or die(" Pax query failed: " . mysqli_error($mysqli));
											$pax_pax_query_fit_amt = mysqli_fetch_assoc($result_pax_query_fit_amt);
											$pax_PriceSell = $pax_pax_query_fit_amt['PriceSell'];
											
											$all_pax_query_fit_amt2 = "SELECT Amount FROM `wpk4_ypsilon_bookings_table_tax` WHERE PaxId = '$gds_id_pax_amt'";
											$result_pax_query_fit_amt2 = mysqli_query($mysqli, $all_pax_query_fit_amt2) or die(" Pax query failed: " . mysqli_error($mysqli));
											$pax_pax_query_fit_amt2 = mysqli_fetch_assoc($result_pax_query_fit_amt2);
											$pax_TaxAmount = $pax_pax_query_fit_amt2['Amount'];
											
											$divided_pax_to_be_paid_total += (float)$pax_PriceSell + (float)$pax_TaxAmount;
										}
										
										if (!in_array($pax_paid_calculator['auto_id'], $selected_ids)) 
										{
											$pnr_pax_amt = $pax_paid_calculator['pnr'];
											$gds_id_pax_amt = $pax_paid_calculator['gds_pax_id'];
												
											$all_pax_query_fit_amt = "SELECT PriceSell FROM `wpk4_ypsilon_bookings_table_fare` WHERE PaxId = '$gds_id_pax_amt'";
											$result_pax_query_fit_amt = mysqli_query($mysqli, $all_pax_query_fit_amt) or die(" Pax query failed: " . mysqli_error($mysqli));
											$pax_pax_query_fit_amt = mysqli_fetch_assoc($result_pax_query_fit_amt);
											$pax_PriceSell = $pax_pax_query_fit_amt['PriceSell'];
											
											$all_pax_query_fit_amt2 = "SELECT Amount FROM `wpk4_ypsilon_bookings_table_tax` WHERE PaxId = '$gds_id_pax_amt'";
											$result_pax_query_fit_amt2 = mysqli_query($mysqli, $all_pax_query_fit_amt2) or die(" Pax query failed: " . mysqli_error($mysqli));
											$pax_pax_query_fit_amt2 = mysqli_fetch_assoc($result_pax_query_fit_amt2);
											$pax_TaxAmount = $pax_pax_query_fit_amt2['Amount'];
											
											$non_divided_pax_to_be_paid_total += (float)$pax_PriceSell + (float)$pax_TaxAmount;
										}
									}
								}
								else
								{
									
									$divided_pax_to_be_paid_total = 0;
									$non_divided_pax_to_be_paid_total = 0;
									
									$all_pax_query_paid_calculator = "SELECT auto_id, trip_price_individual  FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
									$result_all_pax_paid_calculator = mysqli_query($mysqli, $all_pax_query_paid_calculator) or die(" Pax query failed: " . mysqli_error($mysqli));

									while ($pax_paid_calculator = mysqli_fetch_assoc($result_all_pax_paid_calculator)) 
									{
										if (in_array($pax_paid_calculator['auto_id'], $selected_ids)) 
										{
											$divided_pax_to_be_paid_total += $pax_paid_calculator['trip_price_individual'];
										}
										
										if (!in_array($pax_paid_calculator['auto_id'], $selected_ids)) 
										{
											$non_divided_pax_to_be_paid_total += $pax_paid_calculator['trip_price_individual'];
										}
									}
								}	
																
								// Fetch existing bookings
                                $res_booking = mysqli_query($mysqli, "SELECT * FROM wpk4_backend_travel_bookings WHERE order_id = '$order_id'");
                                if (!$res_booking || mysqli_num_rows($res_booking) === 0) {
                                    die(" No booking found for order_id = $order_id");
                                }
                                
                                // Store all booking rows into array
                                $all_booking_rows = [];
                                while ($row = mysqli_fetch_assoc($res_booking)) {
                                    $all_booking_rows[] = $row;
                                }
                                
                                // First loop: insert with new_order_id
                                foreach ($all_booking_rows as $booking_data) {
                                    $booking_data['previous_order_id'] = $order_id;
                                    $booking_data['order_id'] = $new_order_id;
                                    unset($booking_data['auto_id']);
                                
                                    if (empty($booking_data['divided_date'])) unset($booking_data['divided_date']);
                                    if (empty($booking_data['late_modified'])) unset($booking_data['late_modified']);
                                    if (empty($booking_data['airline_ttl_deadline'])) unset($booking_data['airline_ttl_deadline']);
                                    if (empty($booking_data['price_time_limit'])) unset($booking_data['price_time_limit']);
                                    if (empty($booking_data['ticketing_timelimit'])) unset($booking_data['ticketing_timelimit']);
                                    if (empty($booking_data['return_date'])) unset($booking_data['return_date']);
									if (empty($booking_data['family_id'])) unset($booking_data['family_id']);
									if (empty($booking_data['journal_date'])) unset($booking_data['journal_date']);
                                    
									unset($booking_data['payment_modified']);
									$booking_data['source'] = "datechange"; 
									$booking_data['agent_info'] = $currnt_userlogined;
									 
                                    //$booking_data['payment_status'] = "partially_paid";
									//$booking_data['deposit_deadline'] = date("Y-m-d") . ' 23:59:59';
									//$booking_data['full_payment_deadline'] = date("Y-m-d") . ' 23:59:59';
									
									$booking_data['deposit_deadline'] = date("Y-m-d H:i:s", strtotime("+1 day"));
									$booking_data['full_payment_deadline'] = date("Y-m-d H:i:s", strtotime("+1 day"));
                                
                                    $booking_data['total_pax'] = $pax_in_non_divided;
									
									$booking_data['total_amount'] = $non_divided_pax_to_be_paid_total;
									unset($booking_data['balance']);
									
									$booking_data['added_on'] = date("Y-m-d H:i:s");
                                
                                    $columns = array_keys($booking_data);
                                    $values = array_map(function ($val) use ($mysqli) {
                                        if (!empty($val))
											{
												return "'" . mysqli_real_escape_string($mysqli, $val) . "'";
											}
											else
											{
												return "'" . $val . "'";
											}
                                    }, array_values($booking_data));
                                
                                    $insert_booking = "INSERT INTO wpk4_backend_travel_bookings (" . implode(',', $columns) . ") VALUES (" . implode(',', $values) . ")";
                                    if (!mysqli_query($mysqli, $insert_booking)) {
                                        die(" Booking insert failed (new_order_id): " . mysqli_error($mysqli));
                                    }
                                }
                                
                                // Second loop: insert with divided_order_id
                                foreach ($all_booking_rows as $booking_data) {
                                    $booking_data['previous_order_id'] = $order_id;
                                    $booking_data['order_id'] = $divided_order_id;
                                    unset($booking_data['auto_id']);
                                
                                    if (empty($booking_data['divided_date'])) unset($booking_data['divided_date']);
                                    if (empty($booking_data['late_modified'])) unset($booking_data['late_modified']);
                                    if (empty($booking_data['airline_ttl_deadline'])) unset($booking_data['airline_ttl_deadline']);
                                    if (empty($booking_data['price_time_limit'])) unset($booking_data['price_time_limit']);
                                    if (empty($booking_data['ticketing_timelimit'])) unset($booking_data['ticketing_timelimit']);
                                    if (empty($booking_data['return_date'])) unset($booking_data['return_date']);
									if (empty($booking_data['family_id'])) unset($booking_data['family_id']);
									if (empty($booking_data['journal_date'])) unset($booking_data['journal_date']);
									
									unset($booking_data['payment_modified']);
									$booking_data['source'] = "datechange";
                                    $booking_data['payment_status'] = "partially_paid";
									//$booking_data['deposit_deadline'] = date("Y-m-d") . ' 23:59:59';
									//$booking_data['full_payment_deadline'] = date("Y-m-d") . ' 23:59:59';
									
									$booking_data['deposit_deadline'] = date("Y-m-d H:i:s", strtotime("+1 day"));
									$booking_data['full_payment_deadline'] = date("Y-m-d H:i:s", strtotime("+1 day"));
									
									$booking_data['agent_info'] = $currnt_userlogined;
                                
                                    $booking_data['total_pax'] = $pax_in_divided;
									
									$booking_data['total_amount'] = $divided_pax_to_be_paid_total;
									unset($booking_data['balance']);
									$booking_data['added_on'] = date("Y-m-d H:i:s");
                                
                                    $columns = array_keys($booking_data);
                                    $values = array_map(function ($val) use ($mysqli) {
                                        if (!empty($val))
											{
												return "'" . mysqli_real_escape_string($mysqli, $val) . "'";
											}
											else
											{
												return "'" . $val . "'";
											}
                                    }, array_values($booking_data));
                                
                                    $insert_booking = "INSERT INTO wpk4_backend_travel_bookings (" . implode(',', $columns) . ") VALUES (" . implode(',', $values) . ")";
                                    if (!mysqli_query($mysqli, $insert_booking)) {
                                        die(" Booking insert failed (divided_order_id): " . mysqli_error($mysqli));
                                    }
                                }

                                
                                

								// Process unselected passengers
								$all_pax_query = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid'";
                                $result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));
                                
                                // Store all pax in array
                                $all_pax = [];
                                while ($row = mysqli_fetch_assoc($result_all_pax)) {
                                    $all_pax[] = $row;
                                }
                                
                                // Loop 1: for pax NOT in selected_ids  assign to $new_order_id
                                foreach ($all_pax as $pax) {
                                    if (!in_array($pax['auto_id'], $selected_ids)) {
                                        $original_auto_id = $pax['auto_id'];
										$booking_data['previous_order_id'] = $order_id;
                                        $pax['order_id'] = $new_order_id;
                                
                                        unset($pax['auto_id']);
                                        if (empty($pax['trams_profile_id'])) unset($pax['trams_profile_id']);
                                        
										if (empty($pax['customer_id'])) unset($pax['customer_id']);
										

										unset($pax['ticketed_by']);
										unset($pax['ticketed_on']);
										unset($pax['ticketing_audit_on']);
										unset($pax['name_audit_on']);
										unset($pax['ticketing_remarks_on']);
										unset($pax['ticketing_in_progress_on']);
										
										unset($pax['name_update_check']);
										unset($pax['name_update_check_on']);
										$pax['added_on'] = date("Y-m-d H:i:s");
                                
                                        $columns = array_keys($pax);
                                        $values = array_map(function ($val) use ($mysqli) {
                                            if (!empty($val))
											{
												return "'" . mysqli_real_escape_string($mysqli, $val) . "'";
											}
											else
											{
												return "'" . $val . "'";
											}
                                        }, array_values($pax));
                                
                                        $insert_pax = "INSERT INTO wpk4_backend_travel_booking_pax (" . implode(',', $columns) . ") VALUES (" . implode(',', $values) . ")";
                                        if (!mysqli_query($mysqli, $insert_pax)) {
                                            echo " PAX insert failed (new order): " . mysqli_error($mysqli);
                                        }
                                    }
                                }
                                
                                // Loop 2: for pax IN selected_ids  assign to $divided_order_id
                                foreach ($all_pax as $pax2) {
                                    if (in_array($pax2['auto_id'], $selected_ids)) {
                                        $original_auto_id = $pax2['auto_id'];
                                        $pax2['order_id'] = $divided_order_id;
                                
                                        unset($pax2['auto_id']);
                                        if (empty($pax2['trams_profile_id'])) unset($pax2['trams_profile_id']);
										if (empty($pax2['customer_id'])) unset($pax2['customer_id']);
										unset($pax2['ticketed_on']);
										unset($pax2['ticketed_by']);
										unset($pax2['ticket_number']);
										unset($pax2['ticketing_audit_on']);
										unset($pax2['name_audit_on']);
										unset($pax2['ticketing_remarks_on']);
										unset($pax2['ticketing_in_progress_on']);
										
										unset($pax2['name_update_check']);
										unset($pax2['name_update_check_on']);
                                
                                        $columns = array_keys($pax2);
                                        $values = array_map(function ($val) use ($mysqli) {
                                            if (!empty($val))
											{
												return "'" . mysqli_real_escape_string($mysqli, $val) . "'";
											}
											else
											{
												return "'" . $val . "'";
											}
                                        }, array_values($pax2));
                                
                                        $insert_pax2 = "INSERT INTO wpk4_backend_travel_booking_pax (" . implode(',', $columns) . ") VALUES (" . implode(',', $values) . ")";
                                        if (!mysqli_query($mysqli, $insert_pax2)) {
                                            echo " PAX insert failed (divided order): " . mysqli_error($mysqli);
                                        }
                                    }
                                }
                                
                                //echo 'divide booking '.$divided_pax_to_be_paid_total . '</br></br>';
								
								//echo 'non divide booking '.$non_divided_pax_to_be_paid_total. '</br></br>';
								
                                if ($order_type == 'gds') // GDS
                                {
                                    // Step 4: Copy all related history updates
                                    $res_hist = $mysqli->query("SELECT * FROM wpk4_backend_history_of_updates WHERE type_id = '$orderid'");
                                    if (!$res_hist) {
                                        echo "History Error: " . $mysqli->error;
                                        exit;
                                    }
                                
                                    // Store all history rows
                                    $all_hist_rows = [];
                                    while ($row = $res_hist->fetch_assoc()) {
                                        $all_hist_rows[] = $row;
                                    }
                                
                                    // First loop: insert with new_order_id
                                    foreach ($all_hist_rows as $hist) {
                                        $hist['type_id'] = $new_order_id;
                                        unset($hist['auto_id']);
                                
                                        // Remove null or empty values
                                        $hist = array_filter($hist, function($value) {
                                            return $value !== null && $value !== '';
                                        });
                                
                                        $columns = implode(", ", array_keys($hist));
                                        $values = implode("', '", array_map([$mysqli, 'real_escape_string'], array_values($hist)));
                                
                                        $insert_hist = "INSERT INTO wpk4_backend_history_of_updates ($columns) VALUES ('$values')";
                                        if (!$mysqli->query($insert_hist)) {
                                            echo " Error inserting history update (new_order_id): " . $mysqli->error . "<br>Query: $insert_hist";
                                            exit;
                                        }
                                    }
                                
                                    // Second loop: insert with finalco_order_id
                                    foreach ($all_hist_rows as $hist) {
                                        $hist['type_id'] = $divided_order_id;
                                        unset($hist['auto_id']);
                                
                                        // Remove null or empty values
                                        $hist = array_filter($hist, function($value) {
                                            return $value !== null && $value !== '';
                                        });
                                
                                        $columns = implode(", ", array_keys($hist));
                                        $values = implode("', '", array_map([$mysqli, 'real_escape_string'], array_values($hist)));
                                
                                        $insert_hist = "INSERT INTO wpk4_backend_history_of_updates ($columns) VALUES ('$values')";
                                        if (!$mysqli->query($insert_hist)) {
                                            echo " Error inserting history update (finalco_order_id): " . $mysqli->error . "<br>Query: $insert_hist";
                                            exit;
                                        }
                                    }
                                }
								
								$sql_update_past_booking2 ="UPDATE wpk4_backend_travel_bookings
                                                 SET total_amount = '$non_divided_pax_to_be_paid_total', payment_modified = '$current_date_and_time', payment_modified_by = 'customer_portal_dc'
                                                WHERE order_id = '$new_order_id'";
                                $results_update_past_booking2 = $mysqli->query($sql_update_past_booking2);
								
								if ($order_type == 'gds')
								{
									$sql_update_past_booking3 ="UPDATE wpk4_backend_history_of_updates
                                                 SET meta_value = '$non_divided_pax_to_be_paid_total', updated_by = 'DC Amount Change'
                                                WHERE type_id = '$new_order_id' AND meta_key = 'Transaction TotalTurnover'";
									$results_update_past_booking3 = $mysqli->query($sql_update_past_booking3);
									
									$sql_update_past_booking3 ="UPDATE wpk4_backend_history_of_updates
                                                 SET meta_value = '$divided_pax_to_be_paid_total', updated_by = 'DC Amount Change'
                                                WHERE type_id = '$divided_order_id' AND meta_key = 'Transaction TotalTurnover'";
									$results_update_past_booking3 = $mysqli->query($sql_update_past_booking3);
								}
								
								$reduce_past_dc_amount = 0;
								$query_booking_for_dc_history = "select total_amount from wpk4_backend_travel_bookings_datechange_cost_breakdown c 
								where c.order_id = '$orderid'";
								$result_booking_for_dc_history = mysqli_query($mysqli, $query_booking_for_dc_history) or die(" Booking query failed: " . mysqli_error($mysqli));
								if(mysqli_num_rows($result_booking_for_dc_history) > 0 )
								{
									$pax_booking_for_dc_history = mysqli_fetch_assoc($result_booking_for_dc_history); 
									$reduce_past_dc_amount = (float)$pax_booking_for_dc_history['total_amount'];
								}

                                $query_booking_for_payment_history = "SELECT payment_status, total_amount FROM wpk4_backend_travel_bookings WHERE order_id = '$orderid' ";
								$result_booking_for_payment_history = mysqli_query($mysqli, $query_booking_for_payment_history) or die(" Booking query failed: " . mysqli_error($mysqli));
								while ($pax_booking_for_payment_history = mysqli_fetch_assoc($result_booking_for_payment_history)) 
								{
									//echo '</br>In Pay Loop</br>';
									//if($pax_booking_for_payment_history['payment_status'] == 'paid')
									{
										$total_paid_for_booking_transfer = 0.00;
										$processedPayments = array();
										$query_total_paid_for_requestid = "SELECT * FROM wpk4_backend_travel_payment_history where order_id = '$orderid' AND (pay_type = 'deposit' OR pay_type = 'balance' 
														OR pay_type = 'Balance' OR pay_type = 'deposit_adjustment' OR pay_type = 'additional_payment' OR pay_type = 'Refund')";
										$result_total_paid_for_requestid = mysqli_query($mysqli, $query_total_paid_for_requestid);
										while($row_total_paid_for_requestid = mysqli_fetch_assoc($result_total_paid_for_requestid))
										{
											$payment_identifier = $row_total_paid_for_requestid['trams_received_amount'].'^'.$row_total_paid_for_requestid['reference_no']; 
                                    		if (in_array($payment_identifier, $processedPayments)) 
                                    		{
												continue; // Skip to the next value
                                    		}
											$processedPayments[] = $payment_identifier;
											
											$total_paid_for_booking_transfer += (float)$row_total_paid_for_requestid['trams_received_amount'];
										}
										//echo '</br>Total paid . ' . $total_paid_for_booking_transfer .'</br>';
										
										$total_paid_for_booking_transfer = (float)$total_paid_for_booking_transfer - (float)$reduce_past_dc_amount;
										
										//&& $pax_booking_for_payment_history['total_amount'] == $total_paid_for_booking_transfer
										if($total_paid_for_booking_transfer > 0 )
										{
											//echo '</br>In amount check condition</br>';
											$total_balance_after_reduce_non_divided_booking_amount = $total_paid_for_booking_transfer - $non_divided_pax_to_be_paid_total;
											
											// non divide amount transfer
											if( $total_paid_for_booking_transfer >= $non_divided_pax_to_be_paid_total )
											{
												//echo '</br>Inserting transfer 1</br>';
												$total_paid_for_booking_transfer_minus = '-'.$non_divided_pax_to_be_paid_total;
												
												$remark_for_past_booking = 'amount transfered to - '. $new_order_id . ' by Customer Portal DC';
												$remark_for_new_booking = 'amount transfered from - '. $orderid . ' by Customer Portal DC';
												
												mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history (order_id, source, trams_received_amount, reference_no, payment_method, process_date, pay_type, added_on, added_by) 
												values ('$orderid', '$order_type', '$total_paid_for_booking_transfer_minus', '$remark_for_past_booking', '14', '$current_date_and_time', 'deposit_adjustment', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
												
												mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history (order_id, source, trams_received_amount, reference_no, payment_method, process_date, pay_type, added_on, added_by) 
												values ('$new_order_id', '$order_type', '$non_divided_pax_to_be_paid_total', '$remark_for_new_booking', '14', '$current_date_and_time', 'deposit_adjustment', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
											}
											
											//if($total_balance_after_reduce_non_divided_booking_amount <= $divided_pax_to_be_paid_total)
											{
												//echo '</br>Inserting transfer 2</br>';
												$total_paid_for_booking_transfer_minus2 = '-'.$total_balance_after_reduce_non_divided_booking_amount;
												
												$remark_for_past_booking2 = 'amount transfered to - '. $divided_order_id . ' by Customer Portal DC';
												$remark_for_new_booking2 = 'amount transfered from - '. $orderid . ' by Customer Portal DC';
												
												mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history (order_id, source, trams_received_amount, reference_no, payment_method, process_date, pay_type, added_on, added_by) 
												values ('$orderid', '$order_type', '$total_paid_for_booking_transfer_minus2', '$remark_for_past_booking2', '14', '$current_date_and_time', 'deposit_adjustment', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
												
												mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history (order_id, source, trams_received_amount, reference_no, payment_method, process_date, pay_type, added_on, added_by) 
												values ('$divided_order_id', '$order_type', '$total_balance_after_reduce_non_divided_booking_amount', '$remark_for_new_booking2', '14', '$current_date_and_time', 'deposit_adjustment', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
											}
										}
									}
								}
								
								
								//echo '</br>updating status</br>';
                                $sql_update_past_booking ="UPDATE wpk4_backend_travel_bookings
                                                                    SET payment_status = 'voucher_submited', payment_modified = '$current_date_and_time', payment_modified_by = 'customer_portal_dc'
                                                                WHERE order_id = '$orderid'";
                                                                $results_update_past_booking = $wpdb->query($sql_update_past_booking);
                                                                
                                                                if ($results_update_past_booking > 0) 
                                                                {
																	
                                                                    mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
    					                                            values ('$orderid','','','payment_status','Rebooked','$current_date_and_time','$currnt_userlogined')") or die(mysqli_error($mysqli));
                                                                } 

								mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
    					         values ('$orderid','','','DC Initiated','','$current_date_and_time','$currnt_userlogined')") or die(mysqli_error($mysqli));
								//echo $divided_order_id . ' - ' . $new_order_id;
								
								$sql_update = "UPDATE wpk4_backend_user_portal_requests SET change_done = '$divided_order_id', original_order_id='$order_id', reservation_ref='$divided_order_id', change_done_by = '$currnt_userlogined', change_done_on = '$current_date_and_time' WHERE case_id='$case_id'";
								$result_update= mysqli_query($mysqli,$sql_update);

								$finalco_order_id = $co_orderid;
								
								$count_pax_query_1 = "SELECT order_id, fname, lname, dob FROM wpk4_backend_travel_booking_pax WHERE order_id = '$divided_order_id'";
                                $result_count_pax_query_1 = mysqli_query($mysqli, $count_pax_query_1) or die(" Pax query failed: " . mysqli_error($mysqli));
                                $count_pax_array_1 = [];
                                while ($row_count_pax_query_1 = mysqli_fetch_assoc($result_count_pax_query_1)) 
								{
                                    $count_pax_array_1[] = $row_count_pax_query_1['order_id'].$row_count_pax_query_1['fname'].$row_count_pax_query_1['lname'].$row_count_pax_query_1['dob'];
                                }
								$count_pax_array_1 = array_unique($count_pax_array_1);	
								$count_divided_pax = count($count_pax_array_1);

								$sql_update_past_booking ="UPDATE wpk4_backend_travel_bookings
                                        SET total_pax = '$count_divided_pax'
                                        WHERE order_id = '$divided_order_id'";
                                $results_update_past_booking = $mysqli->query($sql_update_past_booking);
								
								
								$count_pax_query_2 = "SELECT order_id, fname, lname, dob FROM wpk4_backend_travel_booking_pax WHERE order_id = '$new_order_id'";
                                $result_count_pax_query_2 = mysqli_query($mysqli, $count_pax_query_2) or die(" Pax query failed: " . mysqli_error($mysqli));
                                $count_pax_array_2 = [];
                                while ($row_count_pax_query_2 = mysqli_fetch_assoc($result_count_pax_query_2)) 
								{
                                    $count_pax_array_2[] = $row_count_pax_query_2['order_id'].$row_count_pax_query_2['fname'].$row_count_pax_query_2['lname'].$row_count_pax_query_2['dob'];
                                }
								$count_pax_array_2 = array_unique($count_pax_array_2);	
								$count_non_divided_pax = count($count_pax_array_2);
								
								$sql_update_past_booking ="UPDATE wpk4_backend_travel_bookings
                                        SET total_pax = '$count_non_divided_pax'
                                        WHERE order_id = '$new_order_id'";
                                $results_update_past_booking = $mysqli->query($sql_update_past_booking);

								if($order_type != 'gds')
								{
									echo "<script>window.location.href='?p=manage-datechange-update-name-v2&part=booking-info-update&oid={$divided_order_id}&coid={$finalco_order_id}&new_oid={$new_order_id}';</script>";
								}
								else
								{
									echo "<script>window.location.href='?p=manage-datechange-update-name-v2&part=booking-info-update&oid={$divided_order_id}&coid={$finalco_order_id}&new_oid={$new_order_id}';</script>";
								}
								exit;
						}
						
						if (isset($_POST['without_divideorder'])) 
						{
							
								$order_id = $_GET['oid'];
								$case_id = $_GET['cid'];
								$orderid = $_POST['id'];
								$co_orderid = $_POST['co_orderid'] ?? '';
								$productid = $_POST['productid'] ?? '';
								//$order_type = $_POST['order_type'] ?? '';
								$selected_ids = $_POST['pax_ids_for_new_order'] ?? [];

								// Enable error reporting for mysqli
								mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT);
								
								if(empty($selected_ids))
								{
								    $all_pax_query = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
    								$result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));
    								while ($pax = mysqli_fetch_assoc($result_all_pax)) 
    								{
    								    $pax_a_id = $pax['auto_id'];
    								    $selected_ids[] = $pax_a_id;
    								}
								}
								
								$all_pax_query = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
								$result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));
								while ($pax = mysqli_fetch_assoc($result_all_pax)) 
								{
									if (in_array($pax['auto_id'], $selected_ids))
									{
									    $pax_a_id = $pax['auto_id'];
									    $fname = $pax['fname'];
									    $lname = $pax['lname'];
										$dob = $pax['dob'];
										$salutation = $pax['salutation'];
									    
									    $all_pax_query_inner = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE auto_id != '$pax_a_id' and order_id = '$orderid' and salutation = '$salutation' and fname = '$fname' and lname = '$lname' and dob = '$dob'";
								        $result_all_pax_inner = mysqli_query($mysqli, $all_pax_query_inner) or die(" Pax query failed: " . mysqli_error($mysqli));
										if( mysqli_num_rows($result_all_pax_inner) > 0)
										{
											$pax_inner = mysqli_fetch_assoc($result_all_pax_inner);
											$inner_a_id = $pax_inner['auto_id'];
											$selected_ids[] = $inner_a_id;
										}
									}
								}
								//print_r($selected_ids);
								
								$selected_ids = array_unique($selected_ids);	

								$res_max_order = mysqli_query($mysqli, "SELECT MAX(order_id) AS max_order_id FROM wpk4_backend_travel_bookings");
								$max_row = mysqli_fetch_assoc($res_max_order);
								$divided_order_id = $max_row['max_order_id'] + 1;

								// Fetch existing booking
								$res_booking = mysqli_query($mysqli, "SELECT * FROM wpk4_backend_travel_bookings WHERE order_id = '$order_id'");
                                if (!$res_booking || mysqli_num_rows($res_booking) === 0) {
                                    die(" No booking found for order_id = $order_id");
                                }

                                while ($booking_data = mysqli_fetch_assoc($res_booking)) {
                                    // Store current order_id as previous
                                    $booking_data['previous_order_id'] = $order_id;
                                
                                    // Remove auto-increment key
                                    unset($booking_data['auto_id']);
                                
                                    // Conditionally unset specific fields
                                    if (empty($booking_data['divided_date'])) unset($booking_data['divided_date']);
                                    if (empty($booking_data['late_modified'])) unset($booking_data['late_modified']);
                                    if (empty($booking_data['airline_ttl_deadline'])) unset($booking_data['airline_ttl_deadline']);
                                    if (empty($booking_data['price_time_limit'])) unset($booking_data['price_time_limit']);
                                    if (empty($booking_data['ticketing_timelimit'])) unset($booking_data['ticketing_timelimit']);
                                    if (empty($booking_data['return_date'])) unset($booking_data['return_date']);
									
									if (empty($booking_data['family_id'])) unset($booking_data['family_id']);
									if (empty($booking_data['journal_date'])) unset($booking_data['journal_date']);
									
									unset($booking_data['payment_modified']);
									$booking_data['source'] = "datechange";
                                    $booking_data['payment_status'] = "partially_paid";
									//$booking_data['deposit_deadline'] = date("Y-m-d") . ' 23:59:59';
									//$booking_data['full_payment_deadline'] = date("Y-m-d") . ' 23:59:59';
									
									$booking_data['deposit_deadline'] = date("Y-m-d H:i:s", strtotime("+1 day"));
									$booking_data['full_payment_deadline'] = date("Y-m-d H:i:s", strtotime("+1 day"));
									$booking_data['agent_info'] = $currnt_userlogined;
									
									$booking_data['added_on'] = date("Y-m-d H:i:s");
                                
                                    // Change to divided_order_id and insert again
                                    $booking_data['order_id'] = $divided_order_id;
                                    
                                    $columns = array_keys($booking_data);
                                    $values = array_map(function ($val) use ($mysqli) {
                                        if (!empty($val))
											{
												return "'" . mysqli_real_escape_string($mysqli, $val) . "'";
											}
											else
											{
												return "'" . $val . "'";
											}
                                    }, array_values($booking_data));
                                
                                    $insert_booking = "INSERT INTO wpk4_backend_travel_bookings (" . implode(',', $columns) . ") VALUES (" . implode(',', $values) . ")";
                                    if (!mysqli_query($mysqli, $insert_booking)) {
                                        die(" Booking insert failed (divided_order_id): " . mysqli_error($mysqli));
                                    }
                                }


								// Process unselected passengers
								$all_pax_query = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
								$result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));

								while ($pax = mysqli_fetch_assoc($result_all_pax)) {
								    
									if (in_array($pax['auto_id'], $selected_ids)) {
										$original_auto_id = $pax['auto_id']; // store before unset
										$pax['order_id'] = $divided_order_id;

										unset($pax['auto_id']);
										if (empty($pax['trams_profile_id'])) unset($pax['trams_profile_id']);
										if (empty($pax['customer_id'])) unset($pax['customer_id']);
										unset($pax['ticket_number']);
										unset($pax['ticketed_by']);
										unset($pax['ticketed_on']);
										unset($pax['ticketing_audit_on']);
										unset($pax['name_audit_on']);
										unset($pax['ticketing_remarks_on']);
										unset($pax['ticketing_in_progress_on']);
										
										unset($pax['name_update_check']);
										unset($pax['name_update_check_on']);

										$columns = array_keys($pax);
										$values = array_map(function ($val) use ($mysqli) {
											if (!empty($val))
											{
												return "'" . mysqli_real_escape_string($mysqli, $val) . "'";
											}
											else
											{
												return "'" . $val . "'";
											}
										}, array_values($pax));

										$insert_pax = "INSERT INTO wpk4_backend_travel_booking_pax (" . implode(',', $columns) . ") VALUES (" . implode(',', $values) . ")";
										if (!mysqli_query($mysqli, $insert_pax)) {
											echo " PAX insert failed: " . mysqli_error($mysqli);
										}
									}
								}
								
								//echo $order_type;
								if ($order_type == 'gds') // GDS
                                {
                                    // Step 4: Copy all related history updates
                                    $res_hist = $mysqli->query("SELECT * FROM wpk4_backend_history_of_updates WHERE type_id = '$orderid'");
                                    if (!$res_hist) {
                                        echo "History Error: " . $mysqli->error;
                                        exit;
                                    }
                                
                                    // Store all history rows
                                    $all_hist_rows = [];
                                    while ($row = $res_hist->fetch_assoc()) {
                                        $all_hist_rows[] = $row;
                                    }
                                    // First loop: insert with new_order_id
                                    foreach ($all_hist_rows as $hist) {
                                        $hist['type_id'] = $divided_order_id;
                                        unset($hist['auto_id']);
                                
                                        // Remove null or empty values
                                        $hist = array_filter($hist, function($value) {
                                            return $value !== null && $value !== '';
                                        });
                                
                                        $columns = implode(", ", array_keys($hist));
                                        $values = implode("', '", array_map([$mysqli, 'real_escape_string'], array_values($hist)));
                                
                                        $insert_hist = "INSERT INTO wpk4_backend_history_of_updates ($columns) VALUES ('$values')";
                                        if (!$mysqli->query($insert_hist)) {
                                            echo " Error inserting history update (new_order_id): " . $mysqli->error . "<br>Query: $insert_hist";
                                            exit;
                                        }
                                    }
                                }

								$is_ticketed = 0;
								$all_pax_query_ticket_finder = "SELECT ticket_number FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' and ticket_number is not null";
								$result_all_pax_ticket_finder = mysqli_query($mysqli, $all_pax_query_ticket_finder) or die(" Pax query failed: " . mysqli_error($mysqli));
								while ($pax_ticket_finder = mysqli_fetch_assoc($result_all_pax_ticket_finder)) 
								{
									if($pax_ticket_finder['ticket_number'] != '')
									{
										$is_ticketed = 1;
										break;
									}
								}
								
								$reduce_past_dc_amount = 0;
								$query_booking_for_dc_history = "select total_amount from wpk4_backend_travel_bookings_datechange_cost_breakdown c 
								where c.order_id = '$orderid'";
								$result_booking_for_dc_history = mysqli_query($mysqli, $query_booking_for_dc_history) or die(" Booking query failed: " . mysqli_error($mysqli));
								if(mysqli_num_rows($result_booking_for_dc_history) > 0 )
								{
									$pax_booking_for_dc_history = mysqli_fetch_assoc($result_booking_for_dc_history); 
									$reduce_past_dc_amount = (float)$pax_booking_for_dc_history['total_amount'];
								}

								
								if($is_ticketed == 0)
								{
									$total_paid_for_booking_transfer = 0.00;
									$processedPayments = array();
									$query_total_paid_for_requestid = "SELECT * FROM wpk4_backend_travel_payment_history where order_id = '$orderid' AND (pay_type = 'deposit' OR pay_type = 'balance' 
													OR pay_type = 'Balance' OR pay_type = 'deposit_adjustment' OR pay_type = 'additional_payment')";
									$result_total_paid_for_requestid = mysqli_query($mysqli, $query_total_paid_for_requestid);
									while($row_total_paid_for_requestid = mysqli_fetch_assoc($result_total_paid_for_requestid))
									{
										$payment_identifier = $row_total_paid_for_requestid['trams_received_amount'].'^'.$row_total_paid_for_requestid['reference_no']; 
                                    		if (in_array($payment_identifier, $processedPayments)) 
                                    		{
												continue; // Skip to the next value
                                    		}
											
										$processedPayments[] = $payment_identifier;
										
										$total_paid_for_booking_transfer += (float)$row_total_paid_for_requestid['trams_received_amount'];
									}
									
									$total_paid_for_booking_transfer = (float)$total_paid_for_booking_transfer - (float)$reduce_past_dc_amount;
									
									if($total_paid_for_booking_transfer > 0) 
									{
										$total_paid_for_booking_transfer_minus = '-'.$total_paid_for_booking_transfer;
										
										$remark_for_past_booking = 'amount transfered to - '. $divided_order_id . ' by Customer Portal DC';
										$remark_for_new_booking = 'amount transfered from - '. $orderid . ' by Customer Portal DC';
										
										mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history (order_id, source, trams_received_amount, reference_no, payment_method, process_date, pay_type, added_on, added_by) 
										values ('$orderid', '$order_type', '$total_paid_for_booking_transfer_minus', '$remark_for_past_booking', '14', '$current_date_and_time', 'deposit_adjustment', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
										
										mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history (order_id, source, trams_received_amount, reference_no, payment_method, process_date, pay_type, added_on, added_by) 
										values ('$divided_order_id', '$order_type', '$total_paid_for_booking_transfer', '$remark_for_new_booking', '14', '$current_date_and_time', 'deposit_adjustment', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
										
									}
								
								}
								
                                $sql_update_past_booking ="UPDATE wpk4_backend_travel_bookings
                                                                    SET payment_status = 'voucher_submited', payment_modified = '$current_date_and_time', payment_modified_by = 'customer_portal_dc'
                                                                WHERE order_id = '$orderid'";
                                                                $results_update_past_booking = $wpdb->query($sql_update_past_booking);
                                                                
                                                                if ($results_update_past_booking > 0) 
                                                                {
																	
                                                                    mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
    					                                            values ('$orderid','','','payment_status','Rebooked','$current_date_and_time','$currnt_userlogined')") or die(mysqli_error($mysqli));
                                                                } 

								mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
    					         values ('$orderid','','','DC Initiated','','$current_date_and_time','$currnt_userlogined')") or die(mysqli_error($mysqli));

								$sql_update = "UPDATE wpk4_backend_user_portal_requests SET change_done = '$divided_order_id', original_order_id='$order_id', reservation_ref='$divided_order_id', change_done_by = '$currnt_userlogined', change_done_on = '$current_date_and_time' WHERE case_id='$case_id'";
								$result_update= mysqli_query($mysqli,$sql_update);

								$finalco_order_id = $co_orderid;

								
								echo "<script>window.location.href='?p=manage-datechange-update-name-v2&part=booking-info-update&oid={$divided_order_id}&coid={$finalco_order_id}&new_oid=';</script>";
								
								
								exit;
						}
					}
											
						if(isset($_GET['p']) && $_GET['p'] =='manage-datechange-update-name-v2' && isset($_GET['part']) && $_GET['part'] == 'booking-info-update')
						{
						    echo '</br></br></br>';
						    $order_id = $_GET['oid'];
							$co_order_id = $_GET['coid'] ?? '';
							$new_order_id = $_GET['new_oid'] ?? '';
							
							
						    
						    $query_pax = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id' ";
							//echo $query_pax;
                    		$result_pax = mysqli_query($mysqli, $query_pax);
                    		?>
							<form action="#" name="statusupdate" method="post" enctype="multipart/form-data" style='font-size:13px;'>
                    		<h6>Order ID : <?php echo $order_id; ?></h6>
							
							Airline Change Fee
                        	<input type='text' name='airline_change_fee' required id='airline_change_fee'></br>
							
							Fare Difference
                        	<input type='text' name='fare_difference' required id='fare_difference'></br>
							
							Gaura Travel Service Fee
                        	<input type='text' name='gaura_service_fee' required id='gaura_service_fee'></br>
							
							Buffer
                        	<input type='text' name='buffer' required id='buffer'></br>
							
							Cost Given / Datechange Amount (Amount to be requested from customer)
                        	<input type='text' name='total_amount' required id='dc_amount'></br>
                    		<?php
                    		if(!empty($result_pax))
                    		{
                    		    ?>
                    		    
                    		    <?php
                    			$row_pax = mysqli_fetch_assoc($result_pax);
                    			{
                    			    //$auto_id = $row_pax['auto_id'];
                    				$order_id = $row_pax['order_id'];
                    				$co_order_id_db = $row_pax['co_order_id'];
                    				$product_id = $row_pax['product_id'];
                    				$order_type = $row_pax['order_type'];
                    				$t_type = $row_pax['t_type'];
                    				$total_pax = $row_pax['total_pax'];
									$previous_order_id_sql = $row_pax['previous_order_id'];
									
									$query_pax_2 = "SELECT pnr FROM wpk4_backend_travel_booking_pax where order_id='$order_id' and product_id = '$product_id' order by auto_id asc ";
									$result_pax_2 = mysqli_query($mysqli, $query_pax_2);
									$row_pax_2 = mysqli_fetch_assoc($result_pax_2);
									$pnr = $row_pax_2['pnr'];
                    				
									$query_pax_5 = "SELECT auto_id, fname, lname, salutation, pnr, product_id, dob FROM wpk4_backend_travel_booking_pax where order_id='$order_id' and product_id = '$product_id' order by auto_id asc ";
									$result_pax_5 = mysqli_query($mysqli, $query_pax_5);
									while($row_pax_5 = mysqli_fetch_assoc($result_pax_5))
									{
										$auto_id = $row_pax_5['auto_id'];
                    				    ?>
                        				    First Name
                        				    <input type='text' name='<?php echo $auto_id; ?>_fname' id='trip_code' value="<?php echo $row_pax_5['fname']; ?>"></br>
                        				    Last Name
                        				    <input type='text' name='<?php echo $auto_id; ?>_lname' value="<?php echo $row_pax_5['lname']; ?>"></br>
                        				    Salutation
											<select name='<?php echo $auto_id; ?>_salutation' style="width:100%; height:36px;">
												<option value="Mr" <?php if(strtolower($row_pax_5['salutation']) == 'mr') { echo 'selected'; } ?>>Mr</option>
												<option value="Mstr" <?php if(strtolower($row_pax_5['salutation']) == 'mstr') { echo 'selected'; } ?>>Mstr</option>
												<option value="Mrs" <?php if(strtolower($row_pax_5['salutation']) == 'mrs') { echo 'selected'; } ?>>Mrs</option>
												<option value="Ms" <?php if(strtolower($row_pax_5['salutation']) == 'ms') { echo 'selected'; } ?>>Ms</option>
												<option value="Miss" <?php if(strtolower($row_pax_5['salutation']) == 'miss') { echo 'selected'; } ?>>Miss</option>
											</select></br></br>
											DOB
											<input type='text' name='<?php echo $auto_id; ?>_dob' value="<?php echo $row_pax_5['dob']; ?>"></br>
                        				    </br></br>
                    				    <?php
									}
                    			}
                    			echo "<input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='submit_gds_changes' value='Next'>
                        		</form>";
                    		}
                    		
                    		if (isset($_POST['submit_gds_changes'])) 
                    		{
								$current_time_modified = date('Y-m-d H:i:s');
								
								$totalAmountRequest = $_POST['total_amount'];
								
								$airline_change_fee = $_POST['airline_change_fee'];
								$fare_difference = $_POST['fare_difference'];
								$gaura_service_fee = $_POST['gaura_service_fee'];
								$buffer = $_POST['buffer'];
								
								$row_case_id = '';
								$query_case_checker = "SELECT case_id FROM wpk4_backend_user_portal_requests WHERE reservation_ref = '$order_id'";
								$result_case_checker = mysqli_query($mysqli, $query_case_checker);	
								if(mysqli_num_rows($result_case_checker) > 0)
								{
									$row_case_checker = mysqli_fetch_assoc($result_case_checker);
									$row_case_id = $row_case_checker['case_id'] ;
								}
								
								
								/*mysqli_query($mysqli,"insert into wpk4_backend_travel_bookings_datechange (order_id, dc_amount, total_amount, added_by, added_on ) 
								values ('$order_id', '$totalAmountRequest', '$totalAmountRequest', 'date_change', '$current_time_modified')") or die(mysqli_error($mysqli));
								
								
								
									
								$update_query5 = "UPDATE wpk4_backend_travel_bookings SET total_amount = '$totalAmountRequest', deposit_amount='0', balance = '$totalAmountRequest' WHERE order_id = '$order_id'";
								//echo $update_query5.'</br>';
                                $result5 = mysqli_query($mysqli, $update_query5);
								*/
								
								
								mysqli_query($mysqli,"insert into wpk4_backend_travel_bookings_datechange_cost_breakdown (case_id, order_id, airline_change_fee, fare_difference, gaura_service_fee, buffer, total_amount, added_by, submit_source ) 
								values ('$row_case_id', '$order_id', '$airline_change_fee', '$fare_difference', '$gaura_service_fee', '$buffer', '$totalAmountRequest', '$currnt_userlogined', 'CS DC Name Update')") or die(mysqli_error($mysqli));
								
								
								$all_pax_query_ticket_finder_booking = "SELECT previous_order_id FROM wpk4_backend_travel_bookings WHERE order_id = '$order_id' ";
								$result_all_pax_ticket_finder_booking = mysqli_query($mysqli, $all_pax_query_ticket_finder_booking) or die(" Pax query failed: " . mysqli_error($mysqli));
								$pax_ticket_finder_booking = mysqli_fetch_assoc($result_all_pax_ticket_finder_booking);
								$previous_order_id_new = $pax_ticket_finder_booking['previous_order_id'];
								
								$all_pax_query_ticket_finder_booking2 = "SELECT order_id, product_id FROM wpk4_backend_travel_bookings WHERE order_id = '$previous_order_id_new' ";
								echo $all_pax_query_ticket_finder_booking2.'</br>';
								$result_all_pax_ticket_finder_booking2 = mysqli_query($mysqli, $all_pax_query_ticket_finder_booking2) or die(" Pax query failed: " . mysqli_error($mysqli));
								$pax_ticket_finder_booking2 = mysqli_fetch_assoc($result_all_pax_ticket_finder_booking2);
								$previous_product_id_new = $pax_ticket_finder_booking2['product_id'];
								
								$is_ticketed = 0;
								$all_pax_query_ticket_finder = "SELECT ticket_number FROM wpk4_backend_travel_booking_pax WHERE order_id = '$previous_order_id_new' ";
								$result_all_pax_ticket_finder = mysqli_query($mysqli, $all_pax_query_ticket_finder) or die(" Pax query failed: " . mysqli_error($mysqli));
								while ($pax_ticket_finder = mysqli_fetch_assoc($result_all_pax_ticket_finder)) 
								{
									if($pax_ticket_finder['ticket_number'] != '')
									{
										$is_ticketed = 1;
										break;
									}
								}	

								$reduce_past_dc_amount = 0;
								$query_booking_for_dc_history = "select total_amount from wpk4_backend_travel_bookings_datechange_cost_breakdown c 
								where c.order_id = '$previous_order_id_new'";
								$result_booking_for_dc_history = mysqli_query($mysqli, $query_booking_for_dc_history) or die(" Booking query failed: " . mysqli_error($mysqli));
								if(mysqli_num_rows($result_booking_for_dc_history) > 0 )
								{
									$pax_booking_for_dc_history = mysqli_fetch_assoc($result_booking_for_dc_history); 
									$reduce_past_dc_amount = (float)$pax_booking_for_dc_history['total_amount'];
								}								
								
								if($totalAmountRequest > 0)
								{
									$total_calculated = $totalAmountRequest;
									if(isset($_GET['new_oid']) && $_GET['new_oid'] != '') // Partial DC
									{
										$query_amt_check = "SELECT total_amount FROM wpk4_backend_travel_bookings where order_id = '$order_id'";
										$result_amt_check = mysqli_query($mysqli, $query_amt_check);
										if(mysqli_num_rows($result_amt_check) > 0 )
										{
											$row_amt_check = mysqli_fetch_assoc($result_amt_check);
											$total_amount_existing = $row_amt_check['total_amount'];
											
											$total_amount_existing = (float)$total_amount_existing - (float)$reduce_past_dc_amount;
											
											$total_calculated = (float)$totalAmountRequest + (float)$total_amount_existing;
											$total_calculated = number_format((float)$total_calculated, 2, '.', '') ;
										}
										
										$query_amt_check2 = "SELECT meta_value FROM wpk4_backend_history_of_updates where type_id = '$order_id' and meta_key = 'Transaction TotalTurnover'";
										$result_amt_check2 = mysqli_query($mysqli, $query_amt_check2);
										if(mysqli_num_rows($result_amt_check2) > 0 )
										{
											$row_amt_check2 = mysqli_fetch_assoc($result_amt_check2);
											$total_amount_existing = $row_amt_check2['meta_value'];
											
											$total_amount_existing = (float)$total_amount_existing - (float)$reduce_past_dc_amount;
											
											$total_calculated = (float)$totalAmountRequest + (float)$total_amount_existing;
											$total_calculated = number_format((float)$total_calculated, 2, '.', '') ;
											
										}
										
										
									}
									else
									{
										if($is_ticketed == 0) // no ticket issued
										{
											$query_amt_check = "SELECT total_amount FROM wpk4_backend_travel_bookings where order_id = '$order_id'";
											$result_amt_check = mysqli_query($mysqli, $query_amt_check);
											if(mysqli_num_rows($result_amt_check) > 0 )
											{
												$row_amt_check = mysqli_fetch_assoc($result_amt_check);
												$total_amount_existing = $row_amt_check['total_amount'];
												
												$total_amount_existing = (float)$total_amount_existing - (float)$reduce_past_dc_amount;
												
												$total_calculated = (float)$totalAmountRequest + (float)$total_amount_existing;
												$total_calculated = number_format((float)$total_calculated, 2, '.', '') ;
											}
											
											$query_amt_check2 = "SELECT meta_value FROM wpk4_backend_history_of_updates where type_id = '$order_id' and meta_key = 'Transaction TotalTurnover'";
											$result_amt_check2 = mysqli_query($mysqli, $query_amt_check2);
											if(mysqli_num_rows($result_amt_check2) > 0 )
											{
												$row_amt_check2 = mysqli_fetch_assoc($result_amt_check2);
												$total_amount_existing = $row_amt_check2['meta_value'];
												
												$total_amount_existing = (float)$total_amount_existing - (float)$reduce_past_dc_amount;
												
												$total_calculated = (float)$totalAmountRequest + (float)$total_amount_existing;
												$total_calculated = number_format((float)$total_calculated, 2, '.', '') ;
												
											}
										}
										else 
										{
											$total_calculated = $totalAmountRequest;
										}
									}
									
																		
									$update_query5 = "UPDATE wpk4_backend_travel_bookings SET total_amount = '$total_calculated', deposit_amount='0', balance = '0' WHERE order_id = '$order_id'";
									//echo $update_query5.'</br>';
									$result5 = mysqli_query($mysqli, $update_query5);
									
									$update_query_turnover = "UPDATE wpk4_backend_history_of_updates SET meta_value = '$total_calculated' WHERE type_id = '$order_id' and meta_key = 'Transaction TotalTurnover'";
									$result_turnover = mysqli_query($mysqli, $update_query_turnover);
									
									$update_query_amt = "UPDATE wpk4_backend_history_of_updates SET meta_value = '$total_calculated' WHERE type_id = '$order_id' and meta_key = 'Payments Amount'";
									$result_amt = mysqli_query($mysqli, $update_query_amt);
									
									mysqli_query($mysqli,"insert into wpk4_backend_travel_bookings_datechange (order_id, dc_amount, total_amount, added_by, added_on ) 
									values ('$order_id', '$totalAmountRequest', '$total_calculated', 'date_change', '$current_date_and_time')") or die(mysqli_error($mysqli));
									
									
									//mysqli_query($mysqli,"insert into wpk4_backend_travel_bookings_datechange (order_id, dc_amount, total_amount, added_by, added_on ) 
									//values ('$order_id', '$dc_amount', '$total_amount_dc', 'date_change', '$current_date_and_time')") or die(mysqli_error($mysqli));
									
									//$update_query5 = "UPDATE wpk4_backend_travel_bookings SET total_amount = '$dc_amount', deposit_amount='0', balance = '$dc_amount' WHERE order_id = '$order_id'";
									//echo $update_query5.'</br>';
									//$result5 = mysqli_query($mysqli, $update_query5);
								}
								
								
								
								
								
									
								$query_2_checker = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id'";
								$result_2_checker = mysqli_query($mysqli, $query_2_checker);
								$is_updatedf = 0;
								while($row_2_checker = mysqli_fetch_assoc($result_2_checker))
								{
									$row_auto_id_pax = $row_2_checker['auto_id'];
									
									foreach($row_2_checker as $columnname_db => $db_value)
									{
										$dbcolumn_and_postname_checker = $row_auto_id_pax.'_'.$columnname_db;
										foreach ($_POST as $post_fieldname => $post_fieldvalue) 
										{
											echo $post_fieldname . ' ' . $db_value . ' ' . $dbcolumn_and_postname_checker . ' ' . $post_fieldvalue .'</br>';
											if($post_fieldname == $dbcolumn_and_postname_checker && $db_value != $post_fieldvalue)
											{
												echo 'updating value </br>';
												
												$is_updatedf = 1;
												$query_4_pp_selecter = "SELECT * FROM wpk4_backend_travel_booking_pax where auto_id = '$row_auto_id_pax' ";
												$result_4_pp_selecter = mysqli_query($mysqli, $query_4_pp_selecter);
												$row_4_pp_selecter = mysqli_fetch_assoc($result_4_pp_selecter);
												$cus_fname = $row_4_pp_selecter['fname'];
												$cus_lname = $row_4_pp_selecter['lname'];
												$cus_dob = $row_4_pp_selecter['dob'];
												
						
												$sql_update_pax = "UPDATE wpk4_backend_travel_booking_pax SET $columnname_db='$post_fieldvalue' WHERE order_id='$order_id' AND fname = '$cus_fname' AND lname = '$cus_lname' AND dob = '$cus_dob'";
												$resultpax= mysqli_query($mysqli,$sql_update_pax);
												
												mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
												values ('$order_id','','$row_auto_id_pax','$columnname_db','$post_fieldvalue','$current_time_modified','$currnt_userlogined')") or die(mysqli_error($mysqli));
											

											}
										}
									}
									if($is_updatedf==1)
									{
										$sql_update_pax2 = "UPDATE wpk4_backend_travel_booking_pax SET late_modified='$current_time_modified',modified_by = '$currnt_userlogined' WHERE auto_id='$row_auto_id_pax'";
										$resultpax2= mysqli_query($mysqli,$sql_update_pax2);
										
									}
								}
								  
                                   echo '<script>window.location.href="?p=manage-datechange-update-name-v2&part=generate-payment-link&oid='.$order_id.'&coid='.$co_order_id.'&new_oid='.$new_order_id.'";</script>';
								
                            }
						}
						
						if(isset($_GET['p']) && $_GET['p'] =='manage-datechange-update-name-v2' && isset($_GET['part']) && $_GET['part'] == 'generate-payment-link')
						{
						    echo '</br></br></br>';
						    $order_id = $_GET['oid'];
							$co_order_id = $_GET['coid'] ?? '';
						    ?>
							<center>
							<h5>Date change process is done.</h5>
							<h5>Please instruct customer to make their balance payment through Customer Portal.</h5>
							</br></br>
							<h3>Datechange Order ID: <?php echo $order_id; ?></h3>
							</center>
							<?php
							$query_booking_check = "SELECT trip_code, travel_date, total_pax, product_id FROM wpk4_backend_travel_bookings where order_id = $order_id";
							$result_booking_check = mysqli_query($mysqli, $query_booking_check);
							if(mysqli_num_rows($result_booking_check) > 0 )
                            {
                                while($row_bookings = mysqli_fetch_assoc($result_booking_check))
                                {
                                    $product_id = $row_bookings['product_id'];
                                    echo '</br><h5>'.$row_bookings['trip_code'] . ' - ' . date("d/m/Y", strtotime( $row_bookings['travel_date'] )) . '</h5>';
                                    
                                    $query_pax_check = "SELECT fname, lname, dob FROM wpk4_backend_travel_booking_pax where order_id = $order_id and product_id = '$product_id'";
        							$result_pax_check = mysqli_query($mysqli, $query_pax_check) or die("Pax query failed: " . mysqli_error($mysqli));
        							if(mysqli_num_rows($result_pax_check) > 0 )
                                    {
                                        echo '<table class="table table-striped" style="width:100%; margin:auto;font-size:14px; margin-top:35px;"><tr>
                                            <th>Pax Name</th>
                                            <th>DOB</th>
                                            </tr>';
                                        while($row_pax = mysqli_fetch_assoc($result_pax_check))
                                        {
                                            echo '<tr>
                                                    <td style="height:40px;">'.$row_pax['fname'] . ' ' . $row_pax['lname'] .'</td>
                                                    <td style="height:40px;">'.$row_pax['dob'].'</td>
                                                </tr>';
                                        }
                                    }
                                    
                                    echo '</table>';
                                }
                            }
							?>
                            </br></br>
							<?php
							if(isset($_GET['new_oid']) && $_GET['new_oid'] != '')
							{
							    $new_order_id = $_GET['new_oid'];
								?>
								<center>
								<h3>Non Datechange Order ID: <?php echo $_GET['new_oid']; ?></h3>
								</center>
								<?php
								
								$query_booking_check = "SELECT trip_code, travel_date, total_pax, product_id FROM wpk4_backend_travel_bookings where order_id = $new_order_id";
    							$result_booking_check = mysqli_query($mysqli, $query_booking_check);
    							if(mysqli_num_rows($result_booking_check) > 0 )
                                {
                                    while($row_bookings = mysqli_fetch_assoc($result_booking_check))
                                    {
                                        $product_id = $row_bookings['product_id'];
                                        echo '</br><h5>'.$row_bookings['trip_code'] . ' - ' . date("d/m/Y", strtotime( $row_bookings['travel_date'] )) . '</h5>';
                                        $query_pax_check = "SELECT fname, lname, dob FROM wpk4_backend_travel_booking_pax where order_id = $new_order_id and product_id = '$product_id'";
            							$result_pax_check = mysqli_query($mysqli, $query_pax_check) or die("Pax query failed: " . mysqli_error($mysqli));
            							if(mysqli_num_rows($result_pax_check) > 0 )
                                        {
                                            echo '<table class="table table-striped" style="width:100%; margin:auto;font-size:14px; margin-top:35px;"><tr>
                                                <th>Pax Name</th>
                                                <th>DOB</th>
                                                </tr>';
                                            while($row_pax = mysqli_fetch_assoc($result_pax_check))
                                            {
                                                echo '<tr>
                                                        <td style="height:40px;">'.$row_pax['fname'] . ' ' . $row_pax['lname'] .'</td>
                                                        <td style="height:40px;">'.$row_pax['dob'].'</td>
                                                    </tr>';
                                            }
                                        }
                                        
                                        echo '</table>';
                                    }
                                }
							}
						}
							
						
						
						
						
						
					
					
						
							if(isset($_GET['p']) && $_GET['p'] =='manage-datechange-v1' && !isset($_GET['part']))
					{
						echo '</br></br></br>';
						    $order_id = $_GET['oid'];
													    
                    		$query_pax = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id' order by travel_date asc limit 1;";
                    		$result_pax = mysqli_query($mysqli, $query_pax);
                    		?>
                    		<h6>Order ID : <?php echo $order_id; ?></h6>
                    		<?php
                    		if(!empty($result_pax))
                    		{
                    			while($row_pax = mysqli_fetch_assoc($result_pax))
                    			{
                    			?>
                    				<form action="#" name="statusupdate" id="divideForm" method="post" enctype="multipart/form-data" style='font-size:13px;'>
                    				    <table class="table table-striped" style="width:100%;"><thead><tr><th width='10%'>Check</th><th>Name</th><th>Passport</th><th>DOB</th></tr></thead><tbody>
                    				<?php
                    				$order_id = $row_pax['order_id'];
                    				$co_order_id_db = $row_pax['co_order_id'];
                    				$product_id = $row_pax['product_id'];
                    				$order_type = $row_pax['order_type'];
                    				
									echo '<input type="hidden" name="id" id="teammembers_status" value="'.$order_id.'">';
									echo '<input type="hidden" name="co_orderid" id="teammembers_status" value="'.$co_order_id_db.'">';
									echo '<input type="hidden" name="productid" id="teammembers_status" value="'.$product_id.'">';
									echo '<input type="hidden" name="order_type" id="teammembers_status" value="'.$order_type.'">';
									
                    				if($order_type != 'gds') // wpt
                    				{
                    				    $query_paxc = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id' and co_order_id = '$co_order_id_db' AND product_id = '$product_id' ";
                        				$result_paxc = mysqli_query($mysqli, $query_paxc);
                        				$row_pax_count = mysqli_num_rows($result_paxc);
                        				while($row_paxc = mysqli_fetch_assoc($result_paxc))
                        				{
                        					$salutation = $row_paxc['salutation']; 
                        					$fname = $row_paxc['fname']; 
                        					$lname = $row_paxc['lname']; 
                        					$ppn = $row_paxc['ppn']; 
                        					$dob = $row_paxc['dob']; 
                        					$auto_id = $row_paxc['auto_id'];
                        					?>
                        					<tr><td>
                        					<?php
                        					if($row_pax_count > 1)
                        					{
                        					?>
                        						<input type="checkbox" checked id="pxe" name="pax_ids_for_new_order[]" class="pxe" value="<?php echo $auto_id; ?>">
                        					<?php
                        					}
                        					else
                        					{
                        					
                        					}
                        					?>
                        					</td><td><?php echo $salutation; ?> <?php echo $fname; ?> <?php echo $lname; ?></td><td><?php echo $ppn; ?></td><td><?php echo $dob; ?></td></tr>
                        				<?php
                        				}
                    				}
                    				else // gds
                    				{
                    				    $query_paxc = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id' and co_order_id = '$co_order_id_db' ";
                        				$result_paxc = mysqli_query($mysqli, $query_paxc);
                        				$row_pax_count = mysqli_num_rows($result_paxc);
                        				while($row_paxc = mysqli_fetch_assoc($result_paxc))
                        				{
                        					$salutation = $row_paxc['salutation']; 
                        					$fname = $row_paxc['fname']; 
                        					$lname = $row_paxc['lname']; 
                        					$ppn = $row_paxc['ppn']; 
                        					$dob = $row_paxc['dob']; 
                        					$auto_id = $row_paxc['auto_id'];
                        					?>
                        					<tr><td>
                        					<?php
                        					if($row_pax_count > 1)
                        					{
                        					?>
                        						<input type="checkbox" checked id="pxe" name="pax_ids_for_new_order[]" class="pxe"  value="<?php echo $auto_id; ?>">
                        					<?php
                        					}
                        					
                        					?>
                        					</td><td><?php echo $salutation; ?> <?php echo $fname; ?> <?php echo $lname; ?></td><td><?php echo $ppn; ?></td><td><?php echo $dob; ?></td></tr>
                        				<?php
                        				}
                    				}
                    				?>
                    				<tr><td colspan='4'></td></tr></tbody>
                    				</table>
                    			<?php
                    			}
								?>
								<div id="divide_submit" style="display:none;">
									<input type="submit" style="padding:15px; margin:0; font-size:11px;" name="divideorder" value="Divide & Next">
								</div>
								<div id="next_without_divide" >
									<input type="submit" style="padding:15px; margin:0; font-size:11px;" name="without_divideorder" value="Clone & Next">
								</div>
								</form>
								<script>
                                document.getElementById('divideForm').addEventListener('submit', function (e) {
                                    // Identify which submit button was clicked
                                    const clickedButton = document.activeElement;
                                
                                    // Only show confirmation for divide or clone actions
                                    if (
                                        clickedButton &&
                                        (clickedButton.name === 'divideorder' || clickedButton.name === 'without_divideorder')
                                    ) {
                                        const confirmMsg = "Do you want to continue with the passenger(s) selected?";
                                        if (!confirm(confirmMsg)) {
                                            e.preventDefault(); // Stop the form from submitting
                                        }
                                    }
                                });
                                </script>
								<script>
								function updateButtonVisibility() {
									const checkboxes = Array.from(document.querySelectorAll('.pxe'));
									const total = checkboxes.length;
									const checkedCount = checkboxes.filter(cb => cb.checked).length;

									if (checkedCount === 0 || checkedCount === total) {
										// All or none are selected
										document.getElementById('next_without_divide').style.display = 'block';
										document.getElementById('divide_submit').style.display = 'none';
									} else {
										// Some but not all are selected
										document.getElementById('next_without_divide').style.display = 'none';
										document.getElementById('divide_submit').style.display = 'block';
									}
								}

								// Attach listener to all checkboxes
								document.querySelectorAll('.pxe').forEach(function(checkbox) {
									checkbox.addEventListener('change', updateButtonVisibility);
								});

								// Run once on page load in case of pre-checked boxes
								updateButtonVisibility();
								</script>
								<?php
                    	}	
                    	if (isset($_POST['divideorder'])) 
						{
								$order_id = $_GET['oid'];
								$case_id = $_GET['cid'];
								$orderid = $_POST['id'];
								$co_orderid = $_POST['co_orderid'] ?? '';
								$productid = $_POST['productid'] ?? '';
								//$order_type = $_POST['order_type'] ?? '';
								$selected_ids = $_POST['pax_ids_for_new_order'] ?? [];
								
								if(empty($selected_ids))
								{
								    $all_pax_query = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
    								$result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));
    								while ($pax = mysqli_fetch_assoc($result_all_pax)) 
    								{
    								    $pax_a_id = $pax['auto_id'];
    								    $selected_ids[] = $pax_a_id;
    								}
								}
								
								$all_pax_query = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
								$result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));
								while ($pax = mysqli_fetch_assoc($result_all_pax)) 
								{
									if (in_array($pax['auto_id'], $selected_ids))
									{
									    $pax_a_id = $pax['auto_id'];
									    $fname = $pax['fname'];
									    $lname = $pax['lname'];
										$dob = $pax['dob'];
										$salutation = $pax['salutation'];
									    
									    $all_pax_query_inner = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE auto_id != '$pax_a_id' and order_id = '$orderid' and salutation = '$salutation' and fname = '$fname' and lname = '$lname' and dob = '$dob'";
								        $result_all_pax_inner = mysqli_query($mysqli, $all_pax_query_inner) or die(" Pax query failed: " . mysqli_error($mysqli));
										if(mysqli_num_rows($result_all_pax_inner) > 0)
										{
											$pax_inner = mysqli_fetch_assoc($result_all_pax_inner);
											$inner_a_id = $pax_inner['auto_id'];
											$selected_ids[] = $inner_a_id;
										}
									}
								}
								

						        //print_r($selected_ids);
						        $selected_ids = array_unique($selected_ids);	

								// Enable error reporting for mysqli
								mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT);

								// Get new order_id
								$res_max_order = mysqli_query($mysqli, "SELECT MAX(order_id) AS max_order_id FROM wpk4_backend_travel_bookings");
								$max_row = mysqli_fetch_assoc($res_max_order);
								$new_order_id = $max_row['max_order_id'] + 1;
								
								$res_max_order = mysqli_query($mysqli, "SELECT MAX(order_id) AS max_order_id FROM wpk4_backend_travel_bookings");
								$max_row = mysqli_fetch_assoc($res_max_order);
								$divided_order_id = $max_row['max_order_id'] + 2;

								$pax_in_non_divided = 0;
                                $pax_in_divided = 0;
                                $all_pax_query = "SELECT auto_id FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
								$result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));

								while ($pax = mysqli_fetch_assoc($result_all_pax)) {
								    
									if (in_array($pax['auto_id'], $selected_ids)) 
									{
									    $pax_in_divided++;
									}
									
									if (!in_array($pax['auto_id'], $selected_ids)) 
									{
									    $pax_in_non_divided++;
									}
								}
								
								if ($order_type != 'gds') // NOT GDS
                                {
									if($pax_in_divided > 1)
									{
										$pax_in_divided = $pax_in_divided / 2;
									}
									if($pax_in_non_divided > 1)
									{
										$pax_in_non_divided = $pax_in_non_divided / 2;
									}
								}
								
								if ($order_type == 'gds') // GDS
                                {
									$divided_pax_to_be_paid_total = 0;
									$non_divided_pax_to_be_paid_total = 0;
									
									$all_pax_query_paid_calculator = "SELECT auto_id, pnr, gds_pax_id FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid'";
									$result_all_pax_paid_calculator = mysqli_query($mysqli, $all_pax_query_paid_calculator) or die(" Pax query failed: " . mysqli_error($mysqli));
									while ($pax_paid_calculator = mysqli_fetch_assoc($result_all_pax_paid_calculator)) 
									{
										if (in_array($pax_paid_calculator['auto_id'], $selected_ids)) 
										{
											$pnr_pax_amt = $pax_paid_calculator['pnr'];
											$gds_id_pax_amt = $pax_paid_calculator['gds_pax_id'];
												
											$all_pax_query_fit_amt = "SELECT PriceSell FROM `wpk4_ypsilon_bookings_table_fare` WHERE PaxId = '$gds_id_pax_amt'";
											$result_pax_query_fit_amt = mysqli_query($mysqli, $all_pax_query_fit_amt) or die(" Pax query failed: " . mysqli_error($mysqli));
											$pax_pax_query_fit_amt = mysqli_fetch_assoc($result_pax_query_fit_amt);
											$pax_PriceSell = $pax_pax_query_fit_amt['PriceSell'];
											
											$all_pax_query_fit_amt2 = "SELECT Amount FROM `wpk4_ypsilon_bookings_table_tax` WHERE PaxId = '$gds_id_pax_amt'";
											$result_pax_query_fit_amt2 = mysqli_query($mysqli, $all_pax_query_fit_amt2) or die(" Pax query failed: " . mysqli_error($mysqli));
											$pax_pax_query_fit_amt2 = mysqli_fetch_assoc($result_pax_query_fit_amt2);
											$pax_TaxAmount = $pax_pax_query_fit_amt2['Amount'];
											
											$divided_pax_to_be_paid_total += (float)$pax_PriceSell + (float)$pax_TaxAmount;
										}
										
										if (!in_array($pax_paid_calculator['auto_id'], $selected_ids)) 
										{
											$pnr_pax_amt = $pax_paid_calculator['pnr'];
											$gds_id_pax_amt = $pax_paid_calculator['gds_pax_id'];
												
											$all_pax_query_fit_amt = "SELECT PriceSell FROM `wpk4_ypsilon_bookings_table_fare` WHERE PaxId = '$gds_id_pax_amt'";
											$result_pax_query_fit_amt = mysqli_query($mysqli, $all_pax_query_fit_amt) or die(" Pax query failed: " . mysqli_error($mysqli));
											$pax_pax_query_fit_amt = mysqli_fetch_assoc($result_pax_query_fit_amt);
											$pax_PriceSell = $pax_pax_query_fit_amt['PriceSell'];
											
											$all_pax_query_fit_amt2 = "SELECT Amount FROM `wpk4_ypsilon_bookings_table_tax` WHERE PaxId = '$gds_id_pax_amt'";
											$result_pax_query_fit_amt2 = mysqli_query($mysqli, $all_pax_query_fit_amt2) or die(" Pax query failed: " . mysqli_error($mysqli));
											$pax_pax_query_fit_amt2 = mysqli_fetch_assoc($result_pax_query_fit_amt2);
											$pax_TaxAmount = $pax_pax_query_fit_amt2['Amount'];
											
											$non_divided_pax_to_be_paid_total += (float)$pax_PriceSell + (float)$pax_TaxAmount;
										}
									}
								}
								else
								{
									
									$divided_pax_to_be_paid_total = 0;
									$non_divided_pax_to_be_paid_total = 0;
									
									$all_pax_query_paid_calculator = "SELECT auto_id, trip_price_individual  FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
									$result_all_pax_paid_calculator = mysqli_query($mysqli, $all_pax_query_paid_calculator) or die(" Pax query failed: " . mysqli_error($mysqli));

									while ($pax_paid_calculator = mysqli_fetch_assoc($result_all_pax_paid_calculator)) 
									{
										if (in_array($pax_paid_calculator['auto_id'], $selected_ids)) 
										{
											$divided_pax_to_be_paid_total += $pax_paid_calculator['trip_price_individual'];
										}
										
										if (!in_array($pax_paid_calculator['auto_id'], $selected_ids)) 
										{
											$non_divided_pax_to_be_paid_total += $pax_paid_calculator['trip_price_individual'];
										}
									}
								}	
																
								// Fetch existing bookings
                                $res_booking = mysqli_query($mysqli, "SELECT * FROM wpk4_backend_travel_bookings WHERE order_id = '$order_id'");
                                if (!$res_booking || mysqli_num_rows($res_booking) === 0) {
                                    die(" No booking found for order_id = $order_id");
                                }
                                
                                // Store all booking rows into array
                                $all_booking_rows = [];
                                while ($row = mysqli_fetch_assoc($res_booking)) {
                                    $all_booking_rows[] = $row;
                                }
                                
                                // First loop: insert with new_order_id
                                foreach ($all_booking_rows as $booking_data) {
                                    $booking_data['previous_order_id'] = $order_id;
                                    $booking_data['order_id'] = $new_order_id;
                                    unset($booking_data['auto_id']);
                                
                                    if (empty($booking_data['divided_date'])) unset($booking_data['divided_date']);
                                    if (empty($booking_data['late_modified'])) unset($booking_data['late_modified']);
                                    if (empty($booking_data['airline_ttl_deadline'])) unset($booking_data['airline_ttl_deadline']);
                                    if (empty($booking_data['price_time_limit'])) unset($booking_data['price_time_limit']);
                                    if (empty($booking_data['ticketing_timelimit'])) unset($booking_data['ticketing_timelimit']);
                                    if (empty($booking_data['return_date'])) unset($booking_data['return_date']);
									if (empty($booking_data['family_id'])) unset($booking_data['family_id']);
									if (empty($booking_data['journal_date'])) unset($booking_data['journal_date']);
                                    
									unset($booking_data['payment_modified']);
									$booking_data['source'] = "datechange"; 
									$booking_data['agent_info'] = $currnt_userlogined;
									 
                                    //$booking_data['payment_status'] = "partially_paid";
									//$booking_data['deposit_deadline'] = date("Y-m-d") . ' 23:59:59';
									//$booking_data['full_payment_deadline'] = date("Y-m-d") . ' 23:59:59';
									$booking_data['deposit_deadline'] = date("Y-m-d H:i:s", strtotime("+1 day"));
									$booking_data['full_payment_deadline'] = date("Y-m-d H:i:s", strtotime("+1 day"));

                                
                                    $booking_data['total_pax'] = $pax_in_non_divided;
									
									$booking_data['total_amount'] = $non_divided_pax_to_be_paid_total;
									unset($booking_data['balance']);
									
									$booking_data['added_on'] = date("Y-m-d H:i:s");
                                
                                    $columns = array_keys($booking_data);
                                    $values = array_map(function ($val) use ($mysqli) {
                                        if (!empty($val))
											{
												return "'" . mysqli_real_escape_string($mysqli, $val) . "'";
											}
											else
											{
												return "'" . $val . "'";
											}
                                    }, array_values($booking_data));
                                
                                    $insert_booking = "INSERT INTO wpk4_backend_travel_bookings (" . implode(',', $columns) . ") VALUES (" . implode(',', $values) . ")";
                                    if (!mysqli_query($mysqli, $insert_booking)) {
                                        die(" Booking insert failed (new_order_id): " . mysqli_error($mysqli));
                                    }
                                }
                                
                                // Second loop: insert with divided_order_id
                                foreach ($all_booking_rows as $booking_data) {
                                    $booking_data['previous_order_id'] = $order_id;
                                    $booking_data['order_id'] = $divided_order_id;
                                    unset($booking_data['auto_id']);
                                
                                    if (empty($booking_data['divided_date'])) unset($booking_data['divided_date']);
                                    if (empty($booking_data['late_modified'])) unset($booking_data['late_modified']);
                                    if (empty($booking_data['airline_ttl_deadline'])) unset($booking_data['airline_ttl_deadline']);
                                    if (empty($booking_data['price_time_limit'])) unset($booking_data['price_time_limit']);
                                    if (empty($booking_data['ticketing_timelimit'])) unset($booking_data['ticketing_timelimit']);
                                    if (empty($booking_data['return_date'])) unset($booking_data['return_date']);
									if (empty($booking_data['family_id'])) unset($booking_data['family_id']);
									if (empty($booking_data['journal_date'])) unset($booking_data['journal_date']);
									
									unset($booking_data['payment_modified']);
									$booking_data['source'] = "datechange";
                                    $booking_data['payment_status'] = "partially_paid";
									//$booking_data['deposit_deadline'] = date("Y-m-d") . ' 23:59:59';
									//$booking_data['full_payment_deadline'] = date("Y-m-d") . ' 23:59:59';
									
									$booking_data['deposit_deadline'] = date("Y-m-d H:i:s", strtotime("+1 day"));
									$booking_data['full_payment_deadline'] = date("Y-m-d H:i:s", strtotime("+1 day"));
									
									$booking_data['agent_info'] = $currnt_userlogined;
                                
                                    $booking_data['total_pax'] = $pax_in_divided;
									
									$booking_data['total_amount'] = $divided_pax_to_be_paid_total;
									unset($booking_data['balance']);
									$booking_data['added_on'] = date("Y-m-d H:i:s");
                                
                                    $columns = array_keys($booking_data);
                                    $values = array_map(function ($val) use ($mysqli) {
                                        if (!empty($val))
											{
												return "'" . mysqli_real_escape_string($mysqli, $val) . "'";
											}
											else
											{
												return "'" . $val . "'";
											}
                                    }, array_values($booking_data));
                                
                                    $insert_booking = "INSERT INTO wpk4_backend_travel_bookings (" . implode(',', $columns) . ") VALUES (" . implode(',', $values) . ")";
                                    if (!mysqli_query($mysqli, $insert_booking)) {
                                        die(" Booking insert failed (divided_order_id): " . mysqli_error($mysqli));
                                    }
                                }

                                
                                

								// Process unselected passengers
								$all_pax_query = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid'";
                                $result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));
                                
                                // Store all pax in array
                                $all_pax = [];
                                while ($row = mysqli_fetch_assoc($result_all_pax)) {
                                    $all_pax[] = $row;
                                }
                                
                                // Loop 1: for pax NOT in selected_ids  assign to $new_order_id
                                foreach ($all_pax as $pax) {
                                    if (!in_array($pax['auto_id'], $selected_ids)) {
                                        $original_auto_id = $pax['auto_id'];
										$booking_data['previous_order_id'] = $order_id;
                                        $pax['order_id'] = $new_order_id;
                                
                                        unset($pax['auto_id']);
                                        if (empty($pax['trams_profile_id'])) unset($pax['trams_profile_id']);
                                        
										if (empty($pax['customer_id'])) unset($pax['customer_id']);
										
										unset($pax['ticketed_on']);
										unset($pax['ticketing_audit_on']);
										unset($pax['name_audit_on']);
										unset($pax['ticketing_remarks_on']);
										unset($pax['ticketing_in_progress_on']);
										unset($pax['ticketed_by']);
										
										unset($pax['name_update_check']);
										unset($pax['name_update_check_on']);
										
										$pax['added_on'] = date("Y-m-d H:i:s");
                                
                                        $columns = array_keys($pax);
                                        $values = array_map(function ($val) use ($mysqli) {
                                            if (!empty($val))
											{
												return "'" . mysqli_real_escape_string($mysqli, $val) . "'";
											}
											else
											{
												return "'" . $val . "'";
											}
                                        }, array_values($pax));
                                
                                        $insert_pax = "INSERT INTO wpk4_backend_travel_booking_pax (" . implode(',', $columns) . ") VALUES (" . implode(',', $values) . ")";
                                        if (!mysqli_query($mysqli, $insert_pax)) {
                                            echo " PAX insert failed (new order): " . mysqli_error($mysqli);
                                        }
                                    }
                                }
                                
                                // Loop 2: for pax IN selected_ids  assign to $divided_order_id
                                foreach ($all_pax as $pax2) {
                                    if (in_array($pax2['auto_id'], $selected_ids)) {
                                        $original_auto_id = $pax2['auto_id'];
                                        $pax2['order_id'] = $divided_order_id;
                                
                                        unset($pax2['auto_id']);
                                        if (empty($pax2['trams_profile_id'])) unset($pax2['trams_profile_id']);
										if (empty($pax2['customer_id'])) unset($pax2['customer_id']);
										unset($pax2['ticketed_on']);
										unset($pax2['ticketed_by']);
										unset($pax2['ticket_number']);
										unset($pax2['ticketing_audit_on']);
										unset($pax2['name_audit_on']);
										unset($pax2['ticketing_remarks_on']);
										unset($pax2['ticketing_in_progress_on']);
										
										unset($pax2['name_update_check']);
										unset($pax2['name_update_check_on']);
										
										$pax['added_on'] = date("Y-m-d H:i:s");
                                
                                        $columns = array_keys($pax2);
                                        $values = array_map(function ($val) use ($mysqli) {
											if (!empty($val))
											{
												return "'" . mysqli_real_escape_string($mysqli, $val) . "'";
											}
											else
											{
												return "'" . $val . "'";
											}
                                        }, array_values($pax2));
                                
                                        $insert_pax2 = "INSERT INTO wpk4_backend_travel_booking_pax (" . implode(',', $columns) . ") VALUES (" . implode(',', $values) . ")";
                                        if (!mysqli_query($mysqli, $insert_pax2)) {
                                            echo " PAX insert failed (divided order): " . mysqli_error($mysqli);
                                        }
                                    }
                                }
                                
                                //echo 'divide booking '.$divided_pax_to_be_paid_total . '</br></br>';
								
								//echo 'non divide booking '.$non_divided_pax_to_be_paid_total. '</br></br>';
								
                                if ($order_type == 'gds') // GDS
                                {
                                    // Step 4: Copy all related history updates
                                    $res_hist = $mysqli->query("SELECT * FROM wpk4_backend_history_of_updates WHERE type_id = '$orderid'");
                                    if (!$res_hist) {
                                        echo "History Error: " . $mysqli->error;
                                        exit;
                                    }
                                
                                    // Store all history rows
                                    $all_hist_rows = [];
                                    while ($row = $res_hist->fetch_assoc()) {
                                        $all_hist_rows[] = $row;
                                    }
                                
                                    // First loop: insert with new_order_id
                                    foreach ($all_hist_rows as $hist) {
                                        $hist['type_id'] = $new_order_id;
                                        unset($hist['auto_id']);
                                
                                        // Remove null or empty values
                                        $hist = array_filter($hist, function($value) {
                                            return $value !== null && $value !== '';
                                        });
                                
                                        $columns = implode(", ", array_keys($hist));
                                        $values = implode("', '", array_map([$mysqli, 'real_escape_string'], array_values($hist)));
                                
                                        $insert_hist = "INSERT INTO wpk4_backend_history_of_updates ($columns) VALUES ('$values')";
                                        if (!$mysqli->query($insert_hist)) {
                                            echo " Error inserting history update (new_order_id): " . $mysqli->error . "<br>Query: $insert_hist";
                                            exit;
                                        }
                                    }
                                
                                    // Second loop: insert with finalco_order_id
                                    foreach ($all_hist_rows as $hist) {
                                        $hist['type_id'] = $divided_order_id;
                                        unset($hist['auto_id']);
                                
                                        // Remove null or empty values
                                        $hist = array_filter($hist, function($value) {
                                            return $value !== null && $value !== '';
                                        });
                                
                                        $columns = implode(", ", array_keys($hist));
                                        $values = implode("', '", array_map([$mysqli, 'real_escape_string'], array_values($hist)));
                                
                                        $insert_hist = "INSERT INTO wpk4_backend_history_of_updates ($columns) VALUES ('$values')";
                                        if (!$mysqli->query($insert_hist)) {
                                            echo " Error inserting history update (finalco_order_id): " . $mysqli->error . "<br>Query: $insert_hist";
                                            exit;
                                        }
                                    }
                                }
								
								$sql_update_past_booking2 ="UPDATE wpk4_backend_travel_bookings
                                                 SET total_amount = '$non_divided_pax_to_be_paid_total', payment_modified = '$current_date_and_time', payment_modified_by = 'customer_portal_dc'
                                                WHERE order_id = '$new_order_id'";
                                $results_update_past_booking2 = $mysqli->query($sql_update_past_booking2);
								
								if ($order_type == 'gds')
								{
									$sql_update_past_booking3 ="UPDATE wpk4_backend_history_of_updates
                                                 SET meta_value = '$non_divided_pax_to_be_paid_total', updated_by = 'DC Amount Change'
                                                WHERE type_id = '$new_order_id' AND meta_key = 'Transaction TotalTurnover'";
									$results_update_past_booking3 = $mysqli->query($sql_update_past_booking3);
									
									$sql_update_past_booking3 ="UPDATE wpk4_backend_history_of_updates
                                                 SET meta_value = '$divided_pax_to_be_paid_total', updated_by = 'DC Amount Change'
                                                WHERE type_id = '$divided_order_id' AND meta_key = 'Transaction TotalTurnover'";
									$results_update_past_booking3 = $mysqli->query($sql_update_past_booking3);
								}
								

                                $query_booking_for_payment_history = "SELECT payment_status, total_amount FROM wpk4_backend_travel_bookings WHERE order_id = '$orderid' ";
								$result_booking_for_payment_history = mysqli_query($mysqli, $query_booking_for_payment_history) or die(" Booking query failed: " . mysqli_error($mysqli));
								while ($pax_booking_for_payment_history = mysqli_fetch_assoc($result_booking_for_payment_history)) 
								{
									//echo '</br>In Pay Loop</br>';
									//if($pax_booking_for_payment_history['payment_status'] == 'paid')
									{
										$total_paid_for_booking_transfer = 0.00;
										$processedPayments = array();
										$query_total_paid_for_requestid = "SELECT * FROM wpk4_backend_travel_payment_history where order_id = '$orderid' AND (pay_type = 'deposit' OR pay_type = 'balance' 
														OR pay_type = 'Balance' OR pay_type = 'deposit_adjustment' OR pay_type = 'additional_payment' OR pay_type = 'Refund')";
										$result_total_paid_for_requestid = mysqli_query($mysqli, $query_total_paid_for_requestid);
										while($row_total_paid_for_requestid = mysqli_fetch_assoc($result_total_paid_for_requestid))
										{
											$payment_identifier = $row_total_paid_for_requestid['trams_received_amount'].'^'.$row_total_paid_for_requestid['reference_no']; 
                                    		if (in_array($payment_identifier, $processedPayments)) 
                                    		{
												continue; // Skip to the next value
                                    		}
											
											$processedPayments[] = $payment_identifier;

											$total_paid_for_booking_transfer += (float)$row_total_paid_for_requestid['trams_received_amount'];
										}
										//echo '</br>Total paid . ' . $total_paid_for_booking_transfer .'</br>';
										//&& $pax_booking_for_payment_history['total_amount'] == $total_paid_for_booking_transfer
										if($total_paid_for_booking_transfer > 0 )
										{
											//echo '</br>In amount check condition</br>';
											$total_balance_after_reduce_non_divided_booking_amount = $total_paid_for_booking_transfer - $non_divided_pax_to_be_paid_total;
											
											// non divide amount transfer
											if( $total_paid_for_booking_transfer >= $non_divided_pax_to_be_paid_total )
											{
												///echo '</br>Inserting transfer 1</br>';
												$total_paid_for_booking_transfer_minus = '-'.$non_divided_pax_to_be_paid_total;
												
												$remark_for_past_booking = 'amount transfered to - '. $new_order_id . ' by Customer Portal DC';
												$remark_for_new_booking = 'amount transfered from - '. $orderid . ' by Customer Portal DC';
												
												mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history (order_id, source, trams_received_amount, reference_no, payment_method, process_date, pay_type, added_on, added_by) 
												values ('$orderid', '$order_type', '$total_paid_for_booking_transfer_minus', '$remark_for_past_booking', '14', '$current_date_and_time', 'deposit_adjustment', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
												
												mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history (order_id, source, trams_received_amount, reference_no, payment_method, process_date, pay_type, added_on, added_by) 
												values ('$new_order_id', '$order_type', '$non_divided_pax_to_be_paid_total', '$remark_for_new_booking', '14', '$current_date_and_time', 'deposit_adjustment', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
											}
											
											//if($total_balance_after_reduce_non_divided_booking_amount == $divided_pax_to_be_paid_total)
											{
												//echo '</br>Inserting transfer 2</br>';
												$total_paid_for_booking_transfer_minus2 = '-'.$total_balance_after_reduce_non_divided_booking_amount;
												
												$remark_for_past_booking2 = 'amount transfered to - '. $divided_order_id . ' by Customer Portal DC';
												$remark_for_new_booking2 = 'amount transfered from - '. $orderid . ' by Customer Portal DC';
												
												mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history (order_id, source, trams_received_amount, reference_no, payment_method, process_date, pay_type, added_on, added_by) 
												values ('$orderid', '$order_type', '$total_paid_for_booking_transfer_minus2', '$remark_for_past_booking2', '14', '$current_date_and_time', 'deposit_adjustment', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
												
												mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history (order_id, source, trams_received_amount, reference_no, payment_method, process_date, pay_type, added_on, added_by) 
												values ('$divided_order_id', '$order_type', '$total_balance_after_reduce_non_divided_booking_amount', '$remark_for_new_booking2', '14', '$current_date_and_time', 'deposit_adjustment', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
											}
										}
									}
								}
								
								if($order_type != 'gds' && $new_order_id != '')
								{
									$query_stock_check = "SELECT trip_code, travel_date, total_pax FROM wpk4_backend_travel_bookings where order_id = '$new_order_id' and order_type != 'gds'";
									$result_stock_check = mysqli_query($mysqli, $query_stock_check);
									if(mysqli_num_rows($result_stock_check) > 0 )
									{
										while($row_stock_check = mysqli_fetch_assoc($result_stock_check))
										{
											$trip_code = $row_stock_check['trip_code'];
											$travel_date = $row_stock_check['travel_date'];
											$total_pax = $row_stock_check['total_pax'];
																															
											update_stock_in_pricing_table($trip_code, $travel_date, $total_pax, 'positive');
																															
											
										}
										$by_user = 'dc_in_customer_portal';

										availability_table_pax_update_positive($order_id, $by_user);
									}
								}
								
								//echo '</br>updating status</br>';
                                $sql_update_past_booking ="UPDATE wpk4_backend_travel_bookings
                                                                    SET payment_status = 'voucher_submited', payment_modified = '$current_date_and_time', payment_modified_by = 'customer_portal_dc'
                                                                WHERE order_id = '$orderid'";
                                                                $results_update_past_booking = $mysqli->query($sql_update_past_booking);
                                                                
                                                                if ($results_update_past_booking > 0) 
                                                                {
																	if($order_type != 'gds')
																	{
																		$query_stock_check = "SELECT trip_code, travel_date, total_pax FROM wpk4_backend_travel_bookings where order_id = '$orderid' and order_type != 'gds'";
																		$result_stock_check = mysqli_query($mysqli, $query_stock_check);
																		if(mysqli_num_rows($result_stock_check) > 0 )
																		{
																			while($row_stock_check = mysqli_fetch_assoc($result_stock_check))
																			{
																					
																				$trip_code = $row_stock_check['trip_code'];
																				$travel_date = $row_stock_check['travel_date'];
																				$total_pax = $row_stock_check['total_pax'];
																				
																				update_stock_in_pricing_table($trip_code, $travel_date, $total_pax, 'negative');
																				
																				$by_user = 'dc_in_customer_portal';
																																						
																				availability_table_pax_update($order_id, $by_user);
																			}
																		}
																	}
																	
                                                                    mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
    					                                            values ('$orderid','','','payment_status','Rebooked','$current_date_and_time','$currnt_userlogined')") or die(mysqli_error($mysqli));
                                                                }

								mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
    					         values ('$orderid','','','DC Initiated','','$current_date_and_time','$currnt_userlogined')") or die(mysqli_error($mysqli));
								//echo $divided_order_id . ' - ' . $new_order_id;
								
								$sql_update = "UPDATE wpk4_backend_user_portal_requests SET change_done = '$divided_order_id', original_order_id='$order_id', reservation_ref='$divided_order_id', change_done_by = '$currnt_userlogined', change_done_on = '$current_date_and_time' WHERE case_id='$case_id'";
								$result_update= mysqli_query($mysqli,$sql_update);

								$finalco_order_id = $co_orderid;
								
								
								$count_pax_query_1 = "SELECT order_id, fname, lname, dob FROM wpk4_backend_travel_booking_pax WHERE order_id = '$divided_order_id'";
                                $result_count_pax_query_1 = mysqli_query($mysqli, $count_pax_query_1) or die(" Pax query failed: " . mysqli_error($mysqli));
                                $count_pax_array_1 = [];
                                while ($row_count_pax_query_1 = mysqli_fetch_assoc($result_count_pax_query_1)) 
								{
                                    $count_pax_array_1[] = $row_count_pax_query_1['order_id'].$row_count_pax_query_1['fname'].$row_count_pax_query_1['lname'].$row_count_pax_query_1['dob'];
                                }
								$count_pax_array_1 = array_unique($count_pax_array_1);	
								$count_divided_pax = count($count_pax_array_1);

								$sql_update_past_booking ="UPDATE wpk4_backend_travel_bookings
                                        SET total_pax = '$count_divided_pax'
                                        WHERE order_id = '$divided_order_id'";
                                $results_update_past_booking = $mysqli->query($sql_update_past_booking);
								
								
								$count_pax_query_2 = "SELECT order_id, fname, lname, dob FROM wpk4_backend_travel_booking_pax WHERE order_id = '$new_order_id'";
                                $result_count_pax_query_2 = mysqli_query($mysqli, $count_pax_query_2) or die(" Pax query failed: " . mysqli_error($mysqli));
                                $count_pax_array_2 = [];
                                while ($row_count_pax_query_2 = mysqli_fetch_assoc($result_count_pax_query_2)) 
								{
                                    $count_pax_array_2[] = $row_count_pax_query_2['order_id'].$row_count_pax_query_2['fname'].$row_count_pax_query_2['lname'].$row_count_pax_query_2['dob'];
                                }
								$count_pax_array_2 = array_unique($count_pax_array_2);	
								$count_non_divided_pax = count($count_pax_array_2);
								
								$sql_update_past_booking ="UPDATE wpk4_backend_travel_bookings
                                        SET total_pax = '$count_non_divided_pax'
                                        WHERE order_id = '$new_order_id'";
                                $results_update_past_booking = $mysqli->query($sql_update_past_booking);
																

								if($order_type != 'gds')
								{
									echo "<script>window.location.href='?p=manage-datechange-v1&part=booking-info-update&oid={$divided_order_id}&coid={$finalco_order_id}&new_oid={$new_order_id}';</script>";
								}
								else
								{
									echo "<script>window.location.href='?p=manage-datechange-v1&part=booking-info-update-fit&oid={$divided_order_id}&coid={$finalco_order_id}&new_oid={$new_order_id}';</script>";
								}
								exit;
						}
						
						if (isset($_POST['without_divideorder'])) 
						{
								$order_id = $_GET['oid'];
								$case_id = $_GET['cid'];
								$orderid = $_POST['id'];
								$co_orderid = $_POST['co_orderid'] ?? '';
								$productid = $_POST['productid'] ?? '';
								//$order_type = $_POST['order_type'] ?? '';
								$selected_ids = $_POST['pax_ids_for_new_order'] ?? [];

								// Enable error reporting for mysqli
								mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT);
								
								if(empty($selected_ids))
								{
								    $all_pax_query = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
    								$result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));
    								while ($pax = mysqli_fetch_assoc($result_all_pax)) 
    								{
    								    $pax_a_id = $pax['auto_id'];
    								    $selected_ids[] = $pax_a_id;
    								}
								}
								
								$all_pax_query = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
								$result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));
								while ($pax = mysqli_fetch_assoc($result_all_pax)) 
								{
									if (in_array($pax['auto_id'], $selected_ids))
									{
									    $pax_a_id = $pax['auto_id'];
									    $fname = $pax['fname'];
									    $lname = $pax['lname'];
										$dob = $pax['dob'];
										$salutation = $pax['salutation'];
									    
									    $all_pax_query_inner = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE auto_id != '$pax_a_id' and order_id = '$orderid' and salutation = '$salutation' and fname = '$fname' and lname = '$lname' and dob = '$dob'";
								        $result_all_pax_inner = mysqli_query($mysqli, $all_pax_query_inner) or die(" Pax query failed: " . mysqli_error($mysqli));
										if( mysqli_num_rows($result_all_pax_inner) > 0)
										{
											$pax_inner = mysqli_fetch_assoc($result_all_pax_inner);
											$inner_a_id = $pax_inner['auto_id'];
											$selected_ids[] = $inner_a_id;
										}
									}
								}
								//print_r($selected_ids);
								$selected_ids = array_unique($selected_ids);	

								$res_max_order = mysqli_query($mysqli, "SELECT MAX(order_id) AS max_order_id FROM wpk4_backend_travel_bookings");
								$max_row = mysqli_fetch_assoc($res_max_order);
								$divided_order_id = $max_row['max_order_id'] + 1;

								// Fetch existing booking
								$res_booking = mysqli_query($mysqli, "SELECT * FROM wpk4_backend_travel_bookings WHERE order_id = '$order_id'");
                                if (!$res_booking || mysqli_num_rows($res_booking) === 0) {
                                    die(" No booking found for order_id = $order_id");
                                }

                                while ($booking_data = mysqli_fetch_assoc($res_booking)) {
                                    // Store current order_id as previous
                                    $booking_data['previous_order_id'] = $order_id;
                                
                                    // Remove auto-increment key
                                    unset($booking_data['auto_id']);
                                
                                    // Conditionally unset specific fields
                                    if (empty($booking_data['divided_date'])) unset($booking_data['divided_date']);
                                    if (empty($booking_data['late_modified'])) unset($booking_data['late_modified']);
                                    if (empty($booking_data['airline_ttl_deadline'])) unset($booking_data['airline_ttl_deadline']);
                                    if (empty($booking_data['price_time_limit'])) unset($booking_data['price_time_limit']);
                                    if (empty($booking_data['ticketing_timelimit'])) unset($booking_data['ticketing_timelimit']);
                                    if (empty($booking_data['return_date'])) unset($booking_data['return_date']);
									
									if (empty($booking_data['family_id'])) unset($booking_data['family_id']);
									if (empty($booking_data['journal_date'])) unset($booking_data['journal_date']);
									
									unset($booking_data['payment_modified']);
									$booking_data['source'] = "datechange";
                                    $booking_data['payment_status'] = "partially_paid";
									//$booking_data['deposit_deadline'] = date("Y-m-d") . ' 23:59:59';
									//$booking_data['full_payment_deadline'] = date("Y-m-d") . ' 23:59:59';
									
									$booking_data['deposit_deadline'] = date("Y-m-d H:i:s", strtotime("+1 day"));
									$booking_data['full_payment_deadline'] = date("Y-m-d H:i:s", strtotime("+1 day"));
									
									$booking_data['agent_info'] = $currnt_userlogined;
									
									$booking_data['added_on'] = date("Y-m-d H:i:s");
                                
                                    // Change to divided_order_id and insert again
                                    $booking_data['order_id'] = $divided_order_id;
                                    
                                    $columns = array_keys($booking_data);
                                    $values = array_map(function ($val) use ($mysqli) {
                                        if (!empty($val))
											{
												return "'" . mysqli_real_escape_string($mysqli, $val) . "'";
											}
											else
											{
												return "'" . $val . "'";
											}
                                    }, array_values($booking_data));
                                
                                    $insert_booking = "INSERT INTO wpk4_backend_travel_bookings (" . implode(',', $columns) . ") VALUES (" . implode(',', $values) . ")";
                                    if (!mysqli_query($mysqli, $insert_booking)) {
                                        die(" Booking insert failed (divided_order_id): " . mysqli_error($mysqli));
                                    }
                                }


								// Process unselected passengers
								$all_pax_query = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
								$result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));

								while ($pax = mysqli_fetch_assoc($result_all_pax)) {
								    
									if (in_array($pax['auto_id'], $selected_ids)) {
										$original_auto_id = $pax['auto_id']; // store before unset
										$pax['order_id'] = $divided_order_id;

										unset($pax['auto_id']);
										if (empty($pax['trams_profile_id'])) unset($pax['trams_profile_id']);
										if (empty($pax['customer_id'])) unset($pax['customer_id']);
										unset($pax['ticket_number']);
										unset($pax['ticketed_by']);
										unset($pax['ticketed_on']);
										unset($pax['ticketing_audit_on']);
										unset($pax['name_audit_on']);
										unset($pax['ticketing_remarks_on']);
										unset($pax['ticketing_in_progress_on']);
										
										unset($pax['name_update_check']);
										unset($pax['name_update_check_on']);
										
										$booking_data['added_on'] = date("Y-m-d H:i:s");

										$columns = array_keys($pax);
										$values = array_map(function ($val) use ($mysqli) {
											if (!empty($val))
											{
												return "'" . mysqli_real_escape_string($mysqli, $val) . "'";
											}
											else
											{
												return "'" . $val . "'";
											}
										}, array_values($pax));

										$insert_pax = "INSERT INTO wpk4_backend_travel_booking_pax (" . implode(',', $columns) . ") VALUES (" . implode(',', $values) . ")";
										if (!mysqli_query($mysqli, $insert_pax)) {
											echo " PAX insert failed: " . mysqli_error($mysqli);
										}
									}
								}
								//echo $order_type;
								if ($order_type == 'gds') // GDS
                                {
                                    // Step 4: Copy all related history updates
                                    $res_hist = $mysqli->query("SELECT * FROM wpk4_backend_history_of_updates WHERE type_id = '$orderid'");
                                    if (!$res_hist) {
                                        echo "History Error: " . $mysqli->error;
                                        exit;
                                    }
                                
                                    // Store all history rows
                                    $all_hist_rows = [];
                                    while ($row = $res_hist->fetch_assoc()) {
                                        $all_hist_rows[] = $row;
                                    }
                                    // First loop: insert with new_order_id
                                    foreach ($all_hist_rows as $hist) {
                                        $hist['type_id'] = $divided_order_id;
                                        unset($hist['auto_id']);
                                
                                        // Remove null or empty values
                                        $hist = array_filter($hist, function($value) {
                                            return $value !== null && $value !== '';
                                        });
                                
                                        $columns = implode(", ", array_keys($hist));
                                        $values = implode("', '", array_map([$mysqli, 'real_escape_string'], array_values($hist)));
                                
                                        $insert_hist = "INSERT INTO wpk4_backend_history_of_updates ($columns) VALUES ('$values')";
                                        if (!$mysqli->query($insert_hist)) {
                                            echo " Error inserting history update (new_order_id): " . $mysqli->error . "<br>Query: $insert_hist";
                                            exit;
                                        }
                                    }
                                }
								
								
								$is_ticketed = 0;
								$all_pax_query_ticket_finder = "SELECT ticket_number FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' and ticket_number is not null";
								$result_all_pax_ticket_finder = mysqli_query($mysqli, $all_pax_query_ticket_finder) or die(" Pax query failed: " . mysqli_error($mysqli));
								while ($pax_ticket_finder = mysqli_fetch_assoc($result_all_pax_ticket_finder)) 
								{
									if($pax_ticket_finder['ticket_number'] != '')
									{
										$is_ticketed = 1;
										break;
									}
								}
								if($is_ticketed == 0)
								{
									$total_paid_for_booking_transfer = 0.00;
									$processedPayments = array();
									$query_total_paid_for_requestid = "SELECT * FROM wpk4_backend_travel_payment_history where order_id = '$orderid' AND (pay_type = 'deposit' OR pay_type = 'balance' 
													OR pay_type = 'Balance' OR pay_type = 'deposit_adjustment' OR pay_type = 'additional_payment')";
									$result_total_paid_for_requestid = mysqli_query($mysqli, $query_total_paid_for_requestid);
									while($row_total_paid_for_requestid = mysqli_fetch_assoc($result_total_paid_for_requestid))
									{
										$payment_identifier = $row_total_paid_for_requestid['trams_received_amount'].'^'.$row_total_paid_for_requestid['reference_no']; 
                                    		if (in_array($payment_identifier, $processedPayments)) 
                                    		{
												continue; // Skip to the next value
                                    		}
											
										$processedPayments[] = $payment_identifier;	

										$total_paid_for_booking_transfer += (float)$row_total_paid_for_requestid['trams_received_amount'];
									}
									echo 'total to transfer '. $total_paid_for_booking_transfer .'</br>';
									if($total_paid_for_booking_transfer > 0) 
									{
										$total_paid_for_booking_transfer_minus = '-'.$total_paid_for_booking_transfer;
										
										$remark_for_past_booking = 'amount transfered to - '. $divided_order_id . ' by Customer Portal DC';
										$remark_for_new_booking = 'amount transfered from - '. $orderid . ' by Customer Portal DC';
										
										mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history (order_id, source, trams_received_amount, reference_no, payment_method, process_date, pay_type, added_on, added_by) 
										values ('$orderid', '$order_type', '$total_paid_for_booking_transfer_minus', '$remark_for_past_booking', '14', '$current_date_and_time', 'deposit_adjustment', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
										
										mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history (order_id, source, trams_received_amount, reference_no, payment_method, process_date, pay_type, added_on, added_by) 
										values ('$divided_order_id', '$order_type', '$total_paid_for_booking_transfer', '$remark_for_new_booking', '14', '$current_date_and_time', 'deposit_adjustment', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
										
									}
								
								}
								
                                $sql_update_past_booking ="UPDATE wpk4_backend_travel_bookings
                                                                    SET payment_status = 'voucher_submited', payment_modified = '$current_date_and_time', payment_modified_by = 'customer_portal_dc'
                                                                WHERE order_id = '$orderid'";
                                                                $results_update_past_booking = $wpdb->query($sql_update_past_booking);
                                                                
                                                                if ($results_update_past_booking > 0) 
                                                                {
																	
																	if($order_type != 'gds')
																	{
																		$query_stock_check = "SELECT trip_code, travel_date, total_pax FROM wpk4_backend_travel_bookings where order_id = '$orderid' and order_type != 'gds'";
																		$result_stock_check = mysqli_query($mysqli, $query_stock_check);
																		if(mysqli_num_rows($result_stock_check) > 0 )
																		{
																			while($row_stock_check = mysqli_fetch_assoc($result_stock_check))
																			{
																					
																				$trip_code = $row_stock_check['trip_code'];
																				$travel_date = $row_stock_check['travel_date'];
																				$total_pax = $row_stock_check['total_pax'];
																				
																				update_stock_in_pricing_table($trip_code, $travel_date, $total_pax, 'negative');
																				
																				$by_user = 'dc_in_customer_portal';
																																						
																				availability_table_pax_update($order_id, $by_user);
																			}
																		}
																	}
																	
																	
                                                                    mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
    					                                            values ('$orderid','','','payment_status','Rebooked','$current_date_and_time','$currnt_userlogined')") or die(mysqli_error($mysqli));
                                                                } 

								mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
    					         values ('$orderid','','','DC Initiated','','$current_date_and_time','$currnt_userlogined')") or die(mysqli_error($mysqli));

								$sql_update = "UPDATE wpk4_backend_user_portal_requests SET change_done = '$divided_order_id', original_order_id='$order_id', reservation_ref='$divided_order_id', change_done_by = '$currnt_userlogined', change_done_on = '$current_date_and_time' WHERE case_id='$case_id'";
								$result_update= mysqli_query($mysqli,$sql_update);

								$finalco_order_id = $co_orderid;

								if($order_type != 'gds')
								{
									echo "<script>window.location.href='?p=manage-datechange-v1&part=booking-info-update&oid={$divided_order_id}&coid={$finalco_order_id}&new_oid=';</script>";
								}
								else
								{
									echo "<script>window.location.href='?p=manage-datechange-v1&part=booking-info-update-fit&oid={$divided_order_id}&coid={$finalco_order_id}&new_oid=';</script>";
								}
								exit;
						}
					}
					
					if(isset($_GET['p']) && $_GET['p'] =='manage-datechange-v1' && isset($_GET['part']) && $_GET['part'] == 'booking-info-update-fit')
						{
						    echo '</br></br></br>';
						    $order_id = $_GET['oid'];
							$co_order_id = $_GET['coid'] ?? '';
							
						    
						    $query_pax = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id' order by travel_date asc limit 1";
							//echo $query_pax;
                    		$result_pax = mysqli_query($mysqli, $query_pax);
                    		?>
                    		<h6>Order ID : <?php echo $order_id; ?></h6>
                    		<?php
                    		if(!empty($result_pax))
                    		{
                    		    ?>
								<script src="https://cdn.jsdelivr.net/gh/alumuko/vanilla-datetimerange-picker@latest/dist/vanilla-datetimerange-picker.js"></script>
								<script>
									window.addEventListener("load", function (event) {
									let drp = new DateRangePicker('travel_date_int',
											{
												
												timePicker: false,
												alwaysShowCalendars: true,
												singleDatePicker: true,
												autoApply: true,
												autoUpdateInput: true,
												
												locale: {
													format: "YYYY-MM-DD 00:00:00",
												}
											},
											function (start) {
												document.getElementById("travel_date_int").value = start.format();
												
											})
									});
									
									window.addEventListener("load", function (event) {
									let drp = new DateRangePicker('travel_date_fit',
											{
												
												timePicker: false,
												alwaysShowCalendars: true,
												singleDatePicker: true,
												autoApply: true,
												autoUpdateInput: true,
												
												locale: {
													format: "YYYY-MM-DD HH:mm:ss",
												}
											},
											function (start) {
												document.getElementById("travel_date_fit").value = start.format();
												
											})
									});
									
									window.addEventListener("load", function (event) {
									let drp = new DateRangePicker('return_date_fit',
											{
												
												timePicker: false,
												alwaysShowCalendars: true,
												singleDatePicker: true,
												autoApply: true,
												autoUpdateInput: true,
												
												locale: {
													format: "YYYY-MM-DD HH:mm:ss",
												}
											},
											function (start) {
												document.getElementById("return_date_fit").value = start.format();
												
											})
									});
								</script>
                    		    <form action="#" name="statusupdate" method="post" enctype="multipart/form-data" style='font-size:13px;'>
                    		    <?php
                    			$row_pax = mysqli_fetch_assoc($result_pax);
                    			{
                    			    $auto_id = $row_pax['auto_id'];
                    				$order_id = $row_pax['order_id'];
                    				$co_order_id_db = $row_pax['co_order_id'];
                    				$product_id = $row_pax['product_id'];
                    				$order_type = $row_pax['order_type'];
                    				$t_type = $row_pax['t_type'];
                    				$total_pax = $row_pax['total_pax'];
									$previous_order_id_sql = $row_pax['previous_order_id'];
									
									$query_pax_2 = "SELECT pnr FROM wpk4_backend_travel_booking_pax where order_id='$previous_order_id_sql' and (product_id = '$product_id' OR product_id = '') order by auto_id asc limit 1";
									$result_pax_2 = mysqli_query($mysqli, $query_pax_2);
									$row_pax_2 = mysqli_fetch_assoc($result_pax_2);
									$pnr = $row_pax_2['pnr'];
                    				?>
                    			    Airline Change Fee
									<input type='text' name='airline_change_fee' required id='airline_change_fee'></br>
									
									Fare Difference
									<input type='text' name='fare_difference' required id='fare_difference'></br>
									
									Gaura Travel Service Fee
									<input type='text' name='gaura_service_fee' required id='gaura_service_fee'></br>
									
									Buffer
									<input type='text' name='buffer' required id='buffer'></br>
									
									Cost Given / Datechange Amount (Amount to be requested from customer)
                        			<input type='text' name='total_amount' required id='dc_amount'></br>

									Tripcode / Route</br>
									<b>One-way</b>: Enter the route in the format <b>MEL-DEL-SQ</b></br>
									<b>Return</b>: Enter only the first main route, e.g., <b>MEL-DEL-SQ</b>. Systemetically we cover the return leg (DEL-MEL-SQ).</br>
									<b>Multi-city</b>: Enter the main route in sequence, e.g., <b>DEL-MEL-SYD-HYD</b></br>
                        			<input type='text' name='tripcode_route_<?php echo $auto_id; ?>' required id='tripcode'></br>
									
                    			    <h6>Current Tripcode : <?php echo $row_pax['trip_code']; ?></h6>
									<input type="hidden" name="manual_fields_log" id="manual_fields_log" value="">
                    				<?php
                    				
                    				echo "<input type='hidden' name='order_type_<?php echo $auto_id; ?>' value='".$order_type."' id='searchkeyvalue'>";
                    				echo "<input type='hidden' name='total_pax_<?php echo $auto_id; ?>' value='".$total_pax."' id='total_pax'>";
                    				{
                    			
											global $wpdb;

											// $query_pax_2 = "SELECT * FROM `wpk4_backend_history_of_updates` WHERE `type_id` LIKE '900114055'";
											// 									$result_pax_2 = mysqli_query($mysqli, $query_pax_2);
											// 									while($row_pax_2 = mysqli_fetch_assoc($result_pax_2))
											// 									{
											// 										echo $row_pax_2['meta_key'] . ': ' . $row_pax_2['meta_value'] . '</br>';
											// 									}



											$existing_data = [];
											$meta_keys = [
												'Flightlegs MarketingCarrier', 'Flightlegs DepApt', 'Flightlegs DestApt', 'Flightlegs Equipment',
												'Flightlegs FlNr', 'Flightlegs Status', 'Flightlegs Meal',
												'Flightlegs Class', 'Flightlegs CrFileKey', 'Flightlegs DepTerminal',
												'Flightlegs DestTerminal', 'Flightlegs DepTime', 'Flightlegs DestTime'
											];

											foreach ($meta_keys as $key) {
												$existing_data[$key] = '';
												$res = $wpdb->get_var($wpdb->prepare(
													"SELECT meta_value FROM wpk4_backend_history_of_updates WHERE type_id = %s AND meta_key = %s",
													$order_id, $key
												));
												if ($res !== null) {
													$existing_data[$key] = explode(' | ', $res);
												}
											}

											// Use one key to determine number of rows
											//$row_count = count($existing_data['Flightlegs DepApt']) ?? 0;

											$row_count = is_array($existing_data['Flightlegs DepApt']) ? count($existing_data['Flightlegs DepApt']) : 0;

											?>
											<style>
											.switch-to-manual {
												display: inline-block;
												font-size: 11px;
												color: #0073aa;
												margin-top: 4px;
												text-decoration: underline;
												cursor: pointer;
											}
											.switch-to-manual:hover {
												color: #005177;
											}
											</style>
											<table id="flight_table" border="0" style="border:none; width:100%; margin-bottom:15px;">
												<thead>
													<tr><th colspan="16">Flight Details</th></tr>
												</thead>

												<?php 
												if($row_count > 0)
												{
													for ($i = 0; $i < $row_count; $i++): 
													
													$dep_datetime_raw = $existing_data['Flightlegs DepTime'][$i] ?? '';
													$dep_date = '';
													$dep_time = '';

													if (!empty($dep_datetime_raw)) {
														$datetime = DateTime::createFromFormat('Y-m-d H:i:s', $dep_datetime_raw) ?: DateTime::createFromFormat('Y-m-d H:i', $dep_datetime_raw);
														if ($datetime) {
															$dep_date = $datetime->format('Y-m-d');
															$dep_time = $datetime->format('H:i');
														}
													}
													
													$arr_datetime_raw = $existing_data['Flightlegs DestTime'][$i] ?? '';
													$arr_date = '';
													$arr_time = '';

													if (!empty($arr_datetime_raw)) {
														$datetime = DateTime::createFromFormat('Y-m-d H:i:s', $arr_datetime_raw) ?: DateTime::createFromFormat('Y-m-d H:i', $arr_datetime_raw);
														if ($datetime) {
															$arr_date = $datetime->format('Y-m-d');
															$arr_time = $datetime->format('H:i');
														}
													}
													?>
													<tbody class="flight-row" data-index="<?= $i ?>">
														<tr>
												<td width="16%">
													Flight<br>
													<div class="select-or-input">
														<a href="#" class="switch-to-manual" style="display:block; font-size:11px; margin-bottom:2px;">Switch to Manual</a>
														<select required name="flight_code[]" class="flight_code" style="width:100%; height:40px;">
															<option value="" disabled <?= empty($existing_data['Flightlegs MarketingCarrier'][$i]) ? 'selected' : '' ?>>Airline</option>
															<?php
															$airlines = $wpdb->get_results("
																SELECT DISTINCT LEFT(Flight, 2) AS airline_code
																FROM wpk4_backend_FIT_flight_schedule
																WHERE Flight IS NOT NULL AND Flight != ''
																ORDER BY airline_code
															");
															$flight_code_val = substr($existing_data['Flightlegs MarketingCarrier'][$i] ?? '', 0, 2);
															foreach ($airlines as $row_airline) {
																$code = $row_airline->airline_code;
																$selected = ($code === $flight_code_val) ? 'selected' : 'disabled';
																echo "<option value='{$code}' {$selected}>{$code}</option>";
															}
															?>
														</select>
													</div>
												</td>

												<td width="32%" colspan="2">
													Origin<br>
													<div class="select-or-input">
														<a href="#" class="switch-to-manual" style="display:block; font-size:11px; margin-bottom:2px;">Switch to Manual</a>
														<select required name="Origin_Code[]" class="Origin_Code" style="width:100%; height:40px;">
															<?php if (!empty($existing_data['Flightlegs DepApt'][$i])): ?>
																<option selected value="<?= esc_attr($existing_data['Flightlegs DepApt'][$i]) ?>"><?= esc_html($existing_data['Flightlegs DepApt'][$i]) ?></option>
															<?php else: ?>
																<option value="" selected disabled>Select Origin</option>
															<?php endif; ?>
														</select>
													</div>
												</td>

												<td width="32%" colspan="2">
													Destination<br>
													<div class="select-or-input">
														<a href="#" class="switch-to-manual" style="display:block; font-size:11px; margin-bottom:2px;">Switch to Manual</a>
														<select required name="destination_code[]" class="destination_code" style="width:100%; height:40px;">
															<?php if (!empty($existing_data['Flightlegs DestApt'][$i])): ?>
																<option selected value="<?= esc_attr($existing_data['Flightlegs DestApt'][$i]) ?>"><?= esc_html($existing_data['Flightlegs DestApt'][$i]) ?></option>
															<?php else: ?>
																<option value="" selected disabled>Select Destination</option>
															<?php endif; ?>
														</select>
													</div>
												</td>

												<td width="16%">
													Flight Number<br>
													<div class="select-or-input">
														<a href="#" class="switch-to-manual" style="display:block; font-size:11px; margin-bottom:2px;">Switch to Manual</a>
														<?php
														$flight_no = ($existing_data['Flightlegs FlNr'][$i] ?? '');
														$airline = substr($existing_data['Flightlegs MarketingCarrier'][$i] ?? '', 0, 2);
														$full_flight_number = $airline . $flight_no;
														?>
														<select required name="flight_number[]" class="flight_number" style="width:100%; height:40px;">
															<option selected value="<?= esc_attr($full_flight_number) ?>"><?= esc_html($full_flight_number) ?></option>
														</select>
													</div>
												</td>
											</tr>


														<tr>
															<td>
																Dep Date<br>
																<input required readonly type="text" class="Dep_date" name="Dep_date[]" value="<?= esc_attr($dep_date) ?>">
															</td>
															<td>
																Dep Time<br>
																<input required type="text" class="Dep_Time" name="Dep_Time[]" value="<?= esc_attr($dep_time) ?>">
															</td>
															<td>
																Dep Terminal<br>
																<input required type="text" class="Dep_Terminal" name="Dep_Terminal[]" value="<?= esc_attr($existing_data['Flightlegs DepTerminal'][$i] ?? '') ?>">
															</td>

															<td>
																Arr Date<br>
																<input required readonly type="text" class="Arr_date" name="Arr_date[]" value="<?= esc_attr($arr_date) ?>">
															</td>
															<td>
																Arr Time<br>
																<input required type="text" class="Arr_Time" name="Arr_Time[]" value="<?= esc_attr($arr_time) ?>">
															</td>
															<td>
																Arr Terminal<br>
																<input required type="text" class="Arr_Terminal" name="Arr_Terminal[]" value="<?= esc_attr($existing_data['Flightlegs DestTerminal'][$i] ?? '') ?>">
															</td>
														</tr>

														<tr>
															<td>
																PNR<br>
																<input required type="text" class="PNRarray" name="PNRarray[]" value="<?= esc_attr($existing_data['Flightlegs CrFileKey'][$i] ?? '') ?>">
															</td>
															<td>
																Equ Code<br>
																<input required type="text" class="Equipment_Code" name="Equipment_Code[]" value="<?= esc_attr($existing_data['Flightlegs Equipment'][$i] ?? '') ?>">
															</td>
															<td>
																Equ Name<br>
																<input required type="text" class="Equipment_Name" name="Equipment_Name[]" value="<?= esc_attr($existing_data['Equipment_Name'][$i] ?? '') ?>">
															</td>
															<td>
																Status<br>
																<input required type="text" class="Status" name="Status[]" value="<?= esc_attr($existing_data['Flightlegs Status'][$i] ?? '') ?>">
															</td>
															<td>
																Meal<br>
																<input required type="text" class="Meal" name="Meal[]" value="<?= esc_attr($existing_data['Flightlegs Meal'][$i] ?? '') ?>">
															</td>
															<td>
																Class<br>
																<input required type="text" class="Class" name="Class[]" value="<?= esc_attr($existing_data['Flightlegs Class'][$i] ?? '') ?>">
															</td>
														</tr>

														<tr>
															<td colspan="6" style="text-align:right;">
																<button type="button" class="removeFlightBtn" style="background:red; color:white; border:none; padding:5px 10px; cursor:pointer;">X Remove</button>
															</td>
														</tr>

														<tr><td colspan="6"></td></tr>
													</tbody>
												<?php endfor; 
												}
												else
												{
													?>
													<tbody class="flight-row" data-index="0">
														<tr>
															<td width="16%">
																Flight<br>
																<div class="select-or-input">
																	<a href="#" class="switch-to-manual" style="display:block; font-size:11px; margin-bottom:2px;">Switch to Manual</a>
																	<select required name="flight_code[]" class="flight_code" style="width:100%; height:40px;">
																		<option value="" selected disabled>Airline</option>
																		<?php
																		global $wpdb;
																		$results = $wpdb->get_results("
																			SELECT DISTINCT LEFT(Flight, 2) AS airline_code
																			FROM wpk4_backend_FIT_flight_schedule
																			WHERE Flight IS NOT NULL AND Flight != ''
																			ORDER BY airline_code
																		");
																		foreach ($results as $row) {
																			echo "<option value='{$row->airline_code}'>{$row->airline_code}</option>";
																		}
																		?>
																	</select>
																</div>
															</td>

															<td width="32%" colspan="2">
																Origin<br>
																<div class="select-or-input">
																	<a href="#" class="switch-to-manual" style="display:block; font-size:11px; margin-bottom:2px;">Switch to Manual</a>
																	<select required name="Origin_Code[]" class="Origin_Code" style="width:100%; height:40px;">
																		<option value="" selected disabled>Select Origin</option>
																	</select>
																</div>
															</td>

															<td width="32%" colspan="2">
																Destination<br>
																<div class="select-or-input">
																	<a href="#" class="switch-to-manual" style="display:block; font-size:11px; margin-bottom:2px;">Switch to Manual</a>
																	<select required name="destination_code[]" class="destination_code" style="width:100%; height:40px;">
																		<option value="" selected disabled>Select Destination</option>
																	</select>
																</div>
															</td>

															<td width="16%">
																Flight Number<br>
																<div class="select-or-input">
																	<a href="#" class="switch-to-manual" style="display:block; font-size:11px; margin-bottom:2px;">Switch to Manual</a>
																	<?php $full_flight_number = ''; ?>
																	<select required name="flight_number[]" class="flight_number" style="width:100%; height:40px;">
																		<option selected value="<?= esc_attr($full_flight_number) ?>"><?= esc_html($full_flight_number) ?></option>
																	</select>
																</div>
															</td>
														</tr>

														<tr>
															<td width="16%">
																Dep Date<br>
																<input required readonly type="text" class="Dep_date" name="Dep_date[]">
															</td>
															<td width="16%">
																Dep Time<br>
																<input required type="text" class="Dep_Time" name="Dep_Time[]" >
															</td>
															<td width="16%">
																Dep Terminal<br>
																<input required type="text" class="Dep_Terminal" name="Dep_Terminal[]" >
															</td>
															
															<td width="16%">
																Arr Date<br>
																<input required readonly type="text" class="Arr_date" name="Arr_date[]">
															</td>
															<td width="16%">
																Arr Time<br>
																<input required type="text" class="Arr_Time" name="Arr_Time[]" >
															</td>
															<td width="16%">
																Arr Terminal<br>
																<input required type="text" class="Arr_Terminal" name="Arr_Terminal[]" >
															</td>
														</tr>
														<tr>
															<td>
																PNR<br><input required type="text" class="PNRarray" name="PNRarray[]" >
															</td>
															<td width="16%">
																Equ Code<br><input required type="text" class="Equipment_Code" name="Equipment_Code[]" >
															</td>
															<td>
																Equ Name<br><input required type="text" class="Equipment_Name" name="Equipment_Name[]">
															</td>
															<td width="16%">
																Status<br><input required type="text" class="Status" name="Status[]" >
															</td>
															<td width="16%">
																Meal<br><input required type="text" class="Meal" name="Meal[]" >
															</td>
															<td width="16%">
																Class<br><input required type="text" class="Class" name="Class[]" >
															</td>
														</tr>
														<tr>
														<td colspan="6" style="text-align:right;">
																<button type="button" class="removeFlightBtn" style="background:red; color:white; border:none; padding:5px 10px; cursor:pointer;">X Remove</button>
														</td>
													</tr>
													<tr><td colspan="6"></td></tr>
													</tbody>
													<?php
												}	
												?>
											</table>





											<button type="button" id="addFlightBtn">+ Add Flights</button>
											</br></br>
											<script>
											jQuery(document).ready(function($) {
												$(document).on('click', '.switch-to-manual', function(e) {
													e.preventDefault();
													
													const $container = $(this).closest('.select-or-input');
													const $select = $container.find('select');
													const selectedVal = $select.val();
													const selectName = $select.attr('name');
													const selectClass = $select.attr('class');

													// Replace select with input
													const $input = $(`<input type="text" style="width:100%; height:40px;">`)
														.attr('name', selectName)
														.attr('class', selectClass)
														.val(selectedVal);

													$select.remove();
													$(this).remove();
													$container.prepend($input);

													// Append to hidden field
													const $hiddenField = $('#manual_fields_log');  
													let currentVal = $hiddenField.val().split(',').filter(v => v.trim() !== '');
													if (!currentVal.includes(selectName)) {
														currentVal.push(selectName);
													}
													$hiddenField.val(currentVal.join(','));

												});
											});
											</script>

											<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
											<script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
											<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">

											<script>

											function initializeDatePickers(row) {
											row.find('.Dep_date').each(function () {
												$(this).datepicker('destroy'); // Destroy previous instances
												$(this).datepicker({
												dateFormat: 'yy-mm-dd',
												onSelect: function (selectedDate) {
													const input = $(this);
													const flightRow = input.closest('.flight-row');
													const flightNumber = flightRow.find('.flight_number').val();

													if (flightNumber && selectedDate) {
														fetch('/wp-content/themes/twentytwenty/templates/tpl_backend_functions.php', {
														method: 'POST',
														headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
														body: new URLSearchParams({
															action: 'get_flight_details_by_date',
															flight_number: flightNumber,
															departure_date: selectedDate
														})
														})
														.then(res => res.json())
														.then(data => {
														// Set values in the current row
														//flightRow.find('.Origin_Code').val(data.Origin);
														//flightRow.find('.destination_code').val(data.Destination);
														flightRow.find('.Dep_Time').val(data.DepartureTime);
														flightRow.find('.Arr_Time').val(data.ArrivalTime);
														flightRow.find('.Dep_Terminal').val(data.DepartureTerminal);
														flightRow.find('.Arr_Terminal').val(data.ArrivalTerminal);
														flightRow.find('.Equipment_Code').val(data.EquipmentCode);
														flightRow.find('.Equipment_Name').val(data.EquipmentName);

														// Determine correct arrival date
														const depTime = data.DepartureTime;
														const arrTime = data.ArrivalTime;

														if (depTime && arrTime) {
															const depParts = depTime.split(':');
															const arrParts = arrTime.split(':');

															const depMinutes = parseInt(depParts[0]) * 60 + parseInt(depParts[1]);
															const arrMinutes = parseInt(arrParts[0]) * 60 + parseInt(arrParts[1]);

															const depDateObj = new Date(selectedDate);
															if (arrMinutes < depMinutes) {
															depDateObj.setDate(depDateObj.getDate() + 1); // Next day
															}
															const yyyy = depDateObj.getFullYear();
															const mm = String(depDateObj.getMonth() + 1).padStart(2, '0');
															const dd = String(depDateObj.getDate()).padStart(2, '0');
															const finalArrDate = `${yyyy}-${mm}-${dd}`;

															flightRow.find('.Arr_date').val(finalArrDate);
														}
														});
													}
													}



												});
											});

											row.find('.Arr_date').each(function () {
												$(this).datepicker('destroy');
												$(this).datepicker({
												dateFormat: 'yy-mm-dd'
												});
											});
											}



											let flightIndex = 1;

											$(document).ready(function () {
												
												
												
											// Initialize datepicker for existing row
											initializeDatePickers($('.flight-row'));

											$(document).on('click', '.removeFlightBtn', function () {
											if ($('.flight-row').length > 1) {
												$(this).closest('.flight-row').remove();
											} else {
												alert('At least one flight row is required.');
											}
											});

											$('#addFlightBtn').on('click', function () {
											const table = $('#flight_table');
											const newRow = $('.flight-row:first').clone();
											newRow.attr('data-index', flightIndex);

											// Clear all inputs and dropdowns inside the cloned block
											newRow.find('input').val('');
											newRow.find('.flight_code').val('');
											newRow.find('.flight_number').html('<option value="">Select Flight Number</option>');

											// Reset datepickers (remove leftover data)
											newRow.find('.Dep_date, .Arr_date').each(function () {
												$(this).removeClass('hasDatepicker').removeAttr('id');
											});

											// Append the entire tbody (as a full block of two rows)
											table.append(newRow);
											initializeDatePickers(newRow);
											flightIndex++;
											});


											$(document).on('change', '.flight_code', function () {
											const row = $(this).closest('.flight-row');
											const existing_origin = row.find('.Origin_Code').val()?.trim().toUpperCase();
											const airlineCode = $(this).val();

											fetch('/wp-content/themes/twentytwenty/templates/tpl_backend_functions.php', {
												method: 'POST',
												headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
												body: new URLSearchParams({
												action: 'get_origins_by_airline',
												airline_code: airlineCode
												})
											})
											.then(res => res.json())
											.then(data => {
												const originField = row.find('.Origin_Code');
												originField.html('<option value="">Select Origin</option>');
												data.forEach(o => {
												const oVal = o.trim().toUpperCase();
												const selected = (existing_origin === oVal) ? 'selected' : '';
												originField.append(`<option value="${o}" ${selected}>${o}</option>`);
												});
											});
											});





											$('.flight_code').each(function () {
													const val = $(this).val();
													if (val && val.trim() !== '') {
													$(this).trigger('change');
													}
												});


											$(document).on('change', '.Origin_Code', function () {
											const row = $(this).closest('.flight-row');
											const origin = $(this).val();
											const airlineCode = row.find('.flight_code').val();

											fetch('/wp-content/themes/twentytwenty/templates/tpl_backend_functions.php', {
												method: 'POST',
												headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
												body: new URLSearchParams({
												action: 'get_destinations_by_airline_origin',
												airline_code: airlineCode,
												origin: origin
												})
											})
											.then(res => res.json())
											.then(data => {
												const destField = row.find('.destination_code');
												destField.html('<option value="">Select Destination</option>');
												data.forEach(d => {
												destField.append(`<option value="${d}">${d}</option>`);
												});
											});
											});

											$(document).on('change', '.destination_code', function () {
											const row = $(this).closest('.flight-row');
											const airlineCode = row.find('.flight_code').val();
											const origin = row.find('.Origin_Code').val();
											const destination = $(this).val();
											
											// Reset next .flight-row (not previous)
											const currentIndex = parseInt(row.attr('data-index'));
											const nextRow = $(`.flight-row[data-index="${currentIndex + 1}"]`);
											if (nextRow.length > 0) {
												//nextRow.find('.Origin_Code').val('');
												//nextRow.find('.destination_code').val('');
												//nextRow.find('.flight_number').html('<option value="">Select Flight</option>');
											}

											fetch('/wp-content/themes/twentytwenty/templates/tpl_backend_functions.php', {
												method: 'POST',
												headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
												body: new URLSearchParams({
												action: 'get_flights_by_route',
												airline_code: airlineCode,
												origin: origin,
												destination: destination
												})
											})
											.then(res => res.json())
											.then(data => {
												if (data.length > 0) {
												// Extract unique flight numbers and sort them
												const uniqueFlights = [...new Set(data.map(f => f.Flight))].sort();

												const options = uniqueFlights.map(flight => `<option value="${flight}">${flight}</option>`).join('');
												row.find('.flight_number').html('<option value="">Select Flight</option>' + options);
												}

												// Pre-fill the rest (just use the first result by default)
												const flight = data[0];
												if (flight) {
												row.find('.Dep_Time').val(flight.DepartureTime);
												row.find('.Arr_Time').val(flight.ArrivalTime);
												row.find('.Dep_Terminal').val(flight.DepartureTerminal);
												row.find('.Arr_Terminal').val(flight.ArrivalTerminal);
												row.find('.Equipment_Code').val(flight.EquipmentCode);
												row.find('.Equipment_Name').val(flight.EquipmentName);
												}
											});
											});

											$(document).on('change', '.flight_number', function () {
												const row = $(this).closest('.flight-row');
												const flightNumber = $(this).val();

												fetch('/wp-content/themes/twentytwenty/templates/tpl_backend_functions.php', {
												method: 'POST',
												headers: {'Content-Type': 'application/x-www-form-urlencoded'},
												body: new URLSearchParams({
													action: 'get_flight_details',
													flight_number: flightNumber
												})
												})
												.then(res => res.json())
												.then(data => {
												row.find('.Origin_Code').val(data.Origin);
												row.find('.destination_code').val(data.Destination);
												row.find('.Dep_Time').val(data.DepartureTime);
												row.find('.Arr_Time').val(data.ArrivalTime);
												row.find('.Dep_Terminal').val(data.DepartureTerminal);
												row.find('.Arr_Terminal').val(data.ArrivalTerminal);
												row.find('.Equipment_Code').val(data.EquipmentCode);
												row.find('.Equipment_Name').val(data.EquipmentName);
												});
											});



											});
											</script>
											
                        				    
                        				    <input type='hidden' readonly name='product_id_<?php echo $auto_id; ?>' id='new_product_id' value="">
											
                    				    <?php
                    				}
                    			}
								?>
                    			<input type='submit' style='padding:15px; margin:0;font-size:11px;' id="submit_gds_updates" name='submit_gds_changes' value='Next'>
                        		</form>
								<?php
                    		}
                    		
                    		?>
							<script>
							document.addEventListener('DOMContentLoaded', function () {
							  const submitBtn = document.getElementById('submit_gds_updates');

							  function getDateFields() {
								// Covers inputs/selects/textareas with these classes
								return Array.from(document.querySelectorAll('.Dep_date, .Arr_date'));
							  }

							  function hasValue(el) {
								// Treats whitespace-only as empty
								return typeof el.value === 'string' && el.value.trim() !== '';
							  }

							  function updateButtonState() {
								const fields = getDateFields();
								const allFilled = fields.length > 0 && fields.every(hasValue);
								submitBtn.disabled = !allFilled;
								submitBtn.title = allFilled ? '' : 'Please fill all Dep_date and Arr_date fields';
								// Optional: subtle visual cue
								submitBtn.style.opacity = submitBtn.disabled ? '0.6' : '';
								submitBtn.style.pointerEvents = submitBtn.disabled ? 'none' : '';
							  }

							  function bindFieldEvents() {
								getDateFields().forEach(el => {
								  // Avoid rebinding
								  if (el._dateWatcherBound) return;
								  el.addEventListener('input', updateButtonState);
								  el.addEventListener('change', updateButtonState);
								  el._dateWatcherBound = true;
								});
							  }

							  // Initial bind + state
							  bindFieldEvents();
							  updateButtonState();

							  // Watch for dynamically added/removed fields
							  const mo = new MutationObserver(() => {
								bindFieldEvents();
								updateButtonState();
							  });
							  mo.observe(document.body, { childList: true, subtree: true, attributes: true, attributeFilter: ['class', 'value'] });

							  // Safety net if something updates value without firing events
							  setInterval(updateButtonState, 2000);
							});
							</script>

                    		<script>
        					$(document).on('change', '#travel_date_int', function(){
        					    
        					    var dc_amount = document.getElementById('dc_amount').value;
        					    if(dc_amount != '')
        					    {
        					        var responsemsg_received = '';
            						var form_data = new FormData(); // create a new FormData object
            						// add any data to the form_data object, as needed
            						form_data.append('req_type', 'movements_getproductid');
            						form_data.append('date', $('#travel_date_int').val());
            						form_data.append('tripcode', $('#trip_code').val());
            						$.ajax({
            							url: "/wp-content/themes/twentytwenty/templates/tpl_backend_functions.php",
            							method: "POST",
            							dataType: "json",
            							data: form_data,
            							contentType: false,
            							cache: false,
            							processData: false,
            							success: function (response) {
            								var id = response.id;
            								var title = response.title;
            								var pnr = response.pnr;
            								var pricingid = response.pricingid;
            								document.getElementById('new_product_id').value = id;
            								document.getElementById('product_title').value = title;
            								document.getElementById('pnr').value = pnr;
            								console.log(response);
            								change_total_price(pricingid);
            							},
            							error: function(xhr, textStatus, errorThrown) {
            								console.log(errorThrown);
            							}
            						});
        					    }
        					    else
        					    {
        					        alert("Please add the Datechange amount to proceed further.");
        					        document.getElementById('travel_date_int').value = '';
        					    }
        						
        					});
        					$(document).on('change', '#trip_code', function(){
        					    
        					    var dc_amount = document.getElementById('dc_amount').value;
        					    if(dc_amount != '')
        					    {
            						var responsemsg_received = '';
            						var form_data = new FormData(); // create a new FormData object
            						// add any data to the form_data object, as needed
            						form_data.append('req_type', 'movements_getproductid');
            						form_data.append('date', $('#travel_date_int').val());
            						form_data.append('tripcode', $('#trip_code').val());
            						$.ajax({
            							url: "/wp-content/themes/twentytwenty/templates/tpl_backend_functions.php",
            							method: "POST",
            							dataType: "json",
            							data: form_data,
            							contentType: false,
            							cache: false,
            							processData: false,
            							success: function (response) {
            								var id = response.id;
            								var title = response.title;
            								var pnr = response.pnr;
            								var pricingid = response.pricingid;
            								document.getElementById('new_product_id').value = id;
            								document.getElementById('product_title').value = title;
            								document.getElementById('pnr').value = pnr;
            								console.log(response);
            								change_total_price(pricingid);
            							},
            							error: function(xhr, textStatus, errorThrown) {
            								console.log(errorThrown);
            							}
            						});
        					    }
        					    else
        					    {
        					        alert("Please add the Datechange amount to proceed further.");
        					        document.getElementById('trip_code').value = '';
        					    }
        					    
        					});
				            </script>
                    		
                    		<?php
                    		
						   if (isset($_POST['submit_gds_changes'])) 
						   {
							
								//echo '<pre>'; print_r($_POST); echo '</pre>';

								// Combine all flight field arrays into pipe-separated strings
								$pnr_array = $_POST['PNRarray'] ?? [];
								$origin_codes = $_POST['Origin_Code'] ?? [];
								$destination_codes = $_POST['destination_code'] ?? [];
								$dep_dates = $_POST['Dep_date'] ?? [];
								$dep_times = $_POST['Dep_Time'] ?? [];
								$arr_dates = $_POST['Arr_date'] ?? [];
								$arr_times = $_POST['Arr_Time'] ?? [];
								$equipment_codes = $_POST['Equipment_Code'] ?? [];
								$equipment_names = $_POST['Equipment_Name'] ?? [];
								$flight_codes = $_POST['flight_code'] ?? [];
								$flight_numbers = $_POST['flight_number'] ?? [];
								$Dep_Terminal = $_POST['Dep_Terminal'] ?? [];
								$Arr_Terminal = $_POST['Arr_Terminal'] ?? [];
								
								$flight_Status = $_POST['Status'] ?? [];
								$flight_Meal = $_POST['Meal'] ?? [];
								$flight_Class = $_POST['Class'] ?? [];
								
								$total_amount = $_POST['total_amount'];

								
								$dep_datetime_combined = [];
								$arr_datetime_combined = [];

								foreach ($dep_dates as $i => $date) {
									$time = $dep_times[$i] ?? '00:00';
									$datetime = DateTime::createFromFormat('Y-m-d H:i', "$date $time");
									$dep_datetime_combined[] = $datetime ? $datetime->format('Y-m-d H:i:s') : '';
								}
								$travel_date_combined = $dep_datetime_combined[0];
								
								$return_date_combined = $dep_datetime_combined[0];
								foreach ($arr_dates as $i => $date) {
									$time = $arr_times[$i] ?? '00:00';
									$datetime = DateTime::createFromFormat('Y-m-d H:i', "$date $time");
									$arr_datetime_combined[] = $datetime ? $datetime->format('Y-m-d H:i:s') : '';
									$return_date_combined = $datetime ? $datetime->format('Y-m-d H:i:s') : '';
								}

								$manualFields = $_POST['manual_fields_log'] ?? '';
								$manualFieldsArray = array_filter(array_map('trim', explode(',', $manualFields)));

								foreach ($manualFieldsArray as $fieldName) {
									mysqli_query($mysqli,"insert into wpk4_backend_history_of_updates (type_id, meta_key, meta_value, updated_by, updated_on ) 
									values ('$order_id', 'Manually Updated Field', '$manualFields', '$currnt_userlogined', '$current_date_and_time')") or die(mysqli_error($mysqli));
								}

								$combined_flight_no = implode(' | ', array_map(fn($f) => substr($f, 2), $flight_numbers));
								$combined_airlinecode = implode(' | ', array_map(fn($f) => substr($f, 0, 2), $flight_numbers));


								// Combine fields
								$combined_data = [
									'Flightlegs DepApt'       => implode(' | ', $origin_codes),
									'Flightlegs DestApt' => implode(' | ', $destination_codes),
									'Flightlegs Equipment'   => implode(' | ', $equipment_codes),
									//'Equipment_Name_combined'   => implode(' | ', $equipment_names),
									//'Flight_Code_combined'      => implode(' | ', $flight_codes),
									'Flightlegs FlNr'    => $combined_flight_no,
									'Flightlegs OperatingCarrier'    => implode(' | ', $flight_codes),
									'Flightlegs MarketingCarrier'    => implode(' | ', $flight_codes),
									'Flightlegs Status'    => implode(' | ', $flight_Status),
									'Flightlegs Elapsed'    => implode(' | ', []),
									'Flightlegs Meal'    => implode(' | ', $flight_Meal),
									'Flightlegs Class'    => implode(' | ', $flight_Class),
									'Flightlegs CrFileKey'    => implode(' | ', $pnr_array),
									'Flightlegs DepTerminal'    => implode(' | ', $Dep_Terminal),
									'Flightlegs DestTerminal'    => implode(' | ', $Arr_Terminal),
								];
								
								// Add to main array
								$combined_data['Flightlegs DepTime'] = implode(' | ', $dep_datetime_combined);
								$combined_data['Flightlegs DestTime'] = implode(' | ', $arr_datetime_combined);

								// Get first origin and last destination
								$first_origin = $origin_codes[0] ?? '';
								$last_destination = end($destination_codes) ?: '';
								$pnr_final = $pnr_array[0];

								// Get first dep datetime and last arr datetime
								$first_dep_date = $dep_dates[0] ?? '';
								$first_dep_time = $dep_times[0] ?? '';
								$last_arr_date = end($arr_dates) ?: '';
								$last_arr_time = end($arr_times) ?: '';

								// Convert to datetime strings
								$first_dep_datetime = $first_dep_date . ' ' . $first_dep_time;
								$last_arr_datetime = $last_arr_date . ' ' . $last_arr_time;

								// Parse datetime objects
								$start = DateTime::createFromFormat('Y-m-d H:i:s', $travel_date_combined);
								$end = DateTime::createFromFormat('Y-m-d H:i:s', $return_date_combined);

								// Calculate trip type
								$trip_type = 'oneway';
								$return_point_found = false;
								$return_point_index = null;

								// Parse first departure datetime
								

								// Loop through all arrival datetimes to find a gap of more than 3 days
								foreach ($dep_datetime_combined as $i => $arr_datetime_str) {
									$arr_datetime_obj = DateTime::createFromFormat('Y-m-d H:i:s', $arr_datetime_str);
									$first_dep_datetime_obj = DateTime::createFromFormat('Y-m-d H:i:s', $arr_datetime_combined[$i - 1] ?? '');

									if ($first_dep_datetime_obj && $arr_datetime_obj) {
										$diff_days = $first_dep_datetime_obj->diff($arr_datetime_obj)->days;

										if ($diff_days > 3) {
											$trip_type = 'return';
											$return_point_found = true;
											$return_point_index = $i;
											break; // Stop at first segment with 3+ day gap
										}
									}
								}

								// Set return_date_combined only if return found
								if ($return_point_found && isset($dep_datetime_combined[$return_point_index])) {
									$return_date_combined = $dep_datetime_combined[$return_point_index];
								}

								// Optional: identify return destination code
								$return_destination_code = $return_point_found && isset($origin_codes[$return_point_index])
									? $origin_codes[$return_point_index]
									: '';
								
								$tripcode_combined = $first_origin . '-' . $return_destination_code;

								//echo "Trip Type: $trip_type\n";
								if ($trip_type === 'return') {

									//echo "Return starts at segment $return_point_index to: $return_destination_code\n";
									//echo "Return date: $return_date_combined\n";
								}


								// Output for verification
								/*echo "<pre>";
								echo "PNR: $pnr_final\n";
								echo "First Origin: $first_origin\n";
								echo "Last Destination: $last_destination\n";
								echo "Departure: $first_dep_datetime\n";
								echo "Arrival: $last_arr_datetime\n";
								echo "Trip Type: $trip_type\n";
								//print_r($combined_data);
								echo "</pre>";*/
								
								
								
								
								$product_id = '';
								$order_type = 'gds';
								
								echo $tripcode_combined . ' tripcode</br>';
								echo $travel_date_combined . ' travel</br>';
								echo $return_date_combined . ' return</br>';
								
								//echo '<pre>';
								//print_r($combined_data);
								//echo '</pre>';
								
								foreach ($combined_data as $key => $value)
								{
									// Escape key and value for safety
									$safe_key   = mysqli_real_escape_string($mysqli, $key);
									$safe_value = mysqli_real_escape_string($mysqli, $value);
									$safe_order_id = mysqli_real_escape_string($mysqli, $order_id);

									// Try to update
									$sql_update = "
										UPDATE wpk4_backend_history_of_updates
										SET meta_value = '$safe_value'
										WHERE type_id = '$safe_order_id' AND meta_key = '$safe_key'
									";

									$result = mysqli_query($mysqli, $sql_update);

									if (!$result) {
										error_log("Failed to update $safe_key: " . mysqli_error($mysqli));
										continue;
									}

									// If no rows were updated, insert instead
									if (mysqli_affected_rows($mysqli) === 0) {
										$sql_insert = "
											INSERT INTO wpk4_backend_history_of_updates (type_id, meta_key, meta_value)
											VALUES ('$safe_order_id', '$safe_key', '$safe_value')
										";

										$insert_result = mysqli_query($mysqli, $sql_insert);

										if (!$insert_result) {
											error_log("Failed to insert $safe_key: " . mysqli_error($mysqli));
										}
									}
								}

								
								$trip_price_value = '0';
								foreach ($_POST as $key2 => $value2) 
								{
									if (strpos($key2, 'total_amount') === 0) 
									{
										$trip_price_value = $value2;
									}
								}
								


								$tripcode_entered = $tripcode_combined;
								foreach ($_POST as $key3 => $value3) 
								{
									if (strpos($key3, 'tripcode_route_') === 0) 
									{
										$tripcode_entered = $value3;
									}
								}
								
								$dc_amount = '0';
								$total_amount_dc = '0';
								foreach ($_POST as $key2 => $value2) 
								{
									if (strpos($key2, 'total_amount') === 0) 
									{
										$total_amount_dc = $value2;
										$dc_amount = $value2;
										
										$total_amount_dc = number_format((float)$total_amount_dc, 2, '.', '') ;
										$dc_amount = number_format((float)$dc_amount, 2, '.', '') ;
									}
								}
								
								
								$all_pax_query_ticket_finder_booking = "SELECT previous_order_id FROM wpk4_backend_travel_bookings WHERE order_id = '$order_id' ";
								$result_all_pax_ticket_finder_booking = mysqli_query($mysqli, $all_pax_query_ticket_finder_booking) or die(" Pax query failed: " . mysqli_error($mysqli));
								$pax_ticket_finder_booking = mysqli_fetch_assoc($result_all_pax_ticket_finder_booking);
								$previous_order_id_new = $pax_ticket_finder_booking['previous_order_id'];
								
								$all_pax_query_ticket_finder_booking2 = "SELECT order_id, product_id FROM wpk4_backend_travel_bookings WHERE order_id = '$previous_order_id_new' ";
								echo $all_pax_query_ticket_finder_booking2.'</br>';
								$result_all_pax_ticket_finder_booking2 = mysqli_query($mysqli, $all_pax_query_ticket_finder_booking2) or die(" Pax query failed: " . mysqli_error($mysqli));
								$pax_ticket_finder_booking2 = mysqli_fetch_assoc($result_all_pax_ticket_finder_booking2);
								$previous_product_id_new = $pax_ticket_finder_booking2['product_id'];
								
								
								$is_ticketed = 0;
								$all_pax_query_ticket_finder = "SELECT ticket_number FROM wpk4_backend_travel_booking_pax WHERE order_id = '$previous_order_id_new' and product_id = '$previous_product_id_new' and ticket_number is not null";
								$result_all_pax_ticket_finder = mysqli_query($mysqli, $all_pax_query_ticket_finder) or die(" Pax query failed: " . mysqli_error($mysqli));
								while ($pax_ticket_finder = mysqli_fetch_assoc($result_all_pax_ticket_finder)) 
								{
									if($pax_ticket_finder['ticket_number'] != '')
									{
										$is_ticketed = 1;
										break;
									}
								}
								
								if($total_amount > 0)
								{
									$total_calculated = $total_amount;
									if(isset($_GET['new_oid']) && $_GET['new_oid'] != '') // Partial DC
									{										
										$query_amt_check2 = "SELECT meta_value FROM wpk4_backend_history_of_updates where type_id = '$order_id' and meta_key = 'Transaction TotalTurnover'";
										$result_amt_check2 = mysqli_query($mysqli, $query_amt_check2);
										if(mysqli_num_rows($result_amt_check2) > 0 )
										{
											$row_amt_check2 = mysqli_fetch_assoc($result_amt_check2);
											$total_amount_existing = $row_amt_check2['meta_value'];
											
											$total_calculated = (float)$total_amount + (float)$total_amount_existing;
											$total_calculated = number_format((float)$total_calculated, 2, '.', '') ;
														
										}
									}
									else // Full dc
									{
										if($is_ticketed == 0) // no ticket issued
										{
											$query_amt_check2 = "SELECT meta_value FROM wpk4_backend_history_of_updates where type_id = '$order_id' and meta_key = 'Transaction TotalTurnover'";
											$result_amt_check2 = mysqli_query($mysqli, $query_amt_check2);
											if(mysqli_num_rows($result_amt_check2) > 0 )
											{
												$row_amt_check2 = mysqli_fetch_assoc($result_amt_check2);
												$total_amount_existing = $row_amt_check2['meta_value'];
												
												$total_calculated = (float)$total_amount + (float)$total_amount_existing;
												$total_calculated = number_format((float)$total_calculated, 2, '.', '') ;
											}
											
										}
										else
										{
											$total_calculated = $total_amount;
										}
									}
									
									$update_query5 = "UPDATE wpk4_backend_travel_bookings SET total_amount = '$total_calculated', deposit_amount='0', balance = '0' WHERE order_id = '$order_id'";
									//echo $update_query5.'</br>';
									$result5 = mysqli_query($mysqli, $update_query5);
									
									$update_query_turnover = "UPDATE wpk4_backend_history_of_updates SET meta_value = '$total_calculated' WHERE type_id = '$order_id' and meta_key = 'Transaction TotalTurnover'";
									$result_turnover = mysqli_query($mysqli, $update_query_turnover);
									
									$update_query_amt = "UPDATE wpk4_backend_history_of_updates SET meta_value = '$total_calculated' WHERE type_id = '$order_id' and meta_key = 'Payments Amount'";
									$result_amt = mysqli_query($mysqli, $update_query_amt);
									
									mysqli_query($mysqli,"insert into wpk4_backend_travel_bookings_datechange (order_id, dc_amount, total_amount, added_by, added_on ) 
									values ('$order_id', '$total_amount', '$total_calculated', 'date_change', '$current_date_and_time')") or die(mysqli_error($mysqli));
									
									
									//mysqli_query($mysqli,"insert into wpk4_backend_travel_bookings_datechange (order_id, dc_amount, total_amount, added_by, added_on ) 
									//values ('$order_id', '$dc_amount', '$total_amount_dc', 'date_change', '$current_date_and_time')") or die(mysqli_error($mysqli));
									
									//$update_query5 = "UPDATE wpk4_backend_travel_bookings SET total_amount = '$dc_amount', deposit_amount='0', balance = '$dc_amount' WHERE order_id = '$order_id'";
									//echo $update_query5.'</br>';
									//$result5 = mysqli_query($mysqli, $update_query5);
								}
								
								$update_query3 = "UPDATE wpk4_backend_travel_booking_pax SET pnr = '$pnr_final' WHERE order_id = '$order_id' and ( product_id = '$product_id' OR product_id = '' )";
								//echo $update_query3.'</br>';
								$result3 = mysqli_query($mysqli, $update_query3);
								
								
								
								$totalAmountRequest = $_POST['total_amount'];
								$airline_change_fee = $_POST['airline_change_fee'];
								$fare_difference = $_POST['fare_difference'];
								$gaura_service_fee = $_POST['gaura_service_fee'];
								$buffer = $_POST['buffer'];
								
								$row_case_id = '';
								$query_case_checker = "SELECT case_id FROM wpk4_backend_user_portal_requests WHERE reservation_ref = '$order_id'";
								$result_case_checker = mysqli_query($mysqli, $query_case_checker);	
								if(mysqli_num_rows($result_case_checker) > 0)
								{
									$row_case_checker = mysqli_fetch_assoc($result_case_checker);
									$row_case_id = $row_case_checker['case_id'] ;
								}

								mysqli_query($mysqli,"insert into wpk4_backend_travel_bookings_datechange_cost_breakdown (case_id, order_id, airline_change_fee, fare_difference, gaura_service_fee, buffer, total_amount, added_by, submit_source ) 
								values ('$row_case_id', '$order_id', '$airline_change_fee', '$fare_difference', '$gaura_service_fee', '$buffer', '$totalAmountRequest', '$currnt_userlogined', 'CS DC')") or die(mysqli_error($mysqli));
								
								
								$update_query = "UPDATE wpk4_backend_travel_bookings SET trip_code = '$tripcode_entered', travel_date = '$travel_date_combined', return_date = '$return_date_combined', product_id = '', t_type = '$trip_type' WHERE order_id = $order_id";
								//echo $update_query.'</br>';
								$result = mysqli_query($mysqli, $update_query);
								
								$update_query4 = "UPDATE wpk4_backend_travel_booking_pax SET product_id = '' WHERE order_id = '$order_id'";
								$result4 = mysqli_query($mysqli, $update_query4);

								$update_query5 = "UPDATE wpk4_backend_travel_bookings SET product_id = '' WHERE order_id = '$order_id'";
								$result5 = mysqli_query($mysqli, $update_query5);

								//echo $update_query4.'</br>';
								$new_order_id = $_GET['new_oid'] ?? '';
								
								echo '<script>window.location.href="?p=manage-datechange-v1&part=generate-payment-link&oid='.$order_id.'&coid='.$co_order_id.'&new_oid='.$new_order_id.'";</script>';

							}

						}
						
						if(isset($_GET['p']) && $_GET['p'] =='manage-datechange-v1' && isset($_GET['part']) && $_GET['part'] == 'booking-info-update')
						{
						    echo '</br></br></br>';
						    $order_id = $_GET['oid'];
							$co_order_id = $_GET['coid'] ?? '';
							
						    
						    $query_pax = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id' order by travel_date asc limit 1";
							//echo $query_pax;
                    		$result_pax = mysqli_query($mysqli, $query_pax);
                    		?>
                    		<h6>Order ID : <?php echo $order_id; ?></h6>
                    		<?php
                    		if(!empty($result_pax))
                    		{
                    		    ?>
								<script src="https://cdn.jsdelivr.net/gh/alumuko/vanilla-datetimerange-picker@latest/dist/vanilla-datetimerange-picker.js"></script>
								<script>
									window.addEventListener("load", function (event) {
									let drp = new DateRangePicker('travel_date_int',
											{
												
												timePicker: false,
												alwaysShowCalendars: true,
												singleDatePicker: true,
												autoApply: true,
												autoUpdateInput: true,
												
												locale: {
													format: "YYYY-MM-DD 00:00:00",
												}
											},
											function (start) {
												var startdate = start.format().substring(0,10);
												document.getElementById("travel_date_int").value = startdate;
												
											})
									});
									
									window.addEventListener("load", function (event) {
									let drp = new DateRangePicker('travel_date_fit',
											{
												
												timePicker: false,
												alwaysShowCalendars: true,
												singleDatePicker: true,
												autoApply: true,
												autoUpdateInput: true,
												
												locale: {
													format: "YYYY-MM-DD HH:mm:ss",
												}
											},
											function (start) {
												document.getElementById("travel_date_fit").value = start.format();
												
											})
									});
									
									window.addEventListener("load", function (event) {
									let drp = new DateRangePicker('return_date_fit',
											{
												
												timePicker: false,
												alwaysShowCalendars: true,
												singleDatePicker: true,
												autoApply: true,
												autoUpdateInput: true,
												
												locale: {
													format: "YYYY-MM-DD HH:mm:ss",
												}
											},
											function (start) {
												document.getElementById("return_date_fit").value = start.format();
												
											})
									});
								</script>
                    		    <form action="#" name="statusupdate" method="post" enctype="multipart/form-data" style='font-size:13px;'>
                    		    <?php
                    			$row_pax = mysqli_fetch_assoc($result_pax);
                    			{
                    			    $auto_id = $row_pax['auto_id'];
                    				$order_id = $row_pax['order_id'];
                    				$co_order_id_db = $row_pax['co_order_id'];
                    				$product_id = $row_pax['product_id'];
                    				$order_type = $row_pax['order_type'];
                    				$t_type = $row_pax['t_type'];
                    				$total_pax = $row_pax['total_pax'];
									$previous_order_id_sql = $row_pax['previous_order_id'];
									
									$query_pax_2 = "SELECT pnr FROM wpk4_backend_travel_booking_pax where order_id='$previous_order_id_sql' and (product_id = '$product_id' OR product_id = '') order by auto_id asc limit 1";
									$result_pax_2 = mysqli_query($mysqli, $query_pax_2);
									$row_pax_2 = mysqli_fetch_assoc($result_pax_2);
									$pnr = $row_pax_2['pnr'];
                    				?>
                    			    Airline Change Fee
									<input type='text' name='airline_change_fee' required id='airline_change_fee'></br>
									
									Fare Difference
									<input type='text' name='fare_difference' required id='fare_difference'></br>
									
									Gaura Travel Service Fee
									<input type='text' name='gaura_service_fee' required id='gaura_service_fee'></br>
									
									Buffer
									<input type='text' name='buffer' required id='buffer'></br>
									
									Cost Given / Datechange Amount (Amount to be requested from customer)
                        			<input type='text' name='total_amount' required id='dc_amount'></br>
									
                    			    <h6>Tripcode : <?php echo $row_pax['trip_code']; ?></h6>
                    				<?php
                    				
                    				echo "<input type='hidden' name='order_type_<?php echo $auto_id; ?>' value='".$order_type."' id='searchkeyvalue'>";
                    				echo "<input type='hidden' name='total_pax_<?php echo $auto_id; ?>' value='".$total_pax."' id='total_pax'>";
                    				if($order_type != 'gds') // wpt
                    				{
                    				    ?>
                        				    Trip code
                        				    <input type='text' name='trip_code_<?php echo $auto_id; ?>' required id='trip_code' value="<?php echo $row_pax['trip_code']; ?>"></br>
                        				    Travel date
                        				    <input type='text' name='travel_date_<?php echo $auto_id; ?>' required id='travel_date_int' value="<?php echo $row_pax['travel_date']; ?>"></br>
                        				    Product ID
                        				    <input type='text' readonly name='product_id_<?php echo $auto_id; ?>' required id='new_product_id' value="<?php echo $row_pax['product_id']; ?>"></br>
                        				    Product Title
                        				    <input type='text' readonly name='product_title_<?php echo $auto_id; ?>' required id='product_title' value="<?php echo $row_pax['product_title']; ?>">
                        				    <input type='hidden' readonly name='current_product_id_<?php echo $auto_id; ?>' id='searchkeyvalue' value="<?php echo $product_id; ?>">
                        				    </br>
                        				    PNR
                        				    <input type='text' name='pnr_<?php echo $auto_id; ?>' required id='pnr' value="<?php echo $pnr; ?>">
                        				    </br>
                        				    
                    				    <?php
                    				}
                    				
									if(1 == 2)
                    				{
                    				?>
                    				        Trip code
                        				    <input type='text' name='trip_code_<?php echo $auto_id; ?>' required id='searchkeyvalue' value="<?php echo $row_pax['trip_code']; ?>"></br>
                        				    Travel Date
                        				    <input type='text' name='travel_date_<?php echo $auto_id; ?>'required id='travel_date_fit' value="<?php echo $row_pax['travel_date']; ?>"></br>
                        				    Return Date
                        				    <input type='text' name='return_date_<?php echo $auto_id; ?>' required id='return_date_fit' value="<?php echo $row_pax['return_date']; ?>"></br>
                        				    
                        				    Trip Type
                        				    <input type='text' name='t_type_<?php echo $auto_id; ?>' required value="<?php echo $t_type; ?>"  id='searchkeyvalue'></br>
                        				    
                        				    PNR
                        				    <input type='text' name='pnr_<?php echo $auto_id; ?>' required id='pnr' value="<?php echo $pnr; ?>"></br>
                        				    <input type='hidden' readonly name='product_id_<?php echo $auto_id; ?>' id='new_product_id' value="">
											<!--
											Total Amount
                        				    <input type='text' readonly name='total_amount_<?php echo $auto_id; ?>' id='total_amount'></br>
                        				    </br>-->
                    				    <?php
                    				}
                    			}
                    			echo "<input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='submit_gds_changes' id='submit_gds_changes' value='Next'>
                        		</form>";
                    		}
                    		
                    		?>
                    		
        					<script>
document.addEventListener('DOMContentLoaded', function () {
    const travelInput = document.getElementById('travel_date_int');
    const tripCode = document.getElementById('trip_code');
    const submitBtn = document.getElementById('submit_gds_changes');
    const dcAmount = document.getElementById('dc_amount');

    let previousValue = '';

    // --- Add Fetch Product button after travel date field ---
    const fetchBtn = document.createElement('button');
    fetchBtn.type = 'button';
	fetchBtn.id = 'fetch_product_btn';
	fetchBtn.textContent = 'Fetch Product';
	fetchBtn.className = 'button button-primary';
	fetchBtn.style.fontSize = '12px';
	fetchBtn.style.margin = '15px 0';
	fetchBtn.style.marginLeft = '8px';
    travelInput.insertAdjacentElement('afterend', fetchBtn);

    // --- Utility to toggle button visibility ---
    function checkFields() {
        const pnr = document.getElementById('pnr').value.trim();
        const title = document.getElementById('product_title').value.trim();
        const product = document.getElementById('new_product_id').value.trim();

        if (pnr !== '' && title !== '' && product !== '') {
            submitBtn.style.display = 'inline-block'; // show button
        } else {
            submitBtn.style.display = 'none'; // hide button
        }
    }

    // --- AJAX function for reuse ---
    function fetchProductData(dateVal, tripVal) {
        const dc_amount = dcAmount.value;
        if (dc_amount === '') {
            alert("Please add the Datechange amount to proceed further.");
            if (dateVal) travelInput.value = '';
            if (tripVal) tripCode.value = '';
            return;
        }

        const form_data = new FormData();
        form_data.append('req_type', 'movements_getproductid');
        form_data.append('date', dateVal);
        form_data.append('tripcode', tripVal);

        // Hide submit button until update completes
        submitBtn.style.display = 'none';

        $.ajax({
            url: "/wp-content/themes/twentytwenty/templates/tpl_backend_functions.php",
            method: "POST",
            dataType: "json",
            data: form_data,
            contentType: false,
            cache: false,
            processData: false,
            success: function (response) {
                $('#new_product_id').val(response.id);
                $('#product_title').val(response.title);
                $('#pnr').val(response.pnr);
                console.log(response);
                checkFields(); // Show submit button if ready
            },
            error: function (xhr, textStatus, errorThrown) {
                console.log(errorThrown);
                checkFields();
            }
        });
    }

    // --- Handle Fetch Button click ---
    fetchBtn.addEventListener('click', function () {
        const dateVal = travelInput.value.trim();
        const tripVal = tripCode.value.trim();

        if (dateVal === '' || tripVal === '') {
            alert('Please select both Travel Date and Trip Code before fetching.');
            return;
        }

        fetchProductData(dateVal, tripVal);
    });

    // --- Just recheck submit visibility when typing ---
    travelInput.addEventListener('input', checkFields);
    tripCode.addEventListener('change', checkFields);
});
</script>


                    		
                    		<?php
                    		
                    		if (isset($_POST['submit_gds_changes'])) 
                    		{
								
								$totalAmount = $_POST['total_amount'];
								
                                foreach ($_POST as $key => $value) {
                                    // Match field pattern like trip_code_123, travel_date_123 etc.
                                    if (preg_match('/^(trip_code|travel_date|return_date|product_id|t_type|total_amount|product_title)_(\d+)$/', $key, $matches)) {
                                        $field = $matches[1];            // e.g., trip_code
                                        $auto_id = $matches[2];          // e.g., 123
                                        $safe_value = mysqli_real_escape_string($mysqli, $value);
                            
                                        // Organize values for each auto_id
                                        $update_data[$auto_id][$field] = $safe_value;
                                    }
                                    
                                }
                                
                                								
								$dc_amount = '0';
								$total_amount_dc = '0';
                                foreach ($_POST as $key2 => $value2) 
                                {
                                    if (strpos($key2, 'total_amount') === 0) 
                                    {
                                        $total_amount_dc = $value2;
										$dc_amount = $value2;
										
										$total_amount_dc = number_format((float)$total_amount_dc, 2, '.', '') ;
										$dc_amount = number_format((float)$dc_amount, 2, '.', '') ;
                                    }
                                }
								
								$all_pax_query_ticket_finder_booking = "SELECT previous_order_id FROM wpk4_backend_travel_bookings WHERE order_id = '$order_id' ";
								//echo $all_pax_query_ticket_finder_booking.'</br>';
								$result_all_pax_ticket_finder_booking = mysqli_query($mysqli, $all_pax_query_ticket_finder_booking) or die(" Pax query failed: " . mysqli_error($mysqli));
								$pax_ticket_finder_booking = mysqli_fetch_assoc($result_all_pax_ticket_finder_booking);
								$previous_order_id_new = $pax_ticket_finder_booking['previous_order_id'];
								
								$all_pax_query_ticket_finder_booking2 = "SELECT order_id, product_id FROM wpk4_backend_travel_bookings WHERE order_id = '$previous_order_id_new' ";
								//echo $all_pax_query_ticket_finder_booking2.'</br>';
								$result_all_pax_ticket_finder_booking2 = mysqli_query($mysqli, $all_pax_query_ticket_finder_booking2) or die(" Pax query failed: " . mysqli_error($mysqli));
								$pax_ticket_finder_booking2 = mysqli_fetch_assoc($result_all_pax_ticket_finder_booking2);
								$previous_product_id_new = $pax_ticket_finder_booking2['product_id'];
								
								$is_ticketed = 0;
								$all_pax_query_ticket_finder = "SELECT ticket_number FROM wpk4_backend_travel_booking_pax WHERE order_id = '$previous_order_id_new' and product_id = '$previous_product_id_new' and ticket_number is not null";
								//echo $all_pax_query_ticket_finder.'</br>';
								$result_all_pax_ticket_finder = mysqli_query($mysqli, $all_pax_query_ticket_finder) or die(" Pax query failed: " . mysqli_error($mysqli));
								while ($pax_ticket_finder = mysqli_fetch_assoc($result_all_pax_ticket_finder)) 
								{
									if($pax_ticket_finder['ticket_number'] != '')
									{
										$is_ticketed = 1;
										break;
									}
								}
								//echo '1</br>';
								if($totalAmount > 0)
								{
									//echo '2</br>';
									if(isset($_GET['new_oid']) && $_GET['new_oid'] != '') // Partial DC
									{
										//echo '3</br>';
										$query_amt_check = "SELECT total_amount FROM wpk4_backend_travel_bookings where order_id = '$order_id'";
										$result_amt_check = mysqli_query($mysqli, $query_amt_check);
										if(mysqli_num_rows($result_amt_check) > 0 )
										{
											//echo '4</br>';
											$row_amt_check = mysqli_fetch_assoc($result_amt_check);
											$total_amount_existing = $row_amt_check['total_amount'];
											
											$total_calculated = (float)$dc_amount + (float)$total_amount_existing;
											$total_calculated = number_format((float)$total_calculated, 2, '.', '') ;
										}
									}
									else
									{
										//echo '5</br>';
										if($is_ticketed == 0) // no ticket issued
										{
											//echo '6</br>';
											$query_amt_check = "SELECT total_amount FROM wpk4_backend_travel_bookings where order_id = '$order_id'";
											$result_amt_check = mysqli_query($mysqli, $query_amt_check);
											if(mysqli_num_rows($result_amt_check) > 0 )
											{
												//echo '7</br>';
												$row_amt_check = mysqli_fetch_assoc($result_amt_check);
												$total_amount_existing = $row_amt_check['total_amount'];
												
												$total_calculated = (float)$dc_amount + (float)$total_amount_existing;
												$total_calculated = number_format((float)$total_calculated, 2, '.', '') ;
											}
										}
										else 
										{
											//echo '8</br>';
											$total_calculated = $dc_amount;
										}
									}
									//echo '9</br>';
									
									$update_query5 = "UPDATE wpk4_backend_travel_bookings SET total_amount = '$total_calculated', deposit_amount='0', balance = '0' WHERE order_id = '$order_id'";
									//echo $update_query5.'</br>';
									$result5 = mysqli_query($mysqli, $update_query5);
									
									mysqli_query($mysqli,"insert into wpk4_backend_travel_bookings_datechange (order_id, dc_amount, total_amount, added_by, added_on ) 
									values ('$order_id', '$dc_amount', '$total_calculated', 'date_change', '$current_date_and_time')") or die(mysqli_error($mysqli));
									
									
								}
								
								$pnr = '';
								foreach ($_POST as $key3 => $value3) 
                                {
                                    if (strpos($key3, 'pnr_') === 0) 
                                    {
										$pnr = $value3;
                                    }
                                }
								//if($pnr != '')
								{
									$update_query3 = "UPDATE wpk4_backend_travel_booking_pax SET pnr = '$pnr' WHERE order_id = '$order_id' and ( product_id = '$product_id' OR product_id = '' )";
									//echo $update_query3.'</br>';
                                    $result3 = mysqli_query($mysqli, $update_query3);
								}
								
								$product_id_pax = '';
								foreach ($_POST as $key4 => $value4) 
                                {
                                    if (strpos($key4, 'product_id_') === 0) 
                                    {
										$product_id_pax = $value4;
                                    }
                                }
								if($product_id_pax != '' && $order_type != 'gds')
								{
									$update_query4 = "UPDATE wpk4_backend_travel_booking_pax SET product_id = '$product_id_pax' WHERE order_id = '$order_id' and ( product_id = '$product_id' OR product_id = '' )";
									//echo $update_query4.'</br>';
                                    $result4 = mysqli_query($mysqli, $update_query4);
								}
								
								if($order_type == 'gds')
								{
									$update_query4 = "UPDATE wpk4_backend_travel_booking_pax SET product_id = '' WHERE order_id = '$order_id'";
                                    $result4 = mysqli_query($mysqli, $update_query4);
									//echo $update_query4.'</br>';
								}
								
								
								$totalAmountRequest = $_POST['total_amount'];
								
								$airline_change_fee = $_POST['airline_change_fee'];
								$fare_difference = $_POST['fare_difference'];
								$gaura_service_fee = $_POST['gaura_service_fee'];
								$buffer = $_POST['buffer'];
								
								$row_case_id = '';
								$query_case_checker = "SELECT case_id FROM wpk4_backend_user_portal_requests WHERE reservation_ref = '$order_id'";
								$result_case_checker = mysqli_query($mysqli, $query_case_checker);	
								if(mysqli_num_rows($result_case_checker) > 0)
								{
									$row_case_checker = mysqli_fetch_assoc($result_case_checker);
									$row_case_id = $row_case_checker['case_id'] ;
								}

								mysqli_query($mysqli,"insert into wpk4_backend_travel_bookings_datechange_cost_breakdown (case_id, order_id, airline_change_fee, fare_difference, gaura_service_fee, buffer, total_amount, added_by, submit_source ) 
								values ('$row_case_id', '$order_id', '$airline_change_fee', '$fare_difference', '$gaura_service_fee', '$buffer', '$totalAmountRequest', '$currnt_userlogined', 'CS DC')") or die(mysqli_error($mysqli));
								
								// Now run update query for each auto_id
                                foreach ($update_data as $auto_id => $fields) {
                                    $set_clause_parts = [];
                                    foreach ($fields as $field => $value) {
                                        $set_clause_parts[] = "$field = '$value'";
                                    }
                                    $set_clause = implode(", ", $set_clause_parts);
                                    $update_query = "UPDATE wpk4_backend_travel_bookings SET $set_clause WHERE auto_id = $auto_id";
									//echo $update_query.'</br>';
                                    $result = mysqli_query($mysqli, $update_query);
                                    
                                    
                                    foreach ($fields as $field => $value) 
                                    {
                                        if($field == 'product_id' && $order_type == 'gds')
        								{
        									$update_query5 = "UPDATE wpk4_backend_travel_bookings SET product_id = '' WHERE auto_id = $auto_id";
                                            $result5 = mysqli_query($mysqli, $update_query5);
        								}
                                    }
    								
                                    if (!$result) 
                                    {
                                        echo "Error updating auto_id $auto_id: " . mysqli_error($mysqli) . "<br>";
                                    } 
                                    else 
                                    {
										
                                    }
                                }
								
								if($order_type != 'gds')
								{
									$query_stock_check = "SELECT trip_code, travel_date, total_pax FROM wpk4_backend_travel_bookings where auto_id = $auto_id and order_type != 'gds'";
									$result_stock_check = mysqli_query($mysqli, $query_stock_check);
									if(mysqli_num_rows($result_stock_check) > 0 )
                                    {
										$row_stock_check = mysqli_fetch_assoc($result_stock_check);
												
										$trip_code = $row_stock_check['trip_code'];
										$travel_date = $row_stock_check['travel_date'];
										$total_pax = $row_stock_check['total_pax'];
										
										update_stock_in_pricing_table($trip_code, $travel_date, $total_pax, 'positive');
										
										$by_user = 'dc_in_customer_portal';
																												
										availability_table_pax_update_positive($order_id, $by_user);
									}
								}
								
								$new_order_id = $_GET['new_oid'] ?? '';
                                $query_pax2 = "SELECT auto_id FROM wpk4_backend_travel_bookings where order_id='$order_id' and order_type != 'gds' and t_type = 'return'";
								$result_pax2 = mysqli_query($mysqli, $query_pax2);
								if(mysqli_num_rows($result_pax2) > 0 )
                                {
                                   echo '<script>window.location.href="?p=manage-datechange-v1&part=booking-info-update-return&oid='.$order_id.'&coid='.$co_order_id.'&new_oid='.$new_order_id.'";</script>';
                                }
                                else
                                {
                                   echo '<script>window.location.href="?p=manage-datechange-v1&part=generate-payment-link&oid='.$order_id.'&coid='.$co_order_id.'&new_oid='.$new_order_id.'";</script>';
                                }
                            }
						}
						
						if(isset($_GET['p']) && $_GET['p'] =='manage-datechange-v1' && isset($_GET['part']) && $_GET['part'] == 'booking-info-update-return')
						{
						    echo '</br></br></br>';
						    $order_id = $_GET['oid'];
						    $co_order_id = $_GET['coid'] ?? '';
							
						    $query_pax = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id' and co_order_id = '$co_order_id' order by travel_date desc limit 1";
                    		$result_pax = mysqli_query($mysqli, $query_pax);
                    		?>
                    		<h6>Order ID : <?php echo $order_id; ?></h6>
                    		<?php
                    		if(!empty($result_pax))
                    		{
                    		    ?>
								<script src="https://cdn.jsdelivr.net/gh/alumuko/vanilla-datetimerange-picker@latest/dist/vanilla-datetimerange-picker.js"></script>
								<script>
									window.addEventListener("load", function (event) {
									let drp = new DateRangePicker('travel_date_int',
											{
												
												timePicker: false,
												alwaysShowCalendars: true,
												singleDatePicker: true,
												autoApply: true,
												autoUpdateInput: true,
												
												locale: {
													format: "YYYY-MM-DD 00:00:00",
												}
											},
											function (start) {
												var startdate = start.format().substring(0,10);
												document.getElementById("travel_date_int").value = startdate;
												
											})
									});
								</script>
                    		    <form action="#" name="statusupdate" method="post" enctype="multipart/form-data" style='font-size:13px;'>
                    		    <?php
                    			$row_pax = mysqli_fetch_assoc($result_pax);
                    			{
                    			?>
                    			    <h6>Tripcode : <?php echo $row_pax['trip_code']; ?></h6>
                    				<?php
                    				$auto_id = $row_pax['auto_id'];
                    				$order_id = $row_pax['order_id'];
                    				$co_order_id_db = $row_pax['co_order_id'];
                    				$product_id = $row_pax['product_id'];
                    				$order_type = $row_pax['order_type'];
                    				$t_type = $row_pax['t_type'];
                    				$total_pax = $row_pax['total_pax'];
									$previous_order_id_sql = $row_pax['previous_order_id'];
									
									$query_pax_2 = "SELECT pnr FROM wpk4_backend_travel_booking_pax where order_id='$previous_order_id_sql' and (product_id = '$product_id' OR product_id = '') order by auto_id asc limit 1";
									$result_pax_2 = mysqli_query($mysqli, $query_pax_2);
									$row_pax_2 = mysqli_fetch_assoc($result_pax_2);
									$pnr = $row_pax_2['pnr'];
                    				
                    				echo "<input type='hidden' name='order_type_<?php echo $auto_id; ?>' value='".$order_type."' id='searchkeyvalue'>";
                    				echo "<input type='hidden' name='total_pax_<?php echo $auto_id; ?>' value='".$total_pax."' id='total_pax'>";
									
                    				if($order_type != 'gds') // wpt
                    				{
                    				    ?>
                        				    Trip code
                        				    <input type='text' name='trip_code_<?php echo $auto_id; ?>' required id='trip_code' value="<?php echo $row_pax['trip_code']; ?>"></br>
                        				    Travel date
                        				    <input type='text' name='travel_date_<?php echo $auto_id; ?>' required id='travel_date_int' value="<?php echo $row_pax['travel_date']; ?>"></br>
                        				    Product ID
                        				    <input type='text' name='product_id_<?php echo $auto_id; ?>' required id='new_product_id' value="<?php echo $row_pax['product_id']; ?>"></br>
                        				    Product Title
                        				    <input type='text' name='product_title_<?php echo $auto_id; ?>' required id='product_title' value="<?php echo $row_pax['product_title']; ?>">
                        				    <input type='hidden' name='current_product_id_<?php echo $auto_id; ?>' required id='searchkeyvalue' value="<?php echo $product_id; ?>">
                        				    </br>
                        				    PNR
                        				    <input type='text' name='pnr_<?php echo $auto_id; ?>' id='pnr' required value="<?php echo $row_pax_2['pnr']; ?>"></br>
                        				    <?php
                        				    $query_pax3 = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id' order by travel_date asc limit 1";
                    		                $result_pax3 = mysqli_query($mysqli, $query_pax3);
                                            $row_pax3 = mysqli_fetch_assoc($result_pax3);
                        				    ?>
                        				    
                        				    <input type='hidden' readonly name='total_amount_<?php echo $auto_id; ?>' id='total_amount' value="<?php echo $row_pax3['total_amount']; ?>"></br>
                    				    <?php
                    				}
                    			}
                    			echo "<input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='submit_gds_changes' id='submit_gds_changes' value='Next'>
                        		</form>";
                    		}
                    		
                    		?>
                    		<script>
document.addEventListener('DOMContentLoaded', function () {
    const travelInput = document.getElementById('travel_date_int');
    const tripCode = document.getElementById('trip_code');
    const submitBtn = document.getElementById('submit_gds_changes');

    let previousValue = '';

    // --- Insert Fetch button after travel date input ---
    const fetchBtn = document.createElement('button');
    fetchBtn.type = 'button';
	fetchBtn.id = 'fetch_product_btn';
	fetchBtn.textContent = 'Fetch Product';
	fetchBtn.className = 'button button-primary';
	fetchBtn.style.fontSize = '12px';
	fetchBtn.style.margin = '15px 0';
	fetchBtn.style.marginLeft = '8px';
    travelInput.insertAdjacentElement('afterend', fetchBtn);

    // --- Utility to toggle button visibility ---
    function checkFields() {
        const pnr = document.getElementById('pnr').value.trim();
        const title = document.getElementById('product_title').value.trim();
        const product = document.getElementById('new_product_id').value.trim();

        if (pnr !== '' && title !== '' && product !== '') {
            submitBtn.style.display = 'inline-block'; // show button
        } else {
            submitBtn.style.display = 'none'; // hide button
        }
    }

    // --- AJAX function ---
    function fetchProductData(dateVal, tripVal) {
        if (dateVal === '' || tripVal === '') {
            alert('Please select both Travel Date and Trip Code.');
            return;
        }

        const form_data = new FormData();
        form_data.append('req_type', 'movements_getproductid');
        form_data.append('date', dateVal);
        form_data.append('tripcode', tripVal);

        submitBtn.style.display = 'none';

        $.ajax({
            url: "/wp-content/themes/twentytwenty/templates/tpl_backend_functions.php",
            method: "POST",
            dataType: "json",
            data: form_data,
            contentType: false,
            cache: false,
            processData: false,
            success: function (response) {
                $('#new_product_id').val(response.id);
                $('#product_title').val(response.title);
                $('#pnr').val(response.pnr);
                console.log(response);
                checkFields();
            },
            error: function (xhr, textStatus, errorThrown) {
                console.log(errorThrown);
                checkFields();
            }
        });
    }

    // --- When Fetch button clicked ---
    fetchBtn.addEventListener('click', function () {
        const dateVal = $('#travel_date_int').val();
        const tripVal = $('#trip_code').val();
        fetchProductData(dateVal, tripVal);
    });

    // --- Recheck on manual edits ---
    travelInput.addEventListener('input', checkFields);
    tripCode.addEventListener('change', checkFields);
});
</script>

                    		<?php
                    		
                    		if (isset($_POST['submit_gds_changes'])) 
                    		{
                                foreach ($_POST as $key => $value) {
                                    // Match field pattern like trip_code_123, travel_date_123 etc.
                                    if (preg_match('/^(trip_code|travel_date|return_date|product_id|t_type|product_title)_(\d+)$/', $key, $matches)) {
                                        $field = $matches[1];            // e.g., trip_code
                                        $auto_id = $matches[2];          // e.g., 123
                                        $safe_value = mysqli_real_escape_string($mysqli, $value);
                            
                                        // Organize values for each auto_id
                                        $update_data[$auto_id][$field] = $safe_value;
                                    }
                                }
								
								$product_id_pax = '';
								foreach ($_POST as $key4 => $value4) 
                                {
                                    if (strpos($key4, 'product_id_') === 0) 
                                    {
										$product_id_pax = $value4;
                                    }
                                }
								if($product_id_pax != '' && $order_type != 'gds')
								{
									$update_query4 = "UPDATE wpk4_backend_travel_booking_pax SET product_id = '$product_id_pax' WHERE order_id = '$order_id' and ( product_id = '$product_id' OR product_id = '' )";
									//echo $update_query4.'</br>';
                                    $result4 = mysqli_query($mysqli, $update_query4);
								}
								
								
								$pnr = '';
								foreach ($_POST as $key3 => $value3) 
                                {
                                    if (strpos($key3, 'pnr_') === 0) 
                                    {
										$pnr = $value3;
                                    }
                                }
								if($pnr != '')
								{
									$update_query3 = "UPDATE wpk4_backend_travel_booking_pax SET pnr = '$pnr' WHERE order_id = '$order_id' and ( product_id = '$product_id' OR product_id = '' )";
									//echo $update_query3.'</br>';
                                    $result3 = mysqli_query($mysqli, $update_query3);
								}
								
								
								if($order_type == 'gds')
								{
									$update_query4 = "UPDATE wpk4_backend_travel_booking_pax SET product_id = '' WHERE order_id = '$order_id'";
                                    $result4 = mysqli_query($mysqli, $update_query4);
									//echo $update_query4.'</br>';
								}
								
								
								
                            
                                // Now run update query for each auto_id
                                foreach ($update_data as $auto_id => $fields) {
                                    $set_clause_parts = [];
                                    foreach ($fields as $field => $value) {
                                        $set_clause_parts[] = "$field = '$value'";
                                    }
                                    $set_clause = implode(", ", $set_clause_parts);
                                    $update_query = "UPDATE wpk4_backend_travel_bookings SET $set_clause WHERE auto_id = $auto_id";
									//echo $update_query.'</br>';
                                    $result = mysqli_query($mysqli, $update_query);
                                    if (!$result) 
                                    {
                                        echo "Error updating auto_id $auto_id: " . mysqli_error($mysqli) . "<br>";
                                    } 
                                    else 
                                    {
										
                                    }
                                }
								
								$query_stock_check = "SELECT trip_code, travel_date, total_pax FROM wpk4_backend_travel_bookings where auto_id = $auto_id and order_type != 'gds'";
									//echo $query_stock_check.'</br>';
									$result_stock_check = mysqli_query($mysqli, $query_stock_check);
									if(mysqli_num_rows($result_stock_check) > 0 )
                                    {
										$row_stock_check = mysqli_fetch_assoc($result_stock_check);
												
										$trip_code = $row_stock_check['trip_code'];
										$travel_date = $row_stock_check['travel_date'];
										$total_pax = $row_stock_check['total_pax'];
										
										update_stock_in_pricing_table($trip_code, $travel_date, $total_pax, 'positive');
										
										$by_user = 'dc_in_customer_portal';
																												
										availability_table_pax_update_positive($order_id, $by_user);
									}
								
								$new_order_id = $_GET['new_oid'] ?? '';
                                echo '<script>window.location.href="?p=manage-datechange-v1&part=generate-payment-link&oid='.$order_id.'&coid='.$co_order_id.'&new_oid='.$new_order_id.'";</script>';
                            }
						}
						
						if(isset($_GET['p']) && $_GET['p'] =='manage-datechange-v1' && isset($_GET['part']) && $_GET['part'] == 'generate-payment-link')
						{
						    
						    echo '</br></br></br>';
						    $order_id = $_GET['oid'];
							$co_order_id = $_GET['coid'] ?? '';
						    ?>
							<center>
							<h5>Date change process is done.</h5>
							<h5>Please instruct customer to make their balance payment through Customer Portal.</h5>
							</br></br>
							<h3>Datechange Order ID: <?php echo $order_id; ?></h3>
							</center>
							<?php
							$query_booking_check = "SELECT trip_code, travel_date, total_pax, product_id FROM wpk4_backend_travel_bookings where order_id = $order_id";
							$result_booking_check = mysqli_query($mysqli, $query_booking_check);
							if(mysqli_num_rows($result_booking_check) > 0 )
                            {
                                while($row_bookings = mysqli_fetch_assoc($result_booking_check))
                                {
                                    $product_id = $row_bookings['product_id'];
                                    echo '</br><h5>'.$row_bookings['trip_code'] . ' - ' . date("d/m/Y", strtotime( $row_bookings['travel_date'] )) . '</h5>';
                                    
                                    $query_pax_check = "SELECT fname, lname, dob FROM wpk4_backend_travel_booking_pax where order_id = $order_id and product_id = '$product_id'";
        							$result_pax_check = mysqli_query($mysqli, $query_pax_check) or die("Pax query failed: " . mysqli_error($mysqli));
        							if(mysqli_num_rows($result_pax_check) > 0 )
                                    {
                                        echo '<table class="table table-striped" style="width:100%; margin:auto;font-size:14px; margin-top:35px;"><tr>
                                            <th>Pax Name</th>
                                            <th>DOB</th>
                                            </tr>';
                                        while($row_pax = mysqli_fetch_assoc($result_pax_check))
                                        {
                                            echo '<tr>
                                                    <td style="height:40px;">'.$row_pax['fname'] . ' ' . $row_pax['lname'] .'</td>
                                                    <td style="height:40px;">'.$row_pax['dob'].'</td>
                                                </tr>';
                                        }
                                    }
                                    
                                    echo '</table>';
                                }
                            }
							?>
                            </br></br>
							<?php
							if(isset($_GET['new_oid']) && $_GET['new_oid'] != '')
							{
							    $new_order_id = $_GET['new_oid'];
								?>
								<center>
								<h3>Non Datechange Order ID: <?php echo $_GET['new_oid']; ?></h3>
								</center>
								<?php
								
								$query_booking_check = "SELECT trip_code, travel_date, total_pax, product_id FROM wpk4_backend_travel_bookings where order_id = $new_order_id";
    							$result_booking_check = mysqli_query($mysqli, $query_booking_check);
    							if(mysqli_num_rows($result_booking_check) > 0 )
                                {
                                    while($row_bookings = mysqli_fetch_assoc($result_booking_check))
                                    {
                                        $product_id = $row_bookings['product_id'];
                                        echo '</br><h5>'.$row_bookings['trip_code'] . ' - ' . date("d/m/Y", strtotime( $row_bookings['travel_date'] )) . '</h5>';
                                        $query_pax_check = "SELECT fname, lname, dob FROM wpk4_backend_travel_booking_pax where order_id = $new_order_id and product_id = '$product_id'";
            							$result_pax_check = mysqli_query($mysqli, $query_pax_check) or die("Pax query failed: " . mysqli_error($mysqli));
            							if(mysqli_num_rows($result_pax_check) > 0 )
                                        {
                                            echo '<table class="table table-striped" style="width:100%; margin:auto;font-size:14px; margin-top:35px;"><tr>
                                                <th>Pax Name</th>
                                                <th>DOB</th>
                                                </tr>';
                                            while($row_pax = mysqli_fetch_assoc($result_pax_check))
                                            {
                                                echo '<tr>
                                                        <td style="height:40px;">'.$row_pax['fname'] . ' ' . $row_pax['lname'] .'</td>
                                                        <td style="height:40px;">'.$row_pax['dob'].'</td>
                                                    </tr>';
                                            }
                                        }
                                        
                                        echo '</table>';
                                    }
                                }
							}
							?>
							
							
												<?php
												if(isset($_POST['request_clone_booking_payment']))
                                                {
                                				    $order_id_for_payment_request = $_POST['order_id'];
                                                    $emailid_for_payment_request = $_POST['emailid'];
                                                    $type_of_payment_for_payment_request = 'Payment';
                                                    $pnr_for_payment_request = $_POST['pnr'];
                                                    $paymentAmount = $_POST['payment_amount'];
                                                    $customer_case_id_for_payment_request = '0';
                                                    
                                                    $paymentAmount_2Decimal = number_format((float)$_POST['payment_amount'], 2, '.', '') ;
                                                    {
                                                        
                                                        if($order_id_for_payment_request && $paymentAmount && $type_of_payment_for_payment_request)
                                                        {
                                    				        if (class_exists('GuzzleHttp\Client'))
                                    				        {}
                                    				        else
                                                            {
                                                                echo '<script>alert("Error on payment link. Contact HO.");</script>';
                                                            }
                                                        }
                                                        else
                                                        {
                                                            echo '<script>alert("Error during the request. Kindly try again later.");</script>';
                                                        }
                                                    }
                                                }
						}
						
						
						
						
						
						
						
						
						if(isset($_GET['p']) && $_GET['p'] =='manage-datechange-update-name-v1' && !isset($_GET['part']))
					{
						echo '</br></br></br>';
						    $order_id = $_GET['oid'];
													    
                    		$query_pax = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id' order by travel_date asc limit 1;";
                    		$result_pax = mysqli_query($mysqli, $query_pax);
                    		?>
                    		<h6>Order ID : <?php echo $order_id; ?></h6>
                    		<?php
                    		if(!empty($result_pax))
                    		{
                    			while($row_pax = mysqli_fetch_assoc($result_pax))
                    			{
                    			?>
                    				<form action="#" name="statusupdate" id="divideForm" method="post" enctype="multipart/form-data" style='font-size:13px;'>
                    				    <table class="table table-striped" style="width:100%;"><thead><tr><th width='10%'>Check</th><th>Name</th><th>Passport</th><th>DOB</th></tr></thead><tbody>
                    				<?php
                    				$order_id = $row_pax['order_id'];
                    				$co_order_id_db = $row_pax['co_order_id'];
                    				$product_id = $row_pax['product_id'];
                    				$order_type = $row_pax['order_type'];
                    				
									echo '<input type="hidden" name="id" id="teammembers_status" value="'.$order_id.'">';
									echo '<input type="hidden" name="co_orderid" id="teammembers_status" value="'.$co_order_id_db.'">';
									echo '<input type="hidden" name="productid" id="teammembers_status" value="'.$product_id.'">';
									echo '<input type="hidden" name="order_type" id="teammembers_status" value="'.$order_type.'">';
									
                    				if($order_type != 'gds') // wpt
                    				{
                    				    $query_paxc = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id' and co_order_id = '$co_order_id_db' AND product_id = '$product_id' ";
                        				$result_paxc = mysqli_query($mysqli, $query_paxc);
                        				$row_pax_count = mysqli_num_rows($result_paxc);
                        				while($row_paxc = mysqli_fetch_assoc($result_paxc))
                        				{
                        					$salutation = $row_paxc['salutation']; 
                        					$fname = $row_paxc['fname']; 
                        					$lname = $row_paxc['lname']; 
                        					$ppn = $row_paxc['ppn']; 
                        					$dob = $row_paxc['dob']; 
                        					$auto_id = $row_paxc['auto_id'];
                        					?>
                        					<tr><td>
                        					<?php
                        					if($row_pax_count > 1)
                        					{
                        					?>
                        						<input type="checkbox" checked id="pxe" name="pax_ids_for_new_order[]" class="pxe" value="<?php echo $auto_id; ?>">
                        					<?php
                        					}
                        					else
                        					{
                        					
                        					}
                        					?>
                        					</td><td><?php echo $salutation; ?> <?php echo $fname; ?> <?php echo $lname; ?></td><td><?php echo $ppn; ?></td><td><?php echo $dob; ?></td></tr>
                        				<?php
                        				}
                    				}
                    				else // gds
                    				{
                    				    $query_paxc = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id' and co_order_id = '$co_order_id_db' ";
                        				$result_paxc = mysqli_query($mysqli, $query_paxc);
                        				$row_pax_count = mysqli_num_rows($result_paxc);
                        				while($row_paxc = mysqli_fetch_assoc($result_paxc))
                        				{
                        					$salutation = $row_paxc['salutation']; 
                        					$fname = $row_paxc['fname']; 
                        					$lname = $row_paxc['lname']; 
                        					$ppn = $row_paxc['ppn']; 
                        					$dob = $row_paxc['dob']; 
                        					$auto_id = $row_paxc['auto_id'];
                        					?>
                        					<tr><td>
                        					<?php
                        					if($row_pax_count > 1)
                        					{
                        					?>
                        						<input type="checkbox" checked id="pxe" name="pax_ids_for_new_order[]" class="pxe"  value="<?php echo $auto_id; ?>">
                        					<?php
                        					}
                        					
                        					?>
                        					</td><td><?php echo $salutation; ?> <?php echo $fname; ?> <?php echo $lname; ?></td><td><?php echo $ppn; ?></td><td><?php echo $dob; ?></td></tr>
                        				<?php
                        				}
                    				}
                    				?>
                    				<tr><td colspan='4'></td></tr></tbody>
                    				</table>
                    			<?php
                    			}
								?>
								<div id="divide_submit" style="display:none;">
									<input type="submit" style="padding:15px; margin:0; font-size:11px;" name="divideorder" value="Divide & Next">
								</div>
								<div id="next_without_divide" >
									<input type="submit" style="padding:15px; margin:0; font-size:11px;" name="without_divideorder" value="Clone & Next">
								</div>
								</form>
								<script>
                                document.getElementById('divideForm').addEventListener('submit', function (e) {
                                    // Identify which submit button was clicked
                                    const clickedButton = document.activeElement;
                                
                                    // Only show confirmation for divide or clone actions
                                    if (
                                        clickedButton &&
                                        (clickedButton.name === 'divideorder' || clickedButton.name === 'without_divideorder')
                                    ) {
                                        const confirmMsg = "Do you want to continue with the passenger(s) selected?";
                                        if (!confirm(confirmMsg)) {
                                            e.preventDefault(); // Stop the form from submitting
                                        }
                                    }
                                });
                                </script>
								<script>
								function updateButtonVisibility() {
									const checkboxes = Array.from(document.querySelectorAll('.pxe'));
									const total = checkboxes.length;
									const checkedCount = checkboxes.filter(cb => cb.checked).length;

									if (checkedCount === 0 || checkedCount === total) {
										// All or none are selected
										document.getElementById('next_without_divide').style.display = 'block';
										document.getElementById('divide_submit').style.display = 'none';
									} else {
										// Some but not all are selected
										document.getElementById('next_without_divide').style.display = 'none';
										document.getElementById('divide_submit').style.display = 'block';
									}
								}

								// Attach listener to all checkboxes
								document.querySelectorAll('.pxe').forEach(function(checkbox) {
									checkbox.addEventListener('change', updateButtonVisibility);
								});

								// Run once on page load in case of pre-checked boxes
								updateButtonVisibility();
								</script>
								<?php
                    	}	
                    	if (isset($_POST['divideorder'])) 
						{
								$order_id = $_GET['oid'];
								$case_id = $_GET['cid'];
								$orderid = $_POST['id'];
								$co_orderid = $_POST['co_orderid'] ?? '';
								$productid = $_POST['productid'] ?? '';
								//$order_type = $_POST['order_type'] ?? '';
								$selected_ids = $_POST['pax_ids_for_new_order'] ?? [];
								
								if(empty($selected_ids))
								{
								    $all_pax_query = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
    								$result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));
    								while ($pax = mysqli_fetch_assoc($result_all_pax)) 
    								{
    								    $pax_a_id = $pax['auto_id'];
    								    $selected_ids[] = $pax_a_id;
    								}
								}
								
								$all_pax_query = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
								$result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));
								while ($pax = mysqli_fetch_assoc($result_all_pax)) 
								{
									if (in_array($pax['auto_id'], $selected_ids))
									{
									    $pax_a_id = $pax['auto_id'];
									    $fname = $pax['fname'];
									    $lname = $pax['lname'];
										$dob = $pax['dob'];
										$salutation = $pax['salutation'];
									    
									    $all_pax_query_inner = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE auto_id != '$pax_a_id' and order_id = '$orderid' and salutation = '$salutation' and fname = '$fname' and lname = '$lname' and dob = '$dob'";
								        $result_all_pax_inner = mysqli_query($mysqli, $all_pax_query_inner) or die(" Pax query failed: " . mysqli_error($mysqli));
										if( mysqli_num_rows($result_all_pax_inner) > 0)
										{
								        $pax_inner = mysqli_fetch_assoc($result_all_pax_inner);
								        $inner_a_id = $pax_inner['auto_id'];
								        $selected_ids[] = $inner_a_id;
										}
									}
								}
						        //print_r($selected_ids);
						        $selected_ids = array_unique($selected_ids);	

								// Enable error reporting for mysqli
								mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT);

								// Get new order_id
								$res_max_order = mysqli_query($mysqli, "SELECT MAX(order_id) AS max_order_id FROM wpk4_backend_travel_bookings");
								$max_row = mysqli_fetch_assoc($res_max_order);
								$new_order_id = $max_row['max_order_id'] + 1;
								
								$res_max_order = mysqli_query($mysqli, "SELECT MAX(order_id) AS max_order_id FROM wpk4_backend_travel_bookings");
								$max_row = mysqli_fetch_assoc($res_max_order);
								$divided_order_id = $max_row['max_order_id'] + 2;

								$pax_in_non_divided = 0;
                                $pax_in_divided = 0;
                                $all_pax_query = "SELECT auto_id FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
								$result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));

								while ($pax = mysqli_fetch_assoc($result_all_pax)) {
								    
									if (in_array($pax['auto_id'], $selected_ids)) 
									{
									    $pax_in_divided++;
									}
									
									if (!in_array($pax['auto_id'], $selected_ids)) 
									{
									    $pax_in_non_divided++;
									}
								}
								if ($order_type != 'gds') // GDS
                                {
									if($pax_in_divided > 1)
									{
										$pax_in_divided = $pax_in_divided / 2;
									}
									if($pax_in_non_divided > 1)
									{
										$pax_in_non_divided = $pax_in_non_divided / 2;
									}
								}
								
								if ($order_type == 'gds') // GDS
                                {
									$divided_pax_to_be_paid_total = 0;
									$non_divided_pax_to_be_paid_total = 0;
									
									$all_pax_query_paid_calculator = "SELECT auto_id, pnr, gds_pax_id FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid'";
									$result_all_pax_paid_calculator = mysqli_query($mysqli, $all_pax_query_paid_calculator) or die(" Pax query failed: " . mysqli_error($mysqli));
									while ($pax_paid_calculator = mysqli_fetch_assoc($result_all_pax_paid_calculator)) 
									{
										if (in_array($pax_paid_calculator['auto_id'], $selected_ids)) 
										{
											$pnr_pax_amt = $pax_paid_calculator['pnr'];
											$gds_id_pax_amt = $pax_paid_calculator['gds_pax_id'];
												
											$all_pax_query_fit_amt = "SELECT PriceSell FROM `wpk4_ypsilon_bookings_table_fare` WHERE PaxId = '$gds_id_pax_amt'";
											$result_pax_query_fit_amt = mysqli_query($mysqli, $all_pax_query_fit_amt) or die(" Pax query failed: " . mysqli_error($mysqli));
											$pax_pax_query_fit_amt = mysqli_fetch_assoc($result_pax_query_fit_amt);
											$pax_PriceSell = $pax_pax_query_fit_amt['PriceSell'];
											
											$all_pax_query_fit_amt2 = "SELECT Amount FROM `wpk4_ypsilon_bookings_table_tax` WHERE PaxId = '$gds_id_pax_amt'";
											$result_pax_query_fit_amt2 = mysqli_query($mysqli, $all_pax_query_fit_amt2) or die(" Pax query failed: " . mysqli_error($mysqli));
											$pax_pax_query_fit_amt2 = mysqli_fetch_assoc($result_pax_query_fit_amt2);
											$pax_TaxAmount = $pax_pax_query_fit_amt2['Amount'];
											
											$divided_pax_to_be_paid_total += (float)$pax_PriceSell + (float)$pax_TaxAmount;
										}
										
										if (!in_array($pax_paid_calculator['auto_id'], $selected_ids)) 
										{
											$pnr_pax_amt = $pax_paid_calculator['pnr'];
											$gds_id_pax_amt = $pax_paid_calculator['gds_pax_id'];
												
											$all_pax_query_fit_amt = "SELECT PriceSell FROM `wpk4_ypsilon_bookings_table_fare` WHERE PaxId = '$gds_id_pax_amt'";
											$result_pax_query_fit_amt = mysqli_query($mysqli, $all_pax_query_fit_amt) or die(" Pax query failed: " . mysqli_error($mysqli));
											$pax_pax_query_fit_amt = mysqli_fetch_assoc($result_pax_query_fit_amt);
											$pax_PriceSell = $pax_pax_query_fit_amt['PriceSell'];
											
											$all_pax_query_fit_amt2 = "SELECT Amount FROM `wpk4_ypsilon_bookings_table_tax` WHERE PaxId = '$gds_id_pax_amt'";
											$result_pax_query_fit_amt2 = mysqli_query($mysqli, $all_pax_query_fit_amt2) or die(" Pax query failed: " . mysqli_error($mysqli));
											$pax_pax_query_fit_amt2 = mysqli_fetch_assoc($result_pax_query_fit_amt2);
											$pax_TaxAmount = $pax_pax_query_fit_amt2['Amount'];
											
											$non_divided_pax_to_be_paid_total += (float)$pax_PriceSell + (float)$pax_TaxAmount;
										}
									}
								}
								else
								{
									
									$divided_pax_to_be_paid_total = 0;
									$non_divided_pax_to_be_paid_total = 0;
									
									$all_pax_query_paid_calculator = "SELECT auto_id, trip_price_individual  FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
									$result_all_pax_paid_calculator = mysqli_query($mysqli, $all_pax_query_paid_calculator) or die(" Pax query failed: " . mysqli_error($mysqli));

									while ($pax_paid_calculator = mysqli_fetch_assoc($result_all_pax_paid_calculator)) 
									{
										if (in_array($pax_paid_calculator['auto_id'], $selected_ids)) 
										{
											$divided_pax_to_be_paid_total += $pax_paid_calculator['trip_price_individual'];
										}
										
										if (!in_array($pax_paid_calculator['auto_id'], $selected_ids)) 
										{
											$non_divided_pax_to_be_paid_total += $pax_paid_calculator['trip_price_individual'];
										}
									}
								}	
																
								// Fetch existing bookings
                                $res_booking = mysqli_query($mysqli, "SELECT * FROM wpk4_backend_travel_bookings WHERE order_id = '$order_id'");
                                if (!$res_booking || mysqli_num_rows($res_booking) === 0) {
                                    die(" No booking found for order_id = $order_id");
                                }
                                
                                // Store all booking rows into array
                                $all_booking_rows = [];
                                while ($row = mysqli_fetch_assoc($res_booking)) {
                                    $all_booking_rows[] = $row;
                                }
                                
                                // First loop: insert with new_order_id
                                foreach ($all_booking_rows as $booking_data) {
                                    $booking_data['previous_order_id'] = $order_id;
                                    $booking_data['order_id'] = $new_order_id;
                                    unset($booking_data['auto_id']);
                                
                                    if (empty($booking_data['divided_date'])) unset($booking_data['divided_date']);
                                    if (empty($booking_data['late_modified'])) unset($booking_data['late_modified']);
                                    if (empty($booking_data['airline_ttl_deadline'])) unset($booking_data['airline_ttl_deadline']);
                                    if (empty($booking_data['price_time_limit'])) unset($booking_data['price_time_limit']);
                                    if (empty($booking_data['ticketing_timelimit'])) unset($booking_data['ticketing_timelimit']);
                                    if (empty($booking_data['return_date'])) unset($booking_data['return_date']);
									if (empty($booking_data['family_id'])) unset($booking_data['family_id']);
									if (empty($booking_data['journal_date'])) unset($booking_data['journal_date']);
                                    
									unset($booking_data['payment_modified']);
									$booking_data['source'] = "datechange"; 
									$booking_data['agent_info'] = $currnt_userlogined;
									 
                                    //$booking_data['payment_status'] = "partially_paid";
									//$booking_data['deposit_deadline'] = date("Y-m-d") . ' 23:59:59';
									//$booking_data['full_payment_deadline'] = date("Y-m-d") . ' 23:59:59';
									
									$booking_data['deposit_deadline'] = date("Y-m-d H:i:s", strtotime("+1 day"));
									$booking_data['full_payment_deadline'] = date("Y-m-d H:i:s", strtotime("+1 day"));
                                
                                    $booking_data['total_pax'] = $pax_in_non_divided;
									
									$booking_data['total_amount'] = $non_divided_pax_to_be_paid_total;
									unset($booking_data['balance']);
									
									$booking_data['added_on'] = date("Y-m-d H:i:s");
                                
                                    $columns = array_keys($booking_data);
                                    $values = array_map(function ($val) use ($mysqli) {
                                        if (!empty($val))
											{
												return "'" . mysqli_real_escape_string($mysqli, $val) . "'";
											}
											else
											{
												return "'" . $val . "'";
											}
                                    }, array_values($booking_data));
                                
                                    $insert_booking = "INSERT INTO wpk4_backend_travel_bookings (" . implode(',', $columns) . ") VALUES (" . implode(',', $values) . ")";
                                    if (!mysqli_query($mysqli, $insert_booking)) {
                                        die(" Booking insert failed (new_order_id): " . mysqli_error($mysqli));
                                    }
                                }
                                
                                // Second loop: insert with divided_order_id
                                foreach ($all_booking_rows as $booking_data) {
                                    $booking_data['previous_order_id'] = $order_id;
                                    $booking_data['order_id'] = $divided_order_id;
                                    unset($booking_data['auto_id']);
                                
                                    if (empty($booking_data['divided_date'])) unset($booking_data['divided_date']);
                                    if (empty($booking_data['late_modified'])) unset($booking_data['late_modified']);
                                    if (empty($booking_data['airline_ttl_deadline'])) unset($booking_data['airline_ttl_deadline']);
                                    if (empty($booking_data['price_time_limit'])) unset($booking_data['price_time_limit']);
                                    if (empty($booking_data['ticketing_timelimit'])) unset($booking_data['ticketing_timelimit']);
                                    if (empty($booking_data['return_date'])) unset($booking_data['return_date']);
									if (empty($booking_data['family_id'])) unset($booking_data['family_id']);
									if (empty($booking_data['journal_date'])) unset($booking_data['journal_date']);
									
									unset($booking_data['payment_modified']);
									$booking_data['source'] = "datechange";
                                    $booking_data['payment_status'] = "partially_paid";
									//$booking_data['deposit_deadline'] = date("Y-m-d") . ' 23:59:59';
									//$booking_data['full_payment_deadline'] = date("Y-m-d") . ' 23:59:59';
									
									$booking_data['deposit_deadline'] = date("Y-m-d H:i:s", strtotime("+1 day"));
									$booking_data['full_payment_deadline'] = date("Y-m-d H:i:s", strtotime("+1 day"));
									
									$booking_data['agent_info'] = $currnt_userlogined;
                                
                                    $booking_data['total_pax'] = $pax_in_divided;
									
									$booking_data['total_amount'] = $divided_pax_to_be_paid_total;
									unset($booking_data['balance']);
									$booking_data['added_on'] = date("Y-m-d H:i:s");
                                
                                    $columns = array_keys($booking_data);
                                    $values = array_map(function ($val) use ($mysqli) {
                                        if (!empty($val))
											{
												return "'" . mysqli_real_escape_string($mysqli, $val) . "'";
											}
											else
											{
												return "'" . $val . "'";
											}
                                    }, array_values($booking_data));
                                
                                    $insert_booking = "INSERT INTO wpk4_backend_travel_bookings (" . implode(',', $columns) . ") VALUES (" . implode(',', $values) . ")";
                                    if (!mysqli_query($mysqli, $insert_booking)) {
                                        die(" Booking insert failed (divided_order_id): " . mysqli_error($mysqli));
                                    }
                                }

                                
                                

								// Process unselected passengers
								$all_pax_query = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid'";
                                $result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));
                                
                                // Store all pax in array
                                $all_pax = [];
                                while ($row = mysqli_fetch_assoc($result_all_pax)) {
                                    $all_pax[] = $row;
                                }
                                
                                // Loop 1: for pax NOT in selected_ids  assign to $new_order_id
                                foreach ($all_pax as $pax) {
                                    if (!in_array($pax['auto_id'], $selected_ids)) {
                                        $original_auto_id = $pax['auto_id'];
										$booking_data['previous_order_id'] = $order_id;
                                        $pax['order_id'] = $new_order_id;
                                
                                        unset($pax['auto_id']);
                                        if (empty($pax['trams_profile_id'])) unset($pax['trams_profile_id']);
                                        
										if (empty($pax['customer_id'])) unset($pax['customer_id']);
										

										unset($pax['ticketed_by']);
										unset($pax['ticketed_on']);
										unset($pax['ticketing_audit_on']);
										unset($pax['name_audit_on']);
										unset($pax['ticketing_remarks_on']);
										unset($pax['ticketing_in_progress_on']);
										
										unset($pax['name_update_check']);
										unset($pax['name_update_check_on']);
										$pax['added_on'] = date("Y-m-d H:i:s");
                                
                                        $columns = array_keys($pax);
                                        $values = array_map(function ($val) use ($mysqli) {
                                            if (!empty($val))
											{
												return "'" . mysqli_real_escape_string($mysqli, $val) . "'";
											}
											else
											{
												return "'" . $val . "'";
											}
                                        }, array_values($pax));
                                
                                        $insert_pax = "INSERT INTO wpk4_backend_travel_booking_pax (" . implode(',', $columns) . ") VALUES (" . implode(',', $values) . ")";
                                        if (!mysqli_query($mysqli, $insert_pax)) {
                                            echo " PAX insert failed (new order): " . mysqli_error($mysqli);
                                        }
                                    }
                                }
                                
                                // Loop 2: for pax IN selected_ids  assign to $divided_order_id
                                foreach ($all_pax as $pax2) {
                                    if (in_array($pax2['auto_id'], $selected_ids)) {
                                        $original_auto_id = $pax2['auto_id'];
                                        $pax2['order_id'] = $divided_order_id;
                                
                                        unset($pax2['auto_id']);
                                        if (empty($pax2['trams_profile_id'])) unset($pax2['trams_profile_id']);
										if (empty($pax2['customer_id'])) unset($pax2['customer_id']);
										unset($pax2['ticketed_on']);
										unset($pax2['ticketed_by']);
										unset($pax2['ticket_number']);
										unset($pax2['ticketing_audit_on']);
										unset($pax2['name_audit_on']);
										unset($pax2['ticketing_remarks_on']);
										unset($pax2['ticketing_in_progress_on']);
										
										unset($pax2['name_update_check']);
										unset($pax2['name_update_check_on']);
                                
                                        $columns = array_keys($pax2);
                                        $values = array_map(function ($val) use ($mysqli) {
                                            if (!empty($val))
											{
												return "'" . mysqli_real_escape_string($mysqli, $val) . "'";
											}
											else
											{
												return "'" . $val . "'";
											}
                                        }, array_values($pax2));
                                
                                        $insert_pax2 = "INSERT INTO wpk4_backend_travel_booking_pax (" . implode(',', $columns) . ") VALUES (" . implode(',', $values) . ")";
                                        if (!mysqli_query($mysqli, $insert_pax2)) {
                                            echo " PAX insert failed (divided order): " . mysqli_error($mysqli);
                                        }
                                    }
                                }
                                
                                //echo 'divide booking '.$divided_pax_to_be_paid_total . '</br></br>';
								
								//echo 'non divide booking '.$non_divided_pax_to_be_paid_total. '</br></br>';
								
                                if ($order_type == 'gds') // GDS
                                {
                                    // Step 4: Copy all related history updates
                                    $res_hist = $mysqli->query("SELECT * FROM wpk4_backend_history_of_updates WHERE type_id = '$orderid'");
                                    if (!$res_hist) {
                                        echo "History Error: " . $mysqli->error;
                                        exit;
                                    }
                                
                                    // Store all history rows
                                    $all_hist_rows = [];
                                    while ($row = $res_hist->fetch_assoc()) {
                                        $all_hist_rows[] = $row;
                                    }
                                
                                    // First loop: insert with new_order_id
                                    foreach ($all_hist_rows as $hist) {
                                        $hist['type_id'] = $new_order_id;
                                        unset($hist['auto_id']);
                                
                                        // Remove null or empty values
                                        $hist = array_filter($hist, function($value) {
                                            return $value !== null && $value !== '';
                                        });
                                
                                        $columns = implode(", ", array_keys($hist));
                                        $values = implode("', '", array_map([$mysqli, 'real_escape_string'], array_values($hist)));
                                
                                        $insert_hist = "INSERT INTO wpk4_backend_history_of_updates ($columns) VALUES ('$values')";
                                        if (!$mysqli->query($insert_hist)) {
                                            echo " Error inserting history update (new_order_id): " . $mysqli->error . "<br>Query: $insert_hist";
                                            exit;
                                        }
                                    }
                                
                                    // Second loop: insert with finalco_order_id
                                    foreach ($all_hist_rows as $hist) {
                                        $hist['type_id'] = $divided_order_id;
                                        unset($hist['auto_id']);
                                
                                        // Remove null or empty values
                                        $hist = array_filter($hist, function($value) {
                                            return $value !== null && $value !== '';
                                        });
                                
                                        $columns = implode(", ", array_keys($hist));
                                        $values = implode("', '", array_map([$mysqli, 'real_escape_string'], array_values($hist)));
                                
                                        $insert_hist = "INSERT INTO wpk4_backend_history_of_updates ($columns) VALUES ('$values')";
                                        if (!$mysqli->query($insert_hist)) {
                                            echo " Error inserting history update (finalco_order_id): " . $mysqli->error . "<br>Query: $insert_hist";
                                            exit;
                                        }
                                    }
                                }
								
								$sql_update_past_booking2 ="UPDATE wpk4_backend_travel_bookings
                                                 SET total_amount = '$non_divided_pax_to_be_paid_total', payment_modified = '$current_date_and_time', payment_modified_by = 'customer_portal_dc'
                                                WHERE order_id = '$new_order_id'";
                                $results_update_past_booking2 = $mysqli->query($sql_update_past_booking2);
								
								if ($order_type == 'gds')
								{
									$sql_update_past_booking3 ="UPDATE wpk4_backend_history_of_updates
                                                 SET meta_value = '$non_divided_pax_to_be_paid_total', updated_by = 'DC Amount Change'
                                                WHERE type_id = '$new_order_id' AND meta_key = 'Transaction TotalTurnover'";
									$results_update_past_booking3 = $mysqli->query($sql_update_past_booking3);
									
									$sql_update_past_booking3 ="UPDATE wpk4_backend_history_of_updates
                                                 SET meta_value = '$divided_pax_to_be_paid_total', updated_by = 'DC Amount Change'
                                                WHERE type_id = '$divided_order_id' AND meta_key = 'Transaction TotalTurnover'";
									$results_update_past_booking3 = $mysqli->query($sql_update_past_booking3);
								}
								
								

                                $query_booking_for_payment_history = "SELECT payment_status, total_amount FROM wpk4_backend_travel_bookings WHERE order_id = '$orderid' ";
								$result_booking_for_payment_history = mysqli_query($mysqli, $query_booking_for_payment_history) or die(" Booking query failed: " . mysqli_error($mysqli));
								while ($pax_booking_for_payment_history = mysqli_fetch_assoc($result_booking_for_payment_history)) 
								{
									//echo '</br>In Pay Loop</br>';
									//if($pax_booking_for_payment_history['payment_status'] == 'paid')
									{
										$total_paid_for_booking_transfer = 0.00;
										$processedPayments = array();
										$query_total_paid_for_requestid = "SELECT * FROM wpk4_backend_travel_payment_history where order_id = '$orderid' AND (pay_type = 'deposit' OR pay_type = 'balance' 
														OR pay_type = 'Balance' OR pay_type = 'deposit_adjustment' OR pay_type = 'additional_payment' OR pay_type = 'Refund')";
										$result_total_paid_for_requestid = mysqli_query($mysqli, $query_total_paid_for_requestid);
										while($row_total_paid_for_requestid = mysqli_fetch_assoc($result_total_paid_for_requestid))
										{
											$payment_identifier = $row_total_paid_for_requestid['trams_received_amount'].'^'.$row_total_paid_for_requestid['reference_no']; 
                                    		if (in_array($payment_identifier, $processedPayments)) 
                                    		{
												continue; // Skip to the next value
                                    		}
											
											$processedPayments[] = $payment_identifier;						

											$total_paid_for_booking_transfer += (float)$row_total_paid_for_requestid['trams_received_amount'];
										}
										//echo '</br>Total paid . ' . $total_paid_for_booking_transfer .'</br>';
										//&& $pax_booking_for_payment_history['total_amount'] == $total_paid_for_booking_transfer
										if($total_paid_for_booking_transfer > 0 )
										{
											//echo '</br>In amount check condition</br>';
											$total_balance_after_reduce_non_divided_booking_amount = $total_paid_for_booking_transfer - $non_divided_pax_to_be_paid_total;
											
											// non divide amount transfer
											if( $total_paid_for_booking_transfer >= $non_divided_pax_to_be_paid_total )
											{
												//echo '</br>Inserting transfer 1</br>';
												$total_paid_for_booking_transfer_minus = '-'.$non_divided_pax_to_be_paid_total;
												
												$remark_for_past_booking = 'amount transfered to - '. $new_order_id . ' by Customer Portal DC';
												$remark_for_new_booking = 'amount transfered from - '. $orderid . ' by Customer Portal DC';
												
												mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history (order_id, source, trams_received_amount, reference_no, payment_method, process_date, pay_type, added_on, added_by) 
												values ('$orderid', '$order_type', '$total_paid_for_booking_transfer_minus', '$remark_for_past_booking', '14', '$current_date_and_time', 'deposit_adjustment', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
												
												mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history (order_id, source, trams_received_amount, reference_no, payment_method, process_date, pay_type, added_on, added_by) 
												values ('$new_order_id', '$order_type', '$non_divided_pax_to_be_paid_total', '$remark_for_new_booking', '14', '$current_date_and_time', 'deposit_adjustment', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
											}
											
											//if($total_balance_after_reduce_non_divided_booking_amount <= $divided_pax_to_be_paid_total)
											{
												//echo '</br>Inserting transfer 2</br>';
												$total_paid_for_booking_transfer_minus2 = '-'.$total_balance_after_reduce_non_divided_booking_amount;
												
												$remark_for_past_booking2 = 'amount transfered to - '. $divided_order_id . ' by Customer Portal DC';
												$remark_for_new_booking2 = 'amount transfered from - '. $orderid . ' by Customer Portal DC';
												
												mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history (order_id, source, trams_received_amount, reference_no, payment_method, process_date, pay_type, added_on, added_by) 
												values ('$orderid', '$order_type', '$total_paid_for_booking_transfer_minus2', '$remark_for_past_booking2', '14', '$current_date_and_time', 'deposit_adjustment', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
												
												mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history (order_id, source, trams_received_amount, reference_no, payment_method, process_date, pay_type, added_on, added_by) 
												values ('$divided_order_id', '$order_type', '$total_balance_after_reduce_non_divided_booking_amount', '$remark_for_new_booking2', '14', '$current_date_and_time', 'deposit_adjustment', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
											}
										}
									}
								}
								
								if($order_type != 'gds' && $new_order_id != '')
								{
									$query_stock_check = "SELECT trip_code, travel_date, total_pax FROM wpk4_backend_travel_bookings where order_id = '$new_order_id' and order_type != 'gds'";
									$result_stock_check = mysqli_query($mysqli, $query_stock_check);
									if(mysqli_num_rows($result_stock_check) > 0 )
									{
										while($row_stock_check = mysqli_fetch_assoc($result_stock_check))
										{
											$trip_code = $row_stock_check['trip_code'];
											$travel_date = $row_stock_check['travel_date'];
											$total_pax = $row_stock_check['total_pax'];
																															
											update_stock_in_pricing_table($trip_code, $travel_date, $total_pax, 'positive');
																															
											
										}
										$by_user = 'dc_in_customer_portal';

											availability_table_pax_update_positive($order_id, $by_user);
									}
								}

								//echo '</br>updating status</br>';
                                $sql_update_past_booking ="UPDATE wpk4_backend_travel_bookings
                                                                    SET payment_status = 'voucher_submited', payment_modified = '$current_date_and_time', payment_modified_by = 'customer_portal_dc'
                                                                WHERE order_id = '$orderid'";
                                                                $results_update_past_booking = $wpdb->query($sql_update_past_booking);
                                                                
                                                                if ($results_update_past_booking > 0) 
                                                                {
																	
																	if($order_type != 'gds')
																	{
																		$query_stock_check = "SELECT trip_code, travel_date, total_pax FROM wpk4_backend_travel_bookings where order_id = '$orderid' and order_type != 'gds'";
																		$result_stock_check = mysqli_query($mysqli, $query_stock_check);
																		if(mysqli_num_rows($result_stock_check) > 0 )
																		{
																			while($row_stock_check = mysqli_fetch_assoc($result_stock_check))
																			{
																					
																				$trip_code = $row_stock_check['trip_code'];
																				$travel_date = $row_stock_check['travel_date'];
																				$total_pax = $row_stock_check['total_pax'];
																				
																				update_stock_in_pricing_table($trip_code, $travel_date, $total_pax, 'negative');
																				
																				$by_user = 'dc_in_customer_portal';
																																						
																				availability_table_pax_update($order_id, $by_user);
																			}
																		}
																	}
																	
                                                                    mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
    					                                            values ('$orderid','','','payment_status','Rebooked','$current_date_and_time','$currnt_userlogined')") or die(mysqli_error($mysqli));
                                                                } 

								mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
    					         values ('$orderid','','','DC Initiated','','$current_date_and_time','$currnt_userlogined')") or die(mysqli_error($mysqli));
								//echo $divided_order_id . ' - ' . $new_order_id;
								
								$sql_update = "UPDATE wpk4_backend_user_portal_requests SET change_done = '$divided_order_id', original_order_id='$order_id', reservation_ref='$divided_order_id', change_done_by = '$currnt_userlogined', change_done_on = '$current_date_and_time' WHERE case_id='$case_id'";
								$result_update= mysqli_query($mysqli,$sql_update);

								$finalco_order_id = $co_orderid;
								
								$count_pax_query_1 = "SELECT order_id, fname, lname, dob FROM wpk4_backend_travel_booking_pax WHERE order_id = '$divided_order_id'";
                                $result_count_pax_query_1 = mysqli_query($mysqli, $count_pax_query_1) or die(" Pax query failed: " . mysqli_error($mysqli));
                                $count_pax_array_1 = [];
                                while ($row_count_pax_query_1 = mysqli_fetch_assoc($result_count_pax_query_1)) 
								{
                                    $count_pax_array_1[] = $row_count_pax_query_1['order_id'].$row_count_pax_query_1['fname'].$row_count_pax_query_1['lname'].$row_count_pax_query_1['dob'];
                                }
								$count_pax_array_1 = array_unique($count_pax_array_1);	
								$count_divided_pax = count($count_pax_array_1);

								$sql_update_past_booking ="UPDATE wpk4_backend_travel_bookings
                                        SET total_pax = '$count_divided_pax'
                                        WHERE order_id = '$divided_order_id'";
                                $results_update_past_booking = $mysqli->query($sql_update_past_booking);
								
								
								$count_pax_query_2 = "SELECT order_id, fname, lname, dob FROM wpk4_backend_travel_booking_pax WHERE order_id = '$new_order_id'";
                                $result_count_pax_query_2 = mysqli_query($mysqli, $count_pax_query_2) or die(" Pax query failed: " . mysqli_error($mysqli));
                                $count_pax_array_2 = [];
                                while ($row_count_pax_query_2 = mysqli_fetch_assoc($result_count_pax_query_2)) 
								{
                                    $count_pax_array_2[] = $row_count_pax_query_2['order_id'].$row_count_pax_query_2['fname'].$row_count_pax_query_2['lname'].$row_count_pax_query_2['dob'];
                                }
								$count_pax_array_2 = array_unique($count_pax_array_2);	
								$count_non_divided_pax = count($count_pax_array_2);
								
								$sql_update_past_booking ="UPDATE wpk4_backend_travel_bookings
                                        SET total_pax = '$count_non_divided_pax'
                                        WHERE order_id = '$new_order_id'";
                                $results_update_past_booking = $mysqli->query($sql_update_past_booking);

								if($order_type != 'gds')
								{
									echo "<script>window.location.href='?p=manage-datechange-update-name-v1&part=booking-info-update&oid={$divided_order_id}&coid={$finalco_order_id}&new_oid={$new_order_id}';</script>";
								}
								else
								{
									echo "<script>window.location.href='?p=manage-datechange-update-name-v1&part=booking-info-update&oid={$divided_order_id}&coid={$finalco_order_id}&new_oid={$new_order_id}';</script>";
								}
								exit;
						}
						
						if (isset($_POST['without_divideorder'])) 
						{
							
								$order_id = $_GET['oid'];
								$case_id = $_GET['cid'];
								$orderid = $_POST['id'];
								$co_orderid = $_POST['co_orderid'] ?? '';
								$productid = $_POST['productid'] ?? '';
								//$order_type = $_POST['order_type'] ?? '';
								$selected_ids = $_POST['pax_ids_for_new_order'] ?? [];

								// Enable error reporting for mysqli
								mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT);
								
								if(empty($selected_ids))
								{
								    $all_pax_query = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
    								$result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));
    								while ($pax = mysqli_fetch_assoc($result_all_pax)) 
    								{
    								    $pax_a_id = $pax['auto_id'];
    								    $selected_ids[] = $pax_a_id;
    								}
								}
								
								$all_pax_query = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
								$result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));
								while ($pax = mysqli_fetch_assoc($result_all_pax)) 
								{
									if (in_array($pax['auto_id'], $selected_ids))
									{
									    $pax_a_id = $pax['auto_id'];
									    $fname = $pax['fname'];
									    $lname = $pax['lname'];
										$dob = $pax['dob'];
										$salutation = $pax['salutation'];
									    
									    $all_pax_query_inner = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE auto_id != '$pax_a_id' and order_id = '$orderid' and salutation = '$salutation' and fname = '$fname' and lname = '$lname' and dob = '$dob'";
								        $result_all_pax_inner = mysqli_query($mysqli, $all_pax_query_inner) or die(" Pax query failed: " . mysqli_error($mysqli));
										if( mysqli_num_rows($result_all_pax_inner) > 0)
										{
											$pax_inner = mysqli_fetch_assoc($result_all_pax_inner);
											$inner_a_id = $pax_inner['auto_id'];
											$selected_ids[] = $inner_a_id;
										}
									}
								}
								//print_r($selected_ids);
								
								$selected_ids = array_unique($selected_ids);	

								$res_max_order = mysqli_query($mysqli, "SELECT MAX(order_id) AS max_order_id FROM wpk4_backend_travel_bookings");
								$max_row = mysqli_fetch_assoc($res_max_order);
								$divided_order_id = $max_row['max_order_id'] + 1;

								// Fetch existing booking
								$res_booking = mysqli_query($mysqli, "SELECT * FROM wpk4_backend_travel_bookings WHERE order_id = '$order_id'");
                                if (!$res_booking || mysqli_num_rows($res_booking) === 0) {
                                    die(" No booking found for order_id = $order_id");
                                }

                                while ($booking_data = mysqli_fetch_assoc($res_booking)) {
                                    // Store current order_id as previous
                                    $booking_data['previous_order_id'] = $order_id;
                                
                                    // Remove auto-increment key
                                    unset($booking_data['auto_id']);
                                
                                    // Conditionally unset specific fields
                                    if (empty($booking_data['divided_date'])) unset($booking_data['divided_date']);
                                    if (empty($booking_data['late_modified'])) unset($booking_data['late_modified']);
                                    if (empty($booking_data['airline_ttl_deadline'])) unset($booking_data['airline_ttl_deadline']);
                                    if (empty($booking_data['price_time_limit'])) unset($booking_data['price_time_limit']);
                                    if (empty($booking_data['ticketing_timelimit'])) unset($booking_data['ticketing_timelimit']);
                                    if (empty($booking_data['return_date'])) unset($booking_data['return_date']);
									
									if (empty($booking_data['family_id'])) unset($booking_data['family_id']);
									if (empty($booking_data['journal_date'])) unset($booking_data['journal_date']);
									
									unset($booking_data['payment_modified']);
									$booking_data['source'] = "datechange";
                                    $booking_data['payment_status'] = "partially_paid";
									//$booking_data['deposit_deadline'] = date("Y-m-d") . ' 23:59:59';
									//$booking_data['full_payment_deadline'] = date("Y-m-d") . ' 23:59:59';
									
									$booking_data['deposit_deadline'] = date("Y-m-d H:i:s", strtotime("+1 day"));
									$booking_data['full_payment_deadline'] = date("Y-m-d H:i:s", strtotime("+1 day"));
									$booking_data['agent_info'] = $currnt_userlogined;
									
									$booking_data['added_on'] = date("Y-m-d H:i:s");
                                
                                    // Change to divided_order_id and insert again
                                    $booking_data['order_id'] = $divided_order_id;
                                    
                                    $columns = array_keys($booking_data);
                                    $values = array_map(function ($val) use ($mysqli) {
                                        if (!empty($val))
											{
												return "'" . mysqli_real_escape_string($mysqli, $val) . "'";
											}
											else
											{
												return "'" . $val . "'";
											}
                                    }, array_values($booking_data));
                                
                                    $insert_booking = "INSERT INTO wpk4_backend_travel_bookings (" . implode(',', $columns) . ") VALUES (" . implode(',', $values) . ")";
                                    if (!mysqli_query($mysqli, $insert_booking)) {
                                        die(" Booking insert failed (divided_order_id): " . mysqli_error($mysqli));
                                    }
                                }


								// Process unselected passengers
								$all_pax_query = "SELECT * FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' ";
								$result_all_pax = mysqli_query($mysqli, $all_pax_query) or die(" Pax query failed: " . mysqli_error($mysqli));

								while ($pax = mysqli_fetch_assoc($result_all_pax)) {
								    
									if (in_array($pax['auto_id'], $selected_ids)) {
										$original_auto_id = $pax['auto_id']; // store before unset
										$pax['order_id'] = $divided_order_id;

										unset($pax['auto_id']);
										if (empty($pax['trams_profile_id'])) unset($pax['trams_profile_id']);
										if (empty($pax['customer_id'])) unset($pax['customer_id']);
										unset($pax['ticket_number']);
										unset($pax['ticketed_by']);
										unset($pax['ticketed_on']);
										unset($pax['ticketing_audit_on']);
										unset($pax['name_audit_on']);
										unset($pax['ticketing_remarks_on']);
										unset($pax['ticketing_in_progress_on']);
										
										unset($pax['name_update_check']);
										unset($pax['name_update_check_on']);

										$columns = array_keys($pax);
										$values = array_map(function ($val) use ($mysqli) {
											if (!empty($val))
											{
												return "'" . mysqli_real_escape_string($mysqli, $val) . "'";
											}
											else
											{
												return "'" . $val . "'";
											}
										}, array_values($pax));

										$insert_pax = "INSERT INTO wpk4_backend_travel_booking_pax (" . implode(',', $columns) . ") VALUES (" . implode(',', $values) . ")";
										if (!mysqli_query($mysqli, $insert_pax)) {
											echo " PAX insert failed: " . mysqli_error($mysqli);
										}
									}
								}
								
								//echo $order_type;
								if ($order_type == 'gds') // GDS
                                {
                                    // Step 4: Copy all related history updates
                                    $res_hist = $mysqli->query("SELECT * FROM wpk4_backend_history_of_updates WHERE type_id = '$orderid'");
                                    if (!$res_hist) {
                                        echo "History Error: " . $mysqli->error;
                                        exit;
                                    }
                                
                                    // Store all history rows
                                    $all_hist_rows = [];
                                    while ($row = $res_hist->fetch_assoc()) {
                                        $all_hist_rows[] = $row;
                                    }
                                    // First loop: insert with new_order_id
                                    foreach ($all_hist_rows as $hist) {
                                        $hist['type_id'] = $divided_order_id;
                                        unset($hist['auto_id']);
                                
                                        // Remove null or empty values
                                        $hist = array_filter($hist, function($value) {
                                            return $value !== null && $value !== '';
                                        });
                                
                                        $columns = implode(", ", array_keys($hist));
                                        $values = implode("', '", array_map([$mysqli, 'real_escape_string'], array_values($hist)));
                                
                                        $insert_hist = "INSERT INTO wpk4_backend_history_of_updates ($columns) VALUES ('$values')";
                                        if (!$mysqli->query($insert_hist)) {
                                            echo " Error inserting history update (new_order_id): " . $mysqli->error . "<br>Query: $insert_hist";
                                            exit;
                                        }
                                    }
                                }

								$is_ticketed = 0;
								$all_pax_query_ticket_finder = "SELECT ticket_number FROM wpk4_backend_travel_booking_pax WHERE order_id = '$orderid' and ticket_number is not null";
								$result_all_pax_ticket_finder = mysqli_query($mysqli, $all_pax_query_ticket_finder) or die(" Pax query failed: " . mysqli_error($mysqli));
								while ($pax_ticket_finder = mysqli_fetch_assoc($result_all_pax_ticket_finder)) 
								{
									if($pax_ticket_finder['ticket_number'] != '')
									{
										$is_ticketed = 1;
										break;
									}
								}
								if($is_ticketed == 0)
								{
									$total_paid_for_booking_transfer = 0.00;
									$processedPayments = array();
									$query_total_paid_for_requestid = "SELECT * FROM wpk4_backend_travel_payment_history where order_id = '$orderid' AND (pay_type = 'deposit' OR pay_type = 'balance' 
													OR pay_type = 'Balance' OR pay_type = 'deposit_adjustment' OR pay_type = 'additional_payment')";
									$result_total_paid_for_requestid = mysqli_query($mysqli, $query_total_paid_for_requestid);
									while($row_total_paid_for_requestid = mysqli_fetch_assoc($result_total_paid_for_requestid))
									{
										$payment_identifier = $row_total_paid_for_requestid['trams_received_amount'].'^'.$row_total_paid_for_requestid['reference_no']; 
                                    		if (in_array($payment_identifier, $processedPayments)) 
                                    		{
												continue; // Skip to the next value
                                    		}
											
										$processedPayments[] = $payment_identifier;						

										$total_paid_for_booking_transfer += (float)$row_total_paid_for_requestid['trams_received_amount'];
									}
									
									if($total_paid_for_booking_transfer > 0) 
									{
										$total_paid_for_booking_transfer_minus = '-'.$total_paid_for_booking_transfer;
										
										$remark_for_past_booking = 'amount transfered to - '. $divided_order_id . ' by Customer Portal DC';
										$remark_for_new_booking = 'amount transfered from - '. $orderid . ' by Customer Portal DC';
										
										mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history (order_id, source, trams_received_amount, reference_no, payment_method, process_date, pay_type, added_on, added_by) 
										values ('$orderid', '$order_type', '$total_paid_for_booking_transfer_minus', '$remark_for_past_booking', '14', '$current_date_and_time', 'deposit_adjustment', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
										
										mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_history (order_id, source, trams_received_amount, reference_no, payment_method, process_date, pay_type, added_on, added_by) 
										values ('$divided_order_id', '$order_type', '$total_paid_for_booking_transfer', '$remark_for_new_booking', '14', '$current_date_and_time', 'deposit_adjustment', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
										
									}
								
								}
								
                                $sql_update_past_booking ="UPDATE wpk4_backend_travel_bookings
                                                                    SET payment_status = 'voucher_submited', payment_modified = '$current_date_and_time', payment_modified_by = 'customer_portal_dc'
                                                                WHERE order_id = '$orderid'";
                                                                $results_update_past_booking = $wpdb->query($sql_update_past_booking);
                                                                
                                                                if ($results_update_past_booking > 0) 
                                                                {
																	if($order_type != 'gds')
																	{
																		$query_stock_check = "SELECT trip_code, travel_date, total_pax FROM wpk4_backend_travel_bookings where order_id = '$orderid' and order_type != 'gds'";
																		$result_stock_check = mysqli_query($mysqli, $query_stock_check);
																		if(mysqli_num_rows($result_stock_check) > 0 )
																		{
																			while($row_stock_check = mysqli_fetch_assoc($result_stock_check))
																			{
																					
																				$trip_code = $row_stock_check['trip_code'];
																				$travel_date = $row_stock_check['travel_date'];
																				$total_pax = $row_stock_check['total_pax'];
																				
																				update_stock_in_pricing_table($trip_code, $travel_date, $total_pax, 'negative');
																				
																				$by_user = 'dc_in_customer_portal';
																																						
																				availability_table_pax_update($order_id, $by_user);
																			}
																		}
																	}
																	
                                                                    mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
    					                                            values ('$orderid','','','payment_status','Rebooked','$current_date_and_time','$currnt_userlogined')") or die(mysqli_error($mysqli));
                                                                } 

								mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
    					         values ('$orderid','','','DC Initiated','','$current_date_and_time','$currnt_userlogined')") or die(mysqli_error($mysqli));

								$sql_update = "UPDATE wpk4_backend_user_portal_requests SET change_done = '$divided_order_id', original_order_id='$order_id', reservation_ref='$divided_order_id', change_done_by = '$currnt_userlogined', change_done_on = '$current_date_and_time' WHERE case_id='$case_id'";
								$result_update= mysqli_query($mysqli,$sql_update);

								$finalco_order_id = $co_orderid;

								
								echo "<script>window.location.href='?p=manage-datechange-update-name-v1&part=booking-info-update&oid={$divided_order_id}&coid={$finalco_order_id}&new_oid=';</script>";
								
								
								exit;
						}
					}
											
						if(isset($_GET['p']) && $_GET['p'] =='manage-datechange-update-name-v1' && isset($_GET['part']) && $_GET['part'] == 'booking-info-update')
						{
						    echo '</br></br></br>';
						    $order_id = $_GET['oid'];
							$co_order_id = $_GET['coid'] ?? '';
							$new_order_id = $_GET['new_oid'] ?? '';
							
							
						    
						    $query_pax = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id' ";
							//echo $query_pax;
                    		$result_pax = mysqli_query($mysqli, $query_pax);
                    		?>
							<form action="#" name="statusupdate" method="post" enctype="multipart/form-data" style='font-size:13px;'>
                    		<h6>Order ID : <?php echo $order_id; ?></h6>
							
							Airline Change Fee
                        	<input type='text' name='airline_change_fee' required id='airline_change_fee'></br>
							
							Fare Difference
                        	<input type='text' name='fare_difference' required id='fare_difference'></br>
							
							Gaura Travel Service Fee
                        	<input type='text' name='gaura_service_fee' required id='gaura_service_fee'></br>
							
							Buffer
                        	<input type='text' name='buffer' required id='buffer'></br>
							
							Cost Given / Datechange Amount (Amount to be requested from customer)
                        	<input type='text' name='total_amount' required id='dc_amount'></br>
                    		<?php
                    		if(!empty($result_pax))
                    		{
                    		    ?>
                    		    
                    		    <?php
                    			$row_pax = mysqli_fetch_assoc($result_pax);
                    			{
                    			    //$auto_id = $row_pax['auto_id'];
                    				$order_id = $row_pax['order_id'];
                    				$co_order_id_db = $row_pax['co_order_id'];
                    				$product_id = $row_pax['product_id'];
                    				$order_type = $row_pax['order_type'];
                    				$t_type = $row_pax['t_type'];
                    				$total_pax = $row_pax['total_pax'];
									$previous_order_id_sql = $row_pax['previous_order_id'];
									
									$query_pax_2 = "SELECT pnr FROM wpk4_backend_travel_booking_pax where order_id='$order_id' and product_id = '$product_id' order by auto_id asc ";
									$result_pax_2 = mysqli_query($mysqli, $query_pax_2);
									$row_pax_2 = mysqli_fetch_assoc($result_pax_2);
									$pnr = $row_pax_2['pnr'];
                    				
									$query_pax_5 = "SELECT auto_id, fname, lname, salutation, pnr, product_id, dob FROM wpk4_backend_travel_booking_pax where order_id='$order_id' and product_id = '$product_id' order by auto_id asc ";
									$result_pax_5 = mysqli_query($mysqli, $query_pax_5);
									while($row_pax_5 = mysqli_fetch_assoc($result_pax_5))
									{
										$auto_id = $row_pax_5['auto_id'];
                    				    ?>
                        				    First Name
                        				    <input type='text' name='<?php echo $auto_id; ?>_fname' id='trip_code' value="<?php echo $row_pax_5['fname']; ?>"></br>
                        				    Last Name
                        				    <input type='text' name='<?php echo $auto_id; ?>_lname' value="<?php echo $row_pax_5['lname']; ?>"></br>
                        				    Salutation
											<select name='<?php echo $auto_id; ?>_salutation' style="width:100%; height:36px;">
												<option value="Mr" <?php if(strtolower($row_pax_5['salutation']) == 'mr') { echo 'selected'; } ?>>Mr</option>
												<option value="Mstr" <?php if(strtolower($row_pax_5['salutation']) == 'mstr') { echo 'selected'; } ?>>Mstr</option>
												<option value="Mrs" <?php if(strtolower($row_pax_5['salutation']) == 'mrs') { echo 'selected'; } ?>>Mrs</option>
												<option value="Ms" <?php if(strtolower($row_pax_5['salutation']) == 'ms') { echo 'selected'; } ?>>Ms</option>
												<option value="Miss" <?php if(strtolower($row_pax_5['salutation']) == 'miss') { echo 'selected'; } ?>>Miss</option>
											</select></br></br>
											DOB
											<input type='text' name='<?php echo $auto_id; ?>_dob' value="<?php echo $row_pax_5['dob']; ?>"></br>
                        				    </br></br>
                    				    <?php
									}
                    			}
                    			echo "<input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='submit_gds_changes' value='Next'>
                        		</form>";
                    		}
                    		
                    		if (isset($_POST['submit_gds_changes'])) 
                    		{
								$current_time_modified = date('Y-m-d H:i:s');
								
								$totalAmountRequest = $_POST['total_amount'];
								
								$airline_change_fee = $_POST['airline_change_fee'];
								$fare_difference = $_POST['fare_difference'];
								$gaura_service_fee = $_POST['gaura_service_fee'];
								$buffer = $_POST['buffer'];
								
								$row_case_id = '';
								$query_case_checker = "SELECT case_id FROM wpk4_backend_user_portal_requests WHERE reservation_ref = '$order_id'";
								$result_case_checker = mysqli_query($mysqli, $query_case_checker);	
								if(mysqli_num_rows($result_case_checker) > 0)
								{
									$row_case_checker = mysqli_fetch_assoc($result_case_checker);
									$row_case_id = $row_case_checker['case_id'] ;
								}
								
								
								/*mysqli_query($mysqli,"insert into wpk4_backend_travel_bookings_datechange (order_id, dc_amount, total_amount, added_by, added_on ) 
								values ('$order_id', '$totalAmountRequest', '$totalAmountRequest', 'date_change', '$current_time_modified')") or die(mysqli_error($mysqli));
								
								
								
									
								$update_query5 = "UPDATE wpk4_backend_travel_bookings SET total_amount = '$totalAmountRequest', deposit_amount='0', balance = '$totalAmountRequest' WHERE order_id = '$order_id'";
								//echo $update_query5.'</br>';
                                $result5 = mysqli_query($mysqli, $update_query5);
								*/
								
								
								mysqli_query($mysqli,"insert into wpk4_backend_travel_bookings_datechange_cost_breakdown (case_id, order_id, airline_change_fee, fare_difference, gaura_service_fee, buffer, total_amount, added_by, submit_source ) 
								values ('$row_case_id', '$order_id', '$airline_change_fee', '$fare_difference', '$gaura_service_fee', '$buffer', '$totalAmountRequest', '$currnt_userlogined', 'CS DC Name Update')") or die(mysqli_error($mysqli));
								
								
								$all_pax_query_ticket_finder_booking = "SELECT previous_order_id FROM wpk4_backend_travel_bookings WHERE order_id = '$order_id' ";
								$result_all_pax_ticket_finder_booking = mysqli_query($mysqli, $all_pax_query_ticket_finder_booking) or die(" Pax query failed: " . mysqli_error($mysqli));
								$pax_ticket_finder_booking = mysqli_fetch_assoc($result_all_pax_ticket_finder_booking);
								$previous_order_id_new = $pax_ticket_finder_booking['previous_order_id'];
								
								$all_pax_query_ticket_finder_booking2 = "SELECT order_id, product_id FROM wpk4_backend_travel_bookings WHERE order_id = '$previous_order_id_new' ";
								echo $all_pax_query_ticket_finder_booking2.'</br>';
								$result_all_pax_ticket_finder_booking2 = mysqli_query($mysqli, $all_pax_query_ticket_finder_booking2) or die(" Pax query failed: " . mysqli_error($mysqli));
								$pax_ticket_finder_booking2 = mysqli_fetch_assoc($result_all_pax_ticket_finder_booking2);
								$previous_product_id_new = $pax_ticket_finder_booking2['product_id'];
								
								$is_ticketed = 0;
								$all_pax_query_ticket_finder = "SELECT ticket_number FROM wpk4_backend_travel_booking_pax WHERE order_id = '$previous_order_id_new' and product_id = '$previous_product_id_new' and ticket_number is not null";
								$result_all_pax_ticket_finder = mysqli_query($mysqli, $all_pax_query_ticket_finder) or die(" Pax query failed: " . mysqli_error($mysqli));
								while ($pax_ticket_finder = mysqli_fetch_assoc($result_all_pax_ticket_finder)) 
								{
									if($pax_ticket_finder['ticket_number'] != '')
									{
										$is_ticketed = 1;
										break;
									}
								}									
								
								if($totalAmountRequest > 0)
								{
									$total_calculated = $totalAmountRequest;
									if(isset($_GET['new_oid']) && $_GET['new_oid'] != '') // Partial DC
									{
										$query_amt_check = "SELECT total_amount FROM wpk4_backend_travel_bookings where order_id = '$order_id'";
										$result_amt_check = mysqli_query($mysqli, $query_amt_check);
										if(mysqli_num_rows($result_amt_check) > 0 )
										{
											$row_amt_check = mysqli_fetch_assoc($result_amt_check);
											$total_amount_existing = $row_amt_check['total_amount'];
											
											$total_calculated = (float)$totalAmountRequest + (float)$total_amount_existing;
											$total_calculated = number_format((float)$total_calculated, 2, '.', '') ;
										}
										
										$query_amt_check2 = "SELECT meta_value FROM wpk4_backend_history_of_updates where type_id = '$order_id' and meta_key = 'Transaction TotalTurnover'";
										$result_amt_check2 = mysqli_query($mysqli, $query_amt_check2);
										if(mysqli_num_rows($result_amt_check2) > 0 )
										{
											$row_amt_check2 = mysqli_fetch_assoc($result_amt_check2);
											$total_amount_existing = $row_amt_check2['meta_value'];
											
											$total_calculated = (float)$totalAmountRequest + (float)$total_amount_existing;
											$total_calculated = number_format((float)$total_calculated, 2, '.', '') ;
											
										}
									}
									else
									{
										if($is_ticketed == 0) // no ticket issued
										{
											$query_amt_check = "SELECT total_amount FROM wpk4_backend_travel_bookings where order_id = '$order_id'";
											$result_amt_check = mysqli_query($mysqli, $query_amt_check);
											if(mysqli_num_rows($result_amt_check) > 0 )
											{
												$row_amt_check = mysqli_fetch_assoc($result_amt_check);
												$total_amount_existing = $row_amt_check['total_amount'];
												
												$total_calculated = (float)$totalAmountRequest + (float)$total_amount_existing;
												$total_calculated = number_format((float)$total_calculated, 2, '.', '') ;
											}
											
											$query_amt_check2 = "SELECT meta_value FROM wpk4_backend_history_of_updates where type_id = '$order_id' and meta_key = 'Transaction TotalTurnover'";
											$result_amt_check2 = mysqli_query($mysqli, $query_amt_check2);
											if(mysqli_num_rows($result_amt_check2) > 0 )
											{
												$row_amt_check2 = mysqli_fetch_assoc($result_amt_check2);
												$total_amount_existing = $row_amt_check2['meta_value'];
												
												$total_calculated = (float)$totalAmountRequest + (float)$total_amount_existing;
												$total_calculated = number_format((float)$total_calculated, 2, '.', '') ;
												
											}
										}
										else 
										{
											$total_calculated = $totalAmountRequest;
										}
									}
									
																		
									$update_query5 = "UPDATE wpk4_backend_travel_bookings SET total_amount = '$total_calculated', deposit_amount='0', balance = '0' WHERE order_id = '$order_id'";
									//echo $update_query5.'</br>';
									$result5 = mysqli_query($mysqli, $update_query5);
									
									$update_query_turnover = "UPDATE wpk4_backend_history_of_updates SET meta_value = '$total_calculated' WHERE type_id = '$order_id' and meta_key = 'Transaction TotalTurnover'";
									$result_turnover = mysqli_query($mysqli, $update_query_turnover);
									
									$update_query_amt = "UPDATE wpk4_backend_history_of_updates SET meta_value = '$total_calculated' WHERE type_id = '$order_id' and meta_key = 'Payments Amount'";
									$result_amt = mysqli_query($mysqli, $update_query_amt);
									
									mysqli_query($mysqli,"insert into wpk4_backend_travel_bookings_datechange (order_id, dc_amount, total_amount, added_by, added_on ) 
									values ('$order_id', '$totalAmountRequest', '$total_calculated', 'date_change', '$current_date_and_time')") or die(mysqli_error($mysqli));
									
									
									//mysqli_query($mysqli,"insert into wpk4_backend_travel_bookings_datechange (order_id, dc_amount, total_amount, added_by, added_on ) 
									//values ('$order_id', '$dc_amount', '$total_amount_dc', 'date_change', '$current_date_and_time')") or die(mysqli_error($mysqli));
									
									//$update_query5 = "UPDATE wpk4_backend_travel_bookings SET total_amount = '$dc_amount', deposit_amount='0', balance = '$dc_amount' WHERE order_id = '$order_id'";
									//echo $update_query5.'</br>';
									//$result5 = mysqli_query($mysqli, $update_query5);
								}
								
								
								
								
								
									
								$query_2_checker = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id'";
								$result_2_checker = mysqli_query($mysqli, $query_2_checker);
								$is_updatedf = 0;
								while($row_2_checker = mysqli_fetch_assoc($result_2_checker))
								{
									$row_auto_id_pax = $row_2_checker['auto_id'];
									
									foreach($row_2_checker as $columnname_db => $db_value)
									{
										$dbcolumn_and_postname_checker = $row_auto_id_pax.'_'.$columnname_db;
										foreach ($_POST as $post_fieldname => $post_fieldvalue) 
										{
											echo $post_fieldname . ' ' . $db_value . ' ' . $dbcolumn_and_postname_checker . ' ' . $post_fieldvalue .'</br>';
											if($post_fieldname == $dbcolumn_and_postname_checker && $db_value != $post_fieldvalue)
											{
												echo 'updating value </br>';
												
												$is_updatedf = 1;
												$query_4_pp_selecter = "SELECT * FROM wpk4_backend_travel_booking_pax where auto_id = '$row_auto_id_pax' ";
												$result_4_pp_selecter = mysqli_query($mysqli, $query_4_pp_selecter);
												$row_4_pp_selecter = mysqli_fetch_assoc($result_4_pp_selecter);
												$cus_fname = $row_4_pp_selecter['fname'];
												$cus_lname = $row_4_pp_selecter['lname'];
												$cus_dob = $row_4_pp_selecter['dob'];
												
						
												$sql_update_pax = "UPDATE wpk4_backend_travel_booking_pax SET $columnname_db='$post_fieldvalue' WHERE order_id='$order_id' AND fname = '$cus_fname' AND lname = '$cus_lname' AND dob = '$cus_dob'";
												$resultpax= mysqli_query($mysqli,$sql_update_pax);
												
												mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
												values ('$order_id','','$row_auto_id_pax','$columnname_db','$post_fieldvalue','$current_time_modified','$currnt_userlogined')") or die(mysqli_error($mysqli));
											

											}
										}
									}
									if($is_updatedf==1)
									{
										$sql_update_pax2 = "UPDATE wpk4_backend_travel_booking_pax SET late_modified='$current_time_modified',modified_by = '$currnt_userlogined' WHERE auto_id='$row_auto_id_pax'";
										$resultpax2= mysqli_query($mysqli,$sql_update_pax2);
										
									}
								}
								  
                                   echo '<script>window.location.href="?p=manage-datechange-update-name-v1&part=generate-payment-link&oid='.$order_id.'&coid='.$co_order_id.'&new_oid='.$new_order_id.'";</script>';
								
                            }
						}
						
						if(isset($_GET['p']) && $_GET['p'] =='manage-datechange-update-name-v1' && isset($_GET['part']) && $_GET['part'] == 'generate-payment-link')
						{
						    echo '</br></br></br>';
						    $order_id = $_GET['oid'];
							$co_order_id = $_GET['coid'] ?? '';
						    ?>
							<center>
							<h5>Date change process is done.</h5>
							<h5>Please instruct customer to make their balance payment through Customer Portal.</h5>
							</br></br>
							<h3>Datechange Order ID: <?php echo $order_id; ?></h3>
							</center>
							<?php
							$query_booking_check = "SELECT trip_code, travel_date, total_pax, product_id FROM wpk4_backend_travel_bookings where order_id = $order_id";
							$result_booking_check = mysqli_query($mysqli, $query_booking_check);
							if(mysqli_num_rows($result_booking_check) > 0 )
                            {
                                while($row_bookings = mysqli_fetch_assoc($result_booking_check))
                                {
                                    $product_id = $row_bookings['product_id'];
                                    echo '</br><h5>'.$row_bookings['trip_code'] . ' - ' . date("d/m/Y", strtotime( $row_bookings['travel_date'] )) . '</h5>';
                                    
                                    $query_pax_check = "SELECT fname, lname, dob FROM wpk4_backend_travel_booking_pax where order_id = $order_id and product_id = '$product_id'";
        							$result_pax_check = mysqli_query($mysqli, $query_pax_check) or die("Pax query failed: " . mysqli_error($mysqli));
        							if(mysqli_num_rows($result_pax_check) > 0 )
                                    {
                                        echo '<table class="table table-striped" style="width:100%; margin:auto;font-size:14px; margin-top:35px;"><tr>
                                            <th>Pax Name</th>
                                            <th>DOB</th>
                                            </tr>';
                                        while($row_pax = mysqli_fetch_assoc($result_pax_check))
                                        {
                                            echo '<tr>
                                                    <td style="height:40px;">'.$row_pax['fname'] . ' ' . $row_pax['lname'] .'</td>
                                                    <td style="height:40px;">'.$row_pax['dob'].'</td>
                                                </tr>';
                                        }
                                    }
                                    
                                    echo '</table>';
                                }
                            }
							?>
                            </br></br>
							<?php
							if(isset($_GET['new_oid']) && $_GET['new_oid'] != '')
							{
							    $new_order_id = $_GET['new_oid'];
								?>
								<center>
								<h3>Non Datechange Order ID: <?php echo $_GET['new_oid']; ?></h3>
								</center>
								<?php
								
								$query_booking_check = "SELECT trip_code, travel_date, total_pax, product_id FROM wpk4_backend_travel_bookings where order_id = $new_order_id";
    							$result_booking_check = mysqli_query($mysqli, $query_booking_check);
    							if(mysqli_num_rows($result_booking_check) > 0 )
                                {
                                    while($row_bookings = mysqli_fetch_assoc($result_booking_check))
                                    {
                                        $product_id = $row_bookings['product_id'];
                                        echo '</br><h5>'.$row_bookings['trip_code'] . ' - ' . date("d/m/Y", strtotime( $row_bookings['travel_date'] )) . '</h5>';
                                        $query_pax_check = "SELECT fname, lname, dob FROM wpk4_backend_travel_booking_pax where order_id = $new_order_id and product_id = '$product_id'";
            							$result_pax_check = mysqli_query($mysqli, $query_pax_check) or die("Pax query failed: " . mysqli_error($mysqli));
            							if(mysqli_num_rows($result_pax_check) > 0 )
                                        {
                                            echo '<table class="table table-striped" style="width:100%; margin:auto;font-size:14px; margin-top:35px;"><tr>
                                                <th>Pax Name</th>
                                                <th>DOB</th>
                                                </tr>';
                                            while($row_pax = mysqli_fetch_assoc($result_pax_check))
                                            {
                                                echo '<tr>
                                                        <td style="height:40px;">'.$row_pax['fname'] . ' ' . $row_pax['lname'] .'</td>
                                                        <td style="height:40px;">'.$row_pax['dob'].'</td>
                                                    </tr>';
                                            }
                                        }
                                        
                                        echo '</table>';
                                    }
                                }
							}
						}
						
						
						
						
						
						
						
						
						
						
						
						
						
						
											
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
					
						
						if(isset($_GET['p']) && $_GET['p'] =='admin-request-view') //admin view perticular request
							{
								$user_roles = $current_user->roles;
								$case_id = $_GET['id'];	
								$enc_auto_id = md5($case_id);	
								$enc_auto_id_url = $_GET['co'];	
								$casetype = $_GET['casetype'];
								
								$case_type_role_name_array = $casetype.'_user_roles';
								$case_type_role_name_generic_array = $casetype.'_user_roles_generic';
								?>
								<h5>View Case</h5>
								<?php
								$x_id = 1;
								if($enc_auto_id == $enc_auto_id_url)
								{
								
								
								$sql_seenupdate = "UPDATE wpk4_backend_user_portal_requests SET is_seen_by_gt='1' WHERE case_id='$case_id'";
								$result_seenupdate= mysqli_query($mysqli,$sql_seenupdate);
								
								$query = "SELECT * FROM wpk4_backend_user_portal_requests where case_id = '$case_id'";
								$result = mysqli_query($mysqli, $query);
								$row = mysqli_fetch_assoc($result);

								$case_id = $row['case_id'];
								$user_id = $row['user_id'];
								$order_id = $row['reservation_ref'];
								$status = $row['status'];
								$sub_status = $row['sub_status'];
								$request_date = $row['case_date'];
								$updated_by = $row['updated_by'];
								$last_response_by = $row['last_response_by'];
								$priority = $row['priority'];
								
								$is_submitted_by_customer = is_numeric($user_id); // check whether its submitted by agent or customer 
								
								$user_fullname = get_user_fullname($user_id);
    							$emailid = get_user_emailid($user_id);
							    
								$subject = get_userportal_post_meta($case_id, 'subject');
								
								
								
								?>
								<div class="tab-pane message-body active" id="inbox-message-1">
										<div class="message-chat">
											<div class="chat-body">
												<div class="table-responsive margin-bottom-2x header-msgbox">
												
								<div class="wpb_wrapper">
									<div class="vc_row wpb_row vc_inner vc_row-fluid vc_row-o-equal-height " style="display: flex;">
										<div class="wpb_column vc_column_container vc_col-sm-6">
											<div class="vc_column-inner">
												<div class="wpb_wrapper">
													<div class="wpb_text_column wpb_content_element ">
														<div class="wpb_wrapper">
									
														<h5>Case ID #<?php echo $case_id; ?> - <?php echo $casetype; ?></h5>
														<h4><?php echo (strlen($subject) > 70 ? substr($subject, 0, 70).'...' : $subject); ?></h4>
													</div>
													</div>
												</div>
											</div>
										</div>
										<div class="wpb_column vc_column_container vc_col-sm-6" >
											<div class="vc_column-inner">
												<div class="wpb_wrapper">
													<div class="wpb_text_column wpb_content_element">
														<div class="wpb_wrapper" style='float:right;'>
														   <?php
															if($row['status'] == 'open' || $row['status'] == 'success')
															{
															?>
																<span class="badge badge-success"><?php echo $row['status']; ?></span> 
															<?php
															}
															else
															{
															?>
																<span class="badge badge-danger"><?php echo $row['status']; ?></span>  
															<?php	
															}
															?>
															<?php if($last_response_by =='admin') 
															{ 
																echo '<span class="badge badge-primary">Awaiting for reply</span>'; 
															} 
															else 
															{
																echo '<span class="badge badge-warning">Awaiting for GT Reply</span>'; 
															} ?>
														</br>		
													<h5 style='margin-top:10px;'>on <?php echo $request_date; ?> by <?php if($user_fullname != '') { echo $user_fullname; } else { echo $user_id; } ?></h5>
													
													</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div></br>
								</div></br>
						
							<?php
								
								
                                // Get the case ID from the URL
                                $case_id1 = isset($_GET['id']) ? $_GET['id'] : '0';
                                
                                if ($case_id1 > 0 && $casetype == 'complaint') {
                                    global $wpdb;
                                    
                                    // Query to get the complaint type from the meta table
                                    $complaint_type = $wpdb->get_var(
                                        $wpdb->prepare(
                                            "SELECT meta_value 
                                            FROM wpk4_backend_user_portal_request_meta 
                                            WHERE case_id = %s 
                                            AND meta_key = 'complaint_type' 
                                            LIMIT 1",
                                            $case_id1
                                        )
                                    );
                                    
                                    // Display the complaint type if found
                                    if ($complaint_type) {
                                        echo '<div class="complaint-type-display">';
                                        echo '<strong>Complaint Type:</strong> ' . esc_html($complaint_type);
                                        echo '</div>';
                                    } else {
                                        echo '<div class="complaint-type-display">';
                                        echo '<strong>Complaint Type:</strong> Not specified';
                                        echo '</div>';
                                    }
                                }
                                ?>
														
								<br><br>
								
							<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#contactinfo">Check Contact Information</button>
								<div class="modal fade" id="contactinfo" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
								  <div class="modal-dialog" role="document">
									<div class="modal-content">
									  <div class="modal-header">
										
									  </div>
									  <div class="modal-body">
										Email: <?php echo get_userportal_post_meta($case_id, 'email_address'); ?></br>
										Phone Number: <?php echo get_userportal_post_meta($case_id, 'phone_number'); ?></br>
									  </div>
									  <div class="modal-footer">
										<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
									  </div>
									</div>
								  </div>
								</div>
							<?php
							if($casetype == 'refund')
							{
								?>
								<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#paxinfo">Check Ticket Information</button>
								<div class="modal fade" id="paxinfo" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
								  <div class="modal-dialog" role="document">
									<div class="modal-content">
									  <div class="modal-header">
										
									  </div>
									  <div class="modal-body">
										Pax: <?php echo get_userportal_post_meta($case_id, 'passenger_names'); ?></br>
										Ticket Numbers: <?php echo get_userportal_post_meta($case_id, 'ticket_numbers'); ?></br>
									  </div>
									  <div class="modal-footer">
										<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
									  </div>
									</div>
								  </div>
								</div>
								<?php
							}
							?>
								<?php
										if($casetype == 'refund')
										{
										?><div style='margin-left:20px;float:right;'>
											<a href="?p=refund-manager&cid=<?php echo $case_id; ?>&oid=" class="btn btn-success view_hidden_options2">Refund Process</a></div>
										<?php
										}
										?>
								
								<div style='margin-left:20px;float:right;'>
										<script>
										function parse_user_teammember(val)
										{
											var element = document.getElementById("teammembers");
											element.value = val;
										}
										function parse_teammember_userstatus(val)
										{
											var element = document.getElementById("teammembers_status");
											element.value = val;
										}
										</script>
										
										<form action="#" method="post" enctype="multipart/form-data">
										<?php
										//echo $case_type_role_name_generic_array; 
										
										if (is_array(${$case_type_role_name_array}) && in_array($currnt_userlogined, ${$case_type_role_name_generic_array})) 
										{
												?>
												&nbsp;&nbsp;&nbsp;User: <select name="teammembers_status" onclick="parse_user_teammember(this.value)" required id="teammembers_status" style="width:170px; height:30px; font-size:12px; border-color: #dcd7ca;">
													<?php
													$query_agents = "SELECT * FROM wpk4_backend_user_portal_generic_users where generic_id = '$currnt_userlogined' ORDER BY user_name ASC"; // get agent names under loged generic login
													$result_agents = mysqli_query($mysqli, $query_agents);
													while($row_agents = mysqli_fetch_assoc($result_agents))
													{
														?>
														<option value="<?php echo $row_agents['user_name']; ?>"><?php echo $row_agents['name']; ?></option>
														<?php
													}
													?>
												</select>
												<?php
										}
										else
											{
												echo '<input type="hidden" name="teammembers_status" id="teammembers_status" value="'.$currnt_userlogined.'">';
											}
											
											//default status conditions
											$is_user_change_status_basic = 'disabled';
											$is_user_change_status_awating = 'disabled';
											$is_user_change_status_cancel = 'disabled';
											$is_user_change_status_cancel_sub = 'disabled';
											
											
											
											if ((count(array_intersect($user_roles, ${$case_type_role_name_array})) > 0) && $_GET['casetype'] != 'ssr_request')
											{	
												$matchingRoles = array_intersect($user_roles, ${$case_type_role_name_array});
												foreach ($matchingRoles as $rolevalues) 
												{	
													if (strpos($rolevalues, 'ho_operations') !== false )
													{
														$is_user_change_status_basic = '';
														$is_user_change_status_awating = '';
														$is_user_change_status_cancel = '';
														$is_user_change_status_cancel_sub = '';
													}
													else if (strpos($rolevalues, 'datechange_manager') !== false )
													{
														$is_user_change_status_basic = '';
														$is_user_change_status_awating = '';
														$is_user_change_status_cancel = '';
														$is_user_change_status_cancel_sub = '';
													}
													else if (strpos($rolevalues, 'administrator') !== false)
													{
														$is_user_change_status_basic = '';
														$is_user_change_status_awating = '';
														$is_user_change_status_cancel = '';
														$is_user_change_status_cancel_sub = '';
													}
													else if (strpos($rolevalues, 'editor_admin_2') !== false)
													{
														$is_user_change_status_basic = '';
														$is_user_change_status_awating = '';
														$is_user_change_status_cancel = 'disabled';
														$is_user_change_status_cancel_sub = '';
													}
													else if (strpos($rolevalues, 'editor_admin') !== false)
													{
													   
														$is_user_change_status_basic = '';
														$is_user_change_status_awating = '';
														$is_user_change_status_cancel = 'disabled';
														$is_user_change_status_cancel_sub = 'disabled';
													}
													else if (strpos($rolevalues, 'editor') !== false)
													{
														$is_user_change_status_basic = '';
														$is_user_change_status_awating = 'disabled';
														$is_user_change_status_cancel = 'disabled';
														$is_user_change_status_cancel_sub = 'disabled';
													}
													else
													{
													     
            											
														$is_user_change_status_basic = 'disabled';
														$is_user_change_status_awating = 'disabled';
														$is_user_change_status_cancel = 'disabled';
														$is_user_change_status_cancel_sub = 'disabled';
													}
												}
											}
											if((count(array_intersect($user_roles, ${$case_type_role_name_array})) > 0) && $_GET['casetype'] == 'ssr_request')
											{
											    $matchingRoles = array_intersect($user_roles, ${$case_type_role_name_array});
												foreach ($matchingRoles as $rolevalues) 
												{	
													if (strpos($rolevalues, 'ho_operations') !== false)
													{
														$is_user_change_status_basic = '';
														$is_user_change_status_awating = '';
														$is_user_change_status_cancel = '';
														$is_user_change_status_cancel_sub = '';
													}
													else if (strpos($rolevalues, 'datechange_manager') !== false)
													{
														$is_user_change_status_basic = '';
														$is_user_change_status_awating = '';
														$is_user_change_status_cancel = '';
														$is_user_change_status_cancel_sub = '';
													}
													else if (strpos($rolevalues, 'administrator') !== false)
													{
														$is_user_change_status_basic = '';
														$is_user_change_status_awating = '';
														$is_user_change_status_cancel = '';
														$is_user_change_status_cancel_sub = '';
													}
													else if (strpos($rolevalues, 'editor_admin') !== false)
													{
														$is_user_change_status_basic = '';
														$is_user_change_status_awating = '';
														$is_user_change_status_cancel = '';
														$is_user_change_status_cancel_sub = '';
													}
													else if (strpos($rolevalues, 'editor') !== false)
													{
														$is_user_change_status_basic = '';
														$is_user_change_status_awating = 'disabled';
														$is_user_change_status_cancel = 'disabled';
														$is_user_change_status_cancel_sub = 'disabled';
													}
													else
													{
														$is_user_change_status_basic = 'disabled';
														$is_user_change_status_awating = 'disabled';
														$is_user_change_status_cancel = 'disabled';
														$is_user_change_status_cancel_sub = 'disabled';
													}
												}
											}
											
											
									?>
									
										<select name='status_selector' id='status_selector' style="width:170px; height:30px; font-size:12px; border-color: #dcd7ca;">
											<?php
											if($casetype != 'datechange_misc')
											{
											?>
												<option value='open' <?php echo $is_user_change_status_cancel; ?> <?php if($status=='open') { echo 'selected'; } ?>>Open</option>
													<option <?php echo $is_user_change_status_basic; ?> value='Processing' <?php if($sub_status=='Processing') { echo 'selected'; } ?>>&nbsp;&nbsp;&nbsp; Processing</option>
													<option <?php echo $is_user_change_status_basic; ?> value='Following up' <?php if($sub_status=='Following up') { echo 'selected'; } ?>>&nbsp;&nbsp;&nbsp; Following up</option>
													<option <?php echo $is_user_change_status_basic; ?> value='Follow-up rejected' <?php if($sub_status=='Follow-up rejected') { echo 'selected'; } ?>>&nbsp;&nbsp;&nbsp; Follow-up rejected</option>
													<option <?php echo $is_user_change_status_basic; ?> value='Follow-up accepted' <?php if($sub_status=='Follow-up accepted') { echo 'selected'; } ?>>&nbsp;&nbsp;&nbsp; Follow-up accepted</option>
													<option <?php echo $is_user_change_status_awating; ?> value='Awaiting HO' <?php if($sub_status=='Awaiting HO') { echo 'selected'; } ?>>&nbsp;&nbsp;&nbsp; Awaiting HO</option>
													<?php
    												if((current_user_can( 'administrator' ) || current_user_can( 'user_portal_refund_editor_admin_2' ) || $currnt_userlogined == 'kajalk' || $currnt_userlogined == 'BinalJ' ) && $casetype == 'refund')
    												{
    												    ?>
    												    <option <?php echo $is_user_change_status_cancel_sub; ?> value='Refund Applied' <?php if($sub_status=='Refund Applied') { echo 'selected'; } ?>>&nbsp;&nbsp;&nbsp; Refund Applied</option>
    												    <option <?php echo $is_user_change_status_cancel_sub; ?> value='Refund FUP with Airline' <?php if($sub_status=='Refund FUP with Airline') { echo 'selected'; } ?>>&nbsp;&nbsp;&nbsp; Refund FUP with Airline</option>
    												    <option <?php echo $is_user_change_status_cancel_sub; ?> value='Refund Received' <?php if($sub_status=='Refund Received') { echo 'selected'; } ?>>&nbsp;&nbsp;&nbsp; Refund Received</option>
    												    <?php
    												}
    												?>
												<option <?php echo $is_user_change_status_cancel; ?> value='fail' <?php if($status=='fail') { echo 'selected'; } ?>>Fail</option>
												<option <?php echo $is_user_change_status_cancel; ?> value='success' <?php if($status=='success') { echo 'selected'; } ?>>Success</option>
												<option <?php echo $is_user_change_status_basic; ?> value='invalid' <?php if($status=='invalid') { echo 'selected'; } ?>>Invalid</option>
												<?php
												}
												
    											if($casetype == 'datechange_misc')
    											{
    												?>
													<option <?php echo $is_user_change_status_cancel; ?> value='open' <?php if($status=='open') { echo 'selected'; } ?>>Open</option>
    												<option <?php echo $is_user_change_status_cancel; ?> value='accept' <?php if($status=='accept') { echo 'selected'; } ?>>Accept</option>
    												<option <?php echo $is_user_change_status_cancel; ?> value='invalid' <?php if($status=='invalid') { echo 'selected'; } ?>>Invalid</option>
    												<?php
												}
    											?>
										</select>
										<?php
											if($is_user_change_status_basic != 'disabled')
											{
												?>
													<button type="submit" name='update_status' class="view_hidden_options2" style='height:30px; width:70px; font-size:12px; padding:7px; margin:0px;'>Update</button>
												<?php								
											}
											?>
										</form>
										</div>
										
										<div style='float:right;'>
                                            <form id="priorityForm" action="#" method="post" enctype="multipart/form-data">
                                                <select name='prioritytype' id='prioritytype' style="width:100px; height:30px; font-size:12px; border-color: #dcd7ca; border-radius:5px;">
                                                    <option value='P1' <?php if($priority == 'P1') { echo 'selected'; } ?>>P1 - Critical</option>
                                                    <option value='P2' <?php if($priority == 'P2') { echo 'selected'; } ?>>P2 - High</option>
                                                    <option value='P3' <?php if($priority == 'P3') { echo 'selected'; } ?>>P3 - Moderate</option>
                                                    <option value='P4' <?php if($priority == 'P4' || $priority == '') { echo 'selected'; } ?>>P4 - Low</option>
                                                </select>
                                                <input type="hidden" name="update_priority" value="1">
                                                <button type="button" onclick="confirmPriorityUpdate()" class="view_hidden_options2" style='height:30px; width:70px; font-size:12px; padding:7px; margin:0px; border-radius:5px;'>Update</button>
                                            </form>
                                        </div>
                                        
                                        <!-- Popup Modal -->
                                        <div id="priorityModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border-radius:5px; box-shadow:0 0 10px rgba(0,0,0,0.5); z-index:1000;">
                                            <h3>Priority Update Confirmation</h3>
                                            <p id="priorityMessage"></p>
                                            <div style="margin-top:20px; text-align:right;">
                                                <button onclick="closePriorityModal()" style="margin-right:10px; padding:5px 10px; border-radius:3px;">Cancel</button>
                                                <button onclick="submitPriorityForm()" style="padding:5px 10px; background:#4CAF50; color:white; border:none; border-radius:3px;">Confirm</button>
                                            </div>
                                        </div>
                                        <div id="priorityOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;"></div>
                                        
                                        <script>
                                        function confirmPriorityUpdate() {
                                            // Get selected value
                                            var selectedPriority = document.getElementById('prioritytype').value;
                                            var priorityText = document.getElementById('prioritytype').options[document.getElementById('prioritytype').selectedIndex].text;
                                            
                                            // Set the message in the popup
                                            document.getElementById('priorityMessage').innerHTML = 
                                                "Are you sure you want to update the case priority to: <strong>" + priorityText + "</strong>?<br><br>" +
                                                "This action will:<br>" +
                                                "- Update the case priority.<br>" +
                                                "- Add a note to the case chat: 'Case priority updated to " + selectedPriority + "'";
                                            
                                            // Show the popup and overlay
                                            document.getElementById('priorityModal').style.display = 'block';
                                            document.getElementById('priorityOverlay').style.display = 'block';
                                        }
                                        
                                        function closePriorityModal() {
                                            document.getElementById('priorityModal').style.display = 'none';
                                            document.getElementById('priorityOverlay').style.display = 'none';
                                        }
                                        
                                        function submitPriorityForm() {
                                            var iframe = document.createElement('iframe');
                                            iframe.style.display = 'none';
                                            iframe.name = 'hiddenFrame';
                                            document.body.appendChild(iframe);
                                            document.getElementById('priorityForm').target = 'hiddenFrame';
                                            
                                            // Submit the form
                                            document.getElementById('priorityForm').submit();
                                            closePriorityModal();
                                            // Refresh the page after a short delay to see changes
                                            setTimeout(function() {
                                                window.location.reload();
                                            }, 500);
                                        }
                                        </script>
                                    
										
 
									<?php
									if($casetype == 'complaint')
									{
									?>
                                        <div style='float:right; margin-right: 20px'>
                                            <form id="actionStepsForm">
                                                <select name='categorytype' id='categorytype' style="width:100px; height:30px; font-size:12px; border-color: #dcd7ca; border-radius:5px;">
                                                    <option value='E-Ticket'>E-Ticket</option>
                                                    <option value='Deposit Refunds'>Deposit Refunds</option>
                                                    <option value='Baggage'>Baggage</option>
                                                    <option value='Name Correction'>Name Correction</option>
                                                    <option value='Special Service Request/SSR'>Special Service Request/SSR</option>
                                                    <option value='Schedule Change'>Schedule Change</option>
                                                    <option value='Date Change & Cancellation Fee'>Date Change & Cancellation Fee</option>
                                                    <option value='Flight Itinerary Issue'>Flight Itinerary Issue</option>
                                                </select>
                                                <button type="button" onclick="showActionSteps()" class="view_hidden_options2" style='height:30px; width:120px; font-size:12px; padding:7px; margin:0px; border-radius:5px;'>Action Steps</button>
                                            </form>
                                        </div>
                                    <?php
									}
									?>									
                                        <!-- Popup Modal -->
                                        <div id="stepsModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border-radius:5px; box-shadow:0 0 10px rgba(0,0,0,0.5); z-index:1000; width:700px; max-width:90%;">
                                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                                                <h3 style="margin:0;"><span id="selectedActionLabel"></span>&nbsp;: &nbsp;Steps to be Taken </h3><br>
                                                <span onclick="closeStepsModal()" style="cursor:pointer; font-size:20px;">&times;</span>
                                            </div>
                                            <div id="stepsContent" style="max-height:400px; overflow-y:auto;">
                                                <!-- Steps content will be inserted here -->
                                            </div>
                                        </div>
                                        <div id="stepsOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;"></div>
                                        
                                        <script>
                                        function showActionSteps() {
                                            const selectElement = document.getElementById('categorytype');
                                            const action = selectElement.value;
                                            const actionLabel = selectElement.options[selectElement.selectedIndex].text;
                                            const content = document.getElementById('stepsContent');
                                        
                                            // Update the modal header with the selected option
                                            document.getElementById('selectedActionLabel').innerText = actionLabel;
                                            
                                        
                                            // Show loading state
                                            content.innerHTML = '<div style="text-align:center; padding:20px;">Loading action steps...</div>';
                                            document.getElementById('stepsModal').style.display = 'block';
                                            document.getElementById('stepsOverlay').style.display = 'block';
                                        
                                            // AJAX request
                                            const xhr = new XMLHttpRequest();
                                            xhr.open('POST', '/wp-admin/admin-ajax.php', true);
                                            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                                            xhr.onload = function() {
                                                if (this.status === 200) {
                                                    content.innerHTML = this.responseText;
                                                } else {
                                                    content.innerHTML = '<div style="color:red;">Error loading action steps. Status: ' + this.status + '</div>';
                                                }
                                            };
                                            xhr.onerror = function() {
                                                content.innerHTML = '<div style="color:red;">Request failed. Please check your connection.</div>';
                                            };
                                            xhr.send('action=get_action_steps&selected_action=' + encodeURIComponent(action));
                                        }
                                        
                                        function closeStepsModal() {
                                            document.getElementById('stepsModal').style.display = 'none';
                                            document.getElementById('stepsOverlay').style.display = 'none';
                                        }
                                        
                                        
                                        </script>
										<?php
											if(isset($_POST['update_status']))
											{
												if (!(is_array(${$case_type_role_name_array}) && in_array($currnt_userlogined, ${$case_type_role_name_generic_array}))) 
												{
													$common_user_team_member_finder = $_POST['teammembers_status'];
													$chat_id = $_GET['id'];
													$casetype = $_GET['casetype'];
													$status_selector = ($_POST['status_selector'] ?? false)? $_POST['status_selector'] : '' ;
													
													if($status_selector == 'open' || $status_selector == 'Processing' || $status_selector == 'Following up' || $status_selector == 'Follow-up rejected' || $status_selector == 'Follow-up accepted' || $status_selector == 'Awaiting HO' || $status_selector == 'Refund Applied' || $status_selector == 'Refund FUP with Airline' || $status_selector == 'Refund Received')
													{
														$main_status = 'open';
														$sub_status = $status_selector;
														if($status_selector == 'open')
														{
															$remark_message = 'reopenthis';
															$responsetypenote = 'chat';
														}
														else
														{
															$remark_message = 'Status changed as ' . $status_selector;
															$responsetypenote = 'status';
														}
													}
													else if($status_selector == 'fail')
													{
														$main_status = 'fail';
														$sub_status = '';
														$remark_message = 'closethis';
														$responsetypenote = 'chat';
													}
													else if($status_selector == 'invalid')
													{
														$main_status = 'invalid';
														$sub_status = '';
														$remark_message = 'closethis';
														$responsetypenote = 'chat';
													}
													else if($status_selector == 'success')
													{
														$main_status = 'success';
														$sub_status = '';
														$remark_message = 'closethis';
														$responsetypenote = 'chat';
													}
													else if($status_selector == 'accept')
													{
														$main_status = 'accept';
														$sub_status = '';
														$remark_message = 'closethis';
														$responsetypenote = 'chat';
													}
													else
													{
														$main_status = '';
														$sub_status = '';
														$remark_message = '';
														$responsetypenote = 'status';
													}
													
													if($status_selector != '')
													{
    													$sql_update = "UPDATE wpk4_backend_user_portal_requests SET status='$main_status',sub_status='$sub_status' WHERE case_id ='$chat_id'";
    													$result= mysqli_query($mysqli,$sql_update);
    																									
    													mysqli_query($mysqli,"insert into wpk4_backend_user_portal_request_chats (request_id,response,response_time,response_by,member_name,status,request_type,chat_or_note) values ('$chat_id','$remark_message','$current_date_time','$currnt_userlogined','$common_user_team_member_finder','open','$casetype','$responsetypenote')") or die(mysqli_error($mysqli));
    															
    													echo '<script>window.location.href="'.$current_url.'";</script>';
													}
												}
											}
											
											if(isset($_POST['update_priority']))
											{
												$autoid_priority = $_GET['id'];
												$casetype = $_GET['casetype'];
												$prioritytype = $_POST['prioritytype'];
												$sql_update = "UPDATE wpk4_backend_user_portal_requests SET priority='$prioritytype' WHERE case_id='$autoid_priority'";
												$result= mysqli_query($mysqli,$sql_update);
												
												$responsetypenote = 'status';
												$replymessage = 'Case priority updated to '.$prioritytype;
												
												mysqli_query($mysqli,"insert into wpk4_backend_user_portal_request_chats (request_id,response,response_time,response_by,status,request_type,chat_or_note) values ('$autoid_priority','$replymessage','$current_date_time','$currnt_userlogined','open','$casetype','$responsetypenote')") or die(mysqli_error($mysqli));
														
												echo '<script>window.location.href="'.$current_url.'";</script>';
											}

									$query = "SELECT * FROM wpk4_backend_user_portal_request_meta where case_id = '$case_id' AND meta_key = 'attachment' AND (meta_value != '' OR meta_value IS NOT NULL)";
									$result = mysqli_query($mysqli, $query);
									$row = mysqli_fetch_assoc($result);
									if( mysqli_num_rows($result) > 0 && $row['meta_value'] != '' )
									{
									    echo '</br></br></br><h6 style="margin:0;">Attachment</h6>';
									    echo '<a target="_blank" href="/wp-content/uploads/customized_function_uploads/'.$row['meta_value'].'">
									        <img src="/wp-content/uploads/customized_function_uploads/'.$row['meta_value'].'" style="height:130px;">
									    </a>';
									}
										?>
										</br></br>
										<div id='reloadornot'></div>
										<div id='chatboxwindow'></div>


										</div>
										<?php
									
										if (count(array_intersect($user_roles, ${$case_type_role_name_array})) ==  0)
									    {
        							       ?> 
        							        <style>
        							            .view_hidden_options2
        							            {
        							                display:none !important;
        							            }
        							        </style>
        							        <?php
        							    }
        							    ?>
										<div class='view_hidden_options2 messagebox'>
										Reply as Gaura Travels..</br>
										<div class="chat-footer" >
										<form action="#" method="post" id="replyform" enctype="multipart/form-data">
									<?php
									if (is_array(${$case_type_role_name_array}) && in_array($currnt_userlogined, ${$case_type_role_name_generic_array})) 
										{
										?>
										<input type="radio" id="chat"  disabled name="responsetypenote" value="chat"> <label for="chat">Chat</label> &nbsp;&nbsp;
											<input type="radio" id="note" checked name="responsetypenote" value="note"> <label for="note">Remark</label>
												<select name="responsetypenote_addittional" id="responsetypenote_addittional" style="width:200px; height:30px; font-size:12px; border-color: #dcd7ca;">
													<option value="" selected disabled>Select type</option>
													<option value="remark">Internal Remark</option>
													<option value="followup">Follow-up Remark</option>
												</select>
												
										&nbsp;&nbsp;&nbsp;User: <select onclick="parse_teammember_userstatus(this.value)" name="teammembers" required id="teammembers">
											<?php
											$query_agents = "SELECT * FROM wpk4_backend_user_portal_generic_users where generic_id = '$currnt_userlogined' ORDER BY user_name ASC"; // get agent names under loged generic login
											$result_agents = mysqli_query($mysqli, $query_agents);
											while($row_agents = mysqli_fetch_assoc($result_agents))
											{
												?>
												<option value="<?php echo $row_agents['user_name']; ?>"><?php echo $row_agents['name']; ?></option>
												<?php
											}
											?>
										</select>&nbsp;&nbsp;
										<?php
									}
									else
									{
										?>
										<input type="radio" id="chat" checked name="responsetypenote" value="chat"> <label for="chat">Chat</label> &nbsp;&nbsp;
											<input type="radio" id="note" name="responsetypenote" value="note"> <label for="note">Remark</label>
												<select name="responsetypenote_addittional" id="responsetypenote_addittional" style="width:200px; height:30px; font-size:12px; border-color: #dcd7ca;">
													<option value="remark">Internal Remark</option>
													<option value="followup">Follow-up Remark</option>
												</select>
										<input type="hidden" name="teammembers" id="teammembers" value="<?php echo $currnt_userlogined; ?>">&nbsp;&nbsp;
										<?php
									}
								if (count(array_intersect($user_roles, ${$case_type_role_name_array})) > 0)
									{	
									$matchingRoles = array_intersect($user_roles, ${$case_type_role_name_array});
									//print_r( $matchingRoles);
									foreach ($matchingRoles as $rolevalues) 
									{	
										if (strpos($rolevalues, 'editor') !== false || strpos($rolevalues, 'ho_operations') !== false || strpos($rolevalues, 'datechange_manager') !== false || strpos($rolevalues, 'administrator') !== false || strpos($rolevalues, 'editor_admin') !== false)
										{	
											?>
											<div id='message_sending_status' style='float:right; width:200px;'></div>	
											<textarea rows='10' name='replymessage' id='replymessage' class="send-message-text"></textarea>
											</br>
											
											<button type="submit" name='make_reply' id='make_reply' class="send-message-button btn-info"> <i class="fa fa-send"></i> </button>
											</br>
											<button type="submit" onclick="uploadFile();" name='attachfile_id' id='attachfile_id' class="send-message-button2 btn-success" > <i class="fa fa-paperclip"></i> </button>
											<input type="file" accept=".jpg,.jpeg,.png,.pdf" class='myattachmentchat' name="myattachmentchat" id="myattachmentchat">
											<?php
											break;
										}
										else
										{
											?>
											<div id='message_sending_status' style='float:right; width:200px;'></div>	
											<textarea rows='10' disabled class="send-message-text"></textarea>
											</br>
											
											<button type="submit" disabled class="send-message-button btn-info"> <i class="fa fa-send"></i> </button>
											</br>
											<button type="submit" disabled class="send-message-button2 btn-success" > <i class="fa fa-paperclip"></i> </button>
											<input type="file" accept=".jpg,.jpeg,.png,.pdf" class='myattachmentchat' name="myattachmentchat" disabled id="myattachmentchat">
											<?php
											break;
										}
										
									}
									}
									?>
										</form>
										</div>
										
										<div style="padding:10px 20px;margin:auto;">
										<center>
										
										<h6>Predefined Messages</h6>
										<?php
										$msg_category = $_GET['casetype'];
										$query_predefined_msg = "SELECT * FROM wpk4_backend_user_portal_predefined_messages where category = '$msg_category'";
										$result_predefined_msg = mysqli_query($mysqli, $query_predefined_msg);
										while($row_predefined_msg = mysqli_fetch_assoc($result_predefined_msg))
										{
										?>
											<button onclick="parse_predefined_msg(this.value)" style="font-weight:400;cursor: pointer;" class="badge badge-primary <?php echo $row_predefined_msg['auto_id']; ?>" value="<?php echo $row_predefined_msg['message']; ?>"><?php echo $row_predefined_msg['message']; ?></button>
										<?php
										}
										?>
										</center>
										</div>
										</div>
										<div id='status_text'></div>
										</div>
										</div>

							
							<style>
								#myattachmentchat 
								{ 
								visibility: hidden; 
								}
								</style>
								<script>
									$('#attachfile_id').click(function(){
										$('#myattachmentchat').click();
									});

							$(document).ready(function(){
							 $(document).on('change', '#myattachmentchat', function(){
							  var name = document.getElementById("myattachmentchat").files[0].name;
							  
							  var form_data = new FormData();
							  var ext = name.split('.').pop().toLowerCase();
							  if(jQuery.inArray(ext, ['png','jpg','jpeg','pdf']) == -1) 
							  {
							   alert("Invalid Image File");
							  }
								  var oFReader = new FileReader();
								  oFReader.readAsDataURL(document.getElementById("myattachmentchat").files[0]);
								  var f = document.getElementById("myattachmentchat").files[0];
								  var fsize = f.size||f.fileSize;
								  if(fsize > 2000000)
								  {
								   alert("Image File Size is very big");
								  }
								  else
								  {
									
									var urlParams = new URLSearchParams(window.location.search);
									var request_id = urlParams.get('id');
									var responsetypenote = $("input[name='responsetypenote']:checked").val();
									var responsetypenote_additional = $("#responsetypenote_addittional").val();
									var teammembers = $("#teammembers").val();
									var reply_type_for = urlParams.get('casetype');
									var response_by = <?php echo json_encode($currnt_userlogined) ?>;
									var make_reply = $("#make_reply").val();
									
									form_data.append( "image_submit" , "yes" );
									form_data.append( "request_id" , request_id );
									form_data.append( "responsetypenote" , responsetypenote );
									form_data.append( "responsetypenote_additional" , responsetypenote_additional );
									form_data.append( "teammembers" , teammembers );
									form_data.append( "reply_type_for" , reply_type_for );
									form_data.append( "response_by" , response_by );
									form_data.append( "usertype_u" , "admin" );
								
								form_data.append("myattachmentchat", document.getElementById('myattachmentchat').files[0]);
								var responsemsg_received = '';
								   $.ajax({
									url:"/wp-content/themes/twentytwenty/templates/tpl_user_portal_backend.php",
									method:"POST",
									dataType: "json",
									data: form_data,
									contentType: false,
									cache: false,
									processData: false,
									beforeSend: function () {
										$('#message_sending_status').show();
									},
									success: function (response) {
										responsemsg_received = responsemsg_received+response;
										$('#message_sending_status').html("Message sent successfully").delay(3000).hide(0); 
									},
									error: function (xhr, status, error) {
										msg = xhr.responseText;
										$('#message_sending_status').html(msg).delay(3000).hide(0);
									} 
								   });
								   document.getElementById('myattachmentchat').value = "";
								   $('#message_sending_status').html(msg).delay(3000).hide(0);
								  }
								 });
							});

								
						function parse_predefined_msg(val)
						{
							var tempval = document.getElementById('replymessage').value;
							document.getElementById('replymessage').value = tempval + ' ' + val;
						}
						
						
					window.setInterval( function isnewupdate() {
					var urlParams = new URLSearchParams(window.location.search);
					var str = urlParams.get('id');
					var chattype = urlParams.get('casetype');
					var last_updated_value = $("#last_updated_id").val();
					  if (str == "") {
						return;
					  } else {
						var xmlhttp = new XMLHttpRequest();
						xmlhttp.onreadystatechange = function() {
						  if (this.readyState == 4 && this.status == 200) {
							var reloadchecker = $("#reloadchecker").val();
							document.getElementById("reloadornot").innerHTML = this.responseText;
							if(reloadchecker=='reload') // have new update_priority
							{
								showChats();
							}
						  }
						};
						xmlhttp.open("GET","<?php echo $themepath; ?>/templates/tpl_user_portal_backend.php/?checknewupdate="+str+"&reply_type_for="+chattype+"&lastvalue="+last_updated_value,true);
						xmlhttp.send();
					  }
					}, 5000);

					$(document).ready(function() {
						showChats();
					});

					function showChats() {
					var urlParams = new URLSearchParams(window.location.search);
					var str = urlParams.get('id');
					var chattype = urlParams.get('casetype');
					  if (str == "") {
						return;
					  } else {
						var xmlhttp = new XMLHttpRequest();
						xmlhttp.onreadystatechange = function() {
						  if (this.readyState == 4 && this.status == 200) {
							document.getElementById("chatboxwindow").innerHTML = this.responseText;
						  }
						};
						xmlhttp.open("GET","<?php echo $themepath; ?>/templates/tpl_user_portal_backend.php/?view_responses="+str+"&reply_type_for="+chattype+"&usertype_u=admin",true);
						xmlhttp.send();
					  }
					}
					</script>
					<script type="text/javascript">
					$( "#replyform" ).submit(function( event ) {
					  event.preventDefault();
					});

					$("#make_reply").click(function(){
					 //get the form values
					 var myattachmentchat = $("#myattachmentchat").val();
					 var replymessage = $("#replymessage").val();
					 if(myattachmentchat == '' && replymessage != '' && replymessage != ' ')
					 {

							var form_data = new FormData();
							
							var urlParams = new URLSearchParams(window.location.search);
							var request_id = urlParams.get('id');
							var responsetypenote = $("input[name='responsetypenote']:checked").val();
							var responsetypenote_additional = $("#responsetypenote_addittional").val();
							var replymessage = $("#replymessage").val();
							var replymessage_2 = replymessage.replace(/[<>*()?'"]/g, function(match) { return '\\' + match;
							});
						
							var teammembers = $("#teammembers").val();
							var reply_type_for = urlParams.get('casetype');
							var response_by = <?php echo json_encode($currnt_userlogined) ?>;
							var make_reply = $("#make_reply").val();
								
							form_data.append( "usertype_u" , "admin" );
							form_data.append( "request_id" , request_id );
							form_data.append( "responsetypenote" , responsetypenote );
							form_data.append( "responsetypenote_additional" , responsetypenote_additional );
							form_data.append( "replymessage" , replymessage_2 );
							form_data.append( "make_reply" , make_reply );
							form_data.append( "response_by" , response_by );
							form_data.append( "member_name" , teammembers );
							form_data.append( "reply_type_for" , reply_type_for );
							var responsemsg_received = '';
							 
							 $.ajax({
								url : "<?php echo $themepath; ?>/templates/tpl_user_portal_backend.php",
								type: "POST",
								data : form_data,
								dataType: "json",
								contentType: false,
								cache: false,
								processData: false,
								beforeSend: function () {
									$('#message_sending_status').show();
								},
								success: function (response) {
									responsemsg_received = responsemsg_received+response;
									$('#message_sending_status').html("Message sent successfully").delay(3000).hide(0);
								},
								error: function (xhr, status, error) {
									msg = xhr.responseText;
									$('#message_sending_status').html(msg).delay(3000).hide(0);
								}  
							});
					 }
						clearchatbox();
					});
					function clearchatbox()
						{
							$("#status_text").html('');
							$('#replymessage').val('');
							document.getElementById("status_text").value = '';
							document.getElementById("replymessage").value = '';
						}
					</script>
					<?php
					}
					?>
					</br>
					<script>
					$('#bankinfo').on('shown.bs.modal', function () {
					  $('#bankinfo').trigger('focus')
					})
					</script>
				<?php	
				}
			
			if(isset($_GET['p']) && $_GET['p'] =='customer-bookings') //customer - my bookings
				{
				    echo '</br><h3>My Bookings</h3></br>';
				    ?>
				    <style>
				        .vc_col-sm-10
				        {
				            width:93%;
				        }
				        .vc_col-sm-2
				        {
				            width:7%;
				            float:right;
				            text-align:right;
				        }
						.view-btn
						{
							background-color: #ffbb00 !important;
							border: none;
							color: black;
							padding: 7px 25px;
							border-radius: 7px;
							text-align: center;
							text-decoration: none;
							display: inline-block;
							font-size: 16px;
							font-weight: 500;
						}
				    </style>
				    <script type="text/javascript">
				function searchordejs() {
				  
				    var pnr_or_id = document.getElementById("searchkeyvalue").value;
				    var type = document.getElementById("typeselecter").value;
					window.location='?p=customer-bookings&type=' + type + '&id=' + pnr_or_id ;
					
				}
				</script>
				<h5>View Booking</h5>
        
				<table class="table" style="width:100%; margin:auto; border:1px solid #adadad;">
				<tr>
				<td width='10%'>
                	Search by
                </td>
				<td width='20%'>
                	<select style="width:100%; padding:10px;" name="typeselecter" id="typeselecter">
                	    <option <?php if(isset($_GET['type']) && $_GET['type'] == 'reference') { echo 'selected'; } ?> value='reference'>PNR/Order ID</option>
                	    <option <?php if(isset($_GET['type']) && $_GET['type'] == 'mobile') { echo 'selected'; } ?> value='mobile'>Mobile</option>
                	    <option <?php if(isset($_GET['type']) && $_GET['type'] == 'email') { echo 'selected'; } ?> value='email'>Email</option>
                	</select>
                </td>
                <td width='15%'>
				<input type='text' name='searchkeyvalue' value='<?php if(isset($_GET['id'])) { echo $_GET['id']; } ?>' id='searchkeyvalue'>
				</td>
				<td>
				<button id='search_orders' style='padding:10px 14px; margin:3px 0px;font-size:13px;background-color:#f5e878; text-decoration:none;curser:pointer;background-color:#c7950b; color:white; ' onclick="searchordejs()">Search</button>
				</td>
				</tr>
				</table>
				    <?php
				    
					
					if(isset($_GET['id']) && $_GET['id'] != '')
					{
					    if ((isset($_GET['id']) && ctype_digit($_GET['id'])) && $_GET['type'] == 'reference') 
        				{
        					$ref_type = 'orderid';
            			} 
            			else if($_GET['type'] == 'mobile')
            			{
            			    $ref_type = 'mobile';
            			}
            			else if($_GET['type'] == 'email')
            			{
            			    $ref_type = 'email';
            			}
            			else
            			{
            				$ref_type = 'pnr';
            			}
            			
        				$filter_type = '';
                        if(isset($_GET['type']))
                        {
                            $filter_type = $_GET['type'];
                        }
        
        				
        				$filetr_id = '';
                        if(isset($_GET['id'])){
                            $filetr_id = $_GET['id'];
                        }
                    
        				if($ref_type == 'pnr')
        				{
            				$filter_sql = "pax.pnr = '".$_GET['id']."'";
        				}
        				else if($ref_type == 'orderid')
        				{
        				    $filter_sql = "pax.order_id='".$_GET['id']."'";
        				}
        				else if($ref_type == 'email')
        				{
            				$filter_sql = "pax.email_pax='".$_GET['id']."'";
        				}
        				else if($ref_type == 'mobile')
        				{
							$phone_nums = substr($_GET['id'], -8);
							$filter_sql = "pax.phone_pax_cropped = '".$phone_nums."'";
							
            				//$filter_sql = "pax.phone_pax='".$_GET['id']."'";
        				}
        				else
            			{
            				$filter_sql = "booking.auto_id='GTDummy'";
            			}
    					$processedOrders_search = [];
    					$query_bookings = "SELECT booking.order_type, booking.order_id, pax.pnr, date(booking.order_date) as orderdate, booking.trip_code, date(booking.travel_date) as traveldate 
        					FROM wpk4_backend_travel_bookings booking 
        					JOIN wpk4_backend_travel_booking_pax pax ON  
        					booking.order_id = pax.order_id AND 
        					booking.co_order_id = pax.co_order_id AND 
        					booking.product_id = pax.product_id  
        					where $filter_sql order by booking.order_date desc, booking.travel_date desc";
        				$result_bookings = mysqli_query($mysqli, $query_bookings);
        				if(mysqli_num_rows($result_bookings) > 0)
        				{
        					
        					while($row_bookings = mysqli_fetch_assoc($result_bookings))
        					{
        					    $order_type = $row_bookings['order_type'];
            					$order_id = $row_bookings['order_id'];
            					$enc_order_id = md5($order_id);
            					$trip_code = $row_bookings['trip_code'];
            					$pnr = $row_bookings['pnr'];
            					$order_date = $row_bookings['orderdate'];
            					
            					$tripKey = $order_id.''.$trip_code;
            					if (in_array($tripKey, $processedOrders_search)) {
        							continue; // Skip to the next iteration if the order ID is already processed
        						}
        						$processedOrders_search[] = $tripKey;
            					?>	
            					<div class="wrapper " style="background-color:#fafbfc; padding:10px 15px 10px 15px; margin:10px 0px 10px 0px; text-align:left; display:flex; ">
            					    <div class="vc_col-sm-10">
            					        <p style="font-size:17px; font-weight:700;">
                        					<?php 
                        					echo $order_id;
                        					?>
                					    </p>
                					    <p style="font-size:13px; font-weight:700;">
                        					<?php 
                        					echo $row_bookings['trip_code'].' | ';
                        					echo date('d/m/Y', strtotime($row_bookings['traveldate']));
                        					?>
                					    </p>
                					</div>
                					<div class="vc_col-sm-2">
                					    <a href="?p=view-customer-booking&orderID=<?php echo $order_id; ?>&key=<?php echo $enc_order_id; ?>" class="view-btn">View</a>
                					</div>
                					
            					</div>
        					    <?php
        					}
        				}
        				else
        				{
        				    echo 'No booking found.';
        				}
				    }
				}
				
				if(isset($_GET['p']) && $_GET['p'] =='view-customer-booking' && isset($_GET['orderID']) && $_GET['orderID'] != '') //customer - individual booking view
				{
					echo '</br></br></br>';
				    //echo '</br><h4>My Booking '.$_GET["orderID"].'</h4></br>';
    				if($_GET['orderID'] != '') // is any values searched
    				{
				    
    				$filter_sql = "wpk4_backend_travel_booking_pax.order_id='".$_GET['orderID']."'";
    				
    				if($_GET['orderID'] != '')
    				{
    					$query = "SELECT * FROM wpk4_backend_travel_bookings JOIN wpk4_backend_travel_booking_pax ON  wpk4_backend_travel_bookings.order_id = wpk4_backend_travel_booking_pax.order_id AND 
    					wpk4_backend_travel_bookings.co_order_id = wpk4_backend_travel_booking_pax.co_order_id AND wpk4_backend_travel_bookings.product_id = wpk4_backend_travel_booking_pax.product_id 
    					where $filter_sql order by wpk4_backend_travel_booking_pax.order_id desc LIMIT 20";
    				}
    				else
    				{
    					$query = "SELECT * FROM wpk4_backend_travel_bookings where wpk4_backend_travel_bookings.order_id='DUMMYgt00000' order by wpk4_backend_travel_bookings.order_id desc LIMIT 20";
    				}
				
    				$selection_query = $query;
    				
    				$result = mysqli_query($mysqli, $query) or die(mysqli_error($mysqli));
    				$row_count = mysqli_num_rows($result);
                    if($row_count > 0)
            		{
            		    $processedOrders_search = [];
            		    while($row = mysqli_fetch_assoc($result))
            		    {
                		    $order_id = $row['order_id'];
                		    $order_id_api = $row['order_id'];
                		    $co_order_id_api = $row['co_order_id'];
                		    $product_id_api = $row['product_id'];
                		    $new_product_id_api = $row['new_product_id'];
                		    
                		    $trip_code_for_order = $row['trip_code'];
                		    
                            if (in_array($order_id, $processedOrders_search)) {
								continue; // Skip to the next iteration if the order ID is already processed
							}
							$processedOrders_search[] = $order_id;
							
                    		$pax_remarks=$row['remarks'];
                    		$booking_date_dmy = date('d/m/Y H:i:s', strtotime($row['order_date'])); 
                            $travel_date_domestic = date('Y-m-d', strtotime($row['travel_date'])); 
                    		$trip_code_domestic = $row['trip_code'];
                    		
                    		$phone_pax = '';
                    		$query_pax_contact_selection_phone = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id' AND phone_pax != ''";
        					$result_pax_contact_selection_phone = mysqli_query($mysqli, $query_pax_contact_selection_phone);
        					$row_pax_contact_selection_phone = mysqli_fetch_assoc($result_pax_contact_selection_phone);
        					if(mysqli_num_rows($result_pax_contact_selection_phone) > 0)
        					{
                        		$phone_pax = $row_pax_contact_selection_phone['phone_pax'];
                        		if($phone_pax == '')
                        		{
                                    $query_pax_contact_from_meta = "SELECT * FROM wpk4_backend_history_of_updates where type_id='$order_id' AND meta_key = 'Billing PrivatePhone'";
                					$result_pax_contact_from_meta = mysqli_query($mysqli, $query_pax_contact_from_meta);
                					$row_pax_contact_from_meta = mysqli_fetch_assoc($result_pax_contact_from_meta);
                					if(mysqli_num_rows($result_pax_contact_from_meta) > 0)
        					        {
                					    $phone_pax = $row_pax_contact_from_meta['meta_value'];
        					        }
                        		}
        					}
                    		
                    		$email_pax = '';
                    		$query_pax_contact_selection_email = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id' AND email_pax != ''";
        					$result_pax_contact_selection_email = mysqli_query($mysqli, $query_pax_contact_selection_email);
        					$row_pax_contact_selection_email = mysqli_fetch_assoc($result_pax_contact_selection_email);
        					if(mysqli_num_rows($result_pax_contact_selection_email) > 0)
        					{
                        		$email_pax = $row_pax_contact_selection_email['email_pax'];
                        		if($email_pax == '')
                        		{
                                    $query_pax_contact_from_meta = "SELECT * FROM wpk4_backend_history_of_updates where type_id='$order_id' AND meta_key = 'Billing Email'";
                					$result_pax_contact_from_meta = mysqli_query($mysqli, $query_pax_contact_from_meta);
                					$row_pax_contact_from_meta = mysqli_fetch_assoc($result_pax_contact_from_meta);
                					if(mysqli_num_rows($result_pax_contact_from_meta) > 0)
            					    {
                				        $email_pax = $row_pax_contact_from_meta['meta_value'];
            					    }
                        		}
        					}
                    		
                    		$total_pax = $row['total_pax'];
                    		$order_type = $row['order_type'];
                    		$order_type_itinerary = $row['order_type'];
                    		
                    		$query_payment_status = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id'";
        					$result_payment_status = mysqli_query($mysqli, $query_payment_status);
        					$row_payment_status = mysqli_fetch_assoc($result_payment_status);
        					
            				$payment_status = $row_payment_status['payment_status'];
    				        if($row_payment_status['payment_status'] == 'pending')
    						{
    							$txt_payment_status = 'Pending';
    						}
    						else if($row_payment_status['payment_status'] == 'partially_paid')
    						{
    							$txt_payment_status = 'Partially Paid';
    						}
    						else if($row_payment_status['payment_status'] == 'paid' || $row_payment_status['payment_status'] == 'Paid')
    						{
    							$txt_payment_status = 'Paid';
    						}
    						else if($row_payment_status['payment_status'] == 'canceled')
    						{
    							$txt_payment_status = 'Xxln With Deposit';
    						}
    						else if($row_payment_status['payment_status'] == 'N/A')
    						{
    							$txt_payment_status = 'Failed';
    						}
    						else if($row_payment_status['payment_status'] == 'refund')
    						{
    							$txt_payment_status = 'Refund Done';
    						}
    						else if($row_payment_status['payment_status'] == 'waiting_voucher')
    						{
    							$txt_payment_status = 'Refund Under Process';
    						}
    						else if($row_payment_status['payment_status'] == 'receipt_received')
    						{
    							$txt_payment_status = 'Receipt Received';
    						}
    						else if($row_payment_status['payment_status'] == 'voucher_submited')
    						{
    							$txt_payment_status = 'Rebooked';
    						}
    						else
    						{
    							$txt_payment_status = 'Pending';
    						}
            				$order_date = $row['order_date'];
            				
            				$query_selection_meta = "SELECT * FROM wpk4_backend_history_of_meta_changes WHERE type_id ='$order_id_api' order by auto_id desc";
                            $result_selection_meta = mysqli_query($mysqli, $query_selection_meta);
                            $row_selection_meta_existingcount = mysqli_num_rows($result_selection_meta);
                            if($row_selection_meta_existingcount > 0)
                            {
                                $row_selection_meta = mysqli_fetch_assoc($result_selection_meta);
                                $gds_data_updated_on = date('d/m/Y H:i:s', strtotime($row_selection_meta['updated_on']));
                                $is_gds_updated_got_updated = '<p class="blink_me">Updated on: '.$gds_data_updated_on.'</br></p>';
                            }
                            else
                            {
                                $is_gds_updated_got_updated = '';
                            }
                            
                            $billing_email = '';
                            $query_order_billing_email = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api'";
                            $result_order_billing_email = mysqli_query($mysqli, $query_order_billing_email) or die(mysqli_error($mysqli));
                            if(mysqli_num_rows($result_order_billing_email) > 0)
                            {
                                $row_order_billing_email = mysqli_fetch_assoc($result_order_billing_email);
                                $billing_email = $row_order_billing_email['billing_email']; 
                            }
                        
            				?>
            				<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                            <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
                            <script>
            				    function openCity(evt, cityName) {
                        		  var i, tabcontent, tablinks;
                        		  tabcontent = document.getElementsByClassName("tabcontent");
                        		  for (i = 0; i < tabcontent.length; i++) {
                        			tabcontent[i].style.display = "none";
                        		  }
                        		  tablinks = document.getElementsByClassName("tablinks");
                        		  for (i = 0; i < tablinks.length; i++) {
                        			tablinks[i].className = tablinks[i].className.replace(" active", "");
                        		  }
                        		  document.getElementById(cityName).style.display = "block";
                        		  evt.currentTarget.className += " active";
                        		  
                        		 
                        		}
            				</script>
            				</br>
            				<div style="margin: auto; font-size:16px;">
                				<div style="float: left; width:49%;">
                    			    Booking Ref: <?php echo $row['order_id']; ?> <?php if($row['co_order_id'] != '') { echo ' '.$row['co_order_id']; } ?></br>
                    				Agent: <?php echo $row['agent_info']; ?></br>
                    				Booked on: <?php echo $booking_date_dmy; ?></br>
                    				
                    				Travel Type: <?php 
                    				if($row['order_type'] == 'WPT')
                    				{
                    				    if($row_count > 1)
                    				    {
                    				        echo 'return';
                    				    }
                    				    else
                    				    {
                    				        echo 'oneway';
                    				    }
                    				}
                    				else
                    				{
                    				    echo $row['t_type']; 
                    				}
                    				?></br>
                				</div>
                				<div style="float: right; width:49%;">
                				    <?php if( $billing_email != '' && $billing_email != $email_pax ) { echo 'Billing Email: '.$billing_email.'</br>'; } ?>
                    				Email: <?php echo $email_pax; ?></br>
                    				Phone Number: <?php echo $phone_pax; ?></br>
                    				Pax: <?php echo $total_pax; ?></br>
                    				Payment Status: <?php echo $txt_payment_status; ?>
                    				</br>
                    			</div>
            				</div>
            				</br></br></br></br></br>
            				<style>
            				.blink_me {
                                animation: blinker 2s linear infinite;
                                margin:0;
                                padding:0;
                            }
                                
                            @keyframes blinker {
                                50% {
                                    opacity: 0;
                                }
                            }
            				.search_bookings button, input[type=submit]
            				{
            				    background-color:#ffbb00;
            				    color:black;
            				}
            				.tabnavigation
            				{
            				    float:left;
            				    left:0;
            				}
                			.chatcategory
                			{
                    			padding:7px 10px; 
                    			margin:0;
                    			font-size:13px;
                			}
                			.tab .active
                			{
                			    color:#FFF !important;
                			    background-color:#000 !important
                			}
                			.ssr_request_radio_button {
                			    margin-top: 10px; display: block;
                                flex-wrap: wrap;
                            }
                            .ssr_request_radio_button label.radio {
                             display:inline;
                             position:relative;
                             margin-left: 0.2em;
                             _top:0.2em;
                             }
                             
                             .radio-group {
                                    display: flex;
                                    align-items: center;
                                }
                                
                                .radio-group label {
                                    margin-right: 10px;
                                    margin-top:13px;
                                }
                                .badge.badge-primary {
                                    background-color: #149efa;
                                }
                                
                                .badge {
                                    display: inline-block;
                                    min-width: 10px;
                                    padding: 3px 7px;
                                    font-size: 12px;
                                    font-weight: 700;
                                    line-height: 1;
                                    color: #fff;
                                    text-align: center;
                                    white-space: nowrap;
                                    vertical-align: middle;
                                    background-color: #777;
                                    border-radius: 10px;
                                }


                			</style>
                			<div class="tabnavigation search_bookings">
                				<div class="tab">

                    				<button class="tablinks chatcategory active" onclick="openCity(event, 'summary_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">Summary</button>
                    				
                    				<button class="tablinks chatcategory" onclick="openCity(event, 'itinerary_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">Itinerary</button>
                    				<button class="tablinks chatcategory" onclick="openCity(event, 'names_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">Pax Names</button>
                    				<button class="tablinks chatcategory" onclick="openCity(event, 'payments_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">Payments</button>
                    				
                    				<button class="tablinks chatcategory" onclick="openCity(event, 'emails_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">Emails</button>
                    				
                    				<button class="tablinks chatcategory" onclick="openCity(event, 'portal_request_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">View Portal Requests</button>
                    				
									
									<?php
											$query_dc_count = "SELECT case_id FROM wpk4_backend_user_portal_requests where case_type = 'datechange' AND reservation_ref = '$order_id_api' ";
											
											$result_dc_count = mysqli_query($mysqli, $query_dc_count);
											if(mysqli_num_rows($result_dc_count) > 0)
											{
											?>
                            				<button class="tablinks chatcategory" onclick="openCity(event, 'dc_submission_edit_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">Date Change Request</button>
											<?php
											}
											else
											{
											?>
											<button class="tablinks chatcategory" onclick="openCity(event, 'dc_submission_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">Date Change Request</button>
											<?php
											}
											?>
											
											
                    				<button class="tablinks chatcategory" onclick="openCity(event, 'refund_request_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">Refund Request</button>
                    				<button class="tablinks chatcategory" onclick="openCity(event, 'complaintform_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">Make Complaint</button>
                    			    <?php
                            				$query_is_ticket_submitted = "SELECT * FROM wpk4_backend_travel_booking_eticket_file_log where order_id = '$order_id_api' ";
        					                $result_is_ticket_submitted = mysqli_query($mysqli, $query_is_ticket_submitted);
                                            if(mysqli_num_rows($result_is_ticket_submitted) > 0)
                                            {
                                				//if($order_id_api == '206514')
                                				{
                                				    ?>
                                				    <button class="tablinks chatcategory" onclick="openCity(event, 'eticketdownload_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">Eticket</button>
                                				    <?php
                                				}
                                            }
                    			    
                    			    $booking_date_ymd = date('Y-m-d', strtotime($row['order_date'])); 
							                $md5_key_of_order_date = md5($booking_date_ymd);
                                            $order_key = md5($order_id_api);                    
                            				?>
                            				<a href="/invoice/?order_id=<?php echo $order_id_api; ?>&key=<?php echo $order_key; ?>&pass=<?php echo $md5_key_of_order_date; ?>" target="_blank"><button class="tablinks chatcategory" >Invoice</button></a>
                    			    
                    			
                    			</div>
                			</div>
            				</br></br>
            				<div id="tabcontent_main" style="font-size:14px;">
            				    
            				    <div id="summary_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>" class="tabcontent" >
                                    
                    				</br></br>
                    				<table class="table table-striped" style="width:100%; margin:auto;font-size:14px; margin-top:35px;">
                    					<thead>
                        					<tr>	
                            					<th>Order ID</th>
                            					<th style="text-align:center;">PNR</th>
                            					<th style="text-align:center;">Flight Details</th>
                            					<th style="text-align:center;">Travel Date</th>
                        				    </tr>
                    				    </thead>
            				            <tbody>
                        				<?php
                        				$order_id = $order_id_api;
                        				$query_summary_loop = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api' && (order_type = 'WPT' || order_type = '') order by travel_date asc";
                        				$result_summary_loop = mysqli_query($mysqli, $query_summary_loop) or die(mysqli_error($mysqli));
                        				$total_paxs = 0;
                        				while($row_summary_loop = mysqli_fetch_assoc($result_summary_loop))
                        				{
                        					$order_id_summary = $row_summary_loop['order_id'];
                        					$product_id_summary = $row_summary_loop['product_id'];
                        					$co_order_id_summary = $row_summary_loop['co_order_id'];
                        					$pax_remarks=$row_summary_loop['remarks'];
                        
                        					$travel_date_domestic = date('Y-m-d', strtotime($row_summary_loop['travel_date'])); 
                        					$trip_code_domestic = $row_summary_loop['trip_code'];
                        					$tripcode_plus_trav_date_for_domestic_filter = $trip_code_domestic.$travel_date_domestic; //Eg: MEL-AMD-TR019-TR5742023-03-22
                        					
                        					$query_count = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_summary' && co_order_id='$co_order_id_summary' && product_id = '$product_id_summary'";
                        					$result_count = mysqli_query($mysqli, $query_count);
                        					$row_count = mysqli_num_rows($result_count);
                        				   
                        				    $query_movement = "SELECT * FROM wpk4_backend_travel_booking_movements where order_id='$order_id_summary' && product_id='$product_id_summary' && co_order_id='$co_order_id_summary' ";
                        					$result_movement = mysqli_query($mysqli, $query_movement);
                        					$row_movement_count = mysqli_num_rows($result_movement);
                        				   
                        				    $pnr_received = '';
                        					$query_count_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_summary' && co_order_id='$co_order_id_summary' && product_id='$product_id_summary'";
                        					$result_count_pax = mysqli_query($mysqli, $query_count_pax);
                        					if(mysqli_num_rows($result_count_pax) > 0)
                        					{
                            					$row_count_pax = mysqli_fetch_assoc($result_count_pax);
                            					$pnr_received = $row_count_pax['pnr'];
                        					}
                							$total_paxs++;
                							$x_id = 1;
                							?>
                							<tr>
                    							<td width='8%'><b>
                        							<?php echo $row_summary_loop['order_id']; ?> <?php if($co_order_id_summary != '') { echo ' '.$co_order_id_summary; } ?></b>
                        							</br>
        							            </td>
                    							<td width='8%' style="text-align:center;"><?php echo $pnr_received; ?></td>
                    							<td width='10%' style="text-align:center;">
                                                	<?php echo $row_summary_loop['trip_code']; ?>
                                                </td>
                    							<td width='5%' style="text-align:center;"> <?php echo date('d/m/Y', strtotime($row_summary_loop['travel_date']));?> </td>
                    							</tr>
                    							<?php
                    							$x_id++;
                        				}
										$order_id = $order_id_api;
                        				$query_summary_loop = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api' AND co_order_id='$co_order_id_api' && (order_type = 'Agent') order by travel_date asc";
                        				$result_summary_loop = mysqli_query($mysqli, $query_summary_loop) or die(mysqli_error($mysqli));
                        				$total_paxs = 0;
                        				while($row_summary_loop = mysqli_fetch_assoc($result_summary_loop))
                        				{
                        					$order_id_summary = $row_summary_loop['order_id'];
                        					$product_id_summary = $row_summary_loop['product_id'];
                        					$co_order_id_summary = $row_summary_loop['co_order_id'];
                        					$pax_remarks=$row_summary_loop['remarks'];
                        
                        					$travel_date_domestic = date('Y-m-d', strtotime($row_summary_loop['travel_date'])); 
                        					$trip_code_domestic = $row_summary_loop['trip_code'];
                        					$tripcode_plus_trav_date_for_domestic_filter = $trip_code_domestic.$travel_date_domestic; //Eg: MEL-AMD-TR019-TR5742023-03-22
                        					
                        					$query_count = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_summary' && co_order_id='$co_order_id_summary' && product_id = '$product_id_summary'";
                        					$result_count = mysqli_query($mysqli, $query_count);
                        					$row_count = mysqli_num_rows($result_count);
                        				   
                        				    $query_movement = "SELECT * FROM wpk4_backend_travel_booking_movements where order_id='$order_id_summary' && product_id='$product_id_summary' && co_order_id='$co_order_id_summary' ";
                        					$result_movement = mysqli_query($mysqli, $query_movement);
                        					$row_movement_count = mysqli_num_rows($result_movement);
                        				   
                        				    $pnr_received = '';
                        					$query_count_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_summary' && co_order_id='$co_order_id_summary' && product_id='$product_id_summary'";
                        					$result_count_pax = mysqli_query($mysqli, $query_count_pax);
                        					if(mysqli_num_rows($result_count_pax) > 0)
                        					{
                            					$row_count_pax = mysqli_fetch_assoc($result_count_pax);
                            					$pnr_received = $row_count_pax['pnr'];
                        					}
                							$total_paxs++;
                							$x_id = 1;
                							?>
                							<tr>
                    							<td width='8%'><b>
                        							<?php echo $row_summary_loop['order_id']; ?> <?php if($co_order_id_summary != '') { echo ' '.$co_order_id_summary; } ?></b>
                        							</br>
        							            </td>
                    							<?php 
                    							 $order_type = $row_summary_loop['order_type'];
                    							 $source_f = $row_summary_loop['source'];
                    							 $sourcebkng = $row_summary_loop['source'];
                    							 $gds_id = '';
                    
                    							$source= '';
                    							
                    							if ($order_type == 'WPT' && substr($trip_code_domestic, 8, 2) === 'SQ') {
                                                    $source = 'Gdeals';
                                                    $gds_id = 'CCUVS32NQ';
                                                }
                                                if ($order_type == 'WPT' && substr($trip_code_domestic, 8, 2) === 'QF') {
                                                    $source = 'Gdeals';
                                                    $gds_id = 'MELA821CV';
                                                }
                    							if($order_type == 'WPT' && $sourcebkng == 'wpwebsite' ){
                    							    $source = 'Gdeals';
                    							    $gds_id = 'CCUVS32NQ';
                    							}
                    						
                    							 if($order_type == 'gds' && $sourcebkng == 'gaurain' ){
                    							    $source = 'Sabre';
                    							    $gds_id = '1BIK';
                    							}
                    							 if($order_type == 'gds' && $sourcebkng == 'gauraaws' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'MELA821CV';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'gaura' ){
                    							    $source = 'Sabre';
                    							    $gds_id = 'I5FC';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'gaurandcx' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'MELA828FN';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'gaurainn' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'CCUVS32NQ';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'shelltechb2bina' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'CCUVS32NQ';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'shelltechb2bndcxau' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'MELA828FN';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'shelltechb2b' ){
                    							    $source = 'Sabre';
                    							    $gds_id = 'I5FC';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'shelltechb2baws' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'MELA828FN';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'shelltechb2bin' ){
                    							    $source = 'SABRE';
                    							    $gds_id = '1BIK';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'shelltechb2bndcxin' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'CCUVS32NQ';
                    							}
                    							
                    							if ($order_type == 'gds' && substr($pnr_received, 0, 3) === 'SQ_') {
                                                    $source = 'SQ NDC';
                                                    $gds_id = 'I5FC';
                                                } 
												
												if($order_type == 'gds' && $sourcebkng == 'import' ){
                    							    $source = 'Import';
                    							    $gds_id = 'MELA821CV';
                    							}
												
												$pnr_received_2 = substr($pnr_received, 0, 6);
												
												
												$query_oid_status = "SELECT OID FROM wpk4_backend_stock_management_sheet where pnr='$pnr_received_2' and OID is not null";
												$result_oid_status = mysqli_query($mysqli, $query_oid_status);
												if(mysqli_num_rows($result_oid_status) > 0)
												{
													$row_oid_status = mysqli_fetch_assoc($result_oid_status);
													$gds_id = $row_oid_status['OID'];
												}
												
                                                $pnrs[] = [
                                                        'pnr' =>$pnr_received_2,
                                                        'source' => $source,
                                                        'gds_id' =>$gds_id
                                                    ];
                    							?>
                    							<td width='8%' style="text-align:center;"><?php echo $pnr_received; ?></td>
                    							<td width='8%' style="text-align:center;">	<?php echo $source ?></td>
                    							<td width='9%' style="text-align:center;"><?php echo $gds_id ?></td>
                    						
                    							<td width='10%' style="text-align:center;">
                                                	<?php echo $row_summary_loop['trip_code']; ?>
                                                </td>
                    							<td width='5%' style="text-align:center;"> <?php echo date('d/m/Y', strtotime($row_summary_loop['travel_date']));?> </td>
                    							</tr>
                    							<?php
                    							$x_id++;
                        				}
                        				$query_summary_loop = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api' && order_type = 'gds'";
                        				$result_summary_loop = mysqli_query($mysqli, $query_summary_loop) or die(mysqli_error($mysqli));
                        				while($row_summary_loop = mysqli_fetch_assoc($result_summary_loop))
                        				{
                        					$order_id_summary = $row_summary_loop['order_id'];
                        					$product_id_summary = $row_summary_loop['product_id'];
                        					$co_order_id_summary = $row_summary_loop['co_order_id'];
                        					$pax_remarks=$row_summary_loop['remarks'];
                        					$return_date=$row_summary_loop['return_date'];
                        					$travel_date=$row_summary_loop['travel_date'];
                        					
                        					$travel_date_domestic = date('Y-m-d', strtotime($row_summary_loop['travel_date'])); 
                            					$trip_code_domestic = $row_summary_loop['trip_code'];
                            					$tripcode_plus_trav_date_for_domestic_filter = $trip_code_domestic.$travel_date_domestic; //Eg: MEL-AMD-TR019-TR5742023-03-22
                            					
                            					$query_count = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_summary' && co_order_id='$co_order_id_summary'";
                            					$result_count = mysqli_query($mysqli, $query_count);
                            					$row_count = mysqli_num_rows($result_count);
                            				   
                            				    $query_movement = "SELECT * FROM wpk4_backend_travel_booking_movements where order_id='$order_id_summary' && product_id='$product_id_summary' && co_order_id='$co_order_id_summary' ";
                            					$result_movement = mysqli_query($mysqli, $query_movement);
                            					$row_movement_count = mysqli_num_rows($result_movement);
                            				   
                            					$query_count_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_summary' && co_order_id='$co_order_id_summary' && product_id='$product_id_summary'";
                            					$result_count_pax = mysqli_query($mysqli, $query_count_pax);
                            					$row_count_pax = mysqli_fetch_assoc($result_count_pax);
                    							$total_paxs++;
                    							$x_id = 1;
                        							 $order_type = $row_summary_loop['order_type'];
                        							 //$source = $row_summary_loop['source'];
                        							 $sourcebkng = $row_summary_loop['source'];
                        							$pnr_received = $row_count_pax['pnr'];
                        							
                                            if($return_date == $travel_date)
                        					{
                    							?>
                    							<tr>
                        							<td width='8%'><b>
                            							<?php echo $row_summary_loop['order_id']; ?> <?php if($co_order_id_summary != '') { echo ' '.$co_order_id_summary; } ?></b>
                            							</br>
            							            </td>
                        							<td width='8%' style="text-align:center;"><?php echo $row_count_pax['pnr']; ?></td>
                        							<td width='10%' style="text-align:center;">
                                                    	<?php echo $row_summary_loop['trip_code']; ?>
                                                    </td>
                        							<td width='5%' style="text-align:center;"> <?php echo date('d-m-Y', strtotime($row_summary_loop['travel_date']));?> </td>
                        						</tr>
                        						<?php
                        					}
                        					else
                        					{
                        					    ?>
                        					    <tr>
                        							<td width='8%'><b>
                            							<?php echo $row_summary_loop['order_id']; ?> <?php if($co_order_id_summary != '') { echo ' '.$co_order_id_summary; } ?></b>
                            							</br>
            							            </td>
                        							<td width='8%' style="text-align:center;"><?php echo $row_count_pax['pnr']; ?></td>
                        							<td width='10%' style="text-align:center;">
                                                    	<?php echo $row_summary_loop['trip_code']; ?>
                                                    </td>
                        							<td width='5%' style="text-align:center;"> <?php echo date('d-m-Y', strtotime($row_summary_loop['travel_date']));?> </td>
                        						</tr>
                    							<tr>
                        							<td width='8%'><b>
                            							<?php echo $row_summary_loop['order_id']; ?> <?php if($co_order_id_summary != '') { echo ' '.$co_order_id_summary; } ?></b>
                            							</br>
            							            </td>
                        							<td width='8%' style="text-align:center;"><?php echo $row_count_pax['pnr']; ?></td>
                        							<td width='10%' style="text-align:center;">
                                                    <?php
                                                    $parts_trip = explode("-", $row_summary_loop['trip_code']);

                                                    if (count($parts_trip) >= 2) {
                                                        $origin_place = $parts_trip[0];
                                                        $destination_place = $parts_trip[1];
                                                    
                                                        echo $destination_place . ' - ' .$origin_place;
                                                    }
                                                    ?>
                                                    </td>
                        							<td width='5%' style="text-align:center;"> <?php echo date('d-m-Y', strtotime($row_summary_loop['return_date']));?> </td>
                        						</tr>
                        						<?php
                        					}
                        					
                        					$x_id++;
                        				}
                        				?>
                    				    </tbody>
                    				</table>
                				</div>
                				
                				<div id="names_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>" class="tabcontent" style="display:none;">

                        				    <?php
                        				    $order_id = $order_id_api;
                        				    if($order_type_itinerary == 'WPT' || $order_type_itinerary == '' || $order_type_itinerary == 'Agent')
        				                    {
                            				    $total_paxs = 0;
                            				    $query_summary_loop = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api'";
                            				    $result_loop = mysqli_query($mysqli, $query_summary_loop) or die(mysqli_error($mysqli));
                                			    while($row_loop = mysqli_fetch_assoc($result_loop))
                            				    {
                            				        $order_id_pax_view = $row_loop['order_id'];
                            				        $co_order_id_pax_view = $row_loop['co_order_id'];
                            				        $product_id_pax_view = $row_loop['product_id'];
                            				        echo $row_loop['product_title']. ' | ' .$row_loop['trip_code'];
                            				        ?>
                            				        <table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
                                					<thead>
                                    					<tr>
                                        					<th>PNR</th>
                                        					<th>Ticket</th>
                                        					<th>Salutation</th>
															<th>First Name</th>
															<th>Last Name</th>
                                        					<th>DOB</th>
                                        					<th>PPN</th>
                                        					<th>PPE</th>
                                        					<th>Meal</th>
                                        					<th>Wheelchair</th>
                                        					<th>Baggage</th>
                                        					
                                    				    </tr>
                                				    </thead>
                                				    <tbody>
                            				        <?php
                            				        $query_summary_loop_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_pax_view' && co_order_id = '$co_order_id_pax_view' && product_id = '$product_id_pax_view'";
                                				    $result_loop_pax = mysqli_query($mysqli, $query_summary_loop_pax) or die(mysqli_error($mysqli));
                                				    $total_amount_from_pax = 0;
                                    			    while($row_loop_pax = mysqli_fetch_assoc($result_loop_pax))
                                    			    {
                                                        $total_paxs++;
                                						?>
                                						<tr>
                                						<td width='8%'><?php echo $row_loop_pax['pnr']; ?></td>
                                						<td width='8%'><?php echo $row_loop_pax['ticket_number']; ?></td>
                                						<td width='11%'><?php echo $row_loop_pax['salutation']; ?></td>
														<td width='11%'><?php echo $row_loop_pax['fname']; ?></td>
														<td width='11%'><?php echo $row_loop_pax['lname']; ?></td>
                                						<td width='8%'><?php echo $row_loop_pax['dob']; ?></td>
                                						<td width='8%'><?php echo $row_loop_pax['ppn']; ?></td>
                                						<td width='8%'><?php echo $row_loop_pax['ppe']; ?></td>
                                						<td width='8%'><?php echo $row_loop_pax['meal']; ?></td>
                                						<td width='8%'><?php echo $row_loop_pax['wheelchair']; ?></td>
                                						<td width='8%'><?php echo $row_loop_pax['baggage']; ?></td>
                                						
                                						
                                						</tr>
                                						<?php
                                    			    }
                                    			    ?>
                                    			    
                                    			    </tbody>
                    				                </table></br></br>
                                    			    <?php
                            				    }
        				                    }
        				                    else
        				                    {
        				                        $total_paxs = 0;
                            				    $query_summary_loop = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api'";
                            				    $result_loop = mysqli_query($mysqli, $query_summary_loop) or die(mysqli_error($mysqli));
                                			    while($row_loop = mysqli_fetch_assoc($result_loop))
                            				    {
                            				        $order_id_pax_view = $row_loop['order_id'];
                            				        $travel_date = $row_loop['travel_date'];
			                                        $return_date = $row_loop['return_date'];
                            				        $co_order_id_pax_view = $row_loop['co_order_id'];
                            				        $product_id_pax_view = $row_loop['product_id'];
                            				        if($return_date != $travel_date) // return trip block
			                                        {
			                                            $parts_trip = explode("-", $row_loop['trip_code']);
                                				        if (count($parts_trip) >= 2) {
                                                            $origin_place = $parts_trip[0];
                                                            $destination_place = $parts_trip[1];
                                                                echo '<tr><th colspan="6">'. $origin_place . ' - ' . $destination_place . ' - ' . $travel_date .'</th></tr>';
                                                        }
                                				        ?>
                                				        <table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
                                    					<thead>
                                        					<tr>
                                            					<th>PNR</th>
                                            					<th>Ticket</th>
                                            					<th>Salutation</th>
															<th>First Name</th>
															<th>Last Name</th>
                                            					<th>DOB</th>
                                            					<th>PPN</th>
                                            					<th>PPE</th>
                                            					<th>Meal</th>
                                            					<th>Wheelchair</th>
                                            					<th>Baggage</th>
                                            					
                                        				    </tr>
                                    				    </thead>
                                    				    <tbody>
                                				        <?php
                                				        $query_summary_loop_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_pax_view' && co_order_id = '$co_order_id_pax_view' && product_id = '$product_id_pax_view'";
                                    				    $result_loop_pax = mysqli_query($mysqli, $query_summary_loop_pax) or die(mysqli_error($mysqli));
                                        			    while($row_loop_pax = mysqli_fetch_assoc($result_loop_pax))
                                        			    {
                                                            $total_paxs++;
                                    						?>
                                    						<tr>
                                    						<td width='8%'><?php echo $row_loop_pax['pnr']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['ticket_number']; ?></td>
                                    						<td width='11%'><?php echo $row_loop_pax['salutation']; ?></td>
														<td width='11%'><?php echo $row_loop_pax['fname']; ?></td>
														<td width='11%'><?php echo $row_loop_pax['lname']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['dob']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['ppn']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['ppe']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['meal']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['wheelchair']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['baggage']; ?></td>
                                    						
                                    						</tr>
                                    						<?php
                                        			    }
                                        			    ?>
                                        			    </tbody>
                        				                </table></br></br>
                        				                <?php
                        				                $parts_trip = explode("-", $row_loop['trip_code']);
                                				        if (count($parts_trip) >= 2) {
                                                            $origin_place = $parts_trip[0];
                                                            $destination_place = $parts_trip[1];
                                                                echo '<tr><th colspan="6">'. $destination_place . ' - ' . $origin_place . ' - ' . $return_date .'</th></tr>';
                                                        }
                                				        ?>
                                				        <table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
                                    					<thead>
                                        					<tr>
                                            					<th>PNR</th>
                                            					<th>Ticket</th>
                                            					<th>Salutation</th>
															<th>First Name</th>
															<th>Last Name</th>
                                            					<th>DOB</th>
                                            					<th>PPN</th>
                                            					<th>PPE</th>
                                            					<th>Meal</th>
                                            					<th>Wheelchair</th>
                                            					<th>Baggage</th>
                                            					
                                        				    </tr>
                                    				    </thead>
                                    				    <tbody>
                                				        <?php
                                				        $query_summary_loop_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_pax_view' && co_order_id = '$co_order_id_pax_view' && product_id = '$product_id_pax_view'";
                                    				    $result_loop_pax = mysqli_query($mysqli, $query_summary_loop_pax) or die(mysqli_error($mysqli));
                                        			    while($row_loop_pax = mysqli_fetch_assoc($result_loop_pax))
                                        			    {
                                                            $total_paxs++;
                                    						?>
                                    						<tr>
                                    						<td width='8%'><?php echo $row_loop_pax['pnr']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['ticket_number']; ?></td>
                                    						<td width='11%'><?php echo $row_loop_pax['salutation']; ?></td>
														<td width='11%'><?php echo $row_loop_pax['fname']; ?></td>
														<td width='11%'><?php echo $row_loop_pax['lname']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['dob']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['ppn']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['ppe']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['meal']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['wheelchair']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['baggage']; ?></td>
                                    						
                                    						</tr>
                                    						<?php
                                        			    }
                                        			    ?>
                                        			    </tbody>
                        				                </table></br></br>
                                        			    <?php
			                                        }
			                                        else
			                                        {
			                                            ?>
			                                            <table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
                                    					<thead>
                                        					<tr>
                                            					<th>PNR</th>
                                            					<th>Ticket</th>
                                            					<th>Salutation</th>
															<th>First Name</th>
															<th>Last Name</th>
                                            					<th>DOB</th>
                                            					<th>PPN</th>
                                            					<th>PPE</th>
                                            					<th>Meal</th>
                                            					<th>Wheelchair</th>
                                            					<th>Baggage</th>
                                            					
                                        				    </tr>
                                    				    </thead>
                                    				    <tbody>
                                				        <?php
                                				        $query_summary_loop_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_pax_view' && co_order_id = '$co_order_id_pax_view' && product_id = '$product_id_pax_view'";
                                    				    $result_loop_pax = mysqli_query($mysqli, $query_summary_loop_pax) or die(mysqli_error($mysqli));
                                        			    while($row_loop_pax = mysqli_fetch_assoc($result_loop_pax))
                                        			    {
                                                            $total_paxs++;
                                    						?>
                                    						<tr>
                                    						<td width='8%'><?php echo $row_loop_pax['pnr']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['ticket_number']; ?></td>
                                    						<td width='11%'><?php echo $row_loop_pax['salutation']; ?></td>
														<td width='11%'><?php echo $row_loop_pax['fname']; ?></td>
														<td width='11%'><?php echo $row_loop_pax['lname']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['dob']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['ppn']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['ppe']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['meal']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['wheelchair']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['baggage']; ?></td>
                                    						
                                    						</tr>
                                    						<?php
                                        			    }
                                        			    ?>
                                        			    </tbody>
                        				                </table></br></br>
			                                            <?php
			                                        }
                            				    }
        				                    }
                        				    ?>
                    				    
    				            </div>
    				            
                				<div id="payments_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>" class="tabcontent" style="display:none;">
                        				    
                        				    <?php
                				    $order_id = $order_id_api;
                				    $query_initial_order = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api'";
                                	$result_initial_order = mysqli_query($mysqli, $query_initial_order);
                                	$row_initial_order = mysqli_fetch_assoc($result_initial_order);
                                    $order_date = $row_initial_order['order_date'];
                                    $order_type_paymentblock = $row_initial_order['order_type'];
									$source_paymentblock = $row_initial_order['source'];
                                    $payment_status = $row_initial_order['payment_status'];
                                    $late_modified = $row_initial_order['late_modified'];
                                    $modified_by = $row_initial_order['modified_by'];
                                    $payment_modified = $row_initial_order['payment_modified'];
                                    $payment_modified_by = $row_initial_order['payment_modified_by'];
                                    $deposit_amount = '';
                                    if($order_type_paymentblock != 'gds' )
                                        {
                                            
                                        $total_amount = $row_initial_order['total_amount'];
                                        $total_amount_from_postmeta = $total_amount;
                                        $deposit_amount = $row_initial_order['deposit_amount'];
                                        $balance = $row_initial_order['balance'];
                                        
                                        
                                            $wpt_coupon_code_array = get_post_meta($order_id_api, 'wp_travel_applied_coupon_data', true);
                                            if(isset($wpt_coupon_code_array) && $wpt_coupon_code_array != '' && isset($wpt_coupon_code_array['coupon_code']) && $wpt_coupon_code_array['coupon_code'] != '')
                                            {
                                                $ordertotal__query = $wpdb->get_results( "SELECT * FROM wpk4_postmeta where post_id='$order_id_api' && meta_key='order_totals'"); 
                                                foreach($ordertotal__query as $row_2){ 
                                                    $order_total_amount = $row_2->meta_value;
                                                }
                                                $orderData = unserialize($order_total_amount);
                                                //$total_amount = $orderData['sub_total'];
                                                $total_amount_from_postmeta = $orderData['cart_total'];
                                                $balance = $total_amount - $deposit_amount;
                                            }
                                            
                                        }
                                    
                                    $total_amount_gds = 0;
                                    if($order_type_paymentblock == 'gds' && $deposit_amount == '' )
                                    {
                                        $deposit_amount = $row_initial_order['deposit_amount'];
                                        $total_amount_gds = get_meta_from_history_of_updates($order_id_api, 'Transaction TotalTurnover');
                                        $total_amount = get_meta_from_history_of_updates($order_id_api, 'Transaction TotalTurnover');
                                        $total_amount_from_postmeta = $total_amount;
                                        if($deposit_amount == '')
                                        {
                                            
                                            $deposit_amount_temp = 0;
                                            $query_initial_order_meta = "SELECT * FROM wpk4_backend_history_of_updates where type_id='$order_id_api' && meta_key = 'Payments Amount'";
                                        	$result_initial_order_meta = mysqli_query($mysqli, $query_initial_order_meta);
                                        	while($row_initial_order_meta = mysqli_fetch_assoc($result_initial_order_meta))
                                        	{
                                        	    $deposit_amount_temp = $deposit_amount_temp + (float)$row_initial_order_meta['meta_value'];
                                        	}
                                    	    $deposit_amount = $deposit_amount_temp;
                                        }
                                        $balance = (float)$total_amount - (float)$deposit_amount;
                                    }
									
									if($source_paymentblock == 'datechange')
									{
										$total_amount = $row_initial_order['total_amount'];
                                        $total_amount_from_postmeta = $total_amount;
                                        //$deposit_amount = $row_initial_order['deposit_amount'];
                                        $balance = '';
									}
                                    
                                    /* Intermediate code added to resolve the issue on G360 GDS total amount shown as 0 after use Update from GDS option. */
                                    if($currnt_userlogn == 'sriharshans' && 1 == 3)
                                    {
                                    if((float)$total_amount_gds == 0 && $order_type_paymentblock == 'gds')
                                    {
                                        $total_amount = $row_initial_order['total_amount'];
                                        
                                        $deposit_amount = $row_initial_order['deposit_amount'];

                                        if($deposit_amount == '')
                                        {
                                            
                                            $deposit_amount_temp = 0;
                                            $query_initial_order_meta = "SELECT * FROM wpk4_backend_history_of_updates where type_id='$order_id_api' && meta_key = 'Payments Amount'";
                                        	$result_initial_order_meta = mysqli_query($mysqli, $query_initial_order_meta);
                                        	while($row_initial_order_meta = mysqli_fetch_assoc($result_initial_order_meta))
                                        	{
                                        	    $deposit_amount_temp = $deposit_amount_temp + (float)$row_initial_order_meta['meta_value'];
                                        	}
                                    	    $deposit_amount = $deposit_amount_temp;
                                        }
                                        $balance = (float)$total_amount - (float)$deposit_amount;
                                        
                                    }
                                    }
                                    /* Intermediate code ends */
                                    
                                    $query_pnr_for_total_paid = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api'";
                                    $result_pnr_for_total_paid = mysqli_query($mysqli, $query_pnr_for_total_paid);
                                    $row_pnr_for_total_paid = mysqli_fetch_assoc($result_pnr_for_total_paid);
                                	$received_pnr_for_total_paid = $row_pnr_for_total_paid['pnr'];
                                	$processedPaymentsPaid = array();	
                            		$query_payment_paid_amount = "SELECT * FROM wpk4_backend_travel_payment_history where (pay_type = 'deposit' OR pay_type LIKE 'balance' 
                            		OR pay_type LIKE 'Balance' OR pay_type = 'deposit_adjustment' OR pay_type = 'Refund' OR pay_type = 'additional_payment') 
                            		AND order_id='$order_id_api' order by process_date desc";
                                    $result_payment_paid_amount = mysqli_query($mysqli, $query_payment_paid_amount);
                                    $total_paid_for_booking = 0;
                                    if($result_payment_paid_amount && mysqli_num_rows($result_payment_paid_amount) > 0)
                                    {
                                        while($row_payment_paid_amount = mysqli_fetch_assoc($result_payment_paid_amount))
                                        {
                                            $payment_identifier = $row_payment_paid_amount['process_date'].'^'.$row_payment_paid_amount['trams_received_amount'].'^'.$row_payment_paid_amount['reference_no']; // defined value to restric duplicate amount + ref no combination on G360
                                			if (in_array($payment_identifier, $processedPaymentsPaid)) 
                                			{
                                			    continue; // Skip to the next value
                                			}
                                				
                                				
                                			$processedPaymentsPaid[] = $payment_identifier;
                                					
                                            $total_paid_for_booking += (float)$row_payment_paid_amount['trams_received_amount'];
                                        }
                                        
                                        if($total_paid_for_booking < 0)
                                        {
                                            $total_paid_for_booking = 0;
                                        }
                                        
                                        $balance = (float)$total_amount - (float)$total_paid_for_booking; 
                                    }
                                    
                                    if($balance == '')
                            		{
                            		    $balance = (float)$total_amount - (float)$deposit_amount;
                            		}
                				    ?>
                				    <?php
                				    $discount_given_amount = 0;
                				    if($order_type_paymentblock == 'WPT' )
                                    {
                                        $wpt_coupon_code_array = get_post_meta($order_id_api, 'wp_travel_applied_coupon_data', true);
                                        if(isset($wpt_coupon_code_array) && $wpt_coupon_code_array != '' && isset($wpt_coupon_code_array['coupon_code']) && $wpt_coupon_code_array['coupon_code'] != '')
                                        {
                                            $wpt_coupon_code_type = '';
                                            if($wpt_coupon_code_array['type'] == 'percentage')
                                            {
                                                $wpt_coupon_code_type = '%';
                                            }
                                            $discount_given_amount = $total_amount_from_postmeta - $total_amount;
                                            ?>
                                            </br></br>
                                            Total amount before discount: <b><?php echo number_format((float)$total_amount_from_postmeta, 2, '.', ''); ?></b></br>
                                            Discount given: <b><?php echo number_format((float)$discount_given_amount, 2, '.', ''); ?></b></br>
                                            Coupon applied: <b><?php echo $wpt_coupon_code_array['coupon_code']; ?> (Discount: <?php echo $wpt_coupon_code_array['value'].$wpt_coupon_code_type; ?>)</b></br>
                                            <?php
                                        }
                                    }
                				    ?>
                				    </br>
                				    <?php
                				    if($discount_given_amount != 0)
                				    {
                				        echo 'Total Amount after discount: ';
                				    }
                				    else
                				    {
                				         echo 'Total Amount: ';
                				    }
                				    ?>
                                        <b><?php echo number_format((float)$total_amount, 2, '.', ''); ?></b>
                                    
                                    <?php
                                    if($total_paid_for_booking < 0)
                                    {
                                        $total_paid_for_booking = 0;
                                    }
                                    
                                    ?>
                                    </br>
                                    Amount paid: <b><?php echo number_format((float)$total_paid_for_booking, 2, '.', ''); ?></b></br>
                                    Balance: <b><?php echo number_format((float)$balance, 2, '.', ''); ?></b>
                                             </br></br>
                                             
                                            <?php
                                            $is_past_payment_link_active = 0;
                                            $query_paymentrequest_history_check = "SELECT * FROM wpk4_backend_travel_booking_custom_payments where order_id='$order_id_api' and type_of_payment = 'Balance Payment' and status = 'waiting' and date(azupay_expiry_date) > DATE(CURRENT_DATE()) order by auto_id desc limit 1;";
                                            $result_paymentrequest_history_check = mysqli_query($mysqli, $query_paymentrequest_history_check);
                                            if(mysqli_num_rows($result_paymentrequest_history_check) > 0)
                                            {
                                                $is_past_payment_link_active = 1;
                                            }
                                            
                                            // reshare the existing payment link
                                            if(($row_payment_status['payment_status'] == 'partially_paid' && $is_past_payment_link_active == 1) )
                                            {
                                                  
                                                    
                                            echo '
                                                <div style="border:1px solid #e0dada; margin-top:15px; padding:15px 15px;">
                                                
                                                    <!-- Checkbox -->
                                                    <label style="font-weight:400; font-size:13px;">
                                                        <input type="checkbox" id="checkbox1" >
                                                        &nbsp;&nbsp;I have read and accepted the itinerary information. the <a target="_blank" href="terms-and-conditions/">terms & conditions of the travel agency</a>, the airline&#39;s ticket rules & itinerary information.
                                                    </label><br>
                                            
                                                    <!-- Wrapper for Pay Now Button -->
                                                    <div>
                                                        <!-- Pay Now Button (Initially Disabled) -->
                                                        <button id="payNowBfgutton" style="padding:15px; background-color: #ffbb00; margin:0; font-size:11px; font-weight:600;" disabled>PAY NOW</button>
                                                    </div>
                                            
                                                    
                                                </div>
                                            ';
        
                                            }
                                            
                                            // create new payment links
                                            if( ($row_payment_status['payment_status'] == 'partially_paid' && $is_past_payment_link_active == 0 ) )
                                            {
                                            ?>
                                                <div style="border:1px solid #e0dada; margin-top:15px; padding:15px 15px;">
                                                <form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                                    <?php
                                                    
                                    		                                    		
                                                    $received_pnr_for_azupay_receipt = '';
                                                    $query_pnr_case = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id'";
                                                	$result_pnr_case = mysqli_query($mysqli, $query_pnr_case);
                                                	while($row_pnr_case = mysqli_fetch_assoc($result_pnr_case))
                                                	{
                                        				$received_pnr_for_azupay_receipt = $row_pnr_case['pnr']; // get one PNR for azupay customer viewing
                                                	}
                                                    ?>
                                                    <label style="font-weight:400; font-size:13px;">
                                                        <input type="checkbox" id="checkbox1" required>
                                                        &nbsp;&nbsp;I have read and accepted the itinerary information. the <a target="_blank" href="terms-and-conditions/">terms & conditions of the travel agency</a>, the airline&#39;s ticket rules & itinerary information.
                                                    </label><br>
                                                    <input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='test_general_payment_request' value='Pay Balance Now ($<?php echo $balance; ?>)'>
                                        		</form>
                                        		</br>
                                        		
                                        		</div>
                                            <?php
                                            }
                                            
                                            
                                            
                                            
                                            ?>
                                            <?php
                                        		if( $row_payment_status['payment_status'] == 'partially_paid' && number_format((float)$total_paid_for_booking, 2, '.', '') == 0.00 )
                                                {
                                                    $payment_partial_value_deposit = '';
                                                    $query_payments_postmeta2 = "SELECT meta_value FROM wpk4_postmeta where post_id='$order_id' && meta_key='order_totals'";
                                                    $result_payments_postmeta2 = mysqli_query($mysqli, $query_payments_postmeta2);
                                                    if(mysqli_num_rows($result_payments_postmeta2) > 0)
                                                    {
                                                        $row_postmeta2 = mysqli_fetch_assoc($result_payments_postmeta2);
                                                        $order_total_amount_deposit = $row_postmeta2['meta_value'];
                                                        $orderData_deposit = unserialize($order_total_amount_deposit);
                                                        $payment_partial_value_deposit = $orderData_deposit['total_partial'];
                                                    }
                                                    if($payment_partial_value_deposit == '')
                                                    {
                                                        $query_payment_amount_deposit = "SELECT total_amount, total_pax FROM wpk4_backend_travel_bookings where order_id='$order_id'";
                                                        $result_payment_amount_deposit = mysqli_query($mysqli, $query_payment_amount_deposit);
                                                        $row_payment_amount_deposit = mysqli_fetch_assoc($result_payment_amount_deposit);
                                                        //$payment_partial_value_deposit = $row_payment_amount_deposit['total_amount'] * 0.05;
														
														$payment_partial_value_deposit = (int)$row_payment_amount_deposit['total_pax'] * 5;
                                                    }
                                                    
                                                    $payment_partial_value_deposit = number_format((float)$payment_partial_value_deposit, 2, '.', '');
                                                    
                                                    ?>
                                                    <div>
                                                        <button id="payDepositNowButton" style="padding:15px; color:black; background-color: #ffbb00; margin:0; font-size:11px; font-weight:600;">PAY $<?php echo $payment_partial_value_deposit; ?> DEPOSIT NOW</button>
                                                    </div>
                                                    <?php
                                                }
                                                ?>
                                            </br>
											<?php 
											if( $row_payment_status['payment_status'] == 'partially_paid' )
                                            {
											?>
                                            <div style="border:1px solid #e0dada; margin-top:15px; padding:15px 15px;">
                                            <h6>Add BPAY Receipt</h6>
                                    		    <form action="#" name="statusupdate" method="post" enctype="multipart/form-data" >
                                        		<style>
                                        		    .myattachmentchat_g360
                                        		    {
                                        		        display:block;
                                        		    }
                                        		</style>
                                        		<input type="file" accept=".jpg,.jpeg,.png,.pdf,.txt" class='myattachmentchat_g360' name="myattachmentchat" id="myattachmentchat"></br>
                                        		<p style="font-size:11px;">Allowed file types are .jpg, .png, .pdf</p>
                                			    <input type='submit' name='ment_bpay' id='ment_bpay' class='btn btn-success' style='padding:15px; margin:0;font-size:11px;' value='Upload'>
                                		    </form>
                                		    </div>
                                		    <?php
											}
											?>
                                            <style>
                                                    /* Basic styles for the modal */
                                                    .modal-payment {
                                                        display: none;
                                                        position: fixed;
                                                        z-index: 10000;
                                                        left: 0;
                                                        top: 0;
                                                        width: 100%;
                                                        height: 100%;
                                                        overflow: auto;
                                                        background-color: rgba(0, 0, 0, 0.5);
                                                        justify-content: center;
                                                        align-items: center;
                                                    }
                                                    .modal-payment-content {
                                                        background-color: white;
                                                        padding: 20px;
                                                        border-radius: 5px;
                                                        width: 80%;
                                                        max-width: 600px;
                                                    }
                                                    .close-payment {
                                                        color: #aaa;
                                                        float: right;
                                                        font-size: 28px;
                                                        font-weight: bold;
                                                        cursor: pointer;
                                                    }
                                                </style>
                                                <div id="paymentModal" class="modal-payment">
                                                    <div class="modal-payment-content">
                                                        <span class="close-payment">&times;</span>
                                                        <p id="paymentOptions"></p>
                                                    </div>
                                                </div>
                                                
                                            <?php
                                            // DC total charge section
                                            
                                    		$query_payment_dc_amount = "SELECT * FROM wpk4_backend_travel_payment_history WHERE (pay_type = 'Datechange' OR pay_type LIKE 'dc_charge') AND order_id='$order_id_api' AND order_id != '' ORDER BY process_date DESC";
                                            $result_payment_dc_amount = mysqli_query($mysqli, $query_payment_dc_amount);
                                            
                                            // Initialize an array to hold the sums of trams_received_amount for each reference_no
                                            $sums_by_reference = array();
                                            
                                            // Initialize an array to track processed payments (to avoid duplicates)
                                            $processedPaymentsDC = array();
                                            
                                            if (mysqli_num_rows($result_payment_dc_amount) > 0) {
                                                echo '</br></br>';
                                                while ($row_payment_dc_amount = mysqli_fetch_assoc($result_payment_dc_amount)) {
                                                    $temp_ref_no = explode("_", $row_payment_dc_amount['reference_no']);
                                                    if(!isset($temp_ref_no[1]) || ( isset($temp_ref_no[1]) && $temp_ref_no[1] == '') )
                                                    {
                                                        $temp_ref_no[1] = 'N/A';
                                                    }
                                                    
                                                    $payment_identifier = $row_payment_dc_amount['process_date'] . '^' . $row_payment_dc_amount['trams_received_amount'] . '^' . $row_payment_dc_amount['reference_no'];
                                            
                                                    // Skip duplicate entries
                                                    if (in_array($payment_identifier, $processedPaymentsDC)) {
                                                        continue;
                                                    }
                                                    $processedPaymentsDC[] = $payment_identifier;
                                            
                                                    // Add the trams_received_amount to the total for the current reference_no
                                                    if (!isset($sums_by_reference[$temp_ref_no[1]])) {
                                                        $sums_by_reference[$temp_ref_no[1]] = 0.0;
                                                    }
                                                    
                                                    $sums_by_reference[$temp_ref_no[1]] += (float)$row_payment_dc_amount['trams_received_amount'];
                                                }
                                            
                                                // Display the total trams_received_amount for each reference_no
                                                foreach ($sums_by_reference as $reference_no => $totalpaid_case) {
                                                    
                                                    
                                                    $query_dc_pay_status = "SELECT * FROM wpk4_backend_travel_booking_custom_payments where payment_client_id LIKE '%$reference_no%'";
                                                    $result_dc_pay_status = mysqli_query($mysqli, $query_dc_pay_status);
                                                    $dc_total_payment_for_case = 0;
                                                    if(mysqli_num_rows($result_dc_pay_status) > 0)
                                            		{
                                                		while($count_dc_pay_status = mysqli_fetch_assoc($result_dc_pay_status))
                                                		{
                                    					    $dc_total_payment_for_case += (float)$count_dc_pay_status['amount'];
                                                		}
                                            		}
                                            		$dc_balance_for_case = $dc_total_payment_for_case - $totalpaid_case;
                                            		
                                            		// assiging dummy 0.00 to avoid negative value as there are no requested amount found.
                                            		if($dc_total_payment_for_case == 0)
                                            		{
                                            		    $dc_balance_for_case = 0.00;
                                            		}
                                            				
                                                    echo 'Case: <b>' . $reference_no . '</b><br>
                                                    Requested: <b>' . number_format($dc_total_payment_for_case, 2, '.', '') . '</b><br>
                                                    Paid: <b>' . number_format($totalpaid_case, 2, '.', '') . '</b><br>
                                                    Balance: <b>' . number_format($dc_balance_for_case, 2, '.', '') . '</b><br><br>';
                                                    
                                                }
                                                
                                            }
                                            else
                                            {
                                                echo '<br/><br/>';
                                            }
                                            
                                                $query_pnr_for_payments = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api'";
                                                $result_pnr_for_payments = mysqli_query($mysqli, $query_pnr_for_payments);
                                                $row_pnr_for_payments = mysqli_fetch_assoc($result_pnr_for_payments);
                                                $received_order_type_for_payments = $row_pnr_for_payments['order_type'];
                                        		$received_pnr_for_payments = $row_pnr_for_payments['pnr'];
                                                $processedPayments = array();
                                                if($received_order_type_for_payments == 'WPT')
                                                {
                                                    ?>
                                                    <h6>Booking Payment</h6>
                                                    <table class="table" style="font-size:13px;">
                                                        <tr>
                                                            <th>Payment Date</th><th>Type</th><th>Paid Amount</th><th>Reference No</th><th>Remark</th><th>Method</th>
                                                        </tr>
                                                        <?php
                                                        $query_payment_history = "SELECT * FROM wpk4_backend_travel_payment_history where order_id='$order_id_api' AND (pay_type IN ('deposit', 'balance', 'balance ', 'Balance', 'deposit_adjustment', 'Refund', 'additional_payment') OR pay_type IS NULL OR pay_type = '') order by process_date desc";
                                                    	$result_payment_history = mysqli_query($mysqli, $query_payment_history);
                                                    	if(mysqli_num_rows($result_payment_history) > 0)
                                                    	{
                                                    	    
                                                        	while($row_payment_history = mysqli_fetch_assoc($result_payment_history))
                                                        	{
                                                                $payment_identifier = $row_payment_history['process_date'].'^'.$row_payment_history['trams_received_amount'].'^'.$row_payment_history['reference_no']; // defined value to restric duplicate amount + ref no combination on G360
                                            					if (in_array($payment_identifier, $processedPayments)) 
                                            					{
                                            					   continue; // Skip to the next value
                                            					}
                                            							
                                            					$processedPayments[] = $payment_identifier;
                                            						
                                                        	    $current_pay_method_id = $row_payment_history['payment_method'];
                                                        	    $query_payment_method_finder = "SELECT * FROM wpk4_backend_accounts_bank_account where bank_id='$current_pay_method_id'";
                                                            	$result_payment_method_finder = mysqli_query($mysqli, $query_payment_method_finder);
                                                            	$row_payment_method_finder = mysqli_fetch_assoc($result_payment_method_finder);
                                                            	$row_payment_method_finder_count = mysqli_num_rows($result_payment_method_finder);
                                                            	$bank_account_type_name = '';
                                                            	if($row_payment_method_finder_count > 0)
                                                            	{
                                                            	    $bank_account_type_name = $row_payment_method_finder['account_name'];
                                                            	}
                                                                ?>
                                                                <tr>
                                                                    <td><?php echo date('d/m/Y H:i:s', strtotime($row_payment_history['process_date'])); ?></td>
                                                                    <td>
                                                                        <?php 
                                                                        if($row_payment_history['pay_type'] == 'deposit')
                                                                        {
                                                                            echo "Booking Deposit"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'balance' || $row_payment_history['pay_type'] == 'balance ' || $row_payment_history['pay_type'] == 'Balance')
                                                                        {
                                                                            echo "Booking Balance"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'deposit_adjustment')
                                                                        {
                                                                            echo "Booking Deposit Adjustment"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'dc_charge')
                                                                        {
                                                                            echo "Datechange"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'Datechange')
                                                                        {
                                                                            echo "Datechange"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'additional_payment')
                                                                        {
                                                                            echo "Additional Payment"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'Refund')
                                                                        {
                                                                            echo "Refund"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'other')
                                                                        {
                                                                            echo "Other"; 
                                                                        }
                                                                        else
                                                                        {
                                                                            echo "Unknown"; 
                                                                        }
                                                                        ?>
                                                                    </td>
                                                                    <td><?php echo $row_payment_history['trams_received_amount']; ?></td>
                                                                    <td><?php echo $row_payment_history['reference_no']; ?></td>
                                                                    <td><?php echo $row_payment_history['trams_remarks']; ?></td>
                                                                    <td><?php echo $bank_account_type_name; ?></td> 
                                                                </tr>
                                                                <?php
                                                            }
                                                    	}
                                                    	else
                                                		{
                                                		    echo '<td colspan="6">No record found</td>';
                                                		}
                                                    	?>
                                                	</table>
                                                	
                                                	<h6>Other Payment</h6>
                                                	<table class="table" style="font-size:13px;">
                                                        <tr>
                                                            <th>Payment Date</th><th>Type</th><th>Paid Amount</th><th>Reference No</th><th>Remark</th><th>Method</th>
                                                        </tr>
                                                    	<?php
                                                    	$query_payment_history = "SELECT * FROM wpk4_backend_travel_payment_history where order_id='$order_id_api' AND pay_type IN ('dc_charge', 'Datechange', 'other') order by process_date desc";
                                                    	$result_payment_history = mysqli_query($mysqli, $query_payment_history);
                                                    	if(mysqli_num_rows($result_payment_history) > 0)
                                                    	{
                                                    	    
                                                        	while($row_payment_history = mysqli_fetch_assoc($result_payment_history))
                                                        	{
                                                                $payment_identifier = $row_payment_history['process_date'].'^'.$row_payment_history['trams_received_amount'].'^'.$row_payment_history['reference_no']; // defined value to restric duplicate amount + ref no combination on G360
                                            					if (in_array($payment_identifier, $processedPayments)) 
                                            					{
                                            					   continue; // Skip to the next value
                                            					}
                                            							
                                            					$processedPayments[] = $payment_identifier;
                                            						
                                                        	    $current_pay_method_id = $row_payment_history['payment_method'];
                                                        	    $query_payment_method_finder = "SELECT * FROM wpk4_backend_accounts_bank_account where bank_id='$current_pay_method_id'";
                                                            	$result_payment_method_finder = mysqli_query($mysqli, $query_payment_method_finder);
                                                            	$row_payment_method_finder = mysqli_fetch_assoc($result_payment_method_finder);
                                                            	$row_payment_method_finder_count = mysqli_num_rows($result_payment_method_finder);
                                                            	$bank_account_type_name = '';
                                                            	if($row_payment_method_finder_count > 0)
                                                            	{
                                                            	    $bank_account_type_name = $row_payment_method_finder['account_name'];
                                                            	}
                                                                ?>
                                                                <tr>
                                                                    <td><?php echo date('d/m/Y H:i:s', strtotime($row_payment_history['process_date'])); ?></td>
                                                                    <td>
                                                                        <?php 
                                                                        if($row_payment_history['pay_type'] == 'deposit')
                                                                        {
                                                                            echo "Booking Deposit"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'balance' || $row_payment_history['pay_type'] == 'balance ' || $row_payment_history['pay_type'] == 'Balance')
                                                                        {
                                                                            echo "Booking Balance"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'deposit_adjustment')
                                                                        {
                                                                            echo "Booking Deposit Adjustment"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'dc_charge')
                                                                        {
                                                                            echo "Datechange"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'Datechange')
                                                                        {
                                                                            echo "Datechange"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'additional_payment')
                                                                        {
                                                                            echo "Additional Payment"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'other')
                                                                        {
                                                                            echo "Other"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'Refund')
                                                                        {
                                                                            echo "Refund"; 
                                                                        }
                                                                        else
                                                                        {
                                                                            echo "Unknown"; 
                                                                        }
                                                                        ?>
                                                                    </td>
                                                                    <td><?php echo $row_payment_history['trams_received_amount']; ?></td>
                                                                    <td><?php echo $row_payment_history['reference_no']; ?></td>
                                                                    <td><?php echo $row_payment_history['trams_remarks']; ?></td>
                                                                    <td><?php echo $bank_account_type_name; ?></td> 
                                                                    
                                                                </tr>
                                                                <?php
                                                            }
                                                    	}
                                                    	else
                                                		{
                                                		    echo '<td colspan="6">No record found</td>';
                                                		}
                                                	?>
                                                	</table>
                                                	<?php
                                                }
                                                else
                                                {
                                                    ?>
                                                    <h6>Booking Payment</h6>
                                                    <table class="table" style="font-size:13px;">
                                                        <tr>
                                                            <th>Payment Date</th><th>Type</th><th>Paid Amount</th><th>Reference No</th><th>Remark</th><th>Method</th>
                                                        </tr>
                                                        <?php
                                                        $payment_history_count = 0;
                                                        $query_payment_history = "SELECT * FROM wpk4_backend_travel_payment_history where order_id='$order_id_api' AND order_id != '' AND (pay_type IN ('deposit', 'balance', 'balance ', 'Balance', 'deposit_adjustment', 'Refund') OR pay_type IS NULL OR pay_type = '') order by process_date desc";
                                                    	$result_payment_history = mysqli_query($mysqli, $query_payment_history);
                                                    	if(mysqli_num_rows($result_payment_history) > 0)
                                                    	{
                                                        	while($row_payment_history = mysqli_fetch_assoc($result_payment_history))
                                                        	{
                                                        	    
                                                        	    $payment_identifier = $row_payment_history['process_date'].'^'.$row_payment_history['trams_received_amount'].'^'.$row_payment_history['reference_no']; // defined value to restric duplicate amount + ref no combination on G360
                                            					if (in_array($payment_identifier, $processedPayments)) 
                                            					{
                                            					   continue; // Skip to the next value
                                            					}
                                            							
                                            					$processedPayments[] = $payment_identifier;
                                            					
                                                        	    $current_pay_method_id = $row_payment_history['payment_method'];
                                                        	    $query_payment_method_finder = "SELECT * FROM wpk4_backend_accounts_bank_account where bank_id='$current_pay_method_id'";
                                                            	$result_payment_method_finder = mysqli_query($mysqli, $query_payment_method_finder);
                                                            	$row_payment_method_finder = mysqli_fetch_assoc($result_payment_method_finder);
                                                            	$row_payment_method_finder_count = mysqli_num_rows($result_payment_method_finder);
                                                            	$bank_account_type_name = '';
                                                            	if($row_payment_method_finder_count > 0)
                                                            	{
                                                            	    $bank_account_type_name = $row_payment_method_finder['account_name'];
                                                            	}
                                                        	    
                                                        	    $payment_history_count++;
                                                                ?>
                                                                <tr>
                                                                    <td><?php echo date('d/m/Y H:i:s', strtotime($row_payment_history['process_date'])); ?></td>
                                                                    <td>
                                                                        <?php 
                                                                        if($row_payment_history['pay_type'] == 'deposit')
                                                                        {
                                                                            echo "Booking Deposit"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'balance' || $row_payment_history['pay_type'] == 'balance ' || $row_payment_history['pay_type'] == 'Balance')
                                                                        {
                                                                            echo "Booking Balance"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'deposit_adjustment')
                                                                        {
                                                                            echo "Booking Deposit Adjustment"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'dc_charge')
                                                                        {
                                                                            echo "Datechange"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'Datechange')
                                                                        {
                                                                            echo "Datechange"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'additional_payment')
                                                                        {
                                                                            echo "Additional Payment"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'other')
                                                                        {
                                                                            echo "Other"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'Refund')
                                                                        {
                                                                            echo "Refund"; 
                                                                        }
                                                                        else
                                                                        {
                                                                            echo "Unknown"; 
                                                                        }
                                                                        ?>
                                                                    </td>
                                                                    <td><?php echo $row_payment_history['trams_received_amount']; ?></td>
                                                                    <td><?php echo $row_payment_history['reference_no']; ?></td>
                                                                    <td><?php echo $row_payment_history['trams_remarks']; ?></td>
                                                                    <td><?php echo $bank_account_type_name; ?></td> 
                                                                </tr>
                                                                <?php
                                                        	}
                                                    	}
                                                    	else
                                                		{
                                                		    echo '<td colspan="6">No record found</td>';
                                                		}
                                                    	?>
                                                    </table>
                                                    
                                                    <h6>Other Payment</h6>
                                                	<table class="table" style="font-size:13px;">
                                                        <tr>
                                                            <th>Payment Date</th><th>Type</th><th>Paid Amount</th><th>Reference No</th><th>Remark</th><th>Method</th>
                                                        </tr>
                                                    	<?php
                                                        $query_payment_history = "SELECT * FROM wpk4_backend_travel_payment_history where order_id='$order_id_api' AND order_id != '' AND pay_type IN ('dc_charge', 'Datechange', 'additional_payment', 'other') order by process_date desc";
                                                    	$result_payment_history = mysqli_query($mysqli, $query_payment_history);
                                                    	if(mysqli_num_rows($result_payment_history) > 0)
                                                    	{
                                                        	while($row_payment_history = mysqli_fetch_assoc($result_payment_history))
                                                        	{
                                                        	    
                                                        	    $payment_identifier = $row_payment_history['process_date'].'^'.$row_payment_history['trams_received_amount'].'^'.$row_payment_history['reference_no']; // defined value to restric duplicate amount + ref no combination on G360
                                            					if (in_array($payment_identifier, $processedPayments)) 
                                            					{
                                            					   continue; // Skip to the next value
                                            					}
                                            							
                                            					$processedPayments[] = $payment_identifier;
                                            					
                                                        	    $current_pay_method_id = $row_payment_history['payment_method'];
                                                        	    $query_payment_method_finder = "SELECT * FROM wpk4_backend_accounts_bank_account where bank_id='$current_pay_method_id'";
                                                            	$result_payment_method_finder = mysqli_query($mysqli, $query_payment_method_finder);
                                                            	$row_payment_method_finder = mysqli_fetch_assoc($result_payment_method_finder);
                                                            	$row_payment_method_finder_count = mysqli_num_rows($result_payment_method_finder);
                                                            	$bank_account_type_name = '';
                                                            	if($row_payment_method_finder_count > 0)
                                                            	{
                                                            	    $bank_account_type_name = $row_payment_method_finder['account_name'];
                                                            	}
                                                        	    
                                                                ?>
                                                                <tr>
                                                                    <td><?php echo date('d/m/Y H:i:s', strtotime($row_payment_history['process_date'])); ?></td>
                                                                    <td>
                                                                        <?php 
                                                                        if($row_payment_history['pay_type'] == 'deposit')
                                                                        {
                                                                            echo "Booking Deposit"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'balance' || $row_payment_history['pay_type'] == 'balance ' || $row_payment_history['pay_type'] == 'Balance')
                                                                        {
                                                                            echo "Booking Balance"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'deposit_adjustment')
                                                                        {
                                                                            echo "Booking Deposit Adjustment"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'dc_charge')
                                                                        {
                                                                            echo "Datechange"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'Datechange')
                                                                        {
                                                                            echo "Datechange"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'additional_payment')
                                                                        {
                                                                            echo "Additional Payment"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'other')
                                                                        {
                                                                            echo "Other"; 
                                                                        }
                                                                        else if($row_payment_history['pay_type'] == 'Refund')
                                                                        {
                                                                            echo "Refund"; 
                                                                        }
                                                                        else
                                                                        {
                                                                            echo "Unknown"; 
                                                                        }
                                                                        ?>
                                                                    </td>
                                                                    <td><?php echo $row_payment_history['trams_received_amount']; ?></td>
                                                                    <td><?php echo $row_payment_history['reference_no']; ?></td>
                                                                    <td><?php echo $row_payment_history['trams_remarks']; ?></td>
                                                                    <td><?php echo $bank_account_type_name; ?></td> 
                                                                    
                                                                </tr>
                                                                <?php
                                                        	}
                                                    	}
                                                    	else
                                                		{
                                                		    echo '<td colspan="6">No record found</td>';
                                                		}
                                                    	?>
                                                	</table>
                                                    <?php
                                                }
                                            	
                                            	
                                            
                                            	?>
                                           
                                    		    <h6>Attachments</h6>
                                    		    <?php
                                    		    $query_all_refunds_latest_chat = "SELECT * FROM wpk4_backend_travel_booking_update_history where order_id = '$order_id_api' && co_order_id = '$co_order_id_api' && merging_id = '$product_id_api' && meta_key like 'G360Events' && meta_value like 'g360paymentattachments' order by auto_id desc";
                                        		$result_all_refunds_latest_chat = mysqli_query($mysqli, $query_all_refunds_latest_chat);
                                        		$row_all_refunds_latest_chat_count = mysqli_num_rows($result_all_refunds_latest_chat);
                                        		if($row_all_refunds_latest_chat_count > 0)
                                        		{
                                        		    ?>
                                        		    <table style="font-size:13px;">
                                    		        <tr><td width="70%">Attachment</td><td>Date uploaded</td></tr>
                                    		        <?php
                                            		while($row_all_refunds_latest_chat = mysqli_fetch_assoc($result_all_refunds_latest_chat))
                                            		{
                                            		    $payment_file_extension = pathinfo($row_all_refunds_latest_chat['meta_key_data'], PATHINFO_EXTENSION);
                                            		    if($payment_file_extension == 'pdf' || $payment_file_extension == 'txt')
                                            		    {
                                            		        echo '<tr><td><a target="_blank" href="https://gauratravel.com.au/wp-content/uploads/customized_function_uploads/'.$row_all_refunds_latest_chat['meta_key_data'].'">'.$row_all_refunds_latest_chat['meta_key_data'].'</a></td><td>'.$row_all_refunds_latest_chat['updated_time'].'</td></tr>';
                                            		    }
                                            		    else
                                            		    {
                                            		        echo '<tr><td><a target="_blank" href="https://gauratravel.com.au/wp-content/uploads/customized_function_uploads/'.$row_all_refunds_latest_chat['meta_key_data'].'"><img src="https://gauratravel.com.au/wp-content/uploads/customized_function_uploads/'.$row_all_refunds_latest_chat['meta_key_data'].'" style="width:200px;"></a></td><td>'.$row_all_refunds_latest_chat['updated_time'].'</td></tr>';
                                            		    }
                                            		}
                                            		?>
                                            		</table>
                                            		<?php
                                        		}
                                        		else
                                        		{
                                        		    echo 'No attachment found';
                                        		}
                                        		echo '</br></br>';
                                        		?>
                                        		
                        				</div>
                        				
                        				
                				<div id="portal_request_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>" class="tabcontent" style="display:none;">
                                        <?php
                                        $order_id = $order_id_api;
                                        
                                        $array_pax_pnr = array();
                                        $query_summary_loop_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id'";
                                		$result_loop_pax = mysqli_query($mysqli, $query_summary_loop_pax) or die(mysqli_error($mysqli));
                                    	while($row_loop_pax = mysqli_fetch_assoc($result_loop_pax))
                                    	{
                                    	    $array_pax_pnr[] = $row_loop_pax['pnr'];
                                    	}
                                    	$array_pax_pnr = array_unique($array_pax_pnr);		        
                                    	$array_pax_pnr_separated = implode(", ", $array_pax_pnr);

                                        $query_task_history = "SELECT * FROM wpk4_backend_user_portal_requests where reservation_ref != '' AND (reservation_ref='$order_id_api' OR reservation_ref IN ('$array_pax_pnr_separated'))";
                                    	$result_task_history = mysqli_query($mysqli, $query_task_history) or die(mysqli_error($mysqli));
                        				$count_task_history_userportal = mysqli_num_rows($result_task_history);
                        				
                        				if($count_task_history_userportal > 0)
                        				{
                        					?>
                        					<h5>Portal Requests <span class="badge badge-primary"><?php echo $count_task_history_userportal; ?></span></h5>
                        					<table class='table' style="font-size:13px;">
                        						<tr><th>CaseID</th><th>Task Type</th><th>Initiated on</th><th>Status</th></tr>
                        						<?php
                        						while($row_task_history_user = mysqli_fetch_assoc($result_task_history))
                        						{
                        							//$task_order_id = $row_task_history_user['order_id'];
                        							$task_case_type = $row_task_history_user['case_type'];
                        							$case_date = $row_task_history_user['case_date'];
                        								$case_id = $row_task_history_user['case_id'];
                        							$gstatus = $row_task_history_user['status'];

                            						    ?>
                            						    <tr><td><?php echo $case_id; ?></td><td><?php echo $task_case_type; ?></td><td><?php echo $case_date; ?></td><td><?php echo $gstatus; ?></td></tr>
                            						    <?php
                            						  
                        						}
                        						?>
                        					</table>
                        					<?php
                        				}
                        				else
                        				{
                        				    
                        					echo '<h5>Customer Portal Requests</h5>
                        					    No task created';
                        				}
                                    ?>
                				</div>
                				
                                <div id="emails_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>" class="tabcontent" style="display:none;">
                				    <?php
                				    $filePath = '';
                				    $order_id = $order_id_api;
                                		$query_select_order_email = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' order by auto_id limit 1";
                                		$result_select_order_email = mysqli_query($mysqli, $query_select_order_email);
                                		$row_select_order_email = mysqli_fetch_assoc($result_select_order_email);
                                		$customer_email = $row_select_order_email['email_pax'];
                                		
                                		$query_select_order_status = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api'";
                                		$result_select_order_status = mysqli_query($mysqli, $query_select_order_status);
                                		$row_select_order_status = mysqli_fetch_assoc($result_select_order_status);
                                		$order_payment_status = $row_select_order_status['payment_status'];
                                		
                                		$query_count_bookingemail = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='Booking Email' order by auto_id desc limit 1";
                                		$result_count_bookingemail = mysqli_query($mysqli, $query_count_bookingemail);
                                		$row_count_bookingemail = mysqli_num_rows($result_count_bookingemail);
                                		$row_bookingemail = mysqli_fetch_assoc($result_count_bookingemail);
                                		if($row_count_bookingemail==0)
                                		{
                                			$is_bookingemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_bookingemail_sent[]" value="'.$order_id_api.'">';
                                			$bookingemail_sent_on = '';
                                		}
                                		else
                                		{
                                			$is_bookingemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_bookingemail_sent[]" value="'.$order_id_api.'">';
                                			$bookingemail_sent_on = ' on '.$row_bookingemail['initiated_date'];
                                		}
                                		
                                		
                                		
                                		
                                		$query_count_mhpplemail = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='MH PPL Voucher' order by auto_id desc limit 1";
                                		$result_count_mhpplemail = mysqli_query($mysqli, $query_count_mhpplemail);
                                		$row_count_mhpplemail = mysqli_num_rows($result_count_mhpplemail);
                                		$row_mhpplemail = mysqli_fetch_assoc($result_count_mhpplemail);
                                		if($row_count_mhpplemail==0)
                                		{
                                			$is_mhpplemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_itineraryemail_sent[]" value="'.$order_id_api.'">';
                                			$mhppl_sent_on = '';
                                		}
                                		else
                                		{
                                			$is_mhpplemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_itineraryemail_sent[]" value="'.$order_id.'">';
                                			$mhppl_sent_on = ' on '.$row_mhpplemail['initiated_date'];
                                		}
                                		
                                		
                                		
                                		$query_count_itineraryemail = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='Itinerary Email' order by auto_id desc limit 1";
                                		$result_count_itineraryemail = mysqli_query($mysqli, $query_count_itineraryemail);
                                		$row_count_itineraryemail = mysqli_num_rows($result_count_itineraryemail);
                                		$row_itineraryemail = mysqli_fetch_assoc($result_count_itineraryemail);
                                		if($row_count_itineraryemail==0)
                                		{
                                			$is_itineraryemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_itineraryemail_sent[]" value="'.$order_id_api.'">';
                                			$itineraryemail_sent_on = '';
                                		}
                                		else
                                		{
                                			$is_itineraryemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_itineraryemail_sent[]" value="'.$order_id.'">';
                                			$itineraryemail_sent_on = ' on '.$row_itineraryemail['initiated_date'];
                                		}	
                                		
                                		$query_count_taxinvoice = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='Tax Invoice' order by auto_id desc limit 1";
                                		$result_count_taxinvoice = mysqli_query($mysqli, $query_count_taxinvoice);
                                		$row_count_taxinvoice = mysqli_num_rows($result_count_taxinvoice);
                                		$row_taxinvoice = mysqli_fetch_assoc($result_count_taxinvoice);
                                		if($row_count_taxinvoice==0)
                                		{
                                			$is_tax_invoice_sent = '<input type="checkbox" onclick="return false;" id="inv" name="is_tax_invoice_sent[]" value="'.$order_id_api.'">'; $tax_invoice_sent_on = '';
                                		}
                                		else
                                		{
                                			$is_tax_invoice_sent = '<input type="checkbox" checked onclick="return false;" id="inv" name="is_tax_invoice_sent[]" value="'.$order_id_api.'">'; 
                                			$tax_invoice_sent_on = ' on '.$row_taxinvoice['initiated_date'];
                                		}
                                		
                                		$query_count_payment_update = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='Payment Update' order by auto_id desc limit 1";
                                		$result_count_payment_update = mysqli_query($mysqli, $query_count_payment_update);
                                		$row_count_payment_update = mysqli_num_rows($result_count_payment_update);
                                		$row_paymentupdate = mysqli_fetch_assoc($result_count_payment_update);
                                		if($row_count_payment_update==0)
                                		{
                                			$is_payment_update_sent = '<input type="checkbox" onclick="return false;" id="pay" name="is_payment_update_sent[]" value="'.$order_id_api.'">'; $payment_update_sent_on = '';
                                		}
                                		else
                                		{
                                			$is_payment_update_sent = '<input type="checkbox" checked onclick="return false;" id="pay" name="is_payment_update_sent[]" value="'.$order_id_api.'">'; 
                                			$payment_update_sent_on = ' on '.$row_paymentupdate['initiated_date'];
                                		}
                                		
                                		$query_count_eticket_update = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='Eticket Email' order by auto_id desc limit 1";
                                		$result_count_eticket_update = mysqli_query($mysqli, $query_count_eticket_update);
                                		$row_count_eticket_update = mysqli_num_rows($result_count_eticket_update);
                                		$row_eticketupdate = mysqli_fetch_assoc($result_count_eticket_update);
                                		if($row_count_eticket_update==0)
                                		{
                                			$is_eticket_update_sent = '<input type="checkbox" onclick="return false;" id="pay" name="is_payment_update_sent[]" value="'.$order_id_api.'">'; $eticket_update_sent_on = '';
                                		}
                                		else
                                		{
                                			$is_eticket_update_sent = '<input type="checkbox" checked onclick="return false;" id="pay" name="is_payment_update_sent[]" value="'.$order_id_api.'">'; 
                                			$eticket_update_sent_on = ' on '.$row_eticketupdate['initiated_date'];
                                		}
                                		?>
                                			<table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
                                				<tr>
                                					<td>Itinerary Email</td>
                                					<td>
                                					    <!--<form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                    						<input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='sent_itinerary_email' value='Sent Itinerary Email'>
                                    					</form>-->
                                    					<form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                    						<input type='submit' style='padding:15px; margin:0;font-size:11px; cursor: not-allowed;' disabled value='Download Itinerary'>
                                    					</form>
                                					</td>
                                					<td>
                                						<button id="toggleButton_email_itinerary_<?php echo $order_id_api; ?>" style='background-color:#ffbb00; padding:15px; margin:0;font-size:11px; '>Show Preview</button>
                                					</td>
                                				</tr>
                                				
                                    			<?php
                                    			
                                    			$query_pax_eticket_loop = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' && product_id='$product_id_api'";
                                        		$result_pax_eticket_loop = mysqli_query($mysqli, $query_pax_eticket_loop);
                                        		$row_pax_eticket_loop_count = mysqli_num_rows($result_pax_eticket_loop);
                                    			?>
                                    			<tr>
                                    				<td rowspan = '<?php echo $row_pax_eticket_loop_count; ?>'>Eticket Email</td>
                                    				<?php
                                    				$loop_count_pax = 0;
                                    				while($row_pax_eticket_loop = mysqli_fetch_assoc($result_pax_eticket_loop))
                                        		    {
                                        		        $loop_count_pax ++;
                                        		        $pax_id = $row_pax_eticket_loop['auto_id'];
                                        		        ?>
                                        				<td>
                                        					<?php
                                            				if($loop_count_pax == 1)
                                            				{
                                            				?>
                                                				<form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                            						<input type='submit' style='padding:15px; margin:0;font-size:11px;cursor: not-allowed;' disabled value='Sent Eticket Email'>
                                            			        </form>
                                            				<?php
                                            				}
                                            				?>
                                        				</td>
                                        				
                                        				<td><button id="toggleButton_email_eticket_<?php echo $order_id_api; ?><?php echo $pax_id; ?>" style='background-color:#ffbb00; padding:15px; margin:0;font-size:11px; '>Show Preview</button></td>
                                    				    <?php
                                    				    echo '</tr>';
            		                                    }
            		                                ?>
                                    			</tr>
                                    			
                                    			
				                                
                                			</table>
                                            <?php
                                			$today_date = date("Y-m-d H:i:s");
                                			?>
                                			

                                    		<div id="email_itineraryPreview_<?php echo $order_id_api; ?>" style="display: none;">
                                                <?php
                                    			$emailsubject = "Itinerary Information - ".$order_id_api;
                                                if($order_type_itinerary == 'WPT' || $order_type_itinerary == '')
        				                        {
                                    			    include(get_template_directory().'/templates/email/tpl_email_itinerary_preview.php');
        				                        }
        				                        else if($order_type_itinerary == 'gds')
        				                        {
                                    			    include(get_template_directory().'/templates/email/tpl_email_itinerary_preview_gds.php');
        				                        }
        				                        else
        				                        {
        				                            echo 'No system email found';
        				                        }    
                                    			
                                                ?>
                                            </div>
                                            
                                            
                                            
                                            <?php
                                    		$query_pax_eticket_loop = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api'";
                                        	$result_pax_eticket_loop = mysqli_query($mysqli, $query_pax_eticket_loop);
                                        	$row_pax_eticket_loop_count = mysqli_num_rows($result_pax_eticket_loop);
                                    		while($row_pax_eticket_loop = mysqli_fetch_assoc($result_pax_eticket_loop))
            		                        {
            		                            $pax_id = $row_pax_eticket_loop['auto_id'];
            		                            ?>
            		                            <div id="email_eticketPreview_<?php echo $order_id_api; ?><?php echo $pax_id; ?>" style="display: none;">
                                                    <?php
                                            		$emailsubject = "Eticket Information - ".$order_id_api;
                                                    include(get_template_directory().'/templates/email/tpl_email_eticket_preview.php');
                                                    ?>
                                                </div>
            		                            <?php
            		                        }
            		                        ?>
                                            <?php
                                    		$query_pax_eticket_loop = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api'";
                                        	$result_pax_eticket_loop = mysqli_query($mysqli, $query_pax_eticket_loop);
                                        	$row_pax_eticket_loop_count = mysqli_num_rows($result_pax_eticket_loop);
                                    		while($row_pax_eticket_loop = mysqli_fetch_assoc($result_pax_eticket_loop))
            		                        {
            		                            $pax_id = $row_pax_eticket_loop['auto_id'];
            		                            ?>
            		                            <script>
            		                                document.getElementById("toggleButton_email_eticket_<?php echo $order_id_api; ?><?php echo $pax_id; ?>").addEventListener("click", function() {
                                                      var myDiv_payment = document.getElementById("email_eticketPreview_<?php echo $order_id_api; ?><?php echo $pax_id; ?>");
                                                      if (myDiv_payment.style.display === "none") {
                                                        myDiv_payment.style.display = "block";
                                                        this.textContent = "Hide Preview";
                                                      } else {
                                                        myDiv_payment.style.display = "none";
                                                        this.textContent = "Show Preview";
                                                      }
                                                    });
            		                            </script>
            		                            <?php
            		                        }
            		                        ?>    
            		                            
                                            
                                            
                                    		<script>
                                    		    document.getElementById("toggleButton_email_itinerary_<?php echo $order_id_api; ?>").addEventListener("click", function() {
                                                  var myDiv_itinerary = document.getElementById("email_itineraryPreview_<?php echo $order_id_api; ?>");
                                                  if (myDiv_itinerary.style.display === "none") {
                                                    myDiv_itinerary.style.display = "block";
                                                    this.textContent = "Hide Preview";
                                                  } else {
                                                    myDiv_itinerary.style.display = "none";
                                                    this.textContent = "Show Preview";
                                                  }
                                                });
                                                
                                                document.getElementById("toggleButton_email_payment_<?php echo $order_id_api; ?>").addEventListener("click", function() {
                                                  var myDiv_payment = document.getElementById("email_paymentPreview_<?php echo $order_id_api; ?>");
                                                  if (myDiv_payment.style.display === "none") {
                                                    myDiv_payment.style.display = "block";
                                                    this.textContent = "Hide Preview";
                                                  } else {
                                                    myDiv_payment.style.display = "none";
                                                    this.textContent = "Show Preview";
                                                  }
                                                });
                                                
                                                
                                                
                                                

                                              function confirmSubmit() {
                                                var confirmed = confirm("Do you want to submit the form?");
                                                return confirmed;
                                              }
                                            </script>
                                    		<?php
                                    		$themepath = get_stylesheet_directory_uri();
                                            $themepath = str_replace("https://gauratravel.com.au/","",$themepath);
                                            
                                            if(isset($_POST['sent_itinerary_email']))
                                    		{
                                    			$today_date = date("Y-m-d H:i:s");
                                    			
                                    			if($order_type_itinerary == 'WPT' || $order_type_itinerary == '')
        				                        {
        				                            $emailsubject = "Itinerary Information - ".$order_id_api;
                                    			    include(get_template_directory().'/templates/email/tpl_email_itinerary.php');
        				                        }
        				                        else if($order_type_itinerary == 'gds')
        				                        {
        				                            $query_pax_lead_traveller = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' order by auto_id asc limit 1";
                                            		$result_pax_lead_traveller = mysqli_query($mysqli, $query_pax_lead_traveller);
                                            		$row_pax_lead_traveller = mysqli_fetch_assoc($result_pax_lead_traveller);
                                                        $pnr_for_email = $row_pax_lead_traveller['pnr'];
            
        				                            $emailsubject = "Itinerary Information - ".$pnr_for_email;
                                    			    include(get_template_directory().'/templates/email/tpl_email_itinerary_gds.php');
        				                        }
        				                        else
        				                        {
        				                            echo 'No system email found';
        				                        }
        				                        
                                    			global $wpdb;
                                    			$email_subject = 'Itinerary Information';
                                    			$wpdb->insert('wpk4_backend_order_email_history', array(
                                                    'email_type' =>'Itinerary Email',
                                                    'order_id' =>$order_id_api,
                                                    'email_address' => $customer_email,
                                                    'initiated_date' => $today_date,
                                    				'initiated_by' => 'customer',
                                                    'email_subject' => $email_subject,
                                                ));
                                                $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                    			echo '<script>window.location.href="'.$current_url.'";</script>';
                                    		}
                                            
                                            
                                    		if(isset($_POST['download_itinerary_email']))
                                    		{
                                    			$today_date = date("Y-m-d H:i:s");
                                    			
                                    			if($order_type_itinerary == 'WPT' || $order_type_itinerary == '')
        				                        {
        				                            $emailsubject = "Itinerary Information - ".$order_id_api;
                                    			    include(get_template_directory().'/templates/email/tpl_download_itinerary.php');
        				                        }
        				                        else if($order_type_itinerary == 'gds')
        				                        {
        				                            $query_pax_lead_traveller = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' order by auto_id asc limit 1";
                                            		$result_pax_lead_traveller = mysqli_query($mysqli, $query_pax_lead_traveller);
                                            		$row_pax_lead_traveller = mysqli_fetch_assoc($result_pax_lead_traveller);
                                                        $pnr_for_email = $row_pax_lead_traveller['pnr'];
            
        				                            $emailsubject = "Itinerary Information - ".$pnr_for_email;
                                    			    include(get_template_directory().'/templates/email/tpl_download_itinerary_gds.php');
        				                        }
        				                        else
        				                        {
        				                            echo 'No itinerary found';
        				                        }
        				                        
                                    			global $wpdb;
                                    			$email_subject = 'Itinerary Information';
                                    			$wpdb->insert('wpk4_backend_order_email_history', array(
                                                    'email_type' =>'Itinerary Email',
                                                    'order_id' =>$order_id_api,
                                                    'email_address' => $customer_email,
                                                    'initiated_date' => $today_date,
                                    				'initiated_by' => 'customer',
                                                    'email_subject' => $email_subject,
                                                ));
                                                $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                    			//echo '<script>window.location.href="'.$current_url.'";</script>';
                                    		}
                                    		
                                    		
                                    		if(isset($_POST['sent_bulk_eticket_email']))
                                    		{
                                    			$today_date = date("Y-m-d H:i:s");
                                    			
                                    			$product_id_for_limit_loop = $product_id_api;
                                    			$order_id = $order_id_api;
                                    			include(get_template_directory().'/templates/email/tpl_download_eticket_bulk.php');
                                    			global $wpdb;
                                    			$wpdb->insert('wpk4_backend_order_email_history', array(
                                                    'email_type' =>'Eticket Email',
                                                    'order_id' =>$order_id,
                                                    'email_address' => $customer_email,
                                                    'initiated_date' => $today_date,
                                    				'initiated_by' => 'customer',
                                                    'email_subject' => $email_subject,
                                                ));
                                    			echo '<script>window.location.href="'.$defaultlink_gaura.'";</script>';
                                    			
                                    		}
                                    		
                                    		
                                    		
        				            
        				            ?>
                				</div>
                				
    		    				<div id="itinerary_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>" class="tabcontent" style="display:none;">
        				            <?php
        				            $order_id = $order_id_api;
        				            if($order_type_itinerary == 'WPT' || $order_type_itinerary == '' || $order_type_itinerary == 'Agent')
        				            {
										
        				                echo '<h5>Current Itinerary</h5>';
        				                
        				                $order_id_for_itinerary = $order_id_api;
                    				    $query_order_booking_info_itinerary = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_for_itinerary' AND co_order_id='$co_order_id_api' order by travel_date asc";
                                		$result_order_booking_info_itinerary = mysqli_query($mysqli, $query_order_booking_info_itinerary) or die(mysqli_error($mysqli));
                                		while($row_order_booking_info_itinerary = mysqli_fetch_assoc($result_order_booking_info_itinerary))
                                		{
                                			$traveldate_fxed = $row_order_booking_info_itinerary['travel_date'];
                                			$product_title = $row_order_booking_info_itinerary['product_title'];
                                			$trip_code = $row_order_booking_info_itinerary['trip_code'];
                                			$product_id_itinerary = $row_order_booking_info_itinerary['product_id'];
                                			$new_product_id_itinerary = $row_order_booking_info_itinerary['new_product_id'];
                                			
                                			if($new_product_id_itinerary == '' || $new_product_id_itinerary == NULL )
                                			{
                                			    $wptravel_itineraries_r = get_post_meta( $product_id_itinerary, 'wp_travel_trip_itinerary_data', true );
                                    			$trip_wp_title = get_post_field( 'post_title', $product_id_itinerary );
                                    			$wptravel_travel_outline = get_post_meta( $product_id_itinerary, 'wp_travel_outline', true );
                                    			$productid_for_wptravel_product = $product_id_itinerary;
                                			}
                                			else
                                			{
                                			    $wptravel_itineraries_r = get_post_meta( $new_product_id_itinerary, 'wp_travel_trip_itinerary_data', true );
                                    			$trip_wp_title = get_post_field( 'post_title', $new_product_id_itinerary );
                                    			$wptravel_travel_outline = get_post_meta( $new_product_id_itinerary, 'wp_travel_outline', true );
                                    			$productid_for_wptravel_product = $new_product_id_itinerary;
                                			}
			
                                			


                                			if ( isset( $wptravel_itineraries_r ) && ! empty( $wptravel_itineraries_r ) ) : 
                                				$wptravel_index = 1;
                                				$itinerary_location_array = array();
                                				$itinerary_time_array = array();
                                				$itinerary_flight_array = array();
                                				$itinerary_date_array = array();
                                				$itinerary_datedecider_array = array();
                                				$itinerary_array_counter = 0;
                                				$itinerary_counter=0;	
                                				foreach ( $wptravel_itineraries_r as $wptravel_itinerary ) : 
                                					$wptravel_time_format = get_option( 'time_format' );
                                					$wptravel_itinerary_label = '';
                                					$wptravel_itinerary_title = '';
                                					$wptravel_itinerary_desc  = '';
                                					$wptravel_itinerary_date  = '';
                                					$wptravel_itinerary_time  = '';
                                					$itinerary_counter = 1;
                                					$is_itinerary_available = 1;
                                						$wptravel_itinerary_label = stripslashes( $wptravel_itinerary['label'] );
                                					
                                						$wptravel_itinerary_title = stripslashes( $wptravel_itinerary['title'] );
                                					
                                						$wptravel_itinerary_desc = stripslashes( $wptravel_itinerary['desc'] );
                                					
                                						$wptravel_itinerary_date = wptravel_format_date( $wptravel_itinerary['date'] );
                                					
                                						$wptravel_itinerary_time = stripslashes( $wptravel_itinerary['time'] );
                                						$wptravel_itinerary_time = date( $wptravel_time_format, strtotime( $wptravel_itinerary_time ) ); 
                                				    $itinerary_location_array[$itinerary_array_counter] = $wptravel_itinerary_label; // destination
                                					$itinerary_time_array[$itinerary_array_counter] = $wptravel_itinerary_time; // flight time
                                					$itinerary_flight_array[$itinerary_array_counter] = $wptravel_itinerary_title; // flight number
                                					$itinerary_date_array[$itinerary_array_counter] = $traveldate_fxed; // flight date
                                					$itinerary_datedecider_array[$itinerary_array_counter] = strip_tags($wptravel_itinerary_desc); // arrival or departure define
                                							
                                					$wptravel_index++;
                                					$itinerary_array_counter++;
                                					
                                				endforeach;
                                			endif; 
                                			// DEFINE EXTRA DAYS
                                            $itinerary_vals = '';
                                			$departure_date_plus_one = date("d/m/Y", strtotime("1 day", strtotime($traveldate_fxed))); 
                                			$departure_date_plus_two = date("d/m/Y", strtotime("2 day", strtotime($traveldate_fxed)));
                                			$departure_date_plus_three = date("d/m/Y", strtotime("3 day", strtotime($traveldate_fxed)));
                                			$departure_date_plus_four = date("d/m/Y", strtotime("4 day", strtotime($traveldate_fxed)));
                                			$length_aray = 0;
                                            if ( isset($itinerary_location_array) && is_array( $itinerary_location_array ) ) {
                                			$length_aray = count($itinerary_location_array);
                                			$itinerary_vals .= '<center><table class="m_-8969220568537220410 tripitinerary wp-travel-table-content trip_'.$product_id_itinerary.'" cellpadding="0" cellspacing="0" style="width:100%; text-align:left; border: 1px solid #e1e1e; border-collapse: collapse; margin:10px 0px 10px 0px; font-size:14px;">
                                			<thead>
                                			  <tr style="background: #f0f0f0; border:none;">
                                				 <th style="width:20%">From</th>
                                				 <th style="width:20%">To</th>
                                				 <th style="width:20%">Flight</th>
                                				 <th style="width:20%">Departure</th>
                                				 <th style="width:20%">Arrival</th>
                                			  </tr>
                                			</thead>
                                			<tbody>';
                                                    }
                                                    else {
                                            // Handle the case when $itinerary_location_array is null
                                            $itinerary_vals .= '<p>No itinerary locations found.</p>';
                                            }
                                			// SECTION TO DIVIDE WAITING, SELF TRANSFER AND FLIGHT INFO
                                			$is_printed_destination = '';
                                			for ($i = 0; $i < $length_aray; $i++) {
                                				if($itinerary_location_array[$i] == 'WAIT')
                                				{
                                					//$itinerary_vals .= "<tr>";
                                					//$itinerary_vals .= '<td colspan="5" style="width:30%">'.$itinerary_location_array[$i].' - '.$itinerary_flight_array[$i].'</td>';
                                					//$itinerary_vals .= "</tr>"; 
                                					
                                					$is_printed_destination = '';
                                				}
                                				else if($itinerary_location_array[$i] == 'SELF-TRANSFER')
                                				{
                                					//$itinerary_vals .= "<tr>";
                                					//$itinerary_vals .= '<td colspan="5" style="width:30%">'.$itinerary_datedecider_array[$i].' - '.$itinerary_flight_array[$i].'</td>';
                                					//$itinerary_vals .= "</tr>"; 
                                					
                                					$is_printed_destination = '';
                                				}
                                				else
                                				{
                                					if ($is_printed_destination == '') 
                            			            {
                            			                 
                            			                $date1 = date("Y-m-d", strtotime($itinerary_datedecider_array[$i]))." ".date("H:i:s", strtotime($itinerary_time_array[$i]));
                            			                if(isset($itinerary_datedecider_array[$i+1]) && isset($itinerary_time_array[$i+1]))
                            			                {
                                                            $date2 = date("Y-m-d", strtotime($itinerary_datedecider_array[$i+1]))." ".date("H:i:s", strtotime($itinerary_time_array[$i+1]));
                                                            $dateDiff = intval((strtotime($date2) - strtotime($date1)) / 60);
                            			                }
                            			                else
                            			                {
                            			                    $dateDiff = intval((strtotime($date1) - strtotime($date1)) / 60);
                            			                }
                                                        
                                                        $hours = intval($dateDiff / 60); 
                                                        $minutes = $dateDiff % 60;
                                                        
                                                        $time_duration = $hours.":".$minutes;
                                                        $airline_from_itinerary = substr($itinerary_flight_array[$i],0,2);
                                            
                                    					$itinerary_vals .= "<tr>";
                                    					$itinerary_vals .= '<td style="width:20%">'.$itinerary_location_array[$i].'</td>';
                                    					if(isset($itinerary_location_array[$i+1])) { 
                                    					    $itinerary_vals .= '<td style="width:20%">'.$itinerary_location_array[$i+1].'</td>';
                                    					}
                                    					$itinerary_vals .= '<td style="width:20%">'.$itinerary_flight_array[$i].'</td>';
                                    					$itinerary_vals .= '<td style="width:20%">'.$itinerary_time_array[$i].'</br>'.$itinerary_datedecider_array[$i].'</td>';
                                    					if(isset($itinerary_time_array[$i+1]) && isset($itinerary_datedecider_array[$i+1])) { 
                                    					    $itinerary_vals .= '<td style="width:20%">'.$itinerary_time_array[$i+1].'</br>'.$itinerary_datedecider_array[$i+1].'</td>';
                                    					}
                                    					$itinerary_vals .= "</tr>";
                                    					$empty = '';
                                    					$itinerary_vals .= "<tr style='border:none;'>";
                                    					$itinerary_vals .= '<td colspan="2" style="border:none;">   Class: Economy
                                    					           </td>';
                                    					$itinerary_vals .= '<td colspan="2" style="border:none;">Operated by: '.$airline_from_itinerary.'</td>';
                                    					$itinerary_vals .= '<td style="border:none;">Duration: </td>';
                                    					$itinerary_vals .= "</tr>";
                                    					
                                    					$is_printed_destination = 'yes';
                            			            }
                            			            else
                            			            {
                            			                $is_printed_destination = '';
                            			            }
                                				}
                                			}
                                    		$itinerary_vals .= "</tbody></table></center></br></br>";
                                    		
                                    		$wptravel_travel_outline = get_post_meta( $productid_for_wptravel_product, 'wp_travel_outline', true );
                                            $pattern_to_remove_itinerary_table = '/<table class="tg">(.*?)<\/table>/s';
                                            $wptravel_travel_outline = preg_replace($pattern_to_remove_itinerary_table, '', $wptravel_travel_outline);
                                    		$itinerary_vals .= $wptravel_travel_outline;
                                    		
                                    		// REPLACE ALL THE FIXED WORDS AS DEPARTURE AND ARRIVAL ON BACKEND
                                    		$itinerary_vals = str_replace("Departure Date", '' ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Arrival Date", '' ,$itinerary_vals);
                                    		
                                    		$itinerary_vals = str_replace("Selected Date +4", $departure_date_plus_four ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Selected Date+4", $departure_date_plus_four ,$itinerary_vals);
                                    		
                                    		$itinerary_vals = str_replace("Selected Date +3", $departure_date_plus_three ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Selected Date+3", $departure_date_plus_three ,$itinerary_vals);
                                    		
                                    		$itinerary_vals = str_replace("Selected Date +2", $departure_date_plus_two ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Selected Date+2", $departure_date_plus_two ,$itinerary_vals);
                                    		
                                    		$itinerary_vals = str_replace("Selected Date+1", $departure_date_plus_one ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Selected Date +1", $departure_date_plus_one ,$itinerary_vals);
                                    		
                                    		$traveldate_fxed_1 = date("d/m/Y", strtotime($traveldate_fxed)); 
                                			$dep_date_ymd = date("Y-m-d", strtotime($traveldate_fxed)); 
                                			
                                    		$itinerary_vals = str_replace("Selected Date", $traveldate_fxed_1 ,$itinerary_vals);
                                			
                                			
                                    		$itinerary_vals = str_replace("Selected Date", $traveldate_fxed_1 ,$itinerary_vals);
                                    		
                                    		
                                    		$trip_code_post = get_post_meta($productid_for_wptravel_product, 'wp_travel_trip_code', true);
	                                        $itinerary_details = getGDealFlightItinerary($trip_code_post, $dep_date_ymd);
	                                        if($itinerary_details != '')
	                                        {
	                                            echo $itinerary_details;
	                                            echo $wptravel_travel_outline;
	                                        }
	                                        else
	                                        {
	                                           echo $itinerary_vals; 
	                                        }
	                                        

                                    		$wptravel_product_information_ordered = get_post_meta( $order_id_for_itinerary, 'order_items_data', true ); // get order product info for trip extras
                                            if (is_array($wptravel_product_information_ordered) || is_object($wptravel_product_information_ordered)) 
                                            {
                                                foreach ($wptravel_product_information_ordered as $key => $value) {
                                                    // Check if the 'trip_extras' key and 'id' key exist
                                                    if (isset($value['trip_extras']['id'])) {
                                                        // Extract "trip_extras" IDs
                                                        $tripExtrasIds = $value['trip_extras']['id'];
                                                        echo '<h6>Additional services</h6>';
                                                        // Print or use the values as needed
                                                        foreach ($tripExtrasIds as $value) {
                                                            echo '<li>'.get_the_title( $value ).'</li>';
                                                        }
                                                    } else {
                                                        echo "No additional services available.";
                                                    }
                                                }
                                    		}
                                    		echo '<hr>';
                                		}
                                		
                		                
                		                
                		                echo '</br></br>';
                		                
                		                
                		                
        				            
										
									}
        				            else if($order_type_itinerary == 'gds')
        				            {
        				                ?>
                				                </br>
                				                <form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                                	<input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='download_itinerary_email' value='Download Itinerary'>
                                                </form>
                				                <?php
        				                echo '<h5>Current Itinerary</h5>';
        				                $carrier = get_meta_from_history_of_updates($order_id_api, "Flightlegs MarketingCarrier");
        				                $flight_number = get_meta_from_history_of_updates($order_id_api, "Flightlegs FlNr");
        				                $departure_airport = get_meta_from_history_of_updates($order_id_api, "Flightlegs DepApt");
        				                $destination_airport = get_meta_from_history_of_updates($order_id_api, "Flightlegs DestApt");
        				                $departure_time = get_meta_from_history_of_updates($order_id_api, "Flightlegs DepTime");
        				                $destination_time = get_meta_from_history_of_updates($order_id_api, "Flightlegs DestTime");
        				                $flight_class = get_meta_from_history_of_updates($order_id_api, "Flightlegs CosDescription");
        				                $flight_class_code = get_meta_from_history_of_updates($order_id_api, "Flightlegs Class");
        				                $flight_elapsed_time = get_meta_from_history_of_updates($order_id_api, "Flightlegs Elapsed");
        				                $flight_meals = get_meta_from_history_of_updates($order_id_api, "Flightlegs Meal");
        				                $flight_departure_terminal = get_meta_from_history_of_updates($order_id_api, "Flightlegs DepTerminal");
        				                $flight_destination_terminal = get_meta_from_history_of_updates($order_id_api, "Flightlegs DestTerminal");
        				                
                                        
                                        $carrier_array = explode(' | ', $carrier);
                                        $flight_number_array = explode(' | ', $flight_number);
                                        $departure_airport_array = explode(' | ', $departure_airport);
                                        $destination_airport_array = explode(' | ', $destination_airport);
                                        $departure_time_array = explode(' | ', $departure_time);
                                        $destination_time_array = explode(' | ', $destination_time);
                                        $flight_class_array = explode(' | ', $flight_class);
                                        $flight_class_code_array = explode(' | ', $flight_class_code);
                                        $flight_elapsed_time_array = explode(' | ', $flight_elapsed_time);
                                        $flight_meals_array = explode(' | ', $flight_meals);
                                        $flight_departure_terminal_array = explode(' | ', $flight_departure_terminal);
                                        $flight_destination_terminal_array = explode(' | ', $flight_destination_terminal);
                                        
                                        $combined_array = array();
                                        for ($i = 0; $i < count($carrier_array); $i++) {
                                            $combined_array[] = array(
                                                'carrier' => $carrier_array[$i] ?? '',
                                                'flightnumber' => $flight_number_array[$i] ?? '',
                                                'departureairport' => $departure_airport_array[$i] ?? '',
                                                'destinationairport' => $destination_airport_array[$i] ?? '',
                                                'departuretime' => $departure_time_array[$i] ?? '',
                                                'destinationtime' => $destination_time_array[$i] ?? '',
                                                'flightclass' => $flight_class_array[$i] ?? '',
                                                'flightclasscode' => $flight_class_code_array[$i] ?? '',
                                                'flightelapedtime' => $flight_elapsed_time_array[$i] ?? '',
                                                'flightdepartureterminal' => $flight_departure_terminal_array[$i] ?? '',
                                                'flightdestinationterminal' => $flight_destination_terminal_array[$i] ?? '',
                                                'flightmeals' => $flight_meals_array[$i] ?? ''
                                            );
                                        }
                                        
                                        echo '<table class="table m_-8969220568537220410 tripitinerary wp-travel-table-content trip_'.$order_id.'" cellpadding="0" cellspacing="0" style="width:100%; margin:auto;font-size:14px; width:100%; text-align:left; border: 1px solid #e1e1e; border-collapse: collapse; margin:10px 0px 10px 0px; font-size:14px;">';
                                        echo '<tr><th width="10%">Dep Airport</th><th width="15%">Dep Date</th><th width="10%">Flight</th><th width="10%">Dest Airport</th><th width="15%">Destination Time</th><th width="10%">Class</th><th width="10%">Meal</th><th width="10%">Duration</th></tr>';
                                        $waitTime = '';
                                        $waitHours = '';
                                        $previousDepTime = null;
            
                                        foreach ($combined_array as $index => $item) {
                                            $totalMinutes = (int)$item['flightelapedtime'] * 60;
                                            $hours = floor($totalMinutes / 60);
                                            $minutes = $totalMinutes % 60;
                                            $timeFormatted = sprintf("%dh %dmin", $hours, $minutes);
                                            if ($index > 0) {
                                                $currentDepTime = strtotime($item['departuretime']);
                                                $previousDestTime = strtotime($combined_array[$index - 1]['destinationtime']);
                                                $waitTimeMinutes = round(($currentDepTime - $previousDestTime) / 60);
                                                $waitHours = floor($waitTimeMinutes / 60);
                                                $waitMinutes = $waitTimeMinutes % 60;
                                                $waitTime = sprintf("%dh %dmin", $waitHours, $waitMinutes);
                                            } else {
                                                $waitTime = '';
                                            }
                                            if ($waitTime !== '' && $waitHours < 24) {
                                                echo '<tr>';
                                                echo '<td colspan="7">WAIT: ' . $waitTime . '</td>';
                                                echo '</tr>';
                                            }
                                            if ($waitHours >= 24 && $waitTime !== '') {
                                                echo '</table></br><table cellpadding="0" cellspacing="0" style="width:100%; text-align:left; border: 1px solid #e1e1e; border-collapse: collapse; margin:10px 0px 10px 0px; font-size:14px;">
                                                <tr><th width="10%">Dep Airport</th><th width="15%">Dep Date</th><th width="10%">Flight</th><th width="10%">Dest Airport</th><th width="15%">Destination Time</th><th width="10%">Class</th><th width="10%">Meal</th><th width="10%">Duration</th></tr>';
                                            }
                                            echo '<tr>';
                                            echo '<td>' . $item['departureairport'] . '</br>' . $item['flightdepartureterminal'] . '</td>';
                                            echo '<td>' . $item['departuretime'] . '</td>';
                                            echo '<td>' . $item['carrier'] . $item['flightnumber'] . '</td>';
                                            echo '<td>' . $item['destinationairport'] . '</br>' . $item['flightdestinationterminal'] . '</td>';
                                            echo '<td>' . $item['destinationtime'] . '</td>';
                                            echo '<td>' . $item['flightclasscode'] . ' - ' . $item['flightclass'] . '</td>';
                                            echo '<td>' . $item['flightmeals'] . '</td>';
                                            echo '<td>' . $timeFormatted . '</td>'; // flight time
                                            echo '</tr>';
                                            $previousDepTime = strtotime($item['departuretime']);
                                        }
                                        echo '</table>';
        				                
        				            }
									else if($order_type_itinerary == 'Agent' )
        				            {
        				                echo '<h5>Current Itinerary</h5>';
        				                
        				                $order_id_for_itinerary = $order_id_api;
                    				    $query_order_booking_info_itinerary = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_for_itinerary' AND co_order_id='$co_order_id_api' order by travel_date asc";
                                		$result_order_booking_info_itinerary = mysqli_query($mysqli, $query_order_booking_info_itinerary) or die(mysqli_error($mysqli));
                                		while($row_order_booking_info_itinerary = mysqli_fetch_assoc($result_order_booking_info_itinerary))
                                		{
                                			$traveldate_fxed = $row_order_booking_info_itinerary['travel_date'];
                                			$product_title = $row_order_booking_info_itinerary['product_title'];
                                			$trip_code = $row_order_booking_info_itinerary['trip_code'];
                                			$product_id_itinerary = $row_order_booking_info_itinerary['product_id'];
                                			$new_product_id_itinerary = $row_order_booking_info_itinerary['new_product_id'];
                                			
                                			if($new_product_id_itinerary == '' || $new_product_id_itinerary == NULL )
                                			{
                                			    $wptravel_itineraries_r = get_post_meta( $product_id_itinerary, 'wp_travel_trip_itinerary_data', true );
                                    			$trip_wp_title = get_post_field( 'post_title', $product_id_itinerary );
                                    			$wptravel_travel_outline = get_post_meta( $product_id_itinerary, 'wp_travel_outline', true );
                                    			$productid_for_wptravel_product = $product_id_itinerary;
                                			}
                                			else
                                			{
                                			    $wptravel_itineraries_r = get_post_meta( $new_product_id_itinerary, 'wp_travel_trip_itinerary_data', true );
                                    			$trip_wp_title = get_post_field( 'post_title', $new_product_id_itinerary );
                                    			$wptravel_travel_outline = get_post_meta( $new_product_id_itinerary, 'wp_travel_outline', true );
                                    			$productid_for_wptravel_product = $new_product_id_itinerary;
                                			}
			
                                			


                                			if ( isset( $wptravel_itineraries_r ) && ! empty( $wptravel_itineraries_r ) ) : 
                                				$wptravel_index = 1;
                                				$itinerary_location_array = array();
                                				$itinerary_time_array = array();
                                				$itinerary_flight_array = array();
                                				$itinerary_date_array = array();
                                				$itinerary_datedecider_array = array();
                                				$itinerary_array_counter = 0;
                                				$itinerary_counter=0;	
                                				foreach ( $wptravel_itineraries_r as $wptravel_itinerary ) : 
                                					$wptravel_time_format = get_option( 'time_format' );
                                					$wptravel_itinerary_label = '';
                                					$wptravel_itinerary_title = '';
                                					$wptravel_itinerary_desc  = '';
                                					$wptravel_itinerary_date  = '';
                                					$wptravel_itinerary_time  = '';
                                					$itinerary_counter = 1;
                                					$is_itinerary_available = 1;
                                						$wptravel_itinerary_label = stripslashes( $wptravel_itinerary['label'] );
                                					
                                						$wptravel_itinerary_title = stripslashes( $wptravel_itinerary['title'] );
                                					
                                						$wptravel_itinerary_desc = stripslashes( $wptravel_itinerary['desc'] );
                                					
                                						$wptravel_itinerary_date = wptravel_format_date( $wptravel_itinerary['date'] );
                                					
                                						$wptravel_itinerary_time = stripslashes( $wptravel_itinerary['time'] );
                                						$wptravel_itinerary_time = date( $wptravel_time_format, strtotime( $wptravel_itinerary_time ) ); 
                                				    $itinerary_location_array[$itinerary_array_counter] = $wptravel_itinerary_label; // destination
                                					$itinerary_time_array[$itinerary_array_counter] = $wptravel_itinerary_time; // flight time
                                					$itinerary_flight_array[$itinerary_array_counter] = $wptravel_itinerary_title; // flight number
                                					$itinerary_date_array[$itinerary_array_counter] = $traveldate_fxed; // flight date
                                					$itinerary_datedecider_array[$itinerary_array_counter] = strip_tags($wptravel_itinerary_desc); // arrival or departure define
                                							
                                					$wptravel_index++;
                                					$itinerary_array_counter++;
                                					
                                				endforeach;
                                			endif; 
                                			// DEFINE EXTRA DAYS
                                            $itinerary_vals = '';
                                			$departure_date_plus_one = date("d/m/Y", strtotime("1 day", strtotime($traveldate_fxed))); 
                                			$departure_date_plus_two = date("d/m/Y", strtotime("2 day", strtotime($traveldate_fxed)));
                                			$departure_date_plus_three = date("d/m/Y", strtotime("3 day", strtotime($traveldate_fxed)));
                                			$departure_date_plus_four = date("d/m/Y", strtotime("4 day", strtotime($traveldate_fxed)));
                                			$length_aray = 0;
                                            if ( isset($itinerary_location_array) && is_array( $itinerary_location_array ) ) {
                                			$length_aray = count($itinerary_location_array);
                                			$itinerary_vals .= '<center><table class="m_-8969220568537220410 tripitinerary wp-travel-table-content trip_'.$product_id_itinerary.'" cellpadding="0" cellspacing="0" style="width:100%; text-align:left; border: 1px solid #e1e1e; border-collapse: collapse; margin:10px 0px 10px 0px; font-size:14px;">
                                			<thead>
                                			  <tr style="background: #f0f0f0; border:none;">
                                				 <th style="width:20%">From</th>
                                				 <th style="width:20%">To</th>
                                				 <th style="width:20%">Flight</th>
                                				 <th style="width:20%">Departure</th>
                                				 <th style="width:20%">Arrival</th>
                                			  </tr>
                                			</thead>
                                			<tbody>';
                                                    }
                                                    else {
                                            // Handle the case when $itinerary_location_array is null
                                            $itinerary_vals .= '<p>No itinerary locations found.</p>';
                                            }
                                			// SECTION TO DIVIDE WAITING, SELF TRANSFER AND FLIGHT INFO
                                			$is_printed_destination = '';
                                			for ($i = 0; $i < $length_aray; $i++) {
                                				if($itinerary_location_array[$i] == 'WAIT')
                                				{
                                					//$itinerary_vals .= "<tr>";
                                					//$itinerary_vals .= '<td colspan="5" style="width:30%">'.$itinerary_location_array[$i].' - '.$itinerary_flight_array[$i].'</td>';
                                					//$itinerary_vals .= "</tr>"; 
                                					
                                					$is_printed_destination = '';
                                				}
                                				else if($itinerary_location_array[$i] == 'SELF-TRANSFER')
                                				{
                                					//$itinerary_vals .= "<tr>";
                                					//$itinerary_vals .= '<td colspan="5" style="width:30%">'.$itinerary_datedecider_array[$i].' - '.$itinerary_flight_array[$i].'</td>';
                                					//$itinerary_vals .= "</tr>"; 
                                					
                                					$is_printed_destination = '';
                                				}
                                				else
                                				{
                                					if ($is_printed_destination == '') 
                            			            {
                            			                 
                            			                $date1 = date("Y-m-d", strtotime($itinerary_datedecider_array[$i]))." ".date("H:i:s", strtotime($itinerary_time_array[$i]));
                            			                if(isset($itinerary_datedecider_array[$i+1]) && isset($itinerary_time_array[$i+1]))
                            			                {
                                                            $date2 = date("Y-m-d", strtotime($itinerary_datedecider_array[$i+1]))." ".date("H:i:s", strtotime($itinerary_time_array[$i+1]));
                                                            $dateDiff = intval((strtotime($date2) - strtotime($date1)) / 60);
                            			                }
                            			                else
                            			                {
                            			                    $dateDiff = intval((strtotime($date1) - strtotime($date1)) / 60);
                            			                }
                                                        
                                                        $hours = intval($dateDiff / 60); 
                                                        $minutes = $dateDiff % 60;
                                                        
                                                        $time_duration = $hours.":".$minutes;
                                                        $airline_from_itinerary = substr($itinerary_flight_array[$i],0,2);
                                            
                                    					$itinerary_vals .= "<tr>";
                                    					$itinerary_vals .= '<td style="width:20%">'.$itinerary_location_array[$i].'</td>';
                                    					if(isset($itinerary_location_array[$i+1])) { 
                                    					    $itinerary_vals .= '<td style="width:20%">'.$itinerary_location_array[$i+1].'</td>';
                                    					}
                                    					$itinerary_vals .= '<td style="width:20%">'.$itinerary_flight_array[$i].'</td>';
                                    					$itinerary_vals .= '<td style="width:20%">'.$itinerary_time_array[$i].'</br>'.$itinerary_datedecider_array[$i].'</td>';
                                    					if(isset($itinerary_time_array[$i+1]) && isset($itinerary_datedecider_array[$i+1])) { 
                                    					    $itinerary_vals .= '<td style="width:20%">'.$itinerary_time_array[$i+1].'</br>'.$itinerary_datedecider_array[$i+1].'</td>';
                                    					}
                                    					$itinerary_vals .= "</tr>";
                                    					$empty = '';
                                    					$itinerary_vals .= "<tr style='border:none;'>";
                                    					$itinerary_vals .= '<td colspan="2" style="border:none;">   Class: Economy
                                    					           </td>';
                                    					$itinerary_vals .= '<td colspan="2" style="border:none;">Operated by: '.$airline_from_itinerary.'</td>';
                                    					$itinerary_vals .= '<td style="border:none;">Duration: </td>';
                                    					$itinerary_vals .= "</tr>";
                                    					
                                    					$is_printed_destination = 'yes';
                            			            }
                            			            else
                            			            {
                            			                $is_printed_destination = '';
                            			            }
                                				}
                                			}
                                    		$itinerary_vals .= "</tbody></table></center></br></br>";
                                    		
                                    		$wptravel_travel_outline = get_post_meta( $productid_for_wptravel_product, 'wp_travel_outline', true );
                                            $pattern_to_remove_itinerary_table = '/<table class="tg">(.*?)<\/table>/s';
                                            $wptravel_travel_outline = preg_replace($pattern_to_remove_itinerary_table, '', $wptravel_travel_outline);
                                    		$itinerary_vals .= $wptravel_travel_outline;
                                    		
                                    		// REPLACE ALL THE FIXED WORDS AS DEPARTURE AND ARRIVAL ON BACKEND
                                    		$itinerary_vals = str_replace("Departure Date", '' ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Arrival Date", '' ,$itinerary_vals);
                                    		
                                    		$itinerary_vals = str_replace("Selected Date +4", $departure_date_plus_four ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Selected Date+4", $departure_date_plus_four ,$itinerary_vals);
                                    		
                                    		$itinerary_vals = str_replace("Selected Date +3", $departure_date_plus_three ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Selected Date+3", $departure_date_plus_three ,$itinerary_vals);
                                    		
                                    		$itinerary_vals = str_replace("Selected Date +2", $departure_date_plus_two ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Selected Date+2", $departure_date_plus_two ,$itinerary_vals);
                                    		
                                    		$itinerary_vals = str_replace("Selected Date+1", $departure_date_plus_one ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Selected Date +1", $departure_date_plus_one ,$itinerary_vals);
                                    		
                                    		$traveldate_fxed_1 = date("d/m/Y", strtotime($traveldate_fxed)); 
                                			$dep_date_ymd = date("Y-m-d", strtotime($traveldate_fxed)); 
                                			
                                    		$itinerary_vals = str_replace("Selected Date", $traveldate_fxed_1 ,$itinerary_vals);
                                			
                                			
                                    		$itinerary_vals = str_replace("Selected Date", $traveldate_fxed_1 ,$itinerary_vals);
                                    		
                                    		
                                    		$trip_code_post = get_post_meta($productid_for_wptravel_product, 'wp_travel_trip_code', true);
	                                        $itinerary_details = getGDealFlightItinerary($trip_code_post, $dep_date_ymd);
	                                        if($itinerary_details != '')
	                                        {
	                                            echo $itinerary_details;
	                                            echo $wptravel_travel_outline;
	                                        }
	                                        else
	                                        {
	                                           echo $itinerary_vals; 
	                                        }
	                                        

                                    		$wptravel_product_information_ordered = get_post_meta( $order_id_for_itinerary, 'order_items_data', true ); // get order product info for trip extras
                                            if (is_array($wptravel_product_information_ordered) || is_object($wptravel_product_information_ordered)) 
                                            {
                                                foreach ($wptravel_product_information_ordered as $key => $value) {
                                                    // Check if the 'trip_extras' key and 'id' key exist
                                                    if (isset($value['trip_extras']['id'])) {
                                                        // Extract "trip_extras" IDs
                                                        $tripExtrasIds = $value['trip_extras']['id'];
                                                        echo '<h6>Additional services</h6>';
                                                        // Print or use the values as needed
                                                        foreach ($tripExtrasIds as $value) {
                                                            echo '<li>'.get_the_title( $value ).'</li>';
                                                        }
                                                    } else {
                                                        echo "No additional services available.";
                                                    }
                                                }
                                    		}
                                    		echo '<hr>';
                                		}
                                		
                		                
                		                
                		                echo '</br></br>';
                		                
                		                
                		                
        				            }
        				            else
        				            {
        				                echo '<p>No itinerary locations found.</p>';
        				            }
                				    ?>
                				</div>
                				
                				<div id="history_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>" class="tabcontent" style="display:none;">
                                    <?php
                                        $order_id = $order_id_api;
                                        
                                        $query_ticketing_history = "SELECT * FROM wpk4_backend_travel_booking_update_history where order_id='$order_id_api' && meta_key = 'G360Events' order by updated_time DESC limit 10";
                                    	$result_ticketing_history = mysqli_query($mysqli, $query_ticketing_history);
                                    	$count_ticketing_history = mysqli_num_rows($result_ticketing_history);
                        				if($count_ticketing_history > 0)
                        				{
                                    	?>
                                    	<h5>G360 History</h5>
                                    	<table style="font-size:13px;">
                                            <tr><th>Type</th><th>on</th><th>By</th></tr>
                                    	    <?php
                                        	while($row_payment_history = mysqli_fetch_assoc($result_ticketing_history))
                                        	{
                                        	    if( $row_payment_history['updated_user'] != 'sriharshans')
                                        	    {
                            						?>	
                            							<tr>
                            								<td><?php echo $row_payment_history['meta_value']; ?> <?php echo $row_payment_history['meta_key_data']; ?></td>
                            								<td><?php echo $row_payment_history['updated_time']; ?></td>
                            								<td><?php echo $row_payment_history['updated_user']; ?></td>
                            							</tr>
                            						<?php
                                        	    }	   
                                        	}
                        				}
                        				else
                        				{
                        				    echo '<h5>Ticketing History</h5>';
                        				    echo 'No record found';
                        				}
                                    	?>
                                        </table>
                                        
                                        
                                        <?php
                                        $processedOrders = []; // processed meta_key and merge with updated date to skip duplicates
                        				$processedPax = []; // skip the posted pax details
                        				
                                        
                                        $query_ticketing_history = "SELECT * FROM wpk4_backend_travel_booking_update_history where order_id='$order_id_api' && meta_key != 'G360Events' order by pax_auto_id, updated_time ASC";
                                    	$result_ticketing_history = mysqli_query($mysqli, $query_ticketing_history);
                                    	$count_ticketing_history = mysqli_num_rows($result_ticketing_history);
                        				if($count_ticketing_history > 0)
                        				{
                                    	?>
                                    	<h5>Ticketing History</h5>
                                    	<table style="font-size:13px;">
                                            <tr><th>Type</th><th>Content</th><th>Updated on</th><th> Updated By</th></tr>
                                    	    
                                    	<?php
                                        	while($row_payment_history = mysqli_fetch_assoc($result_ticketing_history))
                                        	{
                            					$pax_auto_id = $row_payment_history['pax_auto_id'];
                            					$query_payment_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' && auto_id = '$pax_auto_id'";
                            					$result_payment_pax = mysqli_query($mysqli, $query_payment_pax);
                            					$row_payment_pax = mysqli_fetch_assoc($result_payment_pax);
                                					
                                					if(mysqli_num_rows($result_payment_pax) > 0)
                                					{
                                					    $pax_id_received = $row_payment_pax['auto_id'];
                                						if (!in_array($pax_id_received, $processedPax)) {
                                								//continue; // Skip to the next publish of pax row
                                								$is_pax_name_posted = 1;
                                							}
                                							else
                                							{
                                								$is_pax_name_posted = 0;
                                							}
                                							
                                						$processedPax[] = $pax_id_received;
                                						if($is_pax_name_posted == 1)
                                						{
                                						    if($row_payment_history['meta_key'] == 'pnr')
                                						    {
                                						    ?>
                                							<tr>
                                								<td colspan="4"><b><?php echo $row_payment_pax['salutation']; ?> <?php echo $row_payment_pax['fname']; ?> <?php echo $row_payment_pax['lname']; ?></b></td>
                                							</tr>
                                						    <?php
                                						    }
                                						}
                                					}
                            							$updating_value = $row_payment_history['meta_key'].$row_payment_history['pax_auto_id'].$row_payment_history['updated_time'];
                            							
                            							if (in_array($updating_value, $processedOrders)) {
                            								continue; // Skip to the next iteration if the order ID is already processed
                            							}
                            							
                            							$processedOrders[] = $updating_value;
                            							
                            							if 
                            							(
                            							$row_payment_history['meta_key'] != 'payment_status' &&
                            							$row_payment_history['meta_key'] != 'eticket_emailed' &&
                            							$row_payment_history['meta_key'] != 'invoice_raised' &&
                            							$row_payment_history['meta_key'] != 'payment amount' &&
                            							$row_payment_history['meta_key'] != 'payment profile' &&
                            							$row_payment_history['meta_key'] != 'pnr_status'
                            							)
                            							{
                            							    
                            							
                            						?>
                            							<tr>
                            								<td><?php echo $row_payment_history['meta_key']; ?></td>
                            								<td><?php echo $row_payment_history['meta_value']; ?></td>
                            								<td><?php echo $row_payment_history['updated_time']; ?></td>
                            								<td><?php echo $row_payment_history['updated_user']; ?></td>
                            							</tr>
                            						
                            						<?php
                            							}
                            					
                                        	}
                        				}
                        				else
                        				{
                        				    echo '<h5>Ticketing History</h5>';
                        				    echo 'No record found';
                        				}
                                    	?>
                                        </table>
                                        
                                        <?php
                                        $query_movement_history = "SELECT * FROM wpk4_backend_travel_booking_movements where order_id='$order_id_api' order by product_id";
                                    	$result_movement_history = mysqli_query($mysqli, $query_movement_history);
                        				$count_movement_history = mysqli_num_rows($result_movement_history);
                        				if($count_movement_history > 0)
                        				{
                        					?>
                        					<h5>Movement History</h5>
                        					<table style="font-size:13px;">
                        						<tr><th>Original Product ID</th><th>New Product ID</th><th>TripCode</th><th>Travel Date</th><th>Pax</th><th>Moved on</th><th>By</th></tr>
                        						<?php
                        						while($row_movement_history = mysqli_fetch_assoc($result_movement_history))
                        						{
                        						?>
                        						<tr><td><?php echo $row_movement_history['product_id']; ?></td><td><?php echo $row_movement_history['new_product_id']; ?></td><td><?php echo $row_movement_history['trip_code']; ?></td><td><?php echo $row_movement_history['travel_date_int']; ?></td><td><?php echo $row_movement_history['pax']; ?></td><td><?php echo $row_movement_history['updated_on']; ?></td><td><?php echo $row_movement_history['updated_by']; ?></td></tr>
                        						<?php
                        						}
                        						?>
                        					</table>
                        					<?php
                        				}
                        				else
                        				{
                        				    echo '<h5>Movement History</h5>';
                        					echo 'No movement happened';
                        				}
                                    	?>
                                    
            
                				    </div>
                				    
                				<div id="dc_submission_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>" class="tabcontent" style="display:none;">
                                    <?php
                                    $order_id = $order_id_api;
                                    
						?>
						<h4>Date Change Request</h4>
						<h5>Basic Information</h5>	

						<form action="#" method="post" enctype="multipart/form-data">
						<p class='fieldnotelable'>Email Address <font class='redstar'>*</font></p>		
						<input type='text' name='emailid' placeholder='E-mail' required readonly value=''>
						</br>
						<p class='fieldnotelable'>Phone Number <font class='redstar'>*</font></p>
						<input type='text' name='phonenumber' id="phonenumber" onblur="validatePhoneNumber()" onkeypress="return isNumberKey(event)"  required placeholder='Phone'  >
						</br>
						<p class='fieldnotelable'>Reason for the date change <font class='redstar'>*</font></p>
							<select name='reasonforchange' required id='reasonforchange' style="width:100%; padding:10px; border-color: #dcd7ca;">
								<option selected disabled value=''>Select</option>
								<option value='Family Emergency'>Family Emergency</option>
								<option value='Work Commitment/ Leave Rejection'>Work Commitment/ Leave Rejection</option>
								<option value='Health Issue/ Concern'>Health Issue/ Concern</option>
								<option value='Personal Reason'>Personal Reason</option>
								<option value='Medical Reason'>Medical Reason</option>
								<option value='Cancellation of Travel Plan'>Cancellation of Travel Plan</option>
								<option value='Flight Transit Time/ Layover Time'>Flight Transit Time/ Layover Time</option>
								<option value='Due to travel/ visa restrictions'>Due to travel/ visa restrictions</option>
								<option value='Name change request'>Name change request</option>
								<option value='Urgency of travel'>Urgency of travel</option>
								<option value='Incorrect information/ booking made'>Incorrect information/ booking made</option>
								<option value='Extend the travel plan'>Extend the travel plan</option>
							</select>
						</br></br>
						<p class='fieldnotelable'>Reservation code/ Order ID <font class='redstar'>*</font></p>	
						<input type='text' name='order_number'  required placeholder='Reservation Code/Order ID' id='pnr' onblur="validatePNR()">
						</br>
						<h5>Current Travel Information </h5>
						<p class='fieldnotelable'>Change Type <font class='redstar'>*</font></p>
							<input type="radio" id="oneway" checked name="traveltype" value="oneway"> <label for="oneway">One-way (Partial-ticket change)</label>&nbsp;&nbsp;
							<input type="radio" id="return" name="traveltype" value="return"> <label for="return">Return (Full-ticket change)</label><br>
						</br>
						<p class='fieldnotelable'>Travel Date <font class='redstar'>*</font></p>
						<table style="border:0px; padding:0px; margin:0px;">
						<tr><td style='width:50%'>
							<input type='text' required name='prev_traveldate' id='traveldate_going' placeholder='Travel Date' >
							</td><td style='width:49%'>
							<input type='text' required name='prev_traveldate_return' disabled id='traveldate_return' placeholder='Travel Date'>
							</td></tr></table>
						</br>
						<p class='fieldnotelable'>Number of Pax <font class='redstar'>*</font></p>
							<select name='numberofpax_previous' required style="width:100%; padding:10px; border-color: #dcd7ca;">
								<option selected disabled value=''>0</option>
								<?php
								for($i = 1; $i <= 10; $i++)
								{
									?>
									<option value='<?php echo $i; ?>'><?php echo $i; ?></option>
									<?php
								}
								?>
							</select>
						</br></br>
						<p class='fieldnotelable'>Airline <font class='redstar'>*</font></p>
						<select name='airline' required id='airline' style="width:100%; padding:10px; border-color: #dcd7ca;">
						<option selected disabled value=''>Airline</option>
						<option value='Air India'>Air India</option>
						<option value='Cathay Pacific Airways'>Cathay Pacific Airways</option>
						<option value='China Airlines'>China Airlines</option>
						<option value='China Southern'>China Southern</option>
						<option value='Emirates'>Emirates</option>
						<option value='Etihad Airways'>Etihad Airways</option>
						<option value='Garuda Indonesia'>Garuda Indonesia</option>
						<option value='Jet Airways'>Jet Airways</option>
						<option value='Malaysia Airlines'>Malaysia Airlines</option>
						<option value='Qantas Airways'>Qantas Airways</option>
						<option value='Qatar Airways'>Qatar Airways</option>
						<option value='Saudi Arabian Airlines'>Saudi Arabian Airlines</option>
						<option value='Scoot Airlines'>Scoot Airlines</option>
						<option value='Singapore Airlines'>Singapore Airlines</option>
						<option value='South African Airways'>South African Airways</option>
						<option value='Srilankan Airlines'>Srilankan Airlines</option>
						<option value='Thai Airways'>Thai Airways</option>
						<option value='Vietnam Airlines'>Vietnam Airlines</option>
						<option value='Air Asia'>Air Asia</option>
						<option value='Others'>Others</option>
						</select>
						</br></br>
						<h5>Preferred Travel Information</h5>	
						
						<p class='fieldnotelable'>Travel Date <font class='redstar'>*</font></p>
						
						<table style="border:0px; padding:0px; margin:0px;">
						<tr><td style='width:50%'>
							<input type='text' required name='new_traveldate' id='traveldate1' placeholder='Travel Date' >
							</td><td style='width:49%'>
							<input type='text' disabled required name='new_traveldate_both' id='traveldate1_both' placeholder='Travel Date' >
							</td></tr></table>
						</br>
						<p class='fieldnotelable'>Number of Pax</p>
							<select name='numberofpax_new' required style="width:100%; padding:10px; border-color: #dcd7ca;">
								<option selected disabled value=''>0</option>
								<?php
								for($i = 1; $i <= 10; $i++)
								{
									?>
									<option value='<?php echo $i; ?>'><?php echo $i; ?></option>
									<?php
								}
								?>
							</select>
						</br></br>
						<p class='fieldnotelable'>From</p>
						<input type='text' name='future_departure' placeholder='Departure Airport'  >
						</br>
						<p class='fieldnotelable'>To</p>
						<input type='text' name='future_arrival' placeholder='Arrival Airport'  >
						</br>
						<hr>
						<p class='fieldnotelable'>Additional Document</p>
						<input type='file' name='inputfile' accept=".jpg,.jpeg,.png,.pdf" placeholder='Add Attachments'  >
						</br>
						</br>
						<input type="checkbox" id="terms" required name="termsconditions" value="agreed"><label for="terms"> By clicking a submission button, <a target='_blank' href='https://gauratravel.com.au/terms-and-conditions/'>I agree to Consent <font class='redstar'>*</font></a></label><br>
						</br>
						<center><input type='submit' disalbed style='cursor: not-allowed;' class='btn btn-success' value='Submit'></center>
						</form>


                                </div>
                                
                                <div id="dc_submission_edit_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>" class="tabcontent" style="display:none;">
								<?php

								  // ---------- helpers ----------
								  if (!function_exists('gtx_dc_find_today_case_id')) {
									  function gtx_dc_find_today_case_id(mysqli $mysqli, string $order_id_api): ?int {
										  $sql = "
											  SELECT case_id
											  FROM wpk4_backend_user_portal_requests
											  WHERE case_type='datechange'
												AND reservation_ref=?
												
											  ORDER BY case_id DESC
											  LIMIT 1
										  ";
										  if ($stmt=$mysqli->prepare($sql)) {
											  $stmt->bind_param('s',$order_id_api);
											  $stmt->execute();
											  $stmt->bind_result($cid);
											  if ($stmt->fetch()) { $stmt->close(); return (int)$cid; }
											  $stmt->close();
										  }
										  return null;
									  }
								  }
								  if (!function_exists('gtx_dc_get_meta_map')) {
									  function gtx_dc_get_meta_map(mysqli $mysqli, int $case_id): array {
										  $out=[];
										  $sql="SELECT meta_key, meta_value FROM wpk4_backend_user_portal_request_meta WHERE case_id=? ORDER BY auto_id ASC";
										  if ($stmt=$mysqli->prepare($sql)) {
											  $stmt->bind_param('s',$case_id);
											  $stmt->execute();
											  $res=$stmt->get_result();
											  while($r=$res->fetch_assoc()){ $out[$r['meta_key']]=$r['meta_value']; }
											  $stmt->close();
										  }
										  return $out;
									  }
								  }

								  // ---------- determine mode / prefill ----------
								  $order_id = $order_id_api;
								  $existing_case_id = gtx_dc_find_today_case_id($mysqli, $order_id_api);
								  $has_today = !empty($existing_case_id);

								  $prefill = [];
								  if ($has_today) {
									  $prefill = gtx_dc_get_meta_map($mysqli, $existing_case_id);
								  }

								  $username = $prefill['email_address']  ?? ($row['email_pax']  ?? '');
								  $phonepx  = $prefill['phone_number']   ?? ($row['phone_pax']  ?? '');
								  $cur_go   = $prefill['current_travel_date'] ?? (!empty($row['travel_date']) ? date('d/m/Y', strtotime($row['travel_date'])) : '');
								  $cur_rt   = $prefill['current_travel_date_return'] ?? (!empty($row['return_date']) ? date('d/m/Y', strtotime($row['return_date'])) : '');
								  $pref_go  = $prefill['preferred_travel_date'] ?? '';
								  $pref_rt  = $prefill['preferred_travel_date_return'] ?? '';
								  $air_pref = $prefill['current_airline'] ?? '';
								  $from_pref= $prefill['from'] ?? substr($row['trip_code'], 0, 3);
								  $to_pref  = $prefill['to']   ?? substr($row['trip_code'], 4, 3);
								  $reason_pref = $prefill['reason'] ?? '';
								  $pax_prev    = $prefill['current_no_of_pax'] ?? ($total_pax ?? '');
								  $pax_new     = $prefill['no_of_pax'] ?? ($total_pax ?? '');
								?>

								  <style>
									.dc-hide { display:none; }
									.dc-chooser { border:1px solid #e5e5e5; padding:12px; background:#fafafa; margin:10px 0 16px; }
									.dc-chooser .btn { display:inline-block; padding:8px 12px; border:1px solid #ffbb00; cursor:pointer; margin-right:8px; border-radius:6px; background:#fff; }
									.dc-chooser .btn:hover { background:#f4f4f4; }
									.dc-summary { font-size:14px; line-height:1.5; margin-top:10px; }
									.dc-summary table { width:100%; border-collapse:collapse; }
									.dc-summary td { border-top:1px solid #eee; padding:6px 4px; vertical-align:top; }
									.fieldnotelable { margin-bottom:6px; }
								  </style>

								  <h4>Date Change Request</h4>
								  <h5>Basic Information</h5>

								  <?php if ($has_today): ?>
									<div class="dc-chooser" id="dc_choice_box">
									  <div style="margin-bottom:8px;">
										You already have a submission for this Order ID (Case #<?php echo (int)$existing_case_id; ?>).
										What would you like to do?
									  </div>
									  <div>
										<button type="button" class="btn" id="dc_btn_update_prev" style="background-color:#ffbb00; color: black;">Update Previous</button>
										
										<button class="tablinks chatcategory btn" onclick="openCity(event, 'dc_submission_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')" id="dc_btn_new_submit" style="border:2px solid #ffbb00;">Start New</button>
									  </div>

									  <!-- quick summary of previous (today) -->
									  <div class="dc-summary">
										<table>
										  <tr><td><strong>Case ID</strong></td><td>#<?php echo (int)$existing_case_id; ?></td></tr>
										  <tr><td><strong>Email</strong></td><td><?php echo htmlspecialchars($username); ?></td></tr>
										  <tr><td><strong>Phone</strong></td><td><?php echo htmlspecialchars($phonepx); ?></td></tr>
										  <tr><td><strong>Reason</strong></td><td><?php echo htmlspecialchars($reason_pref ?: ''); ?></td></tr>
										  <tr><td><strong>Current Travel</strong></td><td><?php echo htmlspecialchars(trim($cur_go . ($cur_rt ? " | ".$cur_rt : '')) ?: ''); ?></td></tr>
										  <tr><td><strong>Preferred Travel</strong></td><td><?php echo htmlspecialchars(trim($pref_go . ($pref_rt ? " | ".$pref_rt : '')) ?: ''); ?></td></tr>
										  <tr><td><strong>Route</strong></td><td><?php echo htmlspecialchars(($from_pref ?: '') . '  ' . ($to_pref ?: '')); ?></td></tr>
										  <tr><td><strong>Airline</strong></td><td><?php echo htmlspecialchars($air_pref ?: ''); ?></td></tr>
										</table>
									  </div>
									</div>
								  <?php endif; ?>

								  <!-- form container (hidden if has_today until a choice is made) -->
								  <div id="dc_form_box" class="<?php echo $has_today ? 'dc-hide' : ''; ?>">
									<form action="#" id="dcSubmitForm" method="post" enctype="multipart/form-data">
									  <!-- mode + existing case id (filled by JS if user picks Update Previous) -->
									  <input type="hidden" name="dc_mode" id="dc_mode" value="<?php echo $has_today ? '' : 'new'; ?>">
									  <?php if ($has_today): ?>
										<input type="hidden" name="existing_case_id" id="existing_case_id" value="<?php echo (int)$existing_case_id; ?>">
									  <?php endif; ?>

									  <p class='fieldnotelable'>Email Address <font class='redstar'>*</font></p>
									  <input type='text' name='emailid' placeholder='E-mail' required <?php if($username != '') { echo 'readonly'; } ?> value='<?php echo htmlspecialchars($username); ?>'>
									  </br>

									  <p class='fieldnotelable'>Phone Number <font class='redstar'>*</font></p>
									  <input type='text' name='phonenumber' id="phonenumber" onblur="validatePhoneNumber()" onkeypress="return isNumberKey(event)" required placeholder='Phone' value="<?php echo htmlspecialchars($phonepx); ?>">
									  </br>

									  <p class='fieldnotelable'>Reason for the date change <font class='redstar'>*</font></p>
									  <select name='reasonforchange' required id='reasonforchange' style="width:100%; padding:10px; border-color: #dcd7ca;">
										<option disabled value='' <?php echo $reason_pref===''?'selected':''; ?>>Select</option>
										<?php
										  $reasons = [
											  'Family Emergency','Work Commitment/ Leave Rejection','Health Issue/ Concern','Personal Reason',
											  'Medical Reason','Cancellation of Travel Plan','Flight Transit Time/ Layover Time',
											  'Due to travel/ visa restrictions','Name change request','Urgency of travel',
											  'Incorrect information/ booking made','Extend the travel plan'
										  ];
										  foreach ($reasons as $r) {
											  $sel = ($reason_pref===$r)?'selected':'';
											  echo "<option value='".htmlspecialchars($r,ENT_QUOTES)."' $sel>".htmlspecialchars($r)."</option>";
										  }
										?>
									  </select>
									  </br></br>

									  <p class='fieldnotelable'>Order ID <font class='redstar'>*</font></p>
									  <input type='text' name='order_number' onkeypress="return isNumberKey(event)" required placeholder='Reservation Code/Order ID' id='pnr' <?php if($order_id_api != '') echo 'readonly'; ?> value="<?php echo htmlspecialchars($order_id_api); ?>" onblur="validatePNR()">
									  </br>

									  <h5>Current Travel Information </h5>
									  <p class='fieldnotelable'>Change Type <font class='redstar'>*</font></p>
										<input type="radio" id="oneway" <?php if($final_order_type == 'oneway') { echo 'checked'; } ?> name="traveltype" value="oneway"> <label for="oneway">One-way (Partial-ticket change)</label>&nbsp;&nbsp;
										<input type="radio" id="return" name="traveltype" <?php if($final_order_type == 'return') { echo 'checked'; } ?> value="return"> <label for="return">Return (Full-ticket change)</label><br>
									  </br>

									  <p class='fieldnotelable'>Travel Date <font class='redstar'>*</font></p>
									  <table style="border:0; padding:0; margin:0;">
										<tr>
										  <td style='width:50%'>
											<input type='text' required name='prev_traveldate' id='traveldate_going' placeholder='Travel Date' value="<?php echo htmlspecialchars($cur_go); ?>">
										  </td>
										  <td style='width:49%'>
											<input type='text'  name='prev_traveldate_return' <?php echo ($final_order_type==='return')?'required':'disabled'; ?> id='traveldate_return' placeholder='Travel Date' value="<?php echo htmlspecialchars($cur_rt); ?>">
										  </td>
										</tr>
									  </table>
									  </br>

									  <p class='fieldnotelable'>Number of Pax <font class='redstar'>*</font></p>
									  <select name='numberofpax_previous' required style="width:100%; padding:10px; border-color: #dcd7ca;">
										<option disabled value='' <?php echo empty($pax_prev)?'selected':''; ?>>0</option>
										<?php for ($i=1;$i<=10;$i++):
										  $sel = ((string)$pax_prev === (string)$i) ? 'selected' : '';
										?>
										  <option value='<?php echo $i; ?>' <?php echo $sel; ?>><?php echo $i; ?></option>
										<?php endfor; ?>
									  </select>
									  </br></br>

									  <p class='fieldnotelable'>Airline <font class='redstar'>*</font></p>
									  <?php
										$airlines = ['Air India','Cathay Pacific Airways','China Airlines','China Southern','Emirates','Etihad Airways','Garuda Indonesia','Jet Airways','Malaysia Airlines','Qantas Airways','Qatar Airways','Saudi Arabian Airlines','Scoot Airlines','Singapore Airlines','South African Airways','Srilankan Airlines','Thai Airways','Vietnam Airlines','Air Asia','Others'];
									  ?>
									  <select name='airline' required id='airline' style="width:100%; padding:10px; border-color: #dcd7ca;">
										<option disabled value='' <?php echo empty($air_pref)?'selected':''; ?>>Airline</option>
										<?php foreach($airlines as $a):
										  $sel = ($air_pref===$a)?'selected':'';
										?>
										  <option value='<?php echo htmlspecialchars($a,ENT_QUOTES); ?>' <?php echo $sel; ?>><?php echo htmlspecialchars($a); ?></option>
										<?php endforeach; ?>
									  </select>
									  </br></br>

									  <h5>Preferred Travel Information</h5>

									  <p class='fieldnotelable'>Travel Date <font class='redstar'>*</font></p>
									  <table style="border:0; padding:0; margin:0;">
										<tr>
										  <td style='width:50%'>
											<input type='text' required name='new_traveldate' id='traveldate1' placeholder='Travel Date' value="<?php echo htmlspecialchars($pref_go); ?>">
										  </td>
										  <td style='width:49%'>
											<input type='text' <?php echo ($final_order_type==='return')?'required':'disabled'; ?>  name='new_traveldate_both' id='traveldate1_both' placeholder='Travel Date' value="<?php echo htmlspecialchars($pref_rt); ?>">
										  </td>
										</tr>
									  </table>
									  </br>

									  <p class='fieldnotelable'>Number of Pax</p>
									  <select name='numberofpax_new' required style="width:100%; padding:10px; border-color: #dcd7ca;">
										<option disabled value='' <?php echo empty($pax_new)?'selected':''; ?>>0</option>
										<?php for ($i=1;$i<=10;$i++):
										  $sel = ((string)$pax_new === (string)$i) ? 'selected' : '';
										?>
										  <option value='<?php echo $i; ?>' <?php echo $sel; ?>><?php echo $i; ?></option>
										<?php endfor; ?>
									  </select>
									  </br></br>

									  <p class='fieldnotelable'>From</p>
									  <input type='text' name='future_departure' placeholder='Departure Airport' value="<?php echo htmlspecialchars($from_pref); ?>">
									  </br>

									  <p class='fieldnotelable'>To</p>
									  <input type='text' name='future_arrival' placeholder='Arrival Airport' value="<?php echo htmlspecialchars($to_pref); ?>">
									  </br>

									  <input type="checkbox" id="terms" required name="termsconditions" value="agreed">
									  <label for="terms"> By clicking a submission button, <a target='_blank' href='https://gauratravel.com.au/terms-and-conditions/'>I agree to Consent <font class='redstar'>*</font></a></label><br>
									  </br>

									  <center>
										<input type='submit' style="width: 200px; font-size: 25px;"
											   class='btn btn-success' value='Submit'>
									  </center>
									</form>
									
								  </div><!-- /dc_form_box -->
									
																
								  <script>
									(function(){
									  var hasToday = <?php echo $has_today ? 'true':'false'; ?>;
									  if(!hasToday) return;

									  var btnUpdate = document.getElementById('dc_btn_update_prev');
									  var btnNew    = document.getElementById('dc_btn_new_submit');
									  var boxChoice = document.getElementById('dc_choice_box');
									  var boxForm   = document.getElementById('dc_form_box');
									  var dcMode    = document.getElementById('dc_mode');
									  var submitBtn = document.getElementById('dcSubmitBtn');

									  function showForm(mode){
										if (dcMode) dcMode.value = mode;  // 'update' or 'new'
										if (submitBtn) submitBtn.value = (mode==='update' ? 'Update' : 'Submit');
										boxChoice.classList.add('dc-hide');
										boxForm.classList.remove('dc-hide');
									  }

									  btnUpdate && btnUpdate.addEventListener('click', function(){
										showForm('update');
									  });
									  btnNew && btnNew.addEventListener('click', function(){
										showForm('new');
									  });
									})();
								  </script>
								</div>


							<div id="refund_request_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>" class="tabcontent" style="display:none;">
                                    <?php
                                    $order_id = $order_id_api;
                                    
					?>	
					<form action="#" method="post" enctype="multipart/form-data">
					<h2>Apply for Refunds</h2>	
						<h4>Gerneral Information</h4>
					<p class='fieldnotelable'>Email Address</p>	
							<input type='text' name='emailid' placeholder='E-mail' required readonly value=''>
							</br>
							<p class='fieldnotelable'>Reason</p>
							<textarea name='reasonforcancellation' placeholder='Reason' required></textarea>
							</br>
							<p class='fieldnotelable'>Reservation code/ Order ID</p>
							<input type='text' name='order_number' required placeholder='Reservation Code/ Order ID'  >
							</br>
							<p class='fieldnotelable'>Phone Number</p>
							<input type='text' id="phonenumber" onblur="validatePhoneNumber()" onkeypress="return isNumberKey(event)" name='phonenumber' required placeholder='Phone'  >
						
						
						<h4>Ticket Information</h4>	

					<fieldset id="paxcontainer">
					  <div class="paxbox" style='display:flex;'>
					  
						<div style='width:100%;'><p class='fieldnotelable'>Name of Passenger</p></br>
						<input type="text" onkeypress="return isTextKey(event)" required placeholder='Name of Passenger' id="pax_name" name="pax_name[]"></div>
						
					  </div>
					</fieldset>

					<button type="button" id="add_pax" class='btn_add_remove'>+ Add more</button>

					</br></br>

					<fieldset id="ticketcontainer">
					  <div class="ticketbox" style='display:flex;'>
					  
						<div style='width:100%;'><p class='fieldnotelable'>Ticket Number</p></br><input type="text" placeholder='Ticket Number' onkeypress="return isNumberKey(event)" id="ticket_number" name="ticket_number[]"></div>
						
					  </div>
					</fieldset>

					<button type="button" id="add_ticket" class='btn_add_remove'>+ Add more</button>
					</br>
					<p class='fieldnotelable'>Reservation Code</p>
					<input type='text' name='reservationcode' placeholder='Reservation Code' id='pnr' onblur="validatePNR()">
					</br>
					<p class='fieldnotelable'>Airline Reservation Code</p>
					<input type='text' name='airlinereservationcode' placeholder='Airline Reservation Code' id='airline_pnr' onblur="validateAirlinePNR()">
					</br>
					<p class='fieldnotelable'>Airline</p>
					<select name='airline' required id='airline' style="width:100%; padding:10px; border-color: #dcd7ca;">
					<option selected disabled>Airline</option>
    					<option value='Malaysia Airlines'>Malaysia Airlines</option>
    					<option value='Qantas Airways'>Qantas Airways</option>
    					<option value='Singapore Airlines'>Singapore Airlines</option>
    					<option value='Scoot Airlines'>Scoot Airlines</option>
    					<option value='Air India'>Air India</option>
    					<option value='Air India'>Air India</option>
    					<option value='Cathay Pacific Airways'>Cathay Pacific Airways</option>
    					<option value='China Airlines'>China Airlines</option>
    					<option value='China Southern'>China Southern</option>
    					<option value='Emirates'>Emirates</option>
    					<option value='Etihad Airways'>Etihad Airways</option>
    					<option value='Garuda Indonesia'>Garuda Indonesia</option>
    					<option value='Jet Airways'>Jet Airways</option>
    					<option value='Malaysia Airlines'>Malaysia Airlines</option>
    					<option value='Qantas Airways'>Qantas Airways</option>
    					<option value='Qatar Airways'>Qatar Airways</option>
    					<option value='Saudi Arabian Airlines'>Saudi Arabian Airlines</option>
    					<option value='Scoot Airlines'>Scoot Airlines</option>
    					<option value='Singapore Airlines'>Singapore Airlines</option>
    					<option value='South African Airways'>South African Airways</option>
    					<option value='Srilankan Airlines'>Srilankan Airlines</option>
    					<option value='Thai Airways'>Thai Airways</option>
    					<option value='Vietnam Airlines'>Vietnam Airlines</option>
    					<option value='Air Asia'>Air Asia</option>
    					<option value='Others'>Others</option>
					</select>
					</br></br>
					<p class='fieldnotelable'>Travel Date</p>
					<input type='text' required name='traveldate' id='traveldate' placeholder='Travel Date'  >

					<h4>Bank Details</h4>
					<p class='fieldnotelable'>Account Name</p>	
					<input type='text' name='accountname' onkeypress="return isTextKey(event)" required placeholder='Account Name'  >
					</br>
					<p class='fieldnotelable'>BSB</p>
					<input type='text' name='bsb' id='bsb' required onkeypress="return isNumberKey(event)" placeholder='BSB'  >
					</br>
					<p class='fieldnotelable'>Account Number</p>
					<input type='text' name='accountnumber' onkeypress="return isNumberKey(event)" required placeholder='Account Number'  >
					</br>
					<hr>
					<p class='fieldnotelable'>Additional Document</p>
					<input type='file' name='inputfile' accept=".jpg,.jpeg,.png,.pdf" placeholder='Add Attachments'  >
					</br></br>
					<input type="checkbox" id="terms" required name="termsconditions" value="agreed"><label for="terms"> By clicking a submission button, <a target='_blank' href='https://gauratravel.com.au/terms-and-conditions/'>I agree to Consent *</a></label><br>

					</br></br>
					<center><input type='submit' disalbed style='cursor: not-allowed;'  class='btn btn-success' value='Submit'></center>
					</form>
					
				
                                </div>
                                
                                <div id="complaintform_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>" class="tabcontent" style="display:none;">
                                    <?php
                                    $order_id = $order_id_api;
                                     
        					?>
        						<style>
        						#otherissues, #otherissuesbreak  { display: none; }
        						</style>	
        							<h3>Complaint Submission Form</h3>
        							<p>We are unhappy to see you dissatisfied. Please elaborate more to make us try our best to resolve the matter.</p>
        						</br>
        						<form action="#" method="post" enctype="multipart/form-data">
        							<p class='fieldnotelable'>Customer Name <font class='redstar'>*</font></p>
        							<input type='text' required onkeypress="return isTextKey(event)" name='customername' placeholder='Name' >
        								</br>
        							<p class='fieldnotelable'>Reservation Code/ Order ID <font class='redstar'>*</font></p>
        							<input type='text' required name='ordernumber'  placeholder='Reservation Code/ Order ID' id='pnr' onblur="validatePNR()">
        								</br>
        							<p class='fieldnotelable'>Phone Number <font class='redstar'>*</font></p>
        							<input type='text' name='phonenumber' required id="phonenumber" onblur="validatePhoneNumber()" onkeypress="return isNumberKey(event)"  placeholder='Phone Number' >
        								</br>
        							<p class='fieldnotelable'>Email ID <font class='redstar'>*</font></p>
        							<input type='text' name='emailid' placeholder='E-mail' required readonly value=''>
        								</br>
        							<p class='fieldnotelable'>Booking Ref# / Air Ticket Number (If created)</p>
        							<input type='text' name='bookingref' placeholder='Booking Ref# / Air Ticket Number (If created)' id='airline_pnr' onblur="validateAirlinePNR()">
        							<input type='hidden' name='flighttype' >
        								</br>
        							
        							<p class='fieldnotelable'>Complaint Type</p>
        							<select name='complainttype' id='complainttype' required style="width:100%; padding:10px; border-color: #dcd7ca;">
        							<option selected disabled value=''>Complaint Category</option>
        							<option value='Products or Services'>Products or Services</option>
        							<option value='Complaint Handling'>Complaint Handling</option>
        							<option value='Customer Service/Advice'>Customer Service/Advice</option>
        							<option value='Misleading Conduct'>Misleading Conduct</option>
        							<option value='Documentation'>Documentation</option>
        							<option value='Deposit / Pre-Payment / Cancellation'>Deposit / Pre-Payment / Cancellation</option>
        							<option value='Refunds'>Refunds</option>
        							<option value='Ticket / Itinerary'>Ticket / Itinerary</option>
        							<option value='Visa / Passport'>Visa / Passport</option>
        							<option value='Other, Please specify below'>Other, Please specify below</option>
        							
        							</select>
        								</br></br>
        								
        							<p class='fieldnotelable'>Airline</p>
        							<select name='airline' id='airline' style="width:100%; padding:10px; border-color: #dcd7ca;">
        							<option selected disabled value=''>Airline</option>
        							<option value='Air India'>Air India</option>
        							<option value='Cathay Pacific Airways'>Cathay Pacific Airways</option>
        							<option value='China Airlines'>China Airlines</option>
        							<option value='China Southern'>China Southern</option>
        							<option value='Emirates'>Emirates</option>
        							<option value='Etihad Airways'>Etihad Airways</option>
        							<option value='Garuda Indonesia'>Garuda Indonesia</option>
        							<option value='Jet Airways'>Jet Airways</option>
        							<option value='Malaysia Airlines'>Malaysia Airlines</option>
        							<option value='Qantas Airways'>Qantas Airways</option>
        							<option value='Qatar Airways'>Qatar Airways</option>
        							<option value='Saudi Arabian Airlines'>Saudi Arabian Airlines</option>
        							<option value='Scoot Airlines'>Scoot Airlines</option>
        							<option value='Singapore Airlines'>Singapore Airlines</option>
        							<option value='South African Airways'>South African Airways</option>
        							<option value='Srilankan Airlines'>Srilankan Airlines</option>
        							<option value='Thai Airways'>Thai Airways</option>
        							<option value='Vietnam Airlines'>Vietnam Airlines</option>
        							<option value='Air Asia'>Air Asia</option>
        							<option value='Others'>Others</option>
        							</select>
        								</br></br>
        								<p class='fieldnotelable'>Travel Date</p>
        							<input type='text' name='traveldate' id='traveldate' placeholder='Travel Date'  >
        								</br>
        								<p class='fieldnotelable'>Agent Name</p>
        							<input type='text' name='agentname' onkeypress="return isTextKey(event)" placeholder='Agent Name'  >
        								</br>
        								<p class='fieldnotelable'>Other Issues</p>
        							<input type='text' name='otherissue' id='otherissues' onkeypress="return isTextKey(event)" placeholder='Other'  >
        								<div id='otherissuesbreak'></br></div>
        								<p class='fieldnotelable'>Please explain what makes you unhappy?</p>
        							<textarea placeholder='Please explain what makes you unhappy?' name='explanation'></textarea>
        								</br>
        								<p class='fieldnotelable'>Resolution or Outcome you are seeking?</p>
        							<textarea placeholder='Resolution or Outcome you are seeking?' name='expectedresponse'></textarea>
        							</br>
        							<hr>
        							<input type='file' name='inputfile' accept=".jpg,.jpeg,.png,.pdf" placeholder='Please provide any additional files if needed'  >
        							</br></br>
        							<center><input type='submit' disalbed style='cursor: not-allowed;' class='btn btn-success' value='Submit'></center>
        							</form>
                                </div>

                                <div id="eticketdownload_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>" class="tabcontent" style="display:none;">
                        				    <?php
                        				    $filePath = '';
                        				    $order_id = $order_id_api;
                                        		$query_select_order_email = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' order by auto_id limit 1";
                                        		$result_select_order_email = mysqli_query($mysqli, $query_select_order_email);
                                        		$row_select_order_email = mysqli_fetch_assoc($result_select_order_email);
                                        		$customer_email = $row_select_order_email['email_pax'];
                                        		
                                        		$query_select_order_status = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api'";
                                        		$result_select_order_status = mysqli_query($mysqli, $query_select_order_status);
                                        		$row_select_order_status = mysqli_fetch_assoc($result_select_order_status);
                                        		$order_payment_status = $row_select_order_status['payment_status'];
                                        		
                                        		$query_count_bookingemail = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='Booking Email' order by auto_id desc limit 1";
                                        		$result_count_bookingemail = mysqli_query($mysqli, $query_count_bookingemail);
                                        		$row_count_bookingemail = mysqli_num_rows($result_count_bookingemail);
                                        		$row_bookingemail = mysqli_fetch_assoc($result_count_bookingemail);
                                        		if($row_count_bookingemail==0)
                                        		{
                                        			$is_bookingemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_bookingemail_sent[]" value="'.$order_id_api.'">';
                                        			$bookingemail_sent_on = '';
                                        		}
                                        		else
                                        		{
                                        			$is_bookingemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_bookingemail_sent[]" value="'.$order_id_api.'">';
                                        			$bookingemail_sent_on = ' on '.$row_bookingemail['initiated_date'];
                                        		}
                                        		
                                        		
                                        		
                                        		
                                        		$query_count_mhpplemail = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='MH PPL Voucher' order by auto_id desc limit 1";
                                        		$result_count_mhpplemail = mysqli_query($mysqli, $query_count_mhpplemail);
                                        		$row_count_mhpplemail = mysqli_num_rows($result_count_mhpplemail);
                                        		$row_mhpplemail = mysqli_fetch_assoc($result_count_mhpplemail);
                                        		if($row_count_mhpplemail==0)
                                        		{
                                        			$is_mhpplemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_itineraryemail_sent[]" value="'.$order_id_api.'">';
                                        			$mhppl_sent_on = '';
                                        		}
                                        		else
                                        		{
                                        			$is_mhpplemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_itineraryemail_sent[]" value="'.$order_id.'">';
                                        			$mhppl_sent_on = ' on '.$row_mhpplemail['initiated_date'];
                                        		}
                                        		
                                        		
                                        		
                                        		$query_count_itineraryemail = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='Itinerary Email' order by auto_id desc limit 1";
                                        		$result_count_itineraryemail = mysqli_query($mysqli, $query_count_itineraryemail);
                                        		$row_count_itineraryemail = mysqli_num_rows($result_count_itineraryemail);
                                        		$row_itineraryemail = mysqli_fetch_assoc($result_count_itineraryemail);
                                        		if($row_count_itineraryemail==0)
                                        		{
                                        			$is_itineraryemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_itineraryemail_sent[]" value="'.$order_id_api.'">';
                                        			$itineraryemail_sent_on = '';
                                        		}
                                        		else
                                        		{
                                        			$is_itineraryemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_itineraryemail_sent[]" value="'.$order_id.'">';
                                        			$itineraryemail_sent_on = ' on '.$row_itineraryemail['initiated_date'];
                                        		}	
                                        		
                                        		$query_count_taxinvoice = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='Tax Invoice' order by auto_id desc limit 1";
                                        		$result_count_taxinvoice = mysqli_query($mysqli, $query_count_taxinvoice);
                                        		$row_count_taxinvoice = mysqli_num_rows($result_count_taxinvoice);
                                        		$row_taxinvoice = mysqli_fetch_assoc($result_count_taxinvoice);
                                        		if($row_count_taxinvoice==0)
                                        		{
                                        			$is_tax_invoice_sent = '<input type="checkbox" onclick="return false;" id="inv" name="is_tax_invoice_sent[]" value="'.$order_id_api.'">'; $tax_invoice_sent_on = '';
                                        		}
                                        		else
                                        		{
                                        			$is_tax_invoice_sent = '<input type="checkbox" checked onclick="return false;" id="inv" name="is_tax_invoice_sent[]" value="'.$order_id_api.'">'; 
                                        			$tax_invoice_sent_on = ' on '.$row_taxinvoice['initiated_date'];
                                        		}
                                        		
                                        		$query_count_payment_update = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='Payment Update' order by auto_id desc limit 1";
                                        		$result_count_payment_update = mysqli_query($mysqli, $query_count_payment_update);
                                        		$row_count_payment_update = mysqli_num_rows($result_count_payment_update);
                                        		$row_paymentupdate = mysqli_fetch_assoc($result_count_payment_update);
                                        		if($row_count_payment_update==0)
                                        		{
                                        			$is_payment_update_sent = '<input type="checkbox" onclick="return false;" id="pay" name="is_payment_update_sent[]" value="'.$order_id_api.'">'; $payment_update_sent_on = '';
                                        		}
                                        		else
                                        		{
                                        			$is_payment_update_sent = '<input type="checkbox" checked onclick="return false;" id="pay" name="is_payment_update_sent[]" value="'.$order_id_api.'">'; 
                                        			$payment_update_sent_on = ' on '.$row_paymentupdate['initiated_date'];
                                        		}
                                        		
                                        		$query_count_eticket_update = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='Eticket Email' order by auto_id desc limit 1";
                                        		$result_count_eticket_update = mysqli_query($mysqli, $query_count_eticket_update);
                                        		$row_count_eticket_update = mysqli_num_rows($result_count_eticket_update);
                                        		$row_eticketupdate = mysqli_fetch_assoc($result_count_eticket_update);
                                        		if($row_count_eticket_update==0)
                                        		{
                                        			$is_eticket_update_sent = '<input type="checkbox" onclick="return false;" id="pay" name="is_payment_update_sent[]" value="'.$order_id_api.'">'; $eticket_update_sent_on = '';
                                        		}
                                        		else
                                        		{
                                        			$is_eticket_update_sent = '<input type="checkbox" checked onclick="return false;" id="pay" name="is_payment_update_sent[]" value="'.$order_id_api.'">'; 
                                        			$eticket_update_sent_on = ' on '.$row_eticketupdate['initiated_date'];
                                        		}
                                        		?>
                                        			<table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
                                        			
                                            			<?php
                                            			$query_pax_eticket_ = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api' ";
                                                		$result_pax_eticket_ = mysqli_query($mysqli, $query_pax_eticket_);
                                            			while($row_pax_eticket_ = mysqli_fetch_assoc($result_pax_eticket_))
                                                		{
                                                		    $order_id_ticketing = $row_pax_eticket_['order_id'];
                                                		    $product_id_ticketing = $row_pax_eticket_['product_id'];
                                                		    $tripcode_ticketing = $row_pax_eticket_['trip_code'];

                                                			$query_pax_eticket_loop = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' and product_id = '$product_id_ticketing' ";
                                                    		$result_pax_eticket_loop = mysqli_query($mysqli, $query_pax_eticket_loop);
                                                    		$row_pax_eticket_loop_count = mysqli_num_rows($result_pax_eticket_loop);
                                                			?>
                                            			    <tr>
                                            				<td rowspan = '<?php echo $row_pax_eticket_loop_count; ?>'><b><?php echo $tripcode_ticketing; ?></b> </br> Eticket Email</td>
                                            				<?php
                                            				$loop_count_pax = 0;
                                            				while($row_pax_eticket_loop = mysqli_fetch_assoc($result_pax_eticket_loop))
                                                		    {
                                                		        $loop_count_pax ++;
                                                		        $pax_id = $row_pax_eticket_loop['auto_id'];
                                                		        ?>
                                                		        <td>
                                                		            <?php echo $row_pax_eticket_loop['fname']; ?> <?php echo $row_pax_eticket_loop['lname']; ?>
                                                		        </td>
                                                				<td>
                                                					<?php
                                                    				//if($loop_count_pax == 1)
                                                    				{
                                                    				?>
                                                        				<form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                                        				    <input type='hidden' name='productidnew' value="<?php echo $product_id_ticketing; ?>" >
                                                    						<input type='submit' style='padding:15px; margin:0;font-size:11px;' name='sent_bulk_eticket_email_v2' value='Download Eticket'>
                                                    			        </form>
                                                    				<?php
                                                    				}
                                                    				?>
                                                				</td>
                                            				    <?php
                                            				    echo '</tr>';
                    		                                    }
                        		                                ?>
                                                			</tr>
                                            			<?php
                                                		}
                                            			?>
                                            			
        				                                
                                        			</table>
                                                    <?php
                                        			$today_date = date("Y-m-d H:i:s");
                                        			
                                            		$query_pax_eticket_loop = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api'";
                                                	$result_pax_eticket_loop = mysqli_query($mysqli, $query_pax_eticket_loop);
                                                	$row_pax_eticket_loop_count = mysqli_num_rows($result_pax_eticket_loop);
                                            		while($row_pax_eticket_loop = mysqli_fetch_assoc($result_pax_eticket_loop))
                    		                        {
                    		                            $pax_id = $row_pax_eticket_loop['auto_id'];
                    		                            ?>
                    		                            <div id="email_eticketPreview_<?php echo $order_id_api; ?><?php echo $pax_id; ?>" style="display: none;">
                                                            <?php
                                                    		$emailsubject = "Eticket Information - ".$order_id_api;
                                                            include(get_template_directory().'/templates/email/tpl_email_eticket_preview.php');
                                                            ?>
                                                        </div>
                    		                            <?php
                    		                        }
                    		                        ?>
                                                    <?php
                                            		$query_pax_eticket_loop = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api'";
                                                	$result_pax_eticket_loop = mysqli_query($mysqli, $query_pax_eticket_loop);
                                                	$row_pax_eticket_loop_count = mysqli_num_rows($result_pax_eticket_loop);
                                            		while($row_pax_eticket_loop = mysqli_fetch_assoc($result_pax_eticket_loop))
                    		                        {
                    		                            $pax_id = $row_pax_eticket_loop['auto_id'];
                    		                            ?>
                    		                            <script>
                    		                                document.getElementById("toggleButton_email_eticket_<?php echo $order_id_api; ?><?php echo $pax_id; ?>").addEventListener("click", function() {
                                                              var myDiv_payment = document.getElementById("email_eticketPreview_<?php echo $order_id_api; ?><?php echo $pax_id; ?>");
                                                              if (myDiv_payment.style.display === "none") {
                                                                myDiv_payment.style.display = "block";
                                                                this.textContent = "Hide Preview";
                                                              } else {
                                                                myDiv_payment.style.display = "none";
                                                                this.textContent = "Show Preview";
                                                              }
                                                            });
                    		                            </script>
                    		                            <?php
                    		                        }
                    		                        ?>    
                    		                            
                                                    
                                                    
                                            		<script>
                                            		    document.getElementById("toggleButton_email_itinerary_<?php echo $order_id_api; ?>").addEventListener("click", function() {
                                                          var myDiv_itinerary = document.getElementById("email_itineraryPreview_<?php echo $order_id_api; ?>");
                                                          if (myDiv_itinerary.style.display === "none") {
                                                            myDiv_itinerary.style.display = "block";
                                                            this.textContent = "Hide Preview";
                                                          } else {
                                                            myDiv_itinerary.style.display = "none";
                                                            this.textContent = "Show Preview";
                                                          }
                                                        });
                                                        
                                                        document.getElementById("toggleButton_email_payment_<?php echo $order_id_api; ?>").addEventListener("click", function() {
                                                          var myDiv_payment = document.getElementById("email_paymentPreview_<?php echo $order_id_api; ?>");
                                                          if (myDiv_payment.style.display === "none") {
                                                            myDiv_payment.style.display = "block";
                                                            this.textContent = "Hide Preview";
                                                          } else {
                                                            myDiv_payment.style.display = "none";
                                                            this.textContent = "Show Preview";
                                                          }
                                                        });
                                                        
                                                        
                                                        
                                                        
        
                                                      function confirmSubmit() {
                                                        var confirmed = confirm("Do you want to submit the form?");
                                                        return confirmed;
                                                      }
                                                    </script>
                                            		<?php
                                            		$themepath = get_stylesheet_directory_uri();
                                                    $themepath = str_replace("https://gauratravel.com.au/","",$themepath);
                                                    
                                                    if(isset($_POST['sent_itinerary_email']))
                                            		{
                                            			$today_date = date("Y-m-d H:i:s");
                                            			
                                            			if($order_type_itinerary == 'WPT' || $order_type_itinerary == '')
                				                        {
                				                            $emailsubject = "Itinerary Information - ".$order_id_api;
                                            			    include(get_template_directory().'/templates/email/tpl_email_itinerary.php');
                				                        }
                				                        else if($order_type_itinerary == 'gds')
                				                        {
                				                            $query_pax_lead_traveller = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' order by auto_id asc limit 1";
                                                    		$result_pax_lead_traveller = mysqli_query($mysqli, $query_pax_lead_traveller);
                                                    		$row_pax_lead_traveller = mysqli_fetch_assoc($result_pax_lead_traveller);
                                                                $pnr_for_email = $row_pax_lead_traveller['pnr'];
                    
                				                            $emailsubject = "Itinerary Information - ".$pnr_for_email;
                                            			    include(get_template_directory().'/templates/email/tpl_email_itinerary_gds.php');
                				                        }
                				                        else
                				                        {
                				                            echo 'No system email found';
                				                        }
                				                        
                                            			global $wpdb;
                                            			$email_subject = 'Itinerary Information';
                                            			$wpdb->insert('wpk4_backend_order_email_history', array(
                                                            'email_type' =>'Itinerary Email',
                                                            'order_id' =>$order_id_api,
                                                            'email_address' => $customer_email,
                                                            'initiated_date' => $today_date,
                                            				'initiated_by' => 'customer',
                                                            'email_subject' => $email_subject,
                                                        ));
                                                        $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                            			echo '<script>window.location.href="'.$current_url.'";</script>';
                                            		}
                                                    
                                                    
                                            		if(isset($_POST['download_itinerary_email']))
                                            		{
                                            			$today_date = date("Y-m-d H:i:s");
                                            			
                                            			if($order_type_itinerary == 'WPT' || $order_type_itinerary == '')
                				                        {
                				                            $emailsubject = "Itinerary Information - ".$order_id_api;
                                            			    include(get_template_directory().'/templates/email/tpl_download_itinerary.php');
                				                        }
                				                        else if($order_type_itinerary == 'gds')
                				                        {
                				                            $query_pax_lead_traveller = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' order by auto_id asc limit 1";
                                                    		$result_pax_lead_traveller = mysqli_query($mysqli, $query_pax_lead_traveller);
                                                    		$row_pax_lead_traveller = mysqli_fetch_assoc($result_pax_lead_traveller);
                                                                $pnr_for_email = $row_pax_lead_traveller['pnr'];
                    
                				                            $emailsubject = "Itinerary Information - ".$pnr_for_email;
                                            			    include(get_template_directory().'/templates/email/tpl_download_itinerary_gds.php');
                				                        }
                				                        else
                				                        {
                				                            echo 'No itinerary found';
                				                        }
                				                        
                                            			global $wpdb;
                                            			$email_subject = 'Itinerary Information';
                                            			$wpdb->insert('wpk4_backend_order_email_history', array(
                                                            'email_type' =>'Itinerary Email',
                                                            'order_id' =>$order_id_api,
                                                            'email_address' => $customer_email,
                                                            'initiated_date' => $today_date,
                                            				'initiated_by' => 'customer',
                                                            'email_subject' => $email_subject,
                                                        ));
                                                        $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                            			//echo '<script>window.location.href="'.$current_url.'";</script>';
                                            		}
                                            		
                                            		
                                            		if(isset($_POST['sent_bulk_eticket_email_v2']))
                                            		{
                                            			$today_date = date("Y-m-d H:i:s");
                                            			
                                            			$product_id_for_limit_loop = $_POST['productidnew'];
                                            			$order_id = $order_id_api;
                                            			$email_subject = 'Eticket';
                                            			include(get_template_directory().'/templates/email/tpl_download_eticket_bulk_v2.php');
                                            			global $wpdb;
                                            			$wpdb->insert('wpk4_backend_order_email_history', array(
                                                            'email_type' =>'Eticket Email',
                                                            'order_id' =>$order_id,
                                                            'email_address' => $customer_email,
                                                            'initiated_date' => $today_date,
                                            				'initiated_by' => 'customer',
                                                            'email_subject' => $email_subject,
                                                        ));
                                                        $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                            			echo '<script>window.location.href="'.$current_url.'";</script>';
                                            			
                                            		}
                                            		
                                            		
                                            		
                				            
                				            ?>
                        				</div>
                        				
                    			</div>
                			    
                			    <?php
                			    echo '<hr>';
                			}
    				    }
                	}
                	else
                	{
                		echo 'Kindly search with PNR/Order ID';
                	}
				}
			if(isset($_GET['p']) && $_GET['p'] =='update-case-submission') // to modify the major information provided by customer.
			{
				if(isset($_GET['case_id']))
				{
					$request_id = $_GET['case_id'];
					$case_type = $_GET['case_type'];
					
					$skipping_fieldsets = [
					  'attachment','subject','phone_number','email_address','passenger_names','ticket_numbers','booking_type',
					  'remarks','profile_number','total_paid_by_customer','gt_cancellation_fees','airline_cancellation_fees',
					  'consolidator_fees','type_of_refund','stage','refund_applied_to_airline_date','refund_received_from_airline_date',
					  'pcc','consolidator','oneway_return','rejected','refund_received_from_consolidator','refund_processed_date'
					];

					// -------------- handle POST (save) --------------
					if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action']) && $_POST['action'] === 'save_case_update') {
						$request_id = trim($_POST['request_id'] ?? '');
						$fields     = $_POST['fields'] ?? [];

						if ($request_id === '') {
							exit('Missing request_id.');
						}

						// Build combined response text
						$lines = ["Updated request by agent."];
						foreach ($fields as $key => $val) {
							if (in_array($key, $skipping_fieldsets, true)) continue;

							$label = ucfirst(str_replace('_', ' ', $key));
							$value = trim((string)$val);
							$lines[] = $label . ':- <!--email_off-->' . $value . '<!--/email_off-->';
						}
						$combined_text = implode('<br>', $lines);

						// Insert chat row
						$sql = "INSERT INTO wpk4_backend_user_portal_request_chats
								(request_id, request_type, response, response_time, response_by, status, chat_or_note)
								VALUES (?, ?, ?, ?, ?, 'open', 'chat')";
						if ($stmt = $mysqli->prepare($sql)) {
							$now = date('Y-m-d H:i:s');
							$stmt->bind_param('sssss', $request_id, $case_type, $combined_text, $now, $currnt_userlogined);
							if (!$stmt->execute()) {
								error_log('Chat insert failed: ' . $stmt->error);
								echo '<div style="color:#b00020">Failed to save chat. Please try again.</div>';
							} else {
								echo '<div style="color:#1b5e20">Saved successfully.</div>';
								$enc_case_id = md5($request_id);
								echo '<script>alert("Request editing successful.");</script>';
								echo '<script>window.location.href="?p=view-cases&start=&end=&status=&cid='.$request_id.'&id=&reply=&casetype='.$case_type.'";</script>';
							}
							$stmt->close();
						} else {
							error_log('Prepare failed: ' . $mysqli->error);
							echo '<div style="color:#b00020">Failed to save chat. Please try again.</div>';
						}
					}

					// Fetch meta rows
					$rows = [];
					$sql  = "SELECT meta_key, meta_value FROM wpk4_backend_user_portal_request_meta WHERE case_id = ?";
					if ($stmt = $mysqli->prepare($sql)) {
						$stmt->bind_param('s', $request_id);
						$stmt->execute();
						$res = $stmt->get_result();
						while ($r = $res->fetch_assoc()) {
							if (!in_array($r['meta_key'], $skipping_fieldsets, true)) {
								$rows[$r['meta_key']] = $r['meta_value'];
							}
						}
						$stmt->close();
					} else {
						echo '<div style="color:#b00020">Error loading fields.</div>';
						return;
					}

					// Render editable form
					?>
					</br></br></br>
					<form method="post" style="max-width:800px;padding:12px;border:1px solid #ddd;border-radius:10px;">
					  <h3 style="margin-top:0;">Update Case Submission (Case ID: <?php echo htmlspecialchars($request_id); ?>)</h3>

					  <input type="hidden" name="action" value="save_case_update">
					  <input type="hidden" name="request_id" value="<?php echo htmlspecialchars($request_id); ?>">

					  <?php
					  if (empty($rows)) {
						  echo '<p>No editable fields found.</p>';
					  } else {
						  foreach ($rows as $key => $value) {
							  $label = ucfirst(str_replace('_', ' ', $key));
							  $display = htmlspecialchars($value);
							  if (mb_strlen($value) > 120) {
								  echo '<div style="margin-bottom:14px;">
										  <label style="font-weight:600;display:block;margin-bottom:6px;">' . htmlspecialchars($label) . '</label>
										  <textarea name="fields[' . htmlspecialchars($key) . ']" rows="4" style="width:100%;box-sizing:border-box;">' . $display . '</textarea>
										</div>';
							  } else {
								  echo '<div style="margin-bottom:14px;">
										  <label style="font-weight:600;display:block;margin-bottom:6px;">' . htmlspecialchars($label) . '</label>
										  <input type="text" name="fields[' . htmlspecialchars($key) . ']" value="' . $display . '" style="width:100%;box-sizing:border-box;">
										</div>';
							  }
						  }
					  }
					  ?>

					  <button type="submit" style="padding:10px 16px;border:0;border-radius:8px;cursor:pointer;background:#1976d2;color:#fff;">
						Save as Chat Entry
					  </button>
					</form>
					<?php				
				}
			}
			
			if(isset($_GET['p']) && $_GET['p'] =='managebox') //admin dashboard
			{
					
					$order_today = date('Y-m-d').' 00:00:00';
					$order_endtoday = date('Y-m-d').' 23:59:59';
					
					//refunds
					$query_refund = "SELECT * FROM wpk4_backend_user_portal_requests where case_type='refund' && status='open' && (sub_status IS NULL || sub_status NOT IN ('Refund Received','Refund Applied','Refund FUP with Airline'))";
					$result_refund = mysqli_query($mysqli, $query_refund);
					$row_refund = mysqli_num_rows($result_refund);
					
					$query_refund_airline = "SELECT * FROM wpk4_backend_user_portal_requests where case_type='refund' && status='open' && sub_status IN ('Refund Received','Refund Applied','Refund FUP with Airline')";
					$result_refund_airline = mysqli_query($mysqli, $query_refund_airline);
					$row_refund_airline = mysqli_num_rows($result_refund_airline);
					
					
					$query_refund_today = "SELECT * FROM wpk4_backend_user_portal_requests where case_type='refund' && case_date>='$order_today' && case_date<='$order_endtoday' && status='open'";
					$result_refund_today = mysqli_query($mysqli, $query_refund_today);
					$row_refund_today = mysqli_num_rows($result_refund_today);
					
					//date changes
					$query_dc = "SELECT * FROM wpk4_backend_user_portal_requests where case_type='datechange' && status='open'";
					$result_dc = mysqli_query($mysqli, $query_dc);
					$row_dc = mysqli_num_rows($result_dc);
					
					$query_dc_today = "SELECT * FROM wpk4_backend_user_portal_requests where case_type='datechange' &&  case_date>='$order_today' && case_date<='$order_endtoday' && status='open'";
					$result_dc_today = mysqli_query($mysqli, $query_dc_today);
					$row_dc_today = mysqli_num_rows($result_dc_today);
					
					//complaints
					$query_complaints = "SELECT * FROM wpk4_backend_user_portal_requests where case_type='complaint' && status='open'";
					$result_complaints = mysqli_query($mysqli, $query_complaints);
					$row_complaints = mysqli_num_rows($result_complaints);
					
					$query_complaints_today = "SELECT * FROM wpk4_backend_user_portal_requests where case_type='complaint' && case_date>='$order_today' && case_date<='$order_endtoday' && status='open'";
					$result_complaints_today = mysqli_query($mysqli, $query_complaints_today);
					$row_complaints_today = mysqli_num_rows($result_complaints_today);
					
					//SSR
					$query_ssr = "SELECT * FROM wpk4_backend_user_portal_requests where case_type='ssr_request' && status='open'";
					$result_ssr = mysqli_query($mysqli, $query_ssr);
					$row_ssr = mysqli_num_rows($result_ssr);
					
					$query_ssr_today = "SELECT * FROM wpk4_backend_user_portal_requests where case_type='ssr_request' &&  case_date>='$order_today' && case_date<='$order_endtoday' && status='open'";
					$result_ssr_today = mysqli_query($mysqli, $query_ssr_today);
					$row_ssr_today = mysqli_num_rows($result_ssr_today);
					
					
					//SSR
					$query_miscellaneous = "SELECT * FROM wpk4_backend_user_portal_requests where case_type='miscellaneous' && status='open'";
					$result_miscellaneous = mysqli_query($mysqli, $query_miscellaneous);
					$row_miscellaneous = mysqli_num_rows($result_miscellaneous);
					
					$query_miscellaneous_today = "SELECT * FROM wpk4_backend_user_portal_requests where case_type='miscellaneous' &&  case_date>='$order_today' && case_date<='$order_endtoday' && status='open'";
					$result_miscellaneous_today = mysqli_query($mysqli, $query_miscellaneous_today);
					$row_miscellaneous_today = mysqli_num_rows($result_miscellaneous_today);

					//Misc Requests 
					$query_misc = "SELECT * FROM wpk4_backend_user_portal_requests where case_type='datechange_misc' && status='open'";
					$result_misc = mysqli_query($mysqli, $query_misc);
					$row_misc = mysqli_num_rows($result_misc);
					
					$query_misc_today = "SELECT * FROM wpk4_backend_user_portal_requests where case_type='datechange_misc' &&  case_date>='$order_today' && case_date<='$order_endtoday' && status='open'";
					$result_misc_today = mysqli_query($mysqli, $query_misc_today);
					$row_misc_today = mysqli_num_rows($result_misc_today);
					?>
					</br></br></br>
					<div class="row headerdiv">
					<?php
					if( isset($user_role) || (isset($currnt_userlogined) && (current_user_can( 'administrator' ) || current_user_can( 'user_portal_refund_editor' ) || current_user_can( 'ho_operations' ) || current_user_can( 'datechange_manager' ) || current_user_can( 'user_portal_refund_editor_admin' )  || current_user_can( 'user_portal_refund_user' ))))
					{
						?>
					<div class="col-sm-4">
						<div class="alert alert-success" role="alert">
						  <h4 class="alert-heading">Refund Requests</h4>
						  <p>Total Pendings : <?php echo $row_refund; ?></p>
						  <p>Total Awaiting Airline : <?php echo $row_refund_airline; ?></p>
						  <h6 class="mb-0" style='margin:5px 0px;'>Received Today : <?php echo $row_refund_today; ?></h6>
						  </br>
						  <center><a href="?p=view-cases&start=&end=&status=Open&cid=&id=&reply=&casetype=refund"><button class='btn btn-primary' style='width:100%'>Manage Refund Requests</button></a></center>
						</div>
					</div>
					<?php
					}
					if( isset($user_role) || (isset($currnt_userlogined) && (current_user_can( 'administrator' ) || current_user_can( 'ho_operations' ) || current_user_can( 'datechange_manager' ) || current_user_can( 'user_portal_datechange_editor_admin' ) || current_user_can( 'user_portal_datechange_editor' ) || current_user_can( 'user_portal_datechange_user' ))))
					{
						?>
						<div class="col-sm-4">
							<div class="alert alert-success" role="alert">
							  <h4 class="alert-heading">Date Change Requests</h4>
							  <p>Total Pendings : <?php echo $row_dc; ?></p>
							  <h6 class="mb-0" style='margin:5px 0px;'>Received Today : <?php echo $row_dc_today; ?></h6>
							  </br>
							  <center><a href="?p=view-cases&start=&end=&status=Open&cid=&id=&reply=&casetype=datechange"><button class='btn btn-primary' style='width:100%'>Manage Date Change Requests</button></a></center>
							</div>
						</div>
						<?php
					}
					?>
					<?php
					if( isset($user_role) || (isset($currnt_userlogined) && (current_user_can( 'administrator' ) || current_user_can( 'ho_operations' ) || current_user_can( 'datechange_manager' ) || current_user_can( 'user_portal_complaint_editor_admin' ) || current_user_can( 'user_portal_complaint_editor' ) || current_user_can( 'user_portal_complaint_user' ) )))
					{
						?>
						<div class="col-sm-4">
							<div class="alert alert-success" role="alert">
							  <h4 class="alert-heading">Complaints</h4>
							  <p>Total Pendings : <?php echo $row_complaints; ?></p>
							  <h6 class="mb-0" style='margin:5px 0px;'>Received Today : <?php echo $row_complaints_today; ?></h6>
							  </br>
							  <center><a href="?p=view-cases&start=&end=&status=Open&cid=&id=&reply=&casetype=complaint"><button class='btn btn-primary' style='width:100%'>Manage Complaints</button></a>
							  </center>
							  
							</div>
						</div>
						<?php
					}
					?>
					<?php
					//if((isset($currnt_userlogined) && (current_user_can( 'administrator' ) )))
					{
						?>
						<div class="col-sm-4">
							<div class="alert alert-success" role="alert">
							  <h4 class="alert-heading">Special Service Requests</h4>
							  <p>Total Pendings : <?php echo $row_ssr; ?></p>
							  <h6 class="mb-0" style='margin:5px 0px;'>Received Today : <?php echo $row_ssr_today; ?></h6>
							  </br>
							  <center><a href="?p=view-cases&start=&end=&status=Open&cid=&id=&reply=&casetype=ssr_request"><button class='btn btn-primary' style='width:100%'>Manage SSR</button></a></center>
							</div>
						</div>
						<?php
					}
					?>
					<?php
					if((isset($currnt_userlogined) && (current_user_can( 'administrxxator' ) )))
					{
						?>
						<div class="col-sm-4">
							<div class="alert alert-success" role="alert">
							  <h4 class="alert-heading">Miscellaneous Requests</h4>
							  <p>Total Pendings : <?php echo $row_miscellaneous; ?></p>
							  <h6 class="mb-0" style='margin:5px 0px;'>Received Today : <?php echo $row_miscellaneous_today; ?></h6>
							  </br>
							  <center><a href="?p=view-cases&start=&end=&status=Open&cid=&id=&reply=&casetype=miscellaneous"><button class='btn btn-primary' style='width:100%'>Manage Miscellaneous</button></a></center>
							</div>
						</div>
						<?php
					}
					?>

					<div class="col-sm-4">
						<div class="alert alert-success" role="alert">
							<h4 class="alert-heading">Miscellaneous Requests</h4>
							<p>Total : <?php echo $row_misc; ?></p>
							<h6 class="mb-0" style='margin:5px 0px;'>Received Today : <?php echo $row_misc_today; ?></h6>
							</br>
							<center><a href="?p=view-cases&start=&end=&status=Open&cid=&id=&reply=&casetype=datechange_misc"><button class='btn btn-primary' style='width:100%'>Manage Misc Requests</button></a></center>
						</div>
					</div>
					
					<div class="col-sm-4">
							<div class="alert alert-success" role="alert">
							  <h4 class="alert-heading">Customer View</h4>
							  <p></p>
							  <h6 class="mb-0" style='margin:5px 0px;'></h6>
							  </br>
							  <center><a href="?p=customer-bookings"><button class='btn btn-primary' style='width:100%'>View Customer Bookings</button></a></center>
							</div>
						</div>
					</div>
				<?php
			}
			if(isset($_GET['p']) && $_GET['p'] =='refund-manager') //admin dashboard
			{
				if(current_user_can( 'user_portal_refund_editor_admin') || current_user_can( 'ho_operations') || current_user_can( 'datechange_manager') || current_user_can( 'user_portal_refund_editor') || current_user_can( 'administrator'))
				{
				?>
				<script src="https://cdn.jsdelivr.net/gh/alumuko/vanilla-datetimerange-picker@latest/dist/vanilla-datetimerange-picker.js"></script>
				<script>
					window.addEventListener("load", function (event) {
					let drp = new DateRangePicker('refundappliedtoairline',
							{
								
								timePicker: false,
								alwaysShowCalendars: true,
								singleDatePicker: true,
								autoApply: true,
								autoUpdateInput: true,
								
								locale: {
									format: "YYYY-MM-DD",
								}
							},
							function (start) {
								document.getElementById("refundappliedtoairline").value = start.format();
								
							})
					});
					window.addEventListener("load", function (event) {
					let drp = new DateRangePicker('refundreceiveddate',
							{
								
								timePicker: false,
								alwaysShowCalendars: true,
								singleDatePicker: true,
								autoApply: true,
								autoUpdateInput: true,
								
								locale: {
									format: "YYYY-MM-DD",
								}
							},
							function (start) {
								document.getElementById("refundreceiveddate").value = start.format();
								
							})
					
					});
					window.addEventListener("load", function (event) {
					let drp = new DateRangePicker('submitteddate',
							{
								
								timePicker: false,
								alwaysShowCalendars: true,
								singleDatePicker: true,
								autoApply: true,
								autoUpdateInput: true,
								
								locale: {
									format: "YYYY-MM-DD",
								}
							},
							function (start) {
								document.getElementById("submitteddate").value = start.format();
								
							})
					
					});
					
					

				</script>
				<?php
                // add form
                global $wpdb;
                        //edit - aditiya
                if (!function_exists('update_userportal_post_meta')) {
                    function update_userportal_post_meta($case_id, $meta_key, $meta_value) {
                        global $wpdb;
                        $table = 'wpk4_backend_user_portal_request_meta'; // exact table

                        // Try update by (case_id, meta_key)
                        $updated = $wpdb->update(
                            $table,
                            ['meta_value' => $meta_value],
                            ['case_id' => $case_id, 'meta_key' => $meta_key],
                            ['%s'],
                            ['%s', '%s']
                        );

                        if ($updated === false) {
                            // SQL error (log if needed)
                            return false;
                        }

                        if ($updated === 0) {
                            // No existing row -> insert
                            $inserted = $wpdb->insert(
                                $table,
                                [
                                    'case_id'    => (int)$case_id,
                                    'meta_key' => $meta_key,
                                    'meta_value' => $meta_value,
                                ],
                                ['%d', '%s', '%s']
                            );
                            if ($inserted === false) {
                                return false;
                            }
                        }
                        return true;
                    }
                }

				if (!function_exists('normalize_person_name')) {
				function normalize_person_name($name) {
					$name = strtoupper(trim((string)$name));
					$name = preg_replace('/^(MR|MRS|MISS|MS|MSTR|MASTER|DR|PROF|SHRI|SMT|MDM|MADAM)\s+/i', '', $name);
					$name = str_replace(['/', '\\', ',', ';', '|'], ' ', $name);
					$name = preg_replace('/[^A-Z0-9 ]+/', '', $name);
					$name = preg_replace('/\s+/', ' ', $name);
					// keep first + last token if more are present
					$parts = explode(' ', trim($name));
					if (count($parts) >= 2) $name = $parts[0].' '.end($parts);
					return trim($name);
				}
				}

				if (!function_exists('airline_names_from_trip_code')) {
					function airline_names_from_trip_code($trip_code) {
						$trip_code = strtoupper(trim((string)$trip_code));
						if ($trip_code === '') return '';

						// Split "MEL-BLR-SQ238-SQ510" or "MEL-ATQ-AI" into tokens
						$tokens = preg_split('/\s*-\s*/', $trip_code);
						$codes  = [];

						foreach ($tokens as $t) {
						$t = trim($t);
						// Airports are 3 letters (MEL, BLR, ATQ)  skip them
						if (preg_match('/^[A-Z]{3}$/', $t)) continue;

						// Airline indicators:
						//   - 2-char IATA code only (e.g., "AI", "SQ", "VA")
						//   - 2-char IATA code + flight number (e.g., "SQ238", "3K721")
						if (preg_match('/^([A-Z0-9]{2})\d*$/', $t, $m)) {
							$codes[$m[1]] = true; // keep unique
						}
						}

						if (!$codes) return '';

						// Map common codes  full names (fallback to code if unknown)
						$map = [
						'AI'=>'Air India','SQ'=>'Singapore Airlines','UL'=>'SriLankan Airlines','EK'=>'Emirates',
						'QR'=>'Qatar Airways','QF'=>'Qantas','VA'=>'Virgin Australia','JQ'=>'Jetstar',
						'TR'=>'Scoot','MH'=>'Malaysia Airlines','CX'=>'Cathay Pacific','TG'=>'Thai Airways',
						'EY'=>'Etihad Airways','NZ'=>'Air New Zealand','DL'=>'Delta Air Lines','UA'=>'United Airlines',
						'AA'=>'American Airlines','BA'=>'British Airways','KL'=>'KLM','AF'=>'Air France',
						'LH'=>'Lufthansa','TK'=>'Turkish Airlines','3K'=>'Jetstar Asia','IX'=>'Air India Express','UK'=>'Vistara'
						];

						$names = [];
						foreach (array_keys($codes) as $c) {
						$names[] = $map[$c] ?? $c;
						}
						return implode(', ', $names);
					}
				}


				$case_id = (int) ($_GET['cid'] ?? 0);
				$query_refund = "SELECT * FROM wpk4_backend_user_portal_requests where case_id='$case_id'";
				$result_refund = mysqli_query($mysqli, $query_refund);
				$row_refund = mysqli_fetch_assoc($result_refund);
				$created_on = $row_refund['case_date'];

				$ticket_numbers = get_userportal_post_meta($case_id, 'ticket_numbers');
				$passenger_names = get_userportal_post_meta($case_id, 'passenger_names');
				$emailaddress = get_userportal_post_meta($case_id, 'email_address');
				$passenger_paid = get_userportal_post_meta($case_id, 'passenger_paid');
				$payment_method = get_userportal_post_meta($case_id, 'payment_method');

				// Get selected passenger name from form or URL
				$selected_passenger = isset($_POST['passenger_name']) ? $_POST['passenger_name'] : (isset($_GET['passenger_name']) ? $_GET['passenger_name'] : '');
				$selected_passenger_sanitized = sanitize_title($selected_passenger);

				// Initialize passenger-specific fields
				$passenger_specific_fields = [
					 'passenger_paid', 
					'cancellation_fee',
					'refund_amount',
					'refund_received_from_airline',
					'diff',
					'account_name',
					'refund_received_date',
					'vendor',
					'booking_type',
					'submitted_date',
					'status',
					'priority',
					'remarks'
				];
				$decimal_fields = ['passenger_paid','cancellation_fee','refund_amount','refund_received_from_airline','diff'];

				$passenger_data = [];

				// Get passenger-specific data
				if (!empty($selected_passenger_sanitized)) {
					foreach ($passenger_specific_fields as $field) {
						$passenger_data[$field] = get_userportal_post_meta($case_id, $field . '--' . $selected_passenger_sanitized);
					}
				} else {
					// Set defaults if no passenger selected
					foreach ($passenger_specific_fields as $field) {
						$passenger_data[$field] = '';
					}
				}

				// Handle form submission (Submit or Add More)
				if (isset($_POST['refund_save_changes']) || isset($_POST['add_more'])) {
					$current_date_time = date('Y-m-d H:i:s');

					// --- Save passenger-specific fields ---
				if (!empty($selected_passenger_sanitized)) {
					foreach ($passenger_specific_fields as $field) {
						if (isset($_POST[$field]) && !in_array($field, ['status','priority'], true)) {
						$val = is_array($_POST[$field]) ? '' : trim((string)$_POST[$field]);

						// NEW: force decimals for money fields
						if (in_array($field, $decimal_fields, true)) {
							// allow fractions, convert commas to dots, strip extras
							$val = str_replace(',', '.', $val);
							$val = preg_replace('/[^0-9.]/', '', $val);
							if ($val === '' || $val === '.') { $val = '0'; }
							// format to 2 dp (kept as string for meta table)
							$val = number_format((float)$val, 2, '.', '');
						}

						update_userportal_post_meta($case_id, $field . '--' . $selected_passenger_sanitized, $val);
						}
					}
				}

					if (!empty($selected_passenger)) {
			$selected_passenger_sanitized = sanitize_title($selected_passenger);
			$ticket_from_form = isset($_POST['ticket_number_raw']) ? trim((string)$_POST['ticket_number_raw']) : '';
			update_userportal_post_meta($case_id, 'ticket_number--' . $selected_passenger_sanitized, $ticket_from_form);
			}

					// --- Save status in main table ---
					$status = isset($_POST['status']) ? sanitize_text_field($_POST['status']) : '';
					$wpdb->update(
						'wpk4_backend_user_portal_requests',
						[ 'status' => 'open' ],
						[ 'case_id' => $case_id ],
						[ '%s' ],
						[ '%d' ]
					);

					$priority = isset($_POST['priority']) ? sanitize_text_field($_POST['priority']) : '';
					$allowed_priority = ['High','Medium','Low'];
					if ($priority !== '' && in_array($priority, $allowed_priority, true)) {
						$wpdb->update(
							'wpk4_backend_user_portal_requests',
							[ 'priority' => $priority ],
							[ 'case_id' => (int)$case_id ],
							[ '%s' ],
							[ '%d' ]
						);
					}

					// --- Stage logic (from your old bottom block) ---
					foreach ($_POST as $meta_key => $meta_value) {
						if ($meta_key == 'stage') {
							if ($meta_value == 'Refund Applied to Airlines') {
								mysqli_query($mysqli, "UPDATE wpk4_backend_user_portal_request_meta SET meta_value = '$current_date_time' WHERE case_id = '$case_id' AND meta_key = 'refund_applied_to_airline_date'");
								$replymessage = 'Refund Applied to Airlines';
							} elseif ($meta_value == 'Refund received from Consolidator') {
								mysqli_query($mysqli, "UPDATE wpk4_backend_user_portal_request_meta SET meta_value = '$current_date_time' WHERE case_id = '$case_id' AND meta_key = 'refund_received_from_consolidator'");
								$replymessage = 'Refund received from Consolidator';
							} elseif ($meta_value == 'Refund Process to Passenger') {
								mysqli_query($mysqli, "UPDATE wpk4_backend_user_portal_request_meta SET meta_value = '$current_date_time' WHERE case_id = '$case_id' AND meta_key = 'refund_processed_date'");
								$replymessage = 'Refund Process to Passenger';
							}

							if (!empty($replymessage)) {
								mysqli_query($mysqli, "INSERT INTO wpk4_backend_user_portal_request_chats (request_id,response,response_time,response_by,status,request_type,chat_or_note,member_name) VALUES ('$case_id','$replymessage','$current_date_time','$currnt_userlogined','open','refund','status','')") or die(mysqli_error($mysqli));
							}
						}
					}

					// --- Decide action based on button ---
					if (isset($_POST['add_more'])) {
						// Show SweetAlert popup and stay
						echo "
						<script src='https://cdn.jsdelivr.net/npm/sweetalert2@11'></script>
						<script>
							Swal.fire({
								icon: 'success',
								title: 'Added successfully!',
								showConfirmButton: false,
								timer: 1500
							});
						</script>";
					} elseif (isset($_POST['refund_save_changes'])) {
						echo '<script>alert("Change has been updated");</script>';
						$enc_case_id = md5($case_id);
						echo '<script>window.location.href="?p=admin-request-view&id='.$case_id.'&co='.$enc_case_id.'&t=r&casetype=refund";</script>';
						exit;
					}
				}
				//get ticket number 
				// Step 1: Get reservation_ref from main table
				$reservation_ref = $wpdb->get_var(
					$wpdb->prepare(
						"SELECT reservation_ref FROM wpk4_backend_user_portal_requests WHERE case_id = %d",
						$case_id
					)
				);
								
				/* === PASSENGERS & TICKETS: case_id -> reservation_ref -> pax table === */




				// a) get reservation_ref for this case
				$reservation_ref = (string) $wpdb->get_var(
				$wpdb->prepare(
					"SELECT reservation_ref FROM wpk4_backend_user_portal_requests WHERE case_id = %d",
					$case_id
				)
				);
				$reservation_ref = trim($reservation_ref);
				$ref_no_ws = preg_replace('/\s+/', '', $reservation_ref);

				// b) decide whether to match by order_id or pnr
				$is_order = ($ref_no_ws !== '' && ctype_digit($ref_no_ws));
				$whereSql = $is_order ? "order_id = %s" : "pnr = %s";
				$whereArg = $is_order ? $ref_no_ws : $reservation_ref;

				// c) pull pax rows for this booking
				$pax_rows = $wpdb->get_results(
				$wpdb->prepare(
					"SELECT 
					COALESCE(NULLIF(fname,''), '') AS fname,
					COALESCE(NULLIF(lname,''), '') AS lname,
					ticket_number, order_id, product_id, pnr
					FROM wpk4_backend_travel_booking_pax
					WHERE {$whereSql}",
					$whereArg
				),
				ARRAY_A
				);
				if (!is_array($pax_rows)) $pax_rows = [];

				// Build unique (order_id, product_id) pairs from pax
				$pairs = [];
				foreach ($pax_rows as $r) {
				$oid = trim((string)($r['order_id'] ?? ''));
				$pid = trim((string)($r['product_id'] ?? ''));
				if ($oid !== '' && $pid !== '') $pairs[$oid.'|'.$pid] = [$oid, $pid];
				}

				// Fetch trip_code per pair and parse airline names
				$airline_set = [];
				foreach ($pairs as [$oid, $pid]) {
				$trip = $wpdb->get_var(
					$wpdb->prepare(
					"SELECT trip_code 
						FROM wpk4_backend_travel_bookings 
						WHERE order_id = %s AND product_id = %s 
						LIMIT 1",
					$oid, $pid
					)
				);
				if ($trip) {
					$name = airline_names_from_trip_code($trip);
					if ($name !== '') $airline_set[$name] = true;
				}
				}

				// Final display string (multiple products  join)
				$airline_display = !empty($airline_set) ? implode(', ', array_keys($airline_set)) : 'N/A';


				// d) build dropdown list and name->ticket map
				$dropdown_names = [];
				$passengerTicketMap = [];
				$order_no_values = [];
				$pnr_values = [];

				foreach ((array) $pax_rows as $r) {
				$fn = $r['fname'] ?: $r['pax_firstname'];
				$ln = $r['lname'] ?: $r['pax_surname'];
				$display = trim($fn.' '.$ln);
				if ($display !== '') {
					$dropdown_names[] = $display;
					$passengerTicketMap[normalize_person_name($display)] = trim((string)($r['ticket_number'] ?? ''));
				}
				if (!empty($r['order_id'])) $order_no_values[$r['order_id']] = true;
				if (!empty($r['pnr']))      $pnr_values[$r['pnr']] = true;
				}

				// unique & keep order
				$dropdown_names   = array_values(array_unique($dropdown_names));
				$order_no_display = !empty($order_no_values) ? implode(', ', array_keys($order_no_values)) : 'N/A';
				$pnr_display      = !empty($pnr_values) ? implode(', ', array_keys($pnr_values)) : 'N/A';

				// e) read selected passenger (same as you already do)
				$selected_passenger = isset($_POST['passenger_name']) ? $_POST['passenger_name'] : (isset($_GET['passenger_name']) ? $_GET['passenger_name'] : '');
				$preSelectedTicket  = '';
				if ($selected_passenger !== '') {
				$preSelectedTicket = $passengerTicketMap[normalize_person_name($selected_passenger)] ?? '';
				}

				$passengerPNRMap = [];   // NEW

				foreach ((array) $pax_rows as $r) {
				$fn = $r['fname'] ?: $r['pax_firstname'];
				$ln = $r['lname'] ?: $r['pax_surname'];
				$display = trim($fn.' '.$ln);
				if ($display !== '') {
					$key = normalize_person_name($display);
					$passengerTicketMap[$key] = trim((string)($r['ticket_number'] ?? ''));
					$passengerPNRMap[$key]    = trim((string)($r['pnr'] ?? ''));  // NEW
					$dropdown_names[] = $display;
				}
				if (!empty($r['order_id'])) $order_no_values[$r['order_id']] = true;
				if (!empty($r['pnr']))      $pnr_values[$r['pnr']] = true;
				}

				$dropdown_names = array_values(array_unique($dropdown_names));

				$preSelectedTicket = '';
				$preSelectedPNR    = '';  // NEW
				if ($selected_passenger !== '') {
				$k = normalize_person_name($selected_passenger);
				$preSelectedTicket = $passengerTicketMap[$k] ?? '';
				$preSelectedPNR    = $passengerPNRMap[$k]    ?? '';  // NEW
				}

				// Step 2: Decide query condition
				if (ctype_digit($reservation_ref)) {
					// reservation_ref is numeric  use order_id
					$ticket_numbers = $wpdb->get_col(
						$wpdb->prepare(
							"SELECT ticket_number 
							FROM wpk4_backend_travel_booking_pax 
							WHERE order_id = %s",
							$reservation_ref
						)
					);
				} else {
					// reservation_ref is not numeric  use pnr
					$ticket_numbers = $wpdb->get_col(
						$wpdb->prepare(
							"SELECT ticket_number 
							FROM wpk4_backend_travel_booking_pax 
							WHERE pnr = %s",
							$reservation_ref
						)
					);
				}

				
				//pnr
				// Step 1: Get reservation_ref from main table
				$reservation_ref = $wpdb->get_var(
					$wpdb->prepare(
						"SELECT reservation_ref FROM wpk4_backend_user_portal_requests WHERE case_id = %d",
						$case_id
					)
				);

				// Step 2: Decide query condition
				if (ctype_digit($reservation_ref)) {
					// reservation_ref is numeric  use order_id
					$pnr_values = $wpdb->get_col(
						$wpdb->prepare(
							"SELECT pnr 
							FROM wpk4_backend_travel_booking_pax 
							WHERE order_id = %s",
							$reservation_ref
						)
					);
				} else {
					// reservation_ref is not numeric  use pnr
					$pnr_values = $wpdb->get_col(
						$wpdb->prepare(
							"SELECT pnr 
							FROM wpk4_backend_travel_booking_pax 
							WHERE pnr = %s",
							$reservation_ref
						)
					);
				}

				// Step 3: Convert array to string for display
				$pnr_display = !empty($pnr_values) ? implode(', ', $pnr_values) : 'N/A';

				// Step 3: Convert array to string for display
				$ticket_numbers_display = !empty($ticket_numbers) ? implode(', ', $ticket_numbers) : 'N/A';
				//get order id 
				// Step 1: Get reservation_ref from main table
				$reservation_ref = $wpdb->get_var(
					$wpdb->prepare(
						"SELECT reservation_ref FROM wpk4_backend_user_portal_requests WHERE case_id = %d",
						$case_id
					)
				);

				// Step 2: Decide query condition
				if (ctype_digit($reservation_ref)) {
					// reservation_ref is numeric  it's already the order_id
					$order_no_values = [$reservation_ref];
				} else {
					// reservation_ref is not numeric  look up order_id using pnr
					$order_no_values = $wpdb->get_col(
						$wpdb->prepare(
							"SELECT order_id 
							FROM wpk4_backend_travel_booking_pax 
							WHERE pnr = %s",
							$reservation_ref
						)
					);
				}

				// Step 3: Convert array to string for display
				$order_no_display = !empty($order_no_values) ? implode(', ', $order_no_values) : 'N/A';
				//get 'Passenger Paid' and 'Payment Method'

				// Step 1: Get reservation_ref from main requests table
				$reservation_ref = $wpdb->get_var(
					$wpdb->prepare(
						"SELECT reservation_ref 
						FROM wpk4_backend_user_portal_requests 
						WHERE case_id = %d",
						$case_id
					)
				);

				$prefill_keys = ['bsb', 'account_number'];

				// If a passenger is selected: use per-passenger; if empty, fall back to global meta
				if (!empty($selected_passenger_sanitized)) {
					foreach ($prefill_keys as $k) {
						if ($passenger_data[$k] === '' || $passenger_data[$k] === null) {
							$global_val = get_userportal_post_meta($case_id, $k); // meta_key = 'bsb' or 'account_number'
							if ($global_val !== '' && $global_val !== null) {
								$passenger_data[$k] = $global_val;
							}
						}
					}
				} else {
					// No passenger selected yet: Prefill directly from global meta for these keys
					foreach ($prefill_keys as $k) {
						$global_val = get_userportal_post_meta($case_id, $k);
						if ($global_val !== '' && $global_val !== null) {
							$passenger_data[$k] = $global_val;
						}
					}
				}

				if (!function_exists('payment_method_label')) {
					function payment_method_label($raw) {
						$val = trim((string)$raw);
						if ($val === '') return 'N/A';

						// If it's digits, map by code
						if (ctype_digit($val)) {
						$code = (int)$val;
						$map = [
							3  => 'General Account',
							5  => 'BPOINT',
							6  => 'Contra for vendor payment',
							7  => 'AZUPAY',
							8  => 'Asiapay',
							9  => 'Bpay',
							10 => 'IFN Holding Account',
							11 => 'DKT Offset Account',
							12 => 'CBA',
							13 => 'Mintpay',
							14 => 'Transfer',
							15 => 'TDU Booking',
							16 => 'SlicePay',
						];
						return $map[$code] ?? ('Unknown ('.$val.')');
						}

						// If DB already stores a text label, pass through
						return $val;
					}
				}


				$order_id_for_sum = trim((string)($order_no_display ?? ''));

// Fallback (optional): if empty, try numeric reservation_ref
if ($order_id_for_sum === '' && isset($reservation_ref)) {
    $ref_no_ws = preg_replace('/\s+/', '', (string)$reservation_ref);
    if ($ref_no_ws !== '' && ctype_digit($ref_no_ws)) {
        $order_id_for_sum = $ref_no_ws;
    }
}

$passenger_paid = '0.00';
$payment_method = 'N/A';

if ($order_id_for_sum !== '') {
    // SUM trams_received_amount (VARCHAR-safe). Handles () negatives, unicode minus, $, commas, spaces.
    $sum_sql = "
        SELECT COALESCE(SUM(
            CASE
                WHEN trams_received_amount IS NULL OR TRIM(trams_received_amount) = '' THEN 0
                WHEN INSTR(TRIM(trams_received_amount), '(') > 0 THEN
                    - CAST(
                        REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
                            TRIM(trams_received_amount),
                            '','-'),         -- unicode minus
                            '$',''),
                            ',',''),
                            ' ',''),
                            '(',''),
                            ')','')
                    AS DECIMAL(15,2))
                ELSE
                    CAST(
                        REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
                            TRIM(trams_received_amount),
                            '','-'),
                            '$',''),
                            ',',''),
                            ' ',''),
                            ')','')         -- harmless if no ')'
                    AS DECIMAL(15,2))
            END
        ),0) AS total_paid
        FROM wpk4_backend_travel_payment_history
        WHERE TRIM(order_id) = TRIM(%s)
    ";
    $sum_row = $wpdb->get_row($wpdb->prepare($sum_sql, $order_id_for_sum), ARRAY_A);
    $total_paid_num = isset($sum_row['total_paid']) ? (float)$sum_row['total_paid'] : 0.0;
    $passenger_paid = number_format($total_paid_num, 2, '.', '');

    // Collect payment methods used for this exact order id
    $methods_sql = "
        SELECT GROUP_CONCAT(pm ORDER BY max_auto_id DESC SEPARATOR ',') AS methods
        FROM (
            SELECT payment_method AS pm, MAX(auto_id) AS max_auto_id
            FROM wpk4_backend_travel_payment_history
            WHERE TRIM(order_id) = TRIM(%s)
             AND NULLIF(TRIM(payment_method),'') IS NOT NULL
            GROUP BY payment_method
        ) x
    ";
    $methods_csv = $wpdb->get_var($wpdb->prepare($methods_sql, $order_id_for_sum));

    if (!empty($methods_csv)) {
        $raw_methods = array_filter(array_map('trim', explode(',', $methods_csv)));
        $mapped = [];
        foreach ($raw_methods as $m) {
            $label = payment_method_label($m); // your existing mapper
            if ($label !== '' && $label !== null) { $mapped[] = $label; }
        }
        $mapped = array_unique($mapped);
        $payment_method = !empty($mapped) ? implode(', ', $mapped) : 'N/A';
    }
}



				// Fetch PNR from travel booking pax table
				$pnr = $wpdb->get_var(
					$wpdb->prepare(
						"SELECT pnr FROM wpk4_backend_travel_booking_pax WHERE order_id = %d",
						$order_id_for_sum
					)
				);

				// Fetch reservation_ref from main table
				$reservation_ref = $wpdb->get_var(
					$wpdb->prepare(
						"SELECT reservation_ref FROM wpk4_backend_user_portal_requests WHERE case_id = %d",
						$case_id
					)
				);
				// Fetch sub_status and status
				$sub_status = $wpdb->get_var(
					$wpdb->prepare(
						"SELECT sub_status FROM wpk4_backend_user_portal_requests WHERE case_id = %d",
						$case_id
					)
				);

				$status = $wpdb->get_var(
					$wpdb->prepare(
						"SELECT status FROM wpk4_backend_user_portal_requests WHERE case_id = %d",
						$case_id
					)
				);

				$priority = $wpdb->get_var(
					$wpdb->prepare(
						"SELECT priority FROM wpk4_backend_user_portal_requests WHERE case_id = %d",
						$case_id
					)
				);
			
				// Use sub_status if it exists, otherwise fallback to status
				$final_status = (!empty($sub_status)) ? $sub_status : $status;
				// Fetch priority
				

				// Get airline from meta
				$airline = get_userportal_post_meta($case_id, 'airline');
				$travel_date = get_userportal_post_meta($case_id, 'travel_date');
				?>

				<form action="<?php echo add_query_arg(['cid' => $case_id, 'passenger_name' => $selected_passenger]); ?>" name="statusupdate" method="post" enctype="multipart/form-data" class="refund-form">
				<!-- Name of Passenger -->
				<div class="form-group">
				<label class="fieldnotelable">Name of Passenger</label>
					<div class="form-value">
						<select name="passenger_name" class="form-control" style="height:45px;" id="passenger-select" required>
						<option value="">-- Select Passenger --</option>
						<?php foreach ($dropdown_names as $name):
							$norm = normalize_person_name($name);
							$ticket_for_option = $passengerTicketMap[$norm] ?? '';
							$selected = ($selected_passenger === $name) ? 'selected' : '';
						?>
							<option value="<?php echo esc_attr($name); ?>"
									data-ticket="<?php echo esc_attr($ticket_for_option); ?>"
									data-pnr="<?php echo esc_attr($passengerPNRMap[$norm] ?? ''); ?>"
									<?php echo $selected; ?>>
							<?php echo esc_html($name); ?>
							</option>
						<?php endforeach; ?>
						</select>
					</div>
					</div>

					<!-- Ticket Number (auto-filled) -->
					<div class="form-group">
					<label class="fieldnotelable">Ticket Number</label>
					<input type="text"
							name="ticket_number"
							id="ticket-number"
							class="form-control"
							style="height:45px;background:#f1f1f1;"
							value="<?php echo esc_attr($preSelectedTicket); ?>"
							readonly>
					<input type="hidden" name="ticket_number_raw" id="ticket-number-raw" value="<?php echo esc_attr($preSelectedTicket); ?>">
					<small class="muted">Auto-filled from passengers ticket in pax table</small>
					</div>

					<div class="form-group">
						<label class="fieldnotelable">Email</label>
						<div class="form-value"><?php echo $emailaddress; ?></div>
					</div>
					
					<div class="form-group">
						<label class="fieldnotelable">Passenger Paid</label>
						<input type="number"
								step="0.01"
								min="0"
								inputmode="decimal"
								class="decimal"
								name="passenger_paid"
								value="<?php echo esc_attr($passenger_data['passenger_paid']); ?>"
								placeholder="0.00">
					</div>

					<div class="form-group">
						<label class="fieldnotelable">Cancellation fee</label>
						<input type="number" step="0.01" min="0" inputmode="decimal" class="decimal"
							name="cancellation_fee"
							value="<?php echo esc_attr($passenger_data['cancellation_fee']); ?>"
							placeholder="0.00">
					</div>

					<div class="form-group">
						<label class="fieldnotelable">Refund Amount</label>
						<input type="number" step="0.01" min="0" inputmode="decimal" class="decimal"
							name="refund_amount"
							value="<?php echo esc_attr($passenger_data['refund_amount']); ?>"
							placeholder="0.00">
					</div>

					<div class="form-group">
						<label class="fieldnotelable">Refund received from airline</label>
						<input type="number" step="0.01" min="0" inputmode="decimal" class="decimal"
							name="refund_received_from_airline"
							value="<?php echo esc_attr($passenger_data['refund_received_from_airline']); ?>"
							placeholder="0.00">
					</div>

					<div class="form-group">
						<label class="fieldnotelable">Difference</label>
						<input type="number" step="0.01" min="0" inputmode="decimal" class="decimal"
							name="diff"
							value="<?php echo esc_attr($passenger_data['diff']); ?>"
							placeholder="0.00">
					</div>

					
					<div class="form-group">
						<label class="fieldnotelable">Account Name</label>
						<input type="text" name="account_name" value="<?php echo $passenger_data['account_name']; ?>" >
					</div>
					
					<div class="form-group">
						<label class="fieldnotelable">BSB</label>
						<input type="text" id="bsb_view" value="<?php echo esc_attr($passenger_data['bsb']); ?>" disabled>
					</div>

					<div class="form-group">
						<label class="fieldnotelable">Account Number</label>
						<input type="text" id="account_number_view" value="<?php echo esc_attr($passenger_data['account_number']); ?>" disabled>
					</div>


										
					<div class="form-group">
					<label class="fieldnotelable">PNR</label>
					<input type="text"
							name="pnr"
							id="pnr-field"
							class="form-control"
							style="height:45px;background:#f1f1f1;"
							value="<?php echo esc_attr($preSelectedPNR); ?>"
							readonly>
					<input type="hidden" name="pnr_raw" id="pnr-raw" value="<?php echo esc_attr($preSelectedPNR); ?>">
					</div>

					
					<div class="form-group">
						<label class="fieldnotelable">Order No</label>
						<div class="form-value"><?php echo esc_html($order_no_display); ?></div>
					</div>
					
					<div class="form-group">
						<label class="fieldnotelable">Payment Method</label>
						<div class="form-value"><?php echo esc_html($payment_method); ?></div>
					</div>
					
					<div class="form-group">
						<label class="fieldnotelable">Refund received date</label>
						<input type="text" name="refund_received_date" id="refundreceiveddate" value="<?php echo $passenger_data['refund_received_date']; ?>">
					</div>
					
					<div class="form-group">
						<label class="fieldnotelable">Refund vendor</label>
						<select name="vendor">
							<option value="">-- Select Vendor --</option>
							<option value="Air Tickets" <?php if($passenger_data['vendor'] == 'Air Tickets') echo 'selected'; ?>>Air Tickets</option>
							<option value="Sunrate Tickets" <?php if($passenger_data['vendor'] == 'Sunrate Tickets') echo 'selected'; ?>>Sunrate Tickets</option>
							<option value="AirPlus" <?php if($passenger_data['vendor'] == 'AirPlus') echo 'selected'; ?>>AirPlus</option>
							<option value="Consolidated Travel" <?php if($passenger_data['vendor'] == 'Consolidated Travel') echo 'selected'; ?>>Consolidated Travel</option>
							<option value="Gilpin" <?php if($passenger_data['vendor'] == 'Gilpin') echo 'selected'; ?>>Gilpin</option>
							<option value="GKT IATA" <?php if($passenger_data['vendor'] == 'GKT IATA') echo 'selected'; ?>>GKT IATA</option>
							<option value="IFN IATA" <?php if($passenger_data['vendor'] == 'IFN IATA') echo 'selected'; ?>>IFN IATA</option>
							<option value="ETG" <?php if($passenger_data['vendor'] == 'ETG') echo 'selected'; ?>>ETG</option>
						</select>
					</div>
					
					<div class="form-group">
						<label class="fieldnotelable">Type</label>
						<select name="booking_type">
							<?php
							$query_get_field_meta = "SELECT * FROM wpk4_backend_term_keys WHERE category='refund' && option_type='booking type'";
							$result_get_field_meta = mysqli_query($mysqli, $query_get_field_meta);
							while($row_get_field_meta = mysqli_fetch_assoc($result_get_field_meta)) {
							?>
							<option value="<?php echo $row_get_field_meta['option_value']; ?>" <?php if($passenger_data['booking_type'] == $row_get_field_meta['option_value']) { echo 'selected'; } ?>>
								<?php echo $row_get_field_meta['option_value']; ?>
							</option>
							<?php } ?>
						</select>
					</div>
					
					<?php if(current_user_can('administrator')) { ?>
					<div class="form-group">
						<label class="fieldnotelable">Remark</label>
						<textarea rows="6" name="remarks" class="send-message-text"><?php echo $passenger_data['remarks']; ?></textarea>
					</div>
					<?php } ?>
					
					<?php
					$today = current_time('Y-m-d');
					$submitted_val = $passenger_data['submitted_date'] ?: $today;
					?>
					<div class="form-group">
					<label class="fieldnotelable">Submitted Date</label>
					<input type="text" name="submitted_date" id="submitteddate" class="form-control readonly-field" value="<?php echo esc_attr($submitted_val); ?>" readonly aria-readonly="true">
					</div>

					<style>
						.readonly-field { background:#f1f1f1; pointer-events:none; }
					</style>
					
					<div class="form-group">
						<label class="fieldnotelable">Airline</label>
						<div class="form-value"><?php echo esc_html($airline_display); ?></div>
					</div>

					
					<div class="form-group">
						<label class="fieldnotelable">Case ID</label>
						<div class="form-value"><?php echo $case_id; ?></div>
					</div>
					
					<div class="form-group">
						<label class="fieldnotelable">Travel Date</label>
						<div class="form-value"><?php echo $travel_date; ?></div>
					</div>
					
					<div class="form-group">
						<label class="fieldnotelable">Status</label>
						<div class="form-value"><?php echo esc_html($final_status ?: 'N/A'); ?></div>
					</div>

					<div class="form-group">
						<label class="fieldnotelable">Priority</label>
						<div class="form-value"><?php echo esc_html($priority ?: 'N/A'); ?></div>
					</div>
					
					<div class="form-group text-center">
						<input type="submit" name="add_more" class="btn btn-success" value="Add more">
						<input type="submit" name="refund_save_changes" class="btn btn-success" value="Submit">
					</div>


				<style>
				.refund-form {
					max-width: 700px;
					margin: 20px auto;
					padding: 20px;
					background: #fafafa;
					border: 1px solid #ddd;
					border-radius: 8px;
					font-family: Arial, sans-serif;
					}

					.refund-form .form-group {
					margin-bottom: 15px;
					}

					.refund-form .fieldnotelable {
					display: block;
					font-weight: bold;
					margin-bottom: 5px;
					color: #333;
					}

					.refund-form .form-value {
					padding: 8px 10px;
					background: #f1f1f1;
					border-radius: 5px;
					}

					.refund-form input[type="text"],
					.refund-form select,
					.refund-form textarea {
					width: 100%;
					padding: 10px;
					border: 1px solid #bbb;
					border-radius: 5px;
					font-size: 14px;
					box-sizing: border-box;
					}

					.refund-form textarea {
					resize: vertical;
					}

					.refund-form input[type="submit"] {
					padding: 10px 20px;
					font-size: 16px;
					border: none;
					border-radius: 6px;
					cursor: pointer;
					background: #28a745;
					color: #fff;
					transition: background 0.3s;
					}

					.refund-form input[type="submit"]:hover {
					background: #218838;
					}

					.refund-form .text-center {
					text-align: center;
					}
					</style>
					<script>
					(function(){
					function updateFieldsFromOption() {
						var sel     = document.getElementById('passenger-select');
						var tOut    = document.getElementById('ticket-number');
						var tHidden = document.getElementById('ticket-number-raw');
						var pOut    = document.getElementById('pnr-field');   // NEW
						var pHidden = document.getElementById('pnr-raw');     // NEW
						if (!sel) return;

						var opt    = sel.options[sel.selectedIndex] || null;
						var ticket = opt ? (opt.getAttribute('data-ticket') || '') : '';
						var pnr    = opt ? (opt.getAttribute('data-pnr')    || '') : '';

						if (tOut)    tOut.value = ticket;
						if (tHidden) tHidden.value = ticket;
						if (pOut)    pOut.value = pnr;        // NEW
						if (pHidden) pHidden.value = pnr;     // NEW
					}

					document.addEventListener('DOMContentLoaded', updateFieldsFromOption);
					document.addEventListener('change', function(e){
						if (e.target && e.target.id === 'passenger-select') updateFieldsFromOption();
					});
					})();
					</script>



				</form>

				<?php
				if(isset($_POST['refund_save_changes']))
				{
					$current_date_time = date('Y-m-d H:i:s');
					$allowed_status   = ['open','pending','closed'];
					$allowed_priority = ['High','Medium','Low'];

					$new_status   = isset($_POST['status'])   ? strtolower(sanitize_text_field($_POST['status']))   : '';
					$new_priority = isset($_POST['priority']) ? sanitize_text_field($_POST['priority'])             : '';

					if ($new_status !== '' && in_array($new_status, $allowed_status, true)) {
						$ok = $wpdb->query(
							$wpdb->prepare(
								"UPDATE wpk4_backend_user_portal_requests SET `status` = %s WHERE case_id = %d",
								$new_status, (int)$case_id
							)
						);
						if ($ok === false) { error_log('Status update failed: '.$wpdb->last_error); }
					}

					if ($new_priority !== '' && in_array($new_priority, $allowed_priority, true)) {
						$ok = $wpdb->query(
							$wpdb->prepare(
								"UPDATE wpk4_backend_user_portal_requests SET priority = %s WHERE case_id = %d",
								$new_priority, $case_id
							)
						);
					}
					
					$skip_meta_keys = ['status','priority'];
					foreach ($_POST as $meta_key => $meta_value) {
						if (in_array($meta_key, $skip_meta_keys, true)) { continue; }
						$meta_value = mysqli_real_escape_string($mysqli, $meta_value);
						$meta_key = mysqli_real_escape_string($mysqli, $meta_key);
						
						$update_query = "UPDATE wpk4_backend_user_portal_request_meta SET meta_value = '$meta_value' WHERE case_id = '$case_id' AND meta_key = '$meta_key'";
						
						$result = mysqli_query($mysqli, $update_query);

						if (!$result) {
						  die("Error: " . mysqli_error($mysqli));
						}
						
						
						if($meta_key == 'stage')
						{
							if($meta_value == 'Refund Applied to Airlines')
							{
								$update_query_stage = "UPDATE wpk4_backend_user_portal_request_meta SET meta_value = '$current_date_time' WHERE case_id = '$case_id' AND meta_key = 'refund_applied_to_airline_date'";	
								$result = mysqli_query($mysqli, $update_query_stage);
							}
							
							if($meta_value == 'Refund received from Consolidator')
							{
								$update_query_stage = "UPDATE wpk4_backend_user_portal_request_meta SET meta_value = '$current_date_time' WHERE case_id = '$case_id' AND meta_key = 'refund_received_from_consolidator'";	
								$result = mysqli_query($mysqli, $update_query_stage);
							}
							
							if($meta_value == 'Refund Process to Passenger')
							{
								$update_query_stage = "UPDATE wpk4_backend_user_portal_request_meta SET meta_value = '$current_date_time' WHERE case_id = '$case_id' AND meta_key = 'refund_processed_date'";	
								$result = mysqli_query($mysqli, $update_query_stage);
							}
							
							if($meta_value == 'Refund Applied to Airlines' || $meta_value == 'Refund received from Consolidator' || $meta_value == 'Refund Process to Passenger')
							{
								if($meta_value == 'Refund Applied to Airlines')
								{
									$replymessage = 'Refund Applied to Airlines';
								}
								else if($meta_value == 'Refund received from Consolidator')
								{
									$replymessage = 'Refund received from Consolidator';
								}
								else
								{
									$replymessage = 'Refund Process to Passenger';
								}
								
								$querytoAdd = mysqli_query($mysqli,"insert into wpk4_backend_user_portal_request_chats (request_id,response,response_time,response_by,status,request_type,chat_or_note,member_name) values ('$case_id','$replymessage','$current_date_time','$currnt_userlogined','open','refund','status','')") or die(mysqli_error($mysqli));
							
								
							}
						}						
					}
					
					echo '<script>alert("Change has been updated");</script>';
					$enc_case_id = md5($case_id);

					if (isset($_POST['add_more'])) {
						echo "<script>alert('Added successfully!');</script>";
					}

				}

				
				}
				
			}
		} //end if checkadmin
		
		else if (isset($_GET['p']) && !isset($_SESSION['userId']) && $user_role== '')
		{
			echo '<script>window.location.href="https://gauratravel.com.au/customer-portal/";</script>';
		}
		
if(isset($_GET['p']) && $_GET['p'] =='refund-print-view') //admin dashboard
			{
			?>
				<?php
				
				// view table
				global $wpdb;

				if (!function_exists('normalize_passenger_key')) {
					function normalize_passenger_key($name) {
						$key = sanitize_title($name);
						return strtolower(trim($key));
					}
				}

				if (!function_exists('update_userportal_post_meta')) {
					function update_userportal_post_meta($case_id, $meta_key, $meta_value, &$messages) {
						global $wpdb;
						$table = 'wpk4_backend_user_portal_request_meta';

						$meta_key = strtolower(trim($meta_key));

						// Check if a row exists for (case_id, meta_key)
						$exists = $wpdb->get_var(
							$wpdb->prepare(
								"SELECT COUNT(*) 
								FROM {$table} 
								WHERE case_id = %d 
								AND LOWER(TRIM(meta_key)) = LOWER(TRIM(%s))",
								$case_id,
								$meta_key
							)
						);

						if ($exists > 0) {
							$wpdb->update(
								$table,
								[ 'meta_value' => $meta_value ],
								[ 'case_id' => $case_id, 'meta_key' => $meta_key ],
								[ '%s' ],
								[ '%d','%s' ]
							);
							$messages[] = '<div style="color:green;font-weight:bold;">Updated: '
										. esc_html($meta_key) . ' = ' . esc_html($meta_value) . '</div>';
						} else {
							$wpdb->insert(
								$table,
								[
									'case_id'    => $case_id,
									'meta_key'   => $meta_key,
									'meta_value' => $meta_value,
								],
								[ '%d', '%s', '%s' ]
							);
							$messages[] = '<div style="color:orange;font-weight:bold;">Inserted: '
										. esc_html($meta_key) . ' = ' . esc_html($meta_value) . '</div>';
						}
					}
				}

				$case_id = intval($_GET['cid'] ?? 0);

				$query_refund = "SELECT * FROM wpk4_backend_user_portal_requests WHERE case_id='$case_id'";
				$result_refund = mysqli_query($mysqli, $query_refund);
				$row_refund = mysqli_fetch_assoc($result_refund);

				$created_on      = $row_refund['case_date'];
				$passenger_names = get_userportal_post_meta($case_id, 'passenger_names');
				$emailaddress    = get_userportal_post_meta($case_id, 'email_address');
				$passenger_paid  = get_userportal_post_meta($case_id, 'passenger_paid');
				$payment_method  = get_userportal_post_meta($case_id, 'payment_method');
				$airline         = get_userportal_post_meta($case_id, 'airline');
				$travel_date     = get_userportal_post_meta($case_id, 'travel_date');

				// --- Reservation Ref ---
				$reservation_ref = $wpdb->get_var(
					$wpdb->prepare("SELECT reservation_ref FROM wpk4_backend_user_portal_requests WHERE case_id = %d", $case_id)
				);

				// --- Ticket Numbers ---
				if (ctype_digit($reservation_ref)) {
					$ticket_numbers_arr = $wpdb->get_col(
						$wpdb->prepare("SELECT ticket_number FROM wpk4_backend_travel_booking_pax WHERE order_id = %s", $reservation_ref)
					);
				} else {
					$ticket_numbers_arr = $wpdb->get_col(
						$wpdb->prepare("SELECT ticket_number FROM wpk4_backend_travel_booking_pax WHERE pnr = %s", $reservation_ref)
					);
				}
				$ticket_numbers_display = !empty($ticket_numbers_arr) ? implode(', ', $ticket_numbers_arr) : 'N/A';

				// --- PNR ---
				if (ctype_digit($reservation_ref)) {
					$pnr_arr = $wpdb->get_col(
						$wpdb->prepare("SELECT pnr FROM wpk4_backend_travel_booking_pax WHERE order_id = %s", $reservation_ref)
					);
				} else {
					$pnr_arr = $wpdb->get_col(
						$wpdb->prepare("SELECT pnr FROM wpk4_backend_travel_booking_pax WHERE pnr = %s", $reservation_ref)
					);
				}
				$pnr_display = !empty($pnr_arr) ? implode(', ', $pnr_arr) : 'N/A';

				// --- Order No ---
				if (ctype_digit($reservation_ref)) {
					$order_no_arr = [$reservation_ref];
				} else {
					$order_no_arr = $wpdb->get_col(
						$wpdb->prepare("SELECT order_id FROM wpk4_backend_travel_booking_pax WHERE pnr = %s", $reservation_ref)
					);
				}
				$order_no_display = !empty($order_no_arr) ? implode(', ', $order_no_arr) : 'N/A';

				// --- Status & Priority ---
				$sub_status = $row_refund['sub_status'] ?? '';
				$status     = $row_refund['status'] ?? '';
				$final_status = !empty($sub_status) ? $sub_status : $status;

				$priority = $row_refund['priority'] ?? '';

				$messages = [];
				//'Passenger Paid', 'Payment Method'
				// Step 1: Get reservation_ref from main table
				$reservation_ref = $wpdb->get_var(
					$wpdb->prepare(
						"SELECT reservation_ref 
						FROM wpk4_backend_user_portal_requests 
						WHERE case_id = %d",
						$case_id
					)
				);

				if (!function_exists('payment_method_label')) {
					function payment_method_label($raw) {
						$val = trim((string)$raw);
						if ($val === '') return 'N/A';

						// If it's digits, map by code
						if (ctype_digit($val)) {
						$code = (int)$val;
						$map = [
							3  => 'General Account',
							5  => 'BPOINT',
							6  => 'Contra for vendor payment',
							7  => 'AZUPAY',
							8  => 'Asiapay',
							9  => 'Bpay',
							10 => 'IFN Holding Account',
							11 => 'DKT Offset Account',
							12 => 'CBA',
							13 => 'Mintpay',
							14 => 'Transfer',
							15 => 'TDU Booking',
							16 => 'SlicePay',
						];
						return $map[$code] ?? ('Unknown ('.$val.')');
						}

						// If DB already stores a text label, pass through
						return $val;
					}
				}

				// --- Passenger Paid & Payment Method (sum + latest method) ---
				$order_id_for_sum = trim((string)($order_no_display ?? ''));

				// Fallback (optional): if empty, try numeric reservation_ref
				if ($order_id_for_sum === '' && isset($reservation_ref)) {
					$ref_no_ws = preg_replace('/\s+/', '', (string)$reservation_ref);
					if ($ref_no_ws !== '' && ctype_digit($ref_no_ws)) {
						$order_id_for_sum = $ref_no_ws;
					}
				}

				$passenger_paid = '0.00';
				$payment_method = 'N/A';

				if ($order_id_for_sum !== '') {

					$methods_sql = "
						SELECT GROUP_CONCAT(pm ORDER BY max_auto_id DESC SEPARATOR ',') AS methods
						FROM (
							SELECT payment_method AS pm, MAX(auto_id) AS max_auto_id
							FROM wpk4_backend_travel_payment_history
							WHERE TRIM(order_id) = TRIM(%s)
							AND NULLIF(TRIM(payment_method),'') IS NOT NULL
							GROUP BY payment_method
						) x
					";
					$methods_csv = $wpdb->get_var($wpdb->prepare($methods_sql, $order_id_for_sum));

					if (!empty($methods_csv)) {
						$raw_methods = array_filter(array_map('trim', explode(',', $methods_csv)));
						$mapped = [];
						foreach ($raw_methods as $m) {
							$label = payment_method_label($m); // your existing mapper
							if ($label !== '' && $label !== null) { $mapped[] = $label; }
						}
						$mapped = array_unique($mapped);
						$payment_method = !empty($mapped) ? implode(', ', $mapped) : 'N/A';
					}
				}

				
				if (!function_exists('normalize_person_name')) {
					function normalize_person_name($name) {
						$name = strtoupper(trim((string)$name));
						$name = preg_replace('/^(MR|MRS|MISS|MS|MSTR|MASTER|DR|PROF|SHRI|SMT|MDM|MADAM)\s+/i', '', $name);
						$name = str_replace(['/', '\\', ',', ';', '|'], ' ', $name);
						$name = preg_replace('/[^A-Z0-9 ]+/', '', $name);
						$name = preg_replace('/\s+/', ' ', $name);
						$parts = explode(' ', trim($name));
						if (count($parts) >= 2) $name = $parts[0].' '.end($parts); // first + last
						return trim($name);
					}
				}


				$reservation_ref = trim((string)$reservation_ref);
				$ref_no_ws = preg_replace('/\s+/', '', $reservation_ref);
				$is_order = ($ref_no_ws !== '' && ctype_digit($ref_no_ws));

				$pax_rows = $wpdb->get_results(
					$wpdb->prepare(
						"SELECT 
						COALESCE(NULLIF(fname,''), '') AS fname,
						COALESCE(NULLIF(lname,''), '') AS lname,
						ticket_number, pnr
						FROM wpk4_backend_travel_booking_pax
						WHERE ".($is_order ? "order_id=%s" : "pnr=%s"),
						$is_order ? $ref_no_ws : $reservation_ref
					),
					ARRAY_A
				);
				if (!is_array($pax_rows)) $pax_rows = [];

				$pax_display_names = [];
				foreach ($pax_rows as $r) {
				$fn = $r['fname'];
				$ln = $r['lname'];
				$display = trim($fn.' '.$ln);
				if ($display !== '') $pax_display_names[] = $display;
				}
				$pax_display_names = array_values(array_unique($pax_display_names));

				$ticketMap = [];  // normalized name -> ticket_number
				$pnrMap    = [];  // normalized name -> pnr
                
				foreach ($pax_rows as $r) {
					$fn = $r['fname'];
					$ln = $r['lname'];
					$display = trim($fn.' '.$ln);
					$ticket  = trim((string)($r['ticket_number'] ?? ''));
					$pnr     = trim((string)($r['pnr'] ?? ''));
					if ($display !== '') {
						$k1 = normalize_person_name($display);           // FIRST LAST
						$k2 = normalize_person_name($ln.' '.$fn);        // LAST FIRST (safety)
						if ($k1 !== '') { $ticketMap[$k1] = $ticket; $pnrMap[$k1] = $pnr; }
						if ($k2 !== '') { $ticketMap[$k2] = $ticket; $pnrMap[$k2] = $pnr; }
					}
				}

				$account_name_global   = trim((string) get_userportal_post_meta($case_id, 'account_name'));
				$bsb_global            = trim((string) get_userportal_post_meta($case_id, 'bsb'));
				$account_number_global = trim((string) get_userportal_post_meta($case_id, 'account_number'));

				$account_name_display   = ($account_name_global   !== '') ? $account_name_global   : 'N/A';
				$bsb_display            = ($bsb_global            !== '') ? $bsb_global            : 'N/A';
				$account_number_display = ($account_number_global !== '') ? $account_number_global : 'N/A';


				?>


				<div class="ui-card">
					<div class="ui-bar">
						<h3 class="ui-title">Customer Information</h3>
						<div class="ui-subtitle">Review and edit refund details per passenger</div>
					</div>
					<div class="table-wrap">
				<table class="refund-table" id="passengerTable">
					<thead>
						<tr>
							<th>Ticket Number</th>
							<th>Passenger Name</th>
							<th>Email</th>
							<th>Passenger Paid</th>
							<th>Cancellation Fee</th>
							<th>Refund Amount</th>
							<th>Refund received from airline</th>
							<th>Diff</th>
							<th>Account Name</th>
							<th>BSB</th>
							<th>Account Number</th>
							<th>PNR</th>
							<th>Order No</th>
							<th>Payment Method</th>
							<th>Refund received date</th>
							<th>Refund vendor</th>
							<th>Type</th>
							<th>Remark</th>
							<th>Submitted Date</th>
							<th>Airline</th>
							<th>Case ID</th>
							<th>Travel Date</th>
							<th>Status</th>
							<th>Priority</th>
						</tr>
					</thead>
					<tbody>
						<?php
						// $names = explode(",", $passenger_names);
						// $names = array_filter(array_map('trim', $names));

						foreach ($pax_display_names as $index => $name) {
							$sanitized_name = normalize_passenger_key($name);

							$passenger_paid                 = get_userportal_post_meta($case_id, 'passenger_paid' . '--' . $sanitized_name);
							$passenger_cancellation_fee   = get_userportal_post_meta($case_id, 'cancellation_fee' . '--' . $sanitized_name);
							$passenger_refund_amount      = get_userportal_post_meta($case_id, 'refund_amount' . '--' . $sanitized_name);
							$passenger_refund_received    = get_userportal_post_meta($case_id, 'refund_received_from_airline' . '--' . $sanitized_name);
							$passenger_diff               = get_userportal_post_meta($case_id, 'diff' . '--' . $sanitized_name);
							$passenger_account_name       = get_userportal_post_meta($case_id, 'account_name' . '--' . $sanitized_name);
							$passenger_bsb                = get_userportal_post_meta($case_id, 'bsb' . '--' . $sanitized_name);
							$passenger_account_number     = get_userportal_post_meta($case_id, 'account_number' . '--' . $sanitized_name);
							$passenger_refund_received_date = get_userportal_post_meta($case_id, 'refund_received_date' . '--' . $sanitized_name);
							$passenger_vendor             = get_userportal_post_meta($case_id, 'vendor' . '--' . $sanitized_name);
							$passenger_booking_type       = get_userportal_post_meta($case_id, 'booking_type' . '--' . $sanitized_name);
							$passenger_remarks            = get_userportal_post_meta($case_id, 'remarks' . '--' . $sanitized_name);
							$passenger_submitted_date     = get_userportal_post_meta($case_id, 'submitted_date' . '--' . $sanitized_name);
						?>
						<tr data-passenger="<?php echo $sanitized_name; ?>">
							<?php
								// $name is the display name from your loop
								$normName = normalize_person_name($name);
								$rowTicket = $ticketMap[$normName] ?? '';
								$rowPNR    = $pnrMap[$normName]    ?? '';
							?>
							<!-- Read-only fields -->
							<td><?php echo esc_html($rowTicket ?: ''); ?></td>
							<td><?php echo esc_html($name); ?></td>
							<td><?php echo esc_html($emailaddress); ?></td>
							
							<!-- Editable fields -->
							<td>
								<span class="view-mode"><?php echo esc_html($passenger_paid	); ?></span>
								<input type="number" name="passenger_paid[<?php echo $sanitized_name; ?>]" value="<?php echo esc_attr($passenger_paid); ?>" class="edit-mode" style="display: none;" min="0">
							</td>
							<td>
								<span class="view-mode"><?php echo esc_html($passenger_cancellation_fee); ?></span>
								<input type="number" name="cancellation_fee[<?php echo $sanitized_name; ?>]" value="<?php echo esc_attr($passenger_cancellation_fee); ?>" class="edit-mode" style="display: none;" min="0">
							</td>
							<td>
								<span class="view-mode"><?php echo esc_html($passenger_refund_amount); ?></span>
								<input type="number" name="refund_amount[<?php echo $sanitized_name; ?>]" value="<?php echo esc_attr($passenger_refund_amount); ?>" class="edit-mode" style="display: none;" min="0">
							</td>
							<td>
								<span class="view-mode"><?php echo esc_html($passenger_refund_received); ?></span>
								<input type="number" name="refund_received_from_airline[<?php echo $sanitized_name; ?>]" value="<?php echo esc_attr($passenger_refund_received); ?>" class="edit-mode" style="display: none;" min="0">
							</td>
							<td>
								<span class="view-mode"><?php echo esc_html($passenger_diff); ?></span>
								<input type="number" name="diff[<?php echo $sanitized_name; ?>]" value="<?php echo esc_attr($passenger_diff); ?>" class="edit-mode" style="display: none;" min="0">
							</td>
							<!-- Account Name (global) -->
							<td>
								<span class="view-mode keep-visible"><?php echo esc_html($account_name_display); ?></span>
								<!-- no edit input -->
							</td>

							<!-- BSB (global) -->
							<td>
								<span class="view-mode keep-visible"><?php echo esc_html($bsb_display); ?></span>
							<!-- no edit input -->
							</td>

							<!-- Account Number (global) -->
							<td>
								<span class="view-mode keep-visible"><?php echo esc_html($account_number_display); ?></span>
							<!-- no edit input -->
							</td>


							<!-- Read-only fields -->
							<td><?php echo esc_html($rowPNR   ?: ''); ?></td>
							<td><?php echo esc_html($order_no_display); ?></td>
							<td><?php echo $payment_method; ?></td>

							<!-- Editable fields -->
							<td>
								<span class="view-mode"><?php echo esc_html($passenger_refund_received_date); ?></span>
								<input type="text" name="refund_received_date[<?php echo $sanitized_name; ?>]" value="<?php echo esc_attr($passenger_refund_received_date); ?>" class="edit-mode" style="display: none;">
							</td>
							<td>
								<span class="view-mode"><?php echo esc_html($passenger_vendor); ?></span>
								<select name="vendor[<?php echo $sanitized_name; ?>]" class="edit-mode" style="display: none;">
									<option value="">-- Select Vendor --</option>
									<option value="Air Tickets" <?php if($passenger_vendor == 'Air Tickets') echo 'selected'; ?>>Air Tickets</option>
									<option value="Sunrate Tickets" <?php if($passenger_vendor == 'Sunrate Tickets') echo 'selected'; ?>>Sunrate Tickets</option>
									<option value="AirPlus" <?php if($passenger_vendor == 'AirPlus') echo 'selected'; ?>>AirPlus</option>
									<option value="Consolidated Travel" <?php if($passenger_vendor == 'Consolidated Travel') echo 'selected'; ?>>Consolidated Travel</option>
									<option value="Gilpin" <?php if($passenger_vendor == 'Gilpin') echo 'selected'; ?>>Gilpin</option>
									<option value="GKT IATA" <?php if($passenger_vendor == 'GKT IATA') echo 'selected'; ?>>GKT IATA</option>
									<option value="IFN IATA" <?php if($passenger_vendor == 'IFN IATA') echo 'selected'; ?>>IFN IATA</option>
									<option value="ETG" <?php if($passenger_vendor == 'ETG') echo 'selected'; ?>>ETG</option>
								</select>
							</td>
							<td>
								<span class="view-mode"><?php echo esc_html($passenger_booking_type); ?></span>
								<select name="booking_type[<?php echo $sanitized_name; ?>]" class="edit-mode" style="display: none;">
									<?php
									$query_get_field_meta = "SELECT * FROM wpk4_backend_term_keys WHERE category='refund' && option_type='booking type'";
									$result_get_field_meta = mysqli_query($mysqli, $query_get_field_meta);
									while($row_get_field_meta = mysqli_fetch_assoc($result_get_field_meta)) {
									?>
									<option value="<?php echo $row_get_field_meta['option_value']; ?>" <?php if($passenger_booking_type == $row_get_field_meta['option_value']) { echo 'selected'; } ?>>
										<?php echo $row_get_field_meta['option_value']; ?>
									</option>
									<?php } ?>
								</select>
							</td>
							<td>
								<span class="view-mode"><?php echo esc_html($passenger_remarks); ?></span>
								<textarea name="remarks[<?php echo $sanitized_name; ?>]" class="edit-mode" style="display: none; width: 100%; height: 60px;"><?php echo esc_textarea($passenger_remarks); ?></textarea>
							</td>
							<td>
								<span class="view-mode"><?php echo esc_html($passenger_submitted_date); ?></span>
								<input type="text" name="submitted_date[<?php echo $sanitized_name; ?>]" value="<?php echo esc_attr($passenger_submitted_date); ?>" readonly style="display: none; background:#f1f1f1; pointer-events:none;">
							</td>

							<!-- Read-only fields -->
							<td><?php echo esc_html($airline); ?></td>
							<td><?php echo esc_html($case_id); ?></td>
							<td><?php echo esc_html($travel_date); ?></td>

							<!-- New Status & Priority -->
							<td><?php echo esc_html($final_status); ?></td>
							<td><?php echo esc_html($priority); ?></td>
						</tr>
						<?php } ?>
					</tbody>
				</table>
			</div>


				<!-- Edit and Save buttons placed below the table -->
				  <div class="toolbar">
					<button id="editTableBtn" class="btn btn-primary">Edit Table</button>
					<button id="saveTableBtn" class="btn btn-success" style="display:none;">Save All Changes</button>
					<button id="cancelEditBtn" class="btn btn-secondary" style="display:none;">Cancel</button>
				</div>
				</div>

				<form id="bulkEditForm" method="post" action="<?php echo $_SERVER['REQUEST_URI']; ?>">
					<input type="hidden" name="bulk_edit" value="1">
					<input type="hidden" name="case_id" value="<?php echo $case_id; ?>">
					<div id="formDataContainer"></div>
				</form>

				<script>
				document.addEventListener('DOMContentLoaded', function() {
					const editTableBtn = document.getElementById('editTableBtn');
					const saveTableBtn = document.getElementById('saveTableBtn');
					const cancelEditBtn = document.getElementById('cancelEditBtn');
					const passengerTable = document.getElementById('passengerTable');
					const bulkEditForm = document.getElementById('bulkEditForm');

					let originalData = {};

					editTableBtn.addEventListener('click', function() {
						originalData = {};
						passengerTable.querySelectorAll('tbody tr').forEach(row => {
						const passenger = row.dataset.passenger;
						originalData[passenger] = {};
						row.querySelectorAll('.edit-mode').forEach(input => {
							originalData[passenger][input.name] = input.value;
						});
						});

						passengerTable.querySelectorAll('.view-mode').forEach(el => el.style.display = 'none');
						passengerTable.querySelectorAll('.edit-mode').forEach(el => el.style.display = '');
						editTableBtn.style.display = 'none';
						saveTableBtn.style.display = '';
						cancelEditBtn.style.display = '';

						/* NEW: add editing class for styling */
						passengerTable.classList.add('is-editing');
					});

					cancelEditBtn.addEventListener('click', function() {
						passengerTable.querySelectorAll('tbody tr').forEach(row => {
						const passenger = row.dataset.passenger;
						row.querySelectorAll('.edit-mode').forEach(input => {
							if (originalData[passenger] && originalData[passenger][input.name] !== undefined) {
							input.value = originalData[passenger][input.name];
							}
						});
						});

						passengerTable.querySelectorAll('.view-mode').forEach(el => el.style.display = '');
						passengerTable.querySelectorAll('.edit-mode').forEach(el => el.style.display = 'none');
						editTableBtn.style.display = '';
						saveTableBtn.style.display = 'none';
						cancelEditBtn.style.display = 'none';

						/* NEW: remove editing class */
						passengerTable.classList.remove('is-editing');
					});
					
					// Save all changes
					saveTableBtn.addEventListener('click', function(e) {
					e.preventDefault();

					if (!passengerTable) {
						console.error('No passengerTable found');
						alert('Internal error: table not found.');
						return;
					}
					if (!bulkEditForm) {
						console.error('No bulkEditForm found');
						alert('Internal error: form not found.');
						return;
					}

					const rows = passengerTable.querySelectorAll('tbody tr[data-passenger]');
						if (!rows.length) {
						console.warn('No editable rows found');
						alert('No rows to save.');
						return;
					}

					// Remove old hidden inputs we created earlier
					bulkEditForm.querySelectorAll('input[type="hidden"][data-auto="1"]').forEach(el => el.remove());

					let hiddenCount = 0;
					rows.forEach(row => {
					const passenger = row.dataset.passenger;
					if (!passenger) return;

					// Collect all editable fields in the row
					const fields = row.querySelectorAll('.edit-mode'); // inputs, selects, textareas all can have .edit-mode

					fields.forEach(field => {
						
						const baseName = (field.name || '').replace(/\[.*\]$/, ''); // strip [..]
						if (!baseName) return;

						const value = (field.tagName === 'SELECT')
						? field.options[field.selectedIndex]?.value ?? ''
						: field.value;

						const hidden = document.createElement('input');
						hidden.type  = 'hidden';
						hidden.setAttribute('data-auto','1'); 
						hidden.name  = `data[${passenger}][${baseName}]`;
						hidden.value = value;
						bulkEditForm.appendChild(hidden);
						hiddenCount++;
					});
					});

					// Optional: add a nonce if youre validating in PHP 
					if (!bulkEditForm.querySelector('input[name="_wpnonce_bulk_edit"]')) {
						const nonce = document.createElement('input');
						nonce.type = 'hidden';
						nonce.name = '_wpnonce_bulk_edit';
						nonce.value = '<?php echo wp_create_nonce("bulk_edit_refund"); ?>';
						nonce.setAttribute('data-auto','1');
						bulkEditForm.appendChild(nonce);
					}

					console.log('Submitting bulk edit with', hiddenCount, 'fields');
					// Quick peek at what were sending (first 10 inputs)
					console.log(
					Array.from(bulkEditForm.querySelectorAll('input[type="hidden"][data-auto="1"]'))
						.slice(0,10)
						.map(i => ({ name: i.name, value: i.value }))
					);

					// Submit
					try {
					bulkEditForm.submit();
					} catch (err) {
					console.error('Form submit failed:', err);
					alert('Submit failed. Check console for details.');
					return;
					}

					passengerTable.classList.remove('is-editing');
				});
				});
				</script>

				<style>
					/* ---------- Theme tokens ---------- */
					:root{
					--brand: #ffbb00;            /* your brand accent */
					--bg: #f7f9fc;               /* page background */
					--card: #ffffff;             /* card surface */
					--text: #1f2937;             /* primary text */
					--muted: #6b7280;            /* secondary text */
					--border: #e5e7eb;           /* hairline borders */
					--ring: rgba(255,187,0,0.35);/* focus ring */
					--shadow: 0 10px 20px rgba(17,24,39,0.06), 0 2px 6px rgba(17,24,39,0.04);
					}

					/* Page/card */
					.ui-card{
					background: var(--card);
					border: 1px solid var(--border);
					border-radius: 16px;
					box-shadow: var(--shadow);
					padding: 14px 16px 6px;
					margin: 16px 0 24px;
					}

					.ui-bar{
					display: grid;
					gap: 2px;
					padding: 4px 2px 10px;
					border-bottom: 1px solid var(--border);
					}
					.ui-title{
					margin: 0;
					font-size: 18px;
					line-height: 1.25;
					color: var(--text);
					font-weight: 700;
					letter-spacing: .2px;
					}
					.ui-subtitle{
					font-size: 12px;
					color: var(--muted);
					}

					/* Table container with subtle scroll hint */
					.table-wrap{
					position: relative;
					margin: 10px -2px 8px;
					padding: 0 2px;
					overflow: auto;
					background: linear-gradient(to right, rgba(0,0,0,0.03), rgba(0,0,0,0)) left/14px 100% no-repeat,
								linear-gradient(to left,  rgba(0,0,0,0.03), rgba(0,0,0,0)) right/14px 100% no-repeat;
					border-radius: 12px;
					}

					/* Base table */
					.refund-table{
					width: 100%;
					border-collapse: separate;
					border-spacing: 0;
					font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
					color: var(--text);
					background: var(--card);
					min-width: 1200px; /* many columns  allow horizontal scroll gracefully */
					}

					/* Sticky header */
					.refund-table thead th{
					
					top: 0;
					z-index: 3;
					background: linear-gradient(180deg, #fffef6 0%, #fff 100%);
					color: #111827;
					font-weight: 700;
					font-size: 13px;
					padding: 10px 12px;
					border-bottom: 1px solid var(--border);
					white-space: nowrap;
					 text-align: center !important;
                    vertical-align: middle;
					}
					.refund-table thead th:first-child{
					border-top-left-radius: 12px;
					}
					.refund-table thead th:last-child{
					border-top-right-radius: 12px;
					}

					/* Body cells */
					.refund-table tbody td{
					border-bottom: 1px solid var(--border);
					padding: 10px 12px;
					font-size: 13px;
					line-height: 1.35;
					vertical-align: top;
					background: #fff;
					}

					/* Zebra + hover */
					.refund-table tbody tr:nth-child(even) td{
					background: #fafafa;
					}
					.refund-table tbody tr:hover td{
					background: #fff9e6; /* gentle brand-tinted hover */
					}

					/* Numeric alignment */
					.refund-table td.num{
					text-align: right;
					font-variant-numeric: tabular-nums;
					}

					/* Make dense columns a touch narrower, give text-heavy ones breathing room */
					.refund-table thead th:nth-child(1){  min-width: 140px; } /* Ticket Number */
					.refund-table thead th:nth-child(2){  min-width: 160px; } /* Passenger Name */
					.refund-table thead th:nth-child(3){  min-width: 220px; } /* Email */
					.refund-table thead th:nth-child(4){  min-width: 130px; text-align:right; } /* Passenger Paid */
					.refund-table thead th:nth-child(5){  min-width: 140px; text-align:right; } /* Cancellation Fee */
					.refund-table thead th:nth-child(6){  min-width: 140px; text-align:right; } /* Refund Amount */
					.refund-table thead th:nth-child(7){  min-width: 170px; text-align:right; } /* Refund received from airline */
					.refund-table thead th:nth-child(8){  min-width: 110px; text-align:right; } /* Diff */
					.refund-table thead th:nth-child(9){  min-width: 150px; } /* Account Name */
					.refund-table thead th:nth-child(10){ min-width: 100px; text-align:right; } /* BSB */
					.refund-table thead th:nth-child(11){ min-width: 150px; text-align:right; } /* Account Number */
					.refund-table thead th:nth-child(12){ min-width: 120px; } /* PNR */
					.refund-table thead th:nth-child(13){ min-width: 120px; } /* Order No */
					.refund-table thead th:nth-child(14){ min-width: 140px; } /* Payment Method */
					.refund-table thead th:nth-child(15){ min-width: 160px; } /* Refund received date */
					.refund-table thead th:nth-child(16){ min-width: 140px; } /* Refund vendor */
					.refund-table thead th:nth-child(17){ min-width: 110px; } /* Type */
					.refund-table thead th:nth-child(18){ min-width: 220px; } /* Remark */
					.refund-table thead th:nth-child(19){ min-width: 150px; } /* Submitted Date */
					.refund-table thead th:nth-child(20){ min-width: 120px; } /* Airline */
					.refund-table thead th:nth-child(21){ min-width: 110px; } /* Case ID */
					.refund-table thead th:nth-child(22){ min-width: 150px; } /* Travel Date */
					.refund-table thead th:nth-child(23){ min-width: 140px; } /* Status */
					.refund-table thead th:nth-child(24){ min-width: 120px; } /* Priority (if used) */

					/* Inputs in edit mode */
					.refund-table .edit-mode{
					width: 100%;
					max-width: 100%;
					}
					.refund-table .edit-mode[type="number"],
					.refund-table .edit-mode[type="text"],
					.refund-table .edit-mode select{
					width: 100%;
					box-sizing: border-box;
					height: 36px;
					padding: 6px 10px;
					border: 1px solid var(--border);
					border-radius: 8px;
					background: #fff;
					font-size: 13px;
					color: var(--text);
					transition: border-color .15s ease, box-shadow .15s ease;
					}
					.refund-table .edit-mode:focus{
					border-color: var(--brand);
					box-shadow: 0 0 0 3px var(--ring);
					outline: none;
					}
					.refund-table textarea.edit-mode{
					height: 90px;
					resize: vertical;
					line-height: 1.35;
					}

					/* Highlight editable cells while editing */
					.refund-table.is-editing td{
					box-shadow: inset 0 0 0 9999px rgba(255,187,0,0.03);
					}
					.refund-table.is-editing td .view-mode{
					opacity: 0.6;
					}

					/* Toolbar & buttons (no Bootstrap needed) */
					.toolbar{
					display: flex;
					gap: 10px;
					justify-content: flex-end;
					padding: 10px 2px 12px;
					border-top: 1px solid var(--border);
					margin-top: 8px;
					}

					.btn{
					-webkit-appearance: none;
					appearance: none;
					border: 1px solid transparent;
					border-radius: 10px;
					padding: 8px 14px;
					font-size: 13px;
					font-weight: 600;
					cursor: pointer;
					transition: transform .08s ease, box-shadow .15s ease, background-color .15s ease, border-color .15s ease;
					}
					.btn:active{ transform: translateY(1px); }

					.btn-primary{
					background: var(--brand);
					color: #111827;
					box-shadow: 0 6px 14px rgba(255,187,0,0.28);
					}
					.btn-primary:hover{ filter: brightness(1.03); }

					.btn-success{
					background: #10b981;
					color: #ffffff;
					box-shadow: 0 6px 14px rgba(16,185,129,0.28);
					}
					.btn-success:hover{ filter: brightness(1.05); }

					.btn-secondary{
					background: #111827;
					color: #ffffff;
					box-shadow: 0 6px 14px rgba(17,24,39,0.25);
					}
					.btn-secondary:hover{ filter: brightness(1.04); }

					/* Remove old margins that pushed the table left */
					.refund-table{
					margin: 0; /* overrides previous margin-left hacks */
					}

										/* === Full grid lines for the table === */
					:root{
					--grid: #d1d5db; /* line color; tweak darker if you want stronger lines */
					}

					.refund-table{
					border-collapse: separate;   /* keeps sticky header happy */
					border-spacing: 0;           /* crisp grid */
					}

					/* Add right & bottom borders to every cell */
					.refund-table th,
					.refund-table td{
					border-right: 1px solid var(--grid);
					border-bottom: 1px solid var(--grid);
					}

					/* Add the top border to the header row */
					.refund-table thead th{
					border-top: 1px solid var(--grid);
					}

					/* Add the left border to the first column */
					.refund-table thead th:first-child,
					.refund-table tbody td:first-child{
					border-left: 1px solid var(--grid);
					}

					/* Optional: make hover still visible with lines */
					.refund-table tbody tr:hover td{
					background: #fff9e6; /* keep your gentle hover */
					}

					/* Optional: slightly stronger line when editing */
					.refund-table.is-editing th,
					.refund-table.is-editing td{
					border-color: #c7ccd6;
					}
				</style>
			
		<?php
		
			}
			
	}
	else if(isset($_GET['p']) && !isset($_SESSION['userId']) && $user_role== '') //if customer went in without login
	{
		echo '<script>window.location.href="https://gauratravel.com.au/customer-portal/";</script>';
	}
	if(isset($_GET['p']) && $_GET['p'] =='logoutme') // logout code
	{
		
		unset($_SESSION['userEmailID']);
		unset($_SESSION['userId']);
		unset($_SESSION['userFullName']);
		if(isset($_GET['ad']))
		{
			echo '<script>window.location.href="?ad=1";</script>';
		}
		else
		{
			echo '<script>window.location.href="https://gauratravel.com.au/customer-portal/";</script>';
		}
	}
	?>
	
	
	<script type="text/javascript">
	$(document).ready(function () {
		$('#example1').DataTable({
			order: [[0, 'desc']],
		});
	});
	function isNumberKey(evt) {
		var charCode = (evt.which) ? evt.which : evt.keyCode;
		if (charCode == 46 || charCode > 31 && (charCode < 48 || charCode > 57)) {
			evt.preventDefault();
			return false;
		}
		return true;
	}
	
	function validateOrderID() {
        const order = document.getElementById("order_id").value;
        const orderRegex = /^\d{10}$/;
        if (!orderRegex.test(order)) {
          alert("Invalid order number!");
          document.getElementById("order_id").value = "";
        }
		else
		{
			document.getElementById("order_id").value = order;
		}
	}
	
	function validateAirlinePNR() {
        const pnr = document.getElementById("airline_pnr").value;
        const pnrRegex = /^[A-Za-z0-9]+$/; // Regex for alphanumeric characters without spaces or commas
        if (!pnrRegex.test(pnr)) {
            alert("Invalid Reservation code.");
            document.getElementById("airline_pnr").value = ""; // Clear input if invalid
        } else {
            document.getElementById("airline_pnr").value = pnr; // Keep the input value if valid
        }
	}
	
	function validatePNR() {
        const pnr = document.getElementById("pnr").value;
        const pnrRegex = /^[A-Za-z0-9]+$/; // Regex for alphanumeric characters without spaces or commas
        if (!pnrRegex.test(pnr)) {
            alert("Invalid Reservation code.");
            document.getElementById("pnr").value = ""; // Clear input if invalid
            break;
        } else {
            document.getElementById("pnr").value = pnr; // Keep the input value if valid
        }
	}
	
	function validatePhoneNumber() {
		
		
        const phone = document.getElementById("phonenumber").value;
        const phoneRegex = /^\d{10}$/;
        if (!phoneRegex.test(phone)) {
          alert("Invalid phone number! Please enter a 10-digit phone number.");
          document.getElementById("phonenumber").value = "";
        }
		else
		{
			phone = phone.replace(/-/g, ""); // remove existing hyphens
			if (phone.length > 10) {
				phone = phone.slice(0, 3) + "-" + phone.slice(3); // insert hyphen after third character
			}
			document.getElementById("phonenumber").value = phone;
			
		}
		
	}
	function isTextKey(evt) {
		var charCode = (evt.which) ? evt.which : evt.keyCode;
		if (charCode > 32 && (charCode < 65 || charCode > 90) && (charCode < 97 || charCode > 122)) {
			evt.preventDefault();
			return false;
		}
		return true;
	}

	function ValidateEmail(inputText) {
		var mailformat = /^w+([.-]?w+)*@w+([.-]?w+)*(.w{2,3})+$/;
		if (this.value.match(mailformat)) {
			alert("You have entered a valid email address!"); //The pop up alert for a valid email address
			return true;
		} else {
			alert("You have entered an invalid email address!"); //The pop up alert for an invalid email address
			return false;
		}
	}
	</script>
	</br></br></br></br>
	</br></br>
	</div>
<?php 
get_footer();
?>

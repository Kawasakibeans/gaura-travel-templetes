<?php
/**
 * Template Name: Manage WP Orders V3
 * Template Post Type: post, page
 *
 * @package WordPress
 * @subpackage Twenty_Twenty
 * @since Twenty Twenty 1.0
 */
get_header();
include "tpl_contralized_functions.php";
header('Content-Type: text/html; charset=utf-8');
?>
<style>
    .pnr-body {
        background: linear-gradient(120deg, #e0eafc 0%, #cfdef3 100%);
        margin: 0;
        padding: 0;
        min-height: 100vh;
    }
    .pnr-container {
        max-width: 80%;
        margin: 40px auto;
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
        padding: 36px 32px 32px 32px;
        position: relative;
        overflow: hidden;
    }
    .pnr-title {
        color: #1a237e;
        font-size: 2.2rem;
        margin-bottom: 18px;
        letter-spacing: 1px;
        text-align: center;
    }
    .pnr-section {
        background: #f8fafc;
        border-radius: 10px;
        box-shadow: 0 2px 8px #0001;
        padding: 18px 18px 10px 18px;
        margin-bottom: 24px;
        transition: box-shadow 0.2s;
    }
    .pnr-section:hover {
        box-shadow: 0 4px 16px #0002;
    }
    .pnr-section-title {
        color: #283593;
        font-size: 1.25rem;
        margin-bottom: 10px;
        margin-top: 30px;
        border-left: 4px solid #64b5f6;
        padding-left: 10px;
        letter-spacing: 0.5px;
    }
    .pnr-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 10px;
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 4px #0001;
    }
    .pnr-table th, .pnr-table td {
        padding: 10px 8px;
        text-align: left;
    }
    .pnr-table th {
        background: #e3f2fd;
        color: #1a237e;
        font-weight: 600;
        border-bottom: 2px solid #bbdefb;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .pnr-table td {
        border-bottom: 1px solid #f0f0f0;
        color: #333;
    }
    .pnr-table tr:last-child td {
        border-bottom: none;
    }
    .pnr-label {
        font-weight: 600;
        color: #1976d2;
        width: 180px;
        background: #f1f8ff;
    }
    .pnr-error {
        color: #c0392b;
        font-weight: bold;
        background: #ffebee;
        border: 1px solid #ffcdd2;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 18px;
        text-align: center;
    }
    .pnr-input-row {
        margin-bottom: 28px;
        text-align: center;
    }
    .pnr-input {
        padding: 10px 14px;
        width: 220px;
        border: 1.5px solid #90caf9;
        border-radius: 6px;
        font-size: 1rem;
        margin-right: 10px;
        transition: border 0.2s;
        outline: none;
    }
    .pnr-input:focus {
        border: 1.5px solid #1976d2;
        background: #e3f2fd;
    }
    .pnr-btn {
        padding: 10px 22px;
        background: linear-gradient(90deg, #1976d2 0%, #64b5f6 100%);
        color: #fff;
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 2px 8px #1976d220;
        transition: background 0.2s, box-shadow 0.2s;
    }
    .pnr-btn:hover {
        background: linear-gradient(90deg, #1565c0 0%, #42a5f5 100%);
        box-shadow: 0 4px 16px #1976d220;
    }
    .pnr-status-chip {
        display: inline-block;
        background: #1976d2;
        color: #fff;
        border-radius: 16px;
        padding: 4px 14px;
        margin: 0 6px 6px 0;
        font-size: 0.98em;
        font-weight: 500;
        letter-spacing: 0.5px;
        box-shadow: 0 1px 4px #1976d220;
    }
    @media (max-width: 700px) {
        .pnr-container { padding: 12px 2vw; }
        .pnr-table, .pnr-table th, .pnr-table td { font-size: 0.97em; }
        .pnr-label { width: 110px; }
    }
    .pnr-table-scroll {
        width: 100%;
        overflow-x: auto;
    }
    .pnr-tabs {
        display: flex;
        border-bottom: 2px solid #e3f2fd;
        margin-bottom: 18px;
        gap: 2px;
    }
    .pnr-tab {
        padding: 10px 24px;
        background: #f8fafc;
        border: none;
        border-radius: 10px 10px 0 0;
        font-size: 1.08em;
        color: #1976d2;
        font-weight: 600;
        cursor: pointer;
        margin-right: 2px;
        outline: none;
        border-bottom: 2px solid transparent;
        transition: background 0.2s, color 0.2s;
    }
    .pnr-tab.active {
        background: #fff;
        color: #1a237e;
        border-bottom: 2px solid #fff;
    }
    .pnr-tab-content { display: none; }
    .pnr-tab-content.active { display: block; }
    .pnr-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0; top: 0; width: 100vw; height: 100vh;
        background: rgba(30,40,60,0.25);
        justify-content: center;
        align-items: center;
    }
    .pnr-modal-content {
        background: #fff;
        border-radius: 12px;
        padding: 32px 28px 18px 28px;
        max-width: 400px;
        margin: 60px auto;
        box-shadow: 0 8px 32px #0002;
        position: relative;
    }
    .pnr-modal-close {
        position: absolute;
        right: 18px;
        top: 12px;
        font-size: 2rem;
        color: #888;
        cursor: pointer;
    }
    .pnr-form-row {
        margin-bottom: 18px;
        display: flex;
        flex-direction: column;
    }
    .pnr-form-row label {
        font-weight: 600;
        color: #1976d2;
        margin-bottom: 6px;
    }
    .pnr-form-row input, .pnr-form-row select {
        padding: 8px 10px;
        border: 1px solid #90caf9;
        border-radius: 5px;
        font-size: 1em;
    }
    .pnr-checkbox-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
    }
    .pnr-checkbox-row input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    .pnr-checkbox-row label {
        cursor: pointer;
        user-select: none;
    }
    .pnr-infant-form {
        background: #f8fafc;
        padding: 12px;
        border-radius: 8px;
        margin-top: 12px;
        border: 1px solid #e3f2fd;
        display: nonfe;
    }
    .pnr-toggle-form {
        display: none;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #e3f2fd;
    }
    .pnr-toggle-btn {
        background: #1976d2;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.2s;
        margin-bottom: 16px;
    }
    .pnr-toggle-btn:hover {
        background: #1565c0;
    }
    .pnr-spinner {
        display: inline-block;
        width: 28px;
        height: 28px;
        border: 4px solid #90caf9;
        border-top: 4px solid #1976d2;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes 
    spin{
        0%{
            transform:rotate(0deg);
        }
        100%{
            transform:rotate(360deg);
        }
        }
</style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<div class='wpb_column vc_column_container vc_col-sm-12' id='manage_bookings' style='width:90%;margin:auto;padding:100px 0px;'>
<?php
date_default_timezone_set("Australia/Melbourne"); 
$defaultlink_gaura = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
$callbackURL = 'https://gauratravel.com.au/skypay-post-callback/'; // skypay callback url
global $current_user; 
wp_get_current_user();
$site_url = '';
$current_date_and_time = date("Y-m-d H:i:s");
include('wp-config-custom.php');
include('vendor/autoload.php');
$query_ip_selection = "SELECT * FROM wpk4_backend_ip_address_checkup where ip_address='$ip_address'";
$result_ip_selection = mysqli_query($mysqli, $query_ip_selection);
$row_ip_selection = mysqli_fetch_assoc($result_ip_selection);
if(mysqli_num_rows($result_ip_selection) > 0)
{
    $currnt_userlogn = $current_user->user_login;
	
	function gdeal_name_update_ajax($order_id)
	{
		global $currnt_userlogn; 
		$url = "https://gauratravel.com.au/wp-content/themes/twentytwenty/templates/tpl_amadeus_name_update_backend.php?order_id=" . urlencode($order_id) ."&agent=" . urlencode($currnt_userlogn);

		$curl = curl_init();

		curl_setopt_array($curl, array(
			CURLOPT_URL => $url,
			CURLOPT_RETURNTRANSFER => true,
			CURLOPT_TIMEOUT => 30,
			CURLOPT_FOLLOWLOCATION => true,
			CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
			CURLOPT_CUSTOMREQUEST => 'GET'
		));

		$response = curl_exec($curl);
		$http_code = curl_getinfo($curl, CURLINFO_HTTP_CODE);

		if (curl_errno($curl)) {
			//echo "cURL Error: " . curl_error($curl);
		} else {
			//echo "Response (HTTP $http_code): " . $response;
		}

		curl_close($curl);
		

	}
	
    function current_payment_status2($orderid)
    {
        global $mysqli;
        global $current_date_and_time;
        $total_paid_amount = 0;
        $query_payment_history = "SELECT trams_received_amount FROM wpk4_backend_travel_payment_history where order_id = '$orderid' and pay_type IN ('deposit', 'balance', 'Balance', 'Unknown', 'deposit_adjustment', 'additional_payment')";
        $result_payment_history = mysqli_query($mysqli, $query_payment_history);
        while ($row_payment_history = mysqli_fetch_assoc($result_payment_history)) 
        {
            $total_paid_amount += (float)$row_payment_history['trams_received_amount'];
        }
        $query_bookings = "SELECT total_amount, payment_status, order_type FROM wpk4_backend_travel_bookings where order_id = '$orderid'";
        $result_bookings = mysqli_query($mysqli, $query_bookings);
        $row_bookings = mysqli_fetch_assoc($result_bookings); 
        $total_booking_amount = (float)$row_bookings['total_amount'];
		$order_type = $row_bookings['order_type'];
        $booking_payment_status = $row_bookings['payment_status'];
        $is_bpay_paid = 0;
        $query_payment_history_bpay_check = "SELECT meta_key_data FROM wpk4_backend_travel_booking_update_history where order_id = '$orderid' and meta_key = 'G360Events' and meta_value = 'bpay_receipt_awaiting_approval'";
        $result_payment_history_bpay_check = mysqli_query($mysqli, $query_payment_history_bpay_check);
        if (mysqli_num_rows($result_payment_history_bpay_check) > 0) 
        {
            $is_bpay_paid = 2;
        }
        $query_payment_history_bpay_check = "SELECT meta_key_data FROM wpk4_backend_travel_booking_update_history where order_id = '$orderid' and meta_key = 'G360Events' and meta_value = 'bpay_receipt_approved'";
        $result_payment_history_bpay_check = mysqli_query($mysqli, $query_payment_history_bpay_check);
        if (mysqli_num_rows($result_payment_history_bpay_check) > 0) 
        {
            $is_bpay_paid = 1;
        }
        $final_payment_status = '';
        if($is_bpay_paid == 1)
        {
            $balance_bpay = (float)$total_booking_amount - (float)$total_paid_amount;
            if($balance_bpay < 1.00)
            {
                $final_payment_status = 'BPAY Paid';
            }
            else
            {
                $final_payment_status = 'BPAY Received';
            }
        }
        else if($is_bpay_paid == 2)
        {
            $final_payment_status = 'BPAY Received';
        }
        else
        {
            if($total_paid_amount == 0 )
            {
                $final_payment_status = 'Zero Paid';
            }
            else
            {
                $balance = (float)$total_booking_amount - (float)$total_paid_amount;
                if($balance < 1.00 && $balance > -1.00)
                {
                    $final_payment_status = ' Fully Paid';
                }
                else if($balance <= -1.00)
                {
                    $final_payment_status = ' Over Paid';
                }
                else if($balance >= 1.00)
                {
                    $final_payment_status = ' Partially Paid';
                }
                else
                {
                    $final_payment_status = ' Pending';
                }
            }
        }
        if($booking_payment_status == 'partially_paid' && $final_payment_status != ' Partially Paid' )
        {
            if($final_payment_status == ' Fully Paid' || $final_payment_status == ' Over Paid' || $final_payment_status == 'BPAY Paid')
            {
                $new_payment_status = 'paid';
                $sql_update_status = "UPDATE wpk4_backend_travel_bookings SET payment_status = '$new_payment_status', payment_modified = '$current_date_and_time', payment_modified_by = 'status_checker_cron' WHERE order_id = '$orderid'";
				$result_status = mysqli_query($mysqli,$sql_update_status) or die(mysqli_error());
				
				if($order_type == 'WPT')
				{
					gdeal_name_update_ajax($orderid);	
							
					mysqli_query($mysqli,"insert into wpk4_amadeus_name_update_payment_status_log (order_id, order_type, updated_by, updated_on, is_processed_amadeus, amadeus_processed_on, page_title ) 
					values ('$orderid', 'WPT', 'status_checker_cron', '$current_date_and_time', 'yes', '$current_date_and_time', 'G360 Payment Status Check')") or die(mysqli_error($mysqli));
				}	
            }
        }
        return $final_payment_status;
    }
    function current_payment_status($orderid)
    {
        global $mysqli;
        $total_paid_amount = 0;
        $query_payment_history = "SELECT trams_received_amount FROM wpk4_backend_travel_payment_history where order_id = '$orderid' and pay_type IN ('deposit', 'balance', 'Refund', 'Balance', 'Unknown', 'deposit_adjustment', 'additional_payment')";
        $result_payment_history = mysqli_query($mysqli, $query_payment_history);
        while ($row_payment_history = mysqli_fetch_assoc($result_payment_history)) 
        {
            $total_paid_amount += (float)$row_payment_history['trams_received_amount'];
        }
        $query_bookings = "SELECT total_amount FROM wpk4_backend_travel_bookings where order_id = '$orderid'";
        $result_bookings = mysqli_query($mysqli, $query_bookings);
        $row_bookings = mysqli_fetch_assoc($result_bookings);
        $total_booking_amount = (float)$row_bookings['total_amount'];
        if($total_paid_amount == 0)
        {
            return 'Zero Paid';
        }
        else
        {
            $balance = (float)$total_booking_amount - (float)$total_paid_amount;
            if($balance < 1.00 && $balance > -1.00)
            {
                return ' Fully Paid';
            }
            else if($balance <= -1.00)
            {
                return ' Over Paid';
            }
            else if($balance >= 1.00)
            {
                return ' Partially Paid';
            }
            else
            {
                return ' Pending';
            }
        }
    }
    /* SMS generation with Transmit SMS API starts */
    function generateTransmitSMS( $message, $to ) 
    {
        $curl = curl_init();
        // Encode message to ensure it is URL-safe
        $encodedMessage = urlencode($message);
        // Prepare the API URL
        $apiUrl = "https://api.transmitsms.com/send-sms.json?message=$encodedMessage&to=$to&from=GauraTravel&validity=30";
        curl_setopt_array($curl, array(
          CURLOPT_URL => $apiUrl,
          CURLOPT_RETURNTRANSFER => true,
          CURLOPT_ENCODING => '',
          CURLOPT_MAXREDIRS => 10,
          CURLOPT_TIMEOUT => 0,
          CURLOPT_FOLLOWLOCATION => true,
          CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
          CURLOPT_CUSTOMREQUEST => 'GET',
          CURLOPT_HTTPHEADER => array(
            'Authorization: Basic ZmUzZjQzZTJlOGMyM2Q5YmU1MjhkNDliZjczMWIxYjE6R3R4QDEyMzQ1Kg=='
          ),
        ));
        $response = curl_exec($curl);
        if(curl_errno($curl)) {
            echo 'Curl error: ' . curl_error($curl);
        }
        curl_close($curl);
        return $response;
    }
    /* SMS generation with Transmit SMS API ends */
    // BPAY Code snipit start
    /* LIVE */
    $apiURL = 'https://api.bpaygroup.com.au';
    $apiInitialAuthCode = 'QlBQLTAxMjI1LU0yVjctZmExODA5OWFjMjkxMWNiYjpla2xSUkh4TGtydUM5a3l4cHF1VExzeEJ6VlFxc2Y=';
    $baseBiller = '33829';
    /* LIVE END */
    // generate auth code for BPAY
    function generateAuthCode() 
    {
        global $apiURL; global $apiInitialAuthCode; global $baseBiller;
        $curl = curl_init();
        curl_setopt_array($curl, array(
          CURLOPT_URL => $apiURL.'/oauth/token',
          CURLOPT_RETURNTRANSFER => true,
          CURLOPT_ENCODING => '',
          CURLOPT_MAXREDIRS => 10,
          CURLOPT_TIMEOUT => 0,
          CURLOPT_FOLLOWLOCATION => true,
          CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
          CURLOPT_CUSTOMREQUEST => 'POST',
          CURLOPT_POSTFIELDS => 'grant_type=client_credentials&scope=read%3Agenerate-crn%20write%3Agenerate-bpay-bill%20read%3Agenerate-icrn%20read%3Avalidate-biller%20write%3Agenerate-bpay-bill',
          CURLOPT_HTTPHEADER => array(
            'Content-Type: application/x-www-form-urlencoded',
            'Authorization: Basic '.$apiInitialAuthCode
          ),
        ));
        $response = curl_exec($curl);
        curl_close($curl);
        $data = json_decode($response, true);
        $authcode = $data['access_token'];
        return $authcode;
    }
    // BPAY CRN CheckDigit finder
    /* Find the BPAY CheckDigit by comparing base CRN and received CRN */
    function findStringDifferences($string1, $string2) {
        return substr($string2, strlen($string1));
    }
    // Generate BPAY CRN with Amount
    function generateCRNWithAmount($authCode, $baseCustomerNumber, $dueAmount, $expiryDate) {
        global $apiURL; global $baseBiller;
        $tid_generated = date("ymdhis");
        $curl = curl_init();
        $length = strlen($baseCustomerNumber);
        $desiredLength = 9;
        $zerosToAdd = $desiredLength - $length;
        // Add leading zeros using str_repeat and str_pad
        $baseCustomerNumber = str_pad(str_repeat("0", $zerosToAdd) . $baseCustomerNumber, $desiredLength, "0", STR_PAD_LEFT);
        $postData = json_encode(array(
            "baseCRNParams" => array(
                array(
                    "tid" => $tid_generated,
                    "baseCustomerNumber" => $baseCustomerNumber,
                    "dueAmount" => $dueAmount,
                    "expiryDate" => $expiryDate
                )
            )
        ));
        curl_setopt_array($curl, array(
            CURLOPT_URL => $apiURL.'/payments/v1/crncheckdigits/biller/'.$baseBiller,
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_ENCODING => '',
            CURLOPT_MAXREDIRS => 10,
            CURLOPT_TIMEOUT => 0,
            CURLOPT_FOLLOWLOCATION => true,
            CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
            CURLOPT_CUSTOMREQUEST => 'POST',
            CURLOPT_POSTFIELDS => $postData,
            CURLOPT_HTTPHEADER => array(
                'Content-Type: application/json',
                'Authorization: Bearer '.$authCode
            ),
        ));
        $response = curl_exec($curl);
        $error = curl_error($curl);
        curl_close($curl);
        return $response;
    }
    // BPAY Generate CheckDigit by calculating the numbers manually (without API for draft usage)
    function calculateChecksum($number) {
        $checkDigit = 0;
        // if order_id is 6 character length
        if (strlen($number) == 6) {
            $number = '000' . $number;
        }
        // Convert the number to a string and iterate through each digit
        $digits = str_split((string) $number);
        foreach ($digits as $index => $digit) {
            $checkDigit += $digit * ($index + 1);
        }
        // Calculate the checksum and return it
        $checkDigit = $checkDigit % 10;
        $bpayCRN = $number . $checkDigit;
        return $bpayCRN;
    }
    // BPAY Code snipit end 
    // Azupay code generate starts
    function generateRandomSecurityCode($length = 10) {
        $prefix = uniqid(); // Generate a unique prefix
        $characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        $randomString = '';
        for ($i = 0; $i < $length; $i++) {
            $randomString .= $characters[rand(0, strlen($characters) - 1)];
        }
        return $prefix . $randomString;$pax_id_received = $row_payment_pax['auto_id'];
    }
    
    function generateAzupayPaymentRequest($next_3_days2, $clientTransactionId, $paymentAmount, $paymentDescription, $callback_url)
    {
        if (class_exists('GuzzleHttp\Client'))
        {
            $client = new \GuzzleHttp\Client();
            $authorization_code = 'SECR7566D1_c4cc3709d612d1e0e677833ffbcef703_9Kz3JvUrYqPECSwl';
            $access_url = 'https://api.azupay.com.au/v1';
            $clientId = "c4cc3709d612d1e0e677833ffbcef703"; 
            $payID = "payments@gauratravel.com.au";
            $payIDSuffix = "gauratravel.com.au";
            $full_payment_auth_code = generateRandomSecurityCode();
            try 
            {
            $azupay_response = $client->request('POST', $access_url.'/paymentRequest', [
                'body' => '{"PaymentRequest":{"paymentNotification":{"paymentNotificationEndpointUrl":"'.$callback_url.'","paymentNotificationAuthorizationHeaderValue":"'.$full_payment_auth_code.'"},"variant":"1Click", "clientId":"'.$clientId.'","clientTransactionId":"'.$clientTransactionId.'","paymentExpiryDatetime":"'.$next_3_days2.'","paymentAmount":'.$paymentAmount.',"paymentDescription":"'.$paymentDescription.'"}}',
                'headers' => [
                'Authorization' => $authorization_code,
                'accept' => 'application/json',
                'content-type' => 'application/json',
                ],
            ]);
            $azupay_data = json_decode($azupay_response->getBody(), true);
            $paymentRequestId = $azupay_data['PaymentRequestStatus']['paymentRequestId'];
            $paymentRequeststatus = $azupay_data['PaymentRequestStatus']['status'];
            $paymentRequestcreatedDateTime = $azupay_data['PaymentRequestStatus']['createdDateTime'];
            $paymentRequestcheckoutUrl = $azupay_data['PaymentRequest']['checkoutUrl'];
            $paymentRequestExpiryDatetime = date("d/m/Y H:i:s", strtotime( $azupay_data['PaymentRequest']['paymentExpiryDatetime']));
            $paymentRequestExpiryDatetime_ymd = date("Y-m-d H:i:s", strtotime( $azupay_data['PaymentRequest']['paymentExpiryDatetime']));
            $paymentRequestpayID = $azupay_data['PaymentRequest']['payID'];
            $paymentRequestpaymentDescription = $azupay_data['PaymentRequest']['paymentDescription'];
            $paymentRequestAmount = $azupay_data['PaymentRequest']['paymentAmount'];
            $paymentRequestvirtualBsb = $azupay_data['PaymentRequestStatus']['virtualBsb'];
            $paymentRequestvirtualAccountNumber = $azupay_data['PaymentRequestStatus']['virtualAccountNumber'];
            } 
            catch (\GuzzleHttp\Exception\ClientException $e) { echo 'Error on generating the payment link. Kindly try again.'; }
            catch (\GuzzleHttp\Exception\ServerException $e) { echo 'Error on generating the payment link. Kindly try again.'; }
            catch (\GuzzleHttp\Exception\GuzzleException $e) { echo 'Error on generating the payment link. Kindly try again.'; } 
            catch (Exception $e) { echo 'Error on generating the payment link. Kindly try again.'; }
            if(isset($paymentRequestId))
            {
                return [
                    'paymentRequestId' => $paymentRequestId,
                    'createdDateTime' => $paymentRequestcreatedDateTime,
                    'checkoutUrl' => $paymentRequestcheckoutUrl,
                    'paymentExpiryDatetime' => $paymentRequestExpiryDatetime,
                    'paymentExpiryDatetimeYMD' => $paymentRequestExpiryDatetime_ymd,
                    'payID' => $paymentRequestpayID,
                    'paymentAmount' => $paymentRequestAmount,
                    'paymentAuthCode' => $full_payment_auth_code,
                    'virtualBsb' => $paymentRequestvirtualBsb,
                    'virtualAccountNumber' => $paymentRequestvirtualAccountNumber
                ];
            }
            else
            {
                return '';
            }
        }
    }
    function generateSkyPayPaymentRequest($newSalePrice, $departureDate, $order_id_for_payment_request)
    {
        $callbackURL_sky = 'https://gauratravel.com.au/skypay-post-callback/';
        if ( ctype_digit($order_id_for_payment_request) && strlen($order_id_for_payment_request) <= 7 ) 
        {
            $slice_pay_agent_id = 'agent-gaura-41fbn0';
        } 
        elseif (ctype_alpha($order_id_for_payment_request)) 
        {
            $slice_pay_agent_id = 'agent-gaura-41fbn0';
        } 
        else 
        {
            $slice_pay_agent_id = 'agent-gaura-41fbn0';
        }
        $href_paylater = ''; $paylater_link = '';
		$curl_paylater = curl_init();
        curl_setopt_array($curl_paylater, array(
            CURLOPT_URL => 'https://business.paylatertravel.com.au/api/create-link/',
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_ENCODING => '',
            CURLOPT_MAXREDIRS => 10,
            CURLOPT_TIMEOUT => 0,
            CURLOPT_FOLLOWLOCATION => true,
            CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
            CURLOPT_CUSTOMREQUEST => 'POST',
            CURLOPT_POSTFIELDS => 'salePrice='.$newSalePrice.'&currency=AUD&departureDate='.$departureDate.'&bookingReference='.$order_id_for_payment_request.'&agentId='.$slice_pay_agent_id.'&bookingNotificationUrl='.$callbackURL_sky,
            CURLOPT_HTTPHEADER => array(
                'Accept: text/html',
                'Content-Type: application/x-www-form-urlencoded'
            ),
        ));
        $response_paylater = curl_exec($curl_paylater);
        curl_close($curl_paylater);
        if (!empty($response_paylater)) 
        {
            $doc_paylater = new DOMDocument();
            @$doc_paylater->loadHTML($response_paylater);
            $anchors_paylater = $doc_paylater->getElementsByTagName('a');
                                                                            
            if ($anchors_paylater->length > 0) {
                $anchor_paylater = $anchors_paylater->item(0);
                $href_paylater = $anchor_paylater->getAttribute('href');
            }
            if($href_paylater != '')
            {
                $paylater_link = '<a href="'.$href_paylater.'" style="background-color: #26BDD7; border: none; color: white;  padding: 10px 16px; margin: 10px 0px; text-align: center;  text-decoration: none;  display: inline-block;  font-size: 13px;">Pay via PayLater</a>';
            }
        }
        return $paylater_link;
    }
    // Azupay code generate ends
    if($currnt_userlogn) 
    {             
    ?>
    <style>
    #changed_0,#changed_1,.post-94698 .entry-header-inner h1{display:none}td{border:1px solid #c7c7c7}input[type=text]:disabled{pointer-events:none}.w3-bar .w3-button{background-color:#e76f8f}.w3-bar .active{background-color:#cd2653}#manage_bookings{display:nonne}
    </style>
    <script>
    function view_bookings()
    {
         document.getElementById("manage_bookings").style.display="block";
    }
    $(document).ready(function () {
        $('#example').DataTable({
            order: [[1, 'desc']],
        });
    });
    function isNumberKey(evt) {
    	var charCode = (evt.which) ? evt.which : evt.keyCode;
        if (charCode != 45 && (charCode != 46) && (charCode < 48 || charCode > 57)) {
            evt.preventDefault();
            return false;
        }
        return true;
    }
    </script>
    <?php
    if(!isset($_GET['option']))
    {
		include('data-table-classes.php');
		$query = "SELECT * FROM wpk4_backend_travel_bookings where order_id>126289 && order_id<500275 && t_type = 'return' && order_type = 'WPT'";
		$result = mysqli_query($mysqli, $query);
		while($row = mysqli_fetch_assoc($result))
		{
			$order_id = $row['order_id'];
			$queryg = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id' && t_type = 'return'";
			$resultg = mysqli_query($mysqli, $queryg);
			$rowf = mysqli_num_rows($resultg);
			if($rowf==1)
			{
				$sql_update_status = "UPDATE wpk4_backend_travel_bookings SET t_type='return' WHERE order_id='$order_id'";
				$result_status = mysqli_query($mysqli,$sql_update_status) or die(mysqli_error());
			}
		}
		?>
		<center>
		<a target='_blank' href='?option=view_recent'><button class='btn btn-success' style='width:170px; font-size:13px;'>View Recent Orders</button></a>
		<a target='_blank' href='?option=search&order_id_filter=&email_filter=&mobile_filter='><button class='btn btn-success' style='width:170px; font-size:13px;'>Search Orders</button></a>
		<a target='_blank' href='?option=paxview&tripcode=&date=&status=&order_id_filter=&pnr_filter='><button class='btn btn-success' style='width:170px; font-size:13px;'>Filter Orders</button></a>
		<?php
		if( current_user_can( 'administrator' ) || current_user_can( 'ho_operations' ) || current_user_can( 'ticketing_user' ) || current_user_can( 'ticketing_admin' ) || current_user_can( 'user_portal_complaint_editor_admin' ) || current_user_can( 'user_portal_datechange_editor_admin' ) || current_user_can( 'user_portal_refund_editor_admin' ) || current_user_can( 'payment_portal_user' ) || current_user_can( 'ho_payment' ))
		{ ?>
		<a target='_blank' href='?option=view-tasks&category=&status=open&createdon=&orderid=&email='><button class='btn btn-success' style='width:170px; font-size:13px;'>Filter Tasks</button></a>
		<?php } ?>
		</center>
		<?php
    }
    if(isset($_GET['option']) && $_GET['option']=='view_recent')
    {
    	include('data-table-classes.php');
    	?>
    	<div class='wpb_column vc_column_container vc_col-sm-12' id='manage_bookings' style='width:100%;'>
    	<h5>Manage Bookings</h5>
    	<table class="table table-striped" id="example" style="width:100%; font-size:14px;"><thead><tr><th width='20%'>Order Date</th><th>Order ID</th><th width='25%'>Trip Code</th><th>Travel Date</th><th width='8%'>Last Modified</th><th>Payment</th><th width='20%'>Status</th></tr>
    	</thead>
    	<tbody>
    	<?php
    	$query = "SELECT * FROM wpk4_backend_travel_bookings where order_id>'100000' && order_id<'800000' order by auto_id DESC limit 60";
    	$result = mysqli_query($mysqli, $query);
    	while($row = mysqli_fetch_assoc($result))
    	{
    		$order_id = $row['order_id'];
    		$co_order_id = $row['co_order_id'];
    		$product_id = $row['product_id'];
    		
    		$query_count = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id' && co_order_id='$co_order_id' && t_type='return'";
    		$result_count = mysqli_query($mysqli, $query_count);
    		$row_count = mysqli_num_rows($result_count);
    		$query_movement = "SELECT * FROM wpk4_backend_travel_booking_movements where order_id='$order_id' && product_id='$product_id' && co_order_id='$co_order_id'";
    		$result_movement = mysqli_query($mysqli, $query_movement);
    		$row_movement_count = mysqli_num_rows($result_movement);
    		if($row['payment_status'] == 'pending') { $txt_payment_status = 'Pending'; }
			else if($row['payment_status'] == 'partially_paid') { $txt_payment_status = 'Partially Paid'; }
    		else if($row['payment_status'] == 'paid') { $txt_payment_status = 'Paid'; }
    		else if($row['payment_status'] == 'canceled') { $txt_payment_status = 'Xxln With Deposit'; }
    		else if($row['payment_status'] == 'N/A') { $txt_payment_status = 'Failed'; }
    		else if($row['payment_status'] == 'refund') { $txt_payment_status = 'Refund Done'; }
    		else if($row['payment_status'] == 'waiting_voucher') { $txt_payment_status = 'Refund Under Process'; }
    		else if($row['payment_status'] == 'voucher_submited') { $txt_payment_status = 'Rebooked'; }
    		else if($row['payment_status'] == 'receipt_received') { $txt_payment_status = 'Receipt Received'; }
    		else { $txt_payment_status = 'Pending'; }
			?>
    		<tr>
    			<td><?php echo $row['order_date']; ?></td>
    			<td><?php echo $row['order_id']; ?><?php if($co_order_id != '') { echo ' '.$co_order_id; } ?>
    			<?php
    			if($row_count>1)
    			{
    				echo ' <font style="color:red;font-size:11px;"><i class="fa fa-plane" aria-hidden="true"></i><i class="fa fa-plane" aria-hidden="true"></i></font>';
    			}
    			if($row_movement_count>0)
    			{
    				echo ' <font style="color:red;font-size:11px;"><i class="fa fa-refresh" aria-hidden="true"></i></font>';
    			}
    			?>
    			</td>
    			<td><?php echo $row['trip_code']; ?></td>
    			<td><?php echo date('Y-m-d', strtotime($row['travel_date'])); ?></td>
    			<td><?php echo substr($row['late_modified'], 0, -9); ?></td>
    			<td><?php echo $txt_payment_status; ?></td>
    			<td>
					<a href="?option=view&id=<?php echo $order_id; ?>&co_orderid=<?php echo $row['co_order_id']; ?>" class="btn btn-success">View</a></br>
					<?php
					if( current_user_can( 'administrator' ) || current_user_can( 'ticketing_admin' ) || current_user_can( 'ho_operations' ) || current_user_can( 'datechange_manager' ))
					{
						?> 
						<a href="?option=edit&id=<?php echo $order_id; ?>&product_i=<?php echo $product_id; ?>&co_orderid=<?php echo $co_order_id; ?>" class="btn btn-warning">Edit</a></a></br>
						<?php
						if(current_user_can( 'administrator' ) || current_user_can( 'ticketing_admin' ) || current_user_can( 'ho_operations' )|| current_user_can( 'datechange_manager' ))
						{
						?>
							<a href="?option=divide&id=<?php echo $order_id; ?>&co_orderid=<?php echo $row['co_order_id']; ?>&productid=<?php echo $product_id; ?>" class="btn btn-success">Divide</a></br>
							<a href="?option=managepnr&id=<?php echo $order_id; ?>&product_i=<?php echo $product_id; ?>&co_orderid=<?php echo $row['co_order_id']; ?>" class="btn btn-primary">PNR</a></br>
							<a href="?option=movements&orderid=<?php echo $order_id; ?>&productid=<?php echo $product_id; ?>&co_orderid=<?php echo $co_order_id; ?>" class="btn btn-primary">Movement</a>
						<?php 
						}
					} 
					?>
    			</td>
    		</tr>
    		<?php
    	}
    	?>
    	</tbody>
    	</table>
    	</br>
    	</div>
    	<?php
    }
    if(isset($_GET['option']) && $_GET['option']=='divide')
    {
		$orderid = $_GET['id'];
		$co_order_id = $_GET['co_orderid'];
		$product_id = $_GET['productid'];
		$query_pax = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$orderid' && co_order_id = '$co_order_id' && product_id = '$product_id'";
		$result_pax = mysqli_query($mysqli, $query_pax);
		?>
		<h6>Order ID : <?php echo $orderid; ?></h6><h6>Product ID : <?php echo $product_id; ?></h6>
		<?php
		if(!empty($result_pax))
		{
			while($row_pax = mysqli_fetch_assoc($result_pax))
			{
			?>
				<form action="#" name="statusupdate" method="post" enctype="multipart/form-data" style='font-size:13px;'><table class="table table-striped" id="example" style="width:100%;"><thead><tr><th width='10%'>Check</th><th>Name</th><th>Passport</th><th>DOB</th></tr></thead><tbody>
				<?php
				$order_id = $row_pax['order_id'];
				$co_order_id_db = $row_pax['co_order_id'];
				$product_id = $row_pax['product_id'];
				$query_paxc = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id' && ( co_order_id = '$co_order_id' || co_order_id IS NULL ) && product_id = '$product_id'";
				$result_paxc = mysqli_query($mysqli, $query_paxc);
				$row_pax_count = mysqli_num_rows($result_paxc);
				while($row_paxc = mysqli_fetch_assoc($result_paxc))
				{
					$salutation = $row_paxc['salutation']; $fname = $row_paxc['fname']; $lname = $row_paxc['lname']; $ppn = $row_paxc['ppn']; $dob = $row_paxc['dob']; $auto_id = $row_paxc['auto_id'];
					?>
					<tr><td>
					<?php
					if($row_pax_count > 1)
					{
					?>
						<input type="checkbox" id="pxe" name="pax_ids_for_new_order[]" value="<?php echo $auto_id; ?>">
					<?php
					}
					else
					{
					?>
						<input type="checkbox" disabled id="pxe" name="pax_ids_for_new_order" value="<?php echo $auto_id; ?>">
					<?php
					}
					?>
					</td><td><?php echo $salutation; ?> <?php echo $fname; ?> <?php echo $lname; ?></td><td><?php echo $ppn; ?></td><td><?php echo $dob; ?></td></tr>
				<?php
				}
				?>
				<tr><td colspan='4'><input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='divideorder' value='Divide'></td></tr></tbody></table></form>
			<?php
			}
		}	
		if(isset($_POST['divideorder']))
		{ 
			$divided_date = date("Y-m-d H:i:s");
			$orderid = $_GET['id']; $co_orderid = $_GET['co_orderid']; $productid = $_GET['productid'];
			if($co_orderid=='')
			{
				$query_paxc_2 = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$orderid' order by co_order_id DESC LIMIT 1";
				$result_paxc_2 = mysqli_query($mysqli, $query_paxc_2);
				$row_paxc_2 = mysqli_fetch_assoc($result_paxc_2);
				$last_co_id_2 = $row_paxc_2['co_order_id'];
				$main_payment_status = $row_paxc_2['payment_status'];
				if($last_co_id_2=='') // no divide happened previously
				{
					$co_orderid= 'D1';
					$sql_update = "UPDATE wpk4_backend_travel_bookings SET co_order_id='$co_orderid',divided_date='$divided_date' WHERE order_id='$orderid' && product_id = '$productid' && co_order_id = ''";
					$result= mysqli_query($mysqli,$sql_update);
					
					$sql_update = "UPDATE wpk4_backend_travel_booking_pax SET co_order_id='$co_orderid' WHERE order_id='$orderid' && co_order_id = '' && product_id = '$productid'";
					$result= mysqli_query($mysqli,$sql_update);	
				}
				else // already divided on order id
				{
					$last_co_id_number = $int = (int)ltrim($last_co_id_2, 'D');
					$finalco_order_id_for_existingorder = 'D'.$last_co_id_number+1;
					$co_orderid= $finalco_order_id_for_existingorder;
					$sql_update = "UPDATE wpk4_backend_travel_bookings SET co_order_id='$finalco_order_id_for_existingorder',divided_date='$divided_date' WHERE order_id='$orderid' && product_id = '$productid' && co_order_id = ''";
					$result= mysqli_query($mysqli,$sql_update);
				
					$sql_update = "UPDATE wpk4_backend_travel_booking_pax SET co_order_id='$finalco_order_id_for_existingorder' WHERE order_id='$orderid' && co_order_id = '' && product_id = '$productid'";
					$result= mysqli_query($mysqli,$sql_update);	
				}
			}
			$query_paxc = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$orderid' order by co_order_id DESC LIMIT 1";
			$result_paxc = mysqli_query($mysqli, $query_paxc);
			$row_paxc = mysqli_fetch_assoc($result_paxc);
			$last_co_id = $row_paxc['co_order_id'];
			$last_co_id_number = $int = (int)ltrim($last_co_id, 'D');
			$finalco_order_id = 'D'.$last_co_id_number+1;
			$countpax = count($_POST['pax_ids_for_new_order']);
			
			$query_orderinfo = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$orderid' && product_id = '$productid' && co_order_id = '$co_orderid'";
			$result_orderinfo = mysqli_query($mysqli, $query_orderinfo);
			$row_orderinfo = mysqli_fetch_assoc($result_orderinfo);
			$auto_id = $row_orderinfo['auto_id']; $order_date = $row_orderinfo['order_date']; $order_date_date = date('Y-m-d', strtotime($order_date)); $order_date_time = date('H:i:s', strtotime($order_date));
			$order_date = $order_date_date . ' ' . $order_date_time;
			$t_type = $row_orderinfo['t_type']; $new_product_id = $row_orderinfo['new_product_id']; $travel_date = $row_orderinfo['travel_date']; $travel_date = date('Y-m-d', strtotime($travel_date)).' 00:00:00';
			$product_title = $row_orderinfo['product_title']; $total_pax = $row_orderinfo['total_pax']; $source = $row_orderinfo['source']; $trip_code = $row_orderinfo['trip_code'];
			$dom_date = $row_orderinfo['dom_date']; $remarks = $row_orderinfo['remarks']; $agent_info = $row_orderinfo['agent_info']; $total_amount = $row_orderinfo['total_amount'];
			$payment_ref = $row_orderinfo['payment_ref']; $payment_status = $row_orderinfo['payment_status']; $late_modified = $row_orderinfo['late_modified']; $modified_by = $row_orderinfo['modified_by'];
			$deposit_amount = $row_orderinfo['deposit_amount']; $total_pax_new = $total_pax - $countpax;
			$sql_update = "UPDATE wpk4_backend_travel_bookings SET total_pax='$total_pax_new' WHERE order_id='$orderid' && co_order_id = '$co_orderid' && product_id = '$productid'";
			$result= mysqli_query($mysqli,$sql_update);
			if(!empty($_POST['pax_ids_for_new_order'])) 
			{
				foreach($_POST['pax_ids_for_new_order'] as $check) 
				{				
					$sql_update = "UPDATE wpk4_backend_travel_booking_pax SET co_order_id='$finalco_order_id' WHERE auto_id='$check'";
					$result= mysqli_query($mysqli,$sql_update) or die(mysqli_error($mysqli));
				}
				mysqli_query($mysqli,"insert into wpk4_backend_travel_bookings (order_type, order_id, co_order_id, divided_date, t_type, product_id, new_product_id, product_title, total_pax, source, trip_code, dom_date, remarks, agent_info, total_amount, payment_ref, payment_status, modified_by, deposit_amount, travel_date, order_date) 
				values ('WPT', '$orderid', '$finalco_order_id', '$divided_date', '$t_type', '$product_id', '$new_product_id', '$product_title', '$countpax', '$source', '$trip_code', '$dom_date', '$remarks', '$agent_info', '$total_amount', '$payment_ref', '$main_payment_status', '$modified_by', '$deposit_amount', '$travel_date', '$order_date')") or die(mysqli_error($mysqli));
			}
			echo '<script>window.location.href="?option=paxview&tripcode=&date=&or_startdate=&or_enddate=&status=&order_id_filter='.$orderid.'&pnr_filter=&payment_filter=";</script>';
		}
    }
    if(isset($_GET['option']) && $_GET['option']=='movements')
    {
		$orderid = $_GET['orderid']; $productid = $_GET['productid']; $co_orderid = $_GET['co_orderid'];
		$query_pax = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$orderid' && product_id = '$productid' && co_order_id = '$co_orderid' ";
		$result_pax = mysqli_query($mysqli, $query_pax);
		if(!empty($result_pax))
		{ 
			while($row_pax = mysqli_fetch_assoc($result_pax))
			{
				$old_order_id = $row_pax['order_id'];
				$old_old_product_id = $row_pax['product_id'];
				$old_new_product_id = $row_pax['new_product_id'];
				if($old_new_product_id == '')
				{
					$old_db_product_id = $old_old_product_id;
				}
				else
				{
					$old_db_product_id = $old_new_product_id;
				}
				$old_product_title = $row_pax['product_title'];
				$old_trip_code = $row_pax['trip_code'];
				$old_travel_date_int = $row_pax['travel_date'];
				$old_travel_date_dom = $row_pax['dom_date'];
				$old_pax = $row_pax['total_pax'];
				$old_remarks = $row_pax['remarks'];
				?>
				<form action="#" name="statusupdate" method="post" enctype="multipart/form-data" style='font-size:13px;'>
					<p style='font-size:14px;'>Order ID : <?php echo $old_order_id; ?><?php if($co_orderid != '') { echo ' '.$co_orderid; } ?></br>Original Product ID : <?php echo $old_old_product_id; ?></p></br>New Product ID</br><input type='text' name='new_product_id' id='new_product_id' value='<?php echo $old_db_product_id; ?>'></br>Product Title</br><input type='text' name='product_title' id='product_title' value='<?php echo $old_product_title; ?>'></br>
					Trip Code</br><input type='text' name='trip_code' id='trip_code' value='<?php echo $old_trip_code; ?>'></br>
					Travel Date</br><input type='hidden' name='original_travel_date' value='<?php echo $old_travel_date_int; ?>'>
					<input type='text' name='travel_date_int' id='travel_date_int' value='<?php echo $old_travel_date_int; ?>'></br>
					<input type='hidden' name='new_pnr' id='new_pnr'>
					Pax</br><input type='text' name='pax' value='<?php echo $old_pax; ?>'><input type='hidden' name='oldpax' value='<?php echo $old_pax; ?>'></br>
					Remark</br>		
					<input type='text' name='remarks' value='<?php echo $old_remarks; ?>'><input type='hidden' name='oldremarks' value='<?php echo $old_remarks; ?>'></br><input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='movement_updator' value='Save'>
				</form>
				</br><a href='/'>Back to Manage Booking</a>
				<script>
					$(document).on('change', '#travel_date_int', function(){
						var responsemsg_received = '';
						var form_data = new FormData(); // create a new FormData object
						// add any data to the form_data object, as needed
						form_data.append('req_type', 'movements_getproductid');
						form_data.append('date', $('#travel_date_int').val());
						form_data.append('tripcode', $('#trip_code').val());
						$.ajax({
							url: "/wp-content/themes/twentytwenty/templates/tpl_backend_functions.php",
							method: "POST",
							dataType: "json",
							data: form_data,
							contentType: false,
							cache: false,
							processData: false,
							success: function (response) {
								var id = response.id;
								var title = response.title;
								var pnr_resp = response.pnr;
								document.getElementById('new_product_id').value = id;
								document.getElementById('product_title').value = title;
								document.getElementById('new_pnr').value = pnr_resp;
							},
							error: function(xhr, textStatus, errorThrown) {
								console.log(errorThrown);
							}
						});
					});
					$(document).on('change', '#trip_code', function(){
						var responsemsg_received = '';
						var form_data = new FormData(); // create a new FormData object
						// add any data to the form_data object, as needed
						form_data.append('req_type', 'movements_getproductid');
						form_data.append('date', $('#travel_date_int').val());
						form_data.append('tripcode', $('#trip_code').val());
						$.ajax({
							url: "/wp-content/themes/twentytwenty/templates/tpl_backend_functions.php",
							method: "POST",
							dataType: "json",
							data: form_data,
							contentType: false,
							cache: false,
							processData: false,
							success: function (response) {
								var id = response.id;
								var title = response.title;
								var pnr_resp = response.pnr;
								document.getElementById('new_product_id').value = id;
								document.getElementById('product_title').value = title;
								document.getElementById('new_pnr').value = pnr_resp;
							},
							error: function(xhr, textStatus, errorThrown) {
								console.log(errorThrown);
							}
						});
					});
				</script>
				<?php
				if(isset($_POST['movement_updator']))
				{ 
					$orderid = $_GET['orderid']; 
					$productid = $_GET['productid']; 
					$co_orderid = $_GET['co_orderid']; 
					$post_new_product_id = $_POST['new_product_id']; 
					$post_product_title = $_POST['product_title']; 
					$post_trip_code = $_POST['trip_code']; 
					$post_oldremarks = $_POST['oldremarks']; 
					$post_pnr = $_POST['new_pnr'];
					$post_travel_date_int = $_POST['travel_date_int'];
					$original_travel_date = date('Y-m-d', strtotime($_POST['original_travel_date'])).' 00:00:00';
					$post_travel_date_int = date('Y-m-d', strtotime($post_travel_date_int)).' 00:00:00';
					$old_travel_date_int = date('Y-m-d', strtotime($old_travel_date_int)).' 00:00:00';
					$cur_time = date('Y-m-d H:i:s'); $post_oldpax = $_POST['oldpax']; $post_pax = $_POST['pax']; $post_remarks = $_POST['remarks'];
					mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_movements(order_id,product_id,co_order_id,new_product_id,product_title,trip_code,travel_date_int,pax,remarks,updated_on,updated_by) values ('$old_order_id','$old_old_product_id','$co_orderid','$old_new_product_id','$old_product_title','$old_trip_code','$old_travel_date_int','$post_oldpax','$post_oldremarks','$cur_time','$currnt_userlogn')") or die('Main Movement Query failed: '.mysqli_error($mysqli));
					$sql_update_status = "UPDATE wpk4_backend_travel_bookings SET new_product_id='$post_new_product_id',product_title='$post_product_title',trip_code='$post_trip_code',travel_date='$post_travel_date_int',total_pax='$post_pax',remarks='$post_remarks',late_modified='$cur_time',modified_by='$currnt_userlogn' WHERE order_id='$orderid' && product_id='$productid' && co_order_id='$co_orderid'";
					$result_status = mysqli_query($mysqli,$sql_update_status) or die('Main Bookings update Query failed: '.mysqli_error($mysqli));
					$sql_update_ticket_number = "UPDATE wpk4_backend_travel_booking_pax tbp
							SET tbp.ticket_number=NULL, tbp.ticketed_on=NULL, tbp.ticketed_by=NULL, tbp.pax_status='New', tbp.eticket_emailed=NULL, tbp.PNR='$post_pnr'
							WHERE tbp.order_id='$orderid' && tbp.product_id='$productid' && tbp.co_order_id='$co_orderid';";
					$result_update_ticket_number = mysqli_query($mysqli, $sql_update_ticket_number);
					$changed_value = 'date';
					include(get_template_directory().'/gt-manage-custom-pages/stock_change_by_booking.php');
					echo '<script>window.location.href="?option=paxview&tripcode=&date=&or_startdate=&or_enddate=&status=&order_id_filter='.$orderid.'&pnr_filter=&payment_filter=";</script>';				
				}
			}  
		}
    }
    if(isset($_GET['option']) && $_GET['option']=='update-ticket' && (current_user_can( 'administrator' ) || current_user_can( 'ho_operations' ) || current_user_can( 'ticketing_user' ) || current_user_can( 'ticketing_admin' ) || current_user_can( 'user_portal_complaint_editor_admin' )))
    {
        $order_id = $_GET['id'];
        $product_i = $_GET['product_i'];
        $co_orderid = $_GET['co_orderid'];
        $pax_id = $_GET['pax_id'];
        $query = "SELECT * FROM wpk4_backend_travel_bookings JOIN wpk4_backend_travel_booking_pax ON 
				        wpk4_backend_travel_bookings.order_id = wpk4_backend_travel_booking_pax.order_id AND 
				        wpk4_backend_travel_bookings.co_order_id = wpk4_backend_travel_booking_pax.co_order_id AND 
				        wpk4_backend_travel_bookings.product_id = wpk4_backend_travel_booking_pax.product_id 
				    where wpk4_backend_travel_bookings.order_id = '$order_id' AND wpk4_backend_travel_booking_pax.auto_id = '$pax_id'
				    order by wpk4_backend_travel_bookings.order_id desc";
        $result = mysqli_query($mysqli, $query) or die(mysqli_error($mysqli));
		$row_counter_ticket = mysqli_num_rows($result);
        $row = mysqli_fetch_assoc($result);
        {
            $order_id = $row['order_id'];
            $auto_id = $row['auto_id'];
        	$pnr = $row['pnr'];
            echo 'Order ID: '. $order_id . '</br>';
            echo 'Trip: '. $row['trip_code'] . ' ' . $row['travel_date'] . '</br>';
            echo 'Pax: '.$row['salutation'] . ' ' . $row['fname'] . ' ' . $row['lname'] . '</br>';
            
            $tripcode_divided = substr($row['trip_code'], 8, 2);
            $query2 = "SELECT airline_code FROM wpk4_backend_travel_booking_airline_code where iata_code = '$tripcode_divided' ";
            $result2 = mysqli_query($mysqli, $query2) or die(mysqli_error($mysqli));
            $row2 = mysqli_fetch_assoc($result2);
            $airline_code = $row2['airline_code'] ?? '';
        	?>
        	<form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
        	<table>
        	    <tr><th width="15%">PaxID</th><th width="15%">PNR</th><th width="10%">Airline Code</th><th width="20%">Document</th><th width="20%">Document Type</th><th width="20%">Reason</th></tr>
        	    <tr><td><input type='text' name='pax_id' value="<?php echo $auto_id; ?>"></td>
        	    <td><input type='text' name='pnr' value="<?php echo $pnr; ?>"></td><td><input type='text' value="<?php echo $airline_code; ?>" name='airline_code' id='airline_code'  
        	    onblur="validateAINumber()"onkeypress="return isNumberKey(event)" ></td><td><input type='text' name='document' id='document' 
        	    onblur="validateTicketNumber()"onkeypress="return isNumberKey(event)" ></td><td><select name='document_type' style="width:100%; padding:10px;">
        	        <option>Ticket</option><option>EMD</option></select></td><td><select name='reason' style="width:100%; padding:10px;"><option>New (Adult / Child)</option><option>Updated</option>
        	        <option>New (Infant)</option><option>SSR</option><option>Datechange</option><option>Other</option></select></td></tr><tr><th colspan='5'>&nbsp;</th></tr><tr>
        	            <th>Previous Ticket Number (if exists))</th><th>Transaction Amount</th><th>Vendor</th><th>OID</th><th>Issue Date</th><th></th></tr><tr><td><input type='text' name='previous_ticket_number'>
        	            </td>
						<td>
						<input type='text' name='transaction_amount'></td>
						<td>
						<select name='vendor' style="width:100%; padding:10px;">
						<option>GT IATA</option>
        	            <option>IFN IATA</option>
						<option>CT</option>
						<option>Gilpin</option>
						</select></td>
						<td>
						<select name='officeid' style="width:100%; padding:10px;">
						<option>MELA828FN</option>
        	            <option>MELA821CV</option>
						<option>CCUVS32MV</option>
						<option>CCUVS32NQ</option>
						<option>I5FC</option>
						<option>N/A</option></select></td>
						<td><input type='text' name='issue_date' id='issue_date_selector'></td><td></td></tr><tr><td colspan='4'>
        	                <input type='submit' style='float:right;padding:10px; margin:0;font-size:14px; float:right; ' name='save_ticket_numbers' value='Save'></td></tr>
        	</table>
            </form>
        	<script src="https://cdn.jsdelivr.net/gh/alumuko/vanilla-datetimerange-picker@latest/dist/vanilla-datetimerange-picker.js"></script>
		    <script>
			function validateTicketNumber() {
				const phone = document.getElementById("document").value;
				const phoneRegex = /^\d{10}$/;
				if (!phoneRegex.test(phone)) {
				  alert("Invalid document number! Please enter a 10-digit document number.");
				  document.getElementById("document").value = "";
				}		
			}
			function validateAINumber() {
				const phone = document.getElementById("airline_code").value;
				const phoneRegex = /^\d{3}$/;
				if (!phoneRegex.test(phone)) {
				  alert("Invalid airline number! Please enter a 3-digit airline code.");
				  document.getElementById("airline_code").value = "";
				}		
			}
                window.addEventListener("load", function (event) {
            	    var currentdate = new Date(); 
            		var end_maxtime = currentdate.getFullYear() + "-" + (currentdate.getMonth()+1)  + "-" + currentdate.getDate();
            		let drp = new DateRangePicker('issue_date_selector',
                    {
                        timePicker: false,
                        alwaysShowCalendars: true,
            			singleDatePicker: true,
                        autoApply: false,
            			autoUpdateInput: true,
                        locale: {
                            format: "YYYY-MM-DD",
                        }
                    },
            		function (start) {
            			document.getElementById("issue_date_selector").value = start.format();
                    })
                });
            </script>
        	<?php
        	if(isset($_POST['save_ticket_numbers']))
			{
			    $order_id = $_GET['id'];
			    $pax_id = $_POST['pax_id'];
				$pnr = $_POST['pnr'];
				$airline_code = $_POST['airline_code'];
				$document = $_POST['document'];
				$document_type = $_POST['document_type'];
				$reason = $_POST['reason'];
				$previous_ticket_number = $_POST['previous_ticket_number'];
				$transaction_amount = $_POST['transaction_amount'];
				$vendor = $_POST['vendor'];
				$officeid = $_POST['officeid'];
				
				$issue_date = $_POST['issue_date'];
				$issue_date2 = $issue_date. ' 00:00:00';
				if(!($reason == 'Updated' && $previous_ticket_number == ''))
				{
    				global $wpdb;
                    $wpdb->insert('wpk4_backend_travel_booking_ticket_number', array(
                        'pax_id' =>$pax_id,
                        'pnr' =>$pnr,
						'a_l' =>$airline_code,
                        'order_id' =>$order_id,
                        'document' => $document,
                        'document_type' => $document_type,
                        'reason' => $reason,
						'oid' => $officeid,
                        'previous_ticket_number' => $previous_ticket_number,
                        'transaction_amount' => $transaction_amount,
                        'vendor' => $vendor,
                        'issue_date' => $issue_date,
                        'updated_on' => $current_date_and_time,
                        'updated_by' => $currnt_userlogn,
                    ));
                    
                    $sql_update_status = "UPDATE wpk4_backend_travel_booking_pax SET 
							ticket_number = '$document', 
    						ticketed_on = '$issue_date2', 
                            ticketed_by = '$currnt_userlogn' 
                            WHERE auto_id = '$pax_id'";
					$result_status= mysqli_query($mysqli,$sql_update_status);
										
					mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
					values ('$order_id','','$pax_id','ticket_number','$previous_ticket_number','$current_date_and_time','$currnt_userlogn')") or die(mysqli_error($mysqli));
					
					if ( ctype_digit($order_id) && strlen($order_id) <= 7 ) 
					{
            			echo '<script>window.location.href="/manage-ticketing/?option=gdeals-bookings&tripcode=&date=&or_startdate=&or_enddate=&status=&order_id_filter=&pnr_filter=&payment_filter=&domestic_filter=&namereplacement_selector=&travel_type_filter=";</script>';
                	} 
                	elseif (ctype_alpha($order_id)) 
                	{
                		echo '<script>window.location.href="/manage-ticketing/?option=fit-bookings&tripcode=&date=&or_startdate=&or_enddate=&status=&order_id_filter=&pnr_filter=&payment_filter=&domestic_filter=&namereplacement_selector=&travel_type_filter=";</script>';
                	} 
                	else 
                	{
                		echo '<script>window.location.href="/manage-ticketing/?option=fit-bookings&tripcode=&date=&or_startdate=&or_enddate=&status=&order_id_filter=&pnr_filter=&payment_filter=&domestic_filter=&namereplacement_selector=&travel_type_filter=";</script>';
                	}
               	}
				else
				{
				    echo '<script>alert("Previous ticket number should be filled.");</script>'; 
				}
			}
        }
    }
    if(isset($_GET['option']) && $_GET['option']=='view')
        {
        	$orderauto_id = $_GET['id'];
        	$original_co_order_id = '';
        	if(isset($_GET['co_orderid']))
        	{
        	    $original_co_order_id = $_GET['co_orderid'];
        	}
        	
        	$query = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$orderauto_id' && co_order_id = '$original_co_order_id'";
        	$result = mysqli_query($mysqli, $query);
        	$row = mysqli_fetch_assoc($result);
        	if(mysqli_num_rows($result) > 0)
        	{
            	if($row['payment_status'] == 'pending') { $txt_payment_status = 'Pending'; } else if($row['payment_status'] == 'partially_paid') { $txt_payment_status = 'Partially Paid'; } else if($row['payment_status'] == 'paid') { $txt_payment_status = 'Paid'; } else if($row['payment_status'] == 'canceled') { $txt_payment_status = 'Xxln With Deposit'; } else if($row['payment_status'] == 'N/A') { $txt_payment_status = 'Failed'; } else if($row['payment_status'] == 'refund') { $txt_payment_status = 'Refund Done'; } else if($row['payment_status'] == 'waiting_voucher') { $txt_payment_status = 'Refund Under Process'; } else if($row['payment_status'] == 'receipt_received') { $txt_payment_status = 'Receipt Received'; } else if($row['payment_status'] == 'voucher_submited') { $txt_payment_status = 'Rebooked'; } else { $txt_payment_status = 'Pending'; }
            		
            	?>
            	<h5>View Booking</h5>
            	<h5>Order Information</h5>
            		<table class="table" style="width:90%; margin:auto; border:1px solid black;">
            			<tr>
            				<td width="30%">Order ID</td><td><?php echo $row['order_id']; ?><?php if($original_co_order_id != '') { echo ' '.$original_co_order_id; } ?></td>
            			</tr>
            			<tr>
            				<td>Order Date</td><td><?php echo $row['order_date']; ?></td>
            			</tr>
            			<tr>
            				<td>Travel Type</td><td><?php echo $row['t_type']; ?></td>
            			</tr>
            		</table>
            
            	<h5>Payment Information</h5>
            		<?php
            	{
            	    $order_id_api = $row['order_id'];
                				    $order_id = $order_id_api;
                				    $query_initial_order = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api'";
                                	$result_initial_order = mysqli_query($mysqli, $query_initial_order);
                                	$row_initial_order = mysqli_fetch_assoc($result_initial_order);
                                    $order_date = $row_initial_order['order_date'];
                                    $order_type_paymentblock = $row_initial_order['order_type'];
                                    $payment_status = $row_initial_order['payment_status'];
                                    $late_modified = $row_initial_order['late_modified'];
                                    $modified_by = $row_initial_order['modified_by'];
                                    $payment_modified = $row_initial_order['payment_modified'];
                                    $payment_modified_by = $row_initial_order['payment_modified_by'];
                                    $deposit_amount = '';
                                    if($order_type_paymentblock != 'gds')
                                        {
                                            
                                        $total_amount = $row_initial_order['total_amount'];
                                        $deposit_amount = $row_initial_order['deposit_amount'];
                                        $balance = $row_initial_order['balance'];
                                        
                                        
                                            $wpt_coupon_code_array = get_post_meta($order_id_api, 'wp_travel_applied_coupon_data', true);
                                            if(isset($wpt_coupon_code_array) && $wpt_coupon_code_array != '' && isset($wpt_coupon_code_array['coupon_code']) && $wpt_coupon_code_array['coupon_code'] != '')
                                            {
                                                $ordertotal__query = $wpdb->get_results( "SELECT * FROM wpk4_postmeta where post_id='$order_id_api' && meta_key='order_totals'"); 
                                                foreach($ordertotal__query as $row_2){ 
                                                    $order_total_amount = $row_2->meta_value;
                                                }
                                                $orderData = unserialize($order_total_amount);
                                                $total_amount = $orderData['sub_total'];
                                                $balance = $total_amount - $deposit_amount;
                                            }
                                            
                                        }
                                    
                                    $total_amount_gds = 0;
                                    if($order_type_paymentblock == 'gds' && $deposit_amount == '')
                                    {
                                        $deposit_amount = $row_initial_order['deposit_amount'];
                                        $total_amount_gds = get_meta_from_history_of_updates($order_id_api, 'Transaction TotalTurnover');
                                        $total_amount = get_meta_from_history_of_updates($order_id_api, 'Transaction TotalTurnover');
                                        
                                        if($deposit_amount == '')
                                        {
                                            
                                            $deposit_amount_temp = 0;
                                            $query_initial_order_meta = "SELECT * FROM wpk4_backend_history_of_updates where type_id='$order_id_api' && meta_key = 'Payments Amount'";
                                        	$result_initial_order_meta = mysqli_query($mysqli, $query_initial_order_meta);
                                        	while($row_initial_order_meta = mysqli_fetch_assoc($result_initial_order_meta))
                                        	{
                                        	    $deposit_amount_temp = $deposit_amount_temp + (float)$row_initial_order_meta['meta_value'];
                                        	}
                                    	    $deposit_amount = $deposit_amount_temp;
                                        }
                                        $balance = (float)$total_amount - (float)$deposit_amount;
                                    }
                                    
                                    /* Intermediate code added to resolve the issue on G360 GDS total amount shown as 0 after use Update from GDS option. */
                                    if($currnt_userlogn == 'sriharshans')
                                    {
                                    if((float)$total_amount_gds == 0 && $order_type_paymentblock == 'gds')
                                    {
                                        $total_amount = $row_initial_order['total_amount'];
                                        
                                        $deposit_amount = $row_initial_order['deposit_amount'];

                                        if($deposit_amount == '')
                                        {
                                            
                                            $deposit_amount_temp = 0;
                                            $query_initial_order_meta = "SELECT * FROM wpk4_backend_history_of_updates where type_id='$order_id_api' && meta_key = 'Payments Amount'";
                                        	$result_initial_order_meta = mysqli_query($mysqli, $query_initial_order_meta);
                                        	while($row_initial_order_meta = mysqli_fetch_assoc($result_initial_order_meta))
                                        	{
                                        	    $deposit_amount_temp = $deposit_amount_temp + (float)$row_initial_order_meta['meta_value'];
                                        	}
                                    	    $deposit_amount = $deposit_amount_temp;
                                        }
                                        $balance = (float)$total_amount - (float)$deposit_amount;
                                        
                                    }
                                    }
                                    /* Intermediate code ends */
                                    
                                    $query_pnr_for_total_paid = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api'";
                                    $result_pnr_for_total_paid = mysqli_query($mysqli, $query_pnr_for_total_paid);
                                    $row_pnr_for_total_paid = mysqli_fetch_assoc($result_pnr_for_total_paid);
                                	$received_pnr_for_total_paid = $row_pnr_for_total_paid['pnr'];
                                	$processedPaymentsPaid = array();	
                            		$query_payment_paid_amount = "SELECT * FROM wpk4_backend_travel_payment_history where (pay_type = 'deposit' OR pay_type LIKE 'balance' 
                            		OR pay_type LIKE 'Balance' OR pay_type = 'deposit_adjustment' OR pay_type = 'Refund' OR pay_type = 'additional_payment') 
                            		AND order_id='$order_id_api' AND order_id != '' order by process_date desc";
                                    $result_payment_paid_amount = mysqli_query($mysqli, $query_payment_paid_amount);
                                    $total_paid_for_booking = 0;
                                    if($result_payment_paid_amount && mysqli_num_rows($result_payment_paid_amount) > 0)
                                    {
                                        while($row_payment_paid_amount = mysqli_fetch_assoc($result_payment_paid_amount))
                                        {
                                            $payment_identifier = $row_payment_paid_amount['process_date'].'^'.$row_payment_paid_amount['trams_received_amount'].'^'.$row_payment_paid_amount['reference_no']; // defined value to restric duplicate amount + ref no combination on G360
                                			if (in_array($payment_identifier, $processedPaymentsPaid)) 
                                			{
                                			    continue; // Skip to the next value
                                			}
                                				
                                				
                                			$processedPaymentsPaid[] = $payment_identifier;
                                					
                                            $total_paid_for_booking += (float)$row_payment_paid_amount['trams_received_amount'];
                                        }
                                        
                                        $balance = (float)$total_amount - (float)$total_paid_for_booking; 
                                    }
                                    
                                    
                                    if($balance == '')
                            		{
                            		    $balance = (float)$total_amount - (float)$deposit_amount;
                            		}
                				    ?>
                                    Total Amount: <b><?php echo number_format((float)$total_amount, 2, '.', ''); ?></b></br>
                                    Amount paid: <b><?php echo number_format((float)$total_paid_for_booking, 2, '.', ''); ?></b></br>
                                    Balance: <b><?php echo number_format((float)$balance, 2, '.', ''); ?></b>
                                    
                                    <?php
                                    // WPTravel Coupon code
                                    if($order_type_paymentblock == 'WPT')
                                    {
                                        $wpt_coupon_code_array = get_post_meta($order_id_api, 'wp_travel_applied_coupon_data', true);
                                        if(isset($wpt_coupon_code_array) && $wpt_coupon_code_array != '' && isset($wpt_coupon_code_array['coupon_code']) && $wpt_coupon_code_array['coupon_code'] != '')
                                        {
                                            $wpt_coupon_code_type = '';
                                            if($wpt_coupon_code_array['type'] == 'percentage')
                                            {
                                                $wpt_coupon_code_type = '%';
                                            }
                                            ?>
                                            </br></br>
                                            Coupon applied: <b><?php echo $wpt_coupon_code_array['coupon_code']; ?> (Discount: <?php echo $wpt_coupon_code_array['value'].$wpt_coupon_code_type; ?>)</b></br>
                                            <?php
                                        }
                                    }
                                    
                                    // DC total charge section
                                    
                            		$query_payment_dc_amount = "SELECT * FROM wpk4_backend_travel_payment_history WHERE (pay_type = 'Datechange' OR pay_type LIKE 'dc_charge') AND order_id='$order_id_api' AND order_id != '' ORDER BY process_date DESC";
                                    $result_payment_dc_amount = mysqli_query($mysqli, $query_payment_dc_amount);
                                    
                                    // Initialize an array to hold the sums of trams_received_amount for each reference_no
                                    $sums_by_reference = array();
                                    
                                    // Initialize an array to track processed payments (to avoid duplicates)
                                    $processedPaymentsDC = array();
                                    
                                    if (mysqli_num_rows($result_payment_dc_amount) > 0) {
                                        echo '</br></br>';
                                        while ($row_payment_dc_amount = mysqli_fetch_assoc($result_payment_dc_amount)) {
                                            $temp_ref_no = explode("_", $row_payment_dc_amount['reference_no']);
                                            if(!isset($temp_ref_no[1]) || ( isset($temp_ref_no[1]) && $temp_ref_no[1] == '') )
                                            {
                                                $temp_ref_no[1] = 'N/A';
                                            }
                                            
                                            $payment_identifier = $row_payment_dc_amount['process_date'] . '^' . $row_payment_dc_amount['trams_received_amount'] . '^' . $row_payment_dc_amount['reference_no'];
                                    
                                            // Skip duplicate entries
                                            if (in_array($payment_identifier, $processedPaymentsDC)) {
                                                continue;
                                            }
                                            $processedPaymentsDC[] = $payment_identifier;
                                    
                                            // Add the trams_received_amount to the total for the current reference_no
                                            if (!isset($sums_by_reference[$temp_ref_no[1]])) {
                                                $sums_by_reference[$temp_ref_no[1]] = 0.0;
                                            }
                                            
                                            $sums_by_reference[$temp_ref_no[1]] += (float)$row_payment_dc_amount['trams_received_amount'];
                                        }
                                    
                                        // Display the total trams_received_amount for each reference_no
                                        foreach ($sums_by_reference as $reference_no => $totalpaid_case) {
                                            
                                            
                                            $query_dc_pay_status = "SELECT * FROM wpk4_backend_travel_booking_custom_payments where payment_client_id LIKE '%$reference_no%'";
                                            $result_dc_pay_status = mysqli_query($mysqli, $query_dc_pay_status);
                                            $dc_total_payment_for_case = 0;
                                            if(mysqli_num_rows($result_dc_pay_status) > 0)
                                    		{
                                        		while($count_dc_pay_status = mysqli_fetch_assoc($result_dc_pay_status))
                                        		{
                            					    $dc_total_payment_for_case += (float)$count_dc_pay_status['amount'];
                                        		}
                                    		}
                                    		$dc_balance_for_case = $dc_total_payment_for_case - $totalpaid_case;
                                    		
                                    		// assiging dummy 0.00 to avoid negative value as there are no requested amount found.
                                    		if($dc_total_payment_for_case == 0)
                                    		{
                                    		    $dc_balance_for_case = 0.00;
                                    		}
                                    				
                                            echo 'Case: <b>' . $reference_no . '</b><br>
                                            Requested: <b>' . number_format($dc_total_payment_for_case, 2, '.', '') . '</b><br>
                                            Paid: <b>' . number_format($totalpaid_case, 2, '.', '') . '</b><br>
                                            Balance: <b>' . number_format($dc_balance_for_case, 2, '.', '') . '</b><br>';
                                            
                                        }
                                        
                                    }
                                    else
                                    {
                                        echo '<br/>';
                                    }

                                        $query_pnr_for_payments = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api'";
                                        $result_pnr_for_payments = mysqli_query($mysqli, $query_pnr_for_payments);
                                        $row_pnr_for_payments = mysqli_fetch_assoc($result_pnr_for_payments);
                                        $received_order_type_for_payments = $row_pnr_for_payments['order_type'];
                                		$received_pnr_for_payments = $row_pnr_for_payments['pnr'];
                                        $processedPayments = array();
                                        if($received_order_type_for_payments == 'WPT')
                                        {
                                            ?>
                                            <h6>Booking Payment</h6>
                                            <table style="font-size:13px;">
                                                <tr>
                                                    <th>Payment Date</th><th>Type</th><th>Paid Amount</th><th>Reference No</th><th>Remark</th><th>Method</th>
                                                </tr>
                                                <?php
                                                $query_payment_history = "SELECT * FROM wpk4_backend_travel_payment_history where order_id='$order_id_api' AND (pay_type IN ('deposit', 'balance', 'balance ', 'Balance', 'deposit_adjustment', 'Refund', 'additional_payment') OR pay_type IS NULL OR pay_type = '') order by process_date desc";
                                            	$result_payment_history = mysqli_query($mysqli, $query_payment_history);
                                            	if(mysqli_num_rows($result_payment_history) > 0)
                                            	{
                                            	    
                                                	while($row_payment_history = mysqli_fetch_assoc($result_payment_history))
                                                	{
                                                        $payment_identifier = $row_payment_history['process_date'].'^'.$row_payment_history['trams_received_amount'].'^'.$row_payment_history['reference_no']; // defined value to restric duplicate amount + ref no combination on G360
                                    					if (in_array($payment_identifier, $processedPayments)) 
                                    					{
                                    					   continue; // Skip to the next value
                                    					}
                                    							
                                    					$processedPayments[] = $payment_identifier;
                                    						
                                                	    $current_pay_method_id = $row_payment_history['payment_method'];
                                                	    $query_payment_method_finder = "SELECT * FROM wpk4_backend_accounts_bank_account where bank_id='$current_pay_method_id'";
                                                    	$result_payment_method_finder = mysqli_query($mysqli, $query_payment_method_finder);
                                                    	$row_payment_method_finder = mysqli_fetch_assoc($result_payment_method_finder);
                                                    	$row_payment_method_finder_count = mysqli_num_rows($result_payment_method_finder);
                                                    	$bank_account_type_name = '';
                                                    	if($row_payment_method_finder_count > 0)
                                                    	{
                                                    	    $bank_account_type_name = $row_payment_method_finder['account_name'];
                                                    	}
                                                        ?>
                                                        <tr>
                                                            <td><?php echo date('d/m/Y H:i:s', strtotime($row_payment_history['process_date'])); ?></td>
                                                            <td>
                                                                <?php 
                                                                if($row_payment_history['pay_type'] == 'deposit')
                                                                {
                                                                    echo "Booking Deposit"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'balance' || $row_payment_history['pay_type'] == 'balance ' || $row_payment_history['pay_type'] == 'Balance')
                                                                {
                                                                    echo "Booking Balance"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'deposit_adjustment')
                                                                {
                                                                    echo "Booking Deposit Adjustment"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'dc_charge')
                                                                {
                                                                    echo "Datechange"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'Datechange')
                                                                {
                                                                    echo "Datechange"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'additional_payment')
                                                                {
                                                                    echo "Additional Payment"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'Refund')
                                                                {
                                                                    echo "Refund"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'other')
                                                                {
                                                                    echo "Other"; 
                                                                }
                                                                else
                                                                {
                                                                    echo "Unknown"; 
                                                                }
                                                                ?>
                                                            </td>
                                                            <td><?php echo $row_payment_history['trams_received_amount']; ?></td>
                                                            <td><?php echo $row_payment_history['reference_no']; ?></td>
                                                            <td><?php echo $row_payment_history['trams_remarks']; ?></td>
                                                            <td><?php echo $bank_account_type_name; ?></td> 
                                                        </tr>
                                                        <?php
                                                    }
                                            	}
                                            	else
                                        		{
                                        		    echo '<td colspan="6">No record found</td>';
                                        		}
                                            	?>
                                        	</table>
                                        	
                                        	<h6>Other Payment</h6>
                                        	<table style="font-size:13px;">
                                                <tr>
                                                    <th>Payment Date</th><th>Type</th><th>Paid Amount</th><th>Reference No</th><th>Remark</th><th>Method</th>
                                                </tr>
                                            	<?php
                                            	$query_payment_history = "SELECT * FROM wpk4_backend_travel_payment_history where order_id='$order_id_api' AND pay_type IN ('dc_charge', 'Datechange', 'other') order by process_date desc";
                                            	$result_payment_history = mysqli_query($mysqli, $query_payment_history);
                                            	if(mysqli_num_rows($result_payment_history) > 0)
                                            	{
                                            	    
                                                	while($row_payment_history = mysqli_fetch_assoc($result_payment_history))
                                                	{
                                                        $payment_identifier = $row_payment_history['process_date'].'^'.$row_payment_history['trams_received_amount'].'^'.$row_payment_history['reference_no']; // defined value to restric duplicate amount + ref no combination on G360
                                    					if (in_array($payment_identifier, $processedPayments)) 
                                    					{
                                    					   continue; // Skip to the next value
                                    					}
                                    							
                                    					$processedPayments[] = $payment_identifier;
                                    						
                                                	    $current_pay_method_id = $row_payment_history['payment_method'];
                                                	    $query_payment_method_finder = "SELECT * FROM wpk4_backend_accounts_bank_account where bank_id='$current_pay_method_id'";
                                                    	$result_payment_method_finder = mysqli_query($mysqli, $query_payment_method_finder);
                                                    	$row_payment_method_finder = mysqli_fetch_assoc($result_payment_method_finder);
                                                    	$row_payment_method_finder_count = mysqli_num_rows($result_payment_method_finder);
                                                    	$bank_account_type_name = '';
                                                    	if($row_payment_method_finder_count > 0)
                                                    	{
                                                    	    $bank_account_type_name = $row_payment_method_finder['account_name'];
                                                    	}
                                                        ?>
                                                        <tr>
                                                            <td><?php echo date('d/m/Y H:i:s', strtotime($row_payment_history['process_date'])); ?></td>
                                                            <td>
                                                                <?php 
                                                                if($row_payment_history['pay_type'] == 'deposit')
                                                                {
                                                                    echo "Booking Deposit"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'balance' || $row_payment_history['pay_type'] == 'balance ' || $row_payment_history['pay_type'] == 'Balance')
                                                                {
                                                                    echo "Booking Balance"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'deposit_adjustment')
                                                                {
                                                                    echo "Booking Deposit Adjustment"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'dc_charge')
                                                                {
                                                                    echo "Datechange"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'Datechange')
                                                                {
                                                                    echo "Datechange"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'additional_payment')
                                                                {
                                                                    echo "Additional Payment"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'other')
                                                                {
                                                                    echo "Other"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'Refund')
                                                                {
                                                                    echo "Refund"; 
                                                                }
                                                                else
                                                                {
                                                                    echo "Unknown"; 
                                                                }
                                                                ?>
                                                            </td>
                                                            <td><?php echo $row_payment_history['trams_received_amount']; ?></td>
                                                            <td><?php echo $row_payment_history['reference_no']; ?></td>
                                                            <td><?php echo $row_payment_history['trams_remarks']; ?></td>
                                                            <td><?php echo $bank_account_type_name; ?></td> 
                                                            
                                                        </tr>
                                                        <?php
                                                    }
                                            	}
                                            	else
                                        		{
                                        		    echo '<td colspan="6">No record found</td>';
                                        		}
                                        	?>
                                        	</table>
                                        	<?php
                                        }
                                        else
                                        {
                                            ?>
                                            <h6>Booking Payment</h6>
                                            <table style="font-size:13px;">
                                                <tr>
                                                    <th>Payment Date</th><th>Type</th><th>Paid Amount</th><th>Reference No</th><th>Remark</th><th>Method</th>
                                                </tr>
                                                <?php
                                                $payment_history_count = 0;
                                                $query_payment_history = "SELECT * FROM wpk4_backend_travel_payment_history where order_id='$order_id_api' AND order_id != '' AND (pay_type IN ('deposit', 'balance', 'balance ', 'Balance', 'deposit_adjustment', 'Refund') OR pay_type IS NULL OR pay_type = '') order by process_date desc";
                                            	$result_payment_history = mysqli_query($mysqli, $query_payment_history);
                                            	if(mysqli_num_rows($result_payment_history) > 0)
                                            	{
                                                	while($row_payment_history = mysqli_fetch_assoc($result_payment_history))
                                                	{
                                                	    
                                                	    $payment_identifier = $row_payment_history['process_date'].'^'.$row_payment_history['trams_received_amount'].'^'.$row_payment_history['reference_no']; // defined value to restric duplicate amount + ref no combination on G360
                                    					if (in_array($payment_identifier, $processedPayments)) 
                                    					{
                                    					   continue; // Skip to the next value
                                    					}
                                    							
                                    					$processedPayments[] = $payment_identifier;
                                    					
                                                	    $current_pay_method_id = $row_payment_history['payment_method'];
                                                	    $query_payment_method_finder = "SELECT * FROM wpk4_backend_accounts_bank_account where bank_id='$current_pay_method_id'";
                                                    	$result_payment_method_finder = mysqli_query($mysqli, $query_payment_method_finder);
                                                    	$row_payment_method_finder = mysqli_fetch_assoc($result_payment_method_finder);
                                                    	$row_payment_method_finder_count = mysqli_num_rows($result_payment_method_finder);
                                                    	$bank_account_type_name = '';
                                                    	if($row_payment_method_finder_count > 0)
                                                    	{
                                                    	    $bank_account_type_name = $row_payment_method_finder['account_name'];
                                                    	}
                                                	    
                                                	    $payment_history_count++;
                                                        ?>
                                                        <tr>
                                                            <td><?php echo date('d/m/Y H:i:s', strtotime($row_payment_history['process_date'])); ?></td>
                                                            <td>
                                                                <?php 
                                                                if($row_payment_history['pay_type'] == 'deposit')
                                                                {
                                                                    echo "Booking Deposit"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'balance' || $row_payment_history['pay_type'] == 'balance ' || $row_payment_history['pay_type'] == 'Balance')
                                                                {
                                                                    echo "Booking Balance"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'deposit_adjustment')
                                                                {
                                                                    echo "Booking Deposit Adjustment"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'dc_charge')
                                                                {
                                                                    echo "Datechange"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'Datechange')
                                                                {
                                                                    echo "Datechange"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'additional_payment')
                                                                {
                                                                    echo "Additional Payment"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'other')
                                                                {
                                                                    echo "Other"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'Refund')
                                                                {
                                                                    echo "Refund"; 
                                                                }
                                                                else
                                                                {
                                                                    echo "Unknown"; 
                                                                }
                                                                ?>
                                                            </td>
                                                            <td><?php echo $row_payment_history['trams_received_amount']; ?></td>
                                                            <td><?php echo $row_payment_history['reference_no']; ?></td>
                                                            <td><?php echo $row_payment_history['trams_remarks']; ?></td>
                                                            <td><?php echo $bank_account_type_name; ?></td> 
                                                            
                                                        </tr>
                                                        <?php
                                                	}
                                            	}
                                            	else
                                        		{
                                        		    echo '<td colspan="6">No record found</td>';
                                        		}
                                            	?>
                                            </table>
                                            
                                            <h6>Other Payment</h6>
                                        	<table style="font-size:13px;">
                                                <tr>
                                                    <th>Payment Date</th><th>Type</th><th>Paid Amount</th><th>Reference No</th><th>Remark</th><th>Method</th>
                                                </tr>
                                            	<?php
                                                $query_payment_history = "SELECT * FROM wpk4_backend_travel_payment_history where order_id='$order_id_api' AND order_id != '' AND pay_type IN ('dc_charge', 'Datechange', 'additional_payment', 'other') order by process_date desc";
                                            	$result_payment_history = mysqli_query($mysqli, $query_payment_history);
                                            	if(mysqli_num_rows($result_payment_history) > 0)
                                            	{
                                                	while($row_payment_history = mysqli_fetch_assoc($result_payment_history))
                                                	{
                                                	    
                                                	    $payment_identifier = $row_payment_history['process_date'].'^'.$row_payment_history['trams_received_amount'].'^'.$row_payment_history['reference_no']; // defined value to restric duplicate amount + ref no combination on G360
                                    					if (in_array($payment_identifier, $processedPayments)) 
                                    					{
                                    					   continue; // Skip to the next value
                                    					}
                                    							
                                    					$processedPayments[] = $payment_identifier;
                                    					
                                                	    $current_pay_method_id = $row_payment_history['payment_method'];
                                                	    $query_payment_method_finder = "SELECT * FROM wpk4_backend_accounts_bank_account where bank_id='$current_pay_method_id'";
                                                    	$result_payment_method_finder = mysqli_query($mysqli, $query_payment_method_finder);
                                                    	$row_payment_method_finder = mysqli_fetch_assoc($result_payment_method_finder);
                                                    	$row_payment_method_finder_count = mysqli_num_rows($result_payment_method_finder);
                                                    	$bank_account_type_name = '';
                                                    	if($row_payment_method_finder_count > 0)
                                                    	{
                                                    	    $bank_account_type_name = $row_payment_method_finder['account_name'];
                                                    	}
                                                	    
                                                        ?>
                                                        <tr>
                                                            <td><?php echo date('d/m/Y H:i:s', strtotime($row_payment_history['process_date'])); ?></td>
                                                            <td>
                                                                <?php 
                                                                if($row_payment_history['pay_type'] == 'deposit')
                                                                {
                                                                    echo "Booking Deposit"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'balance' || $row_payment_history['pay_type'] == 'balance ' || $row_payment_history['pay_type'] == 'Balance')
                                                                {
                                                                    echo "Booking Balance"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'deposit_adjustment')
                                                                {
                                                                    echo "Booking Deposit Adjustment"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'dc_charge')
                                                                {
                                                                    echo "Datechange"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'Datechange')
                                                                {
                                                                    echo "Datechange"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'additional_payment')
                                                                {
                                                                    echo "Additional Payment"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'other')
                                                                {
                                                                    echo "Other"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'Refund')
                                                                {
                                                                    echo "Refund"; 
                                                                }
                                                                else
                                                                {
                                                                    echo "Unknown"; 
                                                                }
                                                                ?>
                                                            </td>
                                                            <td><?php echo $row_payment_history['trams_received_amount']; ?></td>
                                                            <td><?php echo $row_payment_history['reference_no']; ?></td>
                                                            <td><?php echo $row_payment_history['trams_remarks']; ?></td>
                                                            <td><?php echo $bank_account_type_name; ?></td> 
                                                            
                                                        </tr>
                                                        <?php
                                                	}
                                            	}
                                            	else
                                        		{
                                        		    echo '<td colspan="6">No record found</td>';
                                        		}
                                            	?>
                                        	</table>
                                            <?php
                                        }
            	}
            	
            	$loopi_count = 0;
            	$movement_pax = 0;
            	
            	
            	$query = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$orderauto_id' && co_order_id = '$original_co_order_id'";
            	$result = mysqli_query($mysqli, $query);
            	while($row = mysqli_fetch_assoc($result))
            	{
            	
            		$original_product_id = $row['product_id'];
            		
            			$query_movement = "SELECT * FROM wpk4_backend_travel_booking_movements where order_id='$orderauto_id' && product_id='$original_product_id' && co_order_id = '$original_co_order_id'";
            			$result_movement = mysqli_query($mysqli, $query_movement);
            			$row_movement = mysqli_fetch_assoc($result_movement);
            			$row_movement_count = mysqli_num_rows($result_movement);
            		
            	
            	if($row_movement_count > 0)
            	{
            	    $movement_pax = $row_movement['pax'];
                	?></br>
                		<div class="w3-bar w3-black">
                		  <button id='btoriginal_<?php echo $loopi_count; ?>' class="w3-bar-item w3-button active" style='font-size:12px; width:180px; height:40px;' onclick="Checkchanged_<?php echo $loopi_count; ?>('original')">Current Itinerary</button>
                		  <button id='btchanged_<?php echo $loopi_count; ?>' class="w3-bar-item w3-button" style='font-size:12px; width:180px; height:40px;' onclick="Checkchanged_<?php echo $loopi_count; ?>('changed')">Original Itinerary</button>
                		</div>
                	<?php
            	}
            	if( current_user_can( 'administrator' ) || current_user_can( 'ho_operations' ) || current_user_can( 'ho_payment' )|| current_user_can( 'datechange_manager' ) )
                        {
                        ?>
    						<a href="?option=movements&orderid=<?php echo $orderauto_id; ?>&co_orderid=<?php echo $original_co_order_id; ?>&productid=<?php echo $original_product_id; ?>" class="btn btn-primary"><button style='width:170px; font-size:11px; padding:10px;'>Add Movement</button></a> 
    						<a href="?option=divide&id=<?php echo $orderauto_id; ?>&co_orderid=<?php echo $original_co_order_id; ?>&productid=<?php echo $original_product_id; ?>" class="btn btn-primary"><button style='width:170px; font-size:11px; padding:10px;'>Divide</button></a>
    						<?php
                        }
                        ?>
            		<div id="original_<?php echo $loopi_count; ?>" class="orig_vs_changed_<?php echo $loopi_count; ?>">
            			<h5>Current Trip Information</h5>
            			<table class="table" style="width:90%; margin:auto; border:1px solid black;">
            				<tr>
            					<td width="30%">Product Title</td><td><?php echo $row['product_title']; ?></td>
            				</tr>
            				<tr>
            					<td>Trip Code</td><td><?php echo $row['trip_code']; ?></td>
            				</tr>
            				<tr>
            					<td>Product ID</td><td><?php if($row['new_product_id']!='') { echo $row['new_product_id']; } else { echo $row['product_id']; } ?>
            					</td>
            				</tr>
            				<tr>
            					<td>Travel Date</td><td><?php echo $row['travel_date']; ?></td>
            				</tr>
            				<tr>
            					<td>Travel Date (Domestic)</td><td><?php echo $row['dom_date']; ?></td>
            				</tr>
            				<tr>
            					<td>Pax Count</td><td><?php echo $row['total_pax']; ?> <?php 
            					if($row_movement_count > 0 && $movement_pax != $row['total_pax'])
            					{
            					    echo ' <font style="color:red; font-size:18px; font-weight:700;">*</font>';
            					}
            					?></td>
            				</tr>
            				<tr>
            					<td>Remark</td><td><?php echo $row['remarks']; ?></td>
            				</tr>
            			</table>
            			<?php 
            					if($row_movement_count > 0 && $movement_pax != $row['total_pax'])
            					{
            					    echo '<font style="color:red; font-size:13px; float:right; font-weight:700;">* Pax differs</font>';
            					}
            					?>
            		</div>
            		
            	    <?php
            	    if($row_movement_count > 0)
            	    {
            	    ?>
            		<div id="changed_<?php echo $loopi_count; ?>" class="orig_vs_changed_<?php echo $loopi_count; ?>">
            			<h5>Old Trip Information</h5>
            			<table class="table" style="width:90%; margin:auto; border:1px solid black;">
            				<tr>
            					<td width="30%">Product Title</td><td><?php echo $row_movement['product_title']; ?></td>
            				</tr>
            				<tr>
            					<td>Trip Code</td><td><?php echo $row_movement['trip_code']; ?></td>
            				</tr>
            				<tr>
            					<td>Product ID</td><td><?php if($row_movement['new_product_id']!='') { echo $row_movement['new_product_id']; } else { echo $row_movement['product_id']; } ?></td>
            				</tr>
            				<tr>
            					<td>Travel Date</td><td><?php echo $row_movement['travel_date_int']; ?></td>
            				</tr>
            				<tr>
            					<td>Travel Date (Domestic)</td><td><?php echo $row_movement['travel_date_dom']; ?></td>
            				</tr>
            				<tr>
            					<td>Pax Count</td><td><?php echo $row_movement['pax']; ?></td>
            				</tr>
            				<tr>
            					<td>Remark</td><td><?php echo $row_movement['remarks']; ?></td>
            				</tr>
            			</table>
            		</div>
            		<?php
            	    }
            		?>
            		</br>
            		Pax Details
            		</br>
            	<?php
            	$pax_counter = 1;
            	$selected_orderid = $row['order_id'];
            	$selected_product_id = $row['product_id'];
            	$query_2 = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$selected_orderid' && product_id='$selected_product_id' && co_order_id = '$original_co_order_id'";
            	$result_2 = mysqli_query($mysqli, $query_2);
            	while($row_2 = mysqli_fetch_assoc($result_2))
            	{
            	echo 'Pax '.$pax_counter;
            	echo '</br>';
            	?>
            	
            		<table class="table" style="width:90%; margin:auto; border:1px solid black;">
            			<tr>
            				<td width="30%">Salutation</td><td><?php echo $row_2['salutation']; ?></td>
            			</tr>
            			<tr>
            				<td>First Name</td><td><?php echo $row_2['fname']; ?></td>
            			</tr>
            			
            			<tr>
            				<td>Last Name</td><td><?php echo $row_2['lname']; ?></td>
            			</tr>
            			<tr>
            				<td>Gender</td><td><?php echo $row_2['gender']; ?></td>
            			</tr>
            			<tr>
            				<td>Passport Number</td><td><?php echo $row_2['ppn']; ?></td>
            			</tr>
            			<tr>
            				<td>Passport Expiry</td><td><?php echo $row_2['ppe']; ?></td>
            			</tr>
            			<tr>
            				<td>DOB</td><td><?php echo $row_2['dob']; ?></td>
            			</tr>
            			<tr>
            				<td>Country</td><td><?php echo $row_2['country']; ?></td>
            			</tr>
            			<tr>
            				<td>Meal</td><td><?php echo $row_2['meal']; ?></td>
            			</tr>
            			<tr>
            				<td>Wheelchair</td><td><?php echo $row_2['wheelchair']; ?></td>
            			</tr>
            			<tr>
            				<td>Phone</td><td><?php echo $row_2['phone_pax']; ?></td>
            			</tr>
            			<tr>
            				<td>Email</td><td><?php echo $row_2['email_pax']; ?></td>
            			</tr>
            			<tr>
            				<td>PNR</td><td><?php echo $row_2['pnr']; ?></td>
            			</tr>
            			<tr>
            				<td>Ticket Number</td><td><?php echo $row_2['ticket_number']; ?></td>
            			</tr>
            			<tr>
            				<td>Pax Status</td><td><?php echo $row_2['pax_status']; ?></td>
            			</tr>
            			<tr>
            				<td>e-ticket emailed</td><td><?php echo $row_2['eticket_emailed']; ?></td>
            			</tr>
            			<tr>
            				<td>Adult Order</td><td><a target='_blank' href="?option=view&id=<?php echo $row_2['adult_order']; ?>"><?php echo $row_2['adult_order']; ?></a></td>
            			</tr>
            		</table>
            		</br>
            		
            	<?php
            	$pax_counter++;
            	}
            	echo '</br>';
            	$loopi_count++;
            	echo '<hr>';
            	}
            }
            else
            {
                echo 'No booking found..</br></br></br>';
            }
        	?>
        	<a href='/'>Back to Manage Booking</a>
        	<?php 
        }
        
        if(isset($_GET['option']) && $_GET['option']=='view-tasks')
        {
        ?>
        
        	<script src="https://cdn.jsdelivr.net/gh/alumuko/vanilla-datetimerange-picker@latest/dist/vanilla-datetimerange-picker.js"></script>
        	<script>		
        			window.addEventListener("load", function (event) {
        			let drp = new DateRangePicker('createddate_selector',
                            {
                                timePicker: false,
                                alwaysShowCalendars: true,
                                singleDatePicker: true,
                                autoApply: false,
        						autoUpdateInput: false,
                                locale: {
                                    format: "YYYY-MM-DD",
                                }
                            },
                            function (start) {
        						document.getElementById("createddate_selector").value = start.format();
                            })
        			});
			</script>
			<script type="text/javascript">
			function searchordejs() {
			  
				var category_select = document.getElementById("category_selector").value;
				var status_select = document.getElementById("status_selector").value;
				var createddate_select = document.getElementById("createddate_selector").value;
				var order_id_select = document.getElementById("order_id_selector").value;	
				var email_id_select = document.getElementById("email_id_selector").value;
				
				var createddate_select_length = createddate_select.replace( /\s/g, '' ).length
			
				if(createddate_select_length > 10)
				{
					createddate_select = createddate_select.slice(0, -15);
				}
				else
				{
					createddate_select = createddate_select;
				}
				window.location='?option=view-tasks&category=' + category_select + '&status=' + status_select + '&createdon=' + createddate_select + '&orderid=' + order_id_select + '&email=' + email_id_select;
				
			}
			
			
			</script>
			<h5>Manage Tasks</h5>
			<table class="table" style="width:100%; margin:auto; border:1px solid #adadad;">
			<tr>
			<td width='20%'>Category</br>
			<select name='category_selector' id='category_selector' style="width:100%; padding:10px;">
			<option selected value=''>All</option>
			<option <?php if($_GET['category'] == 'general') { echo 'selected'; } ?> value='general'>General</option>
			<option <?php if($_GET['category'] == 'refund') { echo 'selected'; } ?> value='refund'>Refund</option>
			<option <?php if($_GET['category'] == 'date change') { echo 'selected'; } ?> value='date change'>Date Change</option>
			<option <?php if($_GET['category'] == 'payment followup') { echo 'selected'; } ?> value='payment followup'>Payment Followup</option>
			<option <?php if($_GET['category'] == 'information change') { echo 'selected'; } ?> value='information change'>Information Change</option>
			<option <?php if($_GET['category'] == 'miscellaneous') { echo 'selected'; } ?> value='miscellaneous'>Miscellaneous</option>
			<option <?php if($_GET['category'] == 'adjustment') { echo 'selected'; } ?> value='adjustment'>Payment Adjustment</option>
			</select></td>
			<td width='20%'>
			Status</br>
			<select name='status_selector' id='status_selector' style="width:100%; padding:10px;">
			<option value='' selected>All</option>
			<option value='open' <?php if($_GET['status'] == 'open') { echo 'selected'; } ?>>Open</option>
			<option value='approved' <?php if($_GET['status'] == 'approved') { echo 'selected'; } ?>>Approved</option>
			<option value='rejected' <?php if($_GET['status'] == 'rejected') { echo 'selected'; } ?>>Canceled</option>
			<option value='closed' <?php if($_GET['status'] == 'closed') { echo 'selected'; } ?>>Closed</option>
			</select>
			</td>
			<td width='20%'>Created Date</br>
			<input type='text' name='createddate_selector' onblur='cleardates()' value='<?php if($_GET['createdon'] !='') { echo $_GET['createdon']; } if($_GET['category'] != '' && $_GET['status'] != '' && $_GET['createdon'] != '' && $_GET['orderid'] != '' && $_GET['email'] != '') 
			 { echo date('Y-m-d'); } ?>' id='createddate_selector'>
			</td>
			<td width='20%'>Order ID</br>
			<input type='text' name='order_id_selector' value='<?php if(isset($_GET['orderid'])) { echo $_GET['orderid']; } ?>' id='order_id_selector'></td>
			<td width='20%'>Email ID</br>
			<input type='text' name='email_id_selector' value='<?php if(isset($_GET['email'])) { echo $_GET['email']; } ?>' id='email_id_selector'></td>
			</tr>
			<tr>
			<td colspan='8' style='text-align:center;'>
			<button style='padding:10px; margin:0;font-size:11px; ' id='search_orders' onclick="searchordejs()">Search</button>
			</td>
			</tr>
			</table>
			
			<?php
			$category_filter = $_GET['category'];
			$createdate_filter = $_GET['createdon']; // 2023-01-01
			$createdate_filter_start = substr($_GET['createdon'], 0, 10).' 00:00:00'; // 2023-01-01 00:00:00
			$createdate_filter_end = substr($_GET['createdon'], 0, 10).' 23:59:59'; // 2023-01-01 23:59:59
			
			$status_filter = $_GET['status'];
			$orderid_filter = $_GET['orderid'];
			$email_filter = $_GET['email'];
			
			$common_start_filter = date('Y-m-d').' 00:00:00';
			$common_end_filter = date('Y-m-d').' 23:59:59';
			
			
			if($_GET['category'] != '')
			{
				$category_sql = "wpk4_backend_todo_tasks.comment_type='".$_GET['category']."' && ";
			}
			else
			{
				$category_sql = "wpk4_backend_todo_tasks.auto_id!='EMPTY' && ";
			}
			
			if($_GET['createdon'] != '')
			{
				$createdon_sql = "wpk4_backend_todo_tasks.comment_date_time>='".$createdate_filter_start."' && wpk4_backend_todo_tasks.comment_date_time<='".$createdate_filter_end."' &&";
			}
			else
			{
				$createdon_sql = "wpk4_backend_todo_tasks.auto_id!='EMPTY' && ";
			}
			
			if($_GET['status'] != '')
			{
				$status_sql = "wpk4_backend_todo_tasks.status='".$_GET['status']."' &&";
			}
			else
			{
				$status_sql = "wpk4_backend_todo_tasks.auto_id!='EMPTY' && ";
			}
			
			if($_GET['orderid'] != '')
			{
				$orderid_sql = "wpk4_backend_todo_tasks.order_id='".$_GET['orderid']."' &&";
			}
			else
			{
				$orderid_sql = "wpk4_backend_todo_tasks.auto_id!='EMPTY' && ";
			}
			
			
			if($_GET['email'] != '')
			{
				$email_sql = "wpk4_backend_travel_booking_pax.email_pax='".$_GET['email']."'";
			}
			else
			{
				$email_sql = "wpk4_backend_todo_tasks.auto_id!='EMPTY' ";
			}
			
			if( current_user_can( 'administrator' ) )
			{
				$is_show_all_tasks = 1;
			}
			if(isset($is_show_all_tasks))
			{
				$authorozation_sql = "";
			}
			else
			{
				$authorozation_sql = " AND wpk4_backend_todo_tasks.assigned_to='$currnt_userlogn' ";
			}
				
			
			if($_GET['category'] != '' || $_GET['status'] != '' || $_GET['createdon'] != '' || $_GET['orderid'] != '' || $_GET['email'] != '') 
			{
				if($_GET['email'] != '')
				{
					$query = "SELECT * FROM wpk4_backend_todo_tasks JOIN wpk4_backend_travel_booking_pax ON  wpk4_backend_todo_tasks.order_id = wpk4_backend_travel_booking_pax.order_id 
					where $category_sql $createdon_sql $status_sql $orderid_sql $email_sql 
					order by wpk4_backend_travel_bookings.order_id desc LIMIT 300";
				}
				else 
				{
					$query = "SELECT * FROM wpk4_backend_todo_tasks where $category_sql $createdon_sql $status_sql $orderid_sql $email_sql $authorozation_sql order by auto_id desc LIMIT 100";
				}
			}
			else
			{
				$query = "SELECT * FROM wpk4_backend_todo_tasks order by auto_id desc LIMIT 100";
			}
			
			
			$selection_query = $query;
			$result = mysqli_query($mysqli, $query) or die(mysqli_error($mysqli));
			$row_counter_ticket = mysqli_num_rows($result);
			$auto_numbering = 1;
			$total_paxs = 0;
			?>
			</br>
			
			</br></br>
			<table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
				<thead>
				<tr>
				
				<th>Task</th>
				<th>Order ID</th>
				<th>Status</th>
				<th>Created on</th>
				<th>Created by</th>
				<th>&nbsp;</th>
			  </tr>
			  </thead>
			  <tbody>
			<form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
			<?php
			while($row = mysqli_fetch_assoc($result))
			{
				
				$order_id = $row['order_id'];
				$comment_by = $row['comment_by'];
				$comment_date_time = $row['comment_date_time'];
				$comment_type = $row['comment_type'];
				$payment_received = $row['payment_received'];
				$comment_date_time = $row['comment_date_time'];
				$status = $row['status'];
				
						$total_paxs++;
						$x_id = 1;
						?>
						<tr>
							<td><?php echo $comment_type; ?></td>
							<td><?php echo $order_id; ?></td>
							<td><?php echo $status; ?></td>
							<td><?php echo $comment_date_time; ?></td>
							<td><?php echo $row['comment_by']; ?></td>
							<td><a href="?option=todo&id=<?php echo $order_id; ?>&product_i=&co_orderid=&type=<?php echo $comment_type; ?>" target="_blank" class="btn btn-success">View</a></td>
						</tr>
						<?php
						$x_id++;
						$auto_numbering++;
			}
			?>
			
			
			</tbody>
					
			</table></br>
			<p style='font-size: 13px; float:left;'>Showing <?php echo $total_paxs; ?> Passengers</p>
			</form>
			</br></br>
			<a href='/'>Back to Manage Booking</a>
			<?php
		}
		if(isset($_GET['option']) && $_GET['option']=='edit')
		{
				if( current_user_can( 'administrator' ) || current_user_can( 'wp_travel_bookings_updater' ) || current_user_can( 'ho_operations' ) || current_user_can( 'datechange_manager' ) )
				{
					$editing_access = '';
				}
				else
				{
					$editing_access = 'readonly style="background:#ebebeb;"';
				}
				?>
				<h5>Edit Booking</h5>
				<form action="#" method="post" enctype="multipart/form-data">
    				<?php
    				$orderauto_id = $_GET['id'];
    				$orderproduct_id = $_GET['product_i'];
    				$co_orderid = $_GET['co_orderid'];
    				$query = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$orderauto_id' && product_id='$orderproduct_id' && co_order_id='$co_orderid'";
    				$result = mysqli_query($mysqli, $query);
    				while($row = mysqli_fetch_assoc($result))
    				{
    					$txt_payment_status = $row['payment_status'];
        				?>
        				<h5>Order Information</h5>
        					<table class="table" style="width:90%; margin:auto; border:1px solid black;">
        						<tr>
        							<td>Order ID</td><td><?php echo $row['order_id']; ?><?php if($row['co_order_id'] != '') { echo ' '.$row['co_order_id']; } ?></td>
        						</tr>
        						<tr>
        							<td>Order Date</td><td><?php echo $row['order_date']; ?></td>
        						</tr>
        						<tr>
        							<td>Travel Type</td><td><?php echo $row['t_type']; ?></td>
        						</tr>
        					</table>
        					
        				<h5>Payment Information</h5>
    					<table class="table" style="width:90%; margin:auto; border:1px solid black;">
    						<tr>
    							<td>Total Amount</td><td><?php echo $row['total_amount']; ?></td>
    						</tr>
    						<tr>
    							<td>Payment Ref</td><td><?php echo $row['payment_ref']; ?></td>
    						</tr>
    						<tr>
    							<td>Deposited Amount</td><td><?php echo $row['deposit_amount']; ?></td>
    						</tr>
    						<tr>
    							<td>Payment Status</td><td>
    								<?php
    						
    						if( current_user_can( 'administrator' ) || current_user_can( 'payment_portal_user' ) || current_user_can( 'ho_payment' ) || current_user_can( 'ho_operations' ) )
    							{
    								?>
    							    <input type='hidden' name='payment_status_original' value='<?php echo $txt_payment_status; ?>'>
    								<select name='payment_selector' id='payment_selector' style="width:100%; padding:10px;">
    										<option value='' >Select</option>
    											<?php
    										   if(current_user_can( 'administrator' ) || $currnt_userlogn == 'kajalk' || $currnt_userlogn == 'BinalJ') 
    										   {
    										   ?>
    											<option value='paid' <?php if($txt_payment_status=='paid') { echo 'selected'; } ?>>Paid</option>
    											<option value='receipt_received' <?php if($txt_payment_status=='receipt_received') { echo 'selected'; } ?>>Receipt received</option>
    											<option value='partially_paid' <?php if($txt_payment_status=='partially_paid') { echo 'selected'; } ?>>Partially Paid</option>
    											<option value='refund' <?php if($txt_payment_status=='refund') { echo 'selected'; } ?>>Refund Done</option>
    											<option value='voucher_submited' <?php if($txt_payment_status=='voucher_submited') { echo 'selected'; } ?>>Rebooked</option>
    											<option value='waiting_voucher' <?php if($txt_payment_status=='waiting_voucher') { echo 'selected'; } ?>>Refund Under Process</option>
    											<option value='canceled' <?php if($txt_payment_status=='canceled') { echo 'selected'; } ?>>Xxln With Deposit</option>
    											<option value='pending' <?php if($txt_payment_status=='pending') { echo 'selected'; } ?>>Failed</option>
    											<option value='N/A' <?php if($txt_payment_status=='N/A') { echo 'selected'; } ?>>N/A</option>
    											<?php
    										   }
    										   else
    										   {
    										   ?>
    											<option value='' disabled <?php if($txt_payment_status=='paid') { echo 'selected'; } ?>>Paid</option>
    											<option value='receipt_received' <?php if($txt_payment_status=='receipt_received') { echo 'selected'; } ?>>Receipt received</option>
    											<option value='partially_paid' <?php if($txt_payment_status=='partially_paid') { echo 'selected'; } ?>>Partially Paid</option>
    											<option value='' disabled <?php if($txt_payment_status=='refund') { echo 'selected'; } ?>>Refund Done</option>
    											<option value='' disabled <?php if($txt_payment_status=='voucher_submited') { echo 'selected'; } ?>>Rebooked</option>
    											<option value='' disabled <?php if($txt_payment_status=='waiting_voucher') { echo 'selected'; } ?>>Refund Under Process</option>
    											<option value='' disabled <?php if($txt_payment_status=='pending') { echo 'selected'; } ?>>Failed</option>
    											<option value='' disabled <?php if($txt_payment_status=='N/A') { echo 'selected'; } ?>>N/A</option>
    										   <?php
    										   }
    										   ?>
    								</select>
                    			<?php
                    			}
                    			else
                    			{
                    			    echo "<input type='text' readonly name='payment_status_original' value='".$txt_payment_status."'>";
    
                    			}
                    			?>
    					</td>
    						</tr>
    					</table>
    				
    					<h5>Trip Information</h5>
    					<table class="table" style="width:90%; margin:auto; border:1px solid black;">
    						<tr>
    							<td>Product Title</td><td><input type='text' <?php echo $editing_access; ?> name='product_title' value='<?php echo $row['product_title']; ?>'></td>
    						</tr>
    						<tr>
    							<td>Trip Code</td><td><input type='text' <?php echo $editing_access; ?> name='trip_code' value='<?php echo $row['trip_code']; ?>'></td>
    						</tr>
    						<tr>
    							<td>Product ID</td><td><input type='text' <?php echo $editing_access; ?> name='product_id' value='<?php echo $row['product_id']; ?>'></td>
    						</tr>
    						<tr>
    							<td>Travel Date</td><td><input type='text' <?php echo $editing_access; ?> name='travel_date' value='<?php echo $row['travel_date']; ?>'></td>
    						</tr>
    						
    						<tr>
    							<td>Pax Count</td><td><input type='text' <?php echo $editing_access; ?> name='total_pax' value='<?php echo $row['total_pax']; ?>'></td>
    						</tr>
    					</table>
    					</br>
    					Pax Details
    					</br>
        				<?php
        				$pax_counter = 1;
        				$selected_orderid = $row['order_id'];
        				$selected_product_id = $row['product_id'];
        				$query_2 = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$selected_orderid' && product_id='$selected_product_id' && co_order_id='$co_orderid'";
        				$result_2 = mysqli_query($mysqli, $query_2);
        				while($row_2 = mysqli_fetch_assoc($result_2))
        				{
        				    $pax_auto_id = $row_2['auto_id'];
        				    echo 'Pax '.$pax_counter; echo '</br>';
            				    ?>
            					<table class="table" style="width:90%; margin:auto; border:1px solid black;">
            						<tr>
            							<td>Salutation</td><td><input type='text' name='<?php echo $pax_auto_id; ?>_salutation' value='<?php echo $row_2['salutation']; ?>'></td>
            						</tr>
            						<tr>
            							<td>First Name</td><td><input type='text' name='<?php echo $pax_auto_id; ?>_fname' value='<?php echo $row_2['fname']; ?>'></td>
            						</tr>
            						
            						<tr>
            							<td>Last Name</td><td><input type='text' name='<?php echo $pax_auto_id; ?>_lname' value='<?php echo $row_2['lname']; ?>'></td>
            						</tr>
            						<tr>
            							<td>Gender</td><td><input type='text' name='<?php echo $pax_auto_id; ?>_gender' value='<?php echo $row_2['gender']; ?>'></td>
            						</tr>
            						<tr>
            							<td>Passport Number</td><td><input type='text' name='<?php echo $pax_auto_id; ?>_ppn' value='<?php echo $row_2['ppn']; ?>'></td>
            						</tr>
            						<tr>
            							<td>Passport Expiry</td><td><input type='text' name='<?php echo $pax_auto_id; ?>_ppe' value='<?php echo $row_2['ppe']; ?>'></td>
            						</tr>
            						<tr>
            							<td>DOB</td><td><input type='text' class="dob_datepicker" name='<?php echo $pax_auto_id; ?>_dob' value='<?php echo $row_2['dob']; ?>'></td>
            						</tr>
            						<tr>
            							<td>Country</td><td><input type='text' name='<?php echo $pax_auto_id; ?>_country' value='<?php echo $row_2['country']; ?>'></td>
            						</tr>
            						<tr>
            							<td>Meal</td><td><input type='text' name='<?php echo $pax_auto_id; ?>_meal' value='<?php echo $row_2['meal']; ?>'></td>
            						</tr>
            						<tr>
            							<td>Wheelchair</td><td><input type='text' name='<?php echo $pax_auto_id; ?>_wheelchair' value='<?php echo $row_2['wheelchair']; ?>'></td>
            						</tr>
            						<tr>
            							<td>Phone</td><td><input type='text' name='<?php echo $pax_auto_id; ?>_phone_pax' value='<?php echo $row_2['phone_pax']; ?>'></td>
            						</tr>
            						<tr>
            							<td>Email</td><td><input type='text' name='<?php echo $pax_auto_id; ?>_email_pax' value='<?php echo $row_2['email_pax']; ?>'></td>
            						</tr>
            						<tr>
            							<td>PNR</td><td><input type='text' name='<?php echo $pax_auto_id; ?>_pnr' value='<?php echo $row_2['pnr']; ?>'></td>
            						</tr>
            						<tr>
            							<td>Ticket Number</td><td><input type='text' name='<?php echo $pax_auto_id; ?>_ticket_number' value='<?php echo $row_2['ticket_number']; ?>'></td>
            						</tr>
            						<tr>
            							<td>Pax Status</td><td>
            							<select name='<?php echo $pax_auto_id; ?>_pax_status' style='width:100%; padding:10px;'>
            								<option selected disabled>Select</option>
            								<option value='New' <?php if($row_2['pax_status']=='New'){ echo 'selected'; } ?>>New</option>
            								<option value='Name Updated' <?php if($row_2['pax_status']=='Name Updated'){ echo 'selected'; } ?>>Name Updated</option>
            								<option value='Ticketed' <?php if($row_2['pax_status']=='Ticketed'){ echo 'selected'; } ?>>Ticketed</option>
            							</select>
            							</td>
            						</tr>
            						<tr>
            							<td>e-ticket emailed</td><td>
            							<select name='<?php echo $pax_auto_id; ?>_eticket_emailed' style='width:100%; padding:10px;'>
            								<option selected disabled>Select</option>
            								<option value='Yes' <?php if($row_2['eticket_emailed']=='Yes'){ echo 'selected'; } ?>>Yes</option>
            								<option value='No' <?php if($row_2['eticket_emailed']=='No'){ echo 'selected'; } ?>>No</option>
            							</select>
            							</td>
            						</tr>
            						<tr>
            							<td>Adult Order</td><td><input type='text' name='<?php echo $pax_auto_id; ?>_adult_order' value='<?php echo $row_2['adult_order']; ?>'></td>
            						</tr>
            					</table>
            					</br>
            				    <?php
        				    $pax_counter++;
        				}
        				echo '</br>';
    				}
    				?>
    				<center><input type='submit' name='btn_book_pax' class='btn btn-success' value='Save Changes'></center>
				</form>
				<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link  rel="stylesheet" href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
<style>
.table .model_section,.ui-datepicker-title
{
	visibility:visible !important;
}
</style>
<script>
  function initializeDatePickers($scope) {
  $scope.find('.dob_datepicker').each(function () {
    if ($(this).hasClass('hasDatepicker')) {
      $(this).datepicker('destroy');
    }
    $(this).datepicker({
      dateFormat: 'yy-mm-dd',
      changeMonth: true,
      changeYear: true,
      yearRange: '1900:+0',
      maxDate: 0
    });
  });
}

$(function () {
  initializeDatePickers($(document));
});

</script>

				<a href='/'>Back to Manage Booking</a>
				<?php
				if(isset($_POST['btn_book_pax']))
				{
				    foreach ($_POST as $post_fieldname => $post_fieldvalue) 
    				{
    				    echo $post_fieldname . ' ' . $post_fieldvalue . '</br>' ;
    				}
				    {
    				$current_time_modified = date('Y-m-d H:i:s');
    				
    				global $current_user;
    				wp_get_current_user();
    				$current_usernme = $current_user->user_login;
    				
    				$orderauto_id = $_GET['id'];
    				$orderproduct_id = $_GET['product_i'];
    				
    				$query_checker = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$orderauto_id' && product_id='$orderproduct_id' && co_order_id='$co_orderid'";
    				$result_checker = mysqli_query($mysqli, $query_checker);
    				$row_checker = mysqli_fetch_assoc($result_checker);
					
					if($_POST['product_title'] == $row_checker['product_title'])
					{
						$product_title = $row_checker['product_title'];
					}else
					{
						$product_title = $_POST['product_title'];
					}
					if($_POST['trip_code'] == $row_checker['trip_code'])
					{
						$trip_code = $row_checker['trip_code'];
					}else
					{
						$trip_code = $_POST['trip_code'];
					}
					if($_POST['product_id'] == $row_checker['product_id'])
					{
						$product_id = $row_checker['product_id'];
					}else
					{
						$product_id = $_POST['product_id'];
					}
					if($_POST['travel_date'] == $row_checker['travel_date'])
					{
						$travel_date = $row_checker['travel_date'];
					}else
					{
						$travel_date = $_POST['travel_date'];
					}
					if($_POST['total_pax'] == $row_checker['total_pax'])
					{
						$total_pax = $row_checker['total_pax'];
					}else
					{
						$total_pax = $_POST['total_pax'];
					}
					
					$order_type = $row_checker['order_type'] ?? '';

					if(isset($_POST['payment_selector']) && isset($_POST['payment_status_original']))
					{
					    $payment_selector = $_POST['payment_selector'];
					    $payment_selector_originl = $_POST['payment_status_original'];
					}
					else
					{
					    $payment_selector = $_POST['payment_status_original'];
					    $payment_selector_originl = $_POST['payment_status_original'];
					}
					
        			if( ( current_user_can( 'administrator' ) || current_user_can( 'payment_portal_user' ) || current_user_can( 'ho_operations' ) || current_user_can( 'ho_payment' )) &&  
        			        $payment_selector != $payment_selector_originl && $payment_selector != '' )
        			{
    					$sql_update_main = "UPDATE wpk4_backend_travel_bookings SET payment_status='$payment_selector',payment_modified='$current_time_modified',payment_modified_by='$current_usernme' 
    					WHERE order_id='$orderauto_id' && product_id='$orderproduct_id' && co_order_id='$co_orderid'";
    					$resultmain= mysqli_query($mysqli,$sql_update_main);
						
						$sql_update_main2 = "UPDATE wpk4_backend_travel_bookings_realtime SET payment_status='$payment_selector',payment_modified='$current_time_modified',payment_modified_by='$current_usernme' 
    					WHERE order_id='$orderauto_id' && product_id='$orderproduct_id' && co_order_id='$co_orderid'";
    					$resultmain2 = mysqli_query($mysqli,$sql_update_main2);
    					
    					if($payment_selector != 'paid' && $payment_selector != 'partially_paid')
                		{
                		    $sql_update_pax_pnr = "UPDATE wpk4_backend_travel_booking_pax SET pnr = '', ticket_number = '' WHERE order_id = '$orderauto_id' and product_id='$orderproduct_id' and order_type = 'WPT'";
                		    $resultpax_pnr = mysqli_query($mysqli, $sql_update_pax_pnr);
							
							$sql_update_pax_pnr2 = "UPDATE wpk4_backend_travel_booking_pax_realtime SET pnr = '', ticket_number = '' WHERE order_id = '$orderauto_id' and product_id='$orderproduct_id' and order_type = 'WPT'";
                		    $resultpax_pnr2 = mysqli_query($mysqli, $sql_update_pax_pnr2);
                		}
    					
    					mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,co_order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
    					values ('$orderauto_id','$co_orderid','$orderproduct_id','','payment_status','$payment_selector','$current_time_modified','$current_usernme')") or die(mysqli_error($mysqli));
    				}
				
    				$query_3_duplicater_check = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$orderauto_id' && product_id!='$orderproduct_id' ";
    				$result_3_duplicater_check = mysqli_query($mysqli, $query_3_duplicater_check);
    				$row_3_duplicater_check = mysqli_num_rows($result_3_duplicater_check);				
    			
    				$query_2_checker = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$orderauto_id' && product_id='$orderproduct_id' && co_order_id='$co_orderid'";
    				$result_2_checker = mysqli_query($mysqli, $query_2_checker);
    				
    				while($row_2_checker = mysqli_fetch_assoc($result_2_checker))
    				{
    					$row_auto_id_pax = $row_2_checker['auto_id'];
						
						$pax_fname = $row_2_checker['fname'];
						$pax_lname = $row_2_checker['lname'];
						
    					$is_updatedf = 0;
    					foreach($row_2_checker as $columnname_db => $db_value)
    					{
    						$dbcolumn_and_postname_checker = $row_auto_id_pax.'_'.$columnname_db;
    						foreach ($_POST as $post_fieldname => $post_fieldvalue) 
    						{
    							if($post_fieldname == $dbcolumn_and_postname_checker && $db_value != $post_fieldvalue)
    							{
    								$is_updatedf = 1;
    								$query_4_pp_selecter = "SELECT * FROM wpk4_backend_travel_booking_pax where auto_id='$row_auto_id_pax' ";
    								$result_4_pp_selecter = mysqli_query($mysqli, $query_4_pp_selecter);
    								$row_4_pp_selecter = mysqli_fetch_assoc($result_4_pp_selecter);
    								$ppnum = $row_4_pp_selecter['ppn'];
    		
    								$sql_update_pax = "UPDATE wpk4_backend_travel_booking_pax SET $columnname_db = '$post_fieldvalue' WHERE order_id='$orderauto_id' AND product_id='$orderproduct_id' AND auto_id='$row_auto_id_pax'";
    								$resultpax= mysqli_query($mysqli,$sql_update_pax);
									
									$sql_update_pax2 = "UPDATE wpk4_backend_travel_booking_pax_realtime SET $columnname_db = '$post_fieldvalue' WHERE order_id='$orderauto_id' AND product_id='$orderproduct_id' AND fname='$pax_fname' AND lname='$pax_lname' ";
    								$resultpax2 = mysqli_query($mysqli,$sql_update_pax2);
    								
    								mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
					                values ('$orderauto_id','','$row_auto_id_pax','$columnname_db','$post_fieldvalue','$current_time_modified','$current_usernme')") or die(mysqli_error($mysqli));
    							
    								$restricted_fields_for_loopedit = array("pnr", "ticket_number", "pax_status", "eticket_emailed");

    							}
    						}
    					}
    					if($is_updatedf == 1)
    					{
    						$sql_update_pax2 = "UPDATE wpk4_backend_travel_booking_pax SET late_modified='$current_time_modified',modified_by = '$current_usernme' WHERE auto_id='$row_auto_id_pax'";
    						$resultpax2= mysqli_query($mysqli,$sql_update_pax2);
    					}
    				}
    				if( current_user_can( 'administrator' ) || current_user_can( 'payment_portal_user' ) || current_user_can( 'ho_operations' ) || current_user_can( 'ho_payment' ) )
    				{
    				    if($_POST['product_id'] != $orderproduct_id)
    				    {
    						$orderproduct_id = $_POST['product_id'];
    					}
    					else
    					{
    						$orderproduct_id = $orderproduct_id;
    					}
    					$changed_value = 'status';
    					$payment_status_original = $_POST['payment_status_original'];
    					include(get_template_directory().'/gt-manage-custom-pages/stock_change_by_booking.php');

						
    				}
					
					if(($payment_selector == 'paid' ) && ($payment_status_original == 'partially_paid' || $payment_status_original == 'refund' || $payment_status_original == 'voucher_submited' || $payment_status_original == 'waiting_voucher' || $payment_status_original == 'canceled' || $payment_status_original == 'N/A') && $order_type == 'WPT') // from other status to paid
					{
							
						gdeal_name_update_ajax($orderauto_id);	
							
						mysqli_query($mysqli,"insert into wpk4_amadeus_name_update_payment_status_log (order_id, order_type, updated_by, updated_on, is_processed_amadeus, amadeus_processed_on, page_title ) 
						values ('$orderauto_id', '$order_type', '$current_usernme', '$current_time_modified', 'yes', '$current_time_modified', 'G360 Edit')") or die(mysqli_error($mysqli));
					}
						
			       echo '<script>window.location.href="?option=paxview&tripcode=&date=&or_startdate=&or_enddate=&status=&order_id_filter='.$orderauto_id.'&pnr_filter=&payment_filter=";</script>';
				    }
				}
        }
        if(isset($_GET['option']) && $_GET['option']=='order-history')
        {
            $order_id = $_GET['id'];
            
            $query_initial_order = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id'";
        	$result_initial_order = mysqli_query($mysqli, $query_initial_order);
        	$row_initial_order = mysqli_fetch_assoc($result_initial_order);
            $order_date = $row_initial_order['order_date'];
            $payment_status = $row_initial_order['payment_status'];
            $late_modified = $row_initial_order['late_modified'];
            $modified_by = $row_initial_order['modified_by'];
            $payment_modified = $row_initial_order['payment_modified'];
            $payment_modified_by = $row_initial_order['payment_modified_by'];
            $total_amount = $row_initial_order['total_amount'];
            $balance = $row_initial_order['balance'];
            ?>
            <div style="font-size:13px;">
                <h5>Order History</h5>
                Order Received on: <b><?php echo $order_date; ?></b></br>
                Deposit Received on: <b><?php echo $order_date; ?></b></br>
                Payment Status: <b><?php echo $payment_status; ?></b></br>
                Payment Status changed on: <b><?php echo $payment_modified; ?></b> by <b><?php echo $payment_modified_by; ?></b></br>
                Total Amount: <b><?php echo $total_amount; ?></b></br>
                Balance: <b><?php echo $balance; ?></b></br>
                
                <h5>Payment History</h5>
                <table style="font-size:13px;">
                    <tr><th>Payment Date</th><th>Paid Amount</th><th>Reference No</th></tr>
                <?php
                $query_payment_history = "SELECT * FROM wpk4_backend_travel_payment_history where order_id='$order_id'";
            	$result_payment_history = mysqli_query($mysqli, $query_payment_history);
            	while($row_payment_history = mysqli_fetch_assoc($result_payment_history))
            	{
                ?>
                <tr><td><?php echo $row_payment_history['process_date']; ?></td><td><?php echo $row_payment_history['trams_received_amount']; ?></td><td><?php echo $row_payment_history['reference_no']; ?></td></tr>
                
                <?php
            	}
            	?>
                </table>
				
				<h5>Task History</h5>
                <?php
                $query_task_history = "SELECT * FROM wpk4_backend_todo_tasks where order_id='$order_id' order by comment_type, comment_date_time";
            	$result_task_history = mysqli_query($mysqli, $query_task_history);
				$count_task_history = mysqli_num_rows($result_task_history);
				if($count_task_history > 0)
				{
					?>
					<table style="font-size:13px;">
						<tr><th>Task Type</th><th>Initiated on</th><th>By</th><th>Status</th><th>Link</th></tr>
						<?php
						while($row_task_history = mysqli_fetch_assoc($result_task_history))
						{
							$task_order_id = $row_task_history['order_id'];
							$task_product_id = $row_task_history['product_id'];
						?>
						<tr><td><?php echo $row_task_history['comment_type']; ?></td><td><?php echo $row_task_history['comment_date_time']; ?></td><td><?php echo $row_task_history['comment_by']; ?></td><td><?php echo $row_task_history['status']; ?></td><td><a href="?option=todo&id=<?php echo $task_order_id; ?>&product_i=<?php echo $task_product_id; ?>&co_orderid=&type=<?php echo $row_task_history['comment_type']; ?>">View</a></td></tr>
						<?php
						}
						?>
					</table>
					<?php
				}
				else
				{
					echo 'No task created';
				}
            	?>
				
                <h5>Movement History</h5>
                <?php
                $query_movement_history = "SELECT * FROM wpk4_backend_travel_booking_movements where order_id='$order_id' order by product_id";
            	$result_movement_history = mysqli_query($mysqli, $query_movement_history);
				$count_movement_history = mysqli_num_rows($result_movement_history);
				if($count_movement_history > 0)
				{
					?>
					<table style="font-size:13px;">
						<tr><th>Original Product ID</th><th>New Product ID</th><th>TripCode</th><th>Travel Date</th><th>Pax</th></tr>
						<?php
						while($row_movement_history = mysqli_fetch_assoc($result_movement_history))
						{
						?>
						<tr><td><?php echo $row_movement_history['product_id']; ?></td><td><?php echo $row_movement_history['new_product_id']; ?></td><td><?php echo $row_movement_history['trip_code']; ?></td><td><?php echo $row_movement_history['travel_date_int']; ?></td><td><?php echo $row_movement_history['pax']; ?></td></tr>
						<?php
						}
						?>
					</table>
					<?php
				}
				else
				{
					echo 'No movement happened';
				}
            	?>
                

                <h5>Ticketing History</h5>
                <table style="font-size:13px;">
                    <tr><th>Type</th><th>Content</th><th>Date</th><th>By</th></tr>
                <?php
                $processedOrders = []; // processed meta_key and merge with updated date to skip duplicates
				$processedPax = []; // skip the posted pax details
				
                
                $query_payment_history = "SELECT * FROM wpk4_backend_travel_booking_update_history where order_id='$order_id' order by pax_auto_id, updated_time ASC";
            	$result_payment_history = mysqli_query($mysqli, $query_payment_history);
            	while($row_payment_history = mysqli_fetch_assoc($result_payment_history))
            	{
					$pax_auto_id = $row_payment_history['pax_auto_id'];
					$query_payment_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id' && auto_id = '$pax_auto_id'";
					$result_payment_pax = mysqli_query($mysqli, $query_payment_pax);
					$row_payment_pax = mysqli_fetch_assoc($result_payment_pax);
					if(mysqli_num_rows($result_payment_pax) > 0)
					{
					    $pax_id_received = $row_payment_pax['auto_id'];
						if (!in_array($pax_id_received, $processedPax)) {
								$is_pax_name_posted = 1;
							}
							else
							{
								$is_pax_name_posted = 0;
							}
							
						$processedPax[] = $pax_id_received;
						if($is_pax_name_posted == 1)
						{
						?>
							<tr>
								<td colspan="4"><b><?php echo $row_payment_pax['salutation']; ?> <?php echo $row_payment_pax['fname']; ?> <?php echo $row_payment_pax['lname']; ?></b></td>
							</tr>
						<?php
						}
					}
							$updating_value = $row_payment_history['meta_key'].$row_payment_history['pax_auto_id'].$row_payment_history['updated_time'];
							
							if (in_array($updating_value, $processedOrders)) {
								continue; // Skip to the next iteration if the order ID is already processed
							}
							$processedOrders[] = $updating_value;
						?>
							<tr>
								<td><?php echo $row_payment_history['meta_key']; ?></td>
								<td><?php echo $row_payment_history['meta_value']; ?></td>
								<td><?php echo $row_payment_history['updated_time']; ?></td>
								<td><?php echo $row_payment_history['updated_user']; ?></td>
							</tr>
						
						<?php
					
            	}
            	?>
                </table>

            </div>
            <?php
        }
        if(isset($_GET['option']) && $_GET['option']=='payments')
        {
        	
        	
        		if( current_user_can( 'administrator' ) || current_user_can( 'ho_operations' ) )
        		{
        			$editing_access = '';
        		}
        		else
        		{
        			$editing_access = 'disabled';
        		}
        	
        	?>
        	<h5>Edit Payments</h5>
        	<form action="#" method="post" enctype="multipart/form-data">
        	<?php
        	$orderauto_id = $_GET['id'];
        	$query = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$orderauto_id'";
        	$result = mysqli_query($mysqli, $query);
        	$row = mysqli_fetch_assoc($result);
        	if(mysqli_num_rows($result) > 0) 
        	{
        	    $orderproduct_id = $row['product_id'];
        		$order_type_for_payment = $row['order_type'];
        		$co_orderid = $row['co_order_id'];
        		$txt_payment_status = $row['payment_status'];
        	?>
        	<h5>Order Information</h5>
        		<table class="table" style="width:90%; margin:auto; border:1px solid black;">
        			<tr>
        				<td>Order ID</td><td><?php echo $row['order_id']; ?></td>
        			</tr>
        			<tr>
        				<td>Order Date</td><td><?php echo $row['order_date']; ?></td>
        			</tr>
        			<tr>
        				<td>Travel Type</td><td><?php echo $row['t_type']; ?></td>
        			</tr>
        		</table>
        		
        	<h5>Payment Information</h5>
        		<table class="table" style="width:90%; margin:auto; border:1px solid black;">
        			<tr>
        				<td>Total Amount</td><td><?php echo $row['total_amount']; ?></td>
        			</tr>
        			<tr>
        				<td>Payment Ref</td><td><?php echo $row['payment_ref']; ?></td>
        			</tr>
        			<tr>
        				<td>Deposited Amount</td><td><?php echo $row['deposit_amount']; ?></td>
        			</tr>
        			<tr>
        				<td>Payment Status</td><td>
        			<input type='hidden' name='payment_status_original' value='<?php echo $txt_payment_status; ?>'>
        		<select name='payment_selector' id='payment_selector' style="width:100%; padding:10px;">
        		   <?php
        		   if(current_user_can( 'administrator' ) || current_user_can( 'ho_operations' ) || (current_user_can( 'ticketing_admin' ) && $order_type_for_payment == 'gds' ) || (current_user_can( 'ticketing_user' ) && $order_type_for_payment == 'gds' ) )
        		   {
        		   ?>
                    <option value='paid' <?php if($txt_payment_status=='paid') { echo 'selected'; } ?>>Paid</option>
                    <option value='receipt_received' <?php if($txt_payment_status=='receipt_received') { echo 'selected'; } ?>>Receipt received</option>
                    <option value='partially_paid' <?php if($txt_payment_status=='partially_paid') { echo 'selected'; } ?>>Partially Paid</option>
                    <option value='refund' <?php if($txt_payment_status=='refund') { echo 'selected'; } ?>>Refund Done</option>
                    <option value='voucher_submited' <?php if($txt_payment_status=='voucher_submited') { echo 'selected'; } ?>>Rebooked</option>
                    <option value='waiting_voucher' <?php if($txt_payment_status=='waiting_voucher') { echo 'selected'; } ?>>Refund Under Process</option>
                    <option value='canceled' <?php if($txt_payment_status=='canceled') { echo 'selected'; } ?>>Xxln With Deposit</option>
                    <option value='pending' <?php if($txt_payment_status=='pending') { echo 'selected'; } ?>>Failed</option>
                    <option value='N/A' <?php if($txt_payment_status=='N/A') { echo 'selected'; } ?>>N/A</option>
                    <?php
        		   }
        		   else
        		   {
        		   ?>
                    <option value='' disabled <?php if($txt_payment_status=='paid') { echo 'selected'; } ?>>Paid</option>
                    <option value='receipt_received' <?php if($txt_payment_status=='receipt_received') { echo 'selected'; } ?>>Receipt received</option>
                    <option value='partially_paid' <?php if($txt_payment_status=='partially_paid') { echo 'selected'; } ?>>Partially Paid</option>
                    <option value='' disabled <?php if($txt_payment_status=='refund') { echo 'selected'; } ?>>Refund Done</option>
                    <option value='' disabled <?php if($txt_payment_status=='voucher_submited') { echo 'selected'; } ?>>Rebooked</option>
                    <option value='' disabled <?php if($txt_payment_status=='waiting_voucher') { echo 'selected'; } ?>>Refund Under Process</option>
                    <option value='' disabled <?php if($txt_payment_status=='pending') { echo 'selected'; } ?>>Failed</option>
                    <option value='' disabled <?php if($txt_payment_status=='N/A') { echo 'selected'; } ?>>N/A</option>
                   <?php
        		   }
                   ?>
                    
                    </select>
        		</td>
        			</tr>
        		</table></br>
        	<center><input type='submit' name='btn_book_pax' class='btn btn-success' value='Update Changes'></center>
        	<?php
        	$query = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$orderauto_id' order by travel_date asc";
        	$result = mysqli_query($mysqli, $query);
        	while($row = mysqli_fetch_assoc($result))
        	{
        	?>
        		<h5>Trip Information</h5>
        		<table class="table" style="width:90%; margin:auto; border:1px solid black;">
        			<tr>
        				<td>Product Title</td><td><?php echo $row['product_title']; ?></td>
        			</tr>
        			<tr>
        				<td>Trip Code</td><td><?php echo $row['trip_code']; ?></td>
        			</tr>
        			<tr>
        				<td>Product ID</td><td><?php echo $row['product_id']; ?></td>
        			</tr>
        			<tr>
        				<td>Travel Date</td><td><?php echo $row['travel_date']; ?></td>
        			</tr>
        			
        			<tr>
        				<td>Pax Count</td><td><?php echo $row['total_pax']; ?></td>
        			</tr>
        			
        		</table>
        		
        		
        		</br>
        		Pax Details
        		</br>
        	<?php
        	$pax_counter = 1;
        	$selected_orderid = $row['order_id'];
        	$selected_product_id = $row['product_id'];
        	$query_2 = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$selected_orderid' && product_id='$selected_product_id' && co_order_id='$co_orderid'";
        	$result_2 = mysqli_query($mysqli, $query_2);
        	while($row_2 = mysqli_fetch_assoc($result_2))
        	{
        	$pax_auto_id = $row_2['auto_id'];
        	echo 'Pax '.$pax_counter;
        	echo '</br>';
        	?>
        	
        		<table class="table" style="width:90%; margin:auto; border:1px solid black;">
        			<tr>
        				<td>Salutation</td><td><?php echo $row_2['salutation']; ?></td>
        			</tr>
        			<tr>
        				<td>First Name</td><td><?php echo $row_2['fname']; ?></td>
        			</tr>
        			
        			<tr>
        				<td>Last Name</td><td><?php echo $row_2['lname']; ?></td>
        			</tr>
        			<tr>
        				<td>Gender</td><td><?php echo $row_2['gender']; ?></td>
        			</tr>
        			<tr>
        				<td>Passport Number</td><td><?php echo $row_2['ppn']; ?></td>
        			</tr>
        			<tr>
        				<td>Passport Expiry</td><td><?php echo $row_2['ppe']; ?></td>
        			</tr>
        			<tr>
        				<td>DOB</td><td><?php echo $row_2['dob']; ?></td>
        			</tr>
        			<tr>
        				<td>Country</td><td><?php echo $row_2['country']; ?></td>
        			</tr>
        			<tr>
        				<td>Meal</td><td><?php echo $row_2['meal']; ?></td>
        			</tr>
        			<tr>
        				<td>Wheelchair</td><td><?php echo $row_2['wheelchair']; ?></td>
        			</tr>
        			<tr>
        				<td>Phone</td><td><?php echo $row_2['phone_pax']; ?></td>
        			</tr>
        			<tr>
        				<td>Email</td><td><?php echo $row_2['email_pax']; ?></td>
        			</tr>
        			<tr>
        				<td>PNR</td><td><?php echo $row_2['pnr']; ?></td>
        			</tr>
        			<tr>
        				<td>Ticket Number</td><td><?php echo $row_2['ticket_number']; ?></td>
        			</tr>
        			<tr>
        				<td>Pax Status</td><td>
        				<?php echo $row_2['pax_status']; ?>
        				</td>
        			</tr>
        			<tr>
        				<td>e-ticket emailed</td><td>
        				<?php echo $row_2['eticket_emailed']; ?>
        				</td>
        			</tr>
        			<tr>
        				<td>Adult Order</td><td><?php echo $row_2['adult_order']; ?></td>
        			</tr>
        		</table>
        		</br>
        		
        	<?php
        	$pax_counter++;
        	}
        	echo '</br>';
        	}
        }
        	?>
        	
        	</form>
        	<a href='/'>Back to Manage Booking</a>
        	<?php
        	if(isset($_POST['btn_book_pax']))
        	{
        	$current_time_modified = date('Y-m-d H:i:s');
        	
        	global $current_user;
        	wp_get_current_user();
        	$current_usernme = $current_user->user_login;
        	
        	$orderauto_id = $_GET['id'];
        	
        		if($_POST['payment_selector'] != 'N/A')	
        		{
        		    $payment_selector = strtolower($_POST['payment_selector']);
        		}
        		else
        		{
        		    $payment_selector = $_POST['payment_selector'];
        		}
        
        		$sql_update_main = "UPDATE wpk4_backend_travel_bookings SET payment_status='$payment_selector',payment_modified='$current_time_modified',payment_modified_by='$current_usernme' WHERE order_id='$orderauto_id'";
        		$resultmain= mysqli_query($mysqli,$sql_update_main);
        		
        		if($payment_selector != 'paid' && $payment_selector != 'partially_paid')
                {
                    $sql_update_pax_pnr = "UPDATE wpk4_backend_travel_booking_pax SET pnr = '', ticket_number = '' WHERE order_id = '$orderauto_id' and order_type = 'WPT'";
                	$resultpax_pnr = mysqli_query($mysqli, $sql_update_pax_pnr);
                }
        		
        		if($payment_selector == 'paid' || $payment_selector == 'receipt_received')
        		{
        		$today_date = date("Y-m-d H:i:s");
                $email_subject = "Payment Information - ".$orderauto_id;
                $payment_selector = $payment_selector;
                $order_id = $orderauto_id;
                include(get_template_directory().'/templates/email/tpl_email_trigger_payment.php');
                            
                
                            
                $query_select_order_email = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$orderauto_id' order by auto_id limit 1";
                $result_select_order_email = mysqli_query($mysqli, $query_select_order_email);
                $row_select_order_email = mysqli_fetch_assoc($result_select_order_email);
                $customer_email = $row_select_order_email['email_pax'];
                                		
                global $wpdb;
                $wpdb->insert('wpk4_backend_order_email_history', array(
                    'email_type' =>'Payment Update',
                    'order_id' =>$orderauto_id,
                    'email_address' => $customer_email,
                    'initiated_date' => $today_date,
                    'initiated_by' => $currnt_userlogn,
                    'email_subject' => $email_subject,
                ));
        		}
        		
        		mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,co_order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) values ('$orderauto_id','','','','payment_status','$payment_selector','$current_time_modified','$current_usernme')") or die(mysqli_error($mysqli));
        	
        	
        	  if($order_type_for_payment != 'gds')
        	  {
        	    $changed_value = 'wholeupdate';
        		$payment_status_original = $_POST['payment_status_original'];
                include(get_template_directory().'/gt-manage-custom-pages/stock_change_by_booking.php');
                
                if($order_type_for_payment == 'WPT')
					{
						$payment_info = wptravel_booking_data( $orderauto_id );
                		$payment_id = $payment_info['payment_id'];
        
                			if ( is_array( $payment_id ) ) {
                				if ( count( $payment_id ) > 0 ) {
                					$payment_id = $payment_id[0];
                				}
                			}
                
                		$label_key = $payment_selector;
                		update_post_meta( $payment_id, 'wp_travel_payment_status', $label_key );
                		update_post_meta( $orderauto_id, 'wp_travel_payment_status', $label_key );
					}
        	    }
				
				$payment_status_original = $_POST['payment_status_original'];
				
				if(($payment_selector == 'paid' ) && ($payment_status_original == 'partially_paid' || $payment_status_original == 'refund' || $payment_status_original == 'voucher_submited' || $payment_status_original == 'waiting_voucher' || $payment_status_original == 'canceled' || $payment_status_original == 'N/A') && $order_type_for_payment == 'WPT') // from other status to paid
				{
							
					gdeal_name_update_ajax($orderauto_id);	
												
					mysqli_query($mysqli,"insert into wpk4_amadeus_name_update_payment_status_log (order_id, order_type, updated_by, updated_on, is_processed_amadeus, amadeus_processed_on, page_title ) 
					values ('$orderauto_id', '$order_type_for_payment', '$current_usernme', '$current_time_modified', 'yes', '$current_time_modified', 'G360 Payments')") or die(mysqli_error($mysqli));
				}
        		
        		//echo '<script>window.location.href="?option=payments&id='.$orderauto_id.'";</script>';
        	}
        }
    if(isset($_GET['option']) && $_GET['option']=='managepnr')
    {
    	?>
    	<h5>Ticket Update</h5>
    	<form action="#" method="post" enctype="multipart/form-data">
    	<?php
    	$orderauto_id = $_GET['id'];
    	$orderproduct_id = $_GET['product_i'];
    	$co_orderid = $_GET['co_orderid'];
    	
    	$query = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$orderauto_id' && product_id='$orderproduct_id' && co_order_id='$co_orderid'";
    	$result = mysqli_query($mysqli, $query);
    	while($row = mysqli_fetch_assoc($result))
    	{
    	?>
    	<h6>Order Information</h6>
    		<table class="table" style="width:90%; margin:auto; border:1px solid black;">
    			<tr>
    				<td>Order ID</td><td><?php echo $row['order_id']; ?></td>
    			</tr>
    			<tr>
    				<td>Order Date</td><td><?php echo $row['order_date']; ?></td>
    			</tr>
    		</table>
    		<h6>Trip Information</h6>
    		<table class="table" style="width:90%; margin:auto; border:1px solid black;">
    			<tr>
    				<td>Product Title</td><td><?php echo $row['product_title']; ?></td>
    			</tr>
    			<tr>
    				<td>Trip Code</td><td><?php echo $row['trip_code']; ?></td>
    			</tr>
    			
    			<tr>
    				<td>Travel Date</td><td><?php echo $row['travel_date']; ?></td>
    			</tr>
    		</table>
    		</br>
    		<h6>Pax Details</h6>
    	<?php
		
		if( current_user_can( 'administrator' ) || current_user_can( 'ho_operations' ) )
        		{
        			$editing_access = '';
        		}
        		else
        		{
        			$editing_access = 'readonly';
        		}
				
    	$pax_counter = 1;
    	$selected_orderid = $row['order_id'];
    	$selected_product_id = $row['product_id'];
    	$query_2 = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$selected_orderid' && product_id='$selected_product_id' && co_order_id='$co_orderid'";
    	$result_2 = mysqli_query($mysqli, $query_2);
    	while($row_2 = mysqli_fetch_assoc($result_2))
    	{
    	$pax_auto_id = $row_2['auto_id'];
    	echo 'Pax '.$pax_counter;
    	echo '</br>';
    	?>
    		<table class="table" style="width:90%; margin:auto; border:1px solid black;">
    			<tr>
    				<td>Name</td><td>
    				<table style="margin:0px;"><tr><td width='30%'>
    					<select name='<?php echo $pax_auto_id; ?>_salutation' style='width:100%; padding:10px;'>
    						<option <?php if($row_2['salutation'] == 'Salutation' ) { echo 'selected'; } ?> value="Salutation">Salutation</option>
    						<option <?php if(strtolower($row_2['salutation']) == 'mr' ) { echo 'selected'; } ?> value="Mr">Mr</option>
    						<option <?php if(strtolower($row_2['salutation']) == 'mstr' ) { echo 'selected'; } ?> value="Mstr">Mstr</option>
    						<option <?php if(strtolower($row_2['salutation']) == 'mrs' ) { echo 'selected'; } ?> value="Mrs">Mrs</option>
    						<option <?php if(strtolower($row_2['salutation']) == 'ms' ) { echo 'selected'; } ?> value="Ms">Ms</option>
    						<option <?php if(strtolower($row_2['salutation']) == 'miss' ) { echo 'selected'; } ?> value="Miss">Miss</option>
    					</select></td>
    					<td width='35%'>
						First name
						<input type='text' name='<?php echo $pax_auto_id; ?>_fname' <?php echo $editing_access; ?> value='<?php echo $row_2['fname']; ?>'>
    					</td>
						<td width='35%'>
						Last name
						<input type='text' name='<?php echo $pax_auto_id; ?>_lname' <?php echo $editing_access; ?> value='<?php echo $row_2['lname']; ?>'>
						</td>
						</tr></table>
    				</td>
    			</tr>
    			<tr>
    				<td>Gender</td><td><select name='<?php echo $pax_auto_id; ?>_gender' style='width:100%; padding:10px;'>
    						<option <?php if($row_2['gender'] == 'male' ) { echo 'selected'; } ?> value="male">Male</option>
    						<option <?php if($row_2['gender'] == 'female' ) { echo 'selected'; } ?> value="female">Female</option>
    					</select></td>
    			</tr>
    			<tr>
    				<td>PPN</td><td><?php echo $row_2['ppn']; ?></td>
    			</tr>
				<tr>
					<td>DOB</td><td><input type='text' class="dob_datepicker" name='<?php echo $pax_auto_id; ?>_dob' value='<?php echo $row_2['dob']; ?>'></td>
    			</tr>
				
				<tr>
    				<td>Phone</td><td><input type='text' name='<?php echo $pax_auto_id; ?>_phone_pax' value='<?php echo $row_2['phone_pax']; ?>'></td>
    			</tr>
				
				<tr>
    				<td>Email</td><td><input type='text' name='<?php echo $pax_auto_id; ?>_email_pax' value='<?php echo $row_2['email_pax']; ?>'></td>
    			</tr>
    			
    			<tr>
    				<td>PNR</td><td><input type='text' name='<?php echo $pax_auto_id; ?>_pnr' value='<?php echo $row_2['pnr']; ?>'></td>
    			</tr>
    			<tr>
    				<td>Ticket Number</td><td><input type='text' name='<?php echo $pax_auto_id; ?>_ticket_number' value='<?php echo $row_2['ticket_number']; ?>'></td>
    			</tr>
    			<tr>
    				<td>Pax Status</td><td>
    				<select name='<?php echo $pax_auto_id; ?>_pax_status' style='width:100%; padding:10px;'>
    					<option selected disabled>Select</option>
    					<option value='New' <?php if($row_2['pax_status']=='New'){ echo 'selected'; } ?>>New</option>
    					<option value='Name Updated' <?php if($row_2['pax_status']=='Name Updated'){ echo 'selected'; } ?>>Name Updated</option>
    					<option value='Ticketed' <?php if($row_2['pax_status']=='Ticketed'){ echo 'selected'; } ?>>Ticketed</option>
    					<option disabled></option>
    					<option value='open' <?php if($row_2['pax_status']=='open'){ echo 'selected'; } ?>>Open</option>
    					<option value='flown' <?php if($row_2['pax_status']=='flown'){ echo 'selected'; } ?>>Flown</option>
    				</select>
    				</td>
    			</tr>
    			<tr>
    				<td>e-ticket emailed</td><td>
    				<select name='<?php echo $pax_auto_id; ?>_eticket_emailed' style='width:100%; padding:10px;'>
    					<option selected disabled>Select</option>
    					<option value='Yes' <?php if($row_2['eticket_emailed']=='Yes'){ echo 'selected'; } ?>>Yes</option>
    					<option value='No' <?php if($row_2['eticket_emailed']=='No'){ echo 'selected'; } ?>>No</option>
    				</select>
    				</td>
    			</tr>
    			
    		</table>
    		</br>
    		
    	<?php
    	$pax_counter++;
    	}
    	echo '</br>';
    	}
    	?>
    	<center><input type='submit' name='btn_book_pax' class='btn btn-success' value='Save Ticket Information'></center>
    	</form>
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<link  rel="stylesheet" href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
		<script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
		<style>
		.table .model_section,.ui-datepicker-title
		{
			visibility:visible !important;
		}
		</style>
		<script>
		  function initializeDatePickers($scope) {
		  $scope.find('.dob_datepicker').each(function () {
			if ($(this).hasClass('hasDatepicker')) {
			  $(this).datepicker('destroy');
			}
			$(this).datepicker({
			  dateFormat: 'yy-mm-dd',
			  changeMonth: true,
			  changeYear: true,
			  yearRange: '1900:+0',
			  maxDate: 0
			});
		  });
		}

		$(function () {
		  initializeDatePickers($(document));
		});

		</script>
    	<a href='/'>Back to Manage Booking</a>
    	<?php
    	if(isset($_POST['btn_book_pax']))
    	{
    	$current_time_modified = date('Y-m-d H:i:s');
    	
    	global $current_user;
    	wp_get_current_user();
    	$current_usernme = $current_user->user_login;
    	$orderauto_id = $_GET['id'];
    	$orderproduct_id = $_GET['product_i'];
    	
    	$query_2_checker = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$orderauto_id' && product_id='$orderproduct_id' && co_order_id='$co_orderid'";
    	$result_2_checker = mysqli_query($mysqli, $query_2_checker);
    	
    	while($row_2_checker = mysqli_fetch_assoc($result_2_checker))
    	{
    		$row_auto_id_pax = $row_2_checker['auto_id'];
			
			$row_fname = $row_2_checker['fname'];
			$row_lname = $row_2_checker['lname'];
			
    		$is_updatedf = 0;
    		foreach($row_2_checker as $columnname_db => $db_value)
    		{
    			$dbcolumn_and_postname_checker = $row_auto_id_pax.'_'.$columnname_db;
    			foreach ($_POST as $post_fieldname => $post_fieldvalue) {
    				if($post_fieldname == $dbcolumn_and_postname_checker && $db_value != $post_fieldvalue)
    				{
    					$is_updatedf = 1;
    					$sql_update_pax = "UPDATE wpk4_backend_travel_booking_pax SET $columnname_db='$post_fieldvalue' WHERE order_id='$orderauto_id' && product_id='$orderproduct_id' && auto_id='$row_auto_id_pax'";
    					$resultpax= mysqli_query($mysqli,$sql_update_pax);
						
						$sql_update_pax3 = "UPDATE wpk4_backend_travel_booking_pax_realtime SET $columnname_db='$post_fieldvalue' WHERE order_id='$orderauto_id' && product_id='$orderproduct_id' && fname='$row_fname' and lname = '$row_lname'";
    					$resultpax3 = mysqli_query($mysqli,$sql_update_pax3);
    					
    					mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
					    values ('$orderauto_id','','$row_auto_id_pax','$columnname_db','$post_fieldvalue','$current_time_modified','$current_usernme')") or die(mysqli_error($mysqli));
						
						if($columnname_db == 'email_pax')
						{
							$sql_update_pax = "UPDATE wpk4_backend_travel_bookings SET billing_email = '$post_fieldvalue' WHERE order_id='$orderauto_id' && product_id='$orderproduct_id'";
							$resultpax= mysqli_query($mysqli,$sql_update_pax);
						}
						if($columnname_db == 'phone_pax')
						{
							$sql_update_pax = "UPDATE wpk4_backend_travel_bookings SET billing_phone = '$post_fieldvalue' WHERE order_id='$orderauto_id' && product_id='$orderproduct_id'";
							$resultpax= mysqli_query($mysqli,$sql_update_pax);
						}
    				}
    			}
    		}
    		if($is_updatedf==1)
    			{	
    				$sql_update_pax2 = "UPDATE wpk4_backend_travel_booking_pax SET late_modified='$current_time_modified',modified_by = '$current_usernme' WHERE auto_id='$row_auto_id_pax'";
    				$resultpax2= mysqli_query($mysqli,$sql_update_pax2);
    			}
    	}
       	echo '<script>window.location.href="?option=managepnr&id='.$orderauto_id.'&product_i='.$orderproduct_id.'&co_orderid='.$co_orderid.'";</script>';
    	}
    }
    if(isset($_GET['option']) && $_GET['option']=='comment')
    {
    	?>
    	<h5>Notes</h5>
    	<?php
    	$orderauto_id = $_GET['id'];
    	$orderproduct_id = $_GET['product_i'];
    	
    	$query = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$orderauto_id' && product_id='$orderproduct_id'";
    	$result = mysqli_query($mysqli, $query);
    	$row = mysqli_fetch_assoc($result);
    	{
    	?>
    	<h6>Order Information</h6>
    		<table class="table" style="width:90%; margin:auto; border:1px solid black;">
    			<tr>
    				<td>Order ID</td><td><?php echo $row['order_id']; ?></td>
    			</tr>
    			<tr>
    				<td>Order Date</td><td><?php echo $row['order_date']; ?></td>
    			</tr>
    		</table>
    		<h6>Trip Information</h6>
    		<table class="table" style="width:90%; margin:auto; border:1px solid black;">
    			<tr>
    				<td>Product Title</td><td><?php echo $row['product_title']; ?></td>
    			</tr>
    			<tr>
    				<td>Trip Code</td><td><?php echo $row['trip_code']; ?></td>
    			</tr>
    			<tr>
    				<td>Travel Date</td><td><?php echo $row['travel_date']; ?></td>
    			</tr>
    			
    		</table>
    		</br>
    		<h6>Notes</h6>
    	<table class="table" style="width:90%; margin:auto; border:none;">	
    	<?php
    	$selected_orderid = $row['order_id'];
    	$selected_product_id = $row['product_id'];
    	$query_2 = "SELECT * FROM wpk4_backend_todo_tasks where order_id='$selected_orderid' && product_id='$selected_product_id'";
    	$result_2 = mysqli_query($mysqli, $query_2);
    	$row_2_count = mysqli_num_rows($result_2);
    	while($row_2 = mysqli_fetch_assoc($result_2))
    	{
    		$auto_id_message = $row_2['auto_id'];
    	?>
    			<tr style='background-color:#fcfafa;'>
    				<td><font style='font-size:12px; color:#a6a5a2'>
    				<?php echo $row_2['comment_by']; ?> 
    				on <?php echo $row_2['comment_date_time']; ?> 
    				to <?php echo $row_2['assigned_to']; ?> 
    				&nbsp; 
    				<span style='<?php if($row_2['status']=='open') { echo 'background-color:green;'; } else { echo 'background-color:red;'; } ?>padding:7px; color:white;'><?php echo $row_2['status']; ?></span></font>
    				</td>
    				<td>
    				<form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
    				<select name='<?php echo $auto_id_message; ?>_status'>
    					<option selected disabled>Select</option>
    					<option value='closed' <?php if($row_2['status']=='closed') { echo 'selected'; } ?>>Close</option>
    					<option value='open' <?php if($row_2['status']=='open') { echo 'selected'; } ?>>Open</option>
    				</select>
    				<input type='submit' style='padding:4px; margin:0;font-size:10px; ' name='status_submitter' value='Save'>
    				</form>
    				</td>
    			</tr>
    			<tr style='background-color:#fcfafa;'>
    				<td colspan='2'><?php echo $row_2['comment']; ?></td>
    			</tr>
    		<tr style="height:10px;border:none;"><td colspan='2' style="border:none;">&nbsp;</td></tr>			
    	<?php
    	}
    	if($row_2_count==0)
    	{
    		echo '<tr style="background-color:#fcfafa;">
    				<td colspan="2">No Notes Found..</td>
    			</tr>';
    	}
    	echo '</table></br></br>';
    	}
    	?>
    	<form action="#" name="contactsubmit" method="post" enctype="multipart/form-data">
    	<table class="table" style="width:90%; margin:auto; border:1px solid black;">	
    		<tr>
    			<td>
    			Assigned to
    				<select name='assigned_to' style='width:100%; padding:10px;'>
    				<option selected value='All'>All</option>
    				<?php
    				$query_2 = "SELECT * FROM wpk4_users";
    				$result_2 = mysqli_query($mysqli, $query_2);
    				while($row_2 = mysqli_fetch_assoc($result_2))
    				{
    				?>				
    					<option value='<?php echo $row_2['user_login']; ?>'><?php echo $row_2['user_login']; ?></option>
    				<?php
    				}
    				?>					
    				</select>
    			</td>
    			<td>
    			Complete Before
    				<input type='text' name='complete_before' >
    			</td>
    		</tr>
    		<tr>
    			<td colspan='2'>
    			Comment
    				<textarea name='comment' rows='6'></textarea>
    			</td>
    		</tr>
    	</table></br>
    	<center><input type='submit' name='btn_book_pax' class='btn btn-success' value='Save Comment'></center>
    	</form>
    	<a href='/'>Back to Manage Booking</a>
    	<?php
    	
    	if(isset($_POST['status_submitter']))
    	{
    	$orderauto_id = $_GET['id'];
    	$orderproduct_id = $_GET['product_i'];
    	
    	$current_time_modified = date('Y-m-d H:i:s');
    	
    	global $current_user;
    	wp_get_current_user();
    	$current_usernme = $current_user->user_login;
    	$query_2_checker = "SELECT * FROM wpk4_backend_todo_tasks where order_id='$orderauto_id' && product_id='$orderproduct_id'";
    	$result_2_checker = mysqli_query($mysqli, $query_2_checker);
    	while($row_2_checker = mysqli_fetch_assoc($result_2_checker))
    	{
    		$row_auto_id_pax = $row_2_checker['auto_id'];
    		foreach($row_2_checker as $columnname_db => $db_value)
    		{
    			$dbcolumn_and_postname_checker = $row_auto_id_pax.'_'.$columnname_db;
    			foreach ($_POST as $post_fieldname => $post_fieldvalue) {
    				if($post_fieldname == $dbcolumn_and_postname_checker)
    				{
    					$sql_update_status = "UPDATE wpk4_backend_todo_tasks SET status='$post_fieldvalue',updated_by='$current_usernme',status_updated_on='$current_time_modified' WHERE order_id='$orderauto_id' && product_id='$orderproduct_id' && auto_id='$row_auto_id_pax'";
    					$result_status= mysqli_query($mysqli,$sql_update_status);
    					echo '<script>window.location.href="?option=comment&id='.$orderauto_id.'&product_i='.$orderproduct_id.'";</script>';
    				}
    			}
    		}
    	}
    	}
    	if(isset($_POST['btn_book_pax']))
    	{
    	$current_time_modified = date('Y-m-d H:i:s');
    	
    	global $current_user;
    	wp_get_current_user();
    	$current_usernme = $current_user->user_login;

    	$assigned_to_post = $_POST['assigned_to'];
    	$complete_before_post = $_POST['complete_before'];
    	$comment_post = $_POST['comment'];
    	
    	$orderauto_id = $_GET['id'];
    	$orderproduct_id = $_GET['product_i'];
    	
    	mysqli_query($mysqli,"insert into wpk4_backend_todo_tasks(order_id,product_id,comment_by,comment_date_time,comment,assigned_to,complete_before,status,updated_by,status_updated_on) values ('$orderauto_id','$orderproduct_id','$current_usernme','$current_time_modified','$comment_post','$assigned_to_post','$complete_before_post','open','','0000-00-00 00:00:00')") or die(mysqli_error($mysqli));
		
    	echo '<script>window.location.href="?option=comment&id='.$orderauto_id.'&product_i='.$orderproduct_id.'";</script>';
    	}
    }
    ?>
    <script>
    		function Checkchanged_0(changedornot) 
    		{
    		var i;
    			var x = document.getElementsByClassName("orig_vs_changed_0");
    			for (i = 0; i < x.length; i++) {
    				x[i].style.display = "none";
    				document.getElementById("btoriginal_0").classList.remove('active');
    				document.getElementById("btchanged_0").classList.remove('active');
    			}
    			document.getElementById(changedornot+"_0").style.display = "block";
    			document.getElementById('bt'+changedornot+'_0').classList.add('active');
    		
    	}
		function Checkchanged_1(changedornot) 
    		{
    			var i;
    			var x = document.getElementsByClassName("orig_vs_changed_1");
    			for (i = 0; i < x.length; i++) {
    				x[i].style.display = "none";
    				document.getElementById("btoriginal_1").classList.remove('active');
    				document.getElementById("btchanged_1").classList.remove('active');
    			}
    			document.getElementById(changedornot+"_1").style.display = "block";
    			document.getElementById('bt'+changedornot+'_1').classList.add('active');
    			
    		}
    </script>
    <?php
    }
    // start to do section admin view
    if(isset($_GET['option']) && $_GET['option']=='viewtodo')
    {
    ?>
			<script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js" type="text/javascript"></script>
			<script src="https://cdn.jsdelivr.net/gh/alumuko/vanilla-datetimerange-picker@latest/dist/vanilla-datetimerange-picker.js"></script>
			<script>
						window.addEventListener("load", function (event) {
						let drp = new DateRangePicker('req_date',
								{
									timePicker: false,
									alwaysShowCalendars: true,
									maxSpan: { "days": 7 },
									autoApply: false,
									autoUpdateInput: false,
									ranges: {
										'Today': [moment().startOf('day'), moment().endOf('day')],
										'Yesterday': [moment().subtract(1, 'days').startOf('day'), moment().subtract(1, 'days').endOf('day')],
										'Last 7 Days': [moment().subtract(6, 'days').startOf('day'), moment().endOf('day')],
									},
									locale: {
										format: "YYYY-MM-DD",
									}
									
								},
								function (start, end) {
									document.getElementById("req_date").value = start.format() + end.format();
								})
								
							});
			</script>
			<script type="text/javascript">
			function searchordejs() {
			  
				var order_id = document.getElementById("order_id").value;
				var category = document.getElementById("category").value;	
				var status = document.getElementById("status").value;
				var req_date = document.getElementById("req_date").value;
				window.location='?option=viewtodo&order_id=' + order_id + '&category=' + category + '&status=' + status + '&date=' + req_date + '&recentclose=';
			}
			</script>
			<h5>Manage Pax Info</h5>
			<table class="table" style="width:100%; margin:auto; border:1px solid #adadad;">
			<tr>
			<td width='14%'>Order ID *</br>
			<input type='text' name='order_id' value='<?php if(isset($_GET['order_id'])) { echo $_GET['order_id']; } ?>' id='order_id'></td>
			<td width='14%'>Date *
			<input type='text' name='req_date' value='<?php if(isset($_GET['date'])) { echo $_GET['date']; } ?>' id='req_date'></td>
			<td width='14%'>Category</br>
			<select name='category' id='category' style="width:100%; padding:10px;">
			<option value='' selected>Select</option>
			<option <?php if(isset($_GET['category']) && $_GET['category']=='general') { echo 'selected'; } ?> value='general'>General</option>
			<option <?php if(isset($_GET['category']) && $_GET['category']=='refund') { echo 'selected'; } ?> value='refund'>Refund</option>
			<option <?php if(isset($_GET['category']) && $_GET['category']=='date change') { echo 'selected'; } ?> value='date change'>Date Change</option>
			<option <?php if(isset($_GET['category']) && $_GET['category']=='information change') { echo 'selected'; } ?> value='information change'>Information Change</option>
			<option <?php if(isset($_GET['category']) && $_GET['category']=='payment followup') { echo 'selected'; } ?> value='payment followup'>Payment Followup</option>
			<option <?php if(isset($_GET['category']) && $_GET['category']=='cancellation') { echo 'selected'; } ?> value='cancellation'>Cancellation</option>
			<option <?php if(isset($_GET['category']) && $_GET['category']=='miscellaneous') { echo 'selected'; } ?> value='miscellaneous'>Miscellaneous</option>
			</select>
			</td>
			<td width='14%'>Status
			<select name='status' id='status' style="width:100%; padding:10px;">
			<option value='' selected>Select</option>
			<option value='open' <?php if(isset($_GET['status']) && $_GET['status']=='open') { echo 'selected'; } ?>>Open</option>
			<option value='closed' <?php if(isset($_GET['status']) && $_GET['status']=='closed') { echo 'selected'; } ?>>Closed</option>
			</select>
			</td>
			
			</tr>
			<tr>
			<td colspan='7' style='text-align:center;'>
			<button style='padding:10px; margin:0;font-size:11px; ' id='search_orders' onclick="searchordejs()">Search</button>
			</td>
			</tr>
			</table>
			<?php
			if($_GET['order_id'] != '')
				{
					$order_id = " order_id = '" . $_GET['order_id'] . "' && ";
				}
			else
				{
					$order_id = " order_id != '' && ";
				}
			if($_GET['category'] != '')
				{
					$category = " comment_type = '" . $_GET['category'] . "' && ";
				}
			else
				{
					$category = " comment_type != '' && ";
				}
			if($_GET['status'] != '')
				{
					$status = " status = '" . $_GET['status'] . "' && ";
				}
			else
				{
					$status = " status != '' && ";
				}
			if($_GET['date'] != '')
				{
					$depdate = substr($_GET['date'], 0, 10);
					$enddate = substr($_GET['date'], 25, 10);
				
					$min_date = $depdate." 00:00:00";
					$max_date = $enddate." 23:59:59";
					
					$date = " comment_date_time >= '" . $min_date . "' && " . "comment_date_time <= '" . $max_date . "'";
				}
			else
				{
					$date = " comment_date_time != ''";
				}
			$auto_numbering = 0;
			echo '</br>';
			if($_GET['category'] == '' && $_GET['date'] == '')
			{
				echo "</br><h5>Select atleast either Order ID or Task Date to filter.</h5>";
			}
			else
			{
					$query = "SELECT * FROM wpk4_backend_todo_tasks where ". $order_id . $category . $status  . $date;
					$selection_query = $query;
					$result = mysqli_query($mysqli, $query) or die(mysqli_error($mysqli));
					$row_counter_ticket = mysqli_num_rows($result);
					if($row_counter_ticket == 0 && $auto_numbering != 1)
					{
						echo "</br><h5>No results found for the search.</h5>";
					}
					
					$total_paxs = 0;
					?>
					</br>
					
					</br>
					<table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
						<thead>
						<tr>
						
						<th width='10%'>Case ID</th>
						<th width='15%'>Order ID</th>
						<th width='15%'>Task Type</th>
						<th width='20%'>Added on / by</th>
						<th width='10%'>Status</th>
						<th width='7%'>&nbsp;</th>
					  </tr>
					  </thead>
					  <tbody>
					<form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
					<?php
					while($row = mysqli_fetch_assoc($result))
					{
						$auto_id = $row['auto_id'];
							$order_id = $row['order_id'];
							$product_id = $row['product_id'];
							$comment_by = $row['comment_by'];
							$comment_date_time = $row['comment_date_time'];
							$comment_type = $row['comment_type'];
							$status_updated_on = $row['status_updated_on'];
							$status = $row['status'];
							
							?>
								</td>
								<td><?php echo $auto_id; ?></td>
								<td><?php echo $order_id; ?></td>
								<td><?php echo $comment_type; ?></td>
								<td><?php echo date('d-m-Y H:i:s', strtotime($row_orderi_d['comment_date_time'])); ?></br><?php echo $comment_by; ?>
								</td>
								<td><?php echo $status; ?></td>
								<td><a href='?option=todo&id=<?php echo $row['order_id']; ?>&product_i=<?php echo $product_id; ?>'>View</a></td>
							</tr>
					<?php
					}
					?>
					</tbody> 
					</table></br>
					
					</br></br>
					<a href='/'>Back to Manage Booking</a>
					<?php
			}
    }
    // end of to do admin view
    
    if(isset($_GET['option']) && $_GET['option']=='todo')
    {   
        if(isset($_GET['type'])){
            $task_type = str_replace(" ","_",$_GET['type']);
        } else {
            $task_type = '';
        }
            
        // function to add new tasks
        function generate_html_for_add_task_window($task_type) 
        {
            $task_type_option_value = "";
            // switch by type
            switch($task_type){
                case 'refund':
                    $task_type_option_value = 'Refund';
                    break;
                case 'payment_followup':
                    $task_type_option_value = 'Payment Followup';
                    break;
                case 'miscellaneous':
                    $task_type_option_value = 'Miscellaneous';
                    break;
                case 'information_change':
                    $task_type_option_value = 'Information Change';
                    break;
                case 'special_request':
                    $task_type_option_value = 'Special Request';
                    break;
                case 'cancellation':
                    $task_type_option_value = 'Cancellation';
                    break;
                case 'general':
                    $task_type_option_value = 'General';
                    break;
            }
        
            // default layout for all types except DC
            $html = "
            <div id='".$task_type."_add_task_window' style='display:none;'>
            <h6>Add Task</h6>
            <form action='#' name='contactsubmit' method='post' enctype='multipart/form-data'>
                <table class='table' style='width:90%; font-size:14px; margin:auto; border:1px solid black;'>
                    <tr>
						<td>Assigned to
    						<select name='assigned_to' style='width:100%; padding:10px;'>";
    						    
    							$args = array(
                                    'role__not_in' => 'customer', 'subscriber', 'wp-travel-customer', 'none'
                                );
                                
                                // The Query
                                $user_query = new WP_User_Query( $args );
                                
                                // User Loop
                                if ( ! empty( $user_query->results ) ) {
                                    foreach ( $user_query->results as $user ) {
                                        $html .= "<option value='".$user->user_login."'>".$user->user_login."</option>";
                                    }
                                }
    							
    						$html .= "		
    						
    						</select>
    					</td>
                        <td>
                        Task type
                            <select name='comment_type' style='width:100%; padding:10px;'>
                                <option value='".$task_type."'>".$task_type_option_value."</option>
                            </select>
                        </td>";
                           
                           $col_padding_for_chat_box = '5';
                           if($task_type_option_value == 'Miscellaneous')
                            {
                                $html .= "
                                    <td>
                                    Sub task type 
                                        <select name='sub_comment_type' style='width:100%; padding:10px;'>
                                                <option value='passport related'>passport related</option>
                                                <option value='schedule change related'>schedule change related</option>
                                                <option value='call back request'>call back request</option>
                                                <option value='changes related'>changes related</option>
                                        </select>
                                    </td>";
                                    $col_padding_for_chat_box = '6';
                            }
                           
                        $html .= "
                        <td>
                            Payment Received
                            <select name='payment_received' style='width:100%; padding:10px;'>
                                <option selected value='Yes'>Yes</option>
                                <option value='No'>No</option>
                            </select>
                        </td>
                        <td>
                            Ticket issued
                            <select name='ticket_issued' style='width:100%; padding:10px;'>
                                <option selected value='Yes'>Yes</option>
                                <option value='No'>No</option>
                            </select>
                        </td>
                        <td>
                            Status
                            <select name='status' style='width:100%; padding:10px;'>
                                <option selected value='open'>Open</option>
                                <option value='closed'>Closed</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                    
                        <td colspan='".$col_padding_for_chat_box."'>
                            Task
                            <textarea name='comment' rows='6'></textarea>
                        </td>
                    </tr>
                </table></br>
                <center><input type='submit' name='btn_book_pax' class='btn btn-success' value='Save Task'></center>
            </form>
        </div>
            ";
            return $html;
        }

        // function to add new reply by type
        function generate_html_for_reply_task_window($task_type)
        {

            $html = "
            <div id='".$task_type."_reply_task_window' style='display:none;'>
            <h6>Reply for the task</h6>
            <form action='#' name='contactsubmit' method='post' enctype='multipart/form-data'>
                <table class='table' style='width:90%; font-size:14px; margin:auto; border:1px solid black;'>
                    <tr>
                        <td colspan='3'>
                            Reply
                            <input type='hidden' readonly id='".$task_type."_task_id' name='task_id'
                                style='width:100%; padding:10px;'>
                            <input type='hidden' readonly id='comment_type' name='comment_type'
                                style='width:100%; padding:10px;'>
                            <textarea name='comment' rows='6'></textarea>
                        </td>
        
                    </tr>
        
                </table></br>
                <center><input type='submit' name='btn_reply' class='btn btn-success' value='Save Reply / Task'></center>
            </form>
        </div>
            ";
        
            return $html;
        }
        
        // function to view reply under each types
        function get_reply_for_this_todo_task($auto_id)
        {
            global $mysqli;
            $query_msg = "SELECT * FROM wpk4_backend_todo_task_chat where request_id='$auto_id' order by response_time ";
    			$result_msg = mysqli_query($mysqli, $query_msg);
    			$row_msgcount = mysqli_num_rows($result_msg);
    			$html = '';
    			while($row_msg = mysqli_fetch_assoc($result_msg))
    				{
                        $html .= '<div class="wpb_column vc_col-sm-1">&nbsp;</div>
                        <div class="wpb_column vc_col-sm-11" style="margin-left:10px; margin-bottom:3px;border:1px solid #e3e3e3;">
                            <div class="vc_column-inner">
                                <div class="wpb_wrapper">
                                    <div class="vc_row wpb_row vc_inner vc_row-fluid vc_row-o-equal-height vc_row-flex">
                                        <div class="wpb_single_image wpb_content_element">
                                            <span style="font-size:11px;">by '.$row_msg['response_by'] .' on
                                                '. $row_msg['response_time'] .'
                                            </span>
                                        </div>
                                    </div>
                                    <div style="border-top: 1px solid #cfcfcf; width:100%; height:8px;">
                                        &nbsp;
                                    </div>
                                    <div
                                        class="vc_row wpb_row vc_inner vc_row-fluid vc_column-gap-25 vc_row-o-equal-height vc_row-flex">
                                        <div class="wpb_single_image wpb_content_element">
                                            <p style="font-size:13px;">'. $row_msg['response'] .'</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>';
    				}
    			return $html;
        }
    ?>
        <style>
        .chatcategory {
            padding: 7px 10px;
            margin: 0;
            font-size: 13px;
        }

        .tab button.active {
            text-decoration: none;
            background-color: #FFBB00;
            color: #000;
        }

        .tab button.active:focus,
        .tab button.active:active,
        .tab button.active:hover {
            text-decoration: none;
        }

        .add-new-task {
            padding: 10px;
            margin: 0 44%;
            font-size: 10px;
            background-color: #3e8ef7
        }

        .reply-task {
            padding: 7px 14px;
            float: right;
            margin: 0;
            font-size: 10px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header button {
            padding: 10px;
            background-color: #FFBB00;
            color: #000;
            font-size: 12px;
        }

        .select-status {
            padding: 5px 10px;
            font-size: 12px;
        }

        .select-status-btn {
            padding: 5px 20px !important;
            font-size: 12px !important;
        }
        </style>
        <script type="text/javascript" defer>
        function openCity(evt, cityName) {

            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";

            }

            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById('comment_type').value = cityName.replace("_", " ");
            document.getElementById(cityName).style.display = "block";
            evt.currentTarget.className += " active";

        }

        const addNewTask = (task_type) => {

            let task_id = task_type + "_add_task_window";
            let reply_task_id = "#" + task_type + "_reply_task_window";
            let add_task_id = "#" + task_type + "_add_task_window";

            $(reply_task_id).css('display', 'none');
            hideAllNewTasks();
            $(add_task_id).css('display', 'block');

            document.getElementById(task_id).scrollIntoView();
        }

        const addReplyTask = (event, task_type) => {

            let task_id = task_type + "_task_id";
            let reply_task_id = "#" + task_type + "_reply_task_window";
            let add_task_id = "#" + task_type + "_add_task_window";

            $(reply_task_id).css('display', 'block');
            $(add_task_id).css('display', 'none');

            // set the id for comment
            document.getElementById(task_id).value = $(event.target).data('id');

            if (task_type === 'general') {
                reply_task_id = 'general_reply_task_window';
            }

            document.getElementById(reply_task_id).scrollIntoView();
        }

        function hideAllNewTasks() {
            $("#general_add_task_window").css('display', 'none');
            $("#refund_add_task_window").css('display', 'none');
            $("#payment_followup_add_task_window").css('display', 'none');
            $("#information_change_add_task_window").css('display', 'none');
            $("#cancellation_add_task_window").css('display', 'none');
            $("#miscellaneous_add_task_window").css('display', 'none');
        }

        $(document).ready(function() {
            var task_type = <?php echo json_encode($task_type); ?>;
            if (task_type != '' && task_type != null) {
                tabcontent = document.getElementsByClassName("tabcontent");
                for (i = 0; i < tabcontent.length; i++) {
                    tabcontent[i].style.display = "none";
                }
                document.getElementById(task_type).style.display = "block";
            }
        });
        </script>
        <h5>To Do</h5>
        <?php
    	    $orderauto_id = $_GET['id'];
    	    $orderproduct_id = $_GET['product_i'];
    	    $orderco_orderid = ($_GET['co_orderid'] ?? false) ? $_GET['co_orderid'] : '' ;
    	
    	    $query = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$orderauto_id'";
    	    $result = mysqli_query($mysqli, $query);
    	    $row = mysqli_fetch_assoc($result);
    	{
    	?>
        <h6>Order Information</h6>
        <table class="table" style="width:90%; margin:auto; border:1px solid black;">
            <tr>
                <td>Order ID</td>
                <td><?php echo $row['order_id']; ?></td>
            </tr>
            <tr>
                <td>Order Date</td>
                <td><?php echo $row['order_date']; ?></td>
            </tr>
        </table>
        </br>
        <h6>View Tasks</h6>
        <?php
			$selected_orderid = $row['order_id'];
			$selected_payment_status = $row['payment_status'];
		?>
        <div class="tab">
            <?php

                if(current_user_can( 'administrator' ) ||
                    current_user_can( 'ho_operations' ) || 
                    current_user_can( 'user_portal_datechange_editor_admin' ) || 
                    current_user_can( 'user_portal_datechange_editor' ) || 
                    current_user_can( 'user_portal_complaint_editor_admin' ) || 
                    current_user_can( 'user_portal_refund_editor_admin' ) || 
                    current_user_can( 'datechange_manager' )
                    ){
            ?>
            <!-- TODO task type buttons -->
            <button class="tablinks chatcategory active" onclick="openCity(event, 'all')">All</button>
            <button class="tablinks chatcategory" onclick="openCity(event, 'refund')">Refund</button>
            <button class="tablinks chatcategory" onclick="openCity(event, 'date_change')">Date Change</button>
            <button class="tablinks chatcategory" onclick="openCity(event, 'payment_followup')">Payment
                Followup</button>
                <?php
                
                if( current_user_can( 'administrator' ) || current_user_can( 'ho_payment' ) )
                {
                    ?>
                    <button class="tablinks chatcategory" onclick="openCity(event, 'payment_adjust')">Payment Adjustment</button>
                    <?php
                }
                ?>
            <?php
                }
            ?>
            <button class="tablinks chatcategory" onclick="openCity(event, 'miscellaneous')">Miscellaneous</button>
        </div>

        <!-- HTML elements to view all by categories -->
        <div id="all" class="tabcontent">
            <h6>All Tasks</h6>
            <?php

    		    $query_is_dc_submitted = "SELECT * FROM wpk4_backend_travel_datechange_request where order_id='$selected_orderid'";
    		    $result_is_dc_submitted = mysqli_query($mysqli, $query_is_dc_submitted) or die(mysqli_error($mysqli));
    		    $row_is_dc_submitted_count = mysqli_num_rows($result_is_dc_submitted);
    	
    		    if($row_is_dc_submitted_count>0){
    		?>
            <div>
                <h6>Datechange Tasks</h6>
            </div>
            <?php
                    while($row_dc_submitted = mysqli_fetch_assoc($result_is_dc_submitted)){
                    
                    if($row_dc_submitted['status'] == 'new'){
                        echo '<font style="font-size:12px;color:red;">Not Approved Yet</font>';
                    }
                    else if ($row_dc_submitted['status'] == 'updated'){
                        echo '<font style="font-size:12px;color:green;">Below request has been approved</font>';
                    }
                    else if ($row_dc_submitted['status'] == 'declined'){
                        echo '<font style="font-size:12px;color:red;">Request has been declined</font>';
                    }
                    else{
                        echo '<font style="font-size:12px;color:red;">Not Checked Yet</font>';
                    }
                ?>
            <table class="table" style="width:90%; font-size:14px; margin:auto; border:1px solid black;">
                <tr>
                    <td>Order ID</br>
                        <?php echo $row_dc_submitted['order_id']; ?>
                    </td>
                    <td>
                        Payment Received</br>
                        <?php echo $row_dc_submitted['payment_received']; ?>
                    </td>
                    <td>
                        Ticket Issued</br>
                        <?php echo $row_dc_submitted['ticket_issued']; ?>
                    </td>
                    <td>
                        DC Cost</br>
                        <?php echo $row_dc_submitted['dc_cost_taken']; ?>
                    </td>
                    <td>
                        Partial Change</br>
                        <?php echo $row_dc_submitted['partial_change']; ?>
                    </td>
                    <td>
                        Agent</br>
                        <?php echo $row_dc_submitted['agent']; ?>
                    </td>
                </tr>
                <tr>
                    <td>Original Travel Date</br>
                        <?php echo $row_dc_submitted['original_travel_date']; ?>
                        <input type='hidden' readonly name='auto_id'
                            value='<?php echo $row_dc_submitted['auto_id']; ?>'>
                        <input type='hidden' readonly name='original_travel_date'
                            value='<?php echo $row_dc_submitted['original_travel_date']; ?>'>
                    </td>
                    <td>
                        Original Pax Count</br>
                        <?php echo $row_dc_submitted['original_no_of_pax']; ?>
                    </td>
                    <td>
                        Original Tripcode</br>
                        <?php echo $row_dc_submitted['original_tripcode']; ?>
                        <input type='hidden' readonly name='original_tripcode'
                            value='<?php echo $row_dc_submitted['original_tripcode']; ?>'>
                    </td>
                    <td>
                        New Travel Date</br>
                        <?php echo $row_dc_submitted['new_travel_date']; ?>
                        <input type='hidden' readonly name='new_travel_date'
                            value='<?php echo $row_dc_submitted['new_travel_date']; ?>'>
                    </td>
                    <td>
                        New Pax Count</br>
                        <?php echo $row_dc_submitted['new_no_of_pax']; ?>
                        <input type='hidden' readonly name='new_no_of_pax'
                            value='<?php echo $row_dc_submitted['new_no_of_pax']; ?>'>
                    </td>
                    <td>
                        New Tripcode</br>
                        <?php echo $row_dc_submitted['new_tripcode']; ?>
                        <input type='hidden' readonly name='new_tripcode'
                            value='<?php echo $row_dc_submitted['new_tripcode']; ?>'>
                    </td>
                </tr>
                <tr>
                    <td colspan="6">Remark</br>
                        <?php echo $row_dc_submitted['remark']; ?>
                    </td>
                </tr>
            </table>
            </br></br>
            <?php
		            }
		        }
                $task_title_captured = '';
    	        $query_1 = "SELECT * FROM wpk4_backend_todo_tasks where order_id='$selected_orderid' && comment_type != 'date change' order by comment_type asc, comment_date_time desc";
    	        $result_1 = mysqli_query($mysqli, $query_1) or die(mysqli_error($mysqli));
    	        $row_2_count = mysqli_num_rows($result_1);
    	        $js_button_counter = 0;
    	        while($row_2 = mysqli_fetch_assoc($result_1)){

                    $auto_id_message = $row_2['auto_id'];
                    $comment_type = $row_2['comment_type'];
            ?>
            <h6>
                <?php 
                    if($task_title_captured != $comment_type){
                        echo $comment_type;
                        $task_title_captured = $comment_type;
                    } else {
                        $task_title_captured = $comment_type;
                    }
                ?>
            </h6>
            <table class="table" style="width:90%; font-size:14px; margin:auto; border:1px solid black;">
                <tr>
                    <td>by <?php echo $row_2['comment_by']; ?>
                        on <?php echo $row_2['comment_date_time']; ?>
                        &nbsp;
                        |&nbsp;&nbsp;<span
                            style='<?php if($row_2['status']=='open') { echo 'background-color:green;'; } else { echo 'background-color:red;'; } ?>padding:2px 5px; color:white;'><?php echo $row_2['status']; ?></span>&nbsp;&nbsp;<?php if($row_2['updated_by'] != '' && $row_2['status_updated_on'] != '0000-00-00 00:00:00' && $row_2['status'] != 'open') { echo ' by '.$row_2['updated_by'] .' on '. $row_2['status_updated_on']; } ?>
                        </font> </br>
                        Assigned to: <?php echo $row_2['assigned_to']; ?> </br>
                        Payment Received: <?php echo $row_2['payment_received']; ?>
                    </td>
                    <td>
                        <?php
                                if( current_user_can( 'administrator' ) || 
                                    current_user_can( 'user_portal_complaint_editor_admin' ) || 
                                    current_user_can( 'user_portal_datechange_editor_admin' ) || 
                                    current_user_can( 'user_portal_refund_editor_admin' ) || 
                                    current_user_can( 'payment_portal_user' ) || 
                                    current_user_can( 'ho_operations' ) || 
                                    current_user_can( 'ho_payment' )){
                            ?>
                        <button id='replythistodo_<?php echo $js_button_counter; ?>' class='reply-task'
                            data-id="<?php echo $row_2['auto_id']; ?>" onclick="addReplyTask(event, 'general')">Add
                            Reply to this</button>
                        <?php
                                }
                            ?>
                    </td>
                </tr>
            </table>
            <?php
                $auto_id = $row_2['auto_id']; 
                $query_msg = "SELECT * FROM wpk4_backend_todo_task_chat where request_id='$auto_id' order by response_time ";
                $result_msg = mysqli_query($mysqli, $query_msg);
                $row_msgcount = mysqli_num_rows($result_msg);
                while($row_msg = mysqli_fetch_assoc($result_msg)){
            ?>
            <div class="wpb_column vc_col-sm-1">
                &nbsp;
            </div>
            <table class="table" style="width:90%; font-size:14px; margin:auto; border:1px solid black;">
                <tr>
                    <td>by <?php echo $row_msg['response_by']; ?> on <?php echo $row_msg['response_time']; ?>
                    </td>
                    <td>
                        <p style='font-size:13px;'><?php echo $row_msg['response']; ?></p>
                    </td>
                </tr>
            </table>
            <?php
                }
            ?>
            <div class="wpb_column vc_col-sm-12">
                <div class="vc_column-inner">
                    <div class="wpb_wrapper">
                        <div class="vc_row wpb_row vc_inner vc_row-fluid vc_row-o-equal-height vc_row-flex">
                            <div class="wpb_single_image wpb_content_element">
                                &nbsp;
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <?php
                    $js_button_counter++;
    	        }
	
    		?>
        </div>
        <?php
		        $js_button_counter = 0;
		?>
        </br>

        <!-- GENERAL TASK START -->
        <div id="general" class="tabcontent" style="display:none;">
            <div>
                <h6>General Tasks</h6>
            </div>
            <?php
    		    $query_2 = "SELECT * FROM wpk4_backend_todo_tasks where order_id='$selected_orderid' && comment_type='general'";
    		    $result_2 = mysqli_query($mysqli, $query_2);
    		    $row_2_count = mysqli_num_rows($result_2);
    		    while($row_2 = mysqli_fetch_assoc($result_2)){

    			    $auto_id_message = $row_2['auto_id'];
    		?>
            <div class="wpb_column vc_col-sm-12"
                style='background-color:#fcfcfc; border:1px solid #e3e3e3; padding:10px 5px;'>
                <div class="vc_column-inner">
                    <div class="wpb_wrapper">
                        <div
                            class="vc_row wpb_row vc_inner vc_row-fluid vc_column-gap-25 vc_row-o-equal-height vc_row-flex">
                            <div class="wpb_column vc_col-sm-8">
                                <div class="vc_column-inner">
                                    <div class="wpb_wrapper">
                                        <div class="wpb_single_image wpb_content_element" style='font-size:13px;'>
                                            by <?php echo $row_2['comment_by']; ?>
                                            on <?php echo $row_2['comment_date_time']; ?>
                                            &nbsp;
                                            |&nbsp;&nbsp;<span
                                                style='<?php if($row_2['status']=='open') { echo 'background-color:green;'; } else { echo 'background-color:red;'; } ?>padding:2px 5px; color:white;'><?php echo $row_2['status']; ?></span>&nbsp;&nbsp;<?php if($row_2['updated_by'] != '' && $row_2['status_updated_on'] != '0000-00-00 00:00:00' && $row_2['status'] != 'open') { echo ' by '.$row_2['updated_by'] .' on '. $row_2['status_updated_on']; } ?>
                                            </font> </br>
                                            Assigned to: <?php echo $row_2['assigned_to']; ?> </br>
                                            Payment Received: <?php echo $row_2['payment_received']; ?>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="wpb_column vc_col-sm-2">
                                <div class="vc_column-inner">
                                    <div class="wpb_wrapper">
                                        <div class="wpb_single_image wpb_content_element">
                                            <?php
    											if( current_user_can( 'administrator' ) || current_user_can( 'ho_operations' ) )
    												{
    												?>
                                            <center>
                                                <form action="#" name="statusupdate" method="post"
                                                    enctype="multipart/form-data">
                                                    <select name='<?php echo $auto_id_message; ?>_status'
                                                        class="select-status">
                                                        <option selected disabled>Select</option>
                                                        <option value='closed'
                                                            <?php if($row_2['status']=='closed') { echo 'selected'; } ?>>
                                                            Close</option>
                                                        <option value='open'
                                                            <?php if($row_2['status']=='open') { echo 'selected'; } ?>>
                                                            Open</option>
                                                    </select>
                                                    <input type='submit' class="select-status-btn"
                                                        name='status_submitter' value='Save'>
                                                </form>
                                            </center>
                                            <?php
    												}
    											?>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="wpb_column vc_col-sm-2">
                                <div class="vc_column-inner">
                                    <div class="wpb_wrapper">
                                        <div class="wpb_single_image wpb_content_element">
                                            <?php
    											if( current_user_can( 'administrator' ) || current_user_can( 'user_portal_complaint_editor_admin' ) || current_user_can( 'user_portal_datechange_editor_admin' ) || current_user_can( 'user_portal_refund_editor_admin' ) || current_user_can( 'payment_portal_user' ) || current_user_can( 'ho_operations' ) || current_user_can( 'ho_payment' ))
    												{
    												?>
                                            <button id='replythistodo_<?php echo $js_button_counter; ?>'
                                                class='general_replyclick reply-task'
                                                name='replybtn_<?php echo $row_2['auto_id']; ?>'>Add
                                                Reply for this</button>
                                            <?php
    												}
    											?>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="border-top: 1px solid #cfcfcf;">&nbsp;</div>
                <div class="vc_column-inner">
                    <div class="wpb_wrapper">
                        <div
                            class="vc_row wpb_row vc_inner vc_row-fluid vc_column-gap-25 vc_row-o-equal-height vc_row-flex">
                            <div class="wpb_column vc_col-sm-12">
                                <div class="vc_column-inner">
                                    <div class="wpb_wrapper">
                                        <div class="wpb_single_image wpb_content_element" style='font-size:13px;'>
                                            <?php echo $row_2['comment']; ?>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <?php
    			$auto_id = $row_2['auto_id'];
    			echo get_reply_for_this_todo_task($auto_id);
    				?>
            <div class="wpb_column vc_col-sm-12">
                <div class="vc_column-inner">
                    <div class="wpb_wrapper">
                        <div class="vc_row wpb_row vc_inner vc_row-fluid vc_row-o-equal-height vc_row-flex">
                            <div class="wpb_single_image wpb_content_element">
                                &nbsp;
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <?php
    		$js_button_counter++;
    		}
    		if($row_2_count==0)
    		{
    			echo '<div class="wpb_column vc_col-sm-12">
    				<div class="vc_column-inner">
    					<div class="wpb_wrapper">
    						<div class="vc_row wpb_row vc_inner vc_row-fluid vc_row-o-equal-height vc_row-flex">
    							<div class="wpb_single_image wpb_content_element">
    								No Task Found..
    							</div>
    						</div>
    					</div>
    				</div>
    			</div>';
    		}
    		//if()
    			{
    			?>
            <center>
                <button id='general_addnewtodo' class="add-new-task" onclick="addNewTask('general')">Add New
                    Task</button>
            </center>
            <?php
    			}
    		?>

            <?php echo generate_html_for_add_task_window('general');?>
            <?php echo generate_html_for_reply_task_window('general');?>

        </div>
        <!-- GENERAL TASK END -->
        <!-- REFUND TASK START -->
        <div id="refund" class="tabcontent" style="display:none;">
            <div class="section-header">
                <span>
                    <h6>Refund Tasks</h6>
                </span>
                <button id='refund_addnewtodo' onclick="addNewTask('refund')">Add New Task</button>
            </div>

            <?php
                $fetch_task_query = "SELECT * 
                                    FROM wpk4_backend_todo_tasks 
                                    WHERE order_id='$selected_orderid' AND comment_type='refund'";

                $fetch_task_result = mysqli_query($mysqli, $fetch_task_query);
                $fetch_task_rows = mysqli_num_rows($fetch_task_result);
                while($fetch_task_row = mysqli_fetch_assoc($fetch_task_result)){
                    $auto_id_message = $fetch_task_row['auto_id'];
            ?>

            <div class="wpb_column vc_col-sm-12"
                style='background-color:#fcfcfc; border:1px solid #e3e3e3; padding:10px 5px;'>
                <div class="vc_column-inner">
                    <div class="wpb_wrapper">
                        <div
                            class="vc_row wpb_row vc_inner vc_row-fluid vc_column-gap-25 vc_row-o-equal-height vc_row-flex">
                            <div class="wpb_column vc_col-sm-8">
                                <div class="vc_column-inner">
                                    <div class="wpb_wrapper">
                                        <div class="wpb_single_image wpb_content_element" style='font-size:13px;'>
                                            by
                                            <?php echo $fetch_task_row['comment_by']; ?>
                                            on
                                            <?php echo $fetch_task_row['comment_date_time']; ?> &nbsp;|&nbsp;&nbsp;
                                            <span style='<?php if($fetch_task_row['status']=='open' ) {
                                                        echo 'background-color:green;' ; } else { echo 'background-color:red;' ; }
                                                        ?>padding:2px 5px; color:white;'>
                                                <?php echo $fetch_task_row['status']; ?>
                                            </span>
                                            &nbsp;&nbsp;
                                            <?php 
                                                        if($fetch_task_row['updated_by'] != '' &&
                                                            $fetch_task_row['status_updated_on'] != '0000-00-00 00:00:00' && 
                                                            $fetch_task_row['status'] != 'open') { 
                                                                echo ' by '.$fetch_task_row['updated_by'] .' on '. $fetch_task_row['status_updated_on']; 
                                                        } 
                                                    ?>
                                            </br>
                                            Assigned to: <?php echo $row_2['assigned_to']; ?> </br>
                                            Payment Received: <?php echo $fetch_task_row['payment_received']; ?>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="wpb_column vc_col-sm-2">
                                <div class="vc_column-inner">
                                    <div class="wpb_wrapper">
                                        <div class="wpb_single_image wpb_content_element">
                                            <?php
                                                        if( current_user_can( 'administrator' ) || current_user_can( 'ho_operations' ) ){
                                                    ?>
                                            <center>
                                                <form action="#" name="statusupdate" method="post"
                                                    enctype="multipart/form-data">
                                                    <select name='<?php echo $auto_id_message; ?>_status'
                                                        class="select-status">
                                                        <option selected disabled>Select</option>
                                                        <option value='closed' <?php if($fetch_task_row['status']=='closed' ) {
                                                                    echo 'selected' ; } ?>>
                                                            Close</option>
                                                        <option value='open' <?php if($fetch_task_row['status']=='open' ) {
                                                                    echo 'selected' ; } ?>>
                                                            Open</option>
                                                    </select>
                                                    <input type='submit' class="select-status-btn"
                                                        name='status_submitter' value='Save'>
                                                </form>
                                            </center>
                                            <?php
                                                            }
                                                        ?>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="wpb_column vc_col-sm-2">
                                <div class="vc_column-inner">
                                    <div class="wpb_wrapper">
                                        <div class="wpb_single_image wpb_content_element">
                                            <?php
                                                        if( current_user_can( 'administrator' ) || 
                                                            current_user_can( 'user_portal_complaint_editor_admin' ) || 
                                                            current_user_can( 'user_portal_datechange_editor_admin' ) || 
                                                            current_user_can( 'user_portal_refund_editor_admin' ) || 
                                                            current_user_can( 'payment_portal_user' ) || 
                                                            current_user_can( 'ho_operations' ) || 
                                                            current_user_can( 'ho_payment' )){
                                                    ?>
                                            <button id='replythistodo_<?php echo $js_button_counter; ?>'
                                                class='reply-task' data-id="<?php echo $fetch_task_row['auto_id']; ?>"
                                                onclick="addReplyTask(event, 'refund')">Add Reply to this</button>
                                            <?php
                                                        }
                                                    ?>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="border-top: 1px solid #cfcfcf;">&nbsp;</div>
                <div class="vc_column-inner">
                    <div class="wpb_wrapper">
                        <div
                            class="vc_row wpb_row vc_inner vc_row-fluid vc_column-gap-25 vc_row-o-equal-height vc_row-flex">
                            <div class="wpb_column vc_col-sm-12">
                                <div class="vc_column-inner">
                                    <div class="wpb_wrapper">
                                        <div class="wpb_single_image wpb_content_element" style='font-size:13px;'>
                                            <?php echo $fetch_task_row['comment']; ?>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <?php
                $auto_id = $row_2['auto_id'];
    			echo get_reply_for_this_todo_task($auto_id);
                    ?>
            <div class="wpb_column vc_col-sm-12">
                <div class="vc_column-inner">
                    <div class="wpb_wrapper">
                        <div class="vc_row wpb_row vc_inner vc_row-fluid vc_row-o-equal-height vc_row-flex">
                            <div class="wpb_single_image wpb_content_element">
                                &nbsp;
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <?php
                    $js_button_counter++;
                }
                if($fetch_task_rows==0){

                echo '<div class="wpb_column vc_col-sm-12">
                    <div class="vc_column-inner">
                        <div class="wpb_wrapper">
                            <div class="vc_row wpb_row vc_inner vc_row-fluid vc_row-o-equal-height vc_row-flex">
                                <div class="wpb_single_image wpb_content_element">
                                    No Task Found..
                                </div>
                            </div>
                        </div>
                    </div>
                </div>';
                }	
            echo generate_html_for_add_task_window('refund');
			echo generate_html_for_reply_task_window('refund');?>
        </div>
        <!-- REFUND TASK END -->
        <!-- DC TASK START -->
        <div id="date_change" class="tabcontent" style="display:none;" >
    		<div>
    		<h6>Datechange Tasks</h6>
    		</div>
    		<?php
    		$query_is_dc_submitted = "SELECT * FROM wpk4_backend_travel_datechange_request where order_id='$selected_orderid'";
    		$result_is_dc_submitted = mysqli_query($mysqli, $query_is_dc_submitted) or die(mysqli_error($mysqli));
    		$row_is_dc_submitted_count = mysqli_num_rows($result_is_dc_submitted);
    	
    		if($row_is_dc_submitted_count>0)
    		{
    			while($row_dc_submitted = mysqli_fetch_assoc($result_is_dc_submitted))
    			{
    			
    			if($row_dc_submitted['status'] == 'new')
    			{
    				echo '<font style="font-size:12px;color:red;">Not Approved Yet</font>';
    			}
    			else if ($row_dc_submitted['status'] == 'updated')
    			{
    				echo '<font style="font-size:12px;color:green;">Below request has been approved</font>';
    			}
    			else if ($row_dc_submitted['status'] == 'declined')
    			{
    				echo '<font style="font-size:12px;color:red;">Request has been declined</font>';
    			}
    			else
    			{
    				echo '<font style="font-size:12px;color:red;">Not Checked Yet</font>';
    			}
    			?>
				<form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
				<table class="table" style="width:90%; font-size:14px; margin:auto; border:1px solid black;">	
    				<tr>
    					<td>Order ID</br>
    												<?php echo $row_dc_submitted['order_id']; ?>
    					</td>
    					<td>
							Payment Received</br>
    												<select name='payment_recived' id='payment_recived' style="width:100%; padding:10px; border-color: #dcd7ca;">
    												<option selected disabled value=''>Select</option>
    												<option <?php if($row_dc_submitted['payment_received'] == 'yes') 
    												{ echo 'selected'; } ?> value='yes'>yes</option>
    												<option <?php if($row_dc_submitted['payment_received'] == 'no') 
    												{ echo 'selected'; } ?> value='no'>no</option>
    												</select>
    					</td>
    					<td>
							Ticket Issued</br>
    												<?php echo $row_dc_submitted['ticket_issued']; ?>
    					</td>
						<td>
							DC Cost</br>
    												<?php echo $row_dc_submitted['dc_cost_taken']; ?>
    					</td>
						<td>
							Partial Change</br>
    												<?php echo $row_dc_submitted['partial_change']; ?>
    					</td>
						<td>
							Agent</br>
    												<?php echo $row_dc_submitted['agent']; ?>
    					</td>
    				</tr>
					
					<tr>
    					<td colspan='2'>Original Travel Date</br>
    												<?php echo $row_dc_submitted['original_travel_date']; ?>
    												<input type='hidden' readonly name='auto_id' value='<?php echo $row_dc_submitted['auto_id']; ?>'>
    												<input type='hidden' readonly name='original_travel_date' value='<?php echo $row_dc_submitted['original_travel_date']; ?>'>
    					</td>
    					<td colspan='2'>
							Original Pax Count</br>
    												<?php echo $row_dc_submitted['original_no_of_pax']; ?>
    							<input type='hidden' readonly name='original_no_of_pax' value='<?php echo $row_dc_submitted['original_no_of_pax']; ?>'>
    					</td>
						<td colspan='2'>
							Original Tripcode</br>
    												<?php echo $row_dc_submitted['original_tripcode']; ?>
    												<input type='hidden' readonly name='original_tripcode' value='<?php echo $row_dc_submitted['original_tripcode']; ?>'>
    					</td>
						
    				</tr>
					<tr>
						<td colspan='2'>
							New Travel Date</br>
    												<?php echo $row_dc_submitted['new_travel_date']; ?>
    												<input type='hidden' readonly name='new_travel_date' value='<?php echo $row_dc_submitted['new_travel_date']; ?>'>
    					</td>
						<td colspan='2'>
							New Pax Count</br>
    												<?php echo $row_dc_submitted['new_no_of_pax']; ?>
    												<input type='hidden' readonly name='new_no_of_pax' value='<?php echo $row_dc_submitted['new_no_of_pax']; ?>'>
    					</td>
						<td colspan='2'>
							New Tripcode</br>
    												<?php echo $row_dc_submitted['new_tripcode']; ?>
    												<input type='hidden' readonly name='new_tripcode' value='<?php echo $row_dc_submitted['new_tripcode']; ?>'>
													
							<?php
							$new_tripcode = $row_dc_submitted['new_tripcode'];
    												$new_traveldate = $row_dc_submitted['new_travel_date'];
    												
    												$query_select_comment = "SELECT * FROM wpk4_backend_stock_product_manager WHERE trip_code='$new_tripcode' && travel_date = '$new_traveldate'";
                                        			$result_select_comment = mysqli_query($mysqli, $query_select_comment) or die(mysqli_error($mysqli));
                                        			$row_select_comment = mysqli_fetch_assoc($result_select_comment);
    												
    												echo $row_select_comment['product_id']; 
    												?>
                                                    <input type='hidden' readonly name='new_productid_received' value='<?php echo $row_select_comment['product_id']; ?>'>
    					</td>
						
					</tr>
					<tr>
						<td colspan='6'>
							Remark</br>
    												<?php echo $row_dc_submitted['remark']; ?>
    					</td>
						
						
					</tr>
					<tr>
						<td colspan='6'>
    												<?php
    												if((current_user_can( 'administrator') || current_user_can( 'ho_operations' ) || current_user_can( 'datechange_manager' )) && $row_dc_submitted['status']=='new')
    												{
        												if($row_dc_submitted['partial_change'] != 'yes')
        												{
        												?>
            												<center>
                												<?php
                												if( current_user_can( 'administrator' ) || current_user_can( 'ho_operations' ) || current_user_can( 'datechange_manager' ))
                												{
                												    ?>
                												    <input type='submit' style='padding:10px; margin:0;font-size:12px; ' name='payment_status_change' value='Update Payment Status'>
                													<?php
                												}
                												?>
            													<input type='submit' style='padding:10px; margin:0;font-size:12px; ' name='datechange_accept' value='Accept Changes'>
            													<input type='submit' style='padding:10px; margin:0;font-size:12px; ' name='datechange_decline' value='Decline Changes'>
        													</center>
    													<?php
        												}
        												else
        												{
        												?>
        													<center>
        												    <?php
        												    if( current_user_can( 'administrator' ) || current_user_can( 'ho_operations' ) || current_user_can( 'datechange_manager' ) )
        												    {
        												    ?>
        													    <input type='submit' style='padding:10px; margin:0;font-size:12px; ' name='payment_status_change' value='Update Payment Status'>
        													<?php
            												}
            												?>
        												        <input type='submit' style='padding:10px; margin:0;font-size:12px; ' name='partial_datechange_accept' value='Partial DC Accept Changes'>
            													<input type='submit' style='padding:10px; margin:0;font-size:12px;' name='datechange_decline' value='Decline Changes'>
            													</br>
            												</center>
        												<?php	
        												}
    												}
    												?>
    					</td>
					</tr>
				</table>
				</form>
				<?php
				if($row_dc_submitted['portal_case_id'] != '')
				{
				?>
    			<form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                      <table class="table table-striped" style="width:70%; margin:auto;font-size:13px;">
                                            <tr>
                                				<td>Order ID</td>
                                				<td>
                                				    <input type="text" readonly name="order_id_for_azupay" required value="<?php echo $selected_orderid; ?>">
                                				    <input type="hidden" name="emailid_for_azupay" value="sriharshans@gauratravel.com.au">
                                                </td>
                                			</tr>
                                            <tr>
                                                <td>Case ID</td>
                                                <td>
                                                    <?php
                                                    $received_pnrs_for_azupay = '';
                                                    $received_pnr_for_azupay_receipt = '';
                                                        $query_pnr_case = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$selected_orderid'";
                                        				$result_pnr_case = mysqli_query($mysqli, $query_pnr_case);
                                        				while($row_pnr_case = mysqli_fetch_assoc($result_pnr_case))
                                        				{
                                							$received_pnrs_for_azupay .= "'".$row_pnr_case['pnr'] . "',";
                                							$received_pnr_for_azupay_receipt = $row_pnr_case['pnr']; // get one PNR for azupay customer viewing
                                        				}
                                                        $received_pnrs_for_azupay = substr($received_pnrs_for_azupay, 0, -1);
                                                    
                                                    $final_amount_for_dc_azupay = 0;
                                                    $query_select_case = "SELECT * FROM wpk4_backend_user_portal_requests where reservation_ref = '$selected_orderid' OR reservation_ref IN ($received_pnrs_for_azupay)";
                                        			$result_select_case = mysqli_query($mysqli, $query_select_case);
                                        			$row_select_case_count = mysqli_num_rows($result_select_case);
                                        			if($row_select_case_count > 0)  // if no case if found, then get the case id from staff manually
                                        			{
                                                        ?>
                                                        <select name="case_id_for_azupay" required style="width:100%; padding:10px;">
                                                            <?php 
                                                            
                                            				while($row_select_case = mysqli_fetch_assoc($result_select_case))
                                            				{
                                            				    ?>
                                            				    <option value="<?php echo $row_select_case['case_id']; ?>"><?php echo $row_select_case['case_id']; ?></option>
                                            				    <?php
                                            				    $case_id_for_amount = $row_select_case['case_id'];
                                            				    $query_select_case_from_dc = "SELECT * FROM wpk4_backend_travel_datechange_request where portal_case_id = '$case_id_for_amount'";
                                                        		$result_select_case_from_dc = mysqli_query($mysqli, $query_select_case_from_dc);
                                                        		if(mysqli_num_rows($result_select_case_from_dc) > 0)  // if no case if found
                                                        		{
                                                        		    $row_select_case_from_dc = mysqli_fetch_assoc($result_select_case_from_dc);
                                                        		    $final_amount_for_dc_azupay = str_replace("$","",$row_select_case_from_dc['dc_cost_taken']);
                                                        		}
                                            				}
                                                            ?>
                                                        </select>
                                                        <?php 
                                        			}
                                        			else
                                        			{
                                        			    ?>
                                        			    <input type="text" name="case_id_for_azupay" required>
                                                        <?php 
                                        			}
                                        			?>
                                        			<input type="hidden" name="pnr_for_azupay" value="<?php echo $received_pnr_for_azupay_receipt; ?>">
                                                </td>
                                            </tr>
                                			<tr>
                                				<td>Amount</td>
                                				
                                				<td><input type="text" name="amount_for_azupay" value="<?php echo $final_amount_for_dc_azupay; ?>" required></td>
                                			</tr>
                                			<tr>
                                			    <td colspan='2'><center><input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='make_azupay_payment_request_todo' value='Request Payment'></center></td>
                                			</tr>
                                		</table>
                                		</form>
                                		<?php
    			}
                if(isset($_POST['make_azupay_payment_request_todo']))
                    {
                                        $order_id_for_azupay = $_POST['order_id_for_azupay'];
                                        $emailid_for_azupay = $_POST['emailid_for_azupay'];
                                        $case_id_for_azupay = $_POST['case_id_for_azupay'];
                                        $amount_for_azupay = $_POST['amount_for_azupay'];
                                        $pnr_for_azupay = $_POST['pnr_for_azupay'];
                                    
                                        $query_trav_type_case = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_for_azupay'";
                                        $result_trav_type_case = mysqli_query($mysqli, $query_trav_type_case);
                                        $row_trav_type_case = mysqli_fetch_assoc($result_trav_type_case);
                                        
                                        $travel_type_for_azupay = $row_trav_type_case['order_type'];
                                        
                                        if($travel_type_for_azupay == 'WPT') {
                                            $customer_azupay_ref_title = $order_id_for_azupay;
                                        }
                                        else {
                                            $customer_azupay_ref_title = $pnr_for_azupay;
                                        }
                                        
                                        $current_date_time = date("Y-m-d H:i:s");
                                        
                                		$client = new \GuzzleHttp\Client();
                                		$authorization_code = 'SECR7566D1_c4cc3709d612d1e0e677833ffbcef703_9Kz3JvUrYqPECSwl';
                                		$access_url = 'https://api.azupay.com.au/v1';
                                	
                                		$payID = "payments@gauratravel.com.au";
                                        $payIDSuffix = "gauratravel.com.au";
                                        $clientId = "c4cc3709d612d1e0e677833ffbcef703";
                                        $clientTransactionId = "".$order_id_for_azupay."_DC".$case_id_for_azupay.'_'.date("ms"); //adding date{ms} to get minute and second to ensure the key for multiple dc payment for one order
                                        $paymentAmount = $amount_for_azupay;
                                        $paymentDescription = "Date change charge for #".$customer_azupay_ref_title;
                                        
                                        $next_3_days = date("Y-m-d", strtotime("+3 days"));
                                        $current_time = date("H:i:s");
                                        $next_3_days2 = $next_3_days."T".$current_time."Z";
                                        
                                        
                                        $full_payment_auth_code = generateRandomSecurityCode();
                                
                                
                                        $sql_authcode_store ="UPDATE wpk4_backend_travel_bookings
                                            SET full_payment_auth_code = '$full_payment_auth_code'
                                        WHERE order_id='$order_id_for_azupay'";
                                        $results_authcode_store = $wpdb->query($sql_authcode_store);
                                        
                                        try 
                                        {
                                            $azupay_response = $client->request('POST', $access_url.'/paymentRequest', [
                                                'body' => '{"PaymentRequest":{"paymentNotification":{"paymentNotificationEndpointUrl":"https://gauratravel.com.au/azupay-post-receiver-autodc/","paymentNotificationAuthorizationHeaderValue":"'.$full_payment_auth_code.'"},"variant":"1Click", "clientId":"'.$clientId.'","clientTransactionId":"'.$clientTransactionId.'","paymentExpiryDatetime":"'.$next_3_days2.'","paymentAmount":'.$paymentAmount.',"paymentDescription":"'.$paymentDescription.'"}}',
                                                'headers' => [
                                                'Authorization' => $authorization_code,
                                                'accept' => 'application/json',
                                                'content-type' => 'application/json',
                                                ],
                                            ]);
                                                                                		
                                            $azupay_data = json_decode($azupay_response->getBody(), true);
                                            
                                            $paymentRequestId = $azupay_data['PaymentRequestStatus']['paymentRequestId'];
                                            $paymentRequeststatus = $azupay_data['PaymentRequestStatus']['status'];
                                            $paymentRequestcreatedDateTime = $azupay_data['PaymentRequestStatus']['createdDateTime'];
                                            $paymentRequestcheckoutUrl = $azupay_data['PaymentRequest']['checkoutUrl'];
                                            $paymentRequestExpiryDatetime = date("d/m/Y H:i:s", strtotime( $azupay_data['PaymentRequest']['paymentExpiryDatetime']));
                                            $paymentRequestExpiryDatetime_ymd = date("Y-m-d H:i:s", strtotime( $azupay_data['PaymentRequest']['paymentExpiryDatetime']));
                                            $paymentRequestpayID = $azupay_data['PaymentRequest']['payID'];
                                            $paymentRequestpaymentDescription = $azupay_data['PaymentRequest']['paymentDescription'];
                                            $paymentRequestAmount = $azupay_data['PaymentRequest']['paymentAmount'];
                                            $paymentRequestvirtualBsb = $azupay_data['PaymentRequestStatus']['virtualBsb'];
                                            $paymentRequestvirtualAccountNumber = $azupay_data['PaymentRequestStatus']['virtualAccountNumber'];
                                            
                                    		
                                        }
                                        catch (\GuzzleHttp\Exception\ClientException $e) 
                                        {
                                            echo 'Error on generating the payment link. Kindly try again.';
                                        } catch (\GuzzleHttp\Exception\ServerException $e) {
                                            echo 'Error on generating the payment link. Kindly try again.';
                                        } catch (\GuzzleHttp\Exception\GuzzleException $e) {
                                            echo 'Error on generating the payment link. Kindly try again.';
                                        } catch (Exception $e) {
                                            echo 'Error on generating the payment link. Kindly try again.';
                                        }
                                            
    							        if(isset($paymentRequestId) && $paymentRequestId != '')
    							        {
    							            $azupayBank = true;
    							            $virtualBsb = $paymentRequestvirtualBsb;
    							            $virtualAccountNumber = $paymentRequestvirtualAccountNumber;
        							        include(get_template_directory().'/templates/email/tpl_email_azupay_dc_charge_request.php');
        							            
                                            add_g360_event_history($order_id_api, $co_order_id_api, $product_id_api, 'DC Payment link generated in ToDo', "", $currnt_userlogn, $current_date_time);
    							        
    							            mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_custom_payments (order_id, case_id, type_of_payment, requested_on, requested_by, amount, status, payment_client_id, auth_code, payment_request_id, azupay_bsb, azupay_account_number, azupay_payid  ) 
							                values ('$order_id_for_azupay','$case_id_for_azupay','Date change' ,'$current_date_time' ,'$currnt_userlogn' ,'$amount_for_azupay', 'waiting', '$clientTransactionId', '$full_payment_auth_code' , '$paymentRequestId', '$paymentRequestvirtualBsb', '$paymentRequestvirtualAccountNumber', '$paymentRequestpayID' )") or die(mysqli_error($mysqli));
											
											mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_invoice 
													(order_id, invoice_by, status, invoice_amount, 
													invoice_date, travel_type, invoice_status ) 
        							                values 
													('$order_id_for_azupay','$currnt_userlogn','Proforma Invoice' ,'$amount_for_azupay', '$current_date_time', 'Date change', 'Open' )") or die(mysqli_error($mysqli));
    							        }
    							        
							            $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                    	echo '<script>window.location.href="'.$current_url.'";</script>';
                                    }
                                	?>
    			</br></br>
    			<?php
    			}
    			// SUBMIT BUTTON FOR PARTIAL DC APPROVE
    			if(isset($_POST['partial_datechange_accept']))
    			{
        			$orderauto_id = $_GET['id'];

        			$current_time_modified = date('Y-m-d H:i:s');
        			
        			global $current_user;
        			wp_get_current_user();
        			$current_usernme = $current_user->user_login;
        			$auto_id = $_POST['auto_id'];
        			$original_tripcode = $_POST['original_tripcode'];
        			$original_travel_date = $_POST['original_travel_date'];
        			$new_tripcode = $_POST['new_tripcode'];
        			$payment_recived = $_POST['payment_recived'];
        			$new_travel_date = $_POST['new_travel_date'];
        			$new_productid_received = $_POST['new_productid_received'];
        			
        			$query_select_comment = "SELECT * FROM wpk4_backend_travel_datechange_request WHERE auto_id='$auto_id'";
        			$result_select_comment = mysqli_query($mysqli, $query_select_comment) or die(mysqli_error($mysqli));
        			$row_select_comment = mysqli_fetch_assoc($result_select_comment);
        			$initiated_on = $row_select_comment['initial_request_date'];
    
    				$sql_update_dc_request = "UPDATE wpk4_backend_travel_datechange_request SET status='updated',payment_received='$payment_recived',ho_handled_by='$current_usernme',ho_handled_on='$current_time_modified' WHERE auto_id='$auto_id'";
    					$result_dc_request = mysqli_query($mysqli,$sql_update_dc_request);
    				
    				$sql_update_dc_comments = "UPDATE wpk4_backend_todo_tasks SET status='closed',payment_received='$payment_recived', updated_by='$current_usernme',status_updated_on='$current_time_modified' WHERE order_id='$orderauto_id' && status_updated_on = '$initiated_on'";
    					$result_dc_comments = mysqli_query($mysqli,$sql_update_dc_comments);
    													
    				echo '<script>alert("Task modified.");</script>';
    				echo '<script>window.location.href="https://gauratravel.com.au/manage-emails/?pg=generate_emails&id='.$orderauto_id.'";</script>';

    			}
    			// APPROVE DC WITH FULL CHANGE
    			if(isset($_POST['datechange_accept']))
    			{
    			    $orderauto_id = $_GET['id'];
                    //$orderproduct_id = $_GET['product_i'];
                    
                    $current_time_modified = date('Y-m-d H:i:s');
                    
                    global $current_user;
                    wp_get_current_user();
                    $current_usernme = $current_user->user_login;
                    $auto_id = $_POST['auto_id'];
                    $original_tripcode = $_POST['original_tripcode'];
                    $original_travel_date = $_POST['original_travel_date'];
                    $new_tripcode = $_POST['new_tripcode'];
                    $payment_recived = $_POST['payment_recived'];
                    $new_travel_date = $_POST['new_travel_date'];
                    $new_productid_received = $_POST['new_productid_received'];
                    
                    $query_select_comment = "SELECT * FROM wpk4_backend_travel_datechange_request WHERE auto_id='$auto_id'";
                    $result_select_comment = mysqli_query($mysqli, $query_select_comment) or die(mysqli_error($mysqli));
                    $row_select_comment = mysqli_fetch_assoc($result_select_comment);
                    $initiated_on = $row_select_comment['initial_request_date'];
                    $ticket_issued = $row_select_comment['ticket_issued'];
                    
                    $original_product_id = '';
                    $original_ticket_number = '';
                    $merging_id = '';
                    
                    $old_product_id = '';
                    $query_select_booking = "SELECT product_id FROM wpk4_backend_travel_bookings WHERE trip_code ='$new_tripcode' AND date(travel_date) ='$new_travel_date' and order_id = '$orderauto_id'";
                    $result_select_booking = mysqli_query($mysqli, $query_select_booking) or die(mysqli_error($mysqli));
                    $row_select_booking = mysqli_fetch_assoc($result_select_booking);
                    $old_product_id = $row_select_booking['product_id'];
                    
                    $new_pnr = '';
                    $query_select_pnr = "SELECT pnr FROM wpk4_backend_stock_management_sheet WHERE trip_id ='$new_tripcode' AND date(dep_date) ='$new_travel_date' ";
                    $result_select_pnr = mysqli_query($mysqli, $query_select_pnr) or die(mysqli_error($mysqli));
                    $row_select_pnr = mysqli_fetch_assoc($result_select_pnr);
                    $new_pnr = $row_select_pnr['pnr'];
                    
                    $sql_update_ticket_number = "UPDATE wpk4_backend_travel_booking_pax tbp
                                        SET tbp.PNR='$new_pnr', tbp.pax_status='New', tbp.name_updated= 'New', tbp.ticketed_on=NULL, tbp.ticketed_by=NULL, tbp.ticket_number= ''
                                        WHERE tbp.order_id='$orderauto_id' and tbp.product_id = '$old_product_id';";
                    $result_update_ticket_number = mysqli_query($mysqli, $sql_update_ticket_number);
                    
                    $sql_update_dc_request = "UPDATE wpk4_backend_travel_datechange_request SET
                        status='updated',payment_received='$payment_recived',ho_handled_by='$current_usernme',ho_handled_on='$current_time_modified'
                        WHERE auto_id='$auto_id'";
                    $result_dc_request = mysqli_query($mysqli, $sql_update_dc_request);
                    
                    $sql_update_dc_comments = "UPDATE wpk4_backend_todo_tasks SET status='closed',payment_received='$payment_recived' WHERE
                        order_id='$orderauto_id' && status_updated_on = '$initiated_on'";
                    $result_dc_comments = mysqli_query($mysqli, $sql_update_dc_comments);
                    
                    echo "<script>alert('Task is modified!')</script>";
                    echo '<script>window.location.href = "?option=todo&id='.$orderauto_id.'&product_i=";</script>';
    			    
    			}
    			// DECLINE DC WHICH WILL REVAMP THE STOCK
    			if(isset($_POST['datechange_decline']))
    			{
    			    $orderauto_id = $_GET['id'];
                    //$orderproduct_id = $_GET['product_i'];
                    
                    $new_tripcode = $_POST['new_tripcode'];
                    $new_travel_date = $_POST['new_travel_date'];
                    $new_no_of_pax = $_POST['new_no_of_pax'];
                    $original_tripcode = $_POST['original_tripcode'];
                    
                    $current_time_modified = date('Y-m-d H:i:s');
                    
                    global $current_user;
                    wp_get_current_user();
                    $current_usernme = $current_user->user_login;
                    $auto_id = $_POST['auto_id'];
                    $payment_recived = $_POST['payment_recived'];
                    
                    $query_select_comment = "SELECT * FROM wpk4_backend_travel_datechange_request WHERE auto_id='$auto_id'";
                    $result_select_comment = mysqli_query($mysqli, $query_select_comment) or die(mysqli_error($mysqli));
                    $row_select_comment = mysqli_fetch_assoc($result_select_comment);
                    $initiated_on = $row_select_comment['initial_request_date'];
                    
                    $sql_update_dc_request = "UPDATE wpk4_backend_travel_datechange_request SET
                    status='declined',payment_received='$payment_recived',ho_handled_by='$current_usernme',ho_handled_on='$current_time_modified'
                    WHERE auto_id='$auto_id'";
                    $result_dc_request = mysqli_query($mysqli, $sql_update_dc_request);
                    
                    $sql_update_dc_comments = "UPDATE wpk4_backend_todo_tasks SET status='declined',payment_received='$payment_recived'
                    WHERE order_id='$orderauto_id' && status_updated_on = '$initiated_on'";
                    $result_dc_comments = mysqli_query($mysqli, $sql_update_dc_comments);
                    
                    
                    
                    //fetch the pricing id of the new trip code
                    $query_select_pricing_new = "SELECT spm.pricing_id, p.max_pax FROM wpk4_backend_stock_product_manager spm
                    INNER JOIN wpk4_wt_pricings p ON p.id = spm.pricing_id
                    WHERE spm.trip_code = '$new_tripcode' AND spm.travel_date = '$new_travel_date'";
                    $result_select_pricing_new = mysqli_query($mysqli, $query_select_pricing_new) or die(mysqli_error($mysqli));
                    $row_select_pricing_new = mysqli_fetch_assoc($result_select_pricing_new);
                    $pricing_id_new = $row_select_pricing_new['pricing_id'];
                    $current_pax_new = $row_select_pricing_new['max_pax'];
                    
                    // unblock the seat
                    $update_pax_count_new = $current_pax_new + $new_no_of_pax;
                    $sql_update_pax_new = "UPDATE wpk4_wt_pricings SET max_pax='$update_pax_count_new' WHERE id='$pricing_id_new'";
                    $result_status_new = mysqli_query($mysqli, $sql_update_pax_new) or die(mysqli_error($mysqli));
					
					
					$query_get_current_availability_pax = "SELECT pax FROM wpk4_backend_manage_seat_availability where pricing_id = '$pricing_id_new' ";
					$result_get_current_availability_pax = mysqli_query($mysqli, $query_get_current_availability_pax);
					$row_get_current_availability_pax = mysqli_fetch_assoc($result_get_current_availability_pax); 
					$current_availability_pax = $row_get_current_availability_pax['pax'];
					
					$new_availability_pax = $current_availability_pax - $new_no_of_pax;
					
					$updated_by_username = 'datechange-decline_'.$current_usernme;
                    $sql_update_pax_new2 = "UPDATE wpk4_backend_manage_seat_availability SET pax = '$new_availability_pax', pax_updated_by = '$updated_by_username', pax_updated_on = '$current_time_modified' 
					WHERE pricing_id = '$pricing_id_new'";
                    $result_status_new2 = mysqli_query($mysqli, $sql_update_pax_new2) or die(mysqli_error($mysqli));
                    $new_no_of_pax2 = '-'.$new_no_of_pax;
					mysqli_query($mysqli, "insert into wpk4_backend_manage_seat_availability_log (pricing_id, original_pax, new_pax, updated_on, updated_by, order_id, changed_pax_count) 
					values ('$pricing_id_new','$current_availability_pax','$new_availability_pax','$current_time_modified','$updated_by_username', '$orderauto_id', '$new_no_of_pax2')") or die(mysqli_error($mysqli));
		
                    //revert back the old trip id seat count
                    $orderid = $_GET['id'];
                    $co_orderid = ($_GET['co_orderid'] ?? false)? $_GET['co_orderid'] : '' ;
                    
                    
                    $original_travel_date = $_POST['original_travel_date'];
                    $original_tripcode = $original_tripcode;
                    $total_pax_old = $_POST['original_no_of_pax'];
                    
                    $query_select_order_old = "SELECT * FROM wpk4_backend_travel_bookings where order_id = '$orderid' && co_order_id =
                    '$co_orderid'";
                    $result_select_order_old = mysqli_query($mysqli, $query_select_order_old) or die(mysqli_error($mysqli));
                    $row_select_order_old = mysqli_fetch_assoc($result_select_order_old);
                    
                    $product_id_old = $row_select_order_old['product_id'];
                    $travel_date_old = date('Y-m-d', strtotime($original_travel_date));
                    $original_tripcode = $original_tripcode;
                    
                    
                    $product_id_old = $row_select_order_old['product_id'];
                    
                    
                    $query_select_pricing_old = "SELECT * FROM wpk4_backend_stock_product_manager where trip_code = '$original_tripcode' &&
                    travel_date = '$travel_date_old'";
                    $result_select_pricing_old = mysqli_query($mysqli, $query_select_pricing_old) or die(mysqli_error($mysqli));
                    $row_select_pricing_old = mysqli_fetch_assoc($result_select_pricing_old);
                    $pricing_ids_old = $row_select_pricing_old['pricing_id'];
                    
                    $query_select_stock_old = "SELECT * FROM wpk4_wt_pricings where id = '$pricing_ids_old'";
                    $result_select_stock_old = mysqli_query($mysqli, $query_select_stock_old) or die(mysqli_error($mysqli));
                    $row_select_stock_old = mysqli_fetch_assoc($result_select_stock_old);
                    if(mysqli_num_rows($result_select_stock_old) > 0)
                    {
                        
                    
                        $current_pax_old = $row_select_stock_old['max_pax'];
                        
                        $update_pax_count_old = $current_pax_old - $total_pax_old;
                        
                        //echo "new trip id pax count - ".$update_pax_count_new." old trip id pax count - ".$update_pax_count_old;
                        
                        $sql_update_pax_old = "UPDATE wpk4_wt_pricings SET max_pax='$update_pax_count_old' WHERE id='$pricing_ids_old'";
                        $result_status_old= mysqli_query($mysqli,$sql_update_pax_old) or die(mysqli_error($mysqli));
                        
                        echo '<script>alert("Task modified.");</script>';
                    }
					
					$query_get_current_availability_pax = "SELECT pax FROM wpk4_backend_manage_seat_availability where pricing_id = '$pricing_ids_old' ";
					$result_get_current_availability_pax = mysqli_query($mysqli, $query_get_current_availability_pax);
					$row_get_current_availability_pax = mysqli_fetch_assoc($result_get_current_availability_pax); 
					$current_availability_pax = $row_get_current_availability_pax['pax'];
					
					$new_availability_pax = $current_availability_pax + $total_pax_old;
					
                    $sql_update_pax_new2 = "UPDATE wpk4_backend_manage_seat_availability SET pax = '$new_availability_pax', pax_updated_by = '$updated_by_username', pax_updated_on = '$current_time_modified' 
					WHERE pricing_id = '$pricing_ids_old'";
                    $result_status_new2 = mysqli_query($mysqli, $sql_update_pax_new2) or die(mysqli_error($mysqli));
					
					mysqli_query($mysqli, "insert into wpk4_backend_manage_seat_availability_log (pricing_id, original_pax, new_pax, updated_on, updated_by, order_id, changed_pax_count) 
					values ('$pricing_ids_old','$current_availability_pax','$new_availability_pax','$current_time_modified','$updated_by_username', '$orderauto_id', '$total_pax_old')") or die(mysqli_error($mysqli));
                    

                    $sql_update_dc_main = "UPDATE wpk4_backend_travel_bookings
                            SET travel_date='$original_travel_date',
                            trip_code='$original_tripcode',
                            new_product_id='',
                            modified_by='$current_usernme',
                            late_modified='$current_time_modified'
                            WHERE order_id='$orderauto_id' && trip_code = '$new_tripcode'";
                        $result_dc_main = mysqli_query($mysqli, $sql_update_dc_main);
                        
                    echo '<script>window.location.href = "?option=todo&id=' . $orderauto_id . '&product_i=";</script>';
        			    
    			}

    			// DC CHANGE PAYMENT STATUS
    			if(isset($_POST['payment_status_change']))
    			{
    			$orderauto_id = $_GET['id'];
    
    			$current_time_modified = date('Y-m-d H:i:s');
    			
    			global $current_user;
    			wp_get_current_user();
    			$current_usernme = $current_user->user_login;
    			$auto_id = $_POST['auto_id'];
    			$payment_recived = $_POST['payment_recived'];
    			
    			$query_select_comment = "SELECT * FROM wpk4_backend_travel_datechange_request WHERE auto_id='$auto_id'";
    			$result_select_comment = mysqli_query($mysqli, $query_select_comment) or die(mysqli_error($mysqli));
    			$row_select_comment = mysqli_fetch_assoc($result_select_comment);
    			$initiated_on = $row_select_comment['initial_request_date'];
    
    				$sql_update_dc_request = "UPDATE wpk4_backend_travel_datechange_request SET payment_received='$payment_recived',ho_handled_by='$current_usernme',ho_handled_on='$current_time_modified' WHERE auto_id='$auto_id'";
    					$result_dc_request = mysqli_query($mysqli,$sql_update_dc_request);
    				
    				$sql_update_dc_comments = "UPDATE wpk4_backend_todo_tasks SET payment_received='$payment_recived' WHERE order_id='$orderauto_id' && status_updated_on = '$initiated_on'";
    					$result_dc_comments = mysqli_query($mysqli,$sql_update_dc_comments);
    												
    				echo '<script>alert("Payment status modified.");</script>';
    				echo '<script>window.location.href="?option=todo&id='.$orderauto_id.'&product_i=";</script>';
    
    			}
    			
    		}
    		//else
    		{
    		$query_default_value = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$selected_orderid'";
    		$result_default_value = mysqli_query($mysqli, $query_default_value) or die(mysqli_error($mysqli));
    		$row_default_value = mysqli_fetch_assoc($result_default_value);
    		
    		if( current_user_can( 'administrator' ) || 
    		current_user_can( 'user_portal_complaint_editor_admin' ) || 
    		current_user_can( 'user_portal_datechange_editor_admin' ) ||
    		current_user_can( 'user_portal_refund_editor_admin' ) || 
    		current_user_can( 'payment_portal_user' ) || 
    		current_user_can( 'ho_operations' ) || 
    		current_user_can( 'ho_payment' ) || 
            current_user_can( 'datechange_manager' )
    		)
    		{
    		?>
			<font style="margin-top:40px; font-size:12px;">New Date Change Request</font>
			<form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
			<table class="table" style="width:90%; font-size:14px; margin:auto; border:1px solid black;">	
    				<tr>
    					<td>Order ID
    												<input type='text' required readonly name='order_id' style='width:100%; padding:10px;' value='<?php echo $selected_orderid; ?>'>
    					</td>
    					<td>
							Payment Received
    												<select required name='payment_received' style='width:100%; padding:10px;'>
    													<option selected value=''>Select</option>
    														<option value='yes'>Yes</option>
    														<option value='no'>No</option>
    													
    												</select>
    					</td>
    					<td>
							Ticket Issued
    												<select required name='ticket_issued' style='width:100%; padding:10px;'>
    													<option value='yes'>Yes</option>
    													<option selected value='no'>No</option>
    												</select>
    					</td>
						<td>
							DC Cost
    												<input type='text' name='dc_cost_taken' style='width:100%; padding:10px;'>
    					</td>
						<td>
							Partial Change
    												<select required name='partial_change' style='width:100%; padding:10px;'>
    													<option value='yes'>Yes</option>
    													<option selected value='no'>No</option>
    												</select>
    					</td>
						<td>
							Agent
    												<input type='text' required name='agent' value='<?php echo $row_default_value['agent_info']; ?>' style='width:100%; padding:10px;'>
    					</td>
    				</tr>
					<tr>
    					<td colspan='2'>
						Original Travel Date
    												<select required name='original_travel_date' style='width:100%; padding:10px;'>
    													<?php
    													$query_value = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$selected_orderid'";
    													$result_value = mysqli_query($mysqli, $query_value) or die(mysqli_error($mysqli));
    													while($row_value = mysqli_fetch_assoc($result_value))
    													{
    													?>
    														<option value='<?php echo $row_value['travel_date']; ?>'><?php echo $row_value['travel_date']; ?></option>
    													<?php
    													}
    													?>
    												</select>
    					</td>
    					<td colspan='2'>
							Original Pax Count
    												<select required name='original_no_of_pax' style='width:100%; padding:10px;'>
    												    <option value='0'>0</option>
    													<?php
    													$query_value = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$selected_orderid' AND co_order_id = '$orderco_orderid'";
    													$result_value = mysqli_query($mysqli, $query_value) or die(mysqli_error($mysqli));
    													while($row_value = mysqli_fetch_assoc($result_value))
    													{
    													?>
    														<option selected value='<?php echo $row_value['total_pax']; ?>'><?php echo $row_value['total_pax']; ?></option>
    													<?php
    													}
    													?>
    												</select>
    					</td>
    					<td colspan='2'>
							Original Tripcode
    												<select required name='original_tripcode' style='width:100%; padding:10px;'>
    													<?php
    													$query_value = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$selected_orderid'";
    													$result_value = mysqli_query($mysqli, $query_value) or die(mysqli_error($mysqli));
    													while($row_value = mysqli_fetch_assoc($result_value))
    													{
    													?>
    														<option selected value='<?php echo $row_value['trip_code']; ?>'><?php echo $row_value['trip_code']; ?></option>
    													<?php
    													}
    													?>
    												</select>
    					</td>
    				</tr>
					<tr>
    					<td colspan='2'>
						New Travel Date
    												<input type='text' required readonly id='new_travel_date' name='new_travel_date' style='width:100%; padding:10px;'>
    					</td>
    					<td colspan='2'>
							New Pax Count
    												<select required name='new_no_of_pax' style='width:100%; padding:10px;'>
    													<?php
    													for($paxauto = 0; $paxauto < 20; $paxauto++)
    													{
    														if($paxauto == $row_default_value['total_pax'])
    														{
    															echo '<option selected value="'.$paxauto.'">'.$paxauto.'</option>';
    														}
    														else
    														{
    															echo '<option value="'.$paxauto.'">'.$paxauto.'</option>';
    														}
    													}
    													?>
    												</select>
    					</td>
    					<td colspan='2'>
							New Tripcode
    												<select name='new_tripcode' style="width:100%; padding:10px;">
    												<option value=''>Select</option>
    												<?php
    												$array_tripcode = array();
    												$query_r = "SELECT * FROM wpk4_backend_stock_management_sheet order by trip_id asc";
    												$result_rg = mysqli_query($mysqli, $query_r) or die(mysqli_error($mysqli));
    												while($row_ty = mysqli_fetch_assoc($result_rg))
    												{
    													$array_tripcode[] = $row_ty['trip_id'];
    												}
    												$array_tripcode = array_unique($array_tripcode);
    
    												foreach($array_tripcode as $value)
    												{ 
    													?>
    														<option value='<?php echo $value; ?>'><?php echo $value; ?></option>
    													<?php	
    												}
    												?>
    												</select>
    					</td>
    				</tr>
					<tr>
    					<td colspan='6'>
							Remark
    						<textarea name='remark' style='width:100%; padding:10px;'></textarea>
    					</td>
    				</tr>
					<tr>
    					<td colspan='6'>
							<center><input type='submit' style='padding:10px; margin:0;font-size:12px; ' name='status_submitter_datechange' value='Save Task'></center>
    					</td>
    				</tr>
			</table>
			</form>
    		<?php
    		}
    		?>
    		<script src="https://cdn.jsdelivr.net/gh/alumuko/vanilla-datetimerange-picker@latest/dist/vanilla-datetimerange-picker.js"></script>
    		<script>
                window.addEventListener("load", function (event) {
    			var currentdate = new Date(); 
    				let drp = new DateRangePicker('new_travel_date',
                        {
    						minDate: currentdate,
                            timePicker: false,
                            alwaysShowCalendars: true,
    						singleDatePicker: true,
                            autoApply: false,
    						autoUpdateInput: false,
                            
                            locale: {
                                format: "YYYY-MM-DD",
                            }
                        },
    					function (start) {
    						var start_fixed = start.format().slice(0,10);
    						document.getElementById("new_travel_date").value = start_fixed;
                        })
                    
                });
    		</script>	
    		
    		</table>
    		
    		
    		<?php
    		}
    		?>
    		
    		
    	</div>
    	<!-- DC TASK END -->
        <!-- PAYMENT FOLLOWUP TASK START -->
        <div id="payment_followup" class="tabcontent" style="display:none;">
            <div class="section-header">
                <span>
                    <h6>Payment Followup Tasks</h6>
                </span>
                <button id='payment_followup_addnewtodo' onclick="addNewTask('payment_followup')">Add
                    New
                    Task</button>
            </div>
            <?php
                    $query_2 = "SELECT * FROM wpk4_backend_todo_tasks where order_id='$selected_orderid' && comment_type='payment_followup'";
                    $result_2 = mysqli_query($mysqli, $query_2);
                    $row_2_count = mysqli_num_rows($result_2);
                    // echo $row_2_count;
                    while($row_2 = mysqli_fetch_assoc($result_2))
                    {
                        $auto_id_message = $row_2['auto_id'];
                    ?>
            <div class="wpb_column vc_col-sm-12"
                style='background-color:#fcfcfc; border:1px solid #e3e3e3; padding:10px 5px;'>
                <div class="vc_column-inner">
                    <div class="wpb_wrapper">
                        <div
                            class="vc_row wpb_row vc_inner vc_row-fluid vc_column-gap-25 vc_row-o-equal-height vc_row-flex">
                            <div class="wpb_column vc_col-sm-8">
                                <div class="vc_column-inner">
                                    <div class="wpb_wrapper">
                                        <div class="wpb_single_image wpb_content_element" style='font-size:13px;'>
                                            by <?php echo $row_2['comment_by']; ?>
                                            on <?php echo $row_2['comment_date_time']; ?>
                                            &nbsp;
                                            |&nbsp;&nbsp;<span
                                                style='<?php if($row_2['status']=='open') { echo 'background-color:green;'; } else { echo 'background-color:red;'; } ?>padding:2px 5px; color:white;'><?php echo $row_2['status']; ?></span>&nbsp;&nbsp;<?php if($row_2['updated_by'] != '' && $row_2['status_updated_on'] != '0000-00-00 00:00:00' && $row_2['status'] != 'open') { echo ' by '.$row_2['updated_by'] .' on '. $row_2['status_updated_on']; } ?>
                                            </font> </br>
                                            Assigned to: <?php echo $row_2['assigned_to']; ?> </br>
                                            Payment Received: <?php echo $row_2['payment_received']; ?>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="wpb_column vc_col-sm-2">
                                <div class="vc_column-inner">
                                    <div class="wpb_wrapper">
                                        <div class="wpb_single_image wpb_content_element">
                                            <?php
                                                        if( current_user_can( 'administrator' ) || current_user_can( 'ho_operations' ) )
                                                            {
                                                            ?>
                                            <center>
                                                <form action="#" name="statusupdate" method="post"
                                                    enctype="multipart/form-data">
                                                    <select name='<?php echo $auto_id_message; ?>_status'
                                                        class="select-status">
                                                        <option selected disabled>Select</option>
                                                        <option value='closed'
                                                            <?php if($row_2['status']=='closed') { echo 'selected'; } ?>>
                                                            Close
                                                        </option>
                                                        <option value='open'
                                                            <?php if($row_2['status']=='open') { echo 'selected'; } ?>>
                                                            Open
                                                        </option>
                                                    </select>
                                                    <input type='submit' class="select-status-btn"
                                                        name='status_submitter' value='Save'>
                                                </form>
                                            </center>
                                            <?php
                                                            }
                                                        ?>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="wpb_column vc_col-sm-2">
                                <div class="vc_column-inner">
                                    <div class="wpb_wrapper">
                                        <div class="wpb_single_image wpb_content_element">
                                            <?php
                                                        if( current_user_can( 'administrator' ) || current_user_can( 'user_portal_complaint_editor_admin' ) || current_user_can( 'user_portal_datechange_editor_admin' ) || current_user_can( 'user_portal_refund_editor_admin' ) || current_user_can( 'payment_portal_user' ) || current_user_can( 'ho_operations' ) || current_user_can( 'ho_payment' ))
                                                            {
                                                            ?>
                                            <button id='replythistodo_<?php echo $js_button_counter; ?>'
                                                class='reply-task' data-id="<?php echo $row_2['auto_id']; ?>"
                                                onclick="addReplyTask(event, 'payment_followup')">Add Reply to
                                                this</button>
                                            <?php
                                                            }
                                                        ?>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="border-top: 1px solid #cfcfcf;">&nbsp;</div>
                <div class="vc_column-inner">
                    <div class="wpb_wrapper">
                        <div
                            class="vc_row wpb_row vc_inner vc_row-fluid vc_column-gap-25 vc_row-o-equal-height vc_row-flex">
                            <div class="wpb_column vc_col-sm-12">
                                <div class="vc_column-inner">
                                    <div class="wpb_wrapper">
                                        <div class="wpb_single_image wpb_content_element" style='font-size:13px;'>
                                            <?php echo $row_2['comment']; ?>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <?php
                $auto_id = $row_2['auto_id'];
    			echo get_reply_for_this_todo_task($auto_id);
                            ?>
            <div class="wpb_column vc_col-sm-12">
                <div class="vc_column-inner">
                    <div class="wpb_wrapper">
                        <div class="vc_row wpb_row vc_inner vc_row-fluid vc_row-o-equal-height vc_row-flex">
                            <div class="wpb_single_image wpb_content_element">
                                &nbsp;
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <?php
                    $js_button_counter++;
                    }
                    if($row_2_count==0)
                    {
                        echo '<div class="wpb_column vc_col-sm-12">
                            <div class="vc_column-inner">
                                <div class="wpb_wrapper">
                                    <div class="vc_row wpb_row vc_inner vc_row-fluid vc_row-o-equal-height vc_row-flex">
                                        <div class="wpb_single_image wpb_content_element">
                                            No Task Found..
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>';
                    }			
                  
                        ?>

            <?php echo generate_html_for_add_task_window('payment_followup');?>

            <?php echo generate_html_for_reply_task_window('payment_followup');?>
        </div>
        <!-- PAYMENT FOLLOWUP TASK END -->
        <div id="payment_adjust" class="tabcontent" style="display:none;">
            <div class="section-header">
                <h6>Payment Adjustment</h6>
            </div>
            <?php
            $query_pa = "SELECT * FROM wpk4_backend_travel_payment_history_pending where new_order_id='$selected_orderid' AND status='pending' ORDER BY created_by DESC";
            $result_pa = mysqli_query($mysqli, $query_pa);
            while($row_pa = mysqli_fetch_assoc($result_pa)) {
            ?>
                <div style="border: 1px solid #ccc; padding: 15px; margin-bottom: 20px;">
                    <form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                        <h6>Request Date: <?php echo $row_pa['created_by']; ?></h6>
                        <input type="hidden" name="auto_id" value="<?php echo $row_pa['auto_id']; ?>">
                        <table cellspacing="0" cellpadding="10">
                            <tr>
                                <td>Current Order ID</td>
                                <td>
                                    <input type="text" name="new_order_id" value="<?php echo $row_pa['new_order_id']; ?>" readonly>
                                </td>
                            </tr>
                            <tr>
                                <td>Previous Order ID</td>
                                <td><input type="text" name="old_order_id" id="old_order_id" value="<?php echo $row_pa['old_order_id']; ?>" readonly></td>
                            </tr>
                            <tr>
                                <td>Previous Amount</td>
                                <td><input type="text" name="changing_amount" id="changing_amount" value="<?php echo $row_pa['changing_amount']; ?>" readonly></td>
                            </tr>
                            <tr>
                                <td>Remark</td>
                                <td><textarea name="reason_for_transfer" readonly><?php echo $row_pa['reason_for_transfer']; ?></textarea></td>
                            </tr>
                            <tr>
                                <td colspan="2" style="text-align: center;">
                                    <input type='submit' name='update_user_payment_transfer' class='btn btn-success' style='padding:15px; margin:0; font-size:11px; background: green;' value='Approve'>
                                    <input type='submit' name='update_user_payment_transfer' class='btn btn-success' style='padding:15px; margin:0; font-size:11px; background: red;' value='Deny'>
                                </td>
                            </tr>
                        </table>
                    </form>
                </div>
            <?php
            }
            
            if (isset($_POST['update_user_payment_transfer'])) 
            {
                
                if (isset($_POST['update_user_payment_transfer']) && $_POST['update_user_payment_transfer'] == 'Deny') {
                    $auto_id = $_POST['auto_id'];
                    $new_order_id = $_POST['new_order_id'];
    
                    $sql_update_past_booking_2 ="UPDATE wpk4_backend_travel_payment_history_pending SET status = 'deny'
                    WHERE auto_id = '$auto_id'";
                    $results_update_past_booking_2 = $wpdb->query($sql_update_past_booking_2);
    
                    $sql_update_past_booking_2 ="UPDATE wpk4_backend_todo_tasks SET status = 'closed'
                    WHERE order_id = '$new_order_id' AND comment='$auto_id'";
                    $results_update_past_booking_2 = $wpdb->query($sql_update_past_booking_2);
                }
                else if (isset($_POST['update_user_payment_transfer']) && $_POST['update_user_payment_transfer'] == 'Approve') 
                {
                    $auto_id = $_POST['auto_id'];
                    $previous_order_id_for_adjustment_full = $_POST['old_order_id'];
                    $new_order_id = $_POST['new_order_id'];
    
                    if ( ctype_digit($new_order_id) && strlen($new_order_id) <= 7 ) {
            			$source = 'WPT';
                	} elseif (ctype_alpha($new_order_id)) {
                		$source = 'gds';
                	} else {
                		$source = 'gds';
                	}
                	
                	if ( ctype_digit($previous_order_id_for_adjustment_full) && strlen($previous_order_id_for_adjustment_full) <= 7 ) {
            			$source_previous = 'WPT';
                	} elseif (ctype_alpha($previous_order_id_for_adjustment_full)) {
                		$source_previous = 'gds';
                	} else {
                		$source_previous = 'gds';
                	}
                	
                	$previous_pnr_for_adjustment_full = 'DUMMYPNRFORPAYMENT';	
                	if($source_previous == 'gds' && $previous_order_id_for_adjustment_full != '' )
                	{
                	    $payment_get_orderid = $wpdb->get_results( "SELECT * FROM wpk4_backend_travel_booking_pax where pnr = '$previous_order_id_for_adjustment_full' OR order_id = '$previous_order_id_for_adjustment_full'"); 
        				foreach($payment_get_orderid as $row_get_orderid) { 
        				    $previous_order_id_for_adjustment_full = $row_get_orderid->order_id;
        				    $previous_pnr_for_adjustment_full = $row_get_orderid->pnr;
        				}
                	}
                    $previous_amount_for_adjustment_full = $_POST['changing_amount'];
                    $reason_for_transfer = $_POST['reason_for_transfer'];
    
                    $payment_received_for_previous_order = 0;
                    $payment_ref_partial = $wpdb->get_results( "SELECT * FROM wpk4_backend_travel_payment_history where order_id = '$previous_order_id_for_adjustment_full' "); 
    				foreach($payment_ref_partial as $row_2) { 
    				    $payment_received_for_previous_order += $row_2->trams_received_amount;
    				    $payment_process_date_of_previous_order = $row_2->process_date;
    				}
    				$payment_received_for_previous_order = number_format((float)$payment_received_for_previous_order, 2, '.', '');
    				$previous_amount_for_adjustment_full = number_format((float)$previous_amount_for_adjustment_full, 2, '.', '');
    				
    				$payment_partial_value_for_booking = '';
					
					$previous_order_date = date("Y-m-d H:i:s");
					$query_select_booking_order_date = "SELECT order_date FROM wpk4_backend_travel_bookings where order_id='$previous_order_id_for_adjustment_full'";
					$result_select_booking_order_date = mysqli_query($mysqli, $query_select_booking_order_date);
					if(mysqli_num_rows($result_select_booking_order_date) > 0)
					{
						$row_select_booking_order_date = mysqli_fetch_assoc($result_select_booking_order_date);
						$previous_order_date = $row_select_booking_order_date['order_date'];
					}
														
					$payment_refund_deadline = date('Y-m-d H:i:s', strtotime($previous_order_date . ' +96 hours'));
					
					$invoice_id = '';
					$query_select_order_invoice_id = "SELECT * FROM wpk4_backend_travel_payment_invoice where order_id='$new_order_id' order by invoice_id desc limit 1";
					$result_select_order_invoice_id = mysqli_query($mysqli, $query_select_order_invoice_id) or die(mysqli_error($mysqli));
					if(mysqli_num_rows($result_select_order_invoice_id) > 0)
					{
						$row_select_order_invoice_id = mysqli_fetch_assoc($result_select_order_invoice_id);
						$invoice_id = $row_select_order_invoice_id['invoice_id'];
											
					}
					
					$invoice_id_old = '';
					$query_select_order_invoice_id = "SELECT * FROM wpk4_backend_travel_payment_invoice where order_id='$previous_order_id_for_adjustment_full' order by invoice_id desc limit 1";
					$result_select_order_invoice_id = mysqli_query($mysqli, $query_select_order_invoice_id) or die(mysqli_error($mysqli));
					if(mysqli_num_rows($result_select_order_invoice_id) > 0)
					{
						$row_select_order_invoice_id = mysqli_fetch_assoc($result_select_order_invoice_id);
						$invoice_id_old = $row_select_order_invoice_id['invoice_id'];
											
					}
						
    				
    				if($payment_received_for_previous_order >= $previous_amount_for_adjustment_full && ($payment_received_for_previous_order != '0.00' && $previous_amount_for_adjustment_full != '0.00') && $reason_for_transfer != '')
                    {
                            $deposit_adjustment_note = $reason_for_transfer. ' - ' . $previous_amount_for_adjustment_full . ' transfered from ' . $previous_order_id_for_adjustment_full . ' to ' . $new_order_id;
                            
                            $wpdb->insert('wpk4_backend_history_of_updates', array(
                                    'type_id' =>$previous_order_id_for_adjustment_full,
                                    'meta_key' =>'deposit_adjustment_in_g360',
                                    'meta_value' => $deposit_adjustment_note,
                                    'updated_by' =>$currnt_userlogn,
                                    'updated_on' => $current_date_and_time,
                            ));
                                
                            $wpdb->insert('wpk4_backend_history_of_updates', array(
                                    'type_id' =>$new_order_id,
                                    'meta_key' =>'deposit_adjustment_in_g360',
                                    'meta_value' => $deposit_adjustment_note,
                                    'updated_by' =>$currnt_userlogn,
                                    'updated_on' => $current_date_and_time,
                            ));
                                
                            $previous_payment_history_reference_note = $payment_received_for_previous_order . ' has been transfered to '. $new_order_id;
                                
                            $wpdb->insert('wpk4_backend_travel_payment_history', array(
                                    'order_id' =>$previous_order_id_for_adjustment_full,
                                    'source' => $source_previous,
                                    'profile_no'=>'',
                                    'total_amount' =>'',
                                    'trams_received_amount' => '-'.$previous_amount_for_adjustment_full,
                                    'reference_no' =>'amount transfered to '.$new_order_id . ' - ' . $reason_for_transfer,
                                    'balance_amount' =>'',
                                    'payment_method' =>'14',
                                    'pay_type' =>'deposit_adjustment',
                        			'process_date' => $current_date_and_time,
									'payment_change_deadline' => $payment_refund_deadline,
									'gaura_invoice_id' => $invoice_id_old,
                        			'added_on' => $current_date_and_time,
                        			'added_by' => $currnt_userlogn,
                            ));
                            
                           
    
                            $wpdb->insert('wpk4_backend_travel_payment_history', array(
                                    'order_id' =>$new_order_id,
                                    'source' => $source,
                                    'profile_no'=>'',
                                    'total_amount' =>'',
                                    'trams_received_amount' =>$previous_amount_for_adjustment_full,
                                    'reference_no' =>'deposit transfered from '.$previous_order_id_for_adjustment_full . ' - ' . $reason_for_transfer,
                                    'balance_amount' =>'',
                                    'payment_method' =>'14',
                                    'pay_type' =>'deposit_adjustment',
                        			'process_date' => $current_date_and_time,
									'gaura_invoice_id' => $invoice_id,
									'payment_change_deadline' => $payment_refund_deadline,
                        			'added_on' => $current_date_and_time,
                        			'added_by' => $currnt_userlogn,
                            ));
                            
                            
                            
                            try {
								if ($payment_received_for_previous_order == $previous_amount_for_adjustment_full) {
									if (ctype_digit($previous_order_id_for_adjustment_full) && strlen($previous_order_id_for_adjustment_full) == 6) {
										$query_select_order = "SELECT * FROM wpk4_backend_travel_bookings WHERE order_id = '$previous_order_id_for_adjustment_full'";
										$result_select_order = mysqli_query($mysqli, $query_select_order);

										if (!$result_select_order) {
											throw new Exception("MySQLi query failed: " . mysqli_error($mysqli));
										}

										while ($row_select_order = mysqli_fetch_assoc($result_select_order)) {
											$payment_status_stock = $row_select_order['payment_status'];

											if ($payment_status_stock === 'partially_paid') {
												$trip_code = $row_select_order['trip_code'];
												$travel_date = $row_select_order['travel_date'];
												$total_pax = $row_select_order['total_pax'];

												update_stock_in_pricing_table($trip_code, $travel_date, $total_pax, 'positive');

												$by_user = $currnt_userlogn . '_amount_transfer_in_g360';

												availability_table_pax_update($previous_order_id_for_adjustment_full, $by_user);
											}
										}
									}

									// WordPress DB update
									$sql_update_past_booking = $wpdb->prepare(
										"UPDATE wpk4_backend_travel_bookings
										 SET payment_status = %s, payment_modified = %s, payment_modified_by = %s
										 WHERE order_id = %d",
										'voucher_submited',
										$current_date_and_time,
										$currnt_userlogn,
										$previous_order_id_for_adjustment_full
									);

									$results_update_past_booking = $wpdb->query($sql_update_past_booking);

									if ($results_update_past_booking === false) {
										throw new Exception("WPDB update failed: " . $wpdb->last_error);
									}

									// Log history
									$insert_history = mysqli_query($mysqli, "
										INSERT INTO wpk4_backend_travel_booking_update_history 
										(order_id, merging_id, pax_auto_id, meta_key, meta_value, updated_time, updated_user) 
										VALUES (
											'$previous_order_id_for_adjustment_full', '', '', 'payment_status', 
											'rebooked', '$current_date_and_time', '$currnt_userlogn'
										)
									");

									if (!$insert_history) {
										throw new Exception("MySQLi insert into update history failed: " . mysqli_error($mysqli));
									}
								}
							} catch (Exception $e) {
								error_log("Error in booking adjustment logic for order_id $previous_order_id_for_adjustment_full: " . $e->getMessage());
							}

                            
                            $total_amount_from_booking_table = 0.00;
                            $query_select_booking_order_original_status = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$new_order_id'";
                            $result_select_booking_original_status = mysqli_query($mysqli, $query_select_booking_order_original_status);
                            $row_select_booking_original_status = mysqli_fetch_assoc($result_select_booking_original_status);
                            if(mysqli_num_rows($result_select_booking_original_status) > 0)
                            {
                                $total_amount_from_booking_table = number_format((float)$row_select_booking_original_status['total_amount'], 2, '.', '');
                            }
                            
                            $total_paid_for_booking_transfer = 0.00;
                            $total_differ_from_total_and_paid = 1.10;
                            $query_total_paid_for_requestid = "SELECT * FROM wpk4_backend_travel_payment_history where order_id = '$new_order_id' AND (pay_type = 'deposit' OR pay_type = 'balance' 
                                        		OR pay_type = 'Balance' OR pay_type = 'deposit_adjustment' OR pay_type = 'additional_payment')";
                            $result_total_paid_for_requestid = mysqli_query($mysqli, $query_total_paid_for_requestid);
                            while($row_total_paid_for_requestid = mysqli_fetch_assoc($result_total_paid_for_requestid))
                            {
                                $total_paid_for_booking_transfer += $row_total_paid_for_requestid['trams_received_amount'];
                            }
                            $total_paid_for_booking_transfer = number_format((float)$total_paid_for_booking_transfer, 2, '.', '');
                            
                            $total_differ_from_total_and_paid = $total_amount_from_booking_table - $total_paid_for_booking_transfer;
                            $total_differ_from_total_and_paid = number_format((float)$total_differ_from_total_and_paid, 2, '.', '');
    
                            if($total_amount_from_booking_table != 0.00 && $total_paid_for_booking_transfer != 0.00 && ( $total_differ_from_total_and_paid != 1.10 && $total_differ_from_total_and_paid <= 1.00 && $total_differ_from_total_and_paid >= -1.00 ))
                            {
                                $sql_update_booking_main = "UPDATE wpk4_backend_travel_bookings SET payment_status='paid', balance='$total_differ_from_total_and_paid', payment_modified='$current_date_and_time', payment_modified_by='$currnt_userlogn' 
                			                WHERE order_id='$new_order_id' AND payment_status='partially_paid'";
                        		$result_booking_main= mysqli_query($mysqli,$sql_update_booking_main) or die(mysqli_error($mysqli));
								
								mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
					            values ('$new_order_id','','','payment_status','paid','$current_date_and_time','$currnt_userlogn')") or die(mysqli_error($mysqli));
                            }
                            
                            // change meta status
                            $sql_update_past_booking_2 ="UPDATE wpk4_backend_travel_payment_history_pending SET status = 'approved'
                            WHERE auto_id = '$auto_id'";
                            $results_update_past_booking_2 = $wpdb->query($sql_update_past_booking_2);
                            
                            $sql_update_past_booking_2 ="UPDATE wpk4_backend_todo_tasks SET status = 'closed'
                            WHERE order_id = '$new_order_id' AND comment='$auto_id'";
                            $results_update_past_booking_2 = $wpdb->query($sql_update_past_booking_2);
                            
                        echo '<script>window.location.href="?option=todo&id=' . $new_order_id . '";</script>';
                    }
                    else
                    {
    
                        echo '<script>alert("Error during the process. Kindly try again. Below can be the issue,\n\n Transfer amount is higher than the paid amount\n Remark not provided");</script>';
                    }
                }
            }

            ?>
        </div>
        <!-- MISCELLANEOUS TASK START -->
        <div id="miscellaneous" class="tabcontent" style="display:none;">
            <div class="section-header">
                <span>
                    <h6>Miscellaneous Tasks</h6>
                </span>
                <button id='miscellaneous_addnewtodo' onclick="addNewTask('miscellaneous')">Add New
                    Task</button>
            </div>
            <?php
                    $query_2 = "SELECT * FROM wpk4_backend_todo_tasks where order_id='$selected_orderid' && comment_type='miscellaneous'";
                    $result_2 = mysqli_query($mysqli, $query_2);
                    $row_2_count = mysqli_num_rows($result_2);
                    //echo $row_2_count;
                    while($row_2 = mysqli_fetch_assoc($result_2))
                    {
                        $auto_id_message = $row_2['auto_id'];
                    ?>
            <div class="wpb_column vc_col-sm-12"
                style='background-color:#fcfcfc; border:1px solid #e3e3e3; padding:10px 5px;'>
                <div class="vc_column-inner">
                    <div class="wpb_wrapper">
                        <div
                            class="vc_row wpb_row vc_inner vc_row-fluid vc_column-gap-25 vc_row-o-equal-height vc_row-flex">
                            <div class="wpb_column vc_col-sm-8">
                                <div class="vc_column-inner">
                                    <div class="wpb_wrapper">
                                        <div class="wpb_single_image wpb_content_element" style='font-size:13px;'>
                                            by <?php echo $row_2['comment_by']; ?>
                                            on <?php echo $row_2['comment_date_time']; ?>
                                            &nbsp;
                                            |&nbsp;&nbsp;<span
                                                style='<?php if($row_2['status']=='open') { echo 'background-color:green;'; } else { echo 'background-color:red;'; } ?>padding:2px 5px; color:white;'><?php echo $row_2['status']; ?></span>&nbsp;&nbsp;<?php if($row_2['updated_by'] != '' && $row_2['status_updated_on'] != '0000-00-00 00:00:00' && $row_2['status'] != 'open') { echo ' by '.$row_2['updated_by'] .' on '. $row_2['status_updated_on']; } ?>
                                            </font> </br>
                                            Assigned to: <?php echo $row_2['assigned_to']; ?> </br>
                                            Payment Received: <?php echo $row_2['payment_received']; ?>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="wpb_column vc_col-sm-2">
                                <div class="vc_column-inner">
                                    <div class="wpb_wrapper">
                                        <div class="wpb_single_image wpb_content_element">
                                            
                                            <center>
                                                <form action="#" name="statusupdate" method="post"
                                                    enctype="multipart/form-data">
                                                    <select name='<?php echo $auto_id_message; ?>_status'
                                                        class="select-status">
                                                        <option selected disabled>Select</option>
                                                        <option value='closed'
                                                            <?php if($row_2['status']=='closed') { echo 'selected'; } ?>>
                                                            Close
                                                        </option>
                                                        <option value='open'
                                                            <?php if($row_2['status']=='open') { echo 'selected'; } ?>>
                                                            Open
                                                        </option>
                                                    </select>
                                                    <input type='submit' class="select-status-btn"
                                                        name='status_submitter' value='Save'>
                                                </form>
                                            </center>
                                            
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="wpb_column vc_col-sm-2">
                                <div class="vc_column-inner">
                                    <div class="wpb_wrapper">
                                        <div class="wpb_single_image wpb_content_element">
                                            <?php
                                                        if( current_user_can( 'administrator' ) || current_user_can( 'user_portal_complaint_editor_admin' ) || current_user_can( 'user_portal_datechange_editor_admin' ) || current_user_can( 'user_portal_refund_editor_admin' ) || current_user_can( 'payment_portal_user' ) || current_user_can( 'ho_operations' ) || current_user_can( 'ho_payment' ))
                                                            {
                                                            ?>

                                            <button id='replythistodo_<?php echo $js_button_counter; ?>'
                                                class='reply-task' data-id="<?php echo $row_2['auto_id']; ?>"
                                                onclick="addReplyTask(event, 'miscellaneous')">Add Reply to
                                                this</button>
                                            <?php
                                                            }
                                                        ?>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="border-top: 1px solid #cfcfcf;">&nbsp;</div>
                <div class="vc_column-inner">
                    <div class="wpb_wrapper">
                        <div
                            class="vc_row wpb_row vc_inner vc_row-fluid vc_column-gap-25 vc_row-o-equal-height vc_row-flex">
                            <div class="wpb_column vc_col-sm-12">
                                <div class="vc_column-inner">
                                    <div class="wpb_wrapper">
                                        <div class="wpb_single_image wpb_content_element" style='font-size:13px;'>
                                            <?php echo $row_2['comment']; ?>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <?php
                        $auto_id = $row_2['auto_id'];
    			echo get_reply_for_this_todo_task($auto_id);
                            ?>
            <div class="wpb_column vc_col-sm-12">
                <div class="vc_column-inner">
                    <div class="wpb_wrapper">
                        <div class="vc_row wpb_row vc_inner vc_row-fluid vc_row-o-equal-height vc_row-flex">
                            <div class="wpb_single_image wpb_content_element">
                                &nbsp;
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <?php
                    $js_button_counter++;
                    }
                    if($row_2_count==0)
                    {
                        echo '<div class="wpb_column vc_col-sm-12">
                            <div class="vc_column-inner">
                                <div class="wpb_wrapper">
                                    <div class="vc_row wpb_row vc_inner vc_row-fluid vc_row-o-equal-height vc_row-flex">
                                        <div class="wpb_single_image wpb_content_element">
                                            No Task Found..
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>';
                    }	
            echo generate_html_for_add_task_window('miscellaneous');
			
			echo generate_html_for_reply_task_window('miscellaneous');
			?>
        </div>
        <!-- MISCELLANEOUS TASK END -->

        <?php
        // CREATE NEW DC TODO TASK
		if(isset($_POST['status_submitter_datechange']))
		{
    		$orderauto_id = $_GET['id'];
    
    		$current_time_modified = date('Y-m-d H:i:s');
    		
    		global $current_user;
    		wp_get_current_user();
    		$current_usernme = $current_user->user_login;
    		
    		$original_no_of_pax = $_POST['original_no_of_pax'];
            $original_tripcode = $_POST['original_tripcode'];
            $original_travel_date = $_POST['original_travel_date'];
            $new_no_of_pax = $_POST['new_no_of_pax'];
            $new_tripcode = $_POST['new_tripcode'];
            $new_travel_date = $_POST['new_travel_date'] . ' 00:00:00';
            $payment_received = $_POST['payment_received'];
            $ticket_issued = $_POST['ticket_issued'];
            $ticket_cost =  ($_POST['ticket_cost'] ?? false)? $_POST['ticket_cost'] : '' ;
            $dc_cost_taken = $_POST['dc_cost_taken'];
            $agent = $_POST['agent'];
            $remark = $_POST['remark'];
            $partial_change = $_POST['partial_change'];
    		$initial_request_date = $current_time_modified;
    		$requested_by = $current_usernme;
    		$requested_on = $current_time_modified;
    		$status = 'new';
		
		    if ($original_no_of_pax != '' && $original_tripcode != '' && $original_travel_date != '' && $new_no_of_pax != '' && $new_tripcode != '' && $new_travel_date != '' && $dc_cost_taken != '')
		    {
		        $new_travel_date_c = date('Y-m-d', strtotime($new_travel_date));
                //fetch the pricing id of the new trip code
                $query_select_pricing_new = "SELECT spm.pricing_id, p.max_pax FROM wpk4_backend_stock_product_manager spm
                INNER JOIN wpk4_wt_pricings p ON p.id = spm.pricing_id
                WHERE spm.trip_code = '$new_tripcode' AND spm.travel_date = '$new_travel_date_c'";
                $result_select_pricing_new = mysqli_query($mysqli, $query_select_pricing_new) or die(mysqli_error($mysqli));
                $row_select_pricing_new = mysqli_fetch_assoc($result_select_pricing_new);
                $pricing_id_new = $row_select_pricing_new['pricing_id'];
                $current_pax_new = $row_select_pricing_new['max_pax'];
                
                
                if ($new_no_of_pax > $current_pax_new) {
                
                    $msg = "Error - Only " . $current_pax_new . " seats are available";
                    echo '<script>alert("' . $msg . '");</script>';
                    echo '<script>window.location.href = "?option=todo&id=' . $orderauto_id . '&product_i=";</script>';
                } 
                else 
                {
                    mysqli_query($mysqli, "insert into wpk4_backend_travel_datechange_request (order_id, original_no_of_pax,
                        original_tripcode, original_travel_date, new_no_of_pax, new_tripcode, new_travel_date, payment_received, ticket_issued,
                        ticket_cost, dc_cost_taken, agent, remark, partial_change, initial_request_date, requested_by, requested_on, status)
                        values ('$orderauto_id', '$original_no_of_pax', '$original_tripcode', '$original_travel_date', '$new_no_of_pax',
                        '$new_tripcode', '$new_travel_date', '$payment_received', '$ticket_issued', '$ticket_cost', '$dc_cost_taken', '$agent',
                        '$remark', '$partial_change', '$initial_request_date', '$requested_by', '$requested_on', '$status')") or die(mysqli_error($mysqli));
                    
                    mysqli_query($mysqli, "insert into wpk4_backend_todo_tasks (order_id, comment_by, comment_date_time, comment_type,
                        status, status_updated_on, payment_received) values ('$orderauto_id', '$requested_by', '$requested_on', 'date change',
                        'open', '$requested_on', '$payment_received')") or die(mysqli_error($mysqli));
                    
                    
                    $new_product_id = '';
                    $query_select_new_product_id = "SELECT * FROM wpk4_backend_stock_product_manager where trip_code = '$new_tripcode' &&
                    travel_date = '$new_travel_date'";
                    $result_select_new_product_id = mysqli_query($mysqli, $query_select_new_product_id) or die(mysqli_error($mysqli));
                    $row_select_new_product_id = mysqli_fetch_assoc($result_select_new_product_id);
                    if(mysqli_num_rows($result_select_new_product_id) > 0)
                    {
                        $new_product_id = $row_select_new_product_id['product_id'];
                        
                    }
                    
                    // if new product is available
                    if($new_product_id != '' && $partial_change != 'yes')
                    {
                        $result_fetch_original_prod = "";
                        // get the pnr and ticket for the previous product
                        if ($ticket_issued == 'yes') 
                        {
                            $sql_fetch_original_prod = "SELECT tb.product_id, TRIM(tbp.ticket_number) as ticket_number, tbp.auto_id, tbp.email_pax
                                FROM wpk4_backend_travel_bookings tb
                                INNER JOIN wpk4_backend_travel_booking_pax tbp on tbp.order_id = tb.order_id AND tbp.product_id = tb.product_id
                                WHERE tb.order_id='$orderauto_id' && tb.trip_code = '$original_tripcode'";
                            
                            $result_fetch_original_prod = mysqli_query($mysqli, $sql_fetch_original_prod) or die(mysqli_error($mysqli));;
                        }
                        
                        // if pnr and ticket issued for the previous product then make it null
                        if ($ticket_issued == 'yes' && $result_fetch_original_prod != "") 
                        {
                        
                            if ($result_fetch_original_prod->num_rows > 0) 
                            {
                                while ($row = $result_fetch_original_prod->fetch_assoc()) 
                                {
                                
                                    $original_product_id = $row['product_id'];
                                    $original_ticket_number = $row['ticket_number'];
                                    $merging_id = $row['auto_id'];
                                    $email_pax = $row['email_pax'];
                                    $email = 'sampledevtest0@gmail.com';
                                    
                                    if ($original_ticket_number != '' || $original_ticket_number != NULL) 
                                    {
                                        // update ticket number to be null if the date change request is accepted
                                        $sql_update_ticket_number = "UPDATE wpk4_backend_travel_booking_pax tbp
                                        SET tbp.ticket_number=NULL, tbp.ticketed_on=NULL, tbp.ticketed_by=NULL, tbp.PNR=NULL, tbp.pax_status='New', tbp.pax_status=NULL, tbp.name_updated=NULL
                                        WHERE tbp.auto_id='$merging_id';";
                                        $result_update_ticket_number = mysqli_query($mysqli, $sql_update_ticket_number);
                                        
                                        // include a record in history table
                                        mysqli_query($mysqli, "INSERT INTO wpk4_backend_travel_booking_update_history(order_id, merging_id, meta_key ,
                                        meta_value, updated_time, updated_user)
                                        VALUES ('$orderauto_id', '$merging_id', 'ticket_number','$original_ticket_number','$current_time_modified','$current_usernme');") or die(mysqli_error($mysqli));
                                    }
                                }
                            }
                        }
                    
                        $sql_update_dc_main = "UPDATE wpk4_backend_travel_bookings
                            SET travel_date='$new_travel_date',
                            trip_code='$new_tripcode',
                            new_product_id='$new_product_id',
                            modified_by='$current_usernme',
                            late_modified='$current_time_modified'
                            WHERE order_id='$orderauto_id' && trip_code = '$original_tripcode'";
                        $result_dc_main = mysqli_query($mysqli, $sql_update_dc_main);
                        
                        // block the seat for the request
                        $update_pax_count_new = $current_pax_new - $new_no_of_pax;
                        $sql_update_pax_new = "UPDATE wpk4_wt_pricings SET max_pax='$update_pax_count_new' WHERE id='$pricing_id_new'";
                        $result_status_new = mysqli_query($mysqli, $sql_update_pax_new) or die(mysqli_error($mysqli));
						
						
						$query_get_current_availability_pax = "SELECT pax FROM wpk4_backend_manage_seat_availability where pricing_id = '$pricing_id_new' ";
						$result_get_current_availability_pax = mysqli_query($mysqli, $query_get_current_availability_pax);
						$row_get_current_availability_pax = mysqli_fetch_assoc($result_get_current_availability_pax); 
						$current_availability_pax = $row_get_current_availability_pax['pax'];
						
						$new_availability_pax = $current_availability_pax + $new_no_of_pax;
						
						$updated_by_username = 'datechange-request_'.$current_usernme;
						
						$sql_update_pax_new2 = "UPDATE wpk4_backend_manage_seat_availability SET pax = '$new_availability_pax', pax_updated_by = '$updated_by_username', pax_updated_on = '$current_time_modified' WHERE pricing_id = '$pricing_id_new'";
						$result_status_new2 = mysqli_query($mysqli, $sql_update_pax_new2) or die(mysqli_error($mysqli));
						
						mysqli_query($mysqli, "insert into wpk4_backend_manage_seat_availability_log (pricing_id, original_pax, new_pax, updated_on, updated_by, order_id, changed_pax_count) 
						values ('$pricing_id_new','$current_availability_pax','$new_availability_pax','$current_time_modified','$updated_by_username', '$orderauto_id', '$new_no_of_pax')") or die(mysqli_error($mysqli));
                    
                        
                        $order_id = $_POST['order_id'];
                        
                        $query = "SELECT spm.product_id as old_product_id,
                            (SELECT spm.product_id FROM wpk4_backend_stock_product_manager spm WHERE spm.trip_code='" . $new_tripcode . "' AND
                            DATE(spm.travel_date) = '" . $new_travel_date . "') as new_product_id
                            FROM wpk4_backend_stock_product_manager spm
                            WHERE spm.trip_code='" . $original_tripcode . "' AND DATE(spm.travel_date) = '" . $original_travel_date . "';";
                        $result = mysqli_query($mysqli, $query) or die(mysqli_error($mysqli));
                        $row = mysqli_fetch_assoc($result);
                        
                        $old_trip_code = explode('-', $original_tripcode);
                        $new_trip_code = explode('-', $new_tripcode);
                        
                        $old_travel_date_depart = $original_travel_date;
                        $new_travel_date_depart = $new_travel_date;
                        
                        // add total_pax_old to old trip id
                        $orderid = $_GET['id'];
                        $co_orderid = ($_GET['co_orderid'] ?? false)? $_GET['co_orderid'] : '' ;
                        $productid = ($_GET['product_i'] ?? false)? $_GET['product_i'] : '' ;
    
                        
                        $original_travel_date = $_POST['original_travel_date'];
                        $original_tripcode = $original_tripcode;
                        $total_pax_old = $_POST['original_no_of_pax'];
                        $new_travel_date = $new_travel_date;
                        $new_tripcode = $new_tripcode;
    					
    					$query_select_order_old = "SELECT * FROM wpk4_backend_travel_bookings where order_id = '$orderid' && co_order_id =
                        '$co_orderid' && product_id = '$productid'";
                        $result_select_order_old = mysqli_query($mysqli, $query_select_order_old) or die(mysqli_error($mysqli));
                        $row_select_order_old = mysqli_fetch_assoc($result_select_order_old);
                        
                        $travel_date_old = date('Y-m-d', strtotime($original_travel_date));
                        $original_tripcode = $original_tripcode;
                        $pricing_ids_old = 'TESTPRICINGID';
                        $query_select_pricing_old = "SELECT * FROM wpk4_backend_stock_product_manager where trip_code = '$original_tripcode' AND
                        travel_date = '$travel_date_old'";
                        $result_select_pricing_old = mysqli_query($mysqli, $query_select_pricing_old) or die(mysqli_error($mysqli));
                        $row_select_pricing_old = mysqli_fetch_assoc($result_select_pricing_old);
                        if(mysqli_num_rows($result_select_pricing_old) > 0)
                        {
                            $pricing_ids_old = $row_select_pricing_old['pricing_id'];
                        
                            $query_select_stock_old = "SELECT * FROM wpk4_wt_pricings where id = '$pricing_ids_old'";
                            $result_select_stock_old = mysqli_query($mysqli, $query_select_stock_old) or die(mysqli_error($mysqli));
                            $row_select_stock_old = mysqli_fetch_assoc($result_select_stock_old);
                            if(mysqli_num_rows($result_select_stock_old) > 0)
                            {
                                $current_pax_old = $row_select_stock_old['max_pax'];
                                
                                $update_pax_count_old = $current_pax_old + $total_pax_old;
                                
                                $sql_update_pax_old = "UPDATE wpk4_wt_pricings SET max_pax='$update_pax_count_old' WHERE id='$pricing_ids_old'";
                                $result_status_old= mysqli_query($mysqli,$sql_update_pax_old) or die(mysqli_error($mysqli));
                                
                                
                                echo "new trip id pax count - ". $update_pax_count_new. " old trip id pax count - ". $update_pax_count_old;
                                
                            }
                        }
						
						$query_get_current_availability_pax = "SELECT pax FROM wpk4_backend_manage_seat_availability where pricing_id = '$pricing_ids_old' ";
						$result_get_current_availability_pax = mysqli_query($mysqli, $query_get_current_availability_pax);
						$row_get_current_availability_pax = mysqli_fetch_assoc($result_get_current_availability_pax); 
						$current_availability_pax = $row_get_current_availability_pax['pax'];
						
						$new_availability_pax = $current_availability_pax - $total_pax_old;
						
						$sql_update_pax_new2 = "UPDATE wpk4_backend_manage_seat_availability SET pax = '$new_availability_pax', pax_updated_by = '$updated_by_username', pax_updated_on = '$current_time_modified' WHERE pricing_id = '$pricing_ids_old'";
						$result_status_new2 = mysqli_query($mysqli, $sql_update_pax_new2) or die(mysqli_error($mysqli));
                        $total_pax_old2 = '-'.$total_pax_old;
						mysqli_query($mysqli, "insert into wpk4_backend_manage_seat_availability_log (pricing_id, original_pax, new_pax, updated_on, updated_by, order_id, changed_pax_count) 
						values ('$pricing_ids_old','$current_availability_pax','$new_availability_pax','$current_time_modified','$updated_by_username', '$orderauto_id', '$total_pax_old2')") or die(mysqli_error($mysqli));
                    }
                    
                    echo '<script>alert("Task has been added");</script>';
                    echo '<script>window.location.href = "?option=todo&id=' . $orderauto_id . '&product_i=";</script>';
                }
            }
            else 
            {
                echo '<script>alert("Kindly add all the required information");</script>';
            }
		}
		?>
        </br>
        <?php
		}
		
			// INDIVIDUAL TODO TASK STATUS UPDATION CODE
			if(isset($_POST['status_submitter']))
			{
    			$orderauto_id = $_GET['id'];
    			$current_time_modified = date('Y-m-d H:i:s');
    			
    			global $current_user;
    			wp_get_current_user();
    			$current_usernme = $current_user->user_login;
    			
    			$query_2_checker = "SELECT * FROM wpk4_backend_todo_tasks where order_id='$orderauto_id'";
    			$result_2_checker = mysqli_query($mysqli, $query_2_checker);
    			while($row_2_checker = mysqli_fetch_assoc($result_2_checker))
    			{
    				$row_auto_id_pax = $row_2_checker['auto_id'];
    				foreach($row_2_checker as $columnname_db => $db_value)
    				{
    					
    					$dbcolumn_and_postname_checker = $row_auto_id_pax.'_'.$columnname_db;
    					foreach ($_POST as $post_fieldname => $post_fieldvalue) {
    						if($post_fieldname == $dbcolumn_and_postname_checker)
    						{
    								
    								$sql_update_status = "UPDATE wpk4_backend_todo_tasks SET status='$post_fieldvalue',updated_by='$current_usernme',status_updated_on='$current_time_modified' WHERE order_id='$orderauto_id' && auto_id='$row_auto_id_pax'";
    								$result_status= mysqli_query($mysqli,$sql_update_status);
    								
    								echo '<script>window.location.href="?option=todo&id='.$orderauto_id.'&product_i=";</script>';
    						}
    					}
    				}
    			}
			}
			
			// TODO REPLY CODE SEGMENT
			if(isset($_POST['btn_reply']))
			{
    			$current_time_modified = date('Y-m-d H:i:s');
    			
    			global $current_user;
    			wp_get_current_user();
    			$current_usernme = $current_user->user_login;
    			$task_id = $_POST['task_id'];
    			$comment_post = $_POST['comment'];
    			$orderauto_id = $_GET['id'];

    			mysqli_query($mysqli,"insert into wpk4_backend_todo_task_chat(request_id,response,response_time,response_by,status) values ('$task_id','$comment_post','$current_time_modified','$current_usernme','open')") or die(mysqli_error($mysqli));
    			echo '<script>window.location.href="?option=todo&id='.$orderauto_id.'&product_i=";</script>';
			}
			
			// CREATE NEW TODO TASK CODE SEGMENT
			if(isset($_POST['btn_book_pax']))
			{
    			$current_time_modified = date('Y-m-d H:i:s');
    			
    			global $current_user;
    			wp_get_current_user();
    			$current_usernme = $current_user->user_login;

    			$comment_type = $_POST['comment_type'];
    			$payment_received = $_POST['payment_received'];	
    			$ticket_issued = $_POST['ticket_issued'];	
    			$status = $_POST['status'];
    			$comment_post = $_POST['comment'];
    			
    			$assigned_to = ($_POST['assigned_to'] ?? false)? $_POST['assigned_to'] : '';
    			
    			$orderauto_id = $_GET['id'];

    			mysqli_query($mysqli,"insert into wpk4_backend_todo_tasks(order_id,product_id,comment_by,comment_date_time,comment_type,comment,assigned_to,payment_received,status,updated_by,status_updated_on,ticket_issued) 
    			values ('$orderauto_id','','$current_usernme','$current_time_modified','$comment_type','$comment_post','$assigned_to','$payment_received','$status','$current_usernme','$current_time_modified','$ticket_issued')") or die(mysqli_error($mysqli));
	  
    			echo '<script>window.location.href="?option=todo&id='.$orderauto_id.'&product_i=";</script>';
			}
    }
    if(isset($_GET['option']) && $_GET['option']=='amount-adjustment')
    {
        if( 1 == 2)
        {
                $auto_id_received = $_GET['id'];
                $query_payment_history = "SELECT * FROM wpk4_backend_travel_payment_history where auto_id='$auto_id_received'";
                $result_payment_history = mysqli_query($mysqli, $query_payment_history);
                $row_payment_history = mysqli_fetch_assoc($result_payment_history);
        ?>
        <form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
            <tr>
                <td>Current Order ID *</td>
                <td><input type="text" name="old_order_id" value="<?php echo $row_payment_history['order_id']; ?>" required></td>
            </tr>
            </br>
            <tr>
                <td>Transfer to Order ID *</td>
                <td><input type="text" name="new_order_id" required></td>
            </tr>
            </br>
            <tr>
                <td>Received Amount *</td>
                <td><input type="text" value="<?php echo $row_payment_history['trams_received_amount']; ?>"
                        name="received_amount" required></td>
            </tr>
            </br>
            <tr>
                <td>Transfering Amount *</td>
                <td><input type="text" value="<?php echo $row_payment_history['trams_received_amount']; ?>"
                        name="transfering_amount" required></td>
            </tr>
            </br>
            <tr>
                <td>Remark *</td>
                <td><textarea name="reason_for_transfer" required></textarea></td>
            </tr>
            </br>
            <center><input type='submit' name='update_payment_transfer' class='btn btn-success'
                    style='padding:15px; margin:0;font-size:11px;' value='Save'></center>
        </form>
        <?php
                if (isset($_POST['update_payment_transfer'])) {
                    $auto_id_for_pay_history = $_GET['id'];
                    $old_order_id = $_POST['old_order_id'];
                    $new_order_id = $_POST['new_order_id'];
                    
                    if (ctype_digit($new_order_id)) {
									$source = 'WPT';
    							} elseif (ctype_alpha($new_order_id)) {
    								$source = 'gds';
    							} else {
    								$source = 'gds';
    							}
    							
                    $received_amount = $_POST['received_amount'];
                    $transfering_amount = $_POST['transfering_amount'];
                    $reason_for_transfer = $_POST['reason_for_transfer'];

                    if ($reason_for_transfer != '') {
                        $query_payment_qur = "SELECT * FROM wpk4_backend_travel_payment_history where auto_id='$auto_id_for_pay_history'";
                        $result_payment_qur = mysqli_query($mysqli, $query_payment_qur);
                        $row_payment_qur = mysqli_fetch_assoc($result_payment_qur);
                        $profile_no = $row_payment_qur['profile_no'];
                        
                        
                        $reference_no = 'deposit transfered from '. $old_order_id;
                        
                        $process_date = $row_payment_qur['process_date'];
                        //echo $auto_id_for_pay_history;
                        $process_date = date('Y-m-d H:i:s', strtotime($process_date));
                        
                        $remaining_for_old_order = (float)$received_amount - (float)$transfering_amount;
                        $sql_update_status = "UPDATE wpk4_backend_travel_payment_history SET trams_received_amount='$remaining_for_old_order' WHERE auto_id='$auto_id_for_pay_history'";
                        $result_status = mysqli_query($mysqli, $sql_update_status) or die(mysqli_error());
						

                        mysqli_query($mysqli, "insert into wpk4_backend_travel_payment_history (process_date, source, order_id, profile_no, trams_received_amount, reference_no, modified_date, modified_by, pay_type, payment_method, added_on, added_by) 
					        values ('$process_date', '$source', '$new_order_id', '$profile_no', '$transfering_amount','$reference_no', '$current_date_and_time', '$currnt_userlogn', 'deposit_adjustment', '14', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));

                        $history_description = $transfering_amount . ' transfered from ' . $old_order_id . ' to ' . $new_order_id;

                        mysqli_query($mysqli, "insert into wpk4_backend_travel_booking_update_history (order_id, meta_key, meta_value, meta_key_data, updated_time, updated_user) 
					        values ('$new_order_id', 'amount_adjustment', '$history_description','$reason_for_transfer', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));

                        echo '<script>window.location.href="?option=search&type=reference&id=' . $old_order_id . '";</script>';
                    } else {
                        echo '<script>alert("Kindly add remark for this transfer.");</script>';
                    }
                }
        }
    }
    
    if(isset($_GET['option']) && $_GET['option']=='ticketing-deadline')
    {
        /*$query = "
            SELECT booking.order_id, booking.trip_code, booking.order_type, booking.source, updates.meta_value, pax.pax_status, pax.pnr, pax.email_pax, pax.phone_pax, booking.payment_status, booking.order_date
            FROM wpk4_backend_travel_bookings AS booking
            JOIN wpk4_backend_history_of_updates AS updates 
                ON booking.order_id = updates.type_id 
            JOIN wpk4_backend_travel_booking_pax AS pax 
                ON booking.order_id = pax.order_id 
            WHERE booking.order_type = 'gds' AND LENGTH(pax.pnr) < 8 
                AND booking.payment_status IN ('partially_paid', 'paid')
                AND pax.pax_status = 'Name Updated'
                AND updates.meta_key = 'Flight TicketingTimeLimit'
                AND DATE(booking.order_date) BETWEEN DATE(CURRENT_DATE - INTERVAL 2 DAY) AND CURRENT_DATE
                AND STR_TO_DATE(updates.meta_value, '%Y-%m-%d') BETWEEN CURRENT_DATE AND ADDDATE(CURDATE(), INTERVAL 36 HOUR)
            ORDER BY updates.meta_value ASC 
            LIMIT 50;
        ";*/
        
		$query = "
            SELECT booking.order_id, booking.trip_code, booking.order_type, booking.source, booking.ticketing_timelimit, pax.pax_status, pax.pnr, pax.email_pax, pax.phone_pax, booking.payment_status, booking.order_date
            FROM wpk4_backend_travel_bookings AS booking
            JOIN wpk4_backend_travel_booking_pax AS pax 
                ON booking.order_id = pax.order_id 
            WHERE booking.order_type = 'gds' AND LENGTH(pax.pnr) < 8 
                AND booking.payment_status IN ('partially_paid', 'paid')
                AND pax.pax_status = 'Name Updated'
                AND booking.ticketing_timelimit IS NOT NULL
                AND DATE(booking.order_date) BETWEEN DATE(CURRENT_DATE - INTERVAL 2 DAY) AND CURRENT_DATE
                AND STR_TO_DATE(booking.ticketing_timelimit, '%Y-%m-%d') BETWEEN CURRENT_DATE AND ADDDATE(CURDATE(), INTERVAL 36 HOUR)
            ORDER BY booking.ticketing_timelimit ASC 
            LIMIT 50;;
        ";
		
			
        $result = $mysqli->query($query);
        echo '<table><tr><th>Order ID / PNR</th><th>Source</th><th>Order Date</th><th>Payment Status</th><th>GDS Ticketing Timelimit</th><th>Phone Number</th><th>Email</th><th>View</th></tr>';
        if ($result) {
            $processedOrders = array();
            // Assuming you want to fetch all rows and print them
            while ($row = $result->fetch_assoc()) {
                $tick_order_id = $row['order_id'];
                if (in_array($row['order_id'], $processedOrders)) {
					continue; // Skip to the next iteration if the order ID is already processed
				}
				$processedOrders[] = $row['order_id'];
			    
			    $trip_code_domestic = $row['trip_code'];
                $order_type = $row['order_type'];
                $sourcebkng = $row['source'];
			    $source= '';

                if ($order_type == 'WPT' && substr($trip_code_domestic, 8, 2) === 'SQ') {
                    $source = 'Gdeals';
                }
                if ($order_type == 'WPT' && substr($trip_code_domestic, 8, 2) === 'QF') {
                    $source = 'Gdeals';
                }
                if($order_type == 'WPT' && $sourcebkng == 'wpwebsite' ){
                    $source = 'Gdeals';
                }
                
                 if($order_type == 'gds' && $sourcebkng == 'gaurain' ){
                    $source = 'Sabre';
                }
                 if($order_type == 'gds' && $sourcebkng == 'gauraaws' ){
                    $source = 'Amadeus';
                }
                if($order_type == 'gds' && $sourcebkng == 'gaura' ){
                    $source = 'Sabre';
                }
                if($order_type == 'gds' && $sourcebkng == 'gaurandcx' ){
                    $source = 'Amadeus';
                }
                $pnr_received = $row['pnr'];
                if ($order_type == 'gds' && substr($pnr_received, 0, 3) === 'SQ_') {
                    $source = 'SQ NDC';
                }
                
                echo "<tr>
                        <td>".$row['order_id'].' / '.$row['pnr']."</td>
                        <td>".$source."</td>
                        <td>".$row['order_date']."</td>
                        <td>".$row['payment_status']."</td>
                        <td>".$row['ticketing_timelimit']."</td>
                        <td>".$row['phone_pax']."</td>
                        <td>".$row['email_pax']."</td>
                        <td><a href='?option=search&type=reference&id=".$tick_order_id."' target='_blank'>View</a></td>
                    </tr>";
            }
        }
        echo '</table>';
    }
    
    if(isset($_GET['option']) && $_GET['option']=='bpay-receipts')
    {
        ?>
        <script src="https://cdn.jsdelivr.net/gh/alumuko/vanilla-datetimerange-picker@latest/dist/vanilla-datetimerange-picker.js"></script>
		    	    <script>
                        window.addEventListener("load", function (event) {
                    	    var currentdate = new Date(); 
                    		var end_maxtime = currentdate.getFullYear() + "-" + (currentdate.getMonth()+1)  + "-" + currentdate.getDate();
                    		let drp = new DateRangePicker('added_date',
                            {
                                maxDate: end_maxtime,
                                timePicker: false,
                                alwaysShowCalendars: true,
                    			singleDatePicker: true,
                                autoApply: false,
                    			autoUpdateInput: false,
                                locale: {
                                    format: "YYYY-MM-DD",
                                }
                            },
                    		function (start) {
                    		    var start_fixed = start.format().slice(0,10);
                    			document.getElementById("added_date").value = start_fixed;
                            })
                        });
                    </script>
        <script type="text/javascript">
				function searchordejs() 
				{
				    var pnr_or_id = document.getElementById("searchkeyvalue").value;
				    var added_date = document.getElementById("added_date").value;
				    var payment_status = document.getElementById("payment_status").value;
				    
                    window.location='?option=bpay-receipts&id=' + pnr_or_id + '&date=' + added_date + '&status=' + payment_status ;
				}
				</script>
				<table class="table" style="width:100%; margin:auto; border:1px solid #adadad;">
				<tr>
				
                <td width='15%'>
                Order ID
				<input type='text' name='searchkeyvalue' value='<?php if(isset($_GET['id'])) { echo $_GET['id']; } ?>' id='searchkeyvalue'>
				</td>
				
				<td width='15%'>
                Added on
                <input type='text' name='added_date' value='<?php if(isset($_GET['date'])) { echo $_GET['date']; } ?>' id='added_date'>
				</td>
				
				<td width='15%'>
                Status
				<select name='payment_status' id='payment_status' style="width:100%; padding:10px;">
                			        <option value="" selected>All</option>
                			        <option value="bpay_receipt_awaiting_approval" <?php if(isset($_GET['status']) && $_GET['status'] == 'awaiting_approval') { echo 'selected'; } ?>>BPAY Received</option>
                			        <option value="bpay_receipt_approved" <?php if(isset($_GET['status']) && $_GET['status'] == 'approved') { echo 'selected'; } ?>>BPAY Paid</option>
                			        <option value="bpay_receipt_declined" <?php if(isset($_GET['status']) && $_GET['status'] == 'declined') { echo 'selected'; } ?>>BPAY Declined</option>
                			    </select>
				</td>
				<td>
				<button style='padding:10px; margin:0;font-size:11px; ' id='search_orders' onclick="searchordejs()">Search</button>
				</td>
				</tr>
				</table>
        <?php
        $order_id_check = '';
        if(isset($_GET['id']) && $_GET['id'] != '')
        {
            $order_id_check = "order_id = '".$_GET['id']."' AND ";
        }
        
        $date_check = '';
        if(isset($_GET['date']) && $_GET['date'] != '')
        {
            $date_check = "date(updated_time) = '".$_GET['date']."' AND ";
        }
        
        $status_check = "meta_value = 'bpay_receipt_awaiting_approval'";
        if(isset($_GET['status']) && $_GET['status'] != '')
        {
            $status_check = "meta_value = '".$_GET['status']."' ";
        }
        
        $query = "SELECT * FROM wpk4_backend_travel_booking_update_history where $order_id_check $date_check meta_key = 'G360Events' and $status_check order by updated_time desc LIMIT 50;";
        if($currnt_userlogn == 'sriharshans' || $currnt_userlogn == 'lee')
        {
        echo $query;
        }
        $result = $mysqli->query($query);
        echo '<table><tr><th>Order ID</th><th>Receipt</th><th>Added on</th><th>Added by</th><th>Status</th><th>Amount</th><th></th></tr>';
        if ($result) 
        {
            while ($row = $result->fetch_assoc()) 
            {
                $tick_auto_id = $row['auto_id'];
                $tick_order_id = $row['order_id'];

			    if( strpos( $row['meta_value'], 'approved' ) !== false )
			    {
			        $status = 'approved';
			    }
			    if( strpos( $row['meta_value'], 'awaiting_approval' ) !== false )
			    {
			        $status = 'pending';
			    }
			    if( strpos( $row['meta_value'], 'declined' ) !== false )
			    {
			        $status = 'declined';
			    }
			    
                echo "<tr>
                        <td>".$row['order_id']."</td>
                        <td><a target='_blank' href='https://gauratravel.com.au/wp-content/uploads/customized_function_uploads/".$row['meta_key_data']."'>
                            View Image
                        </a></td>
                        <td>".$row['updated_time']."</td>
                        <td>".$row['updated_user']."</td>
                        <td>".$status."</td>
                        <td><input type='text' id='".$tick_auto_id."_bpay_paid_amount'></td>
                        <td>";
                        if($status != 'approved')
                        {
                        ?>
                            <a href="javascript:void(0);" onClick="transferPageToBPAYReceipt('<?php echo $tick_auto_id; ?>', '<?php echo $tick_auto_id; ?>_bpay_paid_amount')">Approve</a></br>
                        <?php
                        }
                        if($status != 'declined')
                        {
                            echo "<a href='?option=bpay-receipts-status&type=declined&id=".$tick_auto_id."'>Decline</a></br>";
                        }
                        if($status != 'pending')
                        {
                            //echo "<a href='?option=bpay-receipts-status&type=awaiting_approval&id=".$tick_auto_id."'>Awaiting</a>";
                        }
                        echo "</td>
                    </tr>";
            }
        }
        echo '</table>';
        ?>
        <script>
        function transferPageToBPAYReceipt(rowid, inputId) {
            // Get the value from the input field
            var inputValue = document.getElementById(inputId).value;
            
            // Check if the value is not empty
            if (inputValue.trim() === "") {
                alert("Please enter a valid amount before approving.");
                return;
            }
    
            // Construct the URL dynamically
            var url = "?option=bpay-receipts-status&type=approved&id=" + encodeURIComponent(rowid) + "&value=" + encodeURIComponent(inputValue);
    
            // Redirect to the constructed URL
            window.location.href = url;
        }
        </script>
        <?php
    }
    if(isset($_GET['option']) && $_GET['option']=='delete-schedule-change' )
    {
        $auto_id = $_GET['id'];
        
        if(isset($_GET['id']) && $_GET['id'] != '')
        {
            $sql_update_schedule_change ="UPDATE wpk4_backend_travel_bookings
                    SET booking_note_for_agents = ''
                WHERE order_id = '$auto_id'";
            $results_update_schedule_change = $wpdb->query($sql_update_schedule_change);
            
            add_g360_event_history($auto_id, '', '', 'delete booking_note_for_agents', '' , $currnt_userlogn, $current_date_and_time);
            
            echo '<script>alert("Updated successfully");</script>';
            
        }
        echo '<script>window.location.href="?option=search&type=reference&id='.$auto_id.'";</script>';
    }
    
    if(isset($_GET['option']) && $_GET['option']=='bpay-receipts-status' && (current_user_can( 'administrator' ) || current_user_can( 'ho_operations' ) || current_user_can( 'cs_admin' ) || current_user_can( 'ticketing_admin' ) ))
    {
        $auto_id = $_GET['id'];
        $type = $_GET['type'];
        if(isset($_GET['type']) && $_GET['type'] != '')
        {
            $currenttime = date("Y-m-d H:i:s");
            
            $query_gds_checkup_booking_meta = "SELECT order_id FROM wpk4_backend_travel_booking_update_history where auto_id = '$auto_id'";
        	$result_gds_checkup_booking_meta = mysqli_query($mysqli, $query_gds_checkup_booking_meta) or die(mysqli_error($mysqli));
            $row_gds_checkup_booking_meta = mysqli_fetch_assoc($result_gds_checkup_booking_meta);
            if(mysqli_num_rows($result_gds_checkup_booking_meta) > 0 )
            { 
            $order_id = $row_gds_checkup_booking_meta['order_id'];
            if($_GET['type'] == 'approved')
            {
				
				$previous_order_date = date("Y-m-d H:i:s");
				$query_select_booking_order_date = "SELECT order_date FROM wpk4_backend_travel_bookings where order_id='$order_id'";
				$result_select_booking_order_date = mysqli_query($mysqli, $query_select_booking_order_date);
				if(mysqli_num_rows($result_select_booking_order_date) > 0)
				{
					$row_select_booking_order_date = mysqli_fetch_assoc($result_select_booking_order_date);
					$previous_order_date = $row_select_booking_order_date['order_date'];
				}
													
				$payment_refund_deadline = date('Y-m-d H:i:s', strtotime($previous_order_date . ' +96 hours'));


                $final_status = 'bpay_receipt_approved';
                
                $paidamount = $_GET['value'];
                
                $query_payment_booking = "SELECT total_amount, order_type, source, previous_order_id FROM wpk4_backend_travel_bookings where order_id = '$order_id' ";
                $result_payment_booking = mysqli_query($mysqli, $query_payment_booking);
                $row_payment_booking = mysqli_fetch_assoc($result_payment_booking);
                $total_amount = number_format((float)$row_payment_booking['total_amount'], 2, '.', '');
				
				$order_type = $row_payment_booking['order_type'];
				
				$order_source = $row_payment_booking['source'];
				$order_previous_order_id = $row_payment_booking['previous_order_id'];
                
                $query_payment_history2 = "SELECT trams_received_amount FROM wpk4_backend_travel_payment_history where order_id = '$order_id' and CAST(trams_received_amount AS DECIMAL(10,2)) = CAST($paidamount AS DECIMAL(10,2)) and payment_method = '9'";
                $result_payment_history2 = mysqli_query($mysqli, $query_payment_history2);
                if(mysqli_num_rows($result_payment_history2) == 0)
                {
					$invoice_id = '';
					$query_select_order_invoice_id = "SELECT * FROM wpk4_backend_travel_payment_invoice where order_id='$order_id' order by invoice_id desc limit 1";
					$result_select_order_invoice_id = mysqli_query($mysqli, $query_select_order_invoice_id) or die(mysqli_error($mysqli));
					if(mysqli_num_rows($result_select_order_invoice_id) > 0)
					{
						$row_select_order_invoice_id = mysqli_fetch_assoc($result_select_order_invoice_id);
						$invoice_id = $row_select_order_invoice_id['invoice_id'];
											
					}
					
                    mysqli_query($mysqli, "insert into wpk4_backend_travel_payment_history (process_date, source, order_id, profile_no, trams_received_amount, reference_no, modified_date, modified_by, pay_type, payment_method, payment_change_deadline, gaura_invoice_id, added_on, added_by) 
			        values ('$currenttime', '', '$order_id', '', '$paidamount', '$order_id', '$currenttime', '$currnt_userlogn', 'balance', '9', '$payment_refund_deadline', '$invoice_id', '$currenttime', '$currnt_userlogn')") or die(mysqli_error($mysqli));
                }
                
                $total_paid_amount = 0;
                $query_payment_history = "SELECT trams_received_amount FROM wpk4_backend_travel_payment_history where order_id = '$order_id' and pay_type IN ('deposit', 'balance', 'Balance', 'Unknown', 'deposit_adjustment', 'additional_payment')";
                $result_payment_history = mysqli_query($mysqli, $query_payment_history);
                while ($row_payment_history = mysqli_fetch_assoc($result_payment_history)) 
                {
                    $total_paid_amount += (float)$row_payment_history['trams_received_amount'];
                }
                
                $total_paid_amount = number_format((float)$total_paid_amount, 2, '.', '');
                
                if (abs($total_amount - $total_paid_amount) < 1)
                {
                    $sql_subpayment_store ="UPDATE wpk4_backend_travel_bookings
                                                            SET sub_payment_status = 'BPAY Paid'
                                                        WHERE order_id='$order_id'";
                                                    $results_subpayment_store = $wpdb->query($sql_subpayment_store);
                                                    
                    $sql_update_current_booking ="UPDATE wpk4_backend_travel_bookings
                        SET payment_status = 'paid', payment_modified = '$currenttime', payment_modified_by = 'bpay_receipt_update'
                    WHERE order_id = '$order_id'";
                    $results_update_current_booking = $wpdb->query($sql_update_current_booking);
					
					if($order_type == 'WPT') // from other status to paid
					{
							
						gdeal_name_update_ajax($order_id);	
							
						mysqli_query($mysqli,"insert into wpk4_amadeus_name_update_payment_status_log (order_id, order_type, updated_by, updated_on, is_processed_amadeus, amadeus_processed_on, page_title ) 
						values ('$order_id', '$order_type', '$currnt_userlogn', '$currenttime', 'yes', '$currenttime', 'G360 BPay Approval')") or die(mysqli_error($mysqli));
					}
                }
				
				if($order_source === 'datechange' && $order_previous_order_id != '')
    			{
    			    $sql_update_past_booking ="UPDATE wpk4_backend_travel_bookings
                        SET payment_status = 'voucher_submited', payment_modified = '$currenttime', payment_modified_by = 'Customer Portal DC - BPAY Approval'
                        WHERE order_id = '$order_previous_order_id'";
                    $results_update_past_booking = $mysqli->query($sql_update_past_booking);
                                                                                    
                    if ($results_update_past_booking > 0) 
                    {
                        mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
                        values ('$order_previous_order_id','','','payment_status','Rebooked','$currenttime','$currnt_userlogn')") or die(mysqli_error($mysqli));
                    } 
    			}
                
            }
            else if($_GET['type'] == 'declined')
            {
                $final_status = 'bpay_receipt_declined';
                
                $sql_subpayment_store ="UPDATE wpk4_backend_travel_bookings
                        SET sub_payment_status = ''
                    WHERE order_id='$order_id'";
                $results_subpayment_store = $wpdb->query($sql_subpayment_store);
                                                    
            }
            else
            {
                $final_status = 'bpay_receipt_awaiting_approval';
            }

            $sql_update_past_booking ="UPDATE wpk4_backend_travel_booking_update_history
                    SET meta_value = '$final_status'
                WHERE auto_id = '$auto_id'";
            $results_update_past_booking = $wpdb->query($sql_update_past_booking);
            
            mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history ( order_id, merging_id, pax_auto_id, meta_key, meta_value, updated_time, updated_user ) 
				values ('$order_id', '', '', 'BPAY Receipt Status', '$final_status', '$currenttime', '$currnt_userlogn')") or die(mysqli_error($mysqli));
            
            echo '<script>alert("Updated successfully");</script>';
            
            }
        }
		
		echo 'Please wait. You are being redirected.';
		if($order_type == 'WPT')
		{
			echo '<script>
			setTimeout(function(){
				window.location.href="?option=bpay-receipts";
			}, 30000);
			</script>';
		}
		else
		{
			echo '<script>window.location.href="?option=bpay-receipts";</script>';
		}
        
    }
    
	if(isset($_GET['option']) && $_GET['option']=='preview-eticket')
	{
		$order_id_api = $_GET['order'];
		$order_id = $_GET['order'];
		$paxid = $_GET['pax'];
		$product_id_api = $_GET['product'];
		$product_id_for_limit_loop_ui = $_GET['product'] ?? '';
		
		$query_pax_eticket_loop2 = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' AND product_id='$product_id_api'";
                                                                	$result_pax_eticket_loop2 = mysqli_query($mysqli, $query_pax_eticket_loop2);
                                                                	$row_pax_eticket_loop_count = mysqli_num_rows($result_pax_eticket_loop2);
                                                            		$row_pax_eticket_loop2 = mysqli_fetch_assoc($result_pax_eticket_loop2);
                                    		                        {
                                    		                            $pax_id2 = $row_pax_eticket_loop2['auto_id'];
                                    		                            $product_id_for_limit_loop2 = $row_pax_eticket_loop2['product_id'];
                                    		                            //echo $product_id_for_limit_loop2.'</br>';
                                    		                            ?>
                                    		                            <div id="email_eticketPreview_<?php echo $order_id_api; ?><?php echo $pax_id2; ?><?php echo $product_id_for_limit_loop2; ?>" >
                                                                            <?php
                                                                    		$emailsubject = "Eticket Information - ".$order_id_api;
                                                                            include(get_template_directory().'/templates/email/tpl_email_eticket_preview_gdeal.php');
                                                                            ?>
                                                                        </div>
                                    		                            <?php
                                    		                        }
	}
    if(isset($_GET['option']) && $_GET['option']=='search')
    {
		$order_id_api = '';
		$pnrs = [];
       ?>
        <div class="search_bookings">
				<script type="text/javascript">
				function searchordejs() {
				  
				  var pnr_or_id = document.getElementById("searchkeyvalue").value;
					var type = document.getElementById("typeselecter").value;
					
					
					window.location='?option=search&type=' + type + '&id=' + pnr_or_id ;
					
				}
				</script>
				<h5>View Booking</h5>
                <div style="float:right"><div class="status-box green"></div> Completed &nbsp;&nbsp;&nbsp;<div class="status-box ash"></div> Partially completed &nbsp;&nbsp;&nbsp;<div class="status-box red"></div> Incomplete</div>
                
				<table class="table" style="width:100%; margin:auto; border:1px solid #adadad;">
				<tr>
				<td width='10%'>
                	Search by
                </td>
				<td width='20%'>
                	<select style="width:100%; padding:10px;" name="typeselecter" id="typeselecter">
                	    <option <?php if(isset($_GET['type']) && $_GET['type'] == 'reference') { echo 'selected'; } ?> value='reference'>PNR/Order ID</option>
                	    <option <?php if(isset($_GET['type']) && $_GET['type'] == 'mobile') { echo 'selected'; } ?> value='mobile'>Mobile</option>
                	    <option <?php if(isset($_GET['type']) && $_GET['type'] == 'email') { echo 'selected'; } ?> value='email'>Email</option>
                	</select>
                </td>
                <td width='15%'>
				<input type='text' name='searchkeyvalue' value='<?php if(isset($_GET['id'])) { echo $_GET['id']; } ?>' id='searchkeyvalue'>
				</td>
				<td>
				<button style='padding:10px; margin:0;font-size:11px; ' id='search_orders' onclick="searchordejs()">Search</button>
				</td>
				<td width="20%">
				    <?php
				    if(isset($_GET['id'])) // get updated records from ypsilon
				    {
				        if (ctype_digit($_GET['id']) && $_GET['type'] == 'reference') 
        				{
        					$ref_type_gds_checkup = 'orderid';
            			} 
            			else if($_GET['type'] == 'mobile')
            			{
            			    $ref_type_gds_checkup = 'mobile';
            			}
            			else if($_GET['type'] == 'email')
            			{
            			    $ref_type_gds_checkup = 'email';
            			}
            			else
            			{
            				$ref_type_gds_checkup = 'pnr';
            			}
            			
        				if(isset($_GET['type']) && isset($_GET['id']) && $_GET['type'] != '' && $_GET['id'] != '') // is any values searched
        				{
            				if($ref_type_gds_checkup == 'pnr')
            				{
                				$filter_sql_gds_checkup = "wpk4_backend_travel_booking_pax.pnr like '".$_GET['id']."'";
            				}
            				else if($ref_type_gds_checkup == 'orderid')
            				{
            				    $filter_sql_gds_checkup = "wpk4_backend_travel_booking_pax.order_id='".$_GET['id']."'";
            				}
            				else if($ref_type_gds_checkup == 'email')
            				{
                				$filter_sql_gds_checkup = "wpk4_backend_travel_booking_pax.email_pax='".$_GET['id']."'";
            				}
            				else if($ref_type_gds_checkup == 'mobile')
            				{
                				$filter_sql_gds_checkup = "wpk4_backend_travel_booking_pax.phone_pax='".$_GET['id']."'";
            				}
            				else
                			{
                				$filter_sql_gds_checkup = "wpk4_backend_travel_booking_pax.auto_id='GTDummy'";
                			}
        				
            				$query_gds_checkup = "SELECT order_id, pnr, date(order_date) as oderdate FROM wpk4_backend_travel_booking_pax where $filter_sql_gds_checkup";
				            $result_gds_checkup = mysqli_query($mysqli, $query_gds_checkup) or die(mysqli_error($mysqli));
    				        $row_gds_checkup = mysqli_fetch_assoc($result_gds_checkup);
    				        if(mysqli_num_rows($result_gds_checkup) > 0 )
    				        {
        				        $order_id_for_update_gds_code = $row_gds_checkup['order_id'];
        				        $pnr_for_update_gds_code = $row_gds_checkup['pnr'];
        				        $order_date_for_update_gds_code = $row_gds_checkup['oderdate'];
        				        
        				        $query_gds_checkup_booking = "SELECT source FROM wpk4_backend_travel_bookings where order_id = '$order_id_for_update_gds_code'";
    				            $result_gds_checkup_booking = mysqli_query($mysqli, $query_gds_checkup_booking) or die(mysqli_error($mysqli));
        				        $row_gds_checkup_booking = mysqli_fetch_assoc($result_gds_checkup_booking);
        				        if(mysqli_num_rows($result_gds_checkup_booking) > 0 )
        				        {
        				            $source_for_update_gds_code = $row_gds_checkup_booking['source'];
            				        
            				        $query_gds_checkup_booking_meta = "SELECT * FROM wpk4_backend_history_of_updates where type_id = '$order_id_for_update_gds_code' AND meta_key = 'agent'";
        				            $result_gds_checkup_booking_meta = mysqli_query($mysqli, $query_gds_checkup_booking_meta) or die(mysqli_error($mysqli));
            				        $row_gds_checkup_booking_meta = mysqli_fetch_assoc($result_gds_checkup_booking_meta);
            				        //$conso_for_update_gds_code = $row_gds_checkup_booking_meta['meta_value'];
            				        if(mysqli_num_rows($result_gds_checkup_booking_meta) > 0 )
            				        { 
            				            $conso_for_update_gds_code = $row_gds_checkup_booking_meta['meta_value']; 
            				        
                				        if($ref_type_gds_checkup == 'pnr')
                        				{
                				        ?>
                				        <a target="_blank" href="/tpl_get_updated_record_from_ypsilon.php?option=connect&agent=<?php echo $conso_for_update_gds_code; ?> <?php echo $source_for_update_gds_code; ?>&pnr=<?php echo $pnr_for_update_gds_code; ?>&date=<?php echo $order_date_for_update_gds_code; ?>"><button style='padding:10px; margin:0;font-size:11px; float:right; ' id='gdsapiupdate'>Get Updated Records</button></a>
                				        <?php
                        				}
            				        }
        				        }
    				        }
        				}
				    }
				    ?>
				</td>
				</tr>
				</table>
				<?php
				if(isset($_GET['type']) && isset($_GET['id']) && $_GET['type'] != '' && $_GET['id'] != '') // is any values searched
				{
				    if ((isset($_GET['id']) && ctype_digit($_GET['id'])) && $_GET['type'] == 'reference') 
    				{
    					$ref_type = 'orderid';
        			} 
        			else if($_GET['type'] == 'mobile')
        			{
        			    $ref_type = 'mobile';
        			}
        			else if($_GET['type'] == 'email')
        			{
        			    $ref_type = 'email';
        			}
        			else
        			{
        				$ref_type = 'pnr';
        			}
        			
    				$filter_type = '';
                    if(isset($_GET['type']))
                    {
                        $filter_type = $_GET['type'];
                    }
    
    				
    				$filetr_id = '';
                    if(isset($_GET['id'])){
                        $filetr_id = $_GET['id'];
                    }
                
    				if($ref_type == 'pnr')
    				{
        				$filter_sql = "wpk4_backend_travel_booking_pax.pnr = '".$_GET['id']."' AND (wpk4_backend_travel_bookings.is_hidden is null OR wpk4_backend_travel_bookings.is_hidden = '')";
    				}
    				else if($ref_type == 'orderid')
    				{
    				    $filter_sql = "wpk4_backend_travel_booking_pax.order_id='".$_GET['id']."' AND (wpk4_backend_travel_bookings.is_hidden is null OR wpk4_backend_travel_bookings.is_hidden = '')";
    				}
    				else if($ref_type == 'email')
    				{
        				$filter_sql = "wpk4_backend_travel_booking_pax.email_pax='".$_GET['id']."' AND (wpk4_backend_travel_bookings.is_hidden is null OR wpk4_backend_travel_bookings.is_hidden = '')";
    				}
    				else if($ref_type == 'mobile')
    				{
    				    $phone_nums = substr($_GET['id'], -8);
        				//$filter_sql = "wpk4_backend_travel_booking_pax.phone_pax LIKE '%".$phone_nums."'";
        				//$filter_sql = "RIGHT(wpk4_backend_travel_booking_pax.phone_pax, 7) = '".$phone_nums."'";
        				$filter_sql = "wpk4_backend_travel_booking_pax.phone_pax_cropped = '".$phone_nums."' AND (wpk4_backend_travel_bookings.is_hidden is null OR wpk4_backend_travel_bookings.is_hidden = '')";
    				}
    				else
        			{
        				$filter_sql = "wpk4_backend_travel_bookings.auto_id='GTDummy'";
        			}
				
    				if($_GET['type'] != '' && $_GET['id'] != '')
    				{
    					$query = "SELECT * FROM wpk4_backend_travel_bookings JOIN wpk4_backend_travel_booking_pax ON  wpk4_backend_travel_bookings.order_id = wpk4_backend_travel_booking_pax.order_id AND 
    					wpk4_backend_travel_bookings.co_order_id = wpk4_backend_travel_booking_pax.co_order_id AND wpk4_backend_travel_bookings.product_id = wpk4_backend_travel_booking_pax.product_id 
    					where $filter_sql order by wpk4_backend_travel_booking_pax.order_id desc LIMIT 20";
    				}
    				else
    				{
    					$query = "SELECT * FROM wpk4_backend_travel_bookings where wpk4_backend_travel_bookings.order_id='DUMMYgt00000' order by wpk4_backend_travel_bookings.order_id desc LIMIT 20";
    				}
    				if($currnt_userlogn == 'sriharshans')
    				{
				        //echo $query;
    				}
    				$selection_query = $query;
    				
    				$result = mysqli_query($mysqli, $query) or die(mysqli_error($mysqli));
    				$row_count = mysqli_num_rows($result);
                    if($row_count > 0)
            		{
            		    $processedOrders_search = [];
            		    while($row = mysqli_fetch_assoc($result))
            		    {
                		    $order_id = $row['order_id'];
                		    $order_id_api = $row['order_id'];
                		    $co_order_id_api = $row['co_order_id'];
                		    $product_id_api = $row['product_id'];
                		    $new_product_id_api = $row['new_product_id'];
                		    $booking_source = $row['source'];
                		    
                		    $trip_code_for_order = $row['trip_code'];
                		    
                            $sql_g360selection = "SELECT * FROM wpk4_backend_travel_booking_update_history WHERE updated_time > DATE_SUB(NOW(), INTERVAL 5 MINUTE) AND updated_user = '$currnt_userlogn' AND order_id = '$order_id_api'";
                            $result_g360selection = mysqli_query($mysqli, $sql_g360selection);
                            if (mysqli_num_rows($result_g360selection) == 0) {
                                add_g360_event_history($order_id_api, $co_order_id_api, $product_id_api, 'Booking Search', "", $currnt_userlogn, $current_date_and_time);
                                
                                if(isset($_GET['nobel']) && $_GET['nobel'] == '1')
                                {
                                    add_g360_event_history($order_id_api, $co_order_id_api, $product_id_api, 'Noble Search', "", $currnt_userlogn, $current_date_and_time);
                                }
                            }
							$is_order_divided = '';
							if($co_order_id_api != '')
							{
								$is_order_divided = $co_order_id_api.$product_id_api.$new_product_id_api;
							}
							
							$combined_check_for_duplicate = $order_id.$is_order_divided;
                		        
                		    if (in_array($combined_check_for_duplicate, $processedOrders_search)) {
								continue; // Skip to the next iteration if the order ID is already processed
							}
							$processedOrders_search[] = $combined_check_for_duplicate;
							
                    		$pax_remarks=$row['remarks'];
                    		$booking_date_dmy = date('d/m/Y H:i:s', strtotime($row['order_date'])); 
							$booking_date_ymd = date('Y-m-d', strtotime($row['order_date'])); 
							$md5_key_of_order_date = md5($booking_date_ymd);
							
                            $travel_date_domestic = date('Y-m-d', strtotime($row['travel_date'])); 
                    		$trip_code_domestic = $row['trip_code'];
                    		
                    		$phone_pax = '';
                    		$query_pax_contact_selection_phone = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id' AND phone_pax != ''";
        					$result_pax_contact_selection_phone = mysqli_query($mysqli, $query_pax_contact_selection_phone);
        					$row_pax_contact_selection_phone = mysqli_fetch_assoc($result_pax_contact_selection_phone);
        					if(mysqli_num_rows($result_pax_contact_selection_phone) > 0)
        					{
                        		$phone_pax = $row_pax_contact_selection_phone['phone_pax'];
                        		if($phone_pax == '')
                        		{
                                    $query_pax_contact_from_meta = "SELECT * FROM wpk4_backend_history_of_updates where type_id='$order_id' AND meta_key = 'Billing PrivatePhone'";
                					$result_pax_contact_from_meta = mysqli_query($mysqli, $query_pax_contact_from_meta);
                					$row_pax_contact_from_meta = mysqli_fetch_assoc($result_pax_contact_from_meta);
                					if(mysqli_num_rows($result_pax_contact_from_meta) > 0)
        					        {
                					    $phone_pax = $row_pax_contact_from_meta['meta_value'];
        					        }
                        		}
        					}
                    		
                    		$email_pax = '';
                    		$query_pax_contact_selection_email = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id' AND email_pax != ''";
        					$result_pax_contact_selection_email = mysqli_query($mysqli, $query_pax_contact_selection_email);
        					$row_pax_contact_selection_email = mysqli_fetch_assoc($result_pax_contact_selection_email);
        					if(mysqli_num_rows($result_pax_contact_selection_email) > 0)
        					{
                        		$email_pax = $row_pax_contact_selection_email['email_pax'];
                        		if($email_pax == '')
                        		{
                                    $query_pax_contact_from_meta = "SELECT * FROM wpk4_backend_history_of_updates where type_id='$order_id' AND meta_key = 'Billing Email'";
                					$result_pax_contact_from_meta = mysqli_query($mysqli, $query_pax_contact_from_meta);
                					$row_pax_contact_from_meta = mysqli_fetch_assoc($result_pax_contact_from_meta);
                					if(mysqli_num_rows($result_pax_contact_from_meta) > 0)
            					    {
                				        $email_pax = $row_pax_contact_from_meta['meta_value'];
            					    }
                        		}
        					}
                    		
                    		$total_pax = $row['total_pax'];
                    		$order_type = $row['order_type'];
                    		$order_type_itinerary = $row['order_type'];
                    		
							$query_get_previous_orderid = "SELECT previous_order_id FROM wpk4_backend_travel_bookings where order_id = '$order_id_api'";
                            $result_get_previous_orderid = mysqli_query($mysqli, $query_get_previous_orderid) or die(mysqli_error($mysqli));
                            $row_get_previous_orderid = mysqli_fetch_assoc($result_get_previous_orderid);
									
                    		$dc_row_style = '';
                    		if($row_get_previous_orderid['previous_order_id'] != '')
                    		{
                    		    $dc_row_style = 'background-color:#ffd9be; padding: 15px; border-radius: 7px;';
                    		}
                    		
                    		$query_payment_status = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id' and co_order_id = '$co_order_id_api'";
        					$result_payment_status = mysqli_query($mysqli, $query_payment_status);
        					$row_payment_status = mysqli_fetch_assoc($result_payment_status);
        					
            				$payment_status = $row_payment_status['payment_status'];
    				        if($row_payment_status['payment_status'] == 'pending')
    						{
    							$txt_payment_status = 'Pending';
    						}
    						else if($row_payment_status['payment_status'] == 'partially_paid')
    						{
    							$txt_payment_status = 'Partially Paid';
    						}
    						else if($row_payment_status['payment_status'] == 'paid' || $row_payment_status['payment_status'] == 'Paid')
    						{
    							$txt_payment_status = 'Paid';
    						}
    						else if($row_payment_status['payment_status'] == 'canceled')
    						{
    							$txt_payment_status = 'Xxln With Deposit';
    						}
    						else if($row_payment_status['payment_status'] == 'N/A')
    						{
    							$txt_payment_status = 'Failed';
    						}
    						else if($row_payment_status['payment_status'] == 'refund')
    						{
    							$txt_payment_status = 'Refund Done';
    						}
    						else if($row_payment_status['payment_status'] == 'waiting_voucher')
    						{
    							$txt_payment_status = 'Refund Under Process';
    						}
    						else if($row_payment_status['payment_status'] == 'receipt_received')
    						{
    							$txt_payment_status = 'Receipt Received';
    						}
    						else if($row_payment_status['payment_status'] == 'voucher_submited')
    						{
    							$txt_payment_status = 'Rebooked';
    						}
    						else if($row_payment_status['payment_status'] == 'zero_paid')
    						{
    							$txt_payment_status = 'Zero Paid';
    						}
    						else if($row_payment_status['payment_status'] == 'fully_paid')
    						{
    							$txt_payment_status = 'Fully paid';
    						}
    						else
    						{
    							$txt_payment_status = 'Pending';
    						}
            				$order_date = $row['order_date'];
            				
            				$query_selection_meta = "SELECT * FROM wpk4_backend_history_of_meta_changes WHERE type_id ='$order_id_api' order by auto_id desc";
                            $result_selection_meta = mysqli_query($mysqli, $query_selection_meta);
                            $row_selection_meta_existingcount = mysqli_num_rows($result_selection_meta);
                            if($row_selection_meta_existingcount > 0)
                            {
                                $row_selection_meta = mysqli_fetch_assoc($result_selection_meta);
                                $gds_data_updated_on = date('d/m/Y H:i:s', strtotime($row_selection_meta['updated_on']));
                                $is_gds_updated_got_updated = '<p class="blink_me">Updated on: '.$gds_data_updated_on.'</br></p>';
                            }
                            else
                            {
                                $is_gds_updated_got_updated = '';
                            }
                            
                            $billing_email = '';
                            $query_order_billing_email = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api'";
                            $result_order_billing_email = mysqli_query($mysqli, $query_order_billing_email) or die(mysqli_error($mysqli));
                            if(mysqli_num_rows($result_order_billing_email) > 0)
                            {
                                $row_order_billing_email = mysqli_fetch_assoc($result_order_billing_email);
                                $billing_email = $row_order_billing_email['billing_email']; 
                            }
                            
                            $paymentfollowup = '';
                            $query_order_payment_followup = "SELECT updated_by FROM wpk4_backend_travel_payment_followup where order_id='$order_id_api' order by updated_on desc limit 1";
                            $result_order_payment_followup = mysqli_query($mysqli, $query_order_payment_followup) or die(mysqli_error($mysqli));
                            if(mysqli_num_rows($result_order_payment_followup) > 0)
                            {
                                $row_order_payment_followup = mysqli_fetch_assoc($result_order_payment_followup);
                                $paymentfollowup = $row_order_payment_followup['updated_by']; 
                            }
                        
            				?>
            				</br>
            				<?php
            				if($row['booking_note_for_agents'] != '')
                            {
                                ?>
                                <style>
                                @keyframes blink {
                                    0%, 100%, 40%, 60% { opacity: 1; }
                                    50% { opacity: 0; }
                                }
                                                                    
                                .lockinprice {
                                                                            margin:auto;
                                                                            width:100%;
                                                                            text-align:center;
                                                                            font-size: 24px;
                                                                            animation: blink 1s infinite !important;
                                }
                                </style>
                                <?php
                                echo '<div class="lockinprice">
                                    <span style="font-weight:600; color:red;">
                                        '.$row['booking_note_for_agents'].'
                                    </span>
                                </div></br></br>'
                                ;
                            }
                            ?>
            				<div style="display: flex; justify-content: space-between; font-size:16px; <?php echo $dc_row_style; ?>">
                				<div style="width: 32%;">
                    			    Booking Ref: <?php echo $row['order_id']; ?> <?php if($row['co_order_id'] != '') { echo ' '.$row['co_order_id']; } ?></br>
                    			    
                    			    <!--show edit button to update the agent sales id (start)-->
                    				Agent: <?php 
                                        $agent_info = $row['agent_info'];
                                        $show_edit_button = false;
                                        $invalid_agent_values = array(null, '', '-- Select one --', '0', 'No Agent', 'Noagent', 'noagents');
                                        
                                        if(in_array($agent_info, $invalid_agent_values, true)) {
                                            $show_edit_button = true;
                                            echo $agent_info; // Display the current (invalid) value
                                        } else {
                                            echo $agent_info; // Display the valid agent name
                                        }
                                    
                            		 if( current_user_can( 'administrator' ) || current_user_can( 'sales_manager' ) ) 
                            		 {
                            		  
                                        if($show_edit_button) {
                                            echo ' <button class="tablinks chatcategory" onclick="openCity(event, \'agentnameupdate_' . $order_id_api . $co_order_id_api . $product_id_api . $new_product_id_api . '\')" style="padding: 2px 5px; font-size: 12px; background-color: #ff69b4; color: white; border: none; border-radius: 3px; cursor: pointer;">Edit</button>';                                        }
                            		 }
                                    ?></br>
                                    
                                    <!--show edit button to update the agent sales id (end)-->
                    				<?php
                    				if($paymentfollowup != '')
                    				{
                    				    echo 'Followup agent: '.$paymentfollowup.'</br>';
                    				}
                    				?>
                    				Booked on: <?php echo $booking_date_dmy; ?></br>
                    				<?php
                    				if($order_type == 'gds')
                    				{
                    				    $ticketing_timelimit = get_meta_from_history_of_updates($order_id_api, 'Flight TicketingTimeLimit');
                    				    if($ticketing_timelimit != '')
                    				    {
                    				        echo 'GDS Ticketing Timelimit: '. date('d/m/Y H:i:s', strtotime($ticketing_timelimit)).'</br>';
                    				    }
                    				}
                    				?>
                    				<?php echo $is_gds_updated_got_updated; ?>
                    				Travel Type: <?php 
                    				if($row['order_type'] == 'WPT')
                    				{
                    				    if($row_count > 1)
                    				    {
                    				        echo $row['t_type'];
                    				        //echo 'return';
                    				    }
                    				    else
                    				    {
                    				        echo 'oneway';
                    				    }
                    				}
                    				else
                    				{
                    				    echo $row['t_type']; 
                    				}
                    				?></br>
                				</div>
                				<div style="width: 32%;">
                				    <?php if( $billing_email != '' && $billing_email != $email_pax ) { echo 'Billing Email: '.$billing_email.'</br>'; } ?>
                    				Email: <?php echo $email_pax; ?></br>
                    				Phone Number: <?php echo $phone_pax; ?></br>
                    				Pax: <?php echo $total_pax; ?></br>
                    				Payment Status: <?php 
                    				if($co_order_id_api == '')
                    				{
										// exclude DC and other payment statuses
                        				if($row_get_previous_orderid['previous_order_id'] == '' && ($row_payment_status['payment_status'] == 'partially_paid' || $row_payment_status['payment_status'] == 'paid' || $row_payment_status['payment_status'] == 'Paid' || $row_payment_status['payment_status'] == 'zero_paid'))
                                        {
                                            echo current_payment_status2($order_id_api).'</br>';
                                        }
                                        else
                                        {
                                            echo $txt_payment_status.'</br>';
                                        }
                    				}
                    				else
                    				{
                    				    echo $txt_payment_status.'</br>';
                    				}
                                    
                                    if($row_get_previous_orderid['previous_order_id'] != '')
                                    {
                                        echo 'DC case: Linked order ID: <a target="_blank" href="?option=search&type=reference&id='.$row_get_previous_orderid['previous_order_id'].'">'.$row_get_previous_orderid['previous_order_id'].'</a></br>';
                                    }
                    				
                    				if($row['order_type'] == 'gds')
                    				{
                        				if(substr($booking_source, 0, 9) === 'shelltech')
                        				{
                        				    echo 'Made by: Agent</br>';
                        				}
                        				else if($booking_source == 'import')
                        				{
                        				    echo 'Made by: GDS manual</br>';
                        				}
                        				else
                        				{
                        				    echo 'Made by: Customer</br>';
                        				}
                    				}
                    				if($row_payment_status['sub_payment_status'] != '' && ($row_payment_status['payment_status'] == 'partially_paid' || $row_payment_status['payment_status'] == 'zero_paid' || $row_payment_status['payment_status'] == 'canceled'))
                    				{
                    				    echo '<span style="color:red;">('.$row_payment_status['sub_payment_status'].')</span>';
                    				}
                    				?></br>
                    				
                    				<?php
                    				if($currnt_userlogn == 'sriharshans' || $currnt_userlogn == 'lee')
                                    {
                                        if($row_payment_status['payment_status'] == 'partially_paid' || $row_payment_status['payment_status'] == 'paid' || $row_payment_status['payment_status'] == 'Paid' || $row_payment_status['payment_status'] == 'zero_paid')
                                        {
                                            //echo 'New Payment Status: '.current_payment_status2($order_id_api).'</br>';
                                        }
                                    }
                    				
                    				$query_is_updated_note = "SELECT * FROM wpk4_backend_travel_booking_predeparture_check where order_id = '$order_id_api'";
                                    $result_is_updated_note = mysqli_query($mysqli, $query_is_updated_note) or die(mysqli_error($mysqli));
                                    $count_is_updated_note = mysqli_num_rows($result_is_updated_note);
                                    $row_is_updated_note = mysqli_fetch_assoc($result_is_updated_note);
                                    if($count_is_updated_note > 0)
                                    {
                    				?>
                    				    Predeparture check: by <?php echo $row_is_updated_note['updated_by']; ?> on <?php echo date('d/m/Y H:i:s', strtotime($row_is_updated_note['updated_on'])); ?>&nbsp;&nbsp;&nbsp;<a href='/manage-predeparture-checklist/?pg=checklist&order=<?php echo $order_id_api; ?>'>View</a></br>
                    				<?php
                                    }
                                    ?>
                                    <?php
                                    $outside_of_in_au_route_departure = 0;
                                    $outside_of_in_au_route_destination = 0;
                                    if($trip_code_for_order != '')
                                    {
                                        $departure_for_validation = substr($trip_code_for_order, 0, 3);
                                        $destination_for_validation = substr($trip_code_for_order, 4, 3);
                                        //echo $departure_for_validation;
                                        //echo $destination_for_validation;
                                        
                                        $query_departure_airport_check = "SELECT id FROM airport_list where airpotcode = '$departure_for_validation' AND country IN ('AU', 'IN')";
                                        $result_departure_airport_check = mysqli_query($mysqli, $query_departure_airport_check) or die(mysqli_error($mysqli));
                                        if(mysqli_num_rows($result_departure_airport_check) == 0)
                                        {
                                            $outside_of_in_au_route_departure = 1;
                                        }
                                        
                                        $query_departure_airport_check = "SELECT id FROM airport_list where airpotcode = '$destination_for_validation' AND country IN ('AU', 'IN')";
                                        $result_departure_airport_check = mysqli_query($mysqli, $query_departure_airport_check) or die(mysqli_error($mysqli));
                                        if(mysqli_num_rows($result_departure_airport_check) == 0)
                                        {
                                            $outside_of_in_au_route_destination = 1;
                                        }
                                    }
                                    if($outside_of_in_au_route_departure == 1 && $outside_of_in_au_route_destination == 1)
                                    {
                                        echo '<font color="red">Outside of AU - IN route. ('.$departure_for_validation.' - '.$destination_for_validation.')</font></br>';
                                    }
                                    ?>
                    				</br>
                    			</div>
                    			<style>
                    			    .status-box 
                    			    {
                                        display: inline-block;
                                        width: 10px;
                                        height: 10px;
                                        margin-right: 5px;
                                        border-radius: 2px;
                                    }
                                    .red { background-color: red; }
                                    .green { background-color: green; }
                                    .ash { background-color: #e7b416; }
                    			</style>
                    			<?php 
                    			{
                    			?>
                    			<div style="width: 16%;">
                    			    Eligible Payment Methods</br>
                    			    <?php
                    			    $query_payment_type_traffic_light = $wpdb->prepare(
                                        "SELECT order_date, travel_date, 
                                                DATEDIFF(travel_date, order_date) AS date_difference 
                                         FROM wpk4_backend_travel_bookings 
                                         WHERE order_id = %s",
                                        $order_id_api
                                    );
                                    $result_payment_type_traffic_light = $wpdb->get_row($query_payment_type_traffic_light);
                                    if ($result_payment_type_traffic_light) 
                                    {
                                        $date_difference = $result_payment_type_traffic_light->date_difference;
                                        if ($date_difference <= 10) 
                                        {
                                            ?>
                                            <div class="status-box green"></div> <span>Azupay PayID</span></br>
                            			    <div class="status-box green"></div> <span>Azupay Bank</span></br>
                            			    <div class="status-box red"></div> <span>BPAY</span></br>
                                            <div class="status-box red"></div> <span>SlicePay</span></br>
                                            <?php
                                        } 
                                        else 
                                        {
                                            ?>
                                            <div class="status-box green"></div> <span>Azupay PayID</span></br>
                            			    <div class="status-box green"></div> <span>Azupay Bank</span></br>
                            			    <div class="status-box green"></div> <span>BPAY</span></br>
                                            <div class="status-box green"></div> <span>SlicePay</span></br>
                                            <?php
                                        }
                                    }
                    			    ?>
                    			</div>
                    			<?php
                    			}
                    			?>
                    			<div style="width: 16%;">
                    			    <?php
                    			    $is_deposit_received = 'red';
                    			    $query_status_payment_deposit = "SELECT sum(trams_received_amount) as deposit_amount FROM wpk4_backend_travel_payment_history where order_id = '$order_id_api' and CAST(trams_received_amount AS DECIMAL(10,2)) != '0.00' ";
                                    $result_status_payment_deposit = mysqli_query($mysqli, $query_status_payment_deposit) or die(mysqli_error($mysqli));
                                    if(mysqli_num_rows($result_status_payment_deposit) > 0)
                                    {
                                        $row_status_payment_deposit = mysqli_fetch_assoc($result_status_payment_deposit);
                                        if(number_format((float)$row_status_payment_deposit['deposit_amount'], 2, '.', '') != '0.00')
                                        {
                                            $is_deposit_received = 'green';
                                        }
                                    }
                                    
                                    $is_full_amount_received = 'red';
                    			    $query_status_payment_full = "SELECT 
                                                                    b.order_id, 
                                                                    b.total_amount, 
                                                                    SUM(CAST(p.trams_received_amount AS DECIMAL(10,2))) AS deposit_amount
                                                                FROM wpk4_backend_travel_bookings b
                                                                JOIN wpk4_backend_travel_payment_history p 
                                                                    ON b.order_id = p.order_id 
                                                                WHERE b.order_id = '$order_id_api' 
                                                                AND CAST(p.trams_received_amount AS DECIMAL(10,2)) > 0
                                                                GROUP BY b.order_id, b.total_amount
                                                                HAVING b.total_amount <= deposit_amount;";
                                    $result_status_payment_full = mysqli_query($mysqli, $query_status_payment_full) or die(mysqli_error($mysqli));
                                    if(mysqli_num_rows($result_status_payment_full) > 0)
                                    {
                                        $row_status_payment_full = mysqli_fetch_assoc($result_status_payment_full);
                                        if(number_format((float)$row_status_payment_full['total_amount'], 2, '.', '') <= number_format((float)$row_status_payment_full['deposit_amount'], 2, '.', ''))
                                        {
                                            $is_full_amount_received = 'green';
                                        }
                                    }
                                    
                                    $is_name_updated = 'red';
                    			    $query_status_name_updated = "SELECT wpk4_backend_travel_booking_pax.name_updated 
                                                    FROM wpk4_backend_travel_bookings 
                                                    JOIN wpk4_backend_travel_booking_pax 
                                                    ON wpk4_backend_travel_bookings.order_id = wpk4_backend_travel_booking_pax.order_id 
                                                    AND wpk4_backend_travel_bookings.co_order_id = wpk4_backend_travel_booking_pax.co_order_id 
                                                    AND wpk4_backend_travel_bookings.product_id = wpk4_backend_travel_booking_pax.product_id 
                                                    WHERE wpk4_backend_travel_bookings.order_id='$order_id_api' 
                                                    ORDER BY wpk4_backend_travel_booking_pax.order_id DESC 
                                                    LIMIT 20;";
                                    $result_status_name_updated = mysqli_query($mysqli, $query_status_name_updated) or die(mysqli_error($mysqli));
                                    if(mysqli_num_rows($result_status_name_updated) > 0) 
                                    {
                                        $allNullOrEmpty = true;
                                        $allNotNullAndNotEmpty = true;
                                    
                                        while ($row_status_name_updated = mysqli_fetch_assoc($result_status_name_updated)) {
                                            $nameUpdated = trim($row_status_name_updated['name_updated']); // Remove spaces
                                    
                                            if (!is_null($nameUpdated) && $nameUpdated !== '') {
                                                $allNullOrEmpty = false; // At least one value is not null and not empty
                                            } else {
                                                $allNotNullAndNotEmpty = false; // At least one value is null or empty
                                            }
                                        }
                                    
                                        // Determine the color based on conditions
                                        if ($allNullOrEmpty) {
                                            $is_name_updated = 'red';  // All NULL or empty
                                        } elseif ($allNotNullAndNotEmpty) {
                                            $is_name_updated = 'green'; // All not null and not empty
                                        } else {
                                            $is_name_updated = 'ash';  // At least one not null but at least one null/empty
                                        }
                                    }
                                    
                                    $is_ticket_number_updated = 'red'; // Default to red

                                    $query_status_ticket_number = "SELECT wpk4_backend_travel_booking_pax.ticket_number 
                                                                   FROM wpk4_backend_travel_bookings 
                                                                   JOIN wpk4_backend_travel_booking_pax 
                                                                   ON wpk4_backend_travel_bookings.order_id = wpk4_backend_travel_booking_pax.order_id 
                                                                   AND wpk4_backend_travel_bookings.co_order_id = wpk4_backend_travel_booking_pax.co_order_id 
                                                                   AND wpk4_backend_travel_bookings.product_id = wpk4_backend_travel_booking_pax.product_id 
                                                                   WHERE wpk4_backend_travel_bookings.order_id='$order_id_api' 
                                                                   ORDER BY wpk4_backend_travel_booking_pax.order_id DESC 
                                                                   LIMIT 20;";
                                    
                                    $result_status_ticket_number = mysqli_query($mysqli, $query_status_ticket_number) or die(mysqli_error($mysqli));
                                    
                                    if(mysqli_num_rows($result_status_ticket_number) > 0) {
                                        $allNullOrEmpty = true;
                                        $allNotNullAndNotEmpty = true;
                                    
                                        while ($row_status_ticket_number = mysqli_fetch_assoc($result_status_ticket_number)) {
                                            $ticketNumber = trim($row_status_ticket_number['ticket_number']); // Remove spaces
                                    
                                            if (!is_null($ticketNumber) && $ticketNumber !== '') {
                                                $allNullOrEmpty = false; // At least one value is not null and not empty
                                            } else {
                                                $allNotNullAndNotEmpty = false; // At least one value is null or empty
                                            }
                                        }
                                    
                                        // Determine the color based on conditions
                                        if ($allNullOrEmpty) {
                                            $is_ticket_number_updated = 'red';  // All NULL or empty
                                        } elseif ($allNotNullAndNotEmpty) {
                                            $is_ticket_number_updated = 'green'; // All not null and not empty
                                        } else {
                                            $is_ticket_number_updated = 'ash';  // At least one not null but at least one null/empty
                                        }
                                    }
                                    
                                    $is_eticket_emailed = 'red'; // Default to red

                                    $query_status_eticket_emailed = "SELECT wpk4_backend_travel_booking_pax.eticket_emailed 
                                                                   FROM wpk4_backend_travel_bookings 
                                                                   JOIN wpk4_backend_travel_booking_pax 
                                                                   ON wpk4_backend_travel_bookings.order_id = wpk4_backend_travel_booking_pax.order_id 
                                                                   AND wpk4_backend_travel_bookings.co_order_id = wpk4_backend_travel_booking_pax.co_order_id 
                                                                   AND wpk4_backend_travel_bookings.product_id = wpk4_backend_travel_booking_pax.product_id 
                                                                   WHERE wpk4_backend_travel_bookings.order_id='$order_id_api' 
                                                                   ORDER BY wpk4_backend_travel_booking_pax.order_id DESC 
                                                                   LIMIT 20;";
                                    
                                    $result_status_eticket_emailed = mysqli_query($mysqli, $query_status_eticket_emailed) or die(mysqli_error($mysqli));
                                    
                                    if(mysqli_num_rows($result_status_eticket_emailed) > 0) {
                                        $allNullOrEmpty = true;
                                        $allNotNullAndNotEmpty = true;
                                    
                                        while ($row_status_eticket_emailed = mysqli_fetch_assoc($result_status_eticket_emailed)) {
                                            $eticketEmailed = trim($row_status_eticket_emailed['eticket_emailed']); // Remove spaces
                                    
                                            if (!is_null($eticketEmailed) && $eticketEmailed !== '') {
                                                $allNullOrEmpty = false; // At least one value is not null and not empty
                                            } else {
                                                $allNotNullAndNotEmpty = false; // At least one value is null or empty
                                            }
                                        }
                                    
                                        // Determine the color based on conditions
                                        if ($allNullOrEmpty) {
                                            $is_eticket_emailed = 'red';  // All NULL or empty
                                        } elseif ($allNotNullAndNotEmpty) {
                                            $is_eticket_emailed = 'green'; // All not null and not empty
                                        } else {
                                            $is_eticket_emailed = 'ash';  // At least one not null but at least one null/empty
                                        }
                                    }
                                    
                                    $is_travel_date_status = 'red'; // Default to red

                                    $query_status_travel_date = "SELECT travel_date 
                                                                 FROM wpk4_backend_travel_bookings 
                                                                 WHERE order_id = '$order_id_api' and payment_status = 'paid'
                                                                 order by travel_date asc LIMIT 1;"; // Fetch only one row
                                    
                                    $result_status_travel_date = mysqli_query($mysqli, $query_status_travel_date) or die(mysqli_error($mysqli));
                                    
                                    if ($row_status_travel_date = mysqli_fetch_assoc($result_status_travel_date)) {
                                        $travelDate = $row_status_travel_date['travel_date'];
                                    
                                        // Convert travel date to timestamp
                                        $travelTimestamp = strtotime($travelDate);
                                        $currentTimestamp = time(); // Current timestamp
                                    
                                        // Check if travel date is in the past
                                        if ($travelTimestamp <= $currentTimestamp) {
                                            $is_travel_date_status = 'green'; // Travel date is past (expired)
                                        } else {
                                            $is_travel_date_status = 'red'; // Travel date is in the future (upcoming)
                                        }
                                    }
                                    
                                    $is_travel_date_status_passed = 'red';
                                    $query_status_travel_date_passed = "SELECT travel_date 
                                                                 FROM wpk4_backend_travel_bookings 
                                                                 WHERE order_id = '$order_id_api' and payment_status = 'paid'
                                                                 order by travel_date desc LIMIT 1;"; // Fetch only one row
                                    $result_status_travel_date_passed = mysqli_query($mysqli, $query_status_travel_date_passed) or die(mysqli_error($mysqli));
                                    if ($row_status_travel_date_passed = mysqli_fetch_assoc($result_status_travel_date_passed)) {
                                        $travelDate_passed = $row_status_travel_date_passed['travel_date'];
                                    
                                        // Convert travel date to timestamp
                                        $travelTimestamp_passed = strtotime($travelDate_passed);
                                        $currentTimestamp_passed = time(); // Current timestamp
                                    
                                        // Check if travel date is in the past
                                        if ($travelTimestamp_passed < $currentTimestamp_passed) {
                                            $is_travel_date_status_passed = 'green'; // Travel date is past (expired)
                                        } else {
                                            $is_travel_date_status_passed = 'red'; // Travel date is in the future (upcoming)
                                        }
                                    }

                    			    ?>
                    			    <div class="status-box <?php echo $is_deposit_received; ?>"></div> <span>Deposit paid</span></br>
                    			    <div class="status-box <?php echo $is_full_amount_received; ?>"></div> <span>Fully paid</span></br>
                    			    <div class="status-box <?php echo $is_name_updated; ?>"></div> <span class="tooltip-container">Name updated <?php if($is_name_updated == 'ash') { ?><i class="fa fa-info-circle tooltip-icon" style="vertical-align: super; font-size:11px;"></i><span class="tooltip-text">partially completed / in progress</span><?php } ?></span></br>
                                    <div class="status-box <?php echo $is_ticket_number_updated; ?>"></div> <span class="tooltip-container">Ticket issued <?php if($is_ticket_number_updated == 'ash') { ?><i class="fa fa-info-circle tooltip-icon" style="vertical-align: super; font-size:11px;"></i><span class="tooltip-text">partially completed / in progress</span><?php } ?></span></br>
                    			    <div class="status-box <?php echo $is_eticket_emailed; ?>"></div> <span class="tooltip-container">Ticket emailed <?php if($is_eticket_emailed == 'ash') { ?><i class="fa fa-info-circle tooltip-icon" style="vertical-align: super; font-size:11px;"></i><span class="tooltip-text">partially completed / in progress</span><?php } ?></span></br>
                    			    <div class="status-box <?php echo $is_travel_date_status; ?>"></div> <span>Travel commenced</span></br>
                    			    <div class="status-box <?php echo $is_travel_date_status_passed; ?>"></div> <span>Travel completed</span>
                    			</div>
            				
							<?php
							$is_smart_ssr_available = 0;
							$smart_ssr_available_note = '';
							$smart_ssr_not_available_note = '';
						//if($currnt_userlogn == 'sriharshans' || $currnt_userlogn == 'lee' || $currnt_userlogn == 'kajalk')
						{
							if($order_type == 'gds')
							{
								$query_selection_meta = "SELECT meta_value FROM wpk4_backend_history_of_updates WHERE type_id ='$order_id_api' and meta_key = 'Flight CrsType'";
								$result_selection_meta = mysqli_query($mysqli, $query_selection_meta);
								$row_selection_meta_existingcount = mysqli_num_rows($result_selection_meta);
								if(mysqli_num_rows($result_selection_meta) > 0)
								{
									$row_selection_meta = mysqli_fetch_assoc($result_selection_meta);
									$meta_value_for_booking_type = $row_selection_meta['meta_value'];
									if (stripos($meta_value_for_booking_type, 'ndc') !== false)
									{
										// 'ndc' or 'NDC' found in the string (case-insensitive)
										$is_smart_ssr_available = 0;
										$smart_ssr_not_available_note = '<h6 style="color:#c59c00; text-align:center;">Smart SSR is not available for NDC Booking. Please use the manual SSR flow.</h6>';
									}
									else
									{
										if ($meta_value_for_booking_type == 'AMADEUS')
										{
											// Enable for NON NDC Booking
											$is_smart_ssr_available = 1;
										}
										else
										{
											$is_smart_ssr_available = 0;
											$smart_ssr_not_available_note = '<h6 style="color:#c59c00; text-align:center;">Smart SSR is not available for Non-Amadeus Booking. Please use the manual SSR flow.</h6>';
										}
									}
									
								}
								else
								{
									$is_smart_ssr_available = 0;
									$smart_ssr_not_available_note = '<h6 style="color:#c59c00; text-align:center;">Booking type is not matching. Please use the manual SSR flow.</h6>';
								}
							}
							else
							{
								$is_smart_ssr_available = 1;
							}
							
							if($is_smart_ssr_available == 1)
							{
								$smart_ssr_available_note = '<h6 style="color:#2a7604; text-align:center;">Smart SSR is available for this booking.</h6>';
							}
						}
							?>
							</div>
            				</br></br>
            			<style>
                            .tooltip-container {
                                position: relative;
                                display: inline-block;
                            }
                            .tooltip-icon {
                                cursor: pointer;
                                margin-left: 5px;
                            }
                            .tooltip-text {
                                visibility: hidden;
                                opacity: 0;
                                background-color: black;
                                color: #fff;
                                text-align: center;
                                padding: 5px 10px;
                                border-radius: 5px;
                                position: absolute;
                                top: -35px;
                                left: 50%;
                                transform: translateX(-50%);
                                white-space: nowrap;
                                font-size: 12px;
                                z-index: 10;
                                transition: opacity 0.3s ease-in-out, visibility 0.3s;
                            }
                        
                            .tooltip-container:hover .tooltip-text {
                                visibility: visible;
                                opacity: 1;
                            }
                        
            				.blink_me {
                                animation: blinker 2s linear infinite;
                                margin:0;
                                padding:0;
                            }
                                
                            @keyframes blinker {
                                50% {
                                    opacity: 0;
                                }
                            }
            				.search_bookings button, input[type=submit]
            				{
            				    background-color:#ffbb00;
            				    color:black;
            				}
            				.tabnavigation
            				{
            				    float:left;
            				    left:0;
            				}
                			.chatcategory
                			{
                    			padding:7px 10px; 
                    			margin:0;
                    			font-size:13px;
                			}
                			.tab .active
                			{
                			    color:#FFF!important;
                			    background-color:#000!important
                			}
                			.ssr_request_radio_button {
                			    margin-top: 10px; display: block;
                                flex-wrap: wrap;
                            }
                            .ssr_request_radio_button label.radio {
                             display:inline;
                             position:relative;
                             margin-left: 0.2em;
                             _top:0.2em;
                             }
                             
                             .radio-group {
                                    display: flex;
                                    align-items: center;
                                }
                                
                                .radio-group label {
                                    margin-right: 10px;
                                    margin-top:13px;
                                }
                                .badge.badge-primary {
                                    background-color: #149efa;
                                }
                                
                                .badge {
                                    display: inline-block;
                                    min-width: 10px;
                                    padding: 3px 7px;
                                    font-size: 12px;
                                    font-weight: 700;
                                    line-height: 1;
                                    color: #fff;
                                    text-align: center;
                                    white-space: nowrap;
                                    vertical-align: middle;
                                    background-color: #777;
                                    border-radius: 10px;
                                }


                			</style>
                			<div class="tabnavigation">
                				<div class="tab">

                    				<button class="tablinks chatcategory active" onclick="openCity(event, 'summary_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">Summary</button>
                    				<?php
                    				$query_selection_meta_2 = "SELECT * FROM wpk4_backend_history_of_meta_changes WHERE type_id ='$order_id_api' order by auto_id desc";
                                    $result_selection_meta_2 = mysqli_query($mysqli, $query_selection_meta_2);
                                    $row_selection_meta_existingcount_2 = mysqli_num_rows($result_selection_meta_2);
                                    if($row_selection_meta_existingcount_2 > 0)
                                    {
                                    ?>
                    				    <button class="tablinks chatcategory" onclick="openCity(event, 'changelog_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">GDS Change History</button>
                    				<?php
                                    }
                                    ?>
                    				<button class="tablinks chatcategory" onclick="openCity(event, 'itinerary_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">Itinerary</button>
                    				<button class="tablinks chatcategory" onclick="openCity(event, 'names_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">Pax Names</button>
                    				<button class="tablinks chatcategory" onclick="openCity(event, 'payments_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">Payments</button>
                    				
                    				<button class="tablinks chatcategory" onclick="openCity(event, 'refunds_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">Refunds</button>
                    				  
                    				<button class="tablinks chatcategory" onclick="openCity(event, 'portal_request_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">View Portal Requests</button>
                    				
                    				<button class="tablinks chatcategory" onclick="openCity(event, 'notes_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">Notes</button>
                    				
                    				<button class="tablinks chatcategory" onclick="openCity(event, 'emails_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">Emails</button>
                    				
                    			    <button class="tablinks chatcategory" onclick="openCity(event, 'history_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">G360 Search History</button>
                    			    <button class="tablinks chatcategory" onclick="openCity(event, 'change_history_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">Change History</button>
                    			    
                    			    <button class="tablinks chatcategory" onclick="openCity(event, 'attachments_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">Attachments</button>
                    			    <button class="tablinks chatcategory" onclick="openCity(event, 'attachmentlink_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">URL Attachments</button>
                    			    
                    			    <button class="tablinks chatcategory" onclick="openCity(event, 'ticketupdate_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">Ticket History</button>
                    			    
                    			    
                    			    <button class="tablinks chatcategory" onclick="openCity(event, 'escalation_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">Escalation</button>
                    			    
                    			    <?php
                                    {
                                        ?>
										<button class="tablinks chatcategory" onclick="openCity(event, 'ssr_request_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">Add SSR request - After Sales</button>
										
                                        <button class="tablinks chatcategory" onclick="openCity(event, 'internal_ssr_request_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">SSR request</button>
                                        <?php
                                    }

									if($is_smart_ssr_available == 1)
									{
										?>
										<button class="tablinks chatcategory" onclick="openCity(event, 'SSR_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>'); handleSSRClick();">Smart SSR</button>
										<?php
									}
									else
									{
										?>
										<button class="tablinks chatcategory" onclick="openCity(event, 'SSR_notavailable_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>'); handleSSRClick();">Smart SSR</button>
										<?php
									}
									
                    			    if($currnt_userlogn == 'sriharshans' || $currnt_userlogn == 'lee')
                                    {
                                    ?>
										<!--<button class="tablinks chatcategory" onclick="openCity(event, 'ssr_request_v1_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">SSR v2</button>-->
										
										
                    			        <button class="tablinks chatcategory" onclick="openCity(event, 'sms_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">SMS</button>
                    			    <?php
                                    }
                                    
                                    if( current_user_can( 'administrator' ) || current_user_can( 'ho_operations' ) || current_user_can( 'sked_admin' ) ) 
                                    {
                                    ?>
                    			        <button class="tablinks chatcategory" onclick="openCity(event, 'schedule_change_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">Schedule Change</button>
                    			    <?php
                                    }
                    			    ?>
                    			    <button class="tablinks chatcategory" onclick="openCity(event, 'payment_request_history_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">Payment Request History</button>
                    			    <?php
                    			    if( current_user_can( 'administrator' ) || current_user_can( 'ho_operations' )  || current_user_can( 'datechange_manager' ) ) 
                                    {
                                    ?>
                    			        <button class="tablinks chatcategory" onclick="openCity(event, 'ticketing_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">Manage Ticketing</button>
                    			    <?php
                                    }
                    			    ?>
                    			    <?php
                    			    //if($currnt_userlogn == 'sriharshans' || $currnt_userlogn == 'lee') 
                                    {
									$order_key = md5($order_id_api);
                                    ?>
                    			        <a href="/invoice/?order_id=<?php echo $order_id_api; ?>&key=<?php echo $order_key; ?>&pass=<?php echo $md5_key_of_order_date; ?>" target="_blank"><button class="tablinks chatcategory" >Invoice</button></a>
                    			    <?php
                                    }
                                    
                                    if($currnt_userlogn == 'sriharshans' || $currnt_userlogn == 'lee') 
                                    {
                                    ?>
                    			        <button class="tablinks chatcategory" onclick="openCity(event, 'discount_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">Discount</button>
                    			    <?php
                                    }
                    			    
                    			    if( current_user_can( 'administrator' ) || current_user_can( 'sales_manager' ) )
                    			    {
                    			    ?>
                    			    <button class="tablinks chatcategory" onclick="openCity(event, 'agentnameupdate_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">Agent Name update</button>
                    			    <?php
                        		    }
                        		    if((current_user_can( 'administrator' ) || current_user_can( 'ho_operations' ) || current_user_can( 'name_update_admin' ))) 
                    			    {
                        		    ?>
                        		    <button class="tablinks chatcategory" onclick="openCity(event, 'paxnameupdate_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>'); handlePaxNameUpdateClick();">Name Update</button>
									
									<?php
                    			    }
									?>
									<button class="tablinks chatcategory" onclick="openCity(event, 'TST_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>'); handleTSTClick();">TST</button>
									
									<?php
									
									if(1 == 2) 
                    			    {
                        		    ?>
									</br>
                        		    <form action="#" name="statusupdate" method="post" enctype="multipart/form-data" onsubmit="return confirmSubmission();">
										<input type="submit" class="tablinks chatcategory" name="name_update_to_amadeus" value="Name Update to Amadeus" style="padding:7px 10px; margin:0; font-size:13px;">
									</form>

									<script>
									function confirmSubmission() {
										return confirm("Do you want to continue with the Name Update to Amadeus?");
									}
									</script>
									<?php
                    			    }
									if (isset($_POST['name_update_to_amadeus']))
                                    {
										gdeal_name_update_ajax($order_id_api);	
															
										mysqli_query($mysqli,"insert into wpk4_amadeus_name_update_payment_status_log (order_id, order_type, updated_by, updated_on, is_processed_amadeus, amadeus_processed_on, page_title ) 
										values ('$order_id_api', 'WPT', '$currnt_userlogn', '$current_date_and_time', 'yes', '$current_date_and_time', 'G360 Manual Trigger')") or die(mysqli_error($mysqli));
										
										echo '<script>alert("Name has been updated to Amadeus");</script>';
										echo '<script>window.location.href="?option=search&type=reference&id=' . $order_id_api . '";</script>';
										
									}
                    			    ?>
									
									<button class="tablinks chatcategory" onclick="openCity(event, 'issues_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>');">Stop Ticketing Issue</button>
									
                    			</div>
                			</div>
            				</br></br>
            				<div id="tabcontent_main" style="font-size:14px;">
            				    <?php

								?>
            				    <div id="summary_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" >
                                    
                    				</br></br>
                    				<table class="table table-striped" style="width:100%; margin:auto;font-size:14px; margin-top:35px;">
                    					<thead>
                        					<tr>	
                            					<th>Order ID</th>
                            					<th style="text-align:center;">PNR</th>
                            					<th style="text-align:center;">Source</th>
                            				    <th style="text-align:center;">GDS ID</th>
                            					<th style="text-align:center;">Flight Details</th>
                            					<th style="text-align:center;">Travel Date</th>
                        				    </tr>
                    				    </thead>
            				            <tbody>
                        				<?php
										$pnrs = [];
                        				$order_id = $order_id_api;
                        				$query_summary_loop = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api' AND co_order_id='$co_order_id_api' && (order_type = 'WPT' || order_type = '') order by travel_date asc";
                        				$result_summary_loop = mysqli_query($mysqli, $query_summary_loop) or die(mysqli_error($mysqli));
                        				$total_paxs = 0;
                        				while($row_summary_loop = mysqli_fetch_assoc($result_summary_loop))
                        				{
                        					$order_id_summary = $row_summary_loop['order_id'];
                        					$product_id_summary = $row_summary_loop['product_id'];
                        					$co_order_id_summary = $row_summary_loop['co_order_id'];
                        					$pax_remarks=$row_summary_loop['remarks'];
                        
                        					$travel_date_domestic = date('Y-m-d', strtotime($row_summary_loop['travel_date'])); 
                        					$trip_code_domestic = $row_summary_loop['trip_code'];
                        					$tripcode_plus_trav_date_for_domestic_filter = $trip_code_domestic.$travel_date_domestic; //Eg: MEL-AMD-TR019-TR5742023-03-22
                        					
                        					$query_count = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_summary' && co_order_id='$co_order_id_summary' && product_id = '$product_id_summary'";
                        					$result_count = mysqli_query($mysqli, $query_count);
                        					$row_count = mysqli_num_rows($result_count);
                        				   
                        				    $query_movement = "SELECT * FROM wpk4_backend_travel_booking_movements where order_id='$order_id_summary' && product_id='$product_id_summary' && co_order_id='$co_order_id_summary' ";
                        					$result_movement = mysqli_query($mysqli, $query_movement);
                        					$row_movement_count = mysqli_num_rows($result_movement);
                        				   
                        				    $pnr_received = '';
                        					$query_count_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_summary' && co_order_id='$co_order_id_summary' && product_id='$product_id_summary'";
                        					$result_count_pax = mysqli_query($mysqli, $query_count_pax);
                        					if(mysqli_num_rows($result_count_pax) > 0)
                        					{
                            					$row_count_pax = mysqli_fetch_assoc($result_count_pax);
                            					$pnr_received = $row_count_pax['pnr'];
                        					}
                							$total_paxs++;
                							$x_id = 1;
                							?>
                							<tr>
                    							<td width='8%'><b>
                        							<?php echo $row_summary_loop['order_id']; ?> <?php if($co_order_id_summary != '') { echo ' '.$co_order_id_summary; } ?></b>
                        							</br>
        							            </td>
                    							<?php 
                    							 $order_type = $row_summary_loop['order_type'];
                    							 $source_f = $row_summary_loop['source'];
                    							 $sourcebkng = $row_summary_loop['source'];
                    							 $gds_id = '';
                    
                    							$source= '';
                    							
                    							if ($order_type == 'WPT' && substr($trip_code_domestic, 8, 2) === 'SQ') {
                                                    $source = 'Gdeals';
                                                    $gds_id = 'CCUVS32NQ';
                                                }
                                                if ($order_type == 'WPT' && substr($trip_code_domestic, 8, 2) === 'QF') {
                                                    $source = 'Gdeals';
                                                    $gds_id = 'MELA821CV';
                                                }
                    							if($order_type == 'WPT' && $sourcebkng == 'wpwebsite' ){
                    							    $source = 'Gdeals';
                    							    $gds_id = 'CCUVS32NQ';
                    							}
                    						
                    							 if($order_type == 'gds' && $sourcebkng == 'gaurain' ){
                    							    $source = 'Sabre';
                    							    $gds_id = '1BIK';
                    							}
                    							 if($order_type == 'gds' && $sourcebkng == 'gauraaws' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'MELA821CV';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'gaura' ){
                    							    $source = 'Sabre';
                    							    $gds_id = 'I5FC';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'gaurandcx' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'MELA828FN';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'gaurainn' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'CCUVS32NQ';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'shelltechb2bina' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'CCUVS32NQ';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'shelltechb2bndcxau' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'MELA828FN';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'shelltechb2b' ){
                    							    $source = 'Sabre';
                    							    $gds_id = 'I5FC';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'shelltechb2baws' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'MELA828FN';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'shelltechb2bin' ){
                    							    $source = 'SABRE';
                    							    $gds_id = '1BIK';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'shelltechb2bndcxin' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'CCUVS32NQ';
                    							}
                    							
                    							if ($order_type == 'gds' && substr($pnr_received, 0, 3) === 'SQ_') {
                                                    $source = 'SQ NDC';
                                                    $gds_id = 'I5FC';
                                                } 
												$pnr_received_2 = substr($pnr_received, 0, 6);
												
												$query_oid_status = "SELECT OID FROM wpk4_backend_stock_management_sheet where airline_code in ('SQ', 'MH') and pnr='$pnr_received_2' and OID is not null";
												$result_oid_status = mysqli_query($mysqli, $query_oid_status);
												if(mysqli_num_rows($result_oid_status) > 0)
												{
													$row_oid_status = mysqli_fetch_assoc($result_oid_status);
													$gds_id = $row_oid_status['OID'];
												}
												
												if(mysqli_num_rows($result_oid_status) > 0 && (strtotime($row_summary_loop['travel_date']) > strtotime(date("Y-m-d"))))
												{
													$pnrs[] = [
														'orderID' =>$order_id_api,
                                                        'pnr' =>$pnr_received_2,
                                                        'source' => $source,
                                                        'gds_id' =>$gds_id
                                                    ];
												}
                    							?>
                    							<td width='8%' style="text-align:center;"><?php echo $pnr_received; ?></td>
                    							<td width='8%' style="text-align:center;">	<?php echo $source ?></td>
                    							<td width='9%' style="text-align:center;"><?php echo $gds_id ?></td>
                    						
                    							<td width='10%' style="text-align:center;">
                                                	<?php echo $row_summary_loop['trip_code']; ?>
                                                </td>
                    							<td width='5%' style="text-align:center;"> <?php echo date('d/m/Y', strtotime($row_summary_loop['travel_date']));?> </td>
                    							</tr>
                    							<?php
                    							$x_id++;
                        				}
										
										$order_id = $order_id_api;
                        				$query_summary_loop = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api' AND co_order_id='$co_order_id_api' && (order_type = 'Agent') order by travel_date asc";
                        				$result_summary_loop = mysqli_query($mysqli, $query_summary_loop) or die(mysqli_error($mysqli));
                        				$total_paxs = 0;
                        				while($row_summary_loop = mysqli_fetch_assoc($result_summary_loop))
                        				{
                        					$order_id_summary = $row_summary_loop['order_id'];
                        					$product_id_summary = $row_summary_loop['product_id'];
                        					$co_order_id_summary = $row_summary_loop['co_order_id'];
                        					$pax_remarks=$row_summary_loop['remarks'];
                        
                        					$travel_date_domestic = date('Y-m-d', strtotime($row_summary_loop['travel_date'])); 
                        					$trip_code_domestic = $row_summary_loop['trip_code'];
                        					$tripcode_plus_trav_date_for_domestic_filter = $trip_code_domestic.$travel_date_domestic; //Eg: MEL-AMD-TR019-TR5742023-03-22
                        					
                        					$query_count = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_summary' && co_order_id='$co_order_id_summary' && product_id = '$product_id_summary'";
                        					$result_count = mysqli_query($mysqli, $query_count);
                        					$row_count = mysqli_num_rows($result_count);
                        				   
                        				    $query_movement = "SELECT * FROM wpk4_backend_travel_booking_movements where order_id='$order_id_summary' && product_id='$product_id_summary' && co_order_id='$co_order_id_summary' ";
                        					$result_movement = mysqli_query($mysqli, $query_movement);
                        					$row_movement_count = mysqli_num_rows($result_movement);
                        				   
                        				    $pnr_received = '';
                        					$query_count_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_summary' && co_order_id='$co_order_id_summary' && product_id='$product_id_summary'";
                        					$result_count_pax = mysqli_query($mysqli, $query_count_pax);
                        					if(mysqli_num_rows($result_count_pax) > 0)
                        					{
                            					$row_count_pax = mysqli_fetch_assoc($result_count_pax);
                            					$pnr_received = $row_count_pax['pnr'];
                        					}
                							$total_paxs++;
                							$x_id = 1;
                							?>
                							<tr>
                    							<td width='8%'><b>
                        							<?php echo $row_summary_loop['order_id']; ?> <?php if($co_order_id_summary != '') { echo ' '.$co_order_id_summary; } ?></b>
                        							</br>
        							            </td>
                    							<?php 
                    							 $order_type = $row_summary_loop['order_type'];
                    							 $source_f = $row_summary_loop['source'];
                    							 $sourcebkng = $row_summary_loop['source'];
                    							 $gds_id = '';
                    
                    							$source= '';
                    							
                    							if ($order_type == 'WPT' && substr($trip_code_domestic, 8, 2) === 'SQ') {
                                                    $source = 'Gdeals';
                                                    $gds_id = 'CCUVS32NQ';
                                                }
                                                if ($order_type == 'WPT' && substr($trip_code_domestic, 8, 2) === 'QF') {
                                                    $source = 'Gdeals';
                                                    $gds_id = 'MELA821CV';
                                                }
                    							if($order_type == 'WPT' && $sourcebkng == 'wpwebsite' ){
                    							    $source = 'Gdeals';
                    							    $gds_id = 'CCUVS32NQ';
                    							}
                    						
                    							 if($order_type == 'gds' && $sourcebkng == 'gaurain' ){
                    							    $source = 'Sabre';
                    							    $gds_id = '1BIK';
                    							}
                    							 if($order_type == 'gds' && $sourcebkng == 'gauraaws' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'MELA821CV';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'gaura' ){
                    							    $source = 'Sabre';
                    							    $gds_id = 'I5FC';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'gaurandcx' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'MELA828FN';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'gaurainn' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'CCUVS32NQ';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'shelltechb2bina' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'CCUVS32NQ';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'shelltechb2bndcxau' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'MELA828FN';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'shelltechb2b' ){
                    							    $source = 'Sabre';
                    							    $gds_id = 'I5FC';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'shelltechb2baws' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'MELA828FN';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'shelltechb2bin' ){
                    							    $source = 'SABRE';
                    							    $gds_id = '1BIK';
                    							}
                    							if($order_type == 'gds' && $sourcebkng == 'shelltechb2bndcxin' ){
                    							    $source = 'Amadeus';
                    							    $gds_id = 'CCUVS32NQ';
                    							}
                    							
                    							if ($order_type == 'gds' && substr($pnr_received, 0, 3) === 'SQ_') {
                                                    $source = 'SQ NDC';
                                                    $gds_id = 'I5FC';
                                                } 
												
												if($order_type == 'gds' && $sourcebkng == 'import' ){
                    							    $source = 'Import';
                    							    $gds_id = 'MELA821CV';
                    							}
												
												$pnr_received_2 = substr($pnr_received, 0, 6);
												
												
												$query_oid_status = "SELECT OID FROM wpk4_backend_stock_management_sheet where pnr='$pnr_received_2' and OID is not null";
												$result_oid_status = mysqli_query($mysqli, $query_oid_status);
												if(mysqli_num_rows($result_oid_status) > 0)
												{
													$row_oid_status = mysqli_fetch_assoc($result_oid_status);
													$gds_id = $row_oid_status['OID'];
												}
												if(mysqli_num_rows($result_oid_status) > 0 && (strtotime($row_summary_loop['travel_date']) > strtotime(date("Y-m-d"))))
												{
                                                $pnrs[] = [
														'orderID' =>$order_id_api,
                                                        'pnr' =>$pnr_received_2,
                                                        'source' => $source,
                                                        'gds_id' =>$gds_id
                                                    ];
												}
                    							?>
                    							<td width='8%' style="text-align:center;"><?php echo $pnr_received; ?></td>
                    							<td width='8%' style="text-align:center;">	<?php echo $source ?></td>
                    							<td width='9%' style="text-align:center;"><?php echo $gds_id ?></td>
                    						
                    							<td width='10%' style="text-align:center;">
                                                	<?php echo $row_summary_loop['trip_code']; ?>
                                                </td>
                    							<td width='5%' style="text-align:center;"> <?php echo date('d/m/Y', strtotime($row_summary_loop['travel_date']));?> </td>
                    							</tr>
                    							<?php
                    							$x_id++;
                        				}
                        				$query_summary_loop = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api' AND co_order_id='$co_order_id_api' && order_type = 'gds'";
                        				$result_summary_loop = mysqli_query($mysqli, $query_summary_loop) or die(mysqli_error($mysqli));
                        				while($row_summary_loop = mysqli_fetch_assoc($result_summary_loop))
                        				{
                        					$order_id_summary = $row_summary_loop['order_id'];
                        					$product_id_summary = $row_summary_loop['product_id'];
                        					$co_order_id_summary = $row_summary_loop['co_order_id'];
                        					$pax_remarks=$row_summary_loop['remarks'];
                        					$return_date=$row_summary_loop['return_date'];
                        					$travel_date=$row_summary_loop['travel_date'];
                        					
                        					$travel_date_domestic = date('Y-m-d', strtotime($row_summary_loop['travel_date'])); 
                            					$trip_code_domestic = $row_summary_loop['trip_code'];
                            					$tripcode_plus_trav_date_for_domestic_filter = $trip_code_domestic.$travel_date_domestic; //Eg: MEL-AMD-TR019-TR5742023-03-22
                            					
                            					$query_count = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_summary' && co_order_id='$co_order_id_summary'";
                            					$result_count = mysqli_query($mysqli, $query_count);
                            					$row_count = mysqli_num_rows($result_count);
                            				   
                            				    $query_movement = "SELECT * FROM wpk4_backend_travel_booking_movements where order_id='$order_id_summary' && product_id='$product_id_summary' && co_order_id='$co_order_id_summary' ";
                            					$result_movement = mysqli_query($mysqli, $query_movement);
                            					$row_movement_count = mysqli_num_rows($result_movement);
                            				   
                            					$query_count_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_summary' && co_order_id='$co_order_id_summary' && product_id='$product_id_summary'";
                            					$result_count_pax = mysqli_query($mysqli, $query_count_pax);
                            					$row_count_pax = mysqli_fetch_assoc($result_count_pax);
                    							$total_paxs++;
                    							$x_id = 1;
                        							 $order_type = $row_summary_loop['order_type'];
                        							 //$source = $row_summary_loop['source'];
                        							 $sourcebkng = $row_summary_loop['source'];
													 
													 if($sourcebkng == '' || $sourcebkng == 'datechange')
													{
														$query_agent_value = "SELECT * FROM wpk4_backend_history_of_updates where type_id='$order_id_api' AND meta_key = 'agent'";
                                                        $result_agent_value = mysqli_query($mysqli, $query_agent_value);
                                                        if(mysqli_num_rows($result_agent_value) > 0)
                                                        {
                                                            while($row_agent_value = mysqli_fetch_assoc($result_agent_value))
                                                            {
                                                            	$sourcebkng = $row_agent_value['meta_value'];
                                                            }
                                        			    } 
													}
													
                        							 $gds_id = '';
                                                    $source= '';
                        							$pnr_received = $row_count_pax['pnr'];
                        							
                        							if ($order_type == 'WPT' && substr($trip_code_domestic, 8, 2) === 'SQ') {
                                                        $source = 'Gdeals';
                                                        $gds_id = 'CCUVS32NQ';
                                                    }
                                                    if ($order_type == 'WPT' && substr($trip_code_domestic, 8, 2) === 'QF') {
                                                        $source = 'Gdeals';
                                                        $gds_id = 'MELA821CV';
                                                    }
                        							if($order_type == 'WPT' && $sourcebkng == 'wpwebsite' ){
                        							    $source = 'Gdeals';
                        							    $gds_id = 'CCUVS32NQ';
                        							}
                        						
                        							 if($order_type == 'gds' && $sourcebkng == 'gaurain' ){
                        							    $source = 'Sabre';
                        							    $gds_id = '1BIK';
                        							}
                        							 if($order_type == 'gds' && $sourcebkng == 'gauraaws' ){
                        							    $source = 'Amadeus';
                        							    $gds_id = 'MELA821CV';
                        							}
                        							 if($order_type == 'gds' && $sourcebkng == 'gaura' ){
                        							    $source = 'Sabre';
                        							    $gds_id = 'I5FC';
                        							}
                        							if($order_type == 'gds' && $sourcebkng == 'gaurandcx' ){
                        							    $source = 'Amadeus';
                        							    $gds_id = 'MELA828FN';
                        							}
                        							if($order_type == 'gds' && $sourcebkng == 'gaurainn' ){
                        							    $source = 'Amadeus';
                        							    $gds_id = 'CCUVS32NQ';
                        							}
                        							if($order_type == 'gds' && $sourcebkng == 'shelltechb2bina' ){
                        							    $source = 'Amadeus';
                        							    $gds_id = 'CCUVS32NQ';
                        							}
                        							if($order_type == 'gds' && $sourcebkng == 'shelltechb2bndcxau' ){
                        							    $source = 'Amadeus';
                        							    $gds_id = 'MELA828FN';
                        							}
                        							if($order_type == 'gds' && $sourcebkng == 'shelltechb2b' ){
                        							    $source = 'Sabre';
                        							    $gds_id = 'I5FC';
                        							}
                        							if($order_type == 'gds' && $sourcebkng == 'shelltechb2baws' ){
                        							    $source = 'Amadeus';
                        							    $gds_id = 'MELA828FN';
                        							}
                        							if($order_type == 'gds' && $sourcebkng == 'shelltechb2bin' ){
                        							    $source = 'SABRE';
                        							    $gds_id = '1BIK';
                        							}
                        							if($order_type == 'gds' && $sourcebkng == 'shelltechb2bndcxin' ){
                        							    $source = 'Amadeus';
                        							    $gds_id = 'CCUVS32NQ';
                        							}
                    							
                        							if ($order_type == 'gds' && substr($pnr_received, 0, 3) === 'SQ_') {
                                                        $source = 'SQ NDC';
                                                        $gds_id = 'I5FC';
                                                    } 
													
													if($order_type == 'gds' && $sourcebkng == 'import' ){
                    							    $source = 'Import';
                    							    $gds_id = 'MELA821CV';
                    							}
													
													$pnr_received_2 = substr($pnr_received, 0, 6);
													if((strtotime($row_summary_loop['travel_date']) > strtotime(date("Y-m-d"))))
													{														
                                                    $pnrs[] = [
														'orderID' =>$order_id_api,
                                                        'pnr' =>$pnr_received_2,
                                                        'source' => $source,
                                                        'gds_id' =>$gds_id
                                                    ];
													}
                                            if($return_date == $travel_date)
                        					{
                    							?>
                    							<tr>
                        							<td width='8%'><b>
                            							<?php echo $row_summary_loop['order_id']; ?> <?php if($co_order_id_summary != '') { echo ' '.$co_order_id_summary; } ?></b>
                            							</br>
            							            </td>
                        							<td width='8%' style="text-align:center;"><?php echo $row_count_pax['pnr']; ?></td>
                        							<td width='8%' style="text-align:center;">	<?php echo $source ?></td>
                        							<td width='9%' style="text-align:center;"><?php echo $gds_id ?></td>
                        						
                        							<td width='10%' style="text-align:center;">
                                                    	<?php echo substr($row_summary_loop['trip_code'], 0, 7); ?>
                                                    </td>
                        							<td width='5%' style="text-align:center;"> <?php echo date('d-m-Y', strtotime($row_summary_loop['travel_date']));?> </td>
                        						</tr>
                        						<?php
                        					}
                        					else
                        					{
                        					    ?>
                        					    <tr>
                        							<td width='8%'><b>
                            							<?php echo $row_summary_loop['order_id']; ?> <?php if($co_order_id_summary != '') { echo ' '.$co_order_id_summary; } ?></b>
                            							</br>
            							            </td>
                        							<td width='8%' style="text-align:center;"><?php echo $row_count_pax['pnr']; ?></td>
                        							<td width='8%' style="text-align:center;">	<?php echo $source ?></td>
                        							<td width='9%' style="text-align:center;"><?php echo $gds_id ?></td>
                        						
                        							<td width='10%' style="text-align:center;">
                                                    	<?php echo substr($row_summary_loop['trip_code'], 0, 7); ?>
                                                    </td>
                        							<td width='5%' style="text-align:center;"> <?php echo date('d-m-Y', strtotime($row_summary_loop['travel_date']));?> </td>
                        						</tr>
												<?php
												if($row['t_type'] != 'oneway')
												{
												?>
                    							<tr>
                        							<td width='8%'><b>
                            							<?php echo $row_summary_loop['order_id']; ?> <?php if($co_order_id_summary != '') { echo ' '.$co_order_id_summary; } ?></b>
                            							</br>
            							            </td>
                        							<td width='8%' style="text-align:center;"><?php echo $row_count_pax['pnr']; ?></td>
                        							<td width='8%' style="text-align:center;">	<?php echo $source ?></td>
                        							<td width='9%' style="text-align:center;"><?php echo $gds_id ?></td>
                        						
                        							<td width='10%' style="text-align:center;">
                                                    <?php
                                                    $parts_trip = explode("-", $row_summary_loop['trip_code']);
													if(strlen($row_summary_loop['trip_code']) < 11)
													{
														if (count($parts_trip) >= 2) {
															$origin_place = $parts_trip[0];
															$destination_place = $parts_trip[1];
														
															echo $destination_place . ' - ' .$origin_place;
														}
														else
														{
															echo $row_summary_loop['trip_code'];
														}
													}
													else
													{
														echo substr($row_summary_loop['trip_code'], 8, 7);
													}
                                                    ?>
                                                    </td>
                        							<td width='5%' style="text-align:center;"> <?php echo date('d-m-Y', strtotime($row_summary_loop['return_date']));?> </td>
                        						</tr>
                        						<?php
												}
                        					}
                        					$x_id++;
                        				}
                        				?>
                    				    </tbody>
                    				</table>
                				</div>
								<?php
								foreach ($pnrs as &$record) {
									$orderID = intval($record['orderID']);
									$pnr_selection = $mysqli->real_escape_string($record['pnr']);

									$querypnrs = "
										SELECT auto_id, salutation, fname, lname, dob
										FROM wpk4_backend_travel_booking_pax
										WHERE order_id = $orderID AND pnr = '$pnr_selection'
									";

									$resultpnrs = $mysqli->query($querypnrs);
									$record['pax'] = [];

									if ($resultpnrs && $resultpnrs->num_rows > 0) {
										while ($rowpnrs = $resultpnrs->fetch_assoc()) {
											$record['pax'][] = [
												'auto_id' => $rowpnrs['auto_id'],
												'salutation'   => $rowpnrs['salutation'],
												'fname'   => $rowpnrs['fname'],
												'lname'   => $rowpnrs['lname'],
												'dob'     => $rowpnrs['dob'],
											];
										}
									}
								}
								?>
                				<div id="names_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                    				<button class="tablinks chatcategory" onclick="openCity(event, 'fullnames_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">View detailed info</button></br></br>
                    				
                        				    <?php
                        				    $order_id = $order_id_api;
                        				    if($order_type_itinerary == 'WPT' || $order_type_itinerary == '' || $order_type_itinerary == 'Agent')
        				                    {
                            				    $total_paxs = 0;
                            				    $query_summary_loop = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api' AND co_order_id='$co_order_id_api'";
                            				    $result_loop = mysqli_query($mysqli, $query_summary_loop) or die(mysqli_error($mysqli));
                                			    while($row_loop = mysqli_fetch_assoc($result_loop))
                            				    {
                            				        $order_id_pax_view = $row_loop['order_id'];
                            				        $co_order_id_pax_view = $row_loop['co_order_id'];
                            				        $product_id_pax_view = $row_loop['product_id'];
													$travel_date_pax_view = date('Y-m-d', strtotime($row_loop['travel_date']));
                            				        echo $row_loop['product_title']. ' | ' .$row_loop['trip_code'];
                            				        ?>
                            				        <table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
                                					<thead>
                                    					<tr>
                                        					<th width='4%'>PNR</th>
                                        					<th width='8%'>Ticket</th>
                                        					<th width='3%'>Salutation</th>
															<th width='8%'>First Name</th>
															<th width='8%'>Last Name</th>
                                        					<th width='5%'>DOB</th>
                                        					<th>PPN</th>
                                        					<th>PPE</th>
                                        					<th width='8%'>Meal</th>
                                        					<th width='5%'>Wheelchair</th>
                                        					<th width='6%'>Baggage</th>
                                        					<th width='6%'>e-ticket</br>emailed</th>
                                        					<th width='6%'>Invoice</br>Raised</th>
                                        					<th width='5%'>Remarks</th>
                                        					<th width='5%'>Fare</th>
															<th width='8%'>Fare Remark</th>
                                    				    </tr>
                                				    </thead>
                                				    <tbody>
                            				        <?php
                            				        $query_summary_loop_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_pax_view' && co_order_id = '$co_order_id_pax_view' && product_id = '$product_id_pax_view'";
                                				    $result_loop_pax = mysqli_query($mysqli, $query_summary_loop_pax) or die(mysqli_error($mysqli));
                                				    $total_amount_from_pax = 0;
                                    			    while($row_loop_pax = mysqli_fetch_assoc($result_loop_pax))
                                    			    {
                                                        $total_paxs++;
                                						?>
                                						<tr>
															<td><?php echo $row_loop_pax['pnr']; ?></td>
															<td><?php echo $row_loop_pax['ticket_number']; 
															
															if($row_loop_pax['ticket_number'] == '' && $row_loop_pax['ticketed_by'] != '')
															{
																echo '</br></br>Ticket issued by '.$row_loop_pax['ticketed_by'];
															}
															
															?></td>
															
															<td><?php echo $row_loop_pax['salutation']; ?></td>
															<td><?php echo $row_loop_pax['fname']; ?></td>
															<td><?php echo $row_loop_pax['lname']; ?></td>
															
															<td><?php echo $row_loop_pax['dob']; ?></td>
															<td><?php echo $row_loop_pax['ppn']; ?></td>
															<td><?php echo $row_loop_pax['ppe']; ?></td>
															<td><?php echo $row_loop_pax['meal']; ?></td>
															<td><?php echo $row_loop_pax['wheelchair']; ?></td>
															<td><?php echo $row_loop_pax['baggage']; ?></td>
															<td><?php echo $row_loop_pax['eticket_emailed']; ?></td>
															<td><?php echo $row_loop_pax['invoice_raised']; ?></td>
															<td><?php echo $row_loop_pax['remarks']; ?></td>
															<td><?php
																
																$wptravel_price_information_ordered = get_post_meta( $order_id_pax_view, 'order_items_data', true ); // get order product info for trip extras
																if (is_array($wptravel_price_information_ordered)) {

																	foreach ($wptravel_price_information_ordered as $key => $item) {
																		
																		$key_parts = explode('_', $key);
																		$trip_id_from_key = $key_parts[0]; // Assuming the trip ID is the first part before an underscore
			  
																		// Assuming $item['trip'] is where the pricing information is stored, similar to your serialized data structure
																		if ($trip_id_from_key == $product_id_pax_view && isset($item['trip'])) {
																			foreach ($item['trip'] as $tripKey => $tripValue) {
																				if (isset($tripValue['price'])) {
																					echo $tripValue['price']; // This prints out the price.
																					$total_amount_from_pax += (float)$tripValue['price'];
																					break; // Assuming you only need one price, break out of the loop once found.
																				}
																			}
																		} else {
																		}
																	}
																}
																?>
															</td>
															<td><?php echo $row_loop_pax['fare_remark']; ?>
															<?php
															$query_loss_pax = "SELECT * FROM wpk4_backend_ticket_issue_with_loss where product_id='$product_id_pax_view' AND date(travel_date) = '$travel_date_pax_view'";
															$result_loss_pax = mysqli_query($mysqli, $query_loss_pax) or die(mysqli_error($mysqli));
															if(mysqli_num_rows($result_loss_pax) > 0)
															{
																$row_loss_pax = mysqli_fetch_assoc($result_loss_pax);
																if($row_loop_pax['fare_remark'] != '' )
																{
																	echo '</br>';
																}
																echo $row_loss_pax['remark'];
															}
															?>
															</td>
                                						</tr>
                                						<?php
                                    			    }
                                    			    ?>
                                    			    <tr>
                                    			        <td colspan="14"></td>
                                    			        <td><?php echo number_format((float)$total_amount_from_pax, 2, '.', ''); ?></td>
														<td></td>
                                    			    </tr>
                                    			    </tbody>
                    				                </table></br></br>
                                    			    <?php
                            				    }
        				                    }
        				                    else
        				                    {
        				                        $total_paxs = 0;
                            				    $query_summary_loop = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api' AND co_order_id='$co_order_id_api'";
                            				    $result_loop = mysqli_query($mysqli, $query_summary_loop) or die(mysqli_error($mysqli));
                                			    while($row_loop = mysqli_fetch_assoc($result_loop))
                            				    {
                            				        $destination_place = '';
                            				        $order_id_pax_view = $row_loop['order_id'];
                            				        $travel_date = $row_loop['travel_date'];
			                                        $return_date = $row_loop['return_date'];
                            				        $co_order_id_pax_view = $row_loop['co_order_id'];
                            				        $product_id_pax_view = $row_loop['product_id'];
                            				        if($return_date != $travel_date) // return trip block
			                                        {
			                                            $origin_place = '';
			                                            $parts_trip = explode("-", $row_loop['trip_code']);
                                				        if (count($parts_trip) >= 2) {
                                                            $origin_place = $parts_trip[0];
                                                            $destination_place = $parts_trip[1];
                                                                echo '<tr><th colspan="6">'. $origin_place . ' - ' . $destination_place . ' - ' . $travel_date .'</th></tr>';
                                                        }
                                				        ?>
                                				        <table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
                                    					<thead>
                                        					<tr>
																<th width='4%'>PNR</th>
																<th width='8%'>Ticket</th>
																<th width='3%'>Salutation</th>
																<th width='8%'>First Name</th>
																<th width='8%'>Last Name</th>
																<th width='5%'>DOB</th>
																<th>PPN</th>
																<th>PPE</th>
																<th width='8%'>Meal</th>
																<th width='5%'>Wheelchair</th>
																<th width='6%'>Baggage</th>
																<th width='6%'>e-ticket</br>emailed</th>
																<th width='6%'>Invoice</br>Raised</th>
																<th width='5%'>Remarks</th>
                                        				    </tr>
                                    				    </thead>
                                    				    <tbody>
                                				        <?php
                                				        $query_summary_loop_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_pax_view' && co_order_id = '$co_order_id_pax_view' && product_id = '$product_id_pax_view'";
                                    				    $result_loop_pax = mysqli_query($mysqli, $query_summary_loop_pax) or die(mysqli_error($mysqli));
                                        			    while($row_loop_pax = mysqli_fetch_assoc($result_loop_pax))
                                        			    {
                                        			        $baggage_match_checker = $row_loop_pax['gds_pax_id'] . ' - ' . $origin_place . ' - Baggage';
                                        			        $baggage_value = $row_loop_pax['baggage'];
                                        			        $query_baggage_value = "SELECT * FROM wpk4_backend_history_of_updates where type_id='$order_id_api' AND meta_key = '$baggage_match_checker'";
                                                        	$result_baggage_value = mysqli_query($mysqli, $query_baggage_value);
                                                        	if(mysqli_num_rows($result_baggage_value) > 0)
                                                        	{
                                                            	while($row_baggage_value = mysqli_fetch_assoc($result_baggage_value))
                                                            	{
                                                            	    $baggage_value = $row_baggage_value['meta_value'];
                                                            	}
                                        			        } 
                                                            $total_paxs++;
                                    						?>
                                    						<tr>
                                    						<td><?php echo $row_loop_pax['pnr']; ?></td>
                                    						<td><?php echo $row_loop_pax['ticket_number']; ?></td>
                                    						<td><?php echo $row_loop_pax['salutation']; ?></td>
															<td><?php echo $row_loop_pax['fname']; ?></td>
															<td><?php echo $row_loop_pax['lname']; ?></td>
                                    						<td><?php echo $row_loop_pax['dob']; ?></td>
                                    						<td><?php echo $row_loop_pax['ppn']; ?></td>
                                    						<td><?php echo $row_loop_pax['ppe']; ?></td>
                                    						<td><?php echo $row_loop_pax['meal']; ?></td>
                                    						<td><?php echo $row_loop_pax['wheelchair']; ?></td>
                                    						<td><?php echo $baggage_value; ?></td>
                                    						<td><?php echo $row_loop_pax['eticket_emailed']; ?></td>
                                    						<td><?php echo $row_loop_pax['invoice_raised']; ?></td>
                                    						<td><?php echo $row_loop_pax['remarks']; ?></td>
                                    						</tr>
                                    						<?php
                                        			    }
                                        			    ?>
                                        			    </tbody>
                        				                </table></br></br>
                        				                <?php
                        				                $parts_trip = explode("-", $row_loop['trip_code']);
                                				        if (count($parts_trip) >= 2) {
                                                            $origin_place = $parts_trip[0];
                                                            $destination_place = $parts_trip[1];
                                                                echo '<tr><th colspan="6">'. $destination_place . ' - ' . $origin_place . ' - ' . $return_date .'</th></tr>';
                                                        }
                                				        ?>
                                				        <table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
                                    					<thead>
                                        					<tr>
                                            					<th width='4%'>PNR</th>
																<th width='8%'>Ticket</th>
																<th width='3%'>Salutation</th>
																<th width='8%'>First Name</th>
																<th width='8%'>Last Name</th>
																<th width='5%'>DOB</th>
																<th>PPN</th>
																<th>PPE</th>
																<th width='8%'>Meal</th>
																<th width='5%'>Wheelchair</th>
																<th width='6%'>Baggage</th>
																<th width='6%'>e-ticket</br>emailed</th>
																<th width='6%'>Invoice</br>Raised</th>
																<th width='5%'>Remarks</th>
                                        				    </tr>
                                    				    </thead>
                                    				    <tbody>
                                				        <?php
                                				        $query_summary_loop_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_pax_view' && co_order_id = '$co_order_id_pax_view' && product_id = '$product_id_pax_view'";
                                    				    $result_loop_pax = mysqli_query($mysqli, $query_summary_loop_pax) or die(mysqli_error($mysqli));
                                        			    while($row_loop_pax = mysqli_fetch_assoc($result_loop_pax))
                                        			    {
                                        			        $baggage_match_checker = $row_loop_pax['gds_pax_id'] . ' - ' . $destination_place . ' - Baggage';
                                        			        $baggage_value = $row_loop_pax['baggage'];
                                        			        $query_baggage_value = "SELECT * FROM wpk4_backend_history_of_updates where type_id='$order_id_api' AND meta_key = '$baggage_match_checker'";
                                                        	$result_baggage_value = mysqli_query($mysqli, $query_baggage_value);
                                                        	if(mysqli_num_rows($result_baggage_value) > 0)
                                                        	{
                                                            	while($row_baggage_value = mysqli_fetch_assoc($result_baggage_value))
                                                            	{
                                                            	    $baggage_value = $row_baggage_value['meta_value'];
                                                            	}
                                        			        } 
                                                            $total_paxs++;
                                    						?>
                                    						<tr>
                                    						<td><?php echo $row_loop_pax['pnr']; ?></td>
                                    						<td><?php echo $row_loop_pax['ticket_number']; ?></td>
                                    						<td><?php echo $row_loop_pax['salutation']; ?></td>
															<td><?php echo $row_loop_pax['fname']; ?></td>
															<td><?php echo $row_loop_pax['lname']; ?></td>
                                    						<td><?php echo $row_loop_pax['dob']; ?></td>
                                    						<td><?php echo $row_loop_pax['ppn']; ?></td>
                                    						<td><?php echo $row_loop_pax['ppe']; ?></td>
                                    						<td><?php echo $row_loop_pax['meal']; ?></td>
                                    						<td><?php echo $row_loop_pax['wheelchair']; ?></td>
                                    						<td><?php echo $baggage_value; ?></td>
                                    						<td><?php echo $row_loop_pax['eticket_emailed']; ?></td>
                                    						<td><?php echo $row_loop_pax['invoice_raised']; ?></td>
                                    						<td><?php echo $row_loop_pax['remarks']; ?></td>
                                    						</tr>
                                    						<?php
                                        			    }
                                        			    ?>
                                        			    </tbody>
                        				                </table></br></br>
                                        			    <?php
			                                        }
			                                        else
			                                        {
			                                            $origin_place = '';
			                                            $parts_trip = explode("-", $row_loop['trip_code']);
                                				        if (count($parts_trip) >= 2) {
                                                            $origin_place = $parts_trip[0];
                                                            $destination_place = $parts_trip[1];
                                                                echo '<tr><th colspan="6">'. $origin_place . ' - ' . $destination_place . ' - ' . $travel_date .'</th></tr>';
                                                        }
			                                            ?>
			                                            <table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
                                    					<thead>
                                        					<tr>
                                            					<th width='4%'>PNR</th>
																<th width='8%'>Ticket</th>
																<th width='3%'>Salutation</th>
																<th width='8%'>First Name</th>
																<th width='8%'>Last Name</th>
																<th width='5%'>DOB</th>
																<th>PPN</th>
																<th>PPE</th>
																<th width='8%'>Meal</th>
																<th width='5%'>Wheelchair</th>
																<th width='6%'>Baggage</th>
																<th width='6%'>e-ticket</br>emailed</th>
																<th width='6%'>Invoice</br>Raised</th>
																<th width='5%'>Remarks</th>
                                        				    </tr>
                                    				    </thead>
                                    				    <tbody>
                                				        <?php
                                				        $query_summary_loop_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_pax_view' && co_order_id = '$co_order_id_pax_view' && product_id = '$product_id_pax_view'";
                                    				    $result_loop_pax = mysqli_query($mysqli, $query_summary_loop_pax) or die(mysqli_error($mysqli));
                                        			    while($row_loop_pax = mysqli_fetch_assoc($result_loop_pax))
                                        			    {
                                        			        $baggage_match_checker = $row_loop_pax['gds_pax_id'] . ' - ' . $origin_place . ' - Baggage';
                                        			        $baggage_value = $row_loop_pax['baggage'];
                                        			        $query_baggage_value = "SELECT * FROM wpk4_backend_history_of_updates where type_id='$order_id_api' AND meta_key = '$baggage_match_checker'";
                                                        	$result_baggage_value = mysqli_query($mysqli, $query_baggage_value);
                                                        	if(mysqli_num_rows($result_baggage_value) > 0)
                                                        	{
                                                            	while($row_baggage_value = mysqli_fetch_assoc($result_baggage_value))
                                                            	{
                                                            	    $baggage_value = $row_baggage_value['meta_value'];
                                                            	}
                                        			        } 
                                                            $total_paxs++;
                                    						?>
                                    						<tr>
                                    						<td width='8%'><?php echo $row_loop_pax['pnr']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['ticket_number']; ?></td>
                                    						<td width='3%'><?php echo $row_loop_pax['salutation']; ?></td>
															<td width='8%'><?php echo $row_loop_pax['fname']; ?></td>
															<td width='8%'><?php echo $row_loop_pax['lname']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['dob']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['ppn']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['ppe']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['meal']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['wheelchair']; ?></td>
                                    						<td width='8%'><?php echo $baggage_value; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['eticket_emailed']; ?></td>
                                    						<td width='8%'><?php echo $row_loop_pax['invoice_raised']; ?></td>
                                    						<td width='5%'><?php echo $row_loop_pax['remarks']; ?></td>
                                    						</tr>
                                    						<?php
                                        			    }
                                        			    ?>
                                        			    </tbody>
                        				                </table></br></br>
			                                            <?php
			                                        }
                            				    }
        				                    }
                        				    ?>
    				            </div>

    				            <div id="ticketupdate_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                        				    <?php
                        				    $order_id = $order_id_api;
        				                        ?>
        				                        <table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
                                					<thead>
                                    					<tr>
                                    					    <th>Name</th>
                                        					<th>PNR</th>
                                        					<th>Document</th>
                                        					<th>Document Type</th>
                                        					<th>Reason</th>
                                        					<th>Previous Ticket Number</th>
                                        					<th>Transaction Amount</th>
                                        					<th>Vendor</th>
                                        					<th>Issue Date</th>
                                    				    </tr>
                                				    </thead>
                                				    <tbody>
            				                        <?php
                                				    $total_paxs = 0;
                                				    $query_summary_loop = "SELECT ticket.*, pax.salutation, pax.fname, pax.lname FROM wpk4_backend_travel_booking_ticket_number ticket
                                				                join wpk4_backend_travel_booking_pax pax on pax.auto_id = ticket.pax_id
                                				    where ticket.order_id='$order_id_api'";
                                				    $result_loop = mysqli_query($mysqli, $query_summary_loop) or die(mysqli_error($mysqli));
                                    			    while($row_loop = mysqli_fetch_assoc($result_loop))
                                				    {
                                				        $pax_id = $row_loop['pax_id'];
                                				        $pnr = $row_loop['pnr'];
                                				        $document = $row_loop['document'];
                                				        $document_type = $row_loop['document_type'];
                                				        $reason = $row_loop['reason'];
                                				        $previous_ticket_number = $row_loop['previous_ticket_number'];
                                				        $transaction_amount = $row_loop['transaction_amount'];
                                				        $vendor = $row_loop['vendor'];
                                				        $issue_date = $row_loop['issue_date'];
                                				        ?>
                                						<tr>
                                						    <td width='8%'><?php echo $row_loop['salutation']; ?> <?php echo $row_loop['fname']; ?> <?php echo $row_loop['lname']; ?></td>
                                    						<td width='8%'><?php echo $pnr; ?></td>
                                    						<td width='8%'><?php echo $document; ?></td>
                                    						<td width='11%'><?php echo $document_type; ?></td>
                                    						<td width='8%'><?php echo $reason; ?></td>
                                    						<td width='8%'><?php echo $previous_ticket_number; ?></td>
                                    						<td width='8%'><?php echo $transaction_amount; ?></td>
                                    						<td width='8%'><?php echo $vendor; ?></td>
                                    						<td width='8%'><?php echo $issue_date; ?></td>
                                						</tr>
                                						<?php
                                    			    }
                                    			    ?>
                                    			    </tbody>
                    				                </table></br></br>
    				            </div>
    				            
    				            <div id="amount_adjustment_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                				    <?php
                				    $order_id = $order_id_api;
									if($currnt_userlogn == 'joyce' || $currnt_userlogn == 'lee' )
                                    {
										$total_amount_editor = '';
									}
									else
									{
										$total_amount_editor = 'readonly';
									}
                                    ?>
                                    <form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                        <tr>
                                            <td>Current Order ID *</td>
                                            <td>
											<input type="text" name="new_order_id" value="<?php echo $order_id; ?>" required></td>
                                        </tr>
                                        </br>
                                        <tr>
                                            <td>Previous Order ID *</td>
                                            <td><input type="text" name="old_order_id" id="old_order_id" required></td>
                                        </tr>
                                        </br>
                                        <tr>
                                            <td>Previous Amount *</td>
                                            <td><input type="text" name="changing_amount" id="changing_amount" <?php echo $total_amount_editor; ?> required></td>
                                        </tr>
                                        </br>
                                        <tr>
                                            <td>Remark *</td>
                                            <td><textarea name="reason_for_transfer" required></textarea></td>
                                        </tr>
                                        </br>
                                        <center><input type='submit' name='update_user_payment_transfer_g' class='btn btn-success' style='padding:15px; margin:0;font-size:11px;' value='Save'></center>
                                    </form>
									<script>
									$(document).ready(function() {
									    
									    $(document).on('change', '#old_order_id', function(){
                    						var oldOrderId = $(this).val();
                    						var form_data = new FormData();
                    						form_data.append('get_paid_amount_for_adjustment', 'amount_adjustment');
                    						form_data.append('old_order_id', oldOrderId);
                    						$.ajax({
                    							url: "/wp-content/themes/twentytwenty/templates/tpl_backend_functions.php",
                    							method: "POST",
                    							dataType: "json",
                    							data: form_data,
                    							contentType: false,
                    							cache: false,
                    							processData: false,
                    							success: function (response) {
                    								$('#changing_amount').val(response);
                    							},
                    							error: function(xhr, textStatus, errorThrown) {
                    								console.log(errorThrown);
                    							}
                    						});
                    					});
					
									});
									</script>
                                    <?php
                                    if (isset($_POST['update_user_payment_transfer_g']))
                                    {
                                        $previous_order_id_for_adjustment_full = $_POST['old_order_id'];
                                        $new_order_id = $_POST['new_order_id'];

                                        if ( ctype_digit($new_order_id) && strlen($new_order_id) <= 7 ) {
                                			$source = 'WPT';
                                    	} elseif (ctype_alpha($new_order_id)) {
                                    		$source = 'gds';
                                    	} else {
                                    		$source = 'gds';
                                    	}
                                    	
                                    	if ( ctype_digit($previous_order_id_for_adjustment_full) && strlen($previous_order_id_for_adjustment_full) <= 7 ) {
                                			$source_previous = 'WPT';
                                    	} elseif (ctype_alpha($previous_order_id_for_adjustment_full)) {
                                    		$source_previous = 'gds';
                                    	} else {
                                    		$source_previous = 'gds';
                                    	}
                                    	
                                    	$previous_pnr_for_adjustment_full = 'DUMMYPNRFORPAYMENT';	
                                    	if($source_previous == 'gds' && $previous_order_id_for_adjustment_full != '')
                                    	{
                                    	    $payment_get_orderid = $wpdb->get_results( "SELECT * FROM wpk4_backend_travel_booking_pax where pnr = '$previous_order_id_for_adjustment_full' OR order_id = '$previous_order_id_for_adjustment_full'"); 
                            				foreach($payment_get_orderid as $row_get_orderid) { 
                            				    $previous_order_id_for_adjustment_full = $row_get_orderid->order_id;
                            				    $previous_pnr_for_adjustment_full = $row_get_orderid->pnr;
                            				}
                                    	}
                                        $previous_amount_for_adjustment_full = $_POST['changing_amount'];
                                        $reason_for_transfer = $_POST['reason_for_transfer'];

                                        $payment_received_for_previous_order = 0;
                                        $payment_ref_partial = $wpdb->get_results( "SELECT * FROM wpk4_backend_travel_payment_history where order_id = '$previous_order_id_for_adjustment_full' "); 
                        				foreach($payment_ref_partial as $row_2) { 
                        				    $payment_received_for_previous_order += $row_2->trams_received_amount;
                        				    $payment_process_date_of_previous_order = $row_2->process_date;
                        				}
                        				$payment_received_for_previous_order = number_format((float)$payment_received_for_previous_order, 2, '.', '');
                        				$previous_amount_for_adjustment_full = number_format((float)$previous_amount_for_adjustment_full, 2, '.', '');
                        				
                        				
                        				$payment_received_for_previous_order2 = (float) number_format((float) $payment_received_for_previous_order, 2, '.', '');
                                        $previous_amount_for_adjustment_full2 = (float) number_format((float) $previous_amount_for_adjustment_full, 2, '.', '');
                                        
                                        
    
                        				$payment_partial_value_for_booking = '';
										
										$previous_order_date = date("Y-m-d H:i:s");
										$query_select_booking_order_date = "SELECT order_date FROM wpk4_backend_travel_bookings where order_id='$previous_order_id_for_adjustment_full'";
										$result_select_booking_order_date = mysqli_query($mysqli, $query_select_booking_order_date);
										if(mysqli_num_rows($result_select_booking_order_date) > 0)
										{
											$row_select_booking_order_date = mysqli_fetch_assoc($result_select_booking_order_date);
											$previous_order_date = $row_select_booking_order_date['order_date'];
										}
																			
										$payment_refund_deadline = date('Y-m-d H:i:s', strtotime($previous_order_date . ' +96 hours'));
											
                        				$invoice_id = '';
										$query_select_order_invoice_id = "SELECT * FROM wpk4_backend_travel_payment_invoice where order_id='$new_order_id' order by invoice_id desc limit 1";
										$result_select_order_invoice_id = mysqli_query($mysqli, $query_select_order_invoice_id) or die(mysqli_error($mysqli));
										if(mysqli_num_rows($result_select_order_invoice_id) > 0)
										{
											$row_select_order_invoice_id = mysqli_fetch_assoc($result_select_order_invoice_id);
											$invoice_id = $row_select_order_invoice_id['invoice_id'];
																
										}
										
										$invoice_id_old = '';
										$query_select_order_invoice_id = "SELECT * FROM wpk4_backend_travel_payment_invoice where order_id='$previous_order_id_for_adjustment_full' order by invoice_id desc limit 1";
										$result_select_order_invoice_id = mysqli_query($mysqli, $query_select_order_invoice_id) or die(mysqli_error($mysqli));
										if(mysqli_num_rows($result_select_order_invoice_id) > 0)
										{
											$row_select_order_invoice_id = mysqli_fetch_assoc($result_select_order_invoice_id);
											$invoice_id_old = $row_select_order_invoice_id['invoice_id'];
																
										}

                        				if($payment_received_for_previous_order >= $previous_amount_for_adjustment_full && ($payment_received_for_previous_order != '0.00' && $previous_amount_for_adjustment_full != '0.00') && $reason_for_transfer != '')
                                        {
                                                $deposit_adjustment_note = $reason_for_transfer. ' - ' . $previous_amount_for_adjustment_full . ' transfered from ' . $previous_order_id_for_adjustment_full . ' to ' . $new_order_id;
                                                
                                                $wpdb->insert('wpk4_backend_history_of_updates', array(
                                                        'type_id' =>$previous_order_id_for_adjustment_full,
                                                        'meta_key' =>'deposit_adjustment_in_g360',
                                                        'meta_value' => $deposit_adjustment_note,
                                                        'updated_by' =>$currnt_userlogn,
                                                        'updated_on' => $current_date_and_time,
                                                ));
                                                    
                                                $wpdb->insert('wpk4_backend_history_of_updates', array(
                                                        'type_id' =>$new_order_id,
                                                        'meta_key' =>'deposit_adjustment_in_g360',
                                                        'meta_value' => $deposit_adjustment_note,
                                                        'updated_by' =>$currnt_userlogn,
                                                        'updated_on' => $current_date_and_time,
                                                ));
                                                    
                                                $previous_payment_history_reference_note = $payment_received_for_previous_order . ' has been transfered to '. $new_order_id;
                                                    
                                                $wpdb->insert('wpk4_backend_travel_payment_history', array(
                                                        'order_id' =>$previous_order_id_for_adjustment_full,
                                                        'source' => $source_previous,
                                                        'profile_no'=>'',
                                                        'total_amount' =>'',
                                                        'trams_received_amount' => '-'.$previous_amount_for_adjustment_full,
                                                        'reference_no' =>'amount transfered to '.$new_order_id . ' - ' . $reason_for_transfer,
                                                        'balance_amount' =>'',
                                                        'payment_method' =>'14',
                                                        'pay_type' =>'deposit_adjustment',
                                            			'process_date' => $current_date_and_time,
														'gaura_invoice_id' => $invoice_id_old,
														'payment_change_deadline' => $payment_refund_deadline,
                                            			'added_on' => $current_date_and_time,
                                            			'added_by' => $currnt_userlogn,
                                                ));
                                                
                                               

                                                $wpdb->insert('wpk4_backend_travel_payment_history', array(
                                                        'order_id' =>$new_order_id,
                                                        'source' => $source,
                                                        'profile_no'=>'',
                                                        'total_amount' =>'',
                                                        'trams_received_amount' =>$previous_amount_for_adjustment_full,
                                                        'reference_no' =>'deposit transfered from '.$previous_order_id_for_adjustment_full . ' - ' . $reason_for_transfer,
                                                        'balance_amount' =>'',
                                                        'payment_method' =>'14',
                                                        'pay_type' =>'deposit_adjustment',
                                            			'process_date' => $current_date_and_time,
														'gaura_invoice_id' => $invoice_id,
														'payment_change_deadline' => $payment_refund_deadline,
                                            			'added_on' => $current_date_and_time,
                                            			'added_by' => $currnt_userlogn,
                                                ));
												
												
												
												try {
													if (abs($payment_received_for_previous_order2 - $previous_amount_for_adjustment_full2) < 0.01) {

														if (ctype_digit($previous_order_id_for_adjustment_full) && strlen($previous_order_id_for_adjustment_full) == 6) {
															$query_select_order = "SELECT * FROM wpk4_backend_travel_bookings WHERE order_id = '$previous_order_id_for_adjustment_full'";
															$result_select_order = mysqli_query($mysqli, $query_select_order);

															if (!$result_select_order) {
																throw new Exception("MySQLi SELECT failed: " . mysqli_error($mysqli));
															}

															while ($row_select_order = mysqli_fetch_assoc($result_select_order)) {
																$payment_status_stock = $row_select_order['payment_status'];

																if ($payment_status_stock === 'partially_paid') 
																{
																	$trip_code = $row_select_order['trip_code'];
																	$travel_date = $row_select_order['travel_date'];
																	$total_pax = $row_select_order['total_pax'];

																	update_stock_in_pricing_table($trip_code, $travel_date, $total_pax, 'positive');

																	$by_user = $currnt_userlogn . '_amount_transfer_in_g360';

																	availability_table_pax_update($previous_order_id_for_adjustment_full, $by_user);
																}
															}
														}

														// Update booking status using $wpdb
														$sql_update_past_booking = $wpdb->prepare(
															"UPDATE wpk4_backend_travel_bookings
															 SET payment_status = %s,
																 payment_modified = %s,
																 payment_modified_by = %s
															 WHERE order_id = %d",
															'voucher_submited',
															$current_date_and_time,
															$currnt_userlogn,
															$previous_order_id_for_adjustment_full
														);

														$results_update_past_booking = $wpdb->query($sql_update_past_booking);

														if ($results_update_past_booking === false) {
															throw new Exception("WPDB update failed: " . $wpdb->last_error);
														}

														// Insert into update history
														$insert_history_query = "
															INSERT INTO wpk4_backend_travel_booking_update_history 
															(order_id, merging_id, pax_auto_id, meta_key, meta_value, updated_time, updated_user) 
															VALUES (
																'$previous_order_id_for_adjustment_full', '', '', 'payment_status', 
																'rebooked', '$current_date_and_time', '$currnt_userlogn'
															)
														";

														$insert_history_result = mysqli_query($mysqli, $insert_history_query);

														if (!$insert_history_result) {
															throw new Exception("MySQLi INSERT into update history failed: " . mysqli_error($mysqli));
														}
													}
												} catch (Exception $e) {
													error_log("Error during previous booking voucher adjustment for order_id $previous_order_id_for_adjustment_full: " . $e->getMessage());
												}

                                                
                                                
                                               
                                                
                                                
                                                $total_amount_from_booking_table = 0.00;
                                                $query_select_booking_order_original_status = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$new_order_id'";
                                                $result_select_booking_original_status = mysqli_query($mysqli, $query_select_booking_order_original_status);
                                                $row_select_booking_original_status = mysqli_fetch_assoc($result_select_booking_original_status);
                                                if(mysqli_num_rows($result_select_booking_original_status) > 0)
                                                {
                                                    $total_amount_from_booking_table = number_format((float)$row_select_booking_original_status['total_amount'], 2, '.', '');
                                                }
                                                
                                                $total_paid_for_booking_transfer = 0.00;
                                                $total_differ_from_total_and_paid = 1.10;
                                                $query_total_paid_for_requestid = "SELECT * FROM wpk4_backend_travel_payment_history where order_id = '$new_order_id' AND (pay_type = 'deposit' OR pay_type = 'balance' 
                                                            		OR pay_type = 'Balance' OR pay_type = 'deposit_adjustment' OR pay_type = 'additional_payment')";
                                                $result_total_paid_for_requestid = mysqli_query($mysqli, $query_total_paid_for_requestid);
                                                while($row_total_paid_for_requestid = mysqli_fetch_assoc($result_total_paid_for_requestid))
                                                {
                                                    $total_paid_for_booking_transfer += (float)$row_total_paid_for_requestid['trams_received_amount'];
                                                }
                                                $total_paid_for_booking_transfer = number_format((float)$total_paid_for_booking_transfer, 2, '.', '');
                                                
                                                $total_differ_from_total_and_paid = $total_amount_from_booking_table - $total_paid_for_booking_transfer;
                                                $total_differ_from_total_and_paid = number_format((float)$total_differ_from_total_and_paid, 2, '.', '');
                                                
                                                //if($total_amount_from_booking_table != 0.00 && $total_paid_for_booking_transfer != 0.00 && ( $total_differ_from_total_and_paid != 1.10 && $total_differ_from_total_and_paid <= 1.00 && $total_differ_from_total_and_paid >= -1.00 ))
                                                
            			
                                                if($total_amount_from_booking_table != 0.00 && $total_paid_for_booking_transfer != 0.00 && ( $total_differ_from_total_and_paid != 1.10 && $total_differ_from_total_and_paid <= 1.00 ))
                                                {
                                                    $sql_update_booking_main = "UPDATE wpk4_backend_travel_bookings SET payment_status='paid', balance='$total_differ_from_total_and_paid', payment_modified='$current_date_and_time', payment_modified_by='$currnt_userlogn' 
                                    			                WHERE order_id='$new_order_id' AND payment_status='partially_paid'";
                                            		$result_booking_main= mysqli_query($mysqli,$sql_update_booking_main) or die(mysqli_error($mysqli));
													
													mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history (order_id,merging_id,pax_auto_id,meta_key,meta_value,updated_time,updated_user) 
													values ('$new_order_id','','','payment_status','paid','$current_date_and_time','$currnt_userlogn')") or die(mysqli_error($mysqli));
													
													
													if($source == 'WPT')
													{
															
														gdeal_name_update_ajax($new_order_id);	
															
														mysqli_query($mysqli,"insert into wpk4_amadeus_name_update_payment_status_log (order_id, order_type, updated_by, updated_on, is_processed_amadeus, amadeus_processed_on, page_title ) 
														values ('$new_order_id', 'WPT', '$currnt_userlogn', '$current_date_and_time', 'yes', '$current_date_and_time', 'G360 Amount Adjustment')") or die(mysqli_error($mysqli));
													}
												
                                                }
                                                
                                            echo '<script>window.location.href="?option=search&type=reference&id=' . $new_order_id . '";</script>';
                                        }
                                        else
                                        {
                                            echo '<script>alert("Error during the process. Kindly try again. Below can be the issue,\n\n Transfer amount is higher than the paid amount\n Remark not provided");</script>';
                                        }
                                        
                                    }
                				    ?>
                				</div>
                				
								<div id="fullnames_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                				    <button class="tablinks chatcategory" onclick="openCity(event, 'names_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">Switch to table view</button></br></br>
                				    Pax Details</br>
                    				<?php
                    				$order_id = $order_id_api;
                    				if($order_type_itinerary == 'WPT' || $order_type_itinerary == '' || $order_type_itinerary == 'Agent')
                    				{
                        				$query_pax = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api' AND co_order_id='$co_order_id_api'";
                                    	$result_pax = mysqli_query($mysqli, $query_pax);
                                    	while($row_pax = mysqli_fetch_assoc($result_pax))
                                    	{
                                    	    echo $row_pax['product_title']. ' | ' .$row_pax['trip_code'];  
                                    	    ?>
                        	            	</br>
                                        	<?php
                                        	$pax_counter = 1;
                                        	$selected_orderid = $row_pax['order_id'];
                                        	$selected_product_id = $row_pax['product_id'];
                                        	$original_co_order_id = $row_pax['co_order_id'];
                                        	$query_2 = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$selected_orderid' && product_id='$selected_product_id' && co_order_id = '$original_co_order_id'";
                                        	$result_2 = mysqli_query($mysqli, $query_2);
                                        	while($row_2 = mysqli_fetch_assoc($result_2))
                                        	{
                                        	
                                        	echo 'Pax '.$pax_counter;
                                        	?>
                                            <div style="display: flex;">
                                                <div style="width: 50%; padding-right: 10px;">
                                                    <table style="width: 100%; border: 1px solid #c2c0bc; border-collapse: collapse; font-size:14px;">
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; width: 40%; background-color: #f2f2f2;">Salutation</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['salutation']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">First Name</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['fname']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Last Name</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['lname']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Gender</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['gender']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Passport Number</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['ppn']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Passport Expiry</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo$row_2['ppe']?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">DOB</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo date('d-m-Y', strtotime($row_2['dob'])); ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Country</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['country']; ?></td>
                                                        </tr>
                                                    </table>
                                                </div>
                                                
                                                <div style="width: 50%; padding-left: 10px;">
                                                    <table style="width: 100%; border: 1px solid #c2c0bc; border-collapse: collapse; font-size:14px;">
                                                         <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">PNR</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['pnr']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Phone</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['phone_pax']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Email</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['email_pax']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Ticket Number</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['ticket_number']; ?></td>
                                                        </tr>
                                                        
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Meal</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['meal']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">e-ticket emailed</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['eticket_emailed']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Wheelchair</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['wheelchair']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Adult Order</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['adult_order']; ?></td>
                                                        </tr>
                                                    </table>
                                                </div>
                                            </div>
                                            </br>
                                        	<?php
                                        	$pax_counter++;
                                        	}
                                        	echo '</br>'; 
                                    	}
                    				}
                    				else
        				                    {
        				                        $total_paxs = 0;
                            				    $query_summary_loop = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api' AND co_order_id='$co_order_id_api'";
                            				    $result_loop = mysqli_query($mysqli, $query_summary_loop) or die(mysqli_error($mysqli));
                                			    while($row_loop = mysqli_fetch_assoc($result_loop))
                            				    {
                            				        $order_id_pax_view = $row_loop['order_id'];
                            				        $travel_date = $row_loop['travel_date'];
			                                        $return_date = $row_loop['return_date'];
                            				        $co_order_id_pax_view = $row_loop['co_order_id'];
                            				        $product_id_pax_view = $row_loop['product_id'];
                            				        if($return_date != $travel_date) // return trip block
			                                        {
			                                            $parts_trip = explode("-", $row_loop['trip_code']);
                                				        if (count($parts_trip) >= 2) {
                                                            $origin_place = $parts_trip[0];
                                                            $destination_place = $parts_trip[1];
                                                                echo '<tr><th colspan="6">'. $origin_place . ' - ' . $destination_place . ' - ' . $travel_date .'</th></tr>';
                                                        }
                                				        ?>
                                				        <?php
                                        	$pax_counter = 1;
                                        	
                                        	$query_2 = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_pax_view' && product_id='$product_id_pax_view' && co_order_id = '$co_order_id_pax_view'";
                                        	$result_2 = mysqli_query($mysqli, $query_2);
                                        	while($row_2 = mysqli_fetch_assoc($result_2))
                                        	{
                                        	echo '</br>';
                                        	echo 'Pax '.$pax_counter;
                                        	?>
                                            <div style="display: flex;">
                                                <div style="width: 50%; padding-right: 10px;">
                                                    <table style="width: 100%; border: 1px solid #c2c0bc; border-collapse: collapse; font-size:14px;">
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; width: 40%; background-color: #f2f2f2;">Salutation</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['salutation']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">First Name</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['fname']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Last Name</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['lname']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Gender</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['gender']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Passport Number</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['ppn']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Passport Expiry</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo$row_2['ppe']?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">DOB</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo date('d-m-Y', strtotime($row_2['dob'])); ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Country</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['country']; ?></td>
                                                        </tr>
                                                    </table>
                                                </div>
                                                
                                                <div style="width: 50%; padding-left: 10px;">
                                                    <table style="width: 100%; border: 1px solid #c2c0bc; border-collapse: collapse; font-size:14px;">
                                                         <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">PNR</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['pnr']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Phone</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['phone_pax']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Email</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['email_pax']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Ticket Number</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['ticket_number']; ?></td>
                                                        </tr>
                                                        
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Meal</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['meal']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">e-ticket emailed</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['eticket_emailed']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Wheelchair</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['wheelchair']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Adult Order</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['adult_order']; ?></td>
                                                        </tr>
                                                    </table>
                                                </div>
                                            </div>
                                            </br>
                                        	<?php
                                        	$pax_counter++;
                                        	}
                                        	echo '</br>'; 
                        				                $parts_trip = explode("-", $row_loop['trip_code']);
                                				        if (count($parts_trip) >= 2) {
                                                            $origin_place = $parts_trip[0];
                                                            $destination_place = $parts_trip[1];
                                                                echo '<tr><th colspan="6">'. $destination_place . ' - ' . $origin_place . ' - ' . $return_date .'</th></tr>';
                                                        }
                                				        ?>
                                				        <?php
                                        	$pax_counter = 1;
                                        	
                                        	$query_2 = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_pax_view' && product_id='$product_id_pax_view' && co_order_id = '$co_order_id_pax_view'";
                                        	$result_2 = mysqli_query($mysqli, $query_2);
                                        	while($row_2 = mysqli_fetch_assoc($result_2))
                                        	{
                                        	echo '</br>';
                                        	echo 'Pax '.$pax_counter;
                                        	?>
                                            <div style="display: flex;">
                                                <div style="width: 50%; padding-right: 10px;">
                                                    <table style="width: 100%; border: 1px solid #c2c0bc; border-collapse: collapse; font-size:14px;">
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; width: 40%; background-color: #f2f2f2;">Salutation</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['salutation']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">First Name</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['fname']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Last Name</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['lname']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Gender</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['gender']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Passport Number</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['ppn']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Passport Expiry</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo$row_2['ppe']?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">DOB</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo date('d-m-Y', strtotime($row_2['dob'])); ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Country</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['country']; ?></td>
                                                        </tr>
                                                    </table>
                                                </div>
                                                
                                                <div style="width: 50%; padding-left: 10px;">
                                                    <table style="width: 100%; border: 1px solid #c2c0bc; border-collapse: collapse; font-size:14px;">
                                                         <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">PNR</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['pnr']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Phone</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['phone_pax']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Email</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['email_pax']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Ticket Number</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['ticket_number']; ?></td>
                                                        </tr>
                                                        
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Meal</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['meal']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">e-ticket emailed</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['eticket_emailed']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Wheelchair</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['wheelchair']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Adult Order</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['adult_order']; ?></td>
                                                        </tr>
                                                    </table>
                                                </div>
                                            </div>
                                            </br>
                                        	<?php
                                        	$pax_counter++;
                                        	}
                                        	echo '</br>'; 
			                                        }
			                                        else
			                                        {
			                                            ?>
			                                            <?php
                                        	$pax_counter = 1;
                                        	
                                        	$query_2 = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_pax_view' && product_id='$product_id_pax_view' && co_order_id = '$co_order_id_pax_view'";
                                        	$result_2 = mysqli_query($mysqli, $query_2);
                                        	while($row_2 = mysqli_fetch_assoc($result_2))
                                        	{
                                        	echo '</br>';
                                        	echo 'Pax '.$pax_counter;
                                        	?>
                                            <div style="display: flex;">
                                                <div style="width: 50%; padding-right: 10px;">
                                                    <table style="width: 100%; border: 1px solid #c2c0bc; border-collapse: collapse; font-size:14px;">
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; width: 40%; background-color: #f2f2f2;">Salutation</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['salutation']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">First Name</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['fname']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Last Name</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['lname']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Gender</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['gender']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Passport Number</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['ppn']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Passport Expiry</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo$row_2['ppe']?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">DOB</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo date('d-m-Y', strtotime($row_2['dob'])); ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Country</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['country']; ?></td>
                                                        </tr>
                                                    </table>
                                                </div>
                                                
                                                <div style="width: 50%; padding-left: 10px;">
                                                    <table style="width: 100%; border: 1px solid #c2c0bc; border-collapse: collapse; font-size:14px;">
                                                         <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">PNR</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['pnr']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Phone</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['phone_pax']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Email</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['email_pax']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Ticket Number</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['ticket_number']; ?></td>
                                                        </tr>
                                                        
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Meal</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['meal']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">e-ticket emailed</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['eticket_emailed']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Wheelchair</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['wheelchair']; ?></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px; background-color: #f2f2f2;">Adult Order</td>
                                                            <td style="border: 1px solid #c2c0bc; padding: 8px;"><?php echo $row_2['adult_order']; ?></td>
                                                        </tr>
                                                    </table>
                                                </div>
                                            </div>
                                            </br>
                                        	<?php
                                        	$pax_counter++;
                                        	}
                                        	echo '</br>'; 
			                                        }
                            				    }
        				                    }
                    				?>
                				</div>
                				
                				<div id="payments_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                				    </br></br>
                				    <?php
                				    $order_id = $order_id_api;
                				    $query_initial_order = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api'";
                                	$result_initial_order = mysqli_query($mysqli, $query_initial_order);
                                	$row_initial_order = mysqli_fetch_assoc($result_initial_order);
                                    $order_date = $row_initial_order['order_date'];
                                    $order_type_paymentblock = $row_initial_order['order_type'];
									$source_paymentblock = $row_initial_order['source'];
                                    $payment_status = $row_initial_order['payment_status'];
                                    $late_modified = $row_initial_order['late_modified'];
                                    $modified_by = $row_initial_order['modified_by'];
                                    $payment_modified = $row_initial_order['payment_modified'];
                                    $payment_modified_by = $row_initial_order['payment_modified_by'];
                                    $deposit_amount = '';
                                    if($order_type_paymentblock != 'gds' )
                                        {
                                            
                                        $total_amount = $row_initial_order['total_amount'];
                                        $total_amount_from_postmeta = $total_amount;
                                        $deposit_amount = $row_initial_order['deposit_amount'];
                                        $balance = $row_initial_order['balance'];
                                        
                                        
                                            $wpt_coupon_code_array = get_post_meta($order_id_api, 'wp_travel_applied_coupon_data', true);
                                            if(isset($wpt_coupon_code_array) && $wpt_coupon_code_array != '' && isset($wpt_coupon_code_array['coupon_code']) && $wpt_coupon_code_array['coupon_code'] != '')
                                            {
                                                $ordertotal__query = $wpdb->get_results( "SELECT * FROM wpk4_postmeta where post_id='$order_id_api' && meta_key='order_totals'"); 
                                                foreach($ordertotal__query as $row_2){ 
                                                    $order_total_amount = $row_2->meta_value;
                                                }
                                                $orderData = unserialize($order_total_amount);
                                                //$total_amount = $orderData['sub_total'];
                                                $total_amount_from_postmeta = $orderData['cart_total'];
                                                $balance = $total_amount - $deposit_amount;
                                            }
                                            
                                        }
                                    
                                    $total_amount_gds = 0;
                                    if($order_type_paymentblock == 'gds' && $deposit_amount == '' )
                                    {
										$total_amount = $row_initial_order['total_amount'];
                                        $deposit_amount = $row_initial_order['deposit_amount'];
                                        $total_amount_gds = get_meta_from_history_of_updates($order_id_api, 'Transaction TotalTurnover');
                                        $total_amount_temp = (float)get_meta_from_history_of_updates($order_id_api, 'Transaction TotalTurnover');
										
										if($total_amount_temp > 0)
										{
											$total_amount = $total_amount_temp;
										}
                                        $total_amount_from_postmeta = $total_amount;
                                        if($deposit_amount == '')
                                        {
                                            
                                            $deposit_amount_temp = 0;
                                            $query_initial_order_meta = "SELECT * FROM wpk4_backend_history_of_updates where type_id='$order_id_api' AND meta_key = 'Payments Amount'";
                                        	$result_initial_order_meta = mysqli_query($mysqli, $query_initial_order_meta);
											if(mysqli_num_rows($result_initial_order_meta) > 0)
											{
												while($row_initial_order_meta = mysqli_fetch_assoc($result_initial_order_meta))
												{
													$deposit_amount_temp = $deposit_amount_temp + (float)$row_initial_order_meta['meta_value'];
												}
											}
                                    	    $deposit_amount = $deposit_amount_temp;
                                        }
                                        $balance = (float)$total_amount - (float)$deposit_amount;
                                    }
									
									if($source_paymentblock == 'datechange')
									{
										$total_amount = $row_initial_order['total_amount'];
                                        $total_amount_from_postmeta = $total_amount;
                                        //$deposit_amount = $row_initial_order['deposit_amount'];
                                        $balance = '';
									}
                                    
                                    /* Intermediate code added to resolve the issue on G360 GDS total amount shown as 0 after use Update from GDS option. */
                                    if($currnt_userlogn == 'sriharshans' && 1 == 3)
                                    {
                                    if((float)$total_amount_gds == 0 && $order_type_paymentblock == 'gds')
                                    {
                                        $total_amount = $row_initial_order['total_amount'];
                                        
                                        $deposit_amount = $row_initial_order['deposit_amount'];

                                        if($deposit_amount == '')
                                        {
                                            
                                            $deposit_amount_temp = 0;
                                            $query_initial_order_meta = "SELECT * FROM wpk4_backend_history_of_updates where type_id='$order_id_api' && meta_key = 'Payments Amount'";
                                        	$result_initial_order_meta = mysqli_query($mysqli, $query_initial_order_meta);
                                        	while($row_initial_order_meta = mysqli_fetch_assoc($result_initial_order_meta))
                                        	{
                                        	    $deposit_amount_temp = $deposit_amount_temp + (float)$row_initial_order_meta['meta_value'];
                                        	}
                                    	    $deposit_amount = $deposit_amount_temp;
                                        }
                                        $balance = (float)$total_amount - (float)$deposit_amount;
                                        
                                    }
                                    }
                                    /* Intermediate code ends */
                                    
                                    $query_pnr_for_total_paid = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api'";
                                    $result_pnr_for_total_paid = mysqli_query($mysqli, $query_pnr_for_total_paid);
                                    $row_pnr_for_total_paid = mysqli_fetch_assoc($result_pnr_for_total_paid);
                                	$received_pnr_for_total_paid = $row_pnr_for_total_paid['pnr'];
                                	$processedPaymentsPaid = array();	
                            		$query_payment_paid_amount = "SELECT * FROM wpk4_backend_travel_payment_history where (pay_type = 'deposit' OR pay_type LIKE 'balance' 
                            		OR pay_type LIKE 'Balance' OR pay_type = 'deposit_adjustment' OR pay_type = 'Refund' OR pay_type = 'additional_payment') 
                            		AND order_id='$order_id_api' order by process_date desc";
                                    $result_payment_paid_amount = mysqli_query($mysqli, $query_payment_paid_amount);
                                    $total_paid_for_booking = 0;
                                    if($result_payment_paid_amount && mysqli_num_rows($result_payment_paid_amount) > 0)
                                    {
                                        while($row_payment_paid_amount = mysqli_fetch_assoc($result_payment_paid_amount))
                                        {
                                            $payment_identifier = $row_payment_paid_amount['process_date'].'^'.$row_payment_paid_amount['trams_received_amount'].'^'.$row_payment_paid_amount['reference_no']; // defined value to restric duplicate amount + ref no combination on G360
                                			if (in_array($payment_identifier, $processedPaymentsPaid)) 
                                			{
                                			    continue; // Skip to the next value
                                			}
                                				
                                				
                                			$processedPaymentsPaid[] = $payment_identifier;
                                					
                                            $total_paid_for_booking += (float)$row_payment_paid_amount['trams_received_amount'];
                                        }
                                        
                                        if($total_paid_for_booking < 0)
                                        {
                                            $total_paid_for_booking = 0;
                                        }
                                        
                                        $balance = (float)$total_amount - (float)$total_paid_for_booking; 
                                    }
                                    
                                    if($balance == '')
                            		{
                            		    $balance = (float)$total_amount - (float)$deposit_amount;
                            		}
                				    ?>
                				    <?php
                				    $discount_given_amount = 0;
                				    if($order_type_paymentblock == 'WPT' )
                                    {
                                        $wpt_coupon_code_array = get_post_meta($order_id_api, 'wp_travel_applied_coupon_data', true);
                                        if(isset($wpt_coupon_code_array) && $wpt_coupon_code_array != '' && isset($wpt_coupon_code_array['coupon_code']) && $wpt_coupon_code_array['coupon_code'] != '')
                                        {
                                            $wpt_coupon_code_type = '';
                                            if($wpt_coupon_code_array['type'] == 'percentage')
                                            {
                                                $wpt_coupon_code_type = '%';
                                            }
                                            $discount_given_amount = $total_amount_from_postmeta - $total_amount;
                                            ?>
                                            </br></br>
                                            Total amount before discount: <b><?php echo number_format((float)$total_amount_from_postmeta, 2, '.', ''); ?></b></br>
                                            Discount given: <b><?php echo number_format((float)$discount_given_amount, 2, '.', ''); ?></b></br>
                                            Coupon applied: <b><?php echo $wpt_coupon_code_array['coupon_code']; ?> (Discount: <?php echo $wpt_coupon_code_array['value'].$wpt_coupon_code_type; ?>)</b></br>
                                            <?php
                                        }
                                    }
                				    ?>
                				    </br>
                				    <?php
                				    if($discount_given_amount != 0)
                				    {
                				        echo 'Total Amount after discount: ';
                				    }
                				    else
                				    {
                				         echo 'Total Amount: ';
                				    }
                				    ?>
                                        <b><?php echo number_format((float)$total_amount, 2, '.', ''); ?></b>
                                    <?php
                                    if($currnt_userlogn == 'sriharshans' || $currnt_userlogn == 'lee')
                				        {
                                            ?>
                                            <button class="tablinks chatcategory" id="editButton" onclick="toggleForm()">Edit</button></br>
                                            <!-- Hidden form for editing Total Amount -->
                                            <div id="editForm" style="display:none; margin-top: 10px; margin-bottom: 10px;">
                                                <form method="post" style="display: flex; align-items: center;">
                                                    <input type="hidden" name="order_id_for_total_amount" value="<?php echo $order_id_api; ?>">
                                                    
                                                    <input type="text" style="width: 20%; margin-right: 10px; padding: 7px 10px;" 
                                                           pattern="^\d+(\.\d{1,2})?$"
                                                           name="total_amount_new" 
                                                           value="<?php echo $total_amount; ?>">
                                                    
                                                    <input name="update_user_payment_total_amount"  class="tablinks chatcategory" 
                                                           type="submit" style="padding: 7px 10px; font-size: 13px;"
                                                           value="Update">
                                                </form>
                                            </div>
                                            <?php
                				        }
                                    ?>
                                    <script>
                                        function toggleForm() {
                                            var form = document.getElementById('editForm');
                                            var button = document.getElementById('editButton');
                                            
                                            if (form.style.display === 'none' || form.style.display === '') {
                                                form.style.display = 'block';
                                                button.textContent = 'Cancel';
                                            } else {
                                                form.style.display = 'none';
                                                button.textContent = 'Edit'; 
                                            }
                                        }
                                    </script>
                                    <?php
                                    if($total_paid_for_booking < 0)
                                    {
                                        $total_paid_for_booking = 0;
                                    }
                                    
                                    if (isset($_POST['update_user_payment_total_amount'])) { 
                                        $order_id_for_total_amount = $_POST['order_id_for_total_amount'];
                                        $total_amount_new = number_format((float)$_POST['total_amount_new'], 2, '.', '');
                                        $sql_update_past_booking_2 ="UPDATE wpk4_backend_travel_bookings SET total_amount = '$total_amount_new'
                                        WHERE order_id = '$order_id_for_total_amount'";
                                        $results_update_past_booking_2 = $wpdb->query($sql_update_past_booking_2);
                                        
                                        mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history ( order_id, merging_id, pax_auto_id, meta_key, meta_value, updated_time, updated_user ) 
										values ('$order_id_for_total_amount', '', '', 'TotalAmount Update in G360', '$total_amount_new', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
										
										$current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                        echo '<script>window.location.href="'.$current_url.'";</script>';
                                    }
                                    ?>
                                    </br>
                                    Amount paid: <b><?php echo number_format((float)$total_paid_for_booking, 2, '.', ''); ?></b></br>
                                    Balance: <b><?php echo number_format((float)$balance, 2, '.', ''); ?></b>
                                    
                                    <?php
                                    // WPTravel Coupon code
                                    if($order_type_paymentblock == 'WPT' && 1 == 2)
                                    {
                                        $wpt_coupon_code_array = get_post_meta($order_id_api, 'wp_travel_applied_coupon_data', true);
                                        if(isset($wpt_coupon_code_array) && $wpt_coupon_code_array != '' && isset($wpt_coupon_code_array['coupon_code']) && $wpt_coupon_code_array['coupon_code'] != '')
                                        {
                                            $wpt_coupon_code_type = '';
                                            if($wpt_coupon_code_array['type'] == 'percentage')
                                            {
                                                $wpt_coupon_code_type = '%';
                                            }
                                            ?>
                                            </br></br>
                                            Coupon applied: <b><?php echo $wpt_coupon_code_array['coupon_code']; ?> (Discount: <?php echo $wpt_coupon_code_array['value'].$wpt_coupon_code_type; ?>)</b></br>
                                            <?php
                                        }
                                    }
                                    ?>
                                     </br></br>
                                     
                                    <?php
                                    // DC total charge section
                                    
                            		$query_payment_dc_amount = "SELECT * FROM wpk4_backend_travel_payment_history WHERE (pay_type = 'Datechange' OR pay_type LIKE 'dc_charge') AND order_id='$order_id_api' AND order_id != '' ORDER BY process_date DESC";
                                    $result_payment_dc_amount = mysqli_query($mysqli, $query_payment_dc_amount);
                                    
                                    // Initialize an array to hold the sums of trams_received_amount for each reference_no
                                    $sums_by_reference = array();
                                    
                                    // Initialize an array to track processed payments (to avoid duplicates)
                                    $processedPaymentsDC = array();
                                    
                                    if (mysqli_num_rows($result_payment_dc_amount) > 0) {
                                        echo '</br></br>';
                                        while ($row_payment_dc_amount = mysqli_fetch_assoc($result_payment_dc_amount)) {
                                            $temp_ref_no = explode("_", $row_payment_dc_amount['reference_no']);
                                            if(!isset($temp_ref_no[1]) || ( isset($temp_ref_no[1]) && $temp_ref_no[1] == '') )
                                            {
                                                $temp_ref_no[1] = 'N/A';
                                            }
                                            
                                            $payment_identifier = $row_payment_dc_amount['process_date'] . '^' . $row_payment_dc_amount['trams_received_amount'] . '^' . $row_payment_dc_amount['reference_no'];
                                    
                                            // Skip duplicate entries
                                            if (in_array($payment_identifier, $processedPaymentsDC)) {
                                                continue;
                                            }
                                            $processedPaymentsDC[] = $payment_identifier;
                                    
                                            // Add the trams_received_amount to the total for the current reference_no
                                            if (!isset($sums_by_reference[$temp_ref_no[1]])) {
                                                $sums_by_reference[$temp_ref_no[1]] = 0.0;
                                            }
                                            
                                            $sums_by_reference[$temp_ref_no[1]] += (float)$row_payment_dc_amount['trams_received_amount'];
                                        }
                                    
                                        // Display the total trams_received_amount for each reference_no
                                        foreach ($sums_by_reference as $reference_no => $totalpaid_case) {
                                            
                                            
                                            $query_dc_pay_status = "SELECT * FROM wpk4_backend_travel_booking_custom_payments where payment_client_id LIKE '%$reference_no%'";
                                            $result_dc_pay_status = mysqli_query($mysqli, $query_dc_pay_status);
                                            $dc_total_payment_for_case = 0;
                                            if(mysqli_num_rows($result_dc_pay_status) > 0)
                                    		{
                                        		while($count_dc_pay_status = mysqli_fetch_assoc($result_dc_pay_status))
                                        		{
                            					    $dc_total_payment_for_case += (float)$count_dc_pay_status['amount'];
                                        		}
                                    		}
                                    		$dc_balance_for_case = $dc_total_payment_for_case - $totalpaid_case;
                                    		
                                    		// assiging dummy 0.00 to avoid negative value as there are no requested amount found.
                                    		if($dc_total_payment_for_case == 0)
                                    		{
                                    		    $dc_balance_for_case = 0.00;
                                    		}
                                    				
                                            echo 'Case: <b>' . $reference_no . '</b><br>
                                            Requested: <b>' . number_format($dc_total_payment_for_case, 2, '.', '') . '</b><br>
                                            Paid: <b>' . number_format($totalpaid_case, 2, '.', '') . '</b><br>
                                            Balance: <b>' . number_format($dc_balance_for_case, 2, '.', '') . '</b><br><br>';
                                            
                                        }
                                        
                                    }
                                    else
                                    {
                                        echo '<br/><br/>';
                                    }
                                    if( current_user_can( 'administrator' ) || current_user_can( 'ho_payment' ) || current_user_can( 'ho_operations' ) )
									{
									    ?>
									    <a style="text-decoration:none;curser:pointer;background-color:#c7950b; padding:4px 8px; color:white;" onclick="openCity(event, 'amount_adjustment_req<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">Amount Adjustment Request</a>
									    <?php
									}
									
									//if( current_user_can( 'administrator' ) || current_user_can( 'agent_team_leaders' )) 
									if( current_user_can( 'administrator' ) || current_user_can( 'ho_payment' ) || current_user_can( 'ho_operations' ) || current_user_can( 'after_sales_manager' )|| current_user_can( 'local_general_manager' ))
									{
                                    ?>
                                    <a style="text-decoration:none;curser:pointer;background-color:#c7950b; padding:4px 8px; color:white;" onclick="openCity(event, 'amount_adjustment_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">Amount Adjustment</a>
									
									
									<?php
									}
									if( ( current_user_can( 'datechange_manager' ) && $row_payment_status['payment_status'] == 'paid' ) || $currnt_userlogn == 'lee' || $currnt_userlogn == 'sriharshans' || $currnt_userlogn == 'kajalk' || $currnt_userlogn == 'joyce' || $currnt_userlogn == 'BinalJ' || current_user_can( 'after_sales_manager' )|| current_user_can( 'local_general_manager' ))
									{
									?>
									<a style="text-decoration:none;curser:pointer;background-color:#c7950b; padding:4px 8px; color:white;" onclick="openCity(event, 'azupay_request_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>')">Request Payment</a>
									<?php
									}
									?>
									
                                    <script>
                                        function confirmRequest() {
                                            var requestvalue = document.getElementById("resend_payment_amount_value").value;
                                            return confirm("Do you want to resend the payment link for the amount $" + requestvalue + " ?");
                                        }
										function confirmRequestBpay() {
                                            var requestvalue = document.getElementById("resend_payment_amount_value_bpay").value;
                                            return confirm("Do you want to resend the payment link for the amount $" + requestvalue + " ?");
                                        }
                                    </script>
                                    
                                    <?php
                                        $query_pnr_for_payments = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api'";
                                        $result_pnr_for_payments = mysqli_query($mysqli, $query_pnr_for_payments);
                                        $row_pnr_for_payments = mysqli_fetch_assoc($result_pnr_for_payments);
                                        $received_order_type_for_payments = $row_pnr_for_payments['order_type'];
                                		$received_pnr_for_payments = $row_pnr_for_payments['pnr'];
                                        $processedPayments = array();
                                        if($received_order_type_for_payments == 'WPT')
                                        {
                                            ?>
                                            <h6>Booking Payment</h6>
                                            <table style="font-size:13px;">
                                                <tr>
                                                    <th>Payment Date</th><th>Type</th><th>Paid Amount</th><th>Reference No</th><th>Remark</th><th>Method</th><th>Status</th><?php if($currnt_userlogn == 'joyce' || $currnt_userlogn == 'lee' ) { echo '<th></th>'; } ?>
                                                </tr>
                                                <?php
                                                $query_payment_history = "SELECT * FROM wpk4_backend_travel_payment_history where order_id='$order_id_api' AND (pay_type IN ('deposit', 'balance', 'balance ', 'Balance', 'deposit_adjustment', 'Refund', 'additional_payment') OR pay_type IS NULL OR pay_type = '') order by process_date desc";
                                            	$result_payment_history = mysqli_query($mysqli, $query_payment_history);
                                            	if(mysqli_num_rows($result_payment_history) > 0)
                                            	{
                                            	    
                                                	while($row_payment_history = mysqli_fetch_assoc($result_payment_history))
                                                	{
                                                        $payment_identifier = $row_payment_history['process_date'].'^'.$row_payment_history['trams_received_amount'].'^'.$row_payment_history['reference_no']; // defined value to restric duplicate amount + ref no combination on G360
                                    					if (in_array($payment_identifier, $processedPayments)) 
                                    					{
                                    					   continue; // Skip to the next value
                                    					}
                                    							
                                    					$processedPayments[] = $payment_identifier;
                                    						
                                                	    $current_pay_method_id = $row_payment_history['payment_method'];
                                                	    $query_payment_method_finder = "SELECT * FROM wpk4_backend_accounts_bank_account where bank_id='$current_pay_method_id'";
                                                    	$result_payment_method_finder = mysqli_query($mysqli, $query_payment_method_finder);
                                                    	$row_payment_method_finder = mysqli_fetch_assoc($result_payment_method_finder);
                                                    	$row_payment_method_finder_count = mysqli_num_rows($result_payment_method_finder);
                                                    	$bank_account_type_name = '';
                                                    	if($row_payment_method_finder_count > 0)
                                                    	{
                                                    	    $bank_account_type_name = $row_payment_method_finder['account_name'];
                                                    	}
                                                        ?>
                                                        <tr>
                                                            <td><?php echo date('d/m/Y H:i:s', strtotime($row_payment_history['process_date'])); ?></td>
                                                            <td>
                                                                <?php 
                                                                if($row_payment_history['pay_type'] == 'deposit')
                                                                {
                                                                    echo "Booking Deposit"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'balance' || $row_payment_history['pay_type'] == 'balance ' || $row_payment_history['pay_type'] == 'Balance')
                                                                {
                                                                    echo "Booking Balance"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'deposit_adjustment')
                                                                {
                                                                    echo "Booking Deposit Adjustment"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'dc_charge')
                                                                {
                                                                    echo "Datechange"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'Datechange')
                                                                {
                                                                    echo "Datechange"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'additional_payment')
                                                                {
                                                                    echo "Additional Payment"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'Refund')
                                                                {
                                                                    echo "Refund"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'other')
                                                                {
                                                                    echo "Other"; 
                                                                }
                                                                else
                                                                {
                                                                    echo "Unknown"; 
                                                                }
                                                                ?>
                                                            </td>
                                                            <td><?php echo $row_payment_history['trams_received_amount']; ?></td>
                                                            <td><?php echo $row_payment_history['reference_no']; ?></td>
                                                            <td><?php echo $row_payment_history['trams_remarks']; ?></td>
                                                            <td><?php echo $bank_account_type_name; ?></td> 
                                                            <td><?php 
                                                            if($row_payment_history['cleared_date'] != '')
                                                            {
                                                                echo 'Confirmed on '. $row_payment_history['cleared_date'];
                                                            }
                                                            else
                                                            {
                                                                echo 'Pending';
                                                            }
                                                            ?></td> 
                                                            <?php
                                                            if($row_payment_history['cleared_date'] != '' && ($currnt_userlogn == 'joyce' || $currnt_userlogn == 'lee' ))
                                                            {
                                                                echo '<td><a target="_blank" href="?option=amount-adjustment&id='.$row_payment_history['auto_id'].'">Adjustment</a></td>';
                                                            }
                                                            ?>
                                                        </tr>
                                                        <?php
                                                    }
                                            	}
                                            	else
                                        		{
                                        		    echo '<td colspan="7">No record found</td>';
                                        		}
                                            	?>
                                        	</table>
                                        	
                                        	<h6>Other Payment</h6>
                                        	<table style="font-size:13px;">
                                                <tr>
                                                    <th>Payment Date</th><th>Type</th><th>Paid Amount</th><th>Reference No</th><th>Remark</th><th>Method</th><th>Status</th><?php if($currnt_userlogn == 'joyce' || $currnt_userlogn == 'lee' ) { echo '<th></th>'; } ?>
                                                </tr>
                                            	<?php
                                            	$query_payment_history = "SELECT * FROM wpk4_backend_travel_payment_history where order_id='$order_id_api' AND pay_type IN ('dc_charge', 'Datechange', 'other') order by process_date desc";
                                            	$result_payment_history = mysqli_query($mysqli, $query_payment_history);
                                            	if(mysqli_num_rows($result_payment_history) > 0)
                                            	{
                                            	    
                                                	while($row_payment_history = mysqli_fetch_assoc($result_payment_history))
                                                	{
                                                        $payment_identifier = $row_payment_history['process_date'].'^'.$row_payment_history['trams_received_amount'].'^'.$row_payment_history['reference_no']; // defined value to restric duplicate amount + ref no combination on G360
                                    					if (in_array($payment_identifier, $processedPayments)) 
                                    					{
                                    					   continue; // Skip to the next value
                                    					}
                                    							
                                    					$processedPayments[] = $payment_identifier;
                                    						
                                                	    $current_pay_method_id = $row_payment_history['payment_method'];
                                                	    $query_payment_method_finder = "SELECT * FROM wpk4_backend_accounts_bank_account where bank_id='$current_pay_method_id'";
                                                    	$result_payment_method_finder = mysqli_query($mysqli, $query_payment_method_finder);
                                                    	$row_payment_method_finder = mysqli_fetch_assoc($result_payment_method_finder);
                                                    	$row_payment_method_finder_count = mysqli_num_rows($result_payment_method_finder);
                                                    	$bank_account_type_name = '';
                                                    	if($row_payment_method_finder_count > 0)
                                                    	{
                                                    	    $bank_account_type_name = $row_payment_method_finder['account_name'];
                                                    	}
                                                        ?>
                                                        <tr>
                                                            <td><?php echo date('d/m/Y H:i:s', strtotime($row_payment_history['process_date'])); ?></td>
                                                            <td>
                                                                <?php 
                                                                if($row_payment_history['pay_type'] == 'deposit')
                                                                {
                                                                    echo "Booking Deposit"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'balance' || $row_payment_history['pay_type'] == 'balance ' || $row_payment_history['pay_type'] == 'Balance')
                                                                {
                                                                    echo "Booking Balance"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'deposit_adjustment')
                                                                {
                                                                    echo "Booking Deposit Adjustment"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'dc_charge')
                                                                {
                                                                    echo "Datechange"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'Datechange')
                                                                {
                                                                    echo "Datechange"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'additional_payment')
                                                                {
                                                                    echo "Additional Payment"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'other')
                                                                {
                                                                    echo "Other"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'Refund')
                                                                {
                                                                    echo "Refund"; 
                                                                }
                                                                else
                                                                {
                                                                    echo "Unknown"; 
                                                                }
                                                                ?>
                                                            </td>
                                                            <td><?php echo $row_payment_history['trams_received_amount']; ?></td>
                                                            <td><?php echo $row_payment_history['reference_no']; ?></td>
                                                            <td><?php echo $row_payment_history['trams_remarks']; ?></td>
                                                            <td><?php echo $bank_account_type_name; ?></td> 
                                                            <td><?php 
                                                            if($row_payment_history['cleared_date'] != '')
                                                            {
                                                                echo 'Confirmed on '. $row_payment_history['cleared_date'];
                                                            }
                                                            else
                                                            {
                                                                echo 'Pending';
                                                            }
                                                            ?></td> 
                                                            <?php
                                                            if($row_payment_history['cleared_date'] != '' && ($currnt_userlogn == 'joyce' || $currnt_userlogn == 'lee' ))
                                                            {
                                                                echo '<td><a target="_blank" href="?option=amount-adjustment&id='.$row_payment_history['auto_id'].'">Adjustment</a></td>';
                                                            }
                                                            ?>
                                                        </tr>
                                                        <?php
                                                    }
                                            	}
                                            	else
                                        		{
                                        		    echo '<td colspan="7">No record found</td>';
                                        		}
                                        	?>
                                        	</table>
                                        	<?php
                                        }
                                        else
                                        {
                                            ?>
                                            <h6>Booking Payment</h6>
                                            <table style="font-size:13px;">
                                                <tr>
                                                    <th>Payment Date</th><th>Type</th><th>Paid Amount</th><th>Reference No</th><th>Remark</th><th>Method</th><th>Status</th><?php if($currnt_userlogn == 'joyce' || $currnt_userlogn == 'lee' ) { echo '<th></th>'; } ?>
                                                </tr>
                                                <?php
                                                $payment_history_count = 0;
                                                $query_payment_history = "SELECT * FROM wpk4_backend_travel_payment_history where order_id='$order_id_api' AND order_id != '' AND (pay_type IN ('deposit', 'balance', 'balance ', 'Balance', 'deposit_adjustment', 'Refund') OR pay_type IS NULL OR pay_type = '') order by process_date desc";
                                            	$result_payment_history = mysqli_query($mysqli, $query_payment_history);
                                            	if(mysqli_num_rows($result_payment_history) > 0)
                                            	{
                                                	while($row_payment_history = mysqli_fetch_assoc($result_payment_history))
                                                	{
                                                	    
                                                	    $payment_identifier = $row_payment_history['process_date'].'^'.$row_payment_history['trams_received_amount'].'^'.$row_payment_history['reference_no']; // defined value to restric duplicate amount + ref no combination on G360
                                    					if (in_array($payment_identifier, $processedPayments)) 
                                    					{
                                    					   continue; // Skip to the next value
                                    					}
                                    							
                                    					$processedPayments[] = $payment_identifier;
                                    					
                                                	    $current_pay_method_id = $row_payment_history['payment_method'];
                                                	    $query_payment_method_finder = "SELECT * FROM wpk4_backend_accounts_bank_account where bank_id='$current_pay_method_id'";
                                                    	$result_payment_method_finder = mysqli_query($mysqli, $query_payment_method_finder);
                                                    	$row_payment_method_finder = mysqli_fetch_assoc($result_payment_method_finder);
                                                    	$row_payment_method_finder_count = mysqli_num_rows($result_payment_method_finder);
                                                    	$bank_account_type_name = '';
                                                    	if($row_payment_method_finder_count > 0)
                                                    	{
                                                    	    $bank_account_type_name = $row_payment_method_finder['account_name'];
                                                    	}
                                                	    
                                                	    $payment_history_count++;
                                                        ?>
                                                        <tr>
                                                            <td><?php echo date('d/m/Y H:i:s', strtotime($row_payment_history['process_date'])); ?></td>
                                                            <td>
                                                                <?php 
                                                                if($row_payment_history['pay_type'] == 'deposit')
                                                                {
                                                                    echo "Booking Deposit"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'balance' || $row_payment_history['pay_type'] == 'balance ' || $row_payment_history['pay_type'] == 'Balance')
                                                                {
                                                                    echo "Booking Balance"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'deposit_adjustment')
                                                                {
                                                                    echo "Booking Deposit Adjustment"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'dc_charge')
                                                                {
                                                                    echo "Datechange"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'Datechange')
                                                                {
                                                                    echo "Datechange"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'additional_payment')
                                                                {
                                                                    echo "Additional Payment"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'other')
                                                                {
                                                                    echo "Other"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'Refund')
                                                                {
                                                                    echo "Refund"; 
                                                                }
                                                                else
                                                                {
                                                                    echo "Unknown"; 
                                                                }
                                                                ?>
                                                            </td>
                                                            <td><?php echo $row_payment_history['trams_received_amount']; ?></td>
                                                            <td><?php echo $row_payment_history['reference_no']; ?></td>
                                                            <td><?php echo $row_payment_history['trams_remarks']; ?></td>
                                                            <td><?php echo $bank_account_type_name; ?></td> 
                                                            <td><?php 
                                                            if($row_payment_history['cleared_date'] != '')
                                                            {
                                                                echo 'Confirmed on '. $row_payment_history['cleared_date'];
                                                            }
                                                            else
                                                            {
                                                                echo 'Pending';
                                                            }
                                                            ?></td> 
                                                            <?php
                                                            if($row_payment_history['cleared_date'] != '' && ($currnt_userlogn == 'joyce' || $currnt_userlogn == 'lee' ))
                                                            {
                                                                echo '<td><a target="_blank" href="?option=amount-adjustment&id='.$row_payment_history['auto_id'].'">Adjustment</a></td>';
                                                            }
                                                            ?>
                                                        </tr>
                                                        <?php
                                                	}
                                            	}
                                            	else
                                        		{
                                        		    echo '<td colspan="7">No record found</td>';
                                        		}
                                            	?>
                                            </table>
                                            
                                            <h6>Other Payment</h6>
                                        	<table style="font-size:13px;">
                                                <tr>
                                                    <th>Payment Date</th><th>Type</th><th>Paid Amount</th><th>Reference No</th><th>Remark</th><th>Method</th><th>Status</th><?php if($currnt_userlogn == 'joyce' || $currnt_userlogn == 'lee' ) { echo '<th></th>'; } ?>
                                                </tr>
                                            	<?php
                                                $query_payment_history = "SELECT * FROM wpk4_backend_travel_payment_history where order_id='$order_id_api' AND order_id != '' AND pay_type IN ('dc_charge', 'Datechange', 'additional_payment', 'other') order by process_date desc";
                                            	$result_payment_history = mysqli_query($mysqli, $query_payment_history);
                                            	if(mysqli_num_rows($result_payment_history) > 0)
                                            	{
                                                	while($row_payment_history = mysqli_fetch_assoc($result_payment_history))
                                                	{
                                                	    
                                                	    $payment_identifier = $row_payment_history['process_date'].'^'.$row_payment_history['trams_received_amount'].'^'.$row_payment_history['reference_no']; // defined value to restric duplicate amount + ref no combination on G360
                                    					if (in_array($payment_identifier, $processedPayments)) 
                                    					{
                                    					   continue; // Skip to the next value
                                    					}
                                    							
                                    					$processedPayments[] = $payment_identifier;
                                    					
                                                	    $current_pay_method_id = $row_payment_history['payment_method'];
                                                	    $query_payment_method_finder = "SELECT * FROM wpk4_backend_accounts_bank_account where bank_id='$current_pay_method_id'";
                                                    	$result_payment_method_finder = mysqli_query($mysqli, $query_payment_method_finder);
                                                    	$row_payment_method_finder = mysqli_fetch_assoc($result_payment_method_finder);
                                                    	$row_payment_method_finder_count = mysqli_num_rows($result_payment_method_finder);
                                                    	$bank_account_type_name = '';
                                                    	if($row_payment_method_finder_count > 0)
                                                    	{
                                                    	    $bank_account_type_name = $row_payment_method_finder['account_name'];
                                                    	}
                                                	    
                                                        ?>
                                                        <tr>
                                                            <td><?php echo date('d/m/Y H:i:s', strtotime($row_payment_history['process_date'])); ?></td>
                                                            <td>
                                                                <?php 
                                                                if($row_payment_history['pay_type'] == 'deposit')
                                                                {
                                                                    echo "Booking Deposit"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'balance' || $row_payment_history['pay_type'] == 'balance ' || $row_payment_history['pay_type'] == 'Balance')
                                                                {
                                                                    echo "Booking Balance"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'deposit_adjustment')
                                                                {
                                                                    echo "Booking Deposit Adjustment"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'dc_charge')
                                                                {
                                                                    echo "Datechange"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'Datechange')
                                                                {
                                                                    echo "Datechange"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'additional_payment')
                                                                {
                                                                    echo "Additional Payment"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'other')
                                                                {
                                                                    echo "Other"; 
                                                                }
                                                                else if($row_payment_history['pay_type'] == 'Refund')
                                                                {
                                                                    echo "Refund"; 
                                                                }
                                                                else
                                                                {
                                                                    echo "Unknown"; 
                                                                }
                                                                ?>
                                                            </td>
                                                            <td><?php echo $row_payment_history['trams_received_amount']; ?></td>
                                                            <td><?php echo $row_payment_history['reference_no']; ?></td>
                                                            <td><?php echo $row_payment_history['trams_remarks']; ?></td>
                                                            <td><?php echo $bank_account_type_name; ?></td> 
                                                            <td><?php 
                                                            if($row_payment_history['cleared_date'] != '')
                                                            {
                                                                echo 'Confirmed on '. $row_payment_history['cleared_date'];
                                                            }
                                                            else
                                                            {
                                                                echo 'Pending';
                                                            }
                                                            ?></td> 
                                                            <?php
                                                            if($row_payment_history['cleared_date'] != '' && ($currnt_userlogn == 'joyce' || $currnt_userlogn == 'lee' ))
                                                            {
                                                                echo '<td><a target="_blank" href="?option=amount-adjustment&id='.$row_payment_history['auto_id'].'">Adjustment</a></td>';
                                                            }
                                                            ?>
                                                        </tr>
                                                        <?php
                                                	}
                                            	}
                                            	else
                                        		{
                                        		    echo '<td colspan="7">No record found</td>';
                                        		}
                                            	?>
                                        	</table>
                                            <?php
                                        }
                                    	
                                    	if($order_type_paymentblock == 'gds' && $payment_history_count == 0)
                                    	{
                                        	$query_payment_history_meta = "SELECT * FROM wpk4_backend_history_of_updates where type_id='$order_id_api' && meta_key = 'Payments Amount'";
                                        	$result_payment_history_meta = mysqli_query($mysqli, $query_payment_history_meta);
                                        	while($row_payment_history_meta = mysqli_fetch_assoc($result_payment_history_meta))
                                        	{
                                        	    ?>
                                                <tr><td><?php echo $booking_date_dmy; ?></td><td></td><td><?php echo $row_payment_history_meta['meta_value']; ?></td><td></td></tr>
                                                <?php
                                        	}
            		                    }
                                    	?>
                                    
                                    <h5 style="font-size:14px;">Remark</h5>
                                    <?php
                                    $query_chat_call_out_remarks = "SELECT * FROM wpk4_backend_travel_payment_conversations 		
            							where order_id='$order_id_api' && msg_type = 'call_out_remarks' order by updated_on desc limit 1";
            							$result_chat_call_out_remarks = mysqli_query($mysqli, $query_chat_call_out_remarks) or die(mysqli_error($mysqli));
            							$row_chat_call_out_remarks = mysqli_fetch_assoc($result_chat_call_out_remarks);
            							$call_out_remarks ='';
                                        if(mysqli_num_rows($result_chat_call_out_remarks) > 0)
                                        {
                                            $call_out_remarks = $row_chat_call_out_remarks['message'];
                                        }
                					    echo $call_out_remarks;
                                    ?>
                                    
                                    <form action="#" name="statusupdate" method="post" enctype="multipart/form-data" >
                        		    <h6>Attachments</h6>
                        		    <?php
                        		    $query_all_refunds_latest_chat = "SELECT * FROM wpk4_backend_travel_booking_update_history where order_id = '$order_id_api' && co_order_id = '$co_order_id_api' && merging_id = '$product_id_api' && meta_key like 'G360Events' && meta_value like 'g360paymentattachments' order by auto_id desc";
                            		$result_all_refunds_latest_chat = mysqli_query($mysqli, $query_all_refunds_latest_chat);
                            		$row_all_refunds_latest_chat_count = mysqli_num_rows($result_all_refunds_latest_chat);
                            		if($row_all_refunds_latest_chat_count > 0)
                            		{
                            		    ?>
                            		    <table style="font-size:13px;">
                        		        <tr><td width="70%">Attachment</td><td>Date uploaded</td><td>Updated by</td></tr>
                        		        <?php
                                		while($row_all_refunds_latest_chat = mysqli_fetch_assoc($result_all_refunds_latest_chat))
                                		{
                                		    $payment_file_extension = pathinfo($row_all_refunds_latest_chat['meta_key_data'], PATHINFO_EXTENSION);
                                		    if($payment_file_extension == 'pdf' || $payment_file_extension == 'txt')
                                		    {
                                		        echo '<tr><td><a target="_blank" href="https://gauratravel.com.au/wp-content/uploads/customized_function_uploads/'.$row_all_refunds_latest_chat['meta_key_data'].'">'.$row_all_refunds_latest_chat['meta_key_data'].'</a></td><td>'.$row_all_refunds_latest_chat['updated_time'].'</td><td>'.$row_all_refunds_latest_chat['updated_user'].'</td></tr>';
                                		    }
                                		    else
                                		    {
                                		        echo '<tr><td><a target="_blank" href="https://gauratravel.com.au/wp-content/uploads/customized_function_uploads/'.$row_all_refunds_latest_chat['meta_key_data'].'"><img src="https://gauratravel.com.au/wp-content/uploads/customized_function_uploads/'.$row_all_refunds_latest_chat['meta_key_data'].'" style="width:200px;"></a></td><td>'.$row_all_refunds_latest_chat['updated_time'].'</td><td>'.$row_all_refunds_latest_chat['updated_user'].'</td></tr>';
                                		    }
                                		}
                                		?>
                                		</table>
                                		<?php
                            		}
                            		else
                            		{
                            		    echo 'No attachment found';
                            		}
                            		?>
                            		<h6>Add Attachment</h6>
                        		    
                            		</br></br>
                            		<style>
                            		    .myattachmentchat_g360
                            		    {
                            		        display:block;
                            		    }
                            		</style>
                            		Attachment Type
                            		<select style="width:100%; padding:10px;" name="upload_type" id="upload_type">
                                	    <option disalbed selected value=''>Select</option>
                                	    <option value='bpay_receipt'>BPAY Receipt</option>
                                	    <option value='other'>Other</option>
                                	</select>
                	                </br></br>
                            		Attachment
                            		<input type="file" accept=".jpg,.jpeg,.png,.pdf,.txt" class='myattachmentchat_g360' name="myattachmentchat" id="myattachmentchat"></br>
                            		<p style="font-size:11px;">Allowed file types are .jpg, .png, .pdf, .txt</p>
                    			    </br></br>
                    			    <center><input type='submit' name='updateattachment' id='updateattachment' class='btn btn-success' style='padding:15px; margin:0;font-size:11px;' value='Save'></center>
                    		    </form>	  
                    		    <?php
                    		    if(isset($_POST['updateattachment']))
                				{
                                    $upload_file_type = $_POST['upload_type'];
                                    if($_POST['upload_type'] != '')
                                    {
                    				    $type = 'g360paymentattachments'; //type
                    
                                        $fileName = $_FILES['myattachmentchat']['name'];
                                		$temp = explode(".", $_FILES["myattachmentchat"]["name"]);
                                		$ext = end((explode(".", $_FILES["myattachmentchat"]["name"])));
                                		$filename_time = date('ymdHis');
                                		$newfilename =  'g360paymentattachments_'. $filename_time . '.' .$ext;
                                	
                    
                                        $currentDirectory = getcwd();
                                		$uploadDirectory = "wp-content/uploads/customized_function_uploads/";
                                		$errors = []; // Store errors here
                                		$fileExtensionsAllowed = ['jpeg','jpg','png','pdf','JPEG','JPG','PNG','PDF','txt','TXT']; // These will be the only file extensions allowed 
                                						
                                		$fileSize = $_FILES['myattachmentchat']['size'];
                                		$fileTmpName  = $_FILES['myattachmentchat']['tmp_name'];
                                		$fileType = $_FILES['myattachmentchat']['type'];
                                		$fileExtension = strtolower(end(explode('.',$fileName)));
                                		$uploadPath = $uploadDirectory . basename($newfilename); 
                                						
                                		if (! in_array($fileExtension,$fileExtensionsAllowed)) {
                                			$errors[] = "This file extension is not allowed. Please upload a JPEG, PNG or PDF file";
                                			}
                                		if ($fileSize > 4000000) {
                                			$errors[] = "File exceeds maximum size (4MB)";
                                			 }
                                		if (empty($errors)) {
                                    		    $didUpload = move_uploaded_file($fileTmpName, $uploadPath);
                                    			if ($didUpload) {
                                    			//echo "The file has been uploaded";
                                    		} else {
                                    			echo "An error occurred. Please contact the Admin.";
                                    		}
                                		} else {
                                				foreach ($errors as $error) {
                                				echo $error . "" . "\n";
                                			}
                                		}
                                		
                                		if($_POST['upload_type'] == 'bpay_receipt')
                                		{
                                		    $type2 = 'bpay_receipt_awaiting_approval';
                                		    
                                		    $sql_subpayment_store ="UPDATE wpk4_backend_travel_bookings
                                                    SET sub_payment_status = 'BPAY Received'
                                                WHERE order_id='$order_id_api'";
                                            $results_subpayment_store = $wpdb->query($sql_subpayment_store);
                                            
                                		    add_g360_event_history($order_id_api, $co_order_id_api, $product_id_api, $type2, $newfilename , $currnt_userlogn, $current_date_and_time);
                                		}
                                        add_g360_event_history($order_id_api, $co_order_id_api, $product_id_api, $type, $newfilename , $currnt_userlogn, $current_date_and_time);
                                    	
                                                        
                                        $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                        echo '<script>window.location.href="'.$current_url.'";</script>';
                				    }
                				}
                				?>
                				</div>
                				
                				<div id="refunds_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                				    <?php
                				    $order_id = $order_id_api;
                				    $query_refund_order = "SELECT * FROM wpk4_backend_travel_payment_refunds where order_id='$order_id_api'";
                                	$result_refund_order = mysqli_query($mysqli, $query_refund_order) or die(mysqli_error($mysqli));
                                	$row_refund_order_count = mysqli_num_rows($result_refund_order);
                                	
                                    
                				    ?>
                				    <table style="font-size:13px;">
                                        
                                        <?php
                                        if($row_refund_order_count > 0)
                                    	{
                                    	    echo '<tr><th>Refund ID</th><th>Created On</th><th>Case Status</th><th></th></tr>';
                                    	    while($row_refund_order = mysqli_fetch_assoc($result_refund_order))
                                    	    {
                                                ?>
                                                <tr>
                                                    <td><?php echo $row_refund_order['refund_id']; ?></td>
                                                    <td><?php echo date('d/m/Y H:i:s', strtotime($row_refund_order['created_on'])); ?></td>
                                                    <td><?php echo $row_refund_order['case_status']; ?></td>
                                                    <td><a href='https://gauratravel.com.au/manage-refunds/?option=show-refund-request&id=<?php echo $row_refund_order['refund_id']; ?>' target="_blank">View</a></td>
                                                </tr>
                                                <?php
                                    	    }
                                    	}
                                    	else
                                    	{
                                        	?>
                                            <tr><td colspan='4'>No record found.</td></tr>
                                            <?php
                                    	}
                                    	
                                    	?>
                                    </table>
                				</div>
                				
                				<div id="portal_request_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                                        <?php
                                        $order_id = $order_id_api;
                                        
                                        $array_pax_pnr = array();
                                        $query_summary_loop_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id'";
                                		$result_loop_pax = mysqli_query($mysqli, $query_summary_loop_pax) or die(mysqli_error($mysqli));
                                    	while($row_loop_pax = mysqli_fetch_assoc($result_loop_pax))
                                    	{
                                    	    $array_pax_pnr[] = $row_loop_pax['pnr'];
                                    	}
                                    	$array_pax_pnr = array_unique($array_pax_pnr);		        
                                    	$array_pax_pnr_separated = implode(", ", $array_pax_pnr);

                                        $query_task_history = "SELECT * FROM wpk4_backend_user_portal_requests where reservation_ref != '' AND (reservation_ref='$order_id_api' OR reservation_ref IN ('$array_pax_pnr_separated'))";
                                    	$result_task_history = mysqli_query($mysqli, $query_task_history) or die(mysqli_error($mysqli));
                        				$count_task_history_userportal = mysqli_num_rows($result_task_history);
                        				
                        				if($count_task_history_userportal > 0)
                        				{
                        					?>
                        					<h5>Portal Requests <span class="badge badge-primary"><?php echo $count_task_history_userportal; ?></span></h5>
                        					<table style="font-size:13px;">
                        						<tr><th>CaseID</th><th>Task Type</th><th>Initiated on</th><th>Status</th><th>DC Payment Status</th><th>&nbsp;</th></tr>
                        						<?php
                        						while($row_task_history_user = mysqli_fetch_assoc($result_task_history))
                        						{
                        							//$task_order_id = $row_task_history_user['order_id'];
                        							$task_case_type = $row_task_history_user['case_type'];
                        							$case_date = $row_task_history_user['case_date'];
                        								$case_id = $row_task_history_user['case_id'];
                        							$gstatus = $row_task_history_user['status'];
                        						    $enc_pws = md5($case_id); 
                        						    
                        						    $query_dc_pay_status = "SELECT * FROM wpk4_backend_travel_booking_custom_payments where case_id = '$case_id'";
                                                	$result_dc_pay_status = mysqli_query($mysqli, $query_dc_pay_status);
                                    				$count_dc_pay_status = mysqli_fetch_assoc($result_dc_pay_status);
                                    				$dc_payment_status = '';
                                    				if(mysqli_num_rows($result_dc_pay_status) > 0)
                                    				{
                        						        $dc_payment_status = $count_dc_pay_status['status'];
                                    				}
                                    				
                            						if($task_case_type == 'datechange')  // for DC Azupay button
                            						{
                            						    ?>
                            						    <tr><td><?php echo $case_id; ?></td><td><?php echo $task_case_type; ?></td><td><?php echo $case_date; ?></td><td><?php echo $gstatus; ?></td><td><?php echo $dc_payment_status; ?></td><td>
                            						        <a target="_blank" href="/customer-portal/?p=admin-request-view&id=<?php echo $case_id; ?>&co=<?php echo $enc_pws; ?>&t=&casetype=<?php echo $task_case_type; ?>">View</a></br>
                            						        <?php
                            						        //if( current_user_can( 'administrator' ) || current_user_can( 'ho_operations' )) 
                            						        {
                                						        ?>
                                						        <a onclick="openCity(event, 'azupaydc_request_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">Request Payment</a>
                                						        <?php 
                            						        }
                            						        ?>
                            						    </td></tr>
                            						    <?php
                            						    
                            						}
                            						else
                            						{
                            						    ?>
                            						    <tr><td><?php echo $case_id; ?></td><td><?php echo $task_case_type; ?></td><td><?php echo $case_date; ?></td><td><?php echo $gstatus; ?></td><td>&nbsp;</td><td>
                            						        <a target="_blank" href="/customer-portal/?p=admin-request-view&id=<?php echo $case_id; ?>&co=<?php echo $enc_pws; ?>&t=&casetype=<?php echo $task_case_type; ?>">View</a></td></tr>
                            						    <?php
                            						}   
                        						}
                        						?>
                        					</table>
                        					<?php
                        				}
                        				else
                        				{
                        				    
                        					echo '<h5>Customer Portal Requests</h5>
                        					    No task created';
                        				}
                        				
                        				
                        				$query_initial_order = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api'";
                                    	$result_initial_order = mysqli_query($mysqli, $query_initial_order);
                                    	$row_initial_order = mysqli_fetch_assoc($result_initial_order);
                                        $order_date = $row_initial_order['order_date'];
                                        $payment_status = $row_initial_order['payment_status'];
                                        $late_modified = $row_initial_order['late_modified'];
                                        $modified_by = $row_initial_order['modified_by'];
                                        $payment_modified = $row_initial_order['payment_modified'];
                                        $payment_modified_by = $row_initial_order['payment_modified_by'];
                                        $total_amount = $row_initial_order['total_amount'];
                                        $balance = $row_initial_order['balance'];
                                    ?>
                                    <div style="font-size:13px;">
                                       
                        				
                                        <?php
                                        $query_task_history = "SELECT * FROM wpk4_backend_todo_tasks where order_id='$order_id_api' order by comment_type, comment_date_time";
                                    	$result_task_history = mysqli_query($mysqli, $query_task_history);
                        				$count_task_history = mysqli_num_rows($result_task_history);
                        				if($count_task_history > 0)
                        				{
                        					?>
                        					<h5>Task History <span class="badge badge-primary"><?php echo $count_task_history; ?></span></h5>
                        					<table style="font-size:13px;">
                        						<tr><th>Task Type</th><th>Initiated on</th><th>By</th><th>Status</th><th>Link</th></tr>
                        						<?php
                        						while($row_task_history = mysqli_fetch_assoc($result_task_history))
                        						{
                        							$task_order_id = $row_task_history['order_id'];
                        							$task_product_id = $row_task_history['product_id'];
                        						?>
                        						<tr><td><?php echo $row_task_history['comment_type']; ?></td><td><?php echo $row_task_history['comment_date_time']; ?></td><td><?php echo $row_task_history['comment_by']; ?></td><td><?php echo $row_task_history['status']; ?></td><td><a href="?option=todo&id=<?php echo $task_order_id; ?>&product_i=<?php echo $task_product_id; ?>&co_orderid=&type=<?php echo $row_task_history['comment_type']; ?>">View</a></td></tr>
                        						<?php
                        						}
                        						?>
                        					</table>
                        					<?php
                        				}
                        				else
                        				{
                        				    echo '<h5>Task History</h5>';
                        					echo 'No task created';
                        				}
                                    	
                                    	?>
                				    
                				    </div>
                				</div>
                				
								<div id="ssr_request_v1_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                				    
                				    <?php
                                        $order_id = $order_id_api;
                                        
                                        $query_task_history = "SELECT * FROM wpk4_backend_user_portal_requests where reservation_ref='$order_id_api' && case_type = 'ssr_request'";
                                    	$result_task_history = mysqli_query($mysqli, $query_task_history);
                        				$count_task_history_userportal = mysqli_num_rows($result_task_history);
                        				if($count_task_history_userportal > 0)
                        				{
                        					?>
                        					<h6>Previous Requests</span></h6>
                        					<table style="font-size:13px;">
                        						<tr><th>CaseID</th><th>Task Type</th><th>Pax</th><th>Initiated on</th><th>Status</th><th>&nbsp;</th></tr>
                        						<?php
                        						while($row_task_history_user = mysqli_fetch_assoc($result_task_history))
                        						{
                        							//$task_order_id = $row_task_history_user['order_id'];
                        							$task_case_type = $row_task_history_user['case_type'];
                        							$case_date = $row_task_history_user['case_date'];
                        								$case_id = $row_task_history_user['case_id'];
                        							$gstatus = $row_task_history_user['status'];
                        						    $enc_pws = md5($case_id); 
                        						    $pax_name_for_ssr = get_userportal_post_meta($case_id, "Passenger");
                        						?>
                        						<tr><td><?php echo $case_id; ?></td><td><?php echo $task_case_type; ?></td><td><?php echo $pax_name_for_ssr; ?></td>
                        						<td><?php echo $case_date; ?></td><td><?php echo $gstatus; ?></td>
                        						<td><a target="_blank" href="/customer-portal/?p=admin-request-view&id=<?php echo $case_id; ?>&co=<?php echo $enc_pws; ?>&t=&casetype=<?php echo $task_case_type; ?>">View</a></td></tr>
                        						
                        						<?php
                        						}
                        						?>
                        					</table>
                        					<?php
                        				}
                        				else
                        				{
                        				    
                        					echo '<h6>Previous Requests</h6>
                        					    No task created';
                        				}
                        				?>
                                    </br>
									
									<?php echo $smart_ssr_available_note; ?>
									
                                    <h6>Add Special Service Request</h6>
                                      <?php $order_id = $order_id_api; ?>
                                      <form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                      <table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
                                            <tr>
                                                <td>Passenger</td>
                                                <td>
                                                    <select name="pax_data_individual" required style="width:100%; padding:10px;">
                                                        <?php
                                                        $processedOrders = [];
                                                        $query_paxc = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id'";
                                        				$result_paxc = mysqli_query($mysqli, $query_paxc);
                                        				while($row_paxc = mysqli_fetch_assoc($result_paxc))
                                        				{
                                        				    $pax_name_selection = $row_paxc['fname'] . ' ' . $row_paxc['lname'];
                                        				    if (in_array($pax_name_selection, $processedOrders)) {
                            								    continue; 
                                							}
                                							
                                							$processedOrders[] = $pax_name_selection;
                                        				    echo '<option value="'. $pax_name_selection .'">'.$pax_name_selection.'</option>';
                                        				}
                                        				
                                        				$email_pax_ssr = '';
                                        				$query_pax_email = "SELECT billing_email FROM wpk4_backend_travel_bookings where order_id='$order_id' AND billing_email != ''";
                                    					$result_pax_email = mysqli_query($mysqli, $query_pax_email);
                                    					$row_pax_email = mysqli_fetch_assoc($result_pax_email);
                                    					if(mysqli_num_rows($result_pax_email) > 0)
                                    					{
                                                		    $email_pax_ssr = $row_pax_email['billing_email'];
                                    					}
                                    					// if email id is not found in booking table, then get from pax table.
                                    					if($email_pax_ssr == '')
                                    					{
                                    					    $query_pax_email = "SELECT email_pax FROM wpk4_backend_travel_booking_pax where order_id='$order_id' AND email_pax != ''";
                                    					    $result_pax_email = mysqli_query($mysqli, $query_pax_email);
                                    					    $row_pax_email = mysqli_fetch_assoc($result_pax_email);
                                    					    if(mysqli_num_rows($result_pax_email) > 0)
                                    					    {
                                    					        $email_pax_ssr = $row_pax_email['email_pax'];
                                    					    }
                                    					}
                                    					
                                                		$phone_pax_ssr = '';
                                                		$query_pax_phone = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id' AND phone_pax != ''";
                                    					$result_pax_phone = mysqli_query($mysqli, $query_pax_phone);
                                    					$row_pax_phone = mysqli_fetch_assoc($result_pax_phone);
                                    					if(mysqli_num_rows($result_pax_phone) > 0)
                                    					{
                                                		    $phone_pax_ssr = $row_pax_phone['phone_pax'];
                                                        }
                                                        ?>
                                                    </select>
                                                    <input type="hidden" name="emailid_pax" value="<?php echo $email_pax_ssr; ?>">
                                                    <input type="hidden" name="phonenum_pax" value="<?php echo $phone_pax_ssr; ?>">
                                                </td>
                                            </tr>
                                			<tr>
                                				<td>Bassinet</td>
                                				<td><input type="checkbox" id="bassinet" name="bassinet" value="yes">
                                                        <label for="bassinet"> Yes</label><br></td>
                                			</tr>
                                			<tr>
                                				<td>Meet and Greet Assistants</td>
                                				<td><input type="checkbox" id="meetandgreetassistants" name="meetandgreetassistants" value="yes">
                                                        <label for="meetandgreetassistants"> Yes</label><br></td>
                                			</tr>
                                			<tr>
                                				<td>Sent eticketing</td>
                                				<td><input type="checkbox" id="senteticketing" name="senteticketing" value="yes">
                                                        <label for="senteticketing"> Yes</label><br></td>
                                			</tr>
                                			<tr>
                                				<td>Baggage</td>
                                				<td>
                                				    <table style='padding:0; margin:0; border:0;'>
                                				        <tr style='padding:0; margin:0; border:0;'>
                                				            <td style='padding:0; margin:0; border:0; width:15%;'>
                                				                <input type="checkbox" id="baggage" name="baggage" value="yes">
                                                                <label for="baggage"> Yes</label>
                                				            </td>
                                				            <td style='padding:0; margin:0; border:0;'>
                                				                <input type='text' name="baggage_weight" placeholder="Baggage Weight in Kg">
                                				            </td>
                                				        </tr>
                                				    </table>
                                                    
                                                </td>
                                			</tr>
                                			<tr>
                                				<td>Assigned to</td>
                                				<td>
                                                    <select name="assigned_team" required style="width:100%; padding:10px;">
                                                        <option value="BOM Ticketing">BOM Ticketing</option>
                                                        <option value="HO Ticketing">HO Ticketing</option>
                                                    </select>
                                                </td>
                                			</tr>
                                			<tr>
                                			    <td colspan='2'><center><input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='save_ssr_request_v1' value='Save Request'></center></td>
                                			</tr>
                                		</table>
                                		</form>
                                    <?php
                                    if(isset($_POST['save_ssr_request_v1']))
                                    {
                                        $pax_data_individual = $_POST['pax_data_individual'];
                                        $emailid_pax = $_POST['emailid_pax'];
                                        $phonenum_pax = $_POST['phonenum_pax'];
                                        
                                        if(isset($_POST['senteticketing']))
                                        {
                                            $senteticketing = $_POST['senteticketing'];
                                        }
                                        else
                                        {
                                            $senteticketing = '';
                                        }
                                        
                                        if(isset($_POST['meetandgreetassistants']))
                                        {
                                            $meetandgreetassistants = $_POST['meetandgreetassistants'];
                                        }
                                        else
                                        {
                                            $meetandgreetassistants = '';
                                        }
                                        
                                        if(isset($_POST['wheelchair']))
                                        {
                                            $wheelchair = $_POST['wheelchair'];
                                        }
                                        else
                                        {
                                            $wheelchair = '';
                                        }
                                        
                                        if(isset($_POST['bassinet']))
                                        {
                                            $bassinet = $_POST['bassinet'];
                                        }
                                        else
                                        {
                                            $bassinet = '';
                                        }
                                        
                                        if(isset($_POST['seatingplace']))
                                        {
                                            $seatingplace = $_POST['seatingplace'];
                                        }
                                        else
                                        {
                                            $seatingplace = '';
                                        }
                                        
                                        if(isset($_POST['mealselection']))
                                        {
                                            $mealselection = $_POST['mealselection'];
                                        }
                                        else
                                        {
                                            $mealselection = '';
                                        }
                                        
                                        if(isset($_POST['baggage']))
                                        {
                                            $baggage = $_POST['baggage'];
                                        }
                                        else
                                        {
                                            $baggage = '';
                                        }
                                        
                                        $assigned_team = $_POST['assigned_team'];
                                        
                                        $query_count = "SELECT * FROM wpk4_backend_user_portal_requests ORDER BY case_id DESC LIMIT 1";
            							$result_count = mysqli_query($mysqli, $query_count);
            							$row_count_assoc = mysqli_fetch_assoc($result_count);
            							$row_count = mysqli_num_rows($result_count);
            							if($row_count>0)
            							{
            								$case_id = intval($row_count_assoc['case_id']);
            								$case_id = $case_id+1;
            							}
            							else
            							{
            								$case_id = '1';
            							}
							            add_userportal_post_meta($case_id, 'Order', $order_id);
							            add_userportal_post_meta($case_id, 'email', $emailid_pax);
							            add_userportal_post_meta($case_id, 'phone number', $phonenum_pax);
							            add_userportal_post_meta($case_id, 'assigned_to', $assigned_team);
							            add_userportal_post_meta($case_id, 'Passenger', $pax_data_individual);
                                        add_userportal_post_meta($case_id, 'meal_selection', $mealselection);
                                        add_userportal_post_meta($case_id, 'seating_place', $seatingplace);
                                        add_userportal_post_meta($case_id, 'bassinet', $bassinet);
                                        add_userportal_post_meta($case_id, 'wheelchair', $wheelchair);
                                        add_userportal_post_meta($case_id, 'meet_and_greet_assistants', $meetandgreetassistants);
                                        add_userportal_post_meta($case_id, 'sent_eticketing', $senteticketing);
                                        
                                        add_userportal_post_meta($case_id, 'baggage', $baggage);
                                        if($baggage != '')
                                        {
                                            $baggage_weight = $_POST['baggage_weight'];
                                            add_userportal_post_meta($case_id, 'baggage_required', $baggage_weight);
                                        }
                                        
                                        add_g360_event_history($order_id_api, $co_order_id_api, $product_id_api, 'SSR submitted', "", $currnt_userlogn, $current_date_and_time);
                                        
                                        $current_date_time = date("Y-m-d H:i:s");
                                         
                                        mysqli_query($mysqli,"insert into wpk4_backend_user_portal_requests (case_id, case_type, reservation_ref, last_response_by, last_response_on, is_seen_by_gt, user_id, status, case_date, priority) 
							            values ('$case_id','ssr_request','$order_id_api' ,'customer' ,'$current_date_time' ,'0' ,'$currnt_userlogn' ,'open' ,'$current_date_time' ,'P4')") or die(mysqli_error($mysqli));
							            
							            $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                    	echo '<script>window.location.href="'.$current_url.'";</script>';
                                    }
                                    ?>
                				</div>
								
                				<div id="ssr_request_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                				    
                				    <?php
                                        $order_id = $order_id_api;
                                        
                                        $query_task_history = "SELECT * FROM wpk4_backend_user_portal_requests where reservation_ref='$order_id_api' && case_type = 'ssr_request'";
                                    	$result_task_history = mysqli_query($mysqli, $query_task_history);
                        				$count_task_history_userportal = mysqli_num_rows($result_task_history);
                        				if($count_task_history_userportal > 0)
                        				{
                        					?>
                        					<h6>Previous Requests</span></h6>
                        					<table style="font-size:13px;">
                        						<tr><th>CaseID</th><th>Task Type</th><th>Pax</th><th>Initiated on</th><th>Status</th><th>&nbsp;</th></tr>
                        						<?php
                        						while($row_task_history_user = mysqli_fetch_assoc($result_task_history))
                        						{
                        							//$task_order_id = $row_task_history_user['order_id'];
                        							$task_case_type = $row_task_history_user['case_type'];
                        							$case_date = $row_task_history_user['case_date'];
                        								$case_id = $row_task_history_user['case_id'];
                        							$gstatus = $row_task_history_user['status'];
                        						    $enc_pws = md5($case_id); 
                        						    $pax_name_for_ssr = get_userportal_post_meta($case_id, "Passenger");
                        						?>
                        						<tr><td><?php echo $case_id; ?></td><td><?php echo $task_case_type; ?></td><td><?php echo $pax_name_for_ssr; ?></td>
                        						<td><?php echo $case_date; ?></td><td><?php echo $gstatus; ?></td>
                        						<td><a target="_blank" href="/customer-portal/?p=admin-request-view&id=<?php echo $case_id; ?>&co=<?php echo $enc_pws; ?>&t=&casetype=<?php echo $task_case_type; ?>">View</a></td></tr>
                        						
                        						<?php
                        						}
                        						?>
                        					</table>
                        					<?php
                        				}
                        				else
                        				{
                        				    
                        					echo '<h6>Previous Requests</h6>
                        					    No task created';
                        				}
                        				?>
                                    </br>
									<?php echo $smart_ssr_available_note; ?>
									<?php
									if($is_smart_ssr_available == 0)
									{
										?>
                                    <h6>Add Special Service Request</h6>
                                      <?php $order_id = $order_id_api; ?>
                                      <form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                      <table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
                                            <tr>
                                                <td>Passenger</td>
                                                <td>
                                                    <select name="pax_data_individual" required style="width:100%; padding:10px;">
                                                        <?php
                                                        $processedOrders = [];
                                                        $query_paxc = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id'";
                                        				$result_paxc = mysqli_query($mysqli, $query_paxc);
                                        				while($row_paxc = mysqli_fetch_assoc($result_paxc))
                                        				{
                                        				    $pax_name_selection = $row_paxc['fname'] . ' ' . $row_paxc['lname'];
                                        				    if (in_array($pax_name_selection, $processedOrders)) {
                            								    continue; 
                                							}
                                							
                                							$processedOrders[] = $pax_name_selection;
                                        				    echo '<option value="'. $pax_name_selection .'">'.$pax_name_selection.'</option>';
                                        				}
                                        				
                                        				$email_pax_ssr = '';
                                        				$query_pax_email = "SELECT billing_email FROM wpk4_backend_travel_bookings where order_id='$order_id' AND billing_email != ''";
                                    					$result_pax_email = mysqli_query($mysqli, $query_pax_email);
                                    					$row_pax_email = mysqli_fetch_assoc($result_pax_email);
                                    					if(mysqli_num_rows($result_pax_email) > 0)
                                    					{
                                                		    $email_pax_ssr = $row_pax_email['billing_email'];
                                    					}
                                    					// if email id is not found in booking table, then get from pax table.
                                    					if($email_pax_ssr == '')
                                    					{
                                    					    $query_pax_email = "SELECT email_pax FROM wpk4_backend_travel_booking_pax where order_id='$order_id' AND email_pax != ''";
                                    					    $result_pax_email = mysqli_query($mysqli, $query_pax_email);
                                    					    $row_pax_email = mysqli_fetch_assoc($result_pax_email);
                                    					    if(mysqli_num_rows($result_pax_email) > 0)
                                    					    {
                                    					        $email_pax_ssr = $row_pax_email['email_pax'];
                                    					    }
                                    					}
                                    					
                                                		$phone_pax_ssr = '';
                                                		$query_pax_phone = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id' AND phone_pax != ''";
                                    					$result_pax_phone = mysqli_query($mysqli, $query_pax_phone);
                                    					$row_pax_phone = mysqli_fetch_assoc($result_pax_phone);
                                    					if(mysqli_num_rows($result_pax_phone) > 0)
                                    					{
                                                		    $phone_pax_ssr = $row_pax_phone['phone_pax'];
                                                        }
                                                        ?>
                                                    </select>
                                                    <input type="hidden" name="emailid_pax" value="<?php echo $email_pax_ssr; ?>">
                                                    <input type="hidden" name="phonenum_pax" value="<?php echo $phone_pax_ssr; ?>">
                                                </td>
                                            </tr>
                                            <tr>
                                                <td width='25%'>Meal</td>
                                                <td>
                                                    <div class="radio-group">
                                                        <input class="ssr_request_radio_button" type="radio" id="veg" name="mealselection" value="vegetarian">
                                                        <label for="veg">Vegetarian</label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                        
                                                        <input class="ssr_request_radio_button" type="radio" id="vegan" name="mealselection" value="vegan">
                                                        <label for="vegan">Vegan</label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                        
                                                        <input class="ssr_request_radio_button" type="radio" id="jain" name="mealselection" value="jain">
                                                        <label for="jain">Jain</label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                        
                                                        <input class="ssr_request_radio_button" type="radio" id="non-vegetarian" name="mealselection" value="non vegetarian">
                                                        <label for="non-vegetarian">Non Vegetarian</label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                        
                                                        <input class="ssr_request_radio_button" type="radio" id="muslim-meal" name="mealselection" value="muslim meal">
                                                        <label for="muslim-meal">Muslim meal</label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                        
                                                        <input class="ssr_request_radio_button" type="radio" id="child-meal" name="mealselection" value="child meal">
                                                        <label for="child-meal">Child meal</label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                        
                                                        <input class="ssr_request_radio_button" type="radio" id="baby-meal" name="mealselection" value="baby meal">
                                                        <label for="baby-meal">Baby meal</label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                                    </div>
                                                </td>
                                            </tr>
                                			<tr>
                                				<td>Seat</td>
                                				<td>
                                				        <div class="radio-group">
                                				            <input class="ssr_request_radio_button" type="radio" id="windowseat" name="seatingplace" value="window seat"><label for="windowseat"> Window Seat</label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                				            <input class="ssr_request_radio_button" type="radio" id="aisleseat" name="seatingplace" value="aisle seat"><label for="aisleseat"> Aisle Seat</label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                				        </div>
                                                </td>
                                			</tr>
                                			<tr>
                                				<td>Bassinet</td>
                                				<td><input type="checkbox" id="bassinet" name="bassinet" value="yes">
                                                        <label for="bassinet"> Yes</label><br></td>
                                			</tr>
                                			<tr>
                                				<td>Wheelchair</td>
                                				<td><input type="checkbox" id="wheelchair" name="wheelchair" value="yes">
                                                        <label for="wheelchair"> Yes</label><br></td>
                                			</tr>
                                			<tr>
                                				<td>Meet and Greet Assistants</td>
                                				<td><input type="checkbox" id="meetandgreetassistants" name="meetandgreetassistants" value="yes">
                                                        <label for="meetandgreetassistants"> Yes</label><br></td>
                                			</tr>
                                			<tr>
                                				<td>Sent eticketing</td>
                                				<td><input type="checkbox" id="senteticketing" name="senteticketing" value="yes">
                                                        <label for="senteticketing"> Yes</label><br></td>
                                			</tr>
                                			<tr>
                                				<td>Baggage</td>
                                				<td>
                                				    <table style='padding:0; margin:0; border:0;'>
                                				        <tr style='padding:0; margin:0; border:0;'>
                                				            <td style='padding:0; margin:0; border:0; width:15%;'>
                                				                <input type="checkbox" id="baggage" name="baggage" value="yes">
                                                                <label for="baggage"> Yes</label>
                                				            </td>
                                				            <td style='padding:0; margin:0; border:0;'>
                                				                <input type='text' name="baggage_weight" placeholder="Baggage Weight in Kg">
                                				            </td>
                                				        </tr>
                                				    </table>
                                                    
                                                </td>
                                			</tr>
                                			<tr>
                                				<td>Assigned to</td>
                                				<td>
                                                    <select name="assigned_team" required style="width:100%; padding:10px;">
                                                        <option value="BOM Ticketing">BOM Ticketing</option>
                                                        <option value="HO Ticketing">HO Ticketing</option>
                                                    </select>
                                                </td>
                                			</tr>
                                			<tr>
                                			    <td colspan='2'><center><input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='save_ssr_request' value='Save Request'></center></td>
                                			</tr>
                                		</table>
                                		</form>
                                    <?php
                                    if(isset($_POST['save_ssr_request']))
                                    {
                                        $pax_data_individual = $_POST['pax_data_individual'];
                                        $emailid_pax = $_POST['emailid_pax'];
                                        $phonenum_pax = $_POST['phonenum_pax'];
                                        
                                        if(isset($_POST['senteticketing']))
                                        {
                                            $senteticketing = $_POST['senteticketing'];
                                        }
                                        else
                                        {
                                            $senteticketing = '';
                                        }
                                        
                                        if(isset($_POST['meetandgreetassistants']))
                                        {
                                            $meetandgreetassistants = $_POST['meetandgreetassistants'];
                                        }
                                        else
                                        {
                                            $meetandgreetassistants = '';
                                        }
                                        
                                        if(isset($_POST['wheelchair']))
                                        {
                                            $wheelchair = $_POST['wheelchair'];
                                        }
                                        else
                                        {
                                            $wheelchair = '';
                                        }
                                        
                                        if(isset($_POST['bassinet']))
                                        {
                                            $bassinet = $_POST['bassinet'];
                                        }
                                        else
                                        {
                                            $bassinet = '';
                                        }
                                        
                                        if(isset($_POST['seatingplace']))
                                        {
                                            $seatingplace = $_POST['seatingplace'];
                                        }
                                        else
                                        {
                                            $seatingplace = '';
                                        }
                                        
                                        if(isset($_POST['mealselection']))
                                        {
                                            $mealselection = $_POST['mealselection'];
                                        }
                                        else
                                        {
                                            $mealselection = '';
                                        }
                                        
                                        if(isset($_POST['baggage']))
                                        {
                                            $baggage = $_POST['baggage'];
                                        }
                                        else
                                        {
                                            $baggage = '';
                                        }
                                        
                                        $assigned_team = $_POST['assigned_team'];
                                        
                                        $query_count = "SELECT * FROM wpk4_backend_user_portal_requests ORDER BY case_id DESC LIMIT 1";
            							$result_count = mysqli_query($mysqli, $query_count);
            							$row_count_assoc = mysqli_fetch_assoc($result_count);
            							$row_count = mysqli_num_rows($result_count);
            							if($row_count>0)
            							{
            								$case_id = intval($row_count_assoc['case_id']);
            								$case_id = $case_id+1;
            							}
            							else
            							{
            								$case_id = '1';
            							}
							            add_userportal_post_meta($case_id, 'Order', $order_id);
							            add_userportal_post_meta($case_id, 'email', $emailid_pax);
							            add_userportal_post_meta($case_id, 'phone number', $phonenum_pax);
							            add_userportal_post_meta($case_id, 'assigned_to', $assigned_team);
							            add_userportal_post_meta($case_id, 'Passenger', $pax_data_individual);
                                        add_userportal_post_meta($case_id, 'meal_selection', $mealselection);
                                        add_userportal_post_meta($case_id, 'seating_place', $seatingplace);
                                        add_userportal_post_meta($case_id, 'bassinet', $bassinet);
                                        add_userportal_post_meta($case_id, 'wheelchair', $wheelchair);
                                        add_userportal_post_meta($case_id, 'meet_and_greet_assistants', $meetandgreetassistants);
                                        add_userportal_post_meta($case_id, 'sent_eticketing', $senteticketing);
                                        
                                        add_userportal_post_meta($case_id, 'baggage', $baggage);
                                        if($baggage != '')
                                        {
                                            $baggage_weight = $_POST['baggage_weight'];
                                            add_userportal_post_meta($case_id, 'baggage_required', $baggage_weight);
                                        }
                                        
                                        add_g360_event_history($order_id_api, $co_order_id_api, $product_id_api, 'SSR submitted', "", $currnt_userlogn, $current_date_and_time);
                                        
                                        $current_date_time = date("Y-m-d H:i:s");
                                         
                                        mysqli_query($mysqli,"insert into wpk4_backend_user_portal_requests (case_id, case_type, reservation_ref, last_response_by, last_response_on, is_seen_by_gt, user_id, status, case_date, priority) 
							            values ('$case_id','ssr_request','$order_id_api' ,'customer' ,'$current_date_time' ,'0' ,'$currnt_userlogn' ,'open' ,'$current_date_time' ,'P4')") or die(mysqli_error($mysqli));
							            
							            $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                    	echo '<script>window.location.href="'.$current_url.'";</script>';
                                    }
                                    ?>
									<?php
									}
									?>
                				</div>
                				
                				<div id="azupay_request_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                				    <!-- THIS REQUEST IS USED TO GET CUSTOM PAYMENTS FROM CUSTOMER FOR ANY REASON -->
                				    <?php
                                        $order_id = $order_id_api;
                                        
                                        $query_task_history = "SELECT * FROM wpk4_backend_user_portal_requests where reservation_ref='$order_id_api' && case_type = 'ssr_request'";
                                    	$result_task_history = mysqli_query($mysqli, $query_task_history);
                        				$count_task_history_userportal = mysqli_num_rows($result_task_history);
                        				if($count_task_history_userportal > 0)
                        				{
                        					?>
                        					<h6>Previous Requests</span></h6>
                        					<table style="font-size:13px;">
                        						<tr><th>CaseID</th><th>Task Type</th><th>Pax</th><th>Initiated on</th><th>Status</th><th>&nbsp;</th></tr>
                        						<?php
                        						while($row_task_history_user = mysqli_fetch_assoc($result_task_history))
                        						{
                        							//$task_order_id = $row_task_history_user['order_id'];
                        							$task_case_type = $row_task_history_user['case_type'];
                        							$case_date = $row_task_history_user['case_date'];
                        								$case_id = $row_task_history_user['case_id'];
                        							$gstatus = $row_task_history_user['status'];
                        						    $enc_pws = md5($case_id); 
                        						    $pax_name_for_ssr = get_userportal_post_meta($case_id, "Passenger");
                        						?>
                        						<tr><td><?php echo $case_id; ?></td><td><?php echo $task_case_type; ?></td><td><?php echo $pax_name_for_ssr; ?></td>
                        						<td><?php echo $case_date; ?></td><td><?php echo $gstatus; ?></td>
                        						<td><a target="_blank" href="/customer-portal/?p=admin-request-view&id=<?php echo $case_id; ?>&co=<?php echo $enc_pws; ?>&t=&casetype=<?php echo $task_case_type; ?>">View</a></td></tr>
                        						
                        						<?php
                        						}
                        						?>
                        					</table>
                        					<?php
                        				}
                        				else
                        				{
                        				    
                        					echo '<h6>Previous Requests</h6>
                        					    No task created';
                        				}
                        				?>
                                    </br>
                                    <h6>Add Azupay Request</h6>
                                      <?php $order_id = $order_id_api; ?>
                                      <form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                      <table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
                                            <?php
                                            
                                            $order_id = $order_id_api;
                				    $query_initial_order = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api'";
                                	$result_initial_order = mysqli_query($mysqli, $query_initial_order);
                                	$row_initial_order = mysqli_fetch_assoc($result_initial_order);
                                    $order_date = $row_initial_order['order_date'];
									$source_paymentblock = $row_initial_order['source'];
									
                                    $order_type_paymentblock = $row_initial_order['order_type'];
                                    $payment_status = $row_initial_order['payment_status'];
                                    $deposit_amount = '';
                                    
                                    // check whether there are existing Balance Payment
                                    $query_paymentrequest_history_check = "SELECT * FROM wpk4_backend_travel_booking_custom_payments where order_id='$order_id_api';";
                                	$result_paymentrequest_history_check = mysqli_query($mysqli, $query_paymentrequest_history_check);
                                	$count_paymentrequest_count_check = mysqli_num_rows($result_paymentrequest_history_check);
                                	$can_change_balance = true;
                                	$amount_list = [];
                                	while($row_paymentrequest_history_check = mysqli_fetch_assoc($result_paymentrequest_history_check)) {
                                	    if(isset($row_paymentrequest_history_check['type_of_payment']) && $row_paymentrequest_history_check['type_of_payment'] == 'Balance Payment') {
                                	        $can_change_balance = false;
                                	    }
                                	    if(isset($row_paymentrequest_history_check['type_of_payment']) && $row_paymentrequest_history_check['type_of_payment'] == 'Less Amount') {
                                	        $amount_list[] = $row_paymentrequest_history_check['amount'];
                                	    }
                                	}
                                    
                                    if($order_type_paymentblock != 'gds')
                                    {
                                        $total_amount = $row_initial_order['total_amount'];
                                        $deposit_amount = $row_initial_order['deposit_amount'];
                                        $balance = $row_initial_order['balance'];
                                        
                                        $wpt_coupon_code_array = get_post_meta($order_id_api, 'wp_travel_applied_coupon_data', true);
                                        if(isset($wpt_coupon_code_array) && $wpt_coupon_code_array != '' && isset($wpt_coupon_code_array['coupon_code']) && $wpt_coupon_code_array['coupon_code'] != '')
                                        {
                                            $ordertotal__query = $wpdb->get_results( "SELECT * FROM wpk4_postmeta where post_id='$order_id_api' && meta_key='order_totals'"); 
                                            foreach($ordertotal__query as $row_2){ 
                                                $order_total_amount = $row_2->meta_value;
                                            }
                                            $orderData = unserialize($order_total_amount);
                                            //$total_amount = $orderData['sub_total'];
                                            $balance = $total_amount - $deposit_amount;
                                        }
                                    }
                                    
                                    
                                    if($order_type_paymentblock == 'gds' && $deposit_amount == '')
                                    {
                                        $deposit_amount = $row_initial_order['deposit_amount'];
                                        $total_amount = get_meta_from_history_of_updates($order_id_api, 'Transaction TotalTurnover');
                                        
                                        if($deposit_amount == '')
                                        {
                                            
                                            $deposit_amount_temp = 0;
                                            $query_initial_order_meta = "SELECT * FROM wpk4_backend_history_of_updates where type_id='$order_id_api' && meta_key = 'Payments Amount'";
                                        	$result_initial_order_meta = mysqli_query($mysqli, $query_initial_order_meta);
                                        	while($row_initial_order_meta = mysqli_fetch_assoc($result_initial_order_meta))
                                        	{
                                        	    $deposit_amount_temp = $deposit_amount_temp + (float)$row_initial_order_meta['meta_value'];
                                        	}
                                    	    $deposit_amount = $deposit_amount_temp;
                                        }
                                        $balance = (float)$total_amount - (float)$deposit_amount;
                                    }
									if($source_paymentblock == 'datechange')
									{
										$total_amount = $row_initial_order['total_amount'];
                                        $total_amount_from_postmeta = $total_amount;
                                        //$deposit_amount = $row_initial_order['deposit_amount'];
                                        $balance = '';
									}
                                    
                            		$query_pnr_for_total_paid = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api'";
                                    $result_pnr_for_total_paid = mysqli_query($mysqli, $query_pnr_for_total_paid);
                                    $row_pnr_for_total_paid = mysqli_fetch_assoc($result_pnr_for_total_paid);
                                	$received_pnr_for_total_paid = $row_pnr_for_total_paid['pnr'];
                                	$processedPaymentsPaid = array();	
                            		$query_payment_paid_amount = "SELECT * FROM wpk4_backend_travel_payment_history where (pay_type = 'deposit' OR pay_type LIKE 'balance' 
                            		OR pay_type LIKE 'Balance' OR pay_type = 'deposit_adjustment' OR pay_type = 'Refund' OR pay_type = 'additional_payment') 
                            		AND order_id='$order_id_api' AND order_id != '' order by process_date desc";
                                    $result_payment_paid_amount = mysqli_query($mysqli, $query_payment_paid_amount);
                                    $total_paid_for_booking = 0;
                                    if($result_payment_paid_amount && mysqli_num_rows($result_payment_paid_amount) > 0)
                                    {
                                        while($row_payment_paid_amount = mysqli_fetch_assoc($result_payment_paid_amount))
                                        {
                                            $payment_identifier = $row_payment_paid_amount['process_date'].'^'.$row_payment_paid_amount['trams_received_amount'].'^'.$row_payment_paid_amount['reference_no']; // defined value to restric duplicate amount + ref no combination on G360
                                			if (in_array($payment_identifier, $processedPaymentsPaid)) 
                                			{
                                			    continue; // Skip to the next value
                                			}
                                				
                                				
                                			$processedPaymentsPaid[] = $payment_identifier;
                                					
                                            $total_paid_for_booking += (float)$row_payment_paid_amount['trams_received_amount'];
                                        }
                                        
                                        $balance = (float)$total_amount - (float)$total_paid_for_booking; 
                                    }
                                    
                                    if($balance == '')
                            		{
                            		    $balance = (float)$total_amount - (float)$deposit_amount;
                            		}
                            		
                            		
                                            $received_pnr_for_azupay_receipt = '';
                                            $query_pnr_case = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id'";
                                        	$result_pnr_case = mysqli_query($mysqli, $query_pnr_case);
                                        	while($row_pnr_case = mysqli_fetch_assoc($result_pnr_case))
                                        	{
                                				$received_pnr_for_azupay_receipt = $row_pnr_case['pnr']; // get one PNR for azupay customer viewing
                                        	}
                                            ?>
                                            <tr>
                                				<td width="25%">Order ID</td>
                                				<td>
                                				    <input type="text" readonly name="order_id" required value="<?php echo $order_id; ?>">
                                				    <input type="hidden" name="emailid" value="<?php echo $email_pax; ?>" required>
                                				    <input type="hidden" name="dummy_total_amount" value="<?php echo $balance; ?>" required>
                                                </td>
                                			</tr>
                                            <tr>
                                                <td>Reason</td>
                                                <td>
                                                    <select name="type_of_payment" required style="width:100%; padding:10px;">
                                                        <option selected disabled value="">Select</option>
                                                        <?php													
														if(( current_user_can( 'datechange_manager' ) && $row_payment_status['payment_status'] == 'paid' ))
														{
															?>
															<option value="Less Amount">Less Amount</option>
															<option value="SSR">SSR</option>
															<?php
														}
														
														if($currnt_userlogn == 'lee' || $currnt_userlogn == 'sriharshans' || $currnt_userlogn == 'kajalk' || $currnt_userlogn == 'joyce' || $currnt_userlogn == 'BinalJ')
														{
															?>
															<option value="Balance Payment">Balance Payment</option>
															<option value="Less Amount">Less Amount</option>
															<option value="Date change">DC</option>
															<option value="SSR">SSR</option>
															<?php
														}
                                            			?>
                                                    </select>
                                                    </br>
                                        			<input type="hidden" name="pnr" value="<?php echo $received_pnr_for_azupay_receipt; ?>">
                                                </td>
                                            </tr>
                                			<tr>
                                				<td>Amount</td>
                                				<td><input type="text" name="payment_amount" required></td>
                                			</tr>
                                			<tr>
                                				<td>Customer Portal Case ID (if available)</td>
                                				<td><input type="text" name="customer_case_id"></td>
                                			</tr>
                                			<tr>
                                				<td>Note (if available)</td>
                                				<td><input type="text" name="payment_request_note"></td>
                                			</tr>
                                			<tr>
                                			    <td colspan='2'><center><input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='make_general_payment_request' value='Make Request'></center></td>
                                			</tr>
                                		</table>
                                		</form>
                                		<script>
                                        $(document).ready(function() {
                                            $('select[name="type_of_payment"]').change(function() {
                                                var selectedOption = $(this).val();
                                                var totalAmount = $('input[name="dummy_total_amount"]').val();
                                                
                                                if (selectedOption === 'Balance Payment') {
                                                    $('input[name="payment_amount"]').val(totalAmount);
                                                    $('input[name="payment_amount"]').attr('readonly', true);
                                                } 
                                                else if (selectedOption === 'Less Amount') {
                                                    $('input[name="payment_amount"]').val(totalAmount);
                                                    $('input[name="payment_amount"]').attr('readonly', false);
                                                }
                                                else {
                                                    $('input[name="payment_amount"]').val('');
                                                    $('input[name="payment_amount"]').attr('readonly', false);
                                                }
                                                
                                                if (selectedOption === 'Date change') {
                                                    $('input[name="customer_case_id"]').attr('required', true);
                                                } else {
                                                    $('input[name="customer_case_id"]').removeAttr('required');
                                                }
												
												if (selectedOption === 'SSR') {
                                                    $('input[name="customer_case_id"]').attr('required', true);
                                                } else {
                                                    $('input[name="customer_case_id"]').removeAttr('required');
                                                }
                                                
                                                if (selectedOption === 'Less Amount') {
                                                    $('input[name="payment_request_note"]').attr('required', true);
                                                } else {
                                                    $('input[name="payment_request_note"]').removeAttr('required');
                                                }
                                            });
                                        });
                                        </script>

                                    <?php
                                    
                                    if(isset($_POST['make_general_payment_request']))
                                    {
                    				    $order_id_for_payment_request = $_POST['order_id'];
                                        $emailid_for_payment_request = $_POST['emailid'];
                                        $type_of_payment_for_payment_request = $_POST['type_of_payment'];
                                        $pnr_for_payment_request = $_POST['pnr'];
                                        $paymentAmount = $_POST['payment_amount'];
										$current_date_time = date("Y-m-d H:i:s");
                                        if($_POST['customer_case_id'] != '')
                                        {
                                            $customer_case_id_for_payment_request = $_POST['customer_case_id'];
                                        }
                                        else
                                        {
                                            $customer_case_id_for_payment_request = '0';
                                        }
                                        $payment_request_note_for_payment_request = $_POST['payment_request_note'];
                                        
                                        $paymentAmount_2Decimal = number_format((float)$_POST['payment_amount'], 2, '.', '') ;
                                        {
                                            
                                            if($order_id_for_payment_request && $paymentAmount && $type_of_payment_for_payment_request)
                                            {
                        				        if (class_exists('GuzzleHttp\Client'))
                        				        {
                                                    if($type_of_payment_for_payment_request == 'Balance Payment')
                                                    {
                                                        $callback_url = 'https://gauratravel.com.au/azupay-post-receiver/';
                                                        $clientTransactionId = $order_id_for_payment_request.'_RE_'.date("is");
                                                    }
                                                    else if($type_of_payment_for_payment_request == 'Less Amount')
                                                    {
                                                        $callback_url = 'https://gauratravel.com.au/azupay-callback-custom/';
                                                        $clientTransactionId = $order_id_for_payment_request.'_'.date("dis");
                                                    }
                                                    else
                                                    {
                                                        $callback_url = 'https://gauratravel.com.au/azupay-post-receiver-dc/';
                                                        $clientTransactionId = $order_id_for_payment_request."_".date("dis");
														
														mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_invoice 
															(order_id, invoice_by, status, invoice_amount, 
															invoice_date, travel_type, invoice_status ) 
															values 
															('$order_id_for_payment_request','$currnt_userlogn','Proforma Invoice' ,'$paymentAmount', '$current_date_time', 'Date change', 'Open' )") or die(mysqli_error($mysqli));
                                                    }
                                                    
                                                    if($paymentAmount_2Decimal > 0.01)
                                                    {
                                                        $query_pnr_case_ = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_for_payment_request'";
                                                        $result_pnr_case_ = mysqli_query($mysqli, $query_pnr_case_);
                                                        $row_pnr_case_ = mysqli_fetch_assoc($result_pnr_case_);
                                                        $order_type_for_azupay = $row_pnr_case_['order_type'];
                                                		$received_pnr_for_azupay = $row_pnr_case_['pnr'];
                                                        if($order_type_for_azupay == 'WPT')
                                                        {
                                                            $paymentDescription = $type_of_payment_for_payment_request. " for Booking #".$order_id_for_payment_request;
                                                        }
                                                        else
                                                        {
                                                            if($received_pnr_for_azupay != '')
                                                            {
                                                                $paymentDescription = $type_of_payment_for_payment_request . " for Booking #".$received_pnr_for_azupay;
                                                            }
                                                            else
                                                            {
                                                                $paymentDescription = $type_of_payment_for_payment_request . " for Booking #".$order_id_for_payment_request;
                                                            }
                                                        }
                                                        
                                                        $next_3_days = date("Y-m-d", strtotime("+4 days"));
                                                        $current_time = date("H:i:s");
                                                        $next_3_days2 = $next_3_days."T".$current_time."Z";
    
                                                        $day_of_after_24_hrs = date("d") + 3;
                                                        if($day_of_after_24_hrs < 10) {
                                                            $day_of_after_24_hrs = "0".$day_of_after_24_hrs;
                                                        }
                                                        $current_time_plus_24_hrs = date($day_of_after_24_hrs."/m/Y H:i:s");
                                                        
                                                        $paymentDetails = generateAzupayPaymentRequest($next_3_days2, $clientTransactionId, $paymentAmount, $paymentDescription, $callback_url);
                                                       
                                                        // Extract individual values
                                                        if(isset($paymentDetails) && isset($paymentDetails['paymentRequestId']))
                                                        {
                                                            $paymentRequestId = $paymentDetails['paymentRequestId'];
                                                            $paymentRequestcreatedDateTime = $paymentDetails['createdDateTime'];
                                                            $paymentRequestcheckoutUrl = $paymentDetails['checkoutUrl'];
                                                            $paymentRequestExpiryDatetime = $paymentDetails['paymentExpiryDatetime'];
                                                            $paymentRequestExpiryDatetime_ymd = $paymentDetails['paymentExpiryDatetimeYMD'];
                                                            $paymentRequestpayID = $paymentDetails['payID'];
                                                            $paymentRequestAmount = $paymentDetails['paymentAmount'];
                                                            $full_payment_auth_code = $paymentDetails['paymentAuthCode'];
                                                            $virtualBsb = $paymentDetails['virtualBsb'];
                                                            $virtualAccountNumber = $paymentDetails['virtualAccountNumber'];
                                                            
                                                            $sql_authcode_store ="UPDATE wpk4_backend_travel_bookings
                                                                SET full_payment_auth_code = '$full_payment_auth_code'
                                                            WHERE order_id='$order_id_for_payment_request'";
                                                            $results_authcode_store = $wpdb->query($sql_authcode_store);
                                                            
                                                            if(isset($paymentRequestId) && $paymentRequestId != '')
                            							    {
                            							        // SkyPay Request Starts
                            							        $paymentAmount = floatval($paymentAmount);
                            							        $paymentAmount = number_format($paymentAmount, 2, '.', '');
                            							        // Check if the price contains a decimal point
                            							        if (strpos($paymentAmount, '.') !== false) {
                            							            $newSalePrice = (int) str_replace('.', '', $paymentAmount);
                            							        } else {
                            							            $newSalePrice = (int) $paymentAmount * 100;
                                                                }
                                                                $query_get_travel_date = "SELECT travel_date, trip_code FROM wpk4_backend_travel_bookings where order_id = '$order_id_for_payment_request' order by travel_date asc limit 1";
                                                                $result_get_travel_date = mysqli_query($mysqli, $query_get_travel_date);
                                                                $row_get_travel_date = mysqli_fetch_assoc($result_get_travel_date);
                                                                $departureDate = date('Y-m-d', strtotime($row_get_travel_date['travel_date']));
                                                                $limitTimestamp = date("Y-m-d H:i:s", strtotime("+10 days", strtotime(date("Y-m-d").' 23:59:59')));
                                                                // PAY LATER START
                                                                $paylater_link = '';
                                                                if($departureDate > $limitTimestamp && $type_of_payment_for_payment_request == 'Balance Payment')
                                                                {
                                                                    $paylater_link = generateSkyPayPaymentRequest($newSalePrice, $departureDate, $order_id_for_payment_request);
                                							    }
                                                                // SkyPay Request Ends
                                                                // BPAY Request Starts
                                                                $bpay = true;
                                                                $bpay_logo = "https://gauratravel.com.au/wp-content/uploads/2024/01/bpay-icon.png";
                                                                $crn = '';
                                                                $exp_date = '';
                                                                $limitTimestamp_bpay = date("Y-m-d", strtotime("+10 days", strtotime(date("Y-m-d").' 23:59:59')));
                                                                $is_bpay_enabled_with_travel_date = false;
                                                                if(isset($bpay) && $type_of_payment_for_payment_request == 'Balance Payment' && ($departureDate > $limitTimestamp_bpay || $currnt_userlogn == 'lee' || $currnt_userlogn == 'joyce'))
                                                                {
                                                                    $is_bpay_enabled_with_travel_date = true;
                                                                    $order_id = $order_id_for_payment_request; // baseCustomerNumber
                                                                    $exp_date = date("Y-m-d", strtotime("+1 days"));
                                                                    $amount = $paymentAmount_2Decimal;
                                                                    $authcode = generateAuthCode();
                                                                    $response_generateCRNValidation = generateCRNWithAmount($authcode, $order_id, $amount, $exp_date);
                                                                    $data_generateCRNValidation = json_decode($response_generateCRNValidation, true);
                                                                    if (isset($data_generateCRNValidation['crnResults'])) 
                                                                    {
                                                                        foreach ($data_generateCRNValidation['crnResults'] as $resultcrn) 
                                                                        {
                                                                            if($resultcrn['crn'] != '') 
                                                                            {
                                                                                // Extract the data
                                                                                $tid = $resultcrn['tid'];
                                                                                $customerNumber = $resultcrn['baseCustomerNumber'];
                                                                                $crn = $resultcrn['crn'];
                                                                                        
                                                                                $tid_sql = mysqli_real_escape_string($mysqli, $tid);
                                                                                $baseCustomerNumber_sql = mysqli_real_escape_string($mysqli, $customerNumber);
                                                                                $crn_sql = mysqli_real_escape_string($mysqli, $crn);
                                                                                                            
                                                                                $check_digit_difference = findStringDifferences($baseCustomerNumber_sql, $crn_sql);
                                                                                                    
                                                                                mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_bpay_request (order_id, tid, base_customer_number, final_customer_number, check_digit, created_on, created_by, amount, expirydate)
                                                                                values ('$order_id', '$tid_sql', '$baseCustomerNumber_sql', '$crn_sql', '$check_digit_difference', '$current_date_and_time', 'Generate Payment in G360', '$amount', '$exp_date' )") or die(mysqli_error($mysqli));
                                                                            }
                                                                            else
                                                                            {
                                                                                echo 'BaseCRN not matching with API';
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                                
                                                                $enable_bank_account = false;
                                                                if(($departureDate > $limitTimestamp_bpay || $currnt_userlogn == 'lee' || $currnt_userlogn == 'joyce'))
                                                                {
                                                                    $enable_bank_account = true;
                                                                }
                                                                // BPAY Request Ends
                                                                // azupay bank option start
                                                                $azupayBank = false;
                                                                if(isset($virtualBsb) && $virtualBsb != '')
                                                                {
                                                                    $azupayBank = true;
                                                                }
                                                                // azupay bank option ends
                                                                
                                                                $paymentRequestAmount = number_format((float)$paymentRequestAmount, 2, '.', '');
                                        				        
                                							    $orderid_added = $order_id_for_payment_request;
                            							        mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_custom_payments (order_id, case_id, type_of_payment, amount, status, payment_client_id, auth_code, requested_on, requested_by, payment_request_id, azupay_expiry_date, azupay_link, azupay_payid, azupay_bsb, azupay_account_number, skypay_link, skypay_expiry_date, bpay_crn, bpay_expiry_date) 
                							                    values ('$order_id_for_payment_request', '$customer_case_id_for_payment_request', '$type_of_payment_for_payment_request' ,'$paymentAmount' ,'waiting' ,'$clientTransactionId' ,'$full_payment_auth_code' ,'$current_date_time' ,'$currnt_userlogn', '$paymentRequestId', '$paymentRequestExpiryDatetime_ymd', '$paymentRequestcheckoutUrl', '$paymentRequestpayID', '$virtualBsb', '$virtualAccountNumber', '$paylater_link', '$paymentRequestExpiryDatetime_ymd', '$crn', '$exp_date')") or die(mysqli_error($mysqli));
                							            
                                							    include(get_template_directory().'/templates/email/tpl_email_get_balance_payment_with_multiple_payment_options.php');
                                							    
                                							    $type_of_history = $type_of_payment_for_payment_request . ' payment link';
                                                                add_g360_event_history($order_id_for_payment_request, $co_order_id_api, $product_id_api, $type_of_history, "", $currnt_userlogn, $current_date_time);
                            							    }
                            							    echo '<script>alert("Payment link has been shared");</script>';
                                                        }
                                                        else
                                                        {
                                                            echo '<script>alert("Error during the payment generation. Contact HO.");</script>';
                                                        }
                        							    
                    							        $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                                        echo '<script>window.location.href="'.$current_url.'";</script>';
                            				        }
                            				        else
                            				        {
                            				            echo '<script>alert("Payment amount is less than 0.");</script>';
                            				        }
                        				        }
                        				        else
                                                {
                                                    echo '<script>alert("Error on payment link. Contact HO.");</script>';
                                                }
                                            }
                                            else
                                            {
                                                echo '<script>alert("Error during the request. Kindly try again later.");</script>';
                                            }
                                        }
                                    }
                                    ?>
                				</div>
                				
                				<div id="amount_adjustment_req<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                				    <?php
                				    $order_id = $order_id_api;
									if($currnt_userlogn == 'joyce' || $currnt_userlogn == 'chamindikah' || $currnt_userlogn == 'lee' )
                                    {
										$total_amount_editor = '';
									}
									else
									{
										$total_amount_editor = 'readonly';
									}
                                    ?>
                                    <form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                        <tr>
                                            <td>Current Order ID *</td>
                                            <td>
											<input type="text" name="new_order_id2" value="<?php echo $order_id; ?>" required></td>
                                        </tr>
                                        </br>
                                        <tr>
                                            <td>Previous Order ID *</td>
                                            <td><input type="text" name="old_order_id2" id="old_order_id2" required></td>
                                        </tr>
                                        </br>
                                        <tr>
                                            <td>Previous Amount *</td>
                                            <td><input type="text" name="changing_amount2" id="changing_amount2" <?php echo $total_amount_editor; ?> required></td>
                                        </tr>
                                        </br>
                                        <tr>
                                            <td>Remark *</td>
                                           <td><textarea name="reason_for_transfer2" required></textarea></td>
                                        </tr>
                                        </br>
                                        <center><input type='submit' name='update_user_payment_transfer2' class='btn btn-success' style='padding:15px; margin:0;font-size:11px;' value='Save'></center>
                                    </form>
									<script>
									$(document).ready(function() {
									    
									    $(document).on('change', '#old_order_id2', function(){
                    						var oldOrderId = $(this).val();
                    						var form_data = new FormData();
                    						form_data.append('get_paid_amount_for_adjustment2', 'amount_adjustment2');
                    						form_data.append('old_order_id2', oldOrderId);
                    						$.ajax({
                    							url: "/wp-content/themes/twentytwenty/templates/tpl_backend_functions.php",
                    							method: "POST",
                    							dataType: "json",
                    							data: form_data,
                    							contentType: false,
                    							cache: false,
                    							processData: false,
                    							success: function (response) {
                    								$('#changing_amount2').val(response);
                    							},
                    							error: function(xhr, textStatus, errorThrown) {
                    								console.log(errorThrown);
                    							}
                    						});
                    					});
					
									});
									</script>
                                    <?php
                                    if (isset($_POST['update_user_payment_transfer2']))
                                    {
                                        $previous_order_id_for_adjustment_full = $_POST['old_order_id2'];
                                        $new_order_id = $_POST['new_order_id2'];

                                        if ( ctype_digit($new_order_id) && strlen($new_order_id) <= 7 ) {
                                			$source = 'WPT';
                                    	} elseif (ctype_alpha($new_order_id)) {
                                    		$source = 'gds';
                                    	} else {
                                    		$source = 'gds';
                                    	}
                                    	
                                    	if ( ctype_digit($previous_order_id_for_adjustment_full) && strlen($previous_order_id_for_adjustment_full) <= 7 ) {
                                			$source_previous = 'WPT';
                                    	} elseif (ctype_alpha($previous_order_id_for_adjustment_full)) {
                                    		$source_previous = 'gds';
                                    	} else {
                                    		$source_previous = 'gds';
                                    	}
                                    	
                                    	$previous_pnr_for_adjustment_full = 'DUMMYPNRFORPAYMENT';	
                                    	if($source_previous == 'gds' && $previous_order_id_for_adjustment_full != '')
                                    	{
                                    	    $payment_get_orderid = $wpdb->get_results( "SELECT * FROM wpk4_backend_travel_booking_pax where pnr = '$previous_order_id_for_adjustment_full' OR order_id = '$previous_order_id_for_adjustment_full'"); 
                            				foreach($payment_get_orderid as $row_get_orderid) { 
                            				    $previous_order_id_for_adjustment_full = $row_get_orderid->order_id;
                            				    $previous_pnr_for_adjustment_full = $row_get_orderid->pnr;
                            				}
                                    	}
                                        $previous_amount_for_adjustment_full = $_POST['changing_amount2'];
                                        $reason_for_transfer = $_POST['reason_for_transfer2'];

                                        $payment_received_for_previous_order = 0;
                                        $payment_ref_partial = $wpdb->get_results( "SELECT * FROM wpk4_backend_travel_payment_history where order_id = '$previous_order_id_for_adjustment_full' "); 
                        				foreach($payment_ref_partial as $row_2) { 
                        				    $payment_received_for_previous_order += $row_2->trams_received_amount;
                        				    $payment_process_date_of_previous_order = $row_2->process_date;
                        				}
                        				$payment_received_for_previous_order = number_format((float)$payment_received_for_previous_order, 2, '.', '');
                        				$previous_amount_for_adjustment_full = number_format((float)$previous_amount_for_adjustment_full, 2, '.', '');
                        				
                        				$payment_partial_value_for_booking = '';
                        				
                        				if($payment_received_for_previous_order >= $previous_amount_for_adjustment_full && ($payment_received_for_previous_order != '0.00' && $previous_amount_for_adjustment_full != '0.00') && $reason_for_transfer != '')
                                        {
                                            $old_order_id = $_POST['old_order_id2'];
                                            $new_order_id = $_POST['new_order_id2'];
                                            $changing_amount = $_POST['changing_amount2'];
                                            $reason_for_transfer = $_POST['reason_for_transfer2'];
                                            
                                            $wpdb->insert(
                                                'wpk4_backend_travel_payment_history_pending',
                                                array(
                                                    'old_order_id' => $old_order_id,
                                                    'new_order_id' => $new_order_id,
                                                    'changing_amount' => $changing_amount,
                                                    'reason_for_transfer' => $reason_for_transfer,
                                                )
                                            );
                                            
                                            $pending_id = $wpdb->insert_id;
                                            
                                            $wpdb->insert(
                                                'wpk4_backend_todo_tasks',
                                                array(
                                                    'comment_type' => 'adjustment',
                                                    'order_id' => $new_order_id,
                                                    'status' => 'open',
                                                    'comment_date_time' => current_time('mysql'),
                                                    'comment_by' => $currnt_userlogn,
                                                    'comment' => $pending_id
                                                )
                                            );
                                        }
                                        else
                                        {

                                            echo '<script>alert("Error during the process. Kindly try again. Below can be the issue,\n\n Transfer amount is higher than the paid amount\n Remark not provided");</script>';
                                        }
                                        
                                    }
                				    ?>
                				</div>
                				
								<div id="internal_ssr_request_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                				    <?php echo $smart_ssr_available_note; ?>
                				    <?php
                                    $order_id = $order_id_api;
                                    if($is_smart_ssr_available == 0)
									{
                        				?>
                                    <h6>Add SSR Note</h6>
                                      <?php $order_id = $order_id_api; ?>
                                      <form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                      <table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
                                            <tr>
                                                <td>Passenger</td>
                                                <td>
                                                    <select name="pax_data_individual" required style="width:100%; padding:10px;">
                                                        <?php
                                                        $processedOrders = [];
                                                        $query_paxc = "SELECT auto_id, fname, lname FROM wpk4_backend_travel_booking_pax where order_id='$order_id'";
                                        				$result_paxc = mysqli_query($mysqli, $query_paxc);
                                        				while($row_paxc = mysqli_fetch_assoc($result_paxc))
                                        				{
                                        				    $pax_name_selection = $row_paxc['fname'] . ' ' . $row_paxc['lname'];
                                        				    $auto_id_selection = $row_paxc['auto_id'];
                                        				    if (in_array($auto_id_selection, $processedOrders)) {
                            								    continue; 
                                							}
                                							
                                							$processedOrders[] = $auto_id_selection;
                                        				    echo '<option value="'. $auto_id_selection .'">'.$pax_name_selection.'</option>';
                                        				}
                                        				
                                        				$email_pax_ssr = '';
                                        				$query_pax_email = "SELECT billing_email FROM wpk4_backend_travel_bookings where order_id='$order_id' AND billing_email != ''";
                                    					$result_pax_email = mysqli_query($mysqli, $query_pax_email);
                                    					$row_pax_email = mysqli_fetch_assoc($result_pax_email);
                                    					if(mysqli_num_rows($result_pax_email) > 0)
                                    					{
                                                		    $email_pax_ssr = $row_pax_email['billing_email'];
                                    					}
                                    					// if email id is not found in booking table, then get from pax table.
                                    					if($email_pax_ssr == '')
                                    					{
                                    					    $query_pax_email = "SELECT email_pax FROM wpk4_backend_travel_booking_pax where order_id='$order_id' AND email_pax != ''";
                                    					    $result_pax_email = mysqli_query($mysqli, $query_pax_email);
                                    					    $row_pax_email = mysqli_fetch_assoc($result_pax_email);
                                    					    if(mysqli_num_rows($result_pax_email) > 0)
                                    					    {
                                    					        $email_pax_ssr = $row_pax_email['email_pax'];
                                    					    }
                                    					}
                                    					
                                                		$phone_pax_ssr = '';
                                                		$query_pax_phone = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id' AND phone_pax != ''";
                                    					$result_pax_phone = mysqli_query($mysqli, $query_pax_phone);
                                    					$row_pax_phone = mysqli_fetch_assoc($result_pax_phone);
                                    					if(mysqli_num_rows($result_pax_phone) > 0)
                                    					{
                                                		    $phone_pax_ssr = $row_pax_phone['phone_pax'];
                                                        }
                                                        ?>
                                                    </select>
                                                    <input type="hidden" name="emailid_pax" value="<?php echo $email_pax_ssr; ?>">
                                                    <input type="hidden" name="phonenum_pax" value="<?php echo $phone_pax_ssr; ?>">
                                                </td>
                                            </tr>
                                            <tr>
                                                <td width='25%'>Meal</td>
                                                <td>
                                                    <div class="radio-group">
                                                        <input class="ssr_request_radio_button" type="radio" id="veg" name="mealselection" value="vegetarian">
                                                        <label for="veg">Vegetarian</label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                        
                                                        <input class="ssr_request_radio_button" type="radio" id="vegan" name="mealselection" value="vegan">
                                                        <label for="vegan">Vegan</label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                        
                                                        <input class="ssr_request_radio_button" type="radio" id="jain" name="mealselection" value="jain">
                                                        <label for="jain">Jain</label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                        
                                                        <input class="ssr_request_radio_button" type="radio" id="non-vegetarian" name="mealselection" value="non vegetarian">
                                                        <label for="non-vegetarian">Non Vegetarian</label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                        
                                                        <input class="ssr_request_radio_button" type="radio" id="muslim-meal" name="mealselection" value="muslim meal">
                                                        <label for="muslim-meal">Muslim meal</label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                        
                                                        <input class="ssr_request_radio_button" type="radio" id="child-meal" name="mealselection" value="child meal">
                                                        <label for="child-meal">Child meal</label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                        
                                                        <input class="ssr_request_radio_button" type="radio" id="baby-meal" name="mealselection" value="baby meal">
                                                        <label for="baby-meal">Baby meal</label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                                    </div>
                                                </td>
                                            </tr>
                                			<tr>
                                				<td>Seat</td>
                                				<td>
                                				        <div class="radio-group">
                                				            <input class="ssr_request_radio_button" type="radio" id="windowseat" name="seatingplace" value="window seat"><label for="windowseat"> Window Seat</label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                				            <input class="ssr_request_radio_button" type="radio" id="aisleseat" name="seatingplace" value="aisle seat"><label for="aisleseat"> Aisle Seat</label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                				        </div>
                                                </td>
                                			</tr>
                                			<tr>
                                				<td>Bassinet</td>
                                				<td><input type="checkbox" id="bassinet" name="bassinet" value="yes">
                                                        <label for="bassinet"> Yes</label><br></td>
                                			</tr>
                                			<tr>
                                				<td>Wheelchair</td>
                                				<td><input type="checkbox" id="wheelchair" name="wheelchair" value="yes">
                                                        <label for="wheelchair"> Yes</label><br></td>
                                			</tr>
                                			<tr>
                                				<td>Meet and Greet Assistants</td>
                                				<td><input type="checkbox" id="meetandgreetassistants" name="meetandgreetassistants" value="yes">
                                                        <label for="meetandgreetassistants"> Yes</label><br></td>
                                			</tr>
                                			<tr>
                                				<td>Sent eticketing</td>
                                				<td><input type="checkbox" id="senteticketing" name="senteticketing" value="yes">
                                                        <label for="senteticketing"> Yes</label><br></td>
                                			</tr>
                                			<tr>
                                				<td>Baggage</td>
                                				<td>
                                				    <table style='padding:0; margin:0; border:0;'>
                                				        <tr style='padding:0; margin:0; border:0;'>
                                				            <td style='padding:0; margin:0; border:0; width:15%;'>
                                				                <input type="checkbox" id="baggage" name="baggage" value="yes">
                                                                <label for="baggage"> Yes</label>
                                				            </td>
                                				            <td style='padding:0; margin:0; border:0;'>
                                				                <input type='text' name="baggage_weight" placeholder="Baggage Weight in Kg">
                                				            </td>
                                				        </tr>
                                				    </table>
                                                    
                                                </td>
                                			</tr>
                                			<tr>
                                			    <td colspan='2'><center><input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='save_ssr_request_internal' value='Save Request'></center></td>
                                			</tr>
                                		</table>
                                		</form>
                                    <?php
                                    if(isset($_POST['save_ssr_request_internal']))
                                    {
                                        $pax_data_individual = $_POST['pax_data_individual'];
                                        $emailid_pax = $_POST['emailid_pax'];
                                        $phonenum_pax = $_POST['phonenum_pax'];
                                        
                                        $combined_text = '';
                                        
                                        if(isset($_POST['senteticketing']))
                                        {
                                            $senteticketing = $_POST['senteticketing'];
                                            $combined_text .= 'eTicket sent: ' . $_POST['senteticketing'].'</br>';
                                        }
                                        else
                                        {
                                            $senteticketing = '';
                                        }
                                        
                                        if(isset($_POST['meetandgreetassistants']))
                                        {
                                            $meetandgreetassistants = $_POST['meetandgreetassistants'];
                                            $combined_text .= 'Meet and Greet: ' . $_POST['meetandgreetassistants'].'</br>';
                                        }
                                        else
                                        {
                                            $meetandgreetassistants = '';
                                        }
                                        
                                        if(isset($_POST['wheelchair']))
                                        {
                                            $wheelchair = $_POST['wheelchair'];
                                            $combined_text .= 'Wheelchair: ' . $_POST['wheelchair'].'</br>';
                                        }
                                        else
                                        {
                                            $wheelchair = '';
                                        }
                                        
                                        if(isset($_POST['bassinet']))
                                        {
                                            $bassinet = $_POST['bassinet'];
                                            $combined_text .= 'Bassinet: ' . $_POST['bassinet'].'</br>';
                                        }
                                        else
                                        {
                                            $bassinet = '';
                                        }
                                        
                                        if(isset($_POST['seatingplace']))
                                        {
                                            $seatingplace = $_POST['seatingplace'];
                                            $combined_text .= 'Seating place: ' . $_POST['seatingplace'].'</br>';
                                        }
                                        else
                                        {
                                            $seatingplace = '';
                                        }
                                        
                                        if(isset($_POST['mealselection']))
                                        {
                                            $mealselection = $_POST['mealselection'];
                                            $combined_text .= 'Meal selection: ' . $_POST['mealselection'].'</br>';
                                        }
                                        else
                                        {
                                            $mealselection = '';
                                        }
                                        
                                        if(isset($_POST['baggage']))
                                        {
                                            $baggage = $_POST['baggage'];
                                            $combined_text .= 'Baggage: ' . $_POST['baggage'].'</br>';
                                        }
                                        else
                                        {
                                            $baggage = '';
                                        }
                                        
                                        
                                        if($baggage != '')
                                        {
                                            $combined_text .= 'Baggage weight: ' . $_POST['baggage_weight'].'</br>';
                                        }
                                        
                                        
                                        $current_date_time = date("Y-m-d H:i:s");
                                        // Sanitize and escape inputs securely
                                        $sql_authcode_store = $wpdb->prepare(
                                            "UPDATE wpk4_backend_travel_booking_pax
                                             SET ssr_internal_record = %s
                                             WHERE auto_id = %d",
                                            $combined_text,
                                            $pax_data_individual
                                        );
                                        
                                        $results_authcode_store = $wpdb->query($sql_authcode_store);
										$current_date_and_time = date("Y-m-d H:i:s");
										
										mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_update_history ( order_id, merging_id, pax_auto_id, meta_key, meta_value, updated_time, updated_user ) 
										values ('$order_id_api', '', '$pax_data_individual', 'Internal SSR in G360', '$combined_text', '$current_date_and_time', '$currnt_userlogn')") or die(mysqli_error($mysqli));
                                        
                                        // Check if the query was successful
                                        if (false === $results_authcode_store) {
                                            // Handle error
                                            error_log("Error updating record: " . $wpdb->last_error);
                                            echo 'An error occurred while updating the record.';
                                        } else {
                                            echo 'Record updated successfully.';
                                        }
										echo '<script>alert("Record added successfully");</script>';
                                        $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                    	echo '<script>window.location.href="'.$current_url.'";</script>';
                                    }
									}
                                    ?>
									
                				</div>
                				
                				<div id="azupaydc_request_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                				    
                				    <?php
                                        $order_id = $order_id_api;
                                        
                                        $query_task_history_dc = "SELECT * FROM wpk4_backend_user_portal_requests where reservation_ref='$order_id_api' AND case_type = 'ssr_request'";
                                    	$result_task_history_dc = mysqli_query($mysqli, $query_task_history_dc);
                        				$count_task_history_userportal_dc = mysqli_num_rows($result_task_history_dc);
                        				if($count_task_history_userportal_dc > 0)
                        				{
                        					?>
                        					<h6>Previous Requests</span></h6>
                        					<table style="font-size:13px;">
                        						<tr><th>CaseID</th><th>Task Type</th><th>Pax</th><th>Initiated on</th><th>Status</th><th>&nbsp;</th></tr>
                        						<?php
                        						while($row_task_history_user_dc = mysqli_fetch_assoc($result_task_history_dc))
                        						{
                        							//$task_order_id = $row_task_history_user_dc['order_id'];
                        							$task_case_type = $row_task_history_user_dc['case_type'];
                        							$case_date = $row_task_history_user_dc['case_date'];
                        								$case_id = $row_task_history_user_dc['case_id'];
                        							$gstatus = $row_task_history_user_dc['status'];
                        						    $enc_pws = md5($case_id); 
                        						    $pax_name_for_ssr = get_userportal_post_meta($case_id, "Passenger");
                        						?>
                        						<tr><td><?php echo $case_id; ?></td><td><?php echo $task_case_type; ?></td><td><?php echo $pax_name_for_ssr; ?></td><td><?php echo $case_date; ?></td><td><?php echo $gstatus; ?></td><td><a target="_blank" href="/customer-portal/?p=admin-request-view&id=<?php echo $case_id; ?>&co=<?php echo $enc_pws; ?>&t=&casetype=<?php echo $task_case_type; ?>">View</a></td></tr>
                        						
                        						<?php
                        						}
                        						?>
                        					</table>
                        					<?php
                        				}
                        				else
                        				{
                        				    
                        					echo '<h6>Previous Requests</h6>
                        					    No task created';
                        				}
                        				?>
                                    </br>
                                    <h6>Add DC Azupay Request</h6>
                                      <?php $order_id = $order_id_api; ?>
                                      <form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                      <table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
                                            <tr>
                                				<td>Order ID</td>
                                				<td>
                                				    <input type="text" readonly name="order_id_for_azupay" required value="<?php echo $order_id; ?>">
                                				    <input type="hidden" name="emailid_for_azupay" value="<?php echo $email_pax; ?>">
                                                </td>
                                			</tr>
                                            <tr>
                                                <td>Case ID</td>
                                                <td>
                                                    <?php
                                                    $received_pnrs_for_azupay = '';
                                                    $received_pnr_for_azupay_receipt = '';
                                                        $query_pnr_case = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id'";
                                        				$result_pnr_case = mysqli_query($mysqli, $query_pnr_case);
                                        				while($row_pnr_case = mysqli_fetch_assoc($result_pnr_case))
                                        				{
                                							$received_pnrs_for_azupay .= "'".$row_pnr_case['pnr'] . "',";
                                							$received_pnr_for_azupay_receipt = $row_pnr_case['pnr']; // get one PNR for azupay customer viewing
                                        				}
                                                        $received_pnrs_for_azupay = substr($received_pnrs_for_azupay, 0, -1);

                                                    $query_select_case = "SELECT * FROM wpk4_backend_user_portal_requests where reservation_ref = '$order_id' OR reservation_ref IN ($received_pnrs_for_azupay)";
                                        			$result_select_case = mysqli_query($mysqli, $query_select_case);
                                        			$row_select_case_count = mysqli_num_rows($result_select_case);
                                        			if($row_select_case_count > 0)  // if no case if found, then get the case id from staff manually
                                        			{
                                                        ?>
                                                        <select name="case_id_for_azupay" required style="width:100%; padding:10px;">
                                                            <?php 
                                                            
                                            				while($row_select_case = mysqli_fetch_assoc($result_select_case))
                                            				{
                                            				    ?>
                                            				    <option value="<?php echo $row_select_case['case_id']; ?>"><?php echo $row_select_case['case_id']; ?></option>
                                            				    <?php
                                            				}
                                                            ?>
                                                        </select>
                                                        <?php 
                                        			}
                                        			else
                                        			{
                                        			    ?>
                                        			    <input type="text" name="case_id_for_azupay" required>
                                                        <?php 
                                        			}
                                        			?>
                                        			<input type="hidden" name="pnr_for_azupay" value="<?php echo $received_pnr_for_azupay_receipt; ?>">
                                                </td>
                                            </tr>
                                			<tr>
                                				<td>Amount</td>
                                				<td><input type="text" name="amount_for_azupay" required></td>
                                			</tr>
                                			<tr>
                                			    <td colspan='2'><center><input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='make_azupay_payment_request' value='Make Request'></center></td>
                                			</tr>
                                		</table>
                                		</form>
                                    <?php
                                    if(isset($_POST['make_azupay_payment_request']))
                                    {
                                        $order_id_for_azupay = $_POST['order_id_for_azupay'];
                                        $emailid_for_azupay = $_POST['emailid_for_azupay'];
                                        $case_id_for_azupay = $_POST['case_id_for_azupay'];
                                        $amount_for_azupay = $_POST['amount_for_azupay'];
                                        $pnr_for_azupay = $_POST['pnr_for_azupay'];
                                    
                                        $query_trav_type_case = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_for_azupay'";
                                        $result_trav_type_case = mysqli_query($mysqli, $query_trav_type_case);
                                        $row_trav_type_case = mysqli_fetch_assoc($result_trav_type_case);
                                        
                                        $travel_type_for_azupay = $row_trav_type_case['order_type'];
                                        
                                        if($travel_type_for_azupay == 'WPT') {
                                            $customer_azupay_ref_title = $order_id_for_azupay;
                                        }
                                        else {
                                            $customer_azupay_ref_title = $pnr_for_azupay;
                                        }
                                        
                                        $current_date_time = date("Y-m-d H:i:s");
                                        
                                        if (class_exists('GuzzleHttp\Client'))
                				        {
                                    		$client = new \GuzzleHttp\Client();
                                    		$authorization_code = 'SECR7566D1_c4cc3709d612d1e0e677833ffbcef703_9Kz3JvUrYqPECSwl';
                                    		$access_url = 'https://api.azupay.com.au/v1';
                                    	
                                    		$payID = "payments@gauratravel.com.au";
                                            $payIDSuffix = "gauratravel.com.au";
                                            $clientId = "c4cc3709d612d1e0e677833ffbcef703";
                                            $clientTransactionId = "".$order_id_for_azupay."_DC".$case_id_for_azupay.'_'.date("ms"); //adding date{ms} to get minute and second to ensure the key for multiple dc payment for one order
                                            $paymentAmount = $amount_for_azupay;
                                            $paymentDescription = "Date change charge for #".$customer_azupay_ref_title;
                                            
                                            $next_3_days = date("Y-m-d", strtotime("+3 days"));
                                            $current_time = date("H:i:s");
                                            $next_3_days2 = $next_3_days."T".$current_time."Z";
                                            
                                            if($paymentAmount > 0.01)
                                            {
                                                $full_payment_auth_code = generateRandomSecurityCode();
                                        
                                        
                                                $sql_authcode_store ="UPDATE wpk4_backend_travel_bookings
                                                    SET full_payment_auth_code = '$full_payment_auth_code'
                                                WHERE order_id='$order_id_for_azupay'";
                                                $results_authcode_store = $wpdb->query($sql_authcode_store);
                                                
                                                try 
                                                {
                                                    $azupay_response = $client->request('POST', $access_url.'/paymentRequest', [
                                                        'body' => '{"PaymentRequest":{"paymentNotification":{"paymentNotificationEndpointUrl":"https://gauratravel.com.au/azupay-post-receiver-dc/","paymentNotificationAuthorizationHeaderValue":"'.$full_payment_auth_code.'"},"variant":"1Click", "clientId":"'.$clientId.'","clientTransactionId":"'.$clientTransactionId.'","paymentExpiryDatetime":"'.$next_3_days2.'","paymentAmount":'.$paymentAmount.',"paymentDescription":"'.$paymentDescription.'"}}',
                                                        'headers' => [
                                                        'Authorization' => $authorization_code,
                                                        'accept' => 'application/json',
                                                        'content-type' => 'application/json',
                                                        ],
                                                    ]);
                                                                                        		
                                                    $azupay_data = json_decode($azupay_response->getBody(), true);
                                                    
                                                    $paymentRequestId = $azupay_data['PaymentRequestStatus']['paymentRequestId'];
                                                    $paymentRequeststatus = $azupay_data['PaymentRequestStatus']['status'];
                                                    $paymentRequestcreatedDateTime = $azupay_data['PaymentRequestStatus']['createdDateTime'];
                                                    $paymentRequestcheckoutUrl = $azupay_data['PaymentRequest']['checkoutUrl'];
                                                    $paymentRequestExpiryDatetime = date("d/m/Y H:i:s", strtotime( $azupay_data['PaymentRequest']['paymentExpiryDatetime']));
                                                    $paymentRequestExpiryDatetime_ymd = date("Y-m-d H:i:s", strtotime( $azupay_data['PaymentRequest']['paymentExpiryDatetime']));
                                                    $paymentRequestpayID = $azupay_data['PaymentRequest']['payID'];
                                                    $paymentRequestpaymentDescription = $azupay_data['PaymentRequest']['paymentDescription'];
                                                    $paymentRequestAmount = $azupay_data['PaymentRequest']['paymentAmount'];
                                                    $paymentRequestvirtualBsb = $azupay_data['PaymentRequestStatus']['virtualBsb'];
                                                    $paymentRequestvirtualAccountNumber = $azupay_data['PaymentRequestStatus']['virtualAccountNumber'];

                                                } catch (\GuzzleHttp\Exception\ClientException $e) {
                                                    echo 'Error on generating the payment link. Kindly try again.';
                                                    // Client errors (4xx). Output them directly or log them.
                                                    //echo 'Request failed: ' . $e->getMessage();
                                                    // Optionally, inspect the response body: echo $e->getResponse()->getBody()->getContents();
                                                } catch (\GuzzleHttp\Exception\ServerException $e) {
                                                    echo 'Error on generating the payment link. Kindly try again.';
                                                    // Server errors (5xx)
                                                    //echo 'Server error: ' . $e->getMessage();
                                                } catch (\GuzzleHttp\Exception\GuzzleException $e) {
                                                    // Other errors (networking error, etc.)
                                                    echo 'Error on generating the payment link. Kindly try again.';
                                                    //echo 'Error sending request: ' . $e->getMessage();
                                                } catch (Exception $e) {
                                                    // Non-Guzzle related errors
                                                    echo 'Error on generating the payment link. Kindly try again.';
                                                    //echo 'General error: ' . $e->getMessage();
                                                }
                                            
            							        if(isset($paymentRequestId) && $paymentRequestId != '')
            							        {
            							            $azupayBank = true;
            							            $virtualBsb = $paymentRequestvirtualBsb;
            							            $virtualAccountNumber = $paymentRequestvirtualAccountNumber;
    							            
                							        include(get_template_directory().'/templates/email/tpl_email_azupay_dc_charge_request.php');
                							            
                                                    add_g360_event_history($order_id_api, $co_order_id_api, $product_id_api, 'DC Payment link generated', "", $currnt_userlogn, $current_date_time);
            							        
            							            mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_custom_payments (order_id, case_id, type_of_payment, requested_on, requested_by, amount, status, payment_client_id, auth_code, payment_request_id, azupay_bsb, azupay_account_number, azupay_payid ) 
        							                values ('$order_id_for_azupay','$case_id_for_azupay','Date change' ,'$current_date_time' ,'$currnt_userlogn' ,'$amount_for_azupay', 'waiting', '$clientTransactionId', '$full_payment_auth_code', '$paymentRequestId', '$paymentRequestvirtualBsb', '$paymentRequestvirtualAccountNumber', '$paymentRequestpayID' )") or die(mysqli_error($mysqli));
													
													mysqli_query($mysqli,"insert into wpk4_backend_travel_payment_invoice 
													(order_id, invoice_by, status, invoice_amount, 
													invoice_date, travel_type, invoice_status ) 
        							                values 
													('$order_id_for_azupay','$currnt_userlogn','Proforma Invoice' ,'$amount_for_azupay', '$current_date_time', 'Date change', 'Open' )") or die(mysqli_error($mysqli));
                    				        
            							        }
            							    } 
                    				        else
                    				        {
                    				            echo '<script>alert("Payment amount is less than 0.");</script>';
                    				        }
                                        }
                                        else
                                        {
                                            echo '<script>alert("Error on payment link. Contact HO.");</script>';
                                        }
							            $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                    	echo '<script>window.location.href="'.$current_url.'";</script>';
                                    }
                                    ?>
                				</div>
                				
                				<div id="miscellaneous_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                				    
                                    <h6>Add Miscellaneous</h6>
                                      <?php $order_id = $order_id_api; ?>
                                      <form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                            Category
                                                <select name="category" required style="width:100%; padding:10px;">
                                                    <option value="Itinerary">Itinerary</option>
                                                    <option value="Datechange">Datechange</option>
                                                    <option value="Refund">Refund</option>
                                                    <option value="SSR">SSR</option>
                                                    <option value="Payments">Payments</option>
                                                    <option value="Eticket">Eticket</option>
                                                    <option value="Others">Others</option>
                                                </select>
                                             </br>  </br>   
                                            Description
                                            <textarea name="notedescription" required></textarea>
                                             </br>
                                            <center><input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='save_miscellaneous_request' value='Save Request'></center>
                                	</form>
                                    <?php
                                    if(isset($_POST['save_miscellaneous_request']))
                                    {
                                        $category = $_POST['category'];
                                        $notedescription = $_POST['notedescription'];
                                        
                                        $query_count = "SELECT * FROM wpk4_backend_user_portal_requests ORDER BY case_id DESC LIMIT 1";
            							$result_count = mysqli_query($mysqli, $query_count);
            							$row_count_assoc = mysqli_fetch_assoc($result_count);
            							$row_count = mysqli_num_rows($result_count);
            							if($row_count>0)
            							{
            								$case_id = intval($row_count_assoc['case_id']);
            								$case_id = $case_id+1;
            							}
            							else
            							{
            								$case_id = '1';
            							}
							            
							            add_g360_event_history($order_id_api, $co_order_id_api, $product_id_api, 'Miscellaneous submitted', "", $currnt_userlogn, $current_date_and_time);
							            
                                        add_userportal_post_meta($case_id, 'Type', $category);
                                        add_userportal_post_meta($case_id, 'Description', $notedescription);

                                        $current_date_time = date("Y-m-d H:i:s");
                                         
                                        mysqli_query($mysqli,"insert into wpk4_backend_user_portal_requests (case_id, case_type, reservation_ref, last_response_by, last_response_on, is_seen_by_gt, user_id, status, case_date, priority) 
							            values ('$case_id','miscellaneous','$order_id_api' ,'customer' ,'$current_date_time' ,'0' ,'$currnt_userlogn' ,'open' ,'$current_date_time' ,'P4')") or die(mysqli_error($mysqli));
							            
							            $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                    	echo '<script>window.location.href="'.$current_url.'";</script>';
                                    }
                                    ?>
                				</div>
                				
                				<div id="notes_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                                      <h5>Note</h5>
                                      <?php
                                      $order_id = $order_id_api;
                                        $query_note_history = "SELECT * FROM wpk4_backend_history_of_updates where type_id='$order_id_api' AND meta_key = 'Booking Note Category' order by updated_on desc ";
                                    	$result_note_history = mysqli_query($mysqli, $query_note_history);
                        				$count_note_history = mysqli_num_rows($result_note_history);
                        				if($count_note_history > 0)
                        				{
                        					?>
                        					<h5>Notes <span class="badge badge-primary"><?php echo $count_note_history; ?></span></h5>
                        					<?php
                        					while($row_note_history = mysqli_fetch_assoc($result_note_history))
                        					{
                        					    $updated_on_time = $row_note_history['updated_on'];
                        					    
                        					    ?>
                        					    <table class="table" style="width:90%; font-size:14px; margin:auto; border:1px solid black;">	
                                            	    <tr><td colspan='2'>by <?php echo $row_note_history['updated_by']; ?> on <?php echo $row_note_history['updated_on']; ?> </td></tr>
                        					    <?php
                        					    $unique_id = '';
                        					    $query_note_history_individual = "SELECT * FROM wpk4_backend_history_of_updates where type_id='$order_id_api' AND updated_on = '$updated_on_time'";
                                    	        $result_note_history_individual = mysqli_query($mysqli, $query_note_history_individual);
                                    	        while($row_note_history_individual = mysqli_fetch_assoc($result_note_history_individual))
                                    	        {
                                    	            $unique_id = $row_note_history_individual['auto_id'];
                                					?>
                                					<tr>
                                					    <td width="15%">
                                            				<?php echo str_replace("Booking Note "," ",$row_note_history_individual['meta_key']); ?>
                                            			</td>
                                            			<td><?php echo $row_note_history_individual['meta_value']; ?></td>
                                        			</tr>
                            			        <?php
                                    	        }
                                    	        ?>
                                    	            <tr>
                                					    <td width="15%">
                                            				Unique ID
                                            			</td>
                                            			<td><?php echo $unique_id; ?></td>
                                        			</tr>
                                    	        </table><hr style="margin-top:15px; margin-bottom:15px;">
                                    	        <?php
                        					}
                        				}
                        				else
                        				{
                        					echo 'No task created';
                        				}
                                      ?>
                                      
                                      <h5>Add New Note</h5>
                                      <form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                            Category
                                                <select name="categoryofnote" required style="width:100%; padding:10px;">
                                                    <option value="Itinerary">Itinerary</option>
                                                    <option value="Datechange">Datechange</option>
                                                    <option value="Refund">Refund</option>
                                                    <option value="SSR">SSR</option>
                                                    <option value="Payments">Payments</option>
                                                    <option value="Eticket">Eticket</option>
                                                    <option value="INBOUND-Escalation">INBOUND-Escalation</option>
                                                    <option value="INBOUND - Normal">INBOUND - Normal</option>
                                                    <option value="OUTBOUND-Call back">OUTBOUND-Call back</option>
                                                    <option value="Others">Others</option>
                                                </select>
                                            </br> </br>
                                        <label for="Department">Department</label>
                                        <select name="department" required style="width:100%; padding:10px;">
                                            <option value="DC Form" selected>DC Form</option>
                                            <option value="DC Enquiry">DC Enquiry</option>
                                            <option value="DC Assistance">DC Assistance</option>
                                            <option value="RF Form">RF Form</option>
                                            <option value="RF Enquiry">RF Enquiry</option>
                                            <option value="RF Assistance">RF Assistance</option>
                                            <option value="SC Enquiry">SC Enquiry</option>
                                            <option value="SC Assistance">SC Assistance</option>
                                            <option value="Payments Conf">Payments Conf</option>
                                            <option value="Payment Info">Payment Info</option>
                                            <option value="ETicket Resent">ETicket Resent</option>
                                            <option value="ETicket Not Issued">ETicket Not Issued</option>
                                            <option value="Sales (New booking)">Sales (New booking)</option>
                                            <option value="Sales (Re-booking)">Sales (Re-booking)</option>
                                            <option value="Complaints">Complaints</option>
                                            <option value="SSR">SSR</option>
                                            <option value="Website">Website</option>
                                            <option value="Others">Others</option>
                                        </select>
                                             </br>  </br>   
                                            Description
                                            <textarea name="notedescription" required></textarea>
                                             </br>
                                            <center><input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='save_note_request_<?php echo $order_id_api; ?>' value='Save Note'></center>
                                		</form>
                                    <?php
                                    $save_note_request_in_g360_post_name = 'save_note_request_'.$order_id_api;

                                    if(isset($_POST[$save_note_request_in_g360_post_name]))
                                    {
                                        $categoryofnote = $_POST['categoryofnote'];
                                        $notedescription = $_POST['notedescription'];
                                        $department = $_POST['department'];
                                        
                                        $current_date_time = date("Y-m-d H:i:s");
                                        
                                        if(isset($_GET['nobel']) && $_GET['nobel'] == '1')
                                        {
                                            $note_column = 'Noble';
                                        }
                                        else
                                        {
                                            $note_column = '';
                                        }
                                        
                                        add_meta_from_history_of_updates_with_note($order_id_api, 'Booking Note Category', $categoryofnote, $note_column, $currnt_userlogn, $current_date_time );
                                        add_meta_from_history_of_updates_with_note($order_id_api, 'Booking Note Description', $notedescription, $note_column, $currnt_userlogn, $current_date_time);
                                        add_meta_from_history_of_updates_with_note($order_id_api, 'Booking Note Department', $department, $note_column, $currnt_userlogn, $current_date_time);
                                        
                                        add_g360_event_history($order_id_api, $co_order_id_api, $product_id_api, 'Notes submitted', $categoryofnote , $currnt_userlogn, $current_date_and_time);
                                        
                                        //include(get_template_directory().'/templates/email/tpl_email_g360_notes.php');

							            $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                    	echo '<script>window.location.href="'.$current_url.'";</script>';
                                    }
                                    ?>
                				</div>
                				
                				<div id="add_todo_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                				    <h6>Add Tasks</h6>
                                    <button class="tablinks chatcategory" onclick="openCity(event, 'ssr_request_<?php echo $order_id_api; ?>')">SSR Requests</button>
                                    <button class="tablinks chatcategory" onclick="openCity(event, 'miscellaneous_<?php echo $order_id_api; ?>')">Miscellaneous</button>

                				</div>
                				
                				<div id="escalation_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                        			<h6>All Escalations</h6>
                        			<table class="table" style="width:90%; font-size:14px; margin:auto; border:1px solid black;">
                        			    <tr>
                        			        <th>Type</th>
                        			        <th>by</th>
                        			        <th>on</th>
                        			        <th>To</th>
                        			        <th></th>
                        			    </tr>	
                            		<?php
                            		$order_id = $order_id_api;
                            		
                                	$query_msg = "SELECT * FROM wpk4_backend_travel_escalations where order_id='$order_id' order by escalated_on desc ";
                            			$result_msg = mysqli_query($mysqli, $query_msg);
                            			while($row_msg = mysqli_fetch_assoc($result_msg))
                            				{
                            				    $escalation_id = $row_msg['auto_id'];
                            				    $query_msg_chat = "SELECT * FROM wpk4_backend_travel_escalations_chat where escalation_id='$escalation_id' and added_by IN ('kajalk', 'lee')";
                                    			$result_msg_chat = mysqli_query($mysqli, $query_msg_chat);
                                    			$row_msg_chat_responded_by_ho = mysqli_num_rows($result_msg_chat);
                                    			$is_escalation_responded = 0;
                                    			if($row_msg_chat_responded_by_ho > 0)
                                    			{
                                    			    $is_escalation_responded = 1;
                                    			}
                            				?>
                            					<tr>
                        						<td><?php echo $row_msg['escalation_type']; ?></td>
                        						<td><?php echo $row_msg['escalated_by']; ?></td>
                        						<td><?php echo $row_msg['escalated_on']; ?></td>
                        						<td><?php echo $row_msg['escalate_to']; ?></td>
                        						<td>
                        						    
                        						        <a href="/manage-escalations?pg=view&id=<?php echo $row_msg['auto_id']; ?>">View</a> <?php if($is_escalation_responded == 1) { echo '*'; } ?>
                        						        
                        						 </td>
                        						</tr>
                            				<?php
                            				}
                            				?>
                            			</table>
                            		    
                            		 <?php
                            		 //if( current_user_can( 'administrator' ) || current_user_can( 'ho_operations' ) || current_user_can( 'cs_manager' ) || current_user_can( 'datechange_manager' ) ) 
                            		 {
                            		  ?>
                            		 
                            		<h5>New Escalation</h5>
                            		<script src="https://cdn.jsdelivr.net/gh/alumuko/vanilla-datetimerange-picker@latest/dist/vanilla-datetimerange-picker.js"></script>
    						        <script>
            						var currentdate = new Date(); 
            						var date_tomorrow = new Date((new Date()).valueOf() + 1000*3600*24);
            						window.addEventListener("load", function (event) {
    								let drp = new DateRangePicker('followup_date',
    										{
    											maxDate: date_tomorrow,
    											timePicker: true,
    											alwaysShowCalendars: true,
    											singleDatePicker: true,
    											autoApply: true,
    											autoUpdateInput: true,
    											
    											locale: {
    												format: "YYYY-MM-DD HH:mm a",
    											}
    										},
    										function (start) {
    											document.getElementById("followup_date").value = start.format();
    											
    										})
    								});
    								</script>
                                    	<form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                            <table>
                                                <tr>
                                                    <td>
                                                        Type
                                                        <select name="escalation_type" id="escalation_type" style="width:100%; padding:10px;">
                                                            <option value="">Select Type</option>
                                                            <option value="Fare Difference">Fare Difference</option>
                                                            <option value="E-Ticket Request">E-Ticket Request</option>
                                                            <option value="Schedule Change">Schedule Change</option>
															<option value="Deposit Nil / Full Payment Delay">Deposit Nil / Full Payment Delay</option>
															<option value="Payment Adjustment / Payment Link Request">Payment Adjustment / Payment Link Request</option>
															<option value="Gdeals SSR Request">Gdeals SSR Request</option>
															<option value="Gdeals Name Request">Gdeals Name Request</option>
															<option value="Void Request">Void Request</option>
															<option value="Passenger Information Update">Passenger Information Update</option>
															<option value="Tax Invoice Request">Tax Invoice Request</option>
															<option value="Infant Name Too Long">Infant Name Too Long</option>
															<option value="FIT  Unable to Issue Ticket">FIT  Unable to Issue Ticket</option>
															<option value="Duplicate Passenger">Duplicate Passenger</option>
															<option value="Qantas Name Correction">Qantas Name Correction</option>
															<option value="Overbooking Issue">Overbooking Issue</option>
															<option value="Refund Request">Refund Request</option>
															<option value="Agent mistake">Agent mistake</option>
															<option value="Other">Other</option>
                                                        </select>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        Followup Date
                                                        <input type='text' name='followup_date' id='followup_date'>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        Airline
                                                        <select name='airline' id='airline' style="width:100%; padding:10px; border-color: #dcd7ca;">
                                						<option selected value=''>Airline</option>
                                						<option value='Air India'>Air India</option>
                                						<option value='Cathay Pacific Airways'>Cathay Pacific Airways</option>
                                						<option value='China Airlines'>China Airlines</option>
                                						<option value='China Southern'>China Southern</option>
                                						<option value='Emirates'>Emirates</option>
                                						<option value='Etihad Airways'>Etihad Airways</option>
                                						<option value='Garuda Indonesia'>Garuda Indonesia</option>
                                						<option value='Jet Airways'>Jet Airways</option>
                                						<option value='Malaysia Airlines'>Malaysia Airlines</option>
                                						<option value='Qantas Airways'>Qantas Airways</option>
                                						<option value='Qatar Airways'>Qatar Airways</option>
                                						<option value='Saudi Arabian Airlines'>Saudi Arabian Airlines</option>
                                						<option value='Scoot Airlines'>Scoot Airlines</option>
                                						<option value='Singapore Airlines'>Singapore Airlines</option>
                                						<option value='South African Airways'>South African Airways</option>
                                						<option value='Srilankan Airlines'>Srilankan Airlines</option>
                                						<option value='Thai Airways'>Thai Airways</option>
                                						<option value='Viet Jet'>Viet Jet</option>
                                						<option value='Vietnam Airlines'>Vietnam Airlines</option>
                                						<option value='Air Asia'>Air Asia</option>
                                						<option value='Others'>Others</option>
                                						</select>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        Fare Difference
                                                        <input type="text" name="fare_difference">
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        New Options
                                                        <textarea name="new_option"></textarea>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        Existing PNR Screenshot
                                                        <input type='file' name='existing_pnr_screenshot' accept=".jpg,.jpeg,.png,.pdf" placeholder='Add Attachments'  >
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        New option screenshot
                                                        <input type='file' name='new_option_screenshot' accept=".jpg,.jpeg,.png,.pdf" placeholder='Add Attachments'  >
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        Note
                                                        <textarea name="input_note"></textarea>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        Other Note
                                                        <textarea name="other_note"></textarea>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        Escalate to
                                                        <select name="escalation_to" id="escalation_to" style="width:100%; padding:10px;">
                                                            <option value="">Select</option>
                                                            <option value="Manager">Escalate to Manager</option>
															<option value="HO">Escalate to HO</option>
                                                        </select>
                                                    </td>
                                                </tr>
                                                <tr>
                                    			    <td colspan='2'><center><input type='submit' style='padding:15px; margin:0;font-size:11px;' name="submit_escalation" id="submit_escalation" value='Submit'></center></td>
                                    			</tr>
                                            </table>
                                        </form>
                                        <?php
                                        if(isset($_POST['submit_escalation']))
                                        {
                                            $escalation_type = $_POST['escalation_type'];
                                            $input_note = $_POST['input_note'];
                                            $escalation_to = $_POST['escalation_to'];
                                            $followup_date = $_POST['followup_date'];
                                            $airline = $_POST['airline'];
                                            $fare_difference = $_POST['fare_difference'];
                                            $new_option = $_POST['new_option'];
                                            $other_note = $_POST['other_note'];

                                            if($escalation_type != '')
                                            {
                                                
                                                $currentDirectory = getcwd();
                                                $uploadDirectory = "wp-content/uploads/customized_function_uploads/";
                                                if (!is_dir($uploadDirectory)) {
                                                    mkdir($uploadDirectory, 0755, true);
                                                }
                                                
                                                $fileName = $_FILES['existing_pnr_screenshot']['name'];
                                                $fileName_attachment = '';
                                                if ($_FILES['existing_pnr_screenshot']['error'] === UPLOAD_ERR_OK && $fileName != '') {
                                                    $temp = explode(".", $fileName);
                                                    $ext = strtolower(end($temp));
                                                    $allowed = ['jpeg', 'jpg', 'png', 'pdf'];
                                                    
                                                    if (in_array($ext, $allowed)) {
                                                        if ($_FILES['existing_pnr_screenshot']['size'] <= 4000000) {
                                                            $filename_time = date('ymdHis') . '_' . uniqid();
                                                            $existingfilename = 'g360_escalation_' . $filename_time . '.' . $ext;
                                                            $uploadPath = $uploadDirectory . $existingfilename;
                                                            $fileName = $existingfilename;
                                                            $fileName_attachment = 'https://gauratravel.com.au/' . $uploadDirectory . $fileName;
                                                            if (move_uploaded_file($_FILES['existing_pnr_screenshot']['tmp_name'], $uploadPath)) {
                                                                echo "File uploaded successfully: $existingfilename";
                                                            } else {
                                                                echo "Failed to move uploaded file.";
                                                            }
                                                        } else {
                                                            echo "File size exceeds 4MB.";
                                                        }
                                                    } else {
                                                        echo "Invalid file extension: $ext";
                                                    }
                                                } else {
                                                    echo "Error uploading file: " . $_FILES['existing_pnr_screenshot']['error'];
                                                }
                                                
                                                $fileName_2 = $_FILES['new_option_screenshot']['name'];
                                                $fileName_2_attachment = '';
                                                if ($_FILES['new_option_screenshot']['error'] === UPLOAD_ERR_OK && $fileName_2 != '') {
                                                    $temp = explode(".", $fileName_2);
                                                    $ext = strtolower(end($temp));
                                                    $allowed = ['jpeg', 'jpg', 'png', 'pdf'];
                                                    
                                                    if (in_array($ext, $allowed)) {
                                                        if ($_FILES['new_option_screenshot']['size'] <= 4000000) {
                                                            $filename_time = date('ymdHis') . '_' . uniqid();
                                                            $existingfilename = 'g360_escalation_' . $filename_time . '.' . $ext;
                                                            $uploadPath = $uploadDirectory . $existingfilename;
                                                            $fileName_2 = $existingfilename;
                                                            $fileName_2_attachment = 'https://gauratravel.com.au/' . $uploadDirectory . $fileName_2;
                                                            if (move_uploaded_file($_FILES['new_option_screenshot']['tmp_name'], $uploadPath)) {
                                                                echo "File uploaded successfully: $existingfilename";
                                                            } else {
                                                                echo "Failed to move uploaded file.";
                                                            }
                                                        } else {
                                                            echo "File size exceeds 4MB.";
                                                        }
                                                    } else {
                                                        echo "Invalid file extension: $ext";
                                                    }
                                                } else {
                                                    echo "Error uploading file: " . $_FILES['new_option_screenshot']['error'];
                                                }
                                                
                                                
                                                mysqli_query($mysqli,"insert into wpk4_backend_travel_escalations ( order_id, escalation_type, note, status, escalate_to, escalated_by, followup_date, airline, fare_difference, new_option, existing_pnr_screenshot, new_option_screenshot, other_note ) 
    						                    values ('$order_id_api', '$escalation_type', '$input_note', 'open', '$escalation_to', '$currnt_userlogn', '$followup_date', '$airline', '$fare_difference', '$new_option', '$fileName', '$fileName_2', '$other_note' )") or die(mysqli_error($mysqli));
                                    			
    						                    if($currnt_userlogn == 'lee')
                                    			{
                                    			    include(get_template_directory().'/templates/email/tpl_email_escalation_submission.php');
                                    			}
                                    			
    						                    $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
    						                    echo '<script>window.location.href="'.$current_url.'";</script>';
                                            }
                                            else
                                            {
                                                echo '<script>alert("Kindly add the escalation details");</script>';
                                            }
                                        }
            		                }
                                ?>
        				        </div>
        				        
                				<div id="todo_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                        			<h6>All Tasks</h6>
                            		<?php
                            		$order_id = $order_id_api;
                            		$query_is_dc_submitted = "SELECT * FROM wpk4_backend_travel_datechange_request where order_id='$order_id_api'";
                            		$result_is_dc_submitted = mysqli_query($mysqli, $query_is_dc_submitted) or die(mysqli_error($mysqli));
                            		$row_is_dc_submitted_count = mysqli_num_rows($result_is_dc_submitted);
                            		if($row_is_dc_submitted_count>20)
                            		{
                            		    ?>
                            		    <div>
                            		    <h6>Datechange Tasks</h6>
                            		    </div>
                            		    <?php
                            			while($row_dc_submitted = mysqli_fetch_assoc($result_is_dc_submitted))
                            			{
                                			if($row_dc_submitted['status'] == 'new')
                                			{
                                				echo '<font style="font-size:12px;color:red;">Not Approved Yet</font>';
                                			}
                                			else if ($row_dc_submitted['status'] == 'updated')
                                			{
                                				echo '<font style="font-size:12px;color:green;">Below request has been approved</font>';
                                			}
                                			else if ($row_dc_submitted['status'] == 'declined')
                                			{
                                				echo '<font style="font-size:12px;color:red;">Request has been declined</font>';
                                			}
                                			else
                                			{
                                				echo '<font style="font-size:12px;color:red;">Not Checked Yet</font>';
                                			}
                                			?>
                        				    <table class="table" style="width:90%; font-size:14px; margin:auto; border:1px solid black;">	
                                				<tr>
                                					<td>Order ID</br>
                                						<?php echo $row_dc_submitted['order_id']; ?>
                                					</td>
                                					<td>
                            							Payment Received</br>
                                						<?php echo $row_dc_submitted['payment_received']; ?>
                                					</td>
                                					<td>
                            							Ticket Issued</br>
                                						<?php echo $row_dc_submitted['ticket_issued']; ?>
                                					</td>
                            						<td>
                            							DC Cost</br>
                                						<?php echo $row_dc_submitted['dc_cost_taken']; ?>
                                					</td>
                            						<td>
                            							Partial Change</br>
                                						<?php echo $row_dc_submitted['partial_change']; ?>
                                					</td>
                            						<td>
                            							Agent</br>
                                						<?php echo $row_dc_submitted['agent']; ?>
                                					</td>
                                				</tr>
                                				<tr>
                                					<td>Original Travel Date</br>
                                						<?php echo $row_dc_submitted['original_travel_date']; ?>
                                						<input type='hidden' readonly name='auto_id' value='<?php echo $row_dc_submitted['auto_id']; ?>'>
                                						<input type='hidden' readonly name='original_travel_date' value='<?php echo $row_dc_submitted['original_travel_date']; ?>'>
                                					</td>
                                					<td>
                            							Original Pax Count</br>
                                						<?php echo $row_dc_submitted['original_no_of_pax']; ?>
                                					</td>
                                					<td>
                            							Original Tripcode</br>
                                						<?php echo $row_dc_submitted['original_tripcode']; ?>
                                						<input type='hidden' readonly name='original_tripcode' value='<?php echo $row_dc_submitted['original_tripcode']; ?>'>
                                					</td>
                            						<td>
                            							New Travel Date</br>
                                						<?php echo $row_dc_submitted['new_travel_date']; ?>
                                						<input type='hidden' readonly name='new_travel_date' value='<?php echo $row_dc_submitted['new_travel_date']; ?>'>
                                					</td>
                            						<td>
                            							New Pax Count</br>
                                						<?php echo $row_dc_submitted['new_no_of_pax']; ?>
                                						<input type='hidden' readonly name='new_no_of_pax' value='<?php echo $row_dc_submitted['new_no_of_pax']; ?>'>
                                					</td>
                            						<td>
                            							New Tripcode</br>
                                						<?php echo $row_dc_submitted['new_tripcode']; ?>
                                						<input type='hidden' readonly name='new_tripcode' value='<?php echo $row_dc_submitted['new_tripcode']; ?>'>
                                					</td>
                                				</tr>
                            					<tr>
                                					<td colspan="6">Remark</br>
                                						<?php echo $row_dc_submitted['remark']; ?>
                                					</td>
                                				</tr>
                            			    </table>
                            			    </br></br>
                        		        <?php
                        		        }
                        		    }
                            	    $task_title_captured = '';
                            	
                                	$query_1 = "SELECT * FROM wpk4_backend_todo_tasks where order_id='$order_id_api' order by comment_type asc, comment_date_time desc";
                                	$result_1 = mysqli_query($mysqli, $query_1) or die(mysqli_error($mysqli));
                                	$row_2_count = mysqli_num_rows($result_1);
                                	while($row_2 = mysqli_fetch_assoc($result_1))
                                	{
                                		$auto_id_message = $row_2['auto_id'];
                                		$comment_type = $row_2['comment_type'];
                                    	?>
                                    	<h6><?php 
                                    	if($task_title_captured != $comment_type)
                                    	{
                                    		echo $comment_type;
                                    		$task_title_captured = $comment_type;
                                    	}
                                    	else
                                    	{
                                    		$task_title_captured = $comment_type;
                                    	}
                                    	?></h6>
                            			<table class="table" style="width:90%; font-size:14px; margin:auto; border:1px solid black;">	
                                			<tr>
                                				<td>by <?php echo $row_2['comment_by']; ?> 
                                					on <?php echo $row_2['comment_date_time']; ?> 
                                					&nbsp; 
                                					|&nbsp;&nbsp;<span style='<?php if($row_2['status']=='open') { echo 'background-color:green;'; } else { echo 'background-color:red;'; } ?>padding:2px 5px; color:white;'><?php echo $row_2['status']; ?></span>&nbsp;&nbsp;<?php if($row_2['updated_by'] != '' && $row_2['status_updated_on'] != '0000-00-00 00:00:00' && $row_2['status'] != 'open') { echo ' by '.$row_2['updated_by'] .' on '. $row_2['status_updated_on']; } ?> </font> </br>
                                					Payment Received: <?php echo $row_2['payment_received']; ?>
                                					</br>
                                					<?php echo $row_2['comment']; ?>
                                				</td>
                            				</tr>
                            			</table>				
                        			    <?php
                            			$auto_id = $row_2['auto_id']; 
                            			$query_msg = "SELECT * FROM wpk4_backend_todo_task_chat where request_id='$auto_id' order by response_time ";
                            			$result_msg = mysqli_query($mysqli, $query_msg);
                            			$row_msgcount = mysqli_num_rows($result_msg);
                            			while($row_msg = mysqli_fetch_assoc($result_msg))
                            				{
                            				?>
                            					<div class="wpb_column vc_col-sm-1">
                            						&nbsp;
                            					</div>
                        						<table class="table" style="width:90%; font-size:14px; margin:auto; border:1px solid black;">	
                        							<tr>
                        								<td>by <?php echo $row_msg['response_by']; ?> on <?php echo $row_msg['response_time']; ?>
                        								</td>
                        								
                        								<td>
                        									<p style='font-size:13px;'><?php echo $row_msg['response']; ?></p>
                        								</td>
                        							</tr>
                        						</table>		
                            				<?php
                            				}
                            				?>
                            			<div class="wpb_column vc_col-sm-12">
                            				<div class="vc_column-inner">
                            					<div class="wpb_wrapper">
                            						<div class="vc_row wpb_row vc_inner vc_row-fluid vc_row-o-equal-height vc_row-flex">
                            							<div class="wpb_single_image wpb_content_element">
                            								&nbsp;
                            							</div>
                            						</div>
                            					</div>
                            				</div>
                            			</div>
                            		    <?php
                            	    	//$js_button_counter++;
                            	    }
                            		if($row_2_count==0)
                            		{
                            			echo '<div class="wpb_column vc_col-sm-12">
                            				<div class="vc_column-inner">
                            					<div class="wpb_wrapper">
                            						<div class="vc_row wpb_row vc_inner vc_row-fluid vc_row-o-equal-height vc_row-flex">
                            							<div class="wpb_single_image wpb_content_element">
                            								No Task Found..
                            							</div>
                            						</div>
                            					</div>
                            				</div>
                            			</div>';
                            		}		
                            			
                            		?>	
        				        </div>
        				        <?php
								$product_id_api_main = $product_id_api;
								?>
                				<div id="emails_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                				    <?php
                				    $order_id = $order_id_api;
                                		$query_select_order_email = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' order by auto_id limit 1";
                                		$result_select_order_email = mysqli_query($mysqli, $query_select_order_email);
                                		$row_select_order_email = mysqli_fetch_assoc($result_select_order_email);
                                		$customer_email = $row_select_order_email['email_pax'];
                                		
                                		$query_select_order_status = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api'";
                                		$result_select_order_status = mysqli_query($mysqli, $query_select_order_status);
                                		$row_select_order_status = mysqli_fetch_assoc($result_select_order_status);
                                		$order_payment_status = $row_select_order_status['payment_status'];
                                		
                                		$query_count_bookingemail = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='Booking Email' order by auto_id desc limit 1";
                                		$result_count_bookingemail = mysqli_query($mysqli, $query_count_bookingemail);
                                		$row_count_bookingemail = mysqli_num_rows($result_count_bookingemail);
                                		$row_bookingemail = mysqli_fetch_assoc($result_count_bookingemail);
                                		if($row_count_bookingemail==0)
                                		{
                                			$is_bookingemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_bookingemail_sent[]" value="'.$order_id_api.'">';
                                			$bookingemail_sent_on = '';
                                		}
                                		else
                                		{
                                			$is_bookingemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_bookingemail_sent[]" value="'.$order_id_api.'">';
                                			$bookingemail_sent_on = ' on '.$row_bookingemail['initiated_date'];
                                		}
                                		
                                		
                                		
                                		
                                		$query_count_mhpplemail = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='MH PPL Voucher' order by auto_id desc limit 1";
                                		$result_count_mhpplemail = mysqli_query($mysqli, $query_count_mhpplemail);
                                		$row_count_mhpplemail = mysqli_num_rows($result_count_mhpplemail);
                                		$row_mhpplemail = mysqli_fetch_assoc($result_count_mhpplemail);
                                		if($row_count_mhpplemail==0)
                                		{
                                			$is_mhpplemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_itineraryemail_sent[]" value="'.$order_id_api.'">';
                                			$mhppl_sent_on = '';
                                		}
                                		else
                                		{
                                			$is_mhpplemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_itineraryemail_sent[]" value="'.$order_id.'">';
                                			$mhppl_sent_on = ' on '.$row_mhpplemail['initiated_date'];
                                		}
                                		
                                		
                                		
                                		$query_count_itineraryemail = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='Itinerary Email' order by auto_id desc limit 1";
                                		$result_count_itineraryemail = mysqli_query($mysqli, $query_count_itineraryemail);
                                		$row_count_itineraryemail = mysqli_num_rows($result_count_itineraryemail);
                                		$row_itineraryemail = mysqli_fetch_assoc($result_count_itineraryemail);
                                		if($row_count_itineraryemail==0)
                                		{
                                			$is_itineraryemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_itineraryemail_sent[]" value="'.$order_id_api.'">';
                                			$itineraryemail_sent_on = '';
                                		}
                                		else
                                		{
                                			$is_itineraryemail_sent = '<input type="checkbox" onclick="return false;" checked id="inv" name="is_itineraryemail_sent[]" value="'.$order_id.'">';
                                			$itineraryemail_sent_on = ' on '.$row_itineraryemail['initiated_date'];
                                		}	
                                		
                                		$query_count_taxinvoice = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='Tax Invoice' order by auto_id desc limit 1";
                                		$result_count_taxinvoice = mysqli_query($mysqli, $query_count_taxinvoice);
                                		$row_count_taxinvoice = mysqli_num_rows($result_count_taxinvoice);
                                		$row_taxinvoice = mysqli_fetch_assoc($result_count_taxinvoice);
                                		if($row_count_taxinvoice==0)
                                		{
                                			$is_tax_invoice_sent = '<input type="checkbox" onclick="return false;" id="inv" name="is_tax_invoice_sent[]" value="'.$order_id_api.'">'; $tax_invoice_sent_on = '';
                                		}
                                		else
                                		{
                                			$is_tax_invoice_sent = '<input type="checkbox" checked onclick="return false;" id="inv" name="is_tax_invoice_sent[]" value="'.$order_id_api.'">'; 
                                			$tax_invoice_sent_on = ' on '.$row_taxinvoice['initiated_date'];
                                		}
                                		
                                		$query_count_payment_update = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='Payment Update' order by auto_id desc limit 1";
                                		$result_count_payment_update = mysqli_query($mysqli, $query_count_payment_update);
                                		$row_count_payment_update = mysqli_num_rows($result_count_payment_update);
                                		$row_paymentupdate = mysqli_fetch_assoc($result_count_payment_update);
                                		if($row_count_payment_update==0)
                                		{
                                			$is_payment_update_sent = '<input type="checkbox" onclick="return false;" id="pay" name="is_payment_update_sent[]" value="'.$order_id_api.'">'; $payment_update_sent_on = '';
                                		}
                                		else
                                		{
                                			$is_payment_update_sent = '<input type="checkbox" checked onclick="return false;" id="pay" name="is_payment_update_sent[]" value="'.$order_id_api.'">'; 
                                			$payment_update_sent_on = ' on '.$row_paymentupdate['initiated_date'];
                                		}
                                		
                                		$query_count_eticket_update = "SELECT * FROM wpk4_backend_order_email_history where order_id='$order_id_api' && email_type='Eticket Email' order by auto_id desc limit 1";
                                		$result_count_eticket_update = mysqli_query($mysqli, $query_count_eticket_update);
                                		$row_count_eticket_update = mysqli_num_rows($result_count_eticket_update);
                                		$row_eticketupdate = mysqli_fetch_assoc($result_count_eticket_update);
                                		if($row_count_eticket_update==0)
                                		{
                                			$is_eticket_update_sent = '<input type="checkbox" onclick="return false;" id="pay" name="is_payment_update_sent[]" value="'.$order_id_api.'">'; $eticket_update_sent_on = '';
                                		}
                                		else
                                		{
                                			$is_eticket_update_sent = '<input type="checkbox" checked onclick="return false;" id="pay" name="is_payment_update_sent[]" value="'.$order_id_api.'">'; 
                                			$eticket_update_sent_on = ' on '.$row_eticketupdate['initiated_date'];
                                		}
                                		?>
                                			<table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
                                				<tr>
                                					<td>Itinerary Email</td>
                                					<td><?php echo $is_itineraryemail_sent . ' ' . $itineraryemail_sent_on; ?></td>
                                					<td>
                                					    <form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                    						<input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='sent_itinerary_email' value='Sent Itinerary Email'>
                                    					</form>
                                					</td>
                                					<td>
                                						<button id="toggleButton_email_itinerary_<?php echo $order_id_api; ?>" style='padding:15px; margin:0;font-size:11px; '>Show Preview</button>
                                					</td>
                                				</tr>
                                				<tr>
                                    				<td>Payment Email</td>
                                    				<td><?php echo $is_payment_update_sent . ' ' . $payment_update_sent_on; ?> </td>
                                    				<td>
                                    				    <form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                    						<input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='sent_payment_email' value='Sent Payment Email'>
                                    					</form>
                                    					
                                    				</td>
                                    				<td><button id="toggleButton_email_payment_<?php echo $order_id_api; ?>" style='padding:15px; margin:0;font-size:11px; '>Show Preview</button></td>
                                    			</tr>
                                    			<?php
                                    			//if($currnt_userlogn == 'sriharshans')
                                    			{
                                    			?>
                                    			<tr>
                                    				<td>MH Webcheckin Email</td>
                                    				<td></td>
                                    				<td>
                                    				    <form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                    						<input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='sent_mh_webcheckin_email' value='Sent MH Webcheck In Email'>
                                    					</form>
                                    				</td>
                                    				<td><button id="toggleButton_email_mh_webcheckin_<?php echo $order_id_api; ?>" style='padding:15px; margin:0;font-size:11px; '>Show Preview</button></td>
                                    			</tr>
                                    			<?php
            		                            }
                                    			$processedPaxChange = [];
            		                            $query_pax_eticket_loopg = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api' and order_type = 'WPT'";
                                        		$result_pax_eticket_loopg = mysqli_query($mysqli, $query_pax_eticket_loopg);
                                        		while($row_pax_eticket_loop_countg = mysqli_fetch_assoc($result_pax_eticket_loopg))
                                        		{
                                        		    $order_id_api2 = $row_pax_eticket_loop_countg['order_id'];
                                        		    $product_id_api = $row_pax_eticket_loop_countg['product_id'];
                                        		    
                                        		    if (in_array($product_id_api, $processedPaxChange)) 
                                					{
                                						continue;
                                					}
                                					
                                					$processedPaxChange[] = $product_id_api;
                                        		    
                                        		    $query_pax_eticket_loop = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' AND product_id='$product_id_api'";
                                                		$result_pax_eticket_loop = mysqli_query($mysqli, $query_pax_eticket_loop);
                                                		$row_pax_eticket_loop_count = mysqli_num_rows($result_pax_eticket_loop);
                                            			?>
                                            			<tr>
                                            				<td rowspan = '<?php echo $row_pax_eticket_loop_count; ?>'><b><?php echo $row_pax_eticket_loop_countg['trip_code']; ?></b></br></br>Eticket Email</td>
                                            				<?php
                                            				$loop_count_pax = 0;
                                            				while($row_pax_eticket_loop = mysqli_fetch_assoc($result_pax_eticket_loop))
                                                		    {
                                                		        $loop_count_pax ++;
                                                		        $pax_id = $row_pax_eticket_loop['auto_id'];
                                                		        $product_id_for_limit_loop = $row_pax_eticket_loop['product_id'];
                                                		        ?>
                                                				<td><?php echo $row_pax_eticket_loop['fname']; ?> <?php echo $row_pax_eticket_loop['lname']; ?> <?php echo $is_eticket_update_sent . ' ' . $eticket_update_sent_on; ?> </td>
                                                				<td>
                                                				    <?php
                                                				    //if($currnt_userlogn == 'sriharshans' || $currnt_userlogn == 'lee')
                                            			            {
                                                				    ?>
                                                					</br>
                                                					<?php
                                                    				if($loop_count_pax == 1)
                                                    				{
                                                    				?>
                                                        				<form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                                        				    <input type="hidden" class='product_id_new' name="product_id_new" id="product_id_new" value="<?php echo $product_id_for_limit_loop; ?>">
                                                    						<input type='submit' style='padding:15px; margin:0;font-size:11px;' name='sent_bulk_eticket_email' value='Sent Bulk Eticket Email'>
                                                    			        </form>
                                                        				</br>
                                                    				<?php
                                                    				}
                                                    				?>
                                                    				<?php
                                            			            }
                                                    				?>
                                                				</td>
                                                				
                                                				<td><a target="_blank" href="?option=preview-eticket&order=<?php echo $order_id_api; ?>&pax=<?php echo $pax_id; ?>&product=<?php echo $product_id_api; ?>"><button id="toggleButton_email_eticket_<?php echo $order_id_api; ?><?php echo $pax_id; ?><?php echo $product_id_api; ?>" style='padding:15px; margin:0;font-size:11px; '>Show Preview</button></a></td>
                                            				    
                                            				    <?php
                                            				    echo '</tr>';
																
																
                                                            		
                                    		                       
                                                            		
                                    		                        
                    		                                }
                    		                                ?>
                                            			</tr>
                                        		    <?php
                                        		}
                                        		
                                        		
                                    			$query_pax_eticket_loop_fit = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' and product_id='$product_id_api' and order_type = 'gds'";
                                        		$result_pax_eticket_loop_fit = mysqli_query($mysqli, $query_pax_eticket_loop_fit);
                                        		$row_pax_eticket_loop_count_fit = mysqli_num_rows($result_pax_eticket_loop_fit);
                                        		if(mysqli_num_rows($result_pax_eticket_loop_fit) > 0)
                                        		{
                                        		    
                                        		
                                    			?>
                                    			<tr>
                                    				<td rowspan = '<?php echo $row_pax_eticket_loop_count_fit; ?>'>Eticket Email</td>
                                    				<?php
                                    				$loop_count_pax = 0;
                                    				while($row_pax_eticket_loop = mysqli_fetch_assoc($result_pax_eticket_loop_fit))
                                        		    {
                                        		        $loop_count_pax ++;
                                        		        $pax_id = $row_pax_eticket_loop['auto_id'];
                                        		        ?>
                                        				<td><?php echo $row_pax_eticket_loop['fname']; ?> <?php echo $row_pax_eticket_loop['lname']; ?> <?php echo $is_eticket_update_sent . ' ' . $eticket_update_sent_on; ?> </td>
                                        				<td>
                                        				    <?php
                                        				    //if($currnt_userlogn == 'sriharshans' || $currnt_userlogn == 'lee')
                                    			            {
                                        				    ?>
                                        					</br>
                                        					<?php
                                            				if($loop_count_pax == 1)
                                            				{
                                            				?>
                                                				<form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                                				    <input type="hidden" class='product_id_new' name="product_id_new" id="product_id_new" value="<?php echo $product_id_api; ?>">
                                            						<input type='submit' style='padding:15px; margin:0;font-size:11px;' name='sent_bulk_eticket_email' value='Sent Bulk Eticket Email'>
                                            			        </form>
                                                				</br>
                                            				<?php
                                            				}
                                            				?>
                                            				<?php
                                    			            }
                                            				?>
                                        				</td>
                                        				
                                        				<td><button id="toggleButton_email_eticket_<?php echo $order_id_api; ?><?php echo $pax_id; ?>" style='padding:15px; margin:0;font-size:11px; '>Show Preview</button></td>
                                    				    <?php
                                    				    echo '</tr>';
            		                                    }
            		                                ?>
                                    			</tr>
                                    			<?php
                                    			
            		                        
                                        		}
                                        		
                                        		
                                            		
                                    			?>
                                    			
				                                <tr>
                                    				<td>Custom Email</td>
                                    				<td>
                                    				    <form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                    					   <select id="custom_email_selector" name="custom_email_selector" style="width:100%; padding:10px;">
                                    					       <option value="">Select Type</option>
                                                                <option value="thank_you_for_travelling">Thank you for travelling</option>
                                                        </select>
                                                    </td>
                                    				<td>
                                    					  
                                    						  <input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='sent_custom_email' value='Sent Custom Email'>
                                    					  </form>
                                    				        
                                    				</td>
                                    				<td><button id="toggleButton_email_custom_<?php echo $order_id_api; ?>" style='padding:15px; margin:0;font-size:11px; '>Show Preview</button></td>
                                    			</tr>
                                    			
				                                <tr>
                                    				<td>MH PPL Voucher Email</td>
                                    				<td><?php echo $is_mhpplemail_sent . ' ' . $mhppl_sent_on; ?> </td>
                                    				<td>
                                    				    <form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                    						<input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='sent_mh_ppl_voucher_email' value='Sent MH PPL Voucher Email'>
                                    					</form>
                                    				</td>
                                    				<td><button id="toggleButton_email_mh_ppl_<?php echo $order_id_api; ?>" style='padding:15px; margin:0;font-size:11px; '>Show Preview</button></td>
                                    			</tr>
                                			</table>

                                			
                                			
                                			
                                			
                                			<?php
                                			$today_date = date("Y-m-d H:i:s");
											
											
											if(mysqli_num_rows($result_pax_eticket_loop_fit) > 0)
                                        	{
												$query_pax_eticket_loop = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api'";
                                            	$result_pax_eticket_loop = mysqli_query($mysqli, $query_pax_eticket_loop);
                                            	$row_pax_eticket_loop_count = mysqli_num_rows($result_pax_eticket_loop);
                                        		while($row_pax_eticket_loop = mysqli_fetch_assoc($result_pax_eticket_loop))
                		                        {
                		                            $pax_id = $row_pax_eticket_loop['auto_id'];
                		                            ?>
                		                            <div id="email_eticketPreview_<?php echo $order_id_api; ?><?php echo $pax_id; ?>" style="display: none;">
                                                        <?php
                                                		$emailsubject = "Eticket Information - ".$order_id_api;
                                                        include(get_template_directory().'/templates/email/tpl_email_eticket_preview.php');
                                                        ?>
                                                    </div>
                		                            <?php
                		                        }
            		                        
                                    			$query_pax_eticket_loop = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api'";
                                                	$result_pax_eticket_loop = mysqli_query($mysqli, $query_pax_eticket_loop);
                                                	$row_pax_eticket_loop_count = mysqli_num_rows($result_pax_eticket_loop);
                                            		while($row_pax_eticket_loop = mysqli_fetch_assoc($result_pax_eticket_loop))
                    		                        {
                    		                            $pax_id = $row_pax_eticket_loop['auto_id'];
                    		                            ?>
                    		                            <script>
                    		                                document.getElementById("toggleButton_email_eticket_<?php echo $order_id_api; ?><?php echo $pax_id; ?>").addEventListener("click", function() {
                                                              var myDiv_payment = document.getElementById("email_eticketPreview_<?php echo $order_id_api; ?><?php echo $pax_id; ?>");
                                                              if (myDiv_payment.style.display === "none") {
                                                                myDiv_payment.style.display = "block";
                                                                this.textContent = "Hide Preview";
                                                              } else {
                                                                myDiv_payment.style.display = "none";
                                                                this.textContent = "Show Preview";
                                                              }
                                                            });
                    		                            </script>
                    		                            <?php
                    		                        }	
											}
                                			?>
                                			
                                			<div id="email_custom_Thankyou_Preview_<?php echo $order_id_api; ?>" style="display: none;">
                                			    <?php
                                    			$emailsubject = "Thank you for travelling with us";
                                                include(get_template_directory().'/templates/email/tpl_email_custom_template_thankyou_preview.php');
                                                ?>
                                			</div>
                                			
                                			<div id="email_custom_Review_Preview_<?php echo $order_id_api; ?>" style="display: none;">
                                			    <?php
                                    			$emailsubject = "Rate us for your experience";
                                                //include(get_template_directory().'/templates/email/tpl_email_custom_template_review_preview.php');
                                                ?>
                                			</div>
                                			
                                			<div id="email_custom_MH_PPL_Voucher_Preview_<?php echo $order_id_api; ?>" style="display: none;">
                                			    <?php
                                                include(get_template_directory().'/templates/email/tpl_email_custom_template_mh_ppl_voucher_preview.php');
                                                ?>
                                			</div>
                                			
                                    		<div id="email_itineraryPreview_<?php echo $order_id_api; ?>" style="display: none;">
                                                <?php
                                    			$emailsubject = "Itinerary Information - ".$order_id_api;
                                                if($order_type_itinerary == 'WPT' || $order_type_itinerary == '' || $order_type_itinerary == 'Agent')
        				                        {
                                    			    include(get_template_directory().'/templates/email/tpl_email_itinerary_preview.php');
        				                        }
        				                        else if($order_type_itinerary == 'gds')
        				                        {
                                    			    include(get_template_directory().'/templates/email/tpl_email_itinerary_preview_gds.php');
        				                        }
        				                        else
        				                        {
        				                            echo 'No system email found';
        				                        }    
                                    			
                                                ?>
                                            </div>
                                            
                                            <div id="email_paymentPreview_<?php echo $order_id_api; ?>" style="display: none;">
                                                <?php
                                    			$emailsubject = "Payment Information - ".$order_id_api;
                                                $payment_selector = $order_payment_status;
                                                include(get_template_directory().'/templates/email/tpl_email_trigger_payment_preview.php');
                                                ?>
                                            </div>
                                            
                                            
                                            <div id="email_mh_webcheckinPreview_<?php echo $order_id_api; ?>" style="display: none;">
                                                <?php
                                                include(get_template_directory().'/templates/email/tpl_email_trigger_mh_webcheck_preview.php');
                                                ?>
                                            </div>
                                            
                                            
                                            <div id="email_mh_ppl_Preview_<?php echo $order_id_api; ?>" style="display: none;">
                                                <?php
                                                include(get_template_directory().'/templates/email/tpl_email_custom_template_mh_ppl_voucher_preview.php');
                                                ?>
                                            </div>
                                            
                                            
                                              
            		                            
                                            
                                            
                                    		<script>
                                    		    document.getElementById("toggleButton_email_itinerary_<?php echo $order_id_api; ?>").addEventListener("click", function() {
                                                  var myDiv_itinerary = document.getElementById("email_itineraryPreview_<?php echo $order_id_api; ?>");
                                                  if (myDiv_itinerary.style.display === "none") {
                                                    myDiv_itinerary.style.display = "block";
                                                    this.textContent = "Hide Preview";
                                                  } else {
                                                    myDiv_itinerary.style.display = "none";
                                                    this.textContent = "Show Preview";
                                                  }
                                                });
                                                
                                                document.getElementById("toggleButton_email_payment_<?php echo $order_id_api; ?>").addEventListener("click", function() {
                                                  var myDiv_payment = document.getElementById("email_paymentPreview_<?php echo $order_id_api; ?>");
                                                  if (myDiv_payment.style.display === "none") {
                                                    myDiv_payment.style.display = "block";
                                                    this.textContent = "Hide Preview";
                                                  } else {
                                                    myDiv_payment.style.display = "none";
                                                    this.textContent = "Show Preview";
                                                  }
                                                });
                                                
                                                
                                                
                                                document.getElementById("toggleButton_email_mh_webcheckin_<?php echo $order_id_api; ?>").addEventListener("click", function() {
                                                  var myDiv_mhwebcheck = document.getElementById("email_mh_webcheckinPreview_<?php echo $order_id_api; ?>");
                                                  if (myDiv_mhwebcheck.style.display === "none") {
                                                    myDiv_mhwebcheck.style.display = "block";
                                                    this.textContent = "Hide Preview";
                                                  } else {
                                                    myDiv_mhwebcheck.style.display = "none";
                                                    this.textContent = "Show Preview";
                                                  }
                                                });
                                                
                                                document.getElementById("toggleButton_email_mh_ppl_<?php echo $order_id_api; ?>").addEventListener("click", function() {
                                                  var myDiv_mhppl = document.getElementById("email_mh_ppl_Preview_<?php echo $order_id_api; ?>");
                                                  if (myDiv_mhppl.style.display === "none") {
                                                    myDiv_mhppl.style.display = "block";
                                                    this.textContent = "Hide Preview";
                                                  } else {
                                                    myDiv_mhppl.style.display = "none";
                                                    this.textContent = "Show Preview";
                                                  }
                                                });

                                                /* CUSTOM EMAIL VIEWER START */
                                                const custom_email_selector_id = document.getElementById("custom_email_selector");
                                                custom_email_selector_id.addEventListener("change", function() {
                                                    document.getElementById("email_custom_Thankyou_Preview_<?php echo $order_id_api; ?>").style.display = "none";
                                                    document.getElementById("email_custom_MH_PPL_Voucher_Preview_<?php echo $order_id_api; ?>").style.display = "none";
                                                    document.getElementById("toggleButton_email_custom_<?php echo $order_id_api; ?>").textContent = "Show Preview";
                                                });

                                                document.getElementById("toggleButton_email_custom_<?php echo $order_id_api; ?>").addEventListener("click", function() {
                                                    if (custom_email_selector_id.value === "thank_you_for_travelling") {
                                                        document.getElementById("email_custom_Thankyou_Preview_<?php echo $order_id_api; ?>").style.display = "block";
                                                        document.getElementById("email_custom_MH_PPL_Voucher_Preview_<?php echo $order_id_api; ?>").style.display = "none";
                                                        this.textContent = "Hide Preview";
                                                    } 
                                                    else if (custom_email_selector_id.value === "mh_ppl_voucher") {
                                                        document.getElementById("email_custom_Thankyou_Preview_<?php echo $order_id_api; ?>").style.display = "none";
                                                        document.getElementById("email_custom_MH_PPL_Voucher_Preview_<?php echo $order_id_api; ?>").style.display = "block";
                                                        this.textContent = "Hide Preview";
                                                    }
                                                    else
                                                    {
                                                        document.getElementById("email_custom_Thankyou_Preview_<?php echo $order_id_api; ?>").style.display = "none";
                                                        document.getElementById("email_custom_MH_PPL_Voucher_Preview_<?php echo $order_id_api; ?>").style.display = "none";
                                                        this.textContent = "Show Preview";
                                                    }
                                                });
                                                /* CUSTOM EMAIL VIEWER END */

                                              function confirmSubmit() {
                                                var confirmed = confirm("Do you want to submit the form?");
                                                return confirmed;
                                              }
                                            </script>
                                    		<?php
                                    		$themepath = get_stylesheet_directory_uri();
                                            $themepath = str_replace("https://gauratravel.com.au/","",$themepath);
                                            
                                            
                                            
                                            
                                    		if(isset($_POST['sent_itinerary_email']))
                                    		{
                                    			$today_date = date("Y-m-d H:i:s");
                                    			
                                    			if($order_type_itinerary == 'WPT' || $order_type_itinerary == '' || $order_type_itinerary == 'Agent')
        				                        {
        				                            $emailsubject = "Itinerary Information - ".$order_id_api;
                                    			    include(get_template_directory().'/templates/email/tpl_email_itinerary_gdeal.php');
        				                        }
        				                        else if($order_type_itinerary == 'gds')
        				                        {
        				                            $query_pax_lead_traveller = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' order by auto_id asc limit 1";
                                            		$result_pax_lead_traveller = mysqli_query($mysqli, $query_pax_lead_traveller);
                                            		$row_pax_lead_traveller = mysqli_fetch_assoc($result_pax_lead_traveller);
                                                        $pnr_for_email = $row_pax_lead_traveller['pnr'];
            
        				                            $emailsubject = "Itinerary Information - ".$pnr_for_email;
                                    			    include(get_template_directory().'/templates/email/tpl_email_itinerary_gds.php');
        				                        }
        				                        else
        				                        {
        				                            echo 'No system email found';
        				                        }
        				                        
        				                        add_g360_event_history($order_id_api, $co_order_id_api, $product_id_api, 'Itinerary Email has been sent to pax', "" , $currnt_userlogn, $current_date_and_time);
        				                        
                                    			global $wpdb;
                                    			$email_subject = 'Itinerary Information';
                                    			$wpdb->insert('wpk4_backend_order_email_history', array(
                                                    'email_type' =>'Itinerary Email',
                                                    'order_id' =>$order_id_api,
                                                    'email_address' => $customer_email,
                                                    'initiated_date' => $today_date,
                                    				'initiated_by' => $currnt_userlogn,
                                                    'email_subject' => $email_subject,
                                                ));
                                                $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                    			echo '<script>window.location.href="'.$current_url.'";</script>';
                                    		}
                                    		
                                    		
                                    		if(isset($_POST['sent_mh_ppl_voucher_email']))
                                    		{
                                    			$today_date = date("Y-m-d H:i:s");
                                    			$email_subject = "MH PPL Voucher - ".$order_id_api;
                                    			include(get_template_directory().'/templates/email/tpl_email_custom_template_mh_ppl_voucher.php');
                                    			
                                    			global $wpdb;
                                    			$wpdb->insert('wpk4_backend_order_email_history', array(
                                                    'email_type' =>'MH PPL Voucher',
                                                    'order_id' =>$order_id,
                                                    'email_address' => $customer_email,
                                                    'initiated_date' => $today_date,
                                    				'initiated_by' => $currnt_userlogn,
                                                    'email_subject' => $email_subject,
                                                ));
                                    			echo '<script>window.location.href="'.$defaultlink_gaura.'";</script>';
                                    			
                                    		}
                                    		
                                    		
                                    		if(isset($_POST['sent_payment_email']))
                                    		{
                                    			$today_date = date("Y-m-d H:i:s");
                                    			$email_subject = "Payment Information - ".$order_id_api;
                                    			$payment_selector = $order_payment_status;
                                    			$order_id = $order_id_api;
                                    			include(get_template_directory().'/templates/email/tpl_email_trigger_payment.php');
                                    			
                                    			global $wpdb;
                                    			$wpdb->insert('wpk4_backend_order_email_history', array(
                                                    'email_type' =>'Payment Update',
                                                    'order_id' =>$order_id,
                                                    'email_address' => $customer_email,
                                                    'initiated_date' => $today_date,
                                    				'initiated_by' => $currnt_userlogn,
                                                    'email_subject' => $email_subject,
                                                ));
                                    			echo '<script>window.location.href="'.$defaultlink_gaura.'";</script>';
                                    			
                                    		}
                                    		
                                    		
                                    		if(isset($_POST['sent_mh_webcheckin_email']))
                                    		{
                                    			$today_date = date("Y-m-d H:i:s");
                                    			$email_subject = "MH Web check-in Information - ".$order_id_api;
                                    			$payment_selector = $order_payment_status;
                                    			include(get_template_directory().'/templates/email/tpl_email_trigger_mh_webcheck.php');
                                    			
                                    			global $wpdb;
                                    			$wpdb->insert('wpk4_backend_order_email_history', array(
                                                    'email_type' =>'MH Web check in Update G360',
                                                    'order_id' =>$order_id,
                                                    'email_address' => $customer_email,
                                                    'initiated_date' => $today_date,
                                    				'initiated_by' => $currnt_userlogn,
                                                    'email_subject' => $email_subject,
                                                ));
                                    			echo '<script>window.location.href="'.$defaultlink_gaura.'";</script>';
                                    			
                                    		}
                                    		
                                    		
                                    		if(isset($_POST['sent_bulk_eticket_email']))
                                    		{
                                    			$today_date = date("Y-m-d H:i:s");
                                    			if(isset($product_id_api) && $product_id_api != '')
                                    			{
                                    			    $product_id_for_limit_loop = $product_id_api;
                                    			}
                                    			
                                    			if(isset($_POST['product_id_new']) && $_POST['product_id_new'] != '')
                                    			{
                                    			    $product_id_for_limit_loop = $_POST['product_id_new'];
                                    			}
                                    			
                                    			
                                    			$order_id = $order_id_api;
                                    			include(get_template_directory().'/templates/email/tpl_email_eticket_bulk_with_itinerary.php');
                                    			global $wpdb;
                                    			$email_subject = 'Eticket - ' . $order_id;
                                    			$wpdb->insert('wpk4_backend_order_email_history', array(
                                                    'email_type' =>'Eticket Email',
                                                    'order_id' =>$order_id,
                                                    'email_address' => $customer_email,
                                                    'initiated_date' => $today_date,
                                    				'initiated_by' => $currnt_userlogn,
                                                    'email_subject' => $email_subject,
                                                ));
                                    			echo '<script>window.location.href="'.$defaultlink_gaura.'";</script>';
                                    			
                                    		}
                                    		
                                    		if(isset($_POST['sent_individual_eticket_email']))
                                    		{
                                    			$today_date = date("Y-m-d H:i:s");
                                    			$pax_id = $_POST['paxid'];
                                    			$order_id = $order_id_api;
                                    			include(get_template_directory().'/templates/email/tpl_email_eticket.php');
                                    			
                                    			global $wpdb;
                                    			$wpdb->insert('wpk4_backend_order_email_history', array(
                                                    'email_type' =>'Eticket Email',
                                                    'order_id' =>$order_id,
                                                    'email_address' => $customer_email,
                                                    'initiated_date' => $today_date,
                                    				'initiated_by' => $currnt_userlogn,
                                                    'email_subject' => $email_subject,
                                                ));
                                    			echo '<script>window.location.href="'.$defaultlink_gaura.'";</script>';
                                    			
                                    		}
                                    		
                                    		
        				                    if(isset($_POST['sent_custom_email']))
                                    		{
                                    			$today_date = date("Y-m-d H:i:s");
                                    			$email_subject = "Custom Email - ".$order_id_api;
                                    			$payment_selector = $order_payment_status;
                                    			
                                    			if($_POST['custom_email_selector'] == 'thank_you_for_travelling')
                                    			{
                                    			    include(get_template_directory().'/templates/email/tpl_email_custom_template_thankyou.php');
                                    			}
                                    			else if($_POST['custom_email_selector'] == 'mh_ppl_voucher')
                                    			{
                                    			    include(get_template_directory().'/templates/email/tpl_email_custom_template_mh_ppl_voucher.php');
                                    			}
                                    			
                                    			
                                    			
                                    			
                                    			global $wpdb;
                                    			$wpdb->insert('wpk4_backend_order_email_history', array(
                                                    'email_type' =>'Payment Update',
                                                    'order_id' =>$order_id,
                                                    'email_address' => $customer_email,
                                                    'initiated_date' => $today_date,
                                    				'initiated_by' => $currnt_userlogn,
                                                    'email_subject' => $email_subject,
                                                ));
                                    			echo '<script>window.location.href="'.$defaultlink_gaura.'";</script>';
                                    			
                                    		}
        				            
        				            ?>
                				</div>
                				<?php
								$product_id_api = $product_id_api_main;
								?>
    		    				<div id="itinerary_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
        				            <?php
        				            $order_id = $order_id_api;
        				            if($order_type_itinerary == 'WPT' || $order_type_itinerary == '')
        				            {
        				                echo '<h5>Current Itinerary</h5>';
        				                
        				                $order_id_for_itinerary = $order_id_api;
                    				    $query_order_booking_info_itinerary = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_for_itinerary' AND co_order_id='$co_order_id_api' order by travel_date asc";
                                		$result_order_booking_info_itinerary = mysqli_query($mysqli, $query_order_booking_info_itinerary) or die(mysqli_error($mysqli));
                                		while($row_order_booking_info_itinerary = mysqli_fetch_assoc($result_order_booking_info_itinerary))
                                		{
                                			$traveldate_fxed = $row_order_booking_info_itinerary['travel_date'];
                                			$product_title = $row_order_booking_info_itinerary['product_title'];
                                			$trip_code = $row_order_booking_info_itinerary['trip_code'];
                                			$product_id_itinerary = $row_order_booking_info_itinerary['product_id'];
                                			$new_product_id_itinerary = $row_order_booking_info_itinerary['new_product_id'];
                                			
                                			if($new_product_id_itinerary == '' || $new_product_id_itinerary == NULL )
                                			{
                                			    $wptravel_itineraries_r = get_post_meta( $product_id_itinerary, 'wp_travel_trip_itinerary_data', true );
                                    			$trip_wp_title = get_post_field( 'post_title', $product_id_itinerary );
                                    			$wptravel_travel_outline = get_post_meta( $product_id_itinerary, 'wp_travel_outline', true );
                                    			$productid_for_wptravel_product = $product_id_itinerary;
                                			}
                                			else
                                			{
                                			    $wptravel_itineraries_r = get_post_meta( $new_product_id_itinerary, 'wp_travel_trip_itinerary_data', true );
                                    			$trip_wp_title = get_post_field( 'post_title', $new_product_id_itinerary );
                                    			$wptravel_travel_outline = get_post_meta( $new_product_id_itinerary, 'wp_travel_outline', true );
                                    			$productid_for_wptravel_product = $new_product_id_itinerary;
                                			}
			
                                			


                                			if ( isset( $wptravel_itineraries_r ) && ! empty( $wptravel_itineraries_r ) ) : 
                                				$wptravel_index = 1;
                                				$itinerary_location_array = array();
                                				$itinerary_time_array = array();
                                				$itinerary_flight_array = array();
                                				$itinerary_date_array = array();
                                				$itinerary_datedecider_array = array();
                                				$itinerary_array_counter = 0;
                                				$itinerary_counter=0;	
                                				foreach ( $wptravel_itineraries_r as $wptravel_itinerary ) : 
                                					$wptravel_time_format = get_option( 'time_format' );
                                					$wptravel_itinerary_label = '';
                                					$wptravel_itinerary_title = '';
                                					$wptravel_itinerary_desc  = '';
                                					$wptravel_itinerary_date  = '';
                                					$wptravel_itinerary_time  = '';
                                					$itinerary_counter = 1;
                                					$is_itinerary_available = 1;
                                						$wptravel_itinerary_label = stripslashes( $wptravel_itinerary['label'] );
                                					
                                						$wptravel_itinerary_title = stripslashes( $wptravel_itinerary['title'] );
                                					
                                						$wptravel_itinerary_desc = stripslashes( $wptravel_itinerary['desc'] );
                                					
                                						$wptravel_itinerary_date = wptravel_format_date( $wptravel_itinerary['date'] );
                                					
                                						$wptravel_itinerary_time = stripslashes( $wptravel_itinerary['time'] );
                                						$wptravel_itinerary_time = date( $wptravel_time_format, strtotime( $wptravel_itinerary_time ) ); 
                                				    $itinerary_location_array[$itinerary_array_counter] = $wptravel_itinerary_label; // destination
                                					$itinerary_time_array[$itinerary_array_counter] = $wptravel_itinerary_time; // flight time
                                					$itinerary_flight_array[$itinerary_array_counter] = $wptravel_itinerary_title; // flight number
                                					$itinerary_date_array[$itinerary_array_counter] = $traveldate_fxed; // flight date
                                					$itinerary_datedecider_array[$itinerary_array_counter] = strip_tags($wptravel_itinerary_desc); // arrival or departure define
                                							
                                					$wptravel_index++;
                                					$itinerary_array_counter++;
                                					
                                				endforeach;
                                			endif; 
                                			// DEFINE EXTRA DAYS
                                            $itinerary_vals = '';
                                			$departure_date_plus_one = date("d/m/Y", strtotime("1 day", strtotime($traveldate_fxed))); 
                                			$departure_date_plus_two = date("d/m/Y", strtotime("2 day", strtotime($traveldate_fxed)));
                                			$departure_date_plus_three = date("d/m/Y", strtotime("3 day", strtotime($traveldate_fxed)));
                                			$departure_date_plus_four = date("d/m/Y", strtotime("4 day", strtotime($traveldate_fxed)));
                                			$length_aray = 0;
                                            if ( isset($itinerary_location_array) && is_array( $itinerary_location_array ) ) {
                                			$length_aray = count($itinerary_location_array);
                                			$itinerary_vals .= '<center><table class="m_-8969220568537220410 tripitinerary wp-travel-table-content trip_'.$product_id_itinerary.'" cellpadding="0" cellspacing="0" style="width:100%; text-align:left; border: 1px solid #e1e1e; border-collapse: collapse; margin:10px 0px 10px 0px; font-size:14px;">
                                			<thead>
                                			  <tr style="background: #f0f0f0; border:none;">
                                				 <th style="width:20%">From</th>
                                				 <th style="width:20%">To</th>
                                				 <th style="width:20%">Flight</th>
                                				 <th style="width:20%">Departure</th>
                                				 <th style="width:20%">Arrival</th>
                                			  </tr>
                                			</thead>
                                			<tbody>';
                                                    }
                                                    else {
                                            // Handle the case when $itinerary_location_array is null
                                            $itinerary_vals .= '<p>No itinerary locations found.</p>';
                                            }
                                			// SECTION TO DIVIDE WAITING, SELF TRANSFER AND FLIGHT INFO
                                			$is_printed_destination = '';
                                			for ($i = 0; $i < $length_aray; $i++) {
                                				if($itinerary_location_array[$i] == 'WAIT')
                                				{
                                					//$itinerary_vals .= "<tr>";
                                					//$itinerary_vals .= '<td colspan="5" style="width:30%">'.$itinerary_location_array[$i].' - '.$itinerary_flight_array[$i].'</td>';
                                					//$itinerary_vals .= "</tr>"; 
                                					
                                					$is_printed_destination = '';
                                				}
                                				else if($itinerary_location_array[$i] == 'SELF-TRANSFER')
                                				{
                                					//$itinerary_vals .= "<tr>";
                                					//$itinerary_vals .= '<td colspan="5" style="width:30%">'.$itinerary_datedecider_array[$i].' - '.$itinerary_flight_array[$i].'</td>';
                                					//$itinerary_vals .= "</tr>"; 
                                					
                                					$is_printed_destination = '';
                                				}
                                				else
                                				{
                                					if ($is_printed_destination == '') 
                            			            {
                            			                 
                            			                $date1 = date("Y-m-d", strtotime($itinerary_datedecider_array[$i]))." ".date("H:i:s", strtotime($itinerary_time_array[$i]));
                            			                if(isset($itinerary_datedecider_array[$i+1]) && isset($itinerary_time_array[$i+1]))
                            			                {
                                                            $date2 = date("Y-m-d", strtotime($itinerary_datedecider_array[$i+1]))." ".date("H:i:s", strtotime($itinerary_time_array[$i+1]));
                                                            $dateDiff = intval((strtotime($date2) - strtotime($date1)) / 60);
                            			                }
                            			                else
                            			                {
                            			                    $dateDiff = intval((strtotime($date1) - strtotime($date1)) / 60);
                            			                }
                                                        
                                                        $hours = intval($dateDiff / 60); 
                                                        $minutes = $dateDiff % 60;
                                                        
                                                        $time_duration = $hours.":".$minutes;
                                                        $airline_from_itinerary = substr($itinerary_flight_array[$i],0,2);
                                            
                                    					$itinerary_vals .= "<tr>";
                                    					$itinerary_vals .= '<td style="width:20%">'.$itinerary_location_array[$i].'</td>';
                                    					if(isset($itinerary_location_array[$i+1])) { 
                                    					    $itinerary_vals .= '<td style="width:20%">'.$itinerary_location_array[$i+1].'</td>';
                                    					}
                                    					$itinerary_vals .= '<td style="width:20%">'.$itinerary_flight_array[$i].'</td>';
                                    					$itinerary_vals .= '<td style="width:20%">'.$itinerary_time_array[$i].'</br>'.$itinerary_datedecider_array[$i].'</td>';
                                    					if(isset($itinerary_time_array[$i+1]) && isset($itinerary_datedecider_array[$i+1])) { 
                                    					    $itinerary_vals .= '<td style="width:20%">'.$itinerary_time_array[$i+1].'</br>'.$itinerary_datedecider_array[$i+1].'</td>';
                                    					}
                                    					$itinerary_vals .= "</tr>";
                                    					$empty = '';
                                    					$itinerary_vals .= "<tr style='border:none;'>";
                                    					$itinerary_vals .= '<td colspan="2" style="border:none;">   Class: Economy
                                    					           </td>';
                                    					$itinerary_vals .= '<td colspan="2" style="border:none;">Operated by: '.$airline_from_itinerary.'</td>';
                                    					$itinerary_vals .= '<td style="border:none;">Duration: </td>';
                                    					$itinerary_vals .= "</tr>";
                                    					
                                    					$is_printed_destination = 'yes';
                            			            }
                            			            else
                            			            {
                            			                $is_printed_destination = '';
                            			            }
                                				}
                                			}
                                    		$itinerary_vals .= "</tbody></table></center></br></br>";
                                    		
                                    		$wptravel_travel_outline = get_post_meta( $productid_for_wptravel_product, 'wp_travel_outline', true );
                                            $pattern_to_remove_itinerary_table = '/<table class="tg">(.*?)<\/table>/s';
                                            $wptravel_travel_outline = preg_replace($pattern_to_remove_itinerary_table, '', $wptravel_travel_outline);
                                    		$itinerary_vals .= $wptravel_travel_outline;
                                    		
                                    		// REPLACE ALL THE FIXED WORDS AS DEPARTURE AND ARRIVAL ON BACKEND
                                    		$itinerary_vals = str_replace("Departure Date", '' ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Arrival Date", '' ,$itinerary_vals);
                                    		
                                    		$itinerary_vals = str_replace("Selected Date +4", $departure_date_plus_four ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Selected Date+4", $departure_date_plus_four ,$itinerary_vals);
                                    		
                                    		$itinerary_vals = str_replace("Selected Date +3", $departure_date_plus_three ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Selected Date+3", $departure_date_plus_three ,$itinerary_vals);
                                    		
                                    		$itinerary_vals = str_replace("Selected Date +2", $departure_date_plus_two ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Selected Date+2", $departure_date_plus_two ,$itinerary_vals);
                                    		
                                    		$itinerary_vals = str_replace("Selected Date+1", $departure_date_plus_one ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Selected Date +1", $departure_date_plus_one ,$itinerary_vals);
                                    		
                                    		$traveldate_fxed_1 = date("d/m/Y", strtotime($traveldate_fxed)); 
                                			$dep_date_ymd = date("Y-m-d", strtotime($traveldate_fxed)); 
                                			
                                    		$itinerary_vals = str_replace("Selected Date", $traveldate_fxed_1 ,$itinerary_vals);
                                			
                                			
                                    		$itinerary_vals = str_replace("Selected Date", $traveldate_fxed_1 ,$itinerary_vals);
                                    		
                                    		
                                    		$trip_code_post = get_post_meta($productid_for_wptravel_product, 'wp_travel_trip_code', true);
	                                        $itinerary_details = getGDealFlightItinerary($trip_code, $dep_date_ymd);
	                                        if($itinerary_details != '')
	                                        {
	                                            echo $itinerary_details;
	                                            echo $wptravel_travel_outline;
	                                        }
	                                        else
	                                        {
	                                           echo $itinerary_vals; 
	                                        }
	                                        

                                    		$wptravel_product_information_ordered = get_post_meta( $order_id_for_itinerary, 'order_items_data', true ); // get order product info for trip extras
                                            if (is_array($wptravel_product_information_ordered) || is_object($wptravel_product_information_ordered)) 
                                            {
                                                foreach ($wptravel_product_information_ordered as $key => $value) {
                                                    // Check if the 'trip_extras' key and 'id' key exist
                                                    if (isset($value['trip_extras']['id'])) {
                                                        // Extract "trip_extras" IDs
                                                        $tripExtrasIds = $value['trip_extras']['id'];
                                                        echo '<h6>Additional services</h6>';
                                                        // Print or use the values as needed
                                                        foreach ($tripExtrasIds as $value) {
                                                            echo '<li>'.get_the_title( $value ).'</li>';
                                                        }
                                                    } else {
                                                        echo "No additional services available.";
                                                    }
                                                }
                                    		}
                                    		echo '<hr>';
                                		}
                                		
                		                
                		                
                		                echo '</br></br>';
                		                
                		                
                		                
        				            }
        				            else if($order_type_itinerary == 'Agent' )
        				            {
        				                echo '<h5>Current Itinerary</h5>';
        				                
        				                $order_id_for_itinerary = $order_id_api;
                    				    $query_order_booking_info_itinerary = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_for_itinerary' AND co_order_id='$co_order_id_api' order by travel_date asc";
                                		$result_order_booking_info_itinerary = mysqli_query($mysqli, $query_order_booking_info_itinerary) or die(mysqli_error($mysqli));
                                		while($row_order_booking_info_itinerary = mysqli_fetch_assoc($result_order_booking_info_itinerary))
                                		{
                                			$traveldate_fxed = $row_order_booking_info_itinerary['travel_date'];
                                			$product_title = $row_order_booking_info_itinerary['product_title'];
                                			$trip_code = $row_order_booking_info_itinerary['trip_code'];
                                			$product_id_itinerary = $row_order_booking_info_itinerary['product_id'];
                                			$new_product_id_itinerary = $row_order_booking_info_itinerary['new_product_id'];
                                			
                                			if($new_product_id_itinerary == '' || $new_product_id_itinerary == NULL )
                                			{
                                			    $wptravel_itineraries_r = get_post_meta( $product_id_itinerary, 'wp_travel_trip_itinerary_data', true );
                                    			$trip_wp_title = get_post_field( 'post_title', $product_id_itinerary );
                                    			$wptravel_travel_outline = get_post_meta( $product_id_itinerary, 'wp_travel_outline', true );
                                    			$productid_for_wptravel_product = $product_id_itinerary;
                                			}
                                			else
                                			{
                                			    $wptravel_itineraries_r = get_post_meta( $new_product_id_itinerary, 'wp_travel_trip_itinerary_data', true );
                                    			$trip_wp_title = get_post_field( 'post_title', $new_product_id_itinerary );
                                    			$wptravel_travel_outline = get_post_meta( $new_product_id_itinerary, 'wp_travel_outline', true );
                                    			$productid_for_wptravel_product = $new_product_id_itinerary;
                                			}
			
                                			


                                			if ( isset( $wptravel_itineraries_r ) && ! empty( $wptravel_itineraries_r ) ) : 
                                				$wptravel_index = 1;
                                				$itinerary_location_array = array();
                                				$itinerary_time_array = array();
                                				$itinerary_flight_array = array();
                                				$itinerary_date_array = array();
                                				$itinerary_datedecider_array = array();
                                				$itinerary_array_counter = 0;
                                				$itinerary_counter=0;	
                                				foreach ( $wptravel_itineraries_r as $wptravel_itinerary ) : 
                                					$wptravel_time_format = get_option( 'time_format' );
                                					$wptravel_itinerary_label = '';
                                					$wptravel_itinerary_title = '';
                                					$wptravel_itinerary_desc  = '';
                                					$wptravel_itinerary_date  = '';
                                					$wptravel_itinerary_time  = '';
                                					$itinerary_counter = 1;
                                					$is_itinerary_available = 1;
                                						$wptravel_itinerary_label = stripslashes( $wptravel_itinerary['label'] );
                                					
                                						$wptravel_itinerary_title = stripslashes( $wptravel_itinerary['title'] );
                                					
                                						$wptravel_itinerary_desc = stripslashes( $wptravel_itinerary['desc'] );
                                					
                                						$wptravel_itinerary_date = wptravel_format_date( $wptravel_itinerary['date'] );
                                					
                                						$wptravel_itinerary_time = stripslashes( $wptravel_itinerary['time'] );
                                						$wptravel_itinerary_time = date( $wptravel_time_format, strtotime( $wptravel_itinerary_time ) ); 
                                				    $itinerary_location_array[$itinerary_array_counter] = $wptravel_itinerary_label; // destination
                                					$itinerary_time_array[$itinerary_array_counter] = $wptravel_itinerary_time; // flight time
                                					$itinerary_flight_array[$itinerary_array_counter] = $wptravel_itinerary_title; // flight number
                                					$itinerary_date_array[$itinerary_array_counter] = $traveldate_fxed; // flight date
                                					$itinerary_datedecider_array[$itinerary_array_counter] = strip_tags($wptravel_itinerary_desc); // arrival or departure define
                                							
                                					$wptravel_index++;
                                					$itinerary_array_counter++;
                                					
                                				endforeach;
                                			endif; 
                                			// DEFINE EXTRA DAYS
                                            $itinerary_vals = '';
                                			$departure_date_plus_one = date("d/m/Y", strtotime("1 day", strtotime($traveldate_fxed))); 
                                			$departure_date_plus_two = date("d/m/Y", strtotime("2 day", strtotime($traveldate_fxed)));
                                			$departure_date_plus_three = date("d/m/Y", strtotime("3 day", strtotime($traveldate_fxed)));
                                			$departure_date_plus_four = date("d/m/Y", strtotime("4 day", strtotime($traveldate_fxed)));
                                			$length_aray = 0;
                                            if ( isset($itinerary_location_array) && is_array( $itinerary_location_array ) ) {
                                			$length_aray = count($itinerary_location_array);
                                			$itinerary_vals .= '<center><table class="m_-8969220568537220410 tripitinerary wp-travel-table-content trip_'.$product_id_itinerary.'" cellpadding="0" cellspacing="0" style="width:100%; text-align:left; border: 1px solid #e1e1e; border-collapse: collapse; margin:10px 0px 10px 0px; font-size:14px;">
                                			<thead>
                                			  <tr style="background: #f0f0f0; border:none;">
                                				 <th style="width:20%">From</th>
                                				 <th style="width:20%">To</th>
                                				 <th style="width:20%">Flight</th>
                                				 <th style="width:20%">Departure</th>
                                				 <th style="width:20%">Arrival</th>
                                			  </tr>
                                			</thead>
                                			<tbody>';
                                                    }
                                                    else {
                                            // Handle the case when $itinerary_location_array is null
                                            $itinerary_vals .= '<p>No itinerary locations found.</p>';
                                            }
                                			// SECTION TO DIVIDE WAITING, SELF TRANSFER AND FLIGHT INFO
                                			$is_printed_destination = '';
                                			for ($i = 0; $i < $length_aray; $i++) {
                                				if($itinerary_location_array[$i] == 'WAIT')
                                				{
                                					//$itinerary_vals .= "<tr>";
                                					//$itinerary_vals .= '<td colspan="5" style="width:30%">'.$itinerary_location_array[$i].' - '.$itinerary_flight_array[$i].'</td>';
                                					//$itinerary_vals .= "</tr>"; 
                                					
                                					$is_printed_destination = '';
                                				}
                                				else if($itinerary_location_array[$i] == 'SELF-TRANSFER')
                                				{
                                					//$itinerary_vals .= "<tr>";
                                					//$itinerary_vals .= '<td colspan="5" style="width:30%">'.$itinerary_datedecider_array[$i].' - '.$itinerary_flight_array[$i].'</td>';
                                					//$itinerary_vals .= "</tr>"; 
                                					
                                					$is_printed_destination = '';
                                				}
                                				else
                                				{
                                					if ($is_printed_destination == '') 
                            			            {
                            			                 
                            			                $date1 = date("Y-m-d", strtotime($itinerary_datedecider_array[$i]))." ".date("H:i:s", strtotime($itinerary_time_array[$i]));
                            			                if(isset($itinerary_datedecider_array[$i+1]) && isset($itinerary_time_array[$i+1]))
                            			                {
                                                            $date2 = date("Y-m-d", strtotime($itinerary_datedecider_array[$i+1]))." ".date("H:i:s", strtotime($itinerary_time_array[$i+1]));
                                                            $dateDiff = intval((strtotime($date2) - strtotime($date1)) / 60);
                            			                }
                            			                else
                            			                {
                            			                    $dateDiff = intval((strtotime($date1) - strtotime($date1)) / 60);
                            			                }
                                                        
                                                        $hours = intval($dateDiff / 60); 
                                                        $minutes = $dateDiff % 60;
                                                        
                                                        $time_duration = $hours.":".$minutes;
                                                        $airline_from_itinerary = substr($itinerary_flight_array[$i],0,2);
                                            
                                    					$itinerary_vals .= "<tr>";
                                    					$itinerary_vals .= '<td style="width:20%">'.$itinerary_location_array[$i].'</td>';
                                    					if(isset($itinerary_location_array[$i+1])) { 
                                    					    $itinerary_vals .= '<td style="width:20%">'.$itinerary_location_array[$i+1].'</td>';
                                    					}
                                    					$itinerary_vals .= '<td style="width:20%">'.$itinerary_flight_array[$i].'</td>';
                                    					$itinerary_vals .= '<td style="width:20%">'.$itinerary_time_array[$i].'</br>'.$itinerary_datedecider_array[$i].'</td>';
                                    					if(isset($itinerary_time_array[$i+1]) && isset($itinerary_datedecider_array[$i+1])) { 
                                    					    $itinerary_vals .= '<td style="width:20%">'.$itinerary_time_array[$i+1].'</br>'.$itinerary_datedecider_array[$i+1].'</td>';
                                    					}
                                    					$itinerary_vals .= "</tr>";
                                    					$empty = '';
                                    					$itinerary_vals .= "<tr style='border:none;'>";
                                    					$itinerary_vals .= '<td colspan="2" style="border:none;">   Class: Economy
                                    					           </td>';
                                    					$itinerary_vals .= '<td colspan="2" style="border:none;">Operated by: '.$airline_from_itinerary.'</td>';
                                    					$itinerary_vals .= '<td style="border:none;">Duration: </td>';
                                    					$itinerary_vals .= "</tr>";
                                    					
                                    					$is_printed_destination = 'yes';
                            			            }
                            			            else
                            			            {
                            			                $is_printed_destination = '';
                            			            }
                                				}
                                			}
                                    		$itinerary_vals .= "</tbody></table></center></br></br>";
                                    		
                                    		$wptravel_travel_outline = get_post_meta( $productid_for_wptravel_product, 'wp_travel_outline', true );
                                            $pattern_to_remove_itinerary_table = '/<table class="tg">(.*?)<\/table>/s';
                                            $wptravel_travel_outline = preg_replace($pattern_to_remove_itinerary_table, '', $wptravel_travel_outline);
                                    		$itinerary_vals .= $wptravel_travel_outline;
                                    		
                                    		// REPLACE ALL THE FIXED WORDS AS DEPARTURE AND ARRIVAL ON BACKEND
                                    		$itinerary_vals = str_replace("Departure Date", '' ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Arrival Date", '' ,$itinerary_vals);
                                    		
                                    		$itinerary_vals = str_replace("Selected Date +4", $departure_date_plus_four ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Selected Date+4", $departure_date_plus_four ,$itinerary_vals);
                                    		
                                    		$itinerary_vals = str_replace("Selected Date +3", $departure_date_plus_three ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Selected Date+3", $departure_date_plus_three ,$itinerary_vals);
                                    		
                                    		$itinerary_vals = str_replace("Selected Date +2", $departure_date_plus_two ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Selected Date+2", $departure_date_plus_two ,$itinerary_vals);
                                    		
                                    		$itinerary_vals = str_replace("Selected Date+1", $departure_date_plus_one ,$itinerary_vals);
                                    		$itinerary_vals = str_replace("Selected Date +1", $departure_date_plus_one ,$itinerary_vals);
                                    		
                                    		$traveldate_fxed_1 = date("d/m/Y", strtotime($traveldate_fxed)); 
                                			$dep_date_ymd = date("Y-m-d", strtotime($traveldate_fxed)); 
                                			
                                    		$itinerary_vals = str_replace("Selected Date", $traveldate_fxed_1 ,$itinerary_vals);
                                			
                                			
                                    		$itinerary_vals = str_replace("Selected Date", $traveldate_fxed_1 ,$itinerary_vals);
                                    		
                                    		
                                    		$trip_code_post = get_post_meta($productid_for_wptravel_product, 'wp_travel_trip_code', true);
	                                        $itinerary_details = getGDealFlightItinerary($trip_code, $dep_date_ymd);
	                                        if($itinerary_details != '')
	                                        {
	                                            echo $itinerary_details;
	                                            echo $wptravel_travel_outline;
	                                        }
	                                        else
	                                        {
	                                           echo $itinerary_vals; 
	                                        }
	                                        

                                    		$wptravel_product_information_ordered = get_post_meta( $order_id_for_itinerary, 'order_items_data', true ); // get order product info for trip extras
                                            if (is_array($wptravel_product_information_ordered) || is_object($wptravel_product_information_ordered)) 
                                            {
                                                foreach ($wptravel_product_information_ordered as $key => $value) {
                                                    // Check if the 'trip_extras' key and 'id' key exist
                                                    if (isset($value['trip_extras']['id'])) {
                                                        // Extract "trip_extras" IDs
                                                        $tripExtrasIds = $value['trip_extras']['id'];
                                                        echo '<h6>Additional services</h6>';
                                                        // Print or use the values as needed
                                                        foreach ($tripExtrasIds as $value) {
                                                            echo '<li>'.get_the_title( $value ).'</li>';
                                                        }
                                                    } else {
                                                        echo "No additional services available.";
                                                    }
                                                }
                                    		}
                                    		echo '<hr>';
                                		}
                                		
                		                
                		                
                		                echo '</br></br>';
                		                
                		                
                		                
        				            }
        				            else if($order_type_itinerary == 'gds')
        				            {
        				                echo '<h5>Current Itinerary</h5>';
        				                $carrier = get_meta_from_history_of_updates($order_id_api, "Flightlegs MarketingCarrier");
        				                $flight_status_booking = get_meta_from_history_of_updates($order_id_api, "Flightlegs Status");
        				                $operating_carrier = get_meta_from_history_of_updates($order_id_api, "Flightlegs OperatingCarrier");
        				                $flight_number = get_meta_from_history_of_updates($order_id_api, "Flightlegs FlNr");
        				                $flight_equipment = get_meta_from_history_of_updates($order_id_api, "Flightlegs Equipment");
        				                $flight_PNR = get_meta_from_history_of_updates($order_id_api, "Flightlegs CrFileKey");
        				                $departure_airport = get_meta_from_history_of_updates($order_id_api, "Flightlegs DepApt");
        				                $destination_airport = get_meta_from_history_of_updates($order_id_api, "Flightlegs DestApt");
        				                $departure_time = get_meta_from_history_of_updates($order_id_api, "Flightlegs DepTime");
        				                $destination_time = get_meta_from_history_of_updates($order_id_api, "Flightlegs DestTime");
        				                $flight_class = get_meta_from_history_of_updates($order_id_api, "Flightlegs CosDescription");
        				                $flight_class_code = get_meta_from_history_of_updates($order_id_api, "Flightlegs Class");
        				                $flight_elapsed_time = get_meta_from_history_of_updates($order_id_api, "Flightlegs Elapsed");
        				                $flight_meals = get_meta_from_history_of_updates($order_id_api, "Flightlegs Meal");
        				                $flight_departure_terminal = get_meta_from_history_of_updates($order_id_api, "Flightlegs DepTerminal");
        				                $flight_destination_terminal = get_meta_from_history_of_updates($order_id_api, "Flightlegs DestTerminal");
        				                
                                        
                                        $carrier_array = explode(' | ', $carrier);
                                        $flight_status_booking_array = explode(' | ', $flight_status_booking);
                                        $operating_carrier_array = explode(' | ', $operating_carrier);
                                        $flight_equipment_array = explode(' | ', $flight_equipment);
                                        $flight_number_array = explode(' | ', $flight_number);
                                        $flight_PNR_array = explode(' | ', $flight_PNR);
                                        $departure_airport_array = explode(' | ', $departure_airport);
                                        $destination_airport_array = explode(' | ', $destination_airport);
                                        $departure_time_array = explode(' | ', $departure_time);
                                        $destination_time_array = explode(' | ', $destination_time);
                                        $flight_class_array = explode(' | ', $flight_class);
                                        $flight_class_code_array = explode(' | ', $flight_class_code);
                                        $flight_elapsed_time_array = explode(' | ', $flight_elapsed_time);
                                        $flight_meals_array = explode(' | ', $flight_meals);
                                        $flight_departure_terminal_array = explode(' | ', $flight_departure_terminal);
                                        $flight_destination_terminal_array = explode(' | ', $flight_destination_terminal);
                                        
                                        $combined_array = array();
                                        for ($i = 0; $i < count($carrier_array); $i++) {
                                            $combined_array[] = array(
                                                'carrier' => $carrier_array[$i] ?? '',
                                                'flight_booking_status' => $flight_status_booking_array[$i] ?? '',
                                                'operatingcarrier' => $operating_carrier_array[$i] ?? '',
                                                'flightequipment' => $flight_equipment_array[$i] ?? '',
                                                'flightnumber' => $flight_number_array[$i] ?? '',
                                                'flightpnr' => $flight_PNR_array[$i] ?? '',
                                                'departureairport' => $departure_airport_array[$i] ?? '',
                                                'destinationairport' => $destination_airport_array[$i] ?? '',
                                                'departuretime' => $departure_time_array[$i] ?? '',
                                                'destinationtime' => $destination_time_array[$i] ?? '',
                                                'flightclass' => $flight_class_array[$i] ?? '',
                                                'flightclasscode' => $flight_class_code_array[$i] ?? '',
                                                'flightelapedtime' => $flight_elapsed_time_array[$i] ?? '',
                                                'flightdepartureterminal' => $flight_departure_terminal_array[$i] ?? '',
                                                'flightdestinationterminal' => $flight_destination_terminal_array[$i] ?? '',
                                                'flightmeals' => $flight_meals_array[$i] ?? ''
                                            );
                                        }
                                        
                                        echo '<table cellpadding="0" cellspacing="0" style="width:100%; text-align:left; border: 1px solid #e1e1e; border-collapse: collapse; margin:10px 0px 10px 0px; font-size:14px;">';
                                        echo '<tr>
                                        <th width="6%">AirlinePNR</th>
                                                <th width="4%">Airline</th>
                                                <th width="7%">Operating Airline</th>
                                                <th width="5%">Aircraft Type</th>
                                                <th width="8%">Dep Airport</th>
                                                <th width="12%">Dep Date</th>
                                                <th width="7%">Flight</th>
                                                <th width="8%">Dest Airport</th>
                                                <th width="12%">Destination Time</th>
                                                <th width="8%">Class</th>
                                                <th width="6%">Meal</th>
                                                <th width="8%">Duration</th>
                                                <th width="8%">Status</th>
                                        </tr>';
                                        $waitTime = '';
                                        $waitHours = '';
                                        $previousDepTime = null;
            
                                        foreach ($combined_array as $index => $item) {
                                            $totalMinutes = (int)$item['flightelapedtime'] * 60;
                                            $hours = floor($totalMinutes / 60);
                                            $minutes = $totalMinutes % 60;
                                            $timeFormatted = sprintf("%dh %dmin", $hours, $minutes);
                                            if ($index > 0) {
                                                $currentDepTime = strtotime($item['departuretime']);
                                                $previousDestTime = strtotime($combined_array[$index - 1]['destinationtime']);
                                                $waitTimeMinutes = round(($currentDepTime - $previousDestTime) / 60);
                                                $waitHours = floor($waitTimeMinutes / 60);
                                                $waitMinutes = $waitTimeMinutes % 60;
                                                $waitTime = sprintf("%dh %dmin", $waitHours, $waitMinutes);
                                            } else {
                                                $waitTime = '';
                                            }
                                            if ($waitTime !== '' && $waitHours < 24) {
                                                echo '<tr>';
                                                echo '<td colspan="7">WAIT: ' . $waitTime . '</td>';
                                                echo '</tr>';
                                            }
                                            if ($waitHours >= 24 && $waitTime !== '') {
                                                echo '</table></br><table cellpadding="0" cellspacing="0" style="width:100%; text-align:left; border: 1px solid #e1e1e; border-collapse: collapse; margin:10px 0px 10px 0px; font-size:14px;">
                                                <tr>
                                                <th width="6%">AirlinePNR</th>
                                                <th width="4%">Airline</th>
                                                <th width="7%">Operating Airline</th>
                                                <th width="5%">Aircraft Type</th>
                                                <th width="8%">Dep Airport</th>
                                                <th width="12%">Dep Date</th>
                                                <th width="7%">Flight</th>
                                                <th width="8%">Dest Airport</th>
                                                <th width="12%">Destination Time</th>
                                                <th width="8%">Class</th>
                                                <th width="6%">Meal</th>
                                                <th width="8%">Duration</th>
                                                <th width="8%">Status</th>
                                                </tr>';
                                            }
                                            echo '<tr>';
                                            echo '<td>' . $item['flightpnr'] . '</td>';
                                            echo '<td>' . $item['carrier'] . '</td>';
                                            echo '<td>' . $item['operatingcarrier'] . '</td>';
                                            echo '<td>' . $item['flightequipment'] . '</td>';
                                            echo '<td>' . $item['departureairport'] . '</br>' . $item['flightdepartureterminal'] . '</td>';
                                            echo '<td>' . $item['departuretime'] . '</td>';
                                            echo '<td>' . $item['carrier'] . $item['flightnumber'] . '</td>';
                                            echo '<td>' . $item['destinationairport'] . '</br>' . $item['flightdestinationterminal'] . '</td>';
                                            echo '<td>' . $item['destinationtime'] . '</td>';
                                            echo '<td>' . $item['flightclasscode'] . ' - ' . $item['flightclass'] . '</td>';
                                            echo '<td>' . $item['flightmeals'] . '</td>';
                                            echo '<td>' . $timeFormatted . '</td>'; // flight time
                                            echo '<td>' . $item['flight_booking_status'] . '</td>';
                                            echo '</tr>';
                                            $previousDepTime = strtotime($item['departuretime']);
                                        }
                                        echo '</table>';
        				                
        				            }
        				            else
        				            {
        				                echo '<p>No itinerary locations found.</p>';
        				            }
        				            
        				            if($row_selection_meta_existingcount > 1)
                                    {
                                        echo '<br><br>';
                                        echo '<h5>Past Itinerary</h5>';
                                        
                                        $flight_status_booking_changelog = get_meta_from_history_of_updates($order_id_api, "Flightlegs Status");
                                        $operating_carrier_changelog = get_meta_from_history_of_updates($order_id_api, "Flightlegs OperatingCarrier");
                                        $flight_equipment_changelog = get_meta_from_history_of_updates($order_id_api, "Flightlegs Equipment");
                                        $flight_PNR_changelog = get_meta_from_history_of_updates($order_id_api, "Flightlegs CrFileKey");

        				                $carrier_changelog = get_meta_from_history_of_updates_meta_changelog($order_id, "Flightlegs MarketingCarrier");
        				                $flight_number_changelog = get_meta_from_history_of_updates_meta_changelog($order_id, "Flightlegs FlNr");
        				                $departure_airport_changelog = get_meta_from_history_of_updates_meta_changelog($order_id, "Flightlegs DepApt");
        				                $destination_airport_changelog = get_meta_from_history_of_updates_meta_changelog($order_id, "Flightlegs DestApt");
        				                $departure_time_changelog = get_meta_from_history_of_updates_meta_changelog($order_id, "Flightlegs DepTime");
        				                $destination_time_changelog = get_meta_from_history_of_updates_meta_changelog($order_id, "Flightlegs DestTime");
        				                $flight_class_changelog = get_meta_from_history_of_updates_meta_changelog($order_id, "Flightlegs CosDescription");
        				                $flight_class_code_changelog = get_meta_from_history_of_updates_meta_changelog($order_id, "Flightlegs Class");
        				                $flight_elapsed_time_changelog = get_meta_from_history_of_updates_meta_changelog($order_id, "Flightlegs Elapsed");
        				                $flight_meals_changelog = get_meta_from_history_of_updates_meta_changelog($order_id, "Flightlegs Meal");
        				                $flight_departure_terminal_changelog = get_meta_from_history_of_updates_meta_changelog($order_id, "Flightlegs DepTerminal");
        				                $flight_destination_terminal_changelog = get_meta_from_history_of_updates_meta_changelog($order_id, "Flightlegs DestTerminal");
        				                
                                        
                                        $carrier_array_changelog = explode(' | ', $carrier_changelog);
                                        $flight_status_booking_array_changelog = explode(' | ', $flight_status_booking_changelog);
                                        $operating_carrier_array_changelog = explode(' | ', $operating_carrier_changelog);
                                        $flight_equipment_array_changelog = explode(' | ', $flight_equipment_changelog);
                                        $flight_PNR_array_changelog = explode(' | ', $flight_PNR_changelog);

                                        $flight_number_array_changelog = explode(' | ', $flight_number_changelog);
                                        $departure_airport_array_changelog = explode(' | ', $departure_airport_changelog);
                                        $destination_airport_array_changelog = explode(' | ', $destination_airport_changelog);
                                        $departure_time_array_changelog = explode(' | ', $departure_time_changelog);
                                        $destination_time_array_changelog = explode(' | ', $destination_time_changelog);
                                        $flight_class_array_changelog = explode(' | ', $flight_class_changelog);
                                        $flight_class_code_array_changelog = explode(' | ', $flight_class_code_changelog);
                                        $flight_elapsed_time_array_changelog = explode(' | ', $flight_elapsed_time_changelog);
                                        $flight_meals_array_changelog = explode(' | ', $flight_meals_changelog);
                                        $flight_departure_terminal_array_changelog = explode(' | ', $flight_departure_terminal_changelog);
                                        $flight_destination_terminal_array_changelog = explode(' | ', $flight_destination_terminal_changelog);
                                        
                                        $combined_array_2 = array();
                                        for ($i = 0; $i < count($carrier_array_changelog); $i++) {
                                            $combined_array_2[] = array(
                                                'carrier' => $carrier_array_changelog[$i],
                                                'flight_booking_status' => $flight_status_booking_array_changelog[$i] ?? '',
                                                'operatingcarrier' => $operating_carrier_array_changelog[$i] ?? '',
                                                'flightequipment' => $flight_equipment_array_changelog[$i] ?? '',
                                                'flightpnr' => $flight_PNR_array_changelog[$i] ?? '',
                                                'flightnumber' => $flight_number_array_changelog[$i],
                                                'departureairport' => $departure_airport_array_changelog[$i],
                                                'destinationairport' => $destination_airport_array_changelog[$i],
                                                'departuretime' => $departure_time_array_changelog[$i],
                                                'destinationtime' => $destination_time_array_changelog[$i],
                                                'flightclass' => $flight_class_array_changelog[$i],
                                                'flightclasscode' => $flight_class_code_array_changelog[$i],
                                                'flightelapedtime' => $flight_elapsed_time_array_changelog[$i],
                                                'flightdepartureterminal' => $flight_departure_terminal_array_changelog[$i],
                                                'flightdestinationterminal' => $flight_destination_terminal_array_changelog[$i],
                                                'flightmeals' => $flight_meals_array_changelog[$i]
                                            );
                                        }
                                        
                                        echo '<table cellpadding="0" cellspacing="0" style="width:100%; text-align:left; border: 1px solid #e1e1e; border-collapse: collapse; margin:10px 0px 10px 0px; font-size:14px;">';
                                        echo '<tr>
                                        <th width="6%">AirlinePNR</th>
                                                <th width="4%">Airline</th>
                                                <th width="7%">Operating Airline</th>
                                                <th width="5%">Aircraft Type</th>
                                                <th width="8%">Dep Airport</th>
                                                <th width="12%">Dep Date</th>
                                                <th width="7%">Flight</th>
                                                <th width="8%">Dest Airport</th>
                                                <th width="12%">Destination Time</th>
                                                <th width="8%">Class</th>
                                                <th width="6%">Meal</th>
                                                <th width="8%">Duration</th>
                                                <th width="8%">Status</th>
                                        </tr>';
                                        $waitTime = '';
                                        $waitHours = '';
                                        $previousDepTime = null;

                                        foreach ($combined_array_2 as $index => $item_changelog) {
                                            $totalMinutes = (int)$item_changelog['flightelapedtime'] * 60;
                                            $hours = floor($totalMinutes / 60);
                                            $minutes = $totalMinutes % 60;
                                            $timeFormatted = sprintf("%dh %dmin", $hours, $minutes);
                                            if ($index > 0) {
                                                $currentDepTime = strtotime($item_changelog['departuretime']);
                                                $previousDestTime = strtotime($combined_array_2[$index - 1]['destinationtime']);
                                                $waitTimeMinutes = round(($currentDepTime - $previousDestTime) / 60);
                                                $waitHours = floor($waitTimeMinutes / 60);
                                                $waitMinutes = $waitTimeMinutes % 60;
                                                $waitTime = sprintf("%dh %dmin", $waitHours, $waitMinutes);
                                            } else {
                                                $waitTime = '';
                                            }
                                            if ($waitTime !== '' && $waitHours < 24) {
                                                echo '<tr>';
                                                echo '<td colspan="7">WAIT: ' . $waitTime . '</td>';
                                                echo '</tr>';
                                            }
                                            if ($waitHours >= 24 && $waitTime !== '') {
                                                echo '</table></br><table cellpadding="0" cellspacing="0" style="width:100%; text-align:left; border: 1px solid #e1e1e; border-collapse: collapse; margin:10px 0px 10px 0px; font-size:14px;">
                                                <th width="6%">AirlinePNR</th>
                                                <th width="4%">Airline</th>
                                                <th width="7%">Operating Airline</th>
                                                <th width="5%">Aircraft Type</th>
                                                <th width="8%">Dep Airport</th>
                                                <th width="12%">Dep Date</th>
                                                <th width="7%">Flight</th>
                                                <th width="8%">Dest Airport</th>
                                                <th width="12%">Destination Time</th>
                                                <th width="8%">Class</th>
                                                <th width="6%">Meal</th>
                                                <th width="8%">Duration</th>
                                                <th width="8%">Status</th>
                                                </tr>';
                                            }
                                            echo '<tr>';
                                            echo '<td>' . $item_changelog['flightpnr'] . '</td>';
                                            echo '<td>' . $item_changelog['carrier'] . '</td>';
                                            echo '<td>' . $item_changelog['operatingcarrier'] . '</td>';
                                            echo '<td>' . $item_changelog['flightequipment'] . '</td>';
                                            echo '<td>' . $item_changelog['departureairport'] . '</br>' . $item_changelog['flightdepartureterminal'] . '</td>';
                                            echo '<td>' . $item_changelog['departuretime'] . '</td>';
                                            echo '<td>' . $item_changelog['carrier'] . $item_changelog['flightnumber'] . '</td>';
                                            echo '<td>' . $item_changelog['destinationairport'] . '</br>' . $item_changelog['flightdestinationterminal'] . '</td>';
                                            echo '<td>' . $item_changelog['destinationtime'] . '</td>';
                                            echo '<td>' . $item_changelog['flightclasscode'] . ' - ' . $item_changelog['flightclass'] . '</td>';
                                            echo '<td>' . $item_changelog['flightmeals'] . '</td>';
                                            echo '<td>' . $timeFormatted . '</td>'; // flight time
                                            echo '<td>' . $item_changelog['flight_booking_status'] . '</td>';
                                            echo '</tr>';
                                            $previousDepTime = strtotime($item_changelog['departuretime']);
                                        }
                                        echo '</table>';
            		                }
            		                
                				    ?>
                				</div>
                				
                				<div id="history_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                                    <?php
                                        $order_id = $order_id_api;
                                        
                                        $query_ticketing_history = "SELECT * FROM wpk4_backend_travel_booking_update_history where order_id='$order_id_api' AND meta_key = 'G360Events' AND meta_value IN ('Booking Search', 'Noble Search') order by updated_time DESC";
                                    	$result_ticketing_history = mysqli_query($mysqli, $query_ticketing_history);
                                    	$count_ticketing_history = mysqli_num_rows($result_ticketing_history);
                        				if($count_ticketing_history > 0)
                        				{
                                    	?>
                                    	<h5>G360 History</h5>
                                    	<table style="font-size:13px;">
                                            <tr><th>Type</th><th>on</th><th>By</th></tr>
                                    	    <?php
                                        	while($row_payment_history = mysqli_fetch_assoc($result_ticketing_history))
                                        	{
                            						?>	
                            							<tr>
                            								<td><?php echo $row_payment_history['meta_value']; ?> <?php echo $row_payment_history['meta_key_data']; ?></td>
                            								<td><?php echo $row_payment_history['updated_time']; ?></td>
                            								<td><?php echo $row_payment_history['updated_user']; ?></td>
                            							</tr>
                            						<?php
                                        	}
                        				}
                        				else
                        				{
                        				    echo '<h5>G360 History</h5>';
                        				    echo 'No record found';
                        				}
                                    	?>
                                        </table>
                				    </div>
                				    
                				<div id="change_history_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                                    <?php
                                        $order_id = $order_id_api;
                                        $processedPaxChange = [];
                                        $processedOrders = []; // processed meta_key and merge with updated date to skip duplicates
                        				$processedPax = []; // skip the posted pax details

                                        $query_change_ticketing_history = "SELECT * FROM wpk4_backend_travel_booking_update_history where order_id='$order_id_api' order by updated_time DESC";
                                    	$result_change_ticketing_history = mysqli_query($mysqli, $query_change_ticketing_history);
                                    	$count_change_ticketing_history = mysqli_num_rows($result_change_ticketing_history);
                        				if($count_change_ticketing_history > 0)
                        				{
                                    	?>
                                    	<h5>Change History</h5>
                                    	<table style="font-size:13px;">
                                            <tr><th>Type</th><th>on</th><th>By</th></tr>
                                    	    <?php
                                        	while($row_change_payment_history = mysqli_fetch_assoc($result_change_ticketing_history))
                                        	{
                                        	    if($row_change_payment_history['meta_key'] == 'payment_status')
                                        	    {
                            						?>	
                            							<tr>
                            								<td>Payment: <?php echo $row_change_payment_history['meta_value']; ?> <?php echo $row_change_payment_history['meta_key_data']; ?></td>
                            								<td><?php echo $row_change_payment_history['updated_time']; ?></td>
                            								<td><?php echo $row_change_payment_history['updated_user']; ?></td>
                            							</tr>
                            						<?php
                                        	    }
                                        	    
                                        	    if($row_change_payment_history['meta_key'] == 'pnr_status')
                                        	    {
                                        	        $pax_auto_id = $row_change_payment_history['pax_auto_id'];
                                        	        
                                					$query_change_payment_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' && auto_id = '$pax_auto_id'";
                                					$result_change_payment_pax = mysqli_query($mysqli, $query_change_payment_pax);
                                					$row_change_payment_pax = mysqli_fetch_assoc($result_change_payment_pax);
                                					if(mysqli_num_rows($result_change_payment_pax) > 0)
                                					{
                                					    $pax_id_received = $row_change_payment_pax['auto_id'];
                                						if (!in_array($pax_id_received, $processedPaxChange)) 
                                						{
                                							$is_pax_name_posted = 1;
                                						}
                                						else
                                						{
                                							$is_pax_name_posted = 0;
                                						}
                                							
                                						$processedPaxChange[] = $pax_id_received;
                                						if($is_pax_name_posted == 1)
                                						{
                                						    
                                    						?>
                                    						<tr>
                                    						    <td colspan="4"><b><?php echo $row_change_payment_pax['salutation']; ?> <?php echo $row_change_payment_pax['fname']; ?> <?php echo $row_change_payment_pax['lname']; ?></b></td>
                                    						</tr>
                                						    <?php
                                						    
                                						}
                                					}
                            						$updating_value = $row_change_payment_history['meta_key'].$row_change_payment_history['pax_auto_id'].$row_change_payment_history['updated_time'];
                            							
                            						if (in_array($updating_value, $processedOrders)) {
                            							continue; // Skip to the next iteration if the order ID is already processed
                            						}
                            						$processedOrders[] = $updating_value;
                            						?>
                            						<tr>
                            							<td>Pax Status : <?php echo $row_change_payment_history['meta_value']; ?></td>
                            							<td><?php echo $row_change_payment_history['updated_time']; ?></td>
                            							<td><?php echo $row_change_payment_history['updated_user']; ?></td>
                            						</tr>
                            						<?php
                                        	    }
                                        	    
                                        	    if($row_change_payment_history['meta_key'] == 'ticket_number')
                                        	    {
                                        	        $pax_auto_id = $row_change_payment_history['pax_auto_id'];
                                        	        
                                					$query_change_payment_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' && auto_id = '$pax_auto_id'";
                                					$result_change_payment_pax = mysqli_query($mysqli, $query_change_payment_pax);
                                					$row_change_payment_pax = mysqli_fetch_assoc($result_change_payment_pax);
                                					if(mysqli_num_rows($result_change_payment_pax) > 0)
                                					{
                                					    $pax_id_received = $row_change_payment_pax['auto_id'];
                                						if (!in_array($pax_id_received, $processedPaxChange)) 
                                						{
                                							$is_pax_name_posted = 1;
                                						}
                                						else
                                						{
                                							$is_pax_name_posted = 0;
                                						}
                                							
                                						$processedPaxChange[] = $pax_id_received;
                                						if($is_pax_name_posted == 1)
                                						{
                                						    {
                                    						    ?>
                                    							<tr>
                                    								<td colspan="4"><b><?php echo $row_change_payment_pax['salutation']; ?> <?php echo $row_change_payment_pax['fname']; ?> <?php echo $row_change_payment_pax['lname']; ?></b></td>
                                    							</tr>
                                						        <?php
                                						    }
                                						}
                                					}
                            						$updating_value = $row_change_payment_history['meta_key'].$row_change_payment_history['pax_auto_id'].$row_change_payment_history['updated_time'];
                            							
                            						if (in_array($updating_value, $processedOrders)) {
                            							continue; // Skip to the next iteration if the order ID is already processed
                            						}
                            						$processedOrders[] = $updating_value;
                            						?>
                            						<tr>
                            							<td>Ticket Number : <?php echo $row_change_payment_history['meta_value']; ?></td>
                            							<td><?php echo $row_change_payment_history['updated_time']; ?></td>
                            							<td><?php echo $row_change_payment_history['updated_user']; ?></td>
                            						</tr>
                            						<?php
                                        	    }
                                        	    
                                        	    if($row_change_payment_history['meta_key'] == 'eticket_emailed')
                                        	    {
                                        	        $pax_auto_id = $row_change_payment_history['pax_auto_id'];
                                        	        
                                					$query_change_payment_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' && auto_id = '$pax_auto_id'";
                                					$result_change_payment_pax = mysqli_query($mysqli, $query_change_payment_pax);
                                					$row_change_payment_pax = mysqli_fetch_assoc($result_change_payment_pax);
                                					if(mysqli_num_rows($result_change_payment_pax) > 0)
                                					{
                                					    $pax_id_received = $row_change_payment_pax['auto_id'];
                                						if (!in_array($pax_id_received, $processedPaxChange)) 
                                						{
                                							$is_pax_name_posted = 1;
                                						}
                                						else
                                						{
                                							$is_pax_name_posted = 0;
                                						}
                                							
                                						$processedPaxChange[] = $pax_id_received;
                                						if($is_pax_name_posted == 1)
                                						{
                                						    {
                                    						    ?>
                                    							<tr>
                                    								<td colspan="4"><b><?php echo $row_change_payment_pax['salutation']; ?> <?php echo $row_change_payment_pax['fname']; ?> <?php echo $row_change_payment_pax['lname']; ?></b></td>
                                    							</tr>
                                						        <?php
                                						    }
                                						}
                                					}
                            						$updating_value = $row_change_payment_history['meta_key'].$row_change_payment_history['pax_auto_id'].$row_change_payment_history['updated_time'];
                            							
                            						if (in_array($updating_value, $processedOrders)) {
                            							continue; // Skip to the next iteration if the order ID is already processed
                            						}
                            						$processedOrders[] = $updating_value;
                            						?>
                            						<tr>
                            							<td>eTicket emailed: <?php echo $row_change_payment_history['meta_value']; ?></td>
                            							<td><?php echo $row_change_payment_history['updated_time']; ?></td>
                            							<td><?php echo $row_change_payment_history['updated_user']; ?></td>
                            						</tr>
                            						<?php
                                        	    }
                                        	    
                                        	    if($row_change_payment_history['meta_key'] == 'G360Attachments')
                                        	    {
                            						?>	
                            							<tr>
                            								<td>passport | complaint | mh ppl voucher | other - <?php echo $row_change_payment_history['meta_key_data']; ?></td>
                            								<td><?php echo $row_change_payment_history['updated_time']; ?></td>
                            								<td><?php echo $row_change_payment_history['updated_user']; ?></td>
                            							</tr>
                            						<?php
                                        	    }
                                        	    
                                        	    if($row_change_payment_history['meta_key'] == 'dc_payment_status')
                                        	    {
                            						?>	
                            							<tr>
                            								<td>DC Payment: <?php echo $row_change_payment_history['meta_value']; ?></td>
                            								<td><?php echo $row_change_payment_history['updated_time']; ?></td>
                            								<td><?php echo $row_change_payment_history['updated_user']; ?></td>
                            							</tr>
                            						<?php
                                        	    }
                                        	    
                                        	    if($row_change_payment_history['meta_key'] == 'amount_adjustment')
                                        	    {
                            						?>	
                            							<tr>
                            								<td><?php echo $row_change_payment_history['meta_value']; ?> <?php echo $row_change_payment_history['meta_key_data']; ?></td>
                            								<td><?php echo $row_change_payment_history['updated_time']; ?></td>
                            								<td><?php echo $row_change_payment_history['updated_user']; ?></td>
                            							</tr>
                            						<?php
                                        	    }
                                        	    
                                        	    if($row_change_payment_history['meta_key'] == 'name_replacement')
                                        	    {
                                        	        $pax_auto_id = $row_change_payment_history['pax_auto_id'];
                                        	        
                                					$query_change_payment_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' && auto_id = '$pax_auto_id'";
                                					$result_change_payment_pax = mysqli_query($mysqli, $query_change_payment_pax);
                                					$row_change_payment_pax = mysqli_fetch_assoc($result_change_payment_pax);
                                					if(mysqli_num_rows($result_change_payment_pax) > 0)
                                					{
                                					    $pax_id_received = $row_change_payment_pax['auto_id'];
                                						if (!in_array($pax_id_received, $processedPaxChange)) 
                                						{
                                							$is_pax_name_posted = 1;
                                						}
                                						else
                                						{
                                							$is_pax_name_posted = 0;
                                						}
                                							
                                						$processedPaxChange[] = $pax_id_received;
                                						if($is_pax_name_posted == 1)
                                						{
                                						    {
                                    						    ?>
                                    							<tr>
                                    								<td colspan="4"><b><?php echo $row_change_payment_pax['salutation']; ?> <?php echo $row_change_payment_pax['fname']; ?> <?php echo $row_change_payment_pax['lname']; ?></b></td>
                                    							</tr>
                                						        <?php
                                						    }
                                						}
                                					}
                            						$updating_value = $row_change_payment_history['meta_key'].$row_change_payment_history['pax_auto_id'].$row_change_payment_history['updated_time'];
                            							
                            						if (in_array($updating_value, $processedOrders)) {
                            							continue; // Skip to the next iteration if the order ID is already processed
                            						}
                            						$processedOrders[] = $updating_value;
                            						?>
                            						<tr>
                            							<td>Name replacement: <?php echo $row_change_payment_history['meta_value']; ?></td>
                            							<td><?php echo $row_change_payment_history['updated_time']; ?></td>
                            							<td><?php echo $row_change_payment_history['updated_user']; ?></td>
                            						</tr>
                            						<?php
                                        	    }
                                        	    
                                        	    /*if($row_change_payment_history['meta_key'] == 'name_updated')
                                        	    {
                                        	        $pax_auto_id = $row_change_payment_history['pax_auto_id'];
                                        	        
                                					$query_change_payment_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' && auto_id = '$pax_auto_id'";
                                					$result_change_payment_pax = mysqli_query($mysqli, $query_change_payment_pax);
                                					$row_change_payment_pax = mysqli_fetch_assoc($result_change_payment_pax);
                                					if(mysqli_num_rows($result_change_payment_pax) > 0)
                                					{
                                					    $pax_id_received = $row_change_payment_pax['auto_id'];
                                						if (!in_array($pax_id_received, $processedPaxChange)) 
                                						{
                                							$is_pax_name_posted = 1;
                                						}
                                						else
                                						{
                                							$is_pax_name_posted = 0;
                                						}
                                							
                                						$processedPaxChange[] = $pax_id_received;
                                						if($is_pax_name_posted == 1)
                                						{
                                						    {
                                    						    ?>
                                    							<tr>
                                    								<td colspan="4"><b><?php echo $row_change_payment_pax['salutation']; ?> <?php echo $row_change_payment_pax['fname']; ?> <?php echo $row_change_payment_pax['lname']; ?></b></td>
                                    							</tr>
                                						        <?php
                                						    }
                                						}
                                					}
                            						$updating_value = $row_change_payment_history['meta_key'].$row_change_payment_history['pax_auto_id'].$row_change_payment_history['updated_time'];
                            							
                            						if (in_array($updating_value, $processedOrders)) {
                            							continue; // Skip to the next iteration if the order ID is already processed
                            						}
                            						$processedOrders[] = $updating_value;
                            						?>
                            						<tr>
                            							<td>Name updated: <?php echo $row_change_payment_history['meta_value']; ?></td>
                            							<td><?php echo $row_change_payment_history['updated_time']; ?></td>
                            							<td><?php echo $row_change_payment_history['updated_user']; ?></td>
                            						</tr>
                            						<?php
                                        	    }*/
                                        	    
                                        	    if($row_change_payment_history['meta_key'] == 'ticketing_audit')
                                        	    {
                                        	        $pax_auto_id = $row_change_payment_history['pax_auto_id'];
                                        	        
                                					$query_change_payment_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' && auto_id = '$pax_auto_id'";
                                					$result_change_payment_pax = mysqli_query($mysqli, $query_change_payment_pax);
                                					$row_change_payment_pax = mysqli_fetch_assoc($result_change_payment_pax);
                                					if(mysqli_num_rows($result_change_payment_pax) > 0)
                                					{
                                					    $pax_id_received = $row_change_payment_pax['auto_id'];
                                						if (!in_array($pax_id_received, $processedPaxChange)) 
                                						{
                                							$is_pax_name_posted = 1;
                                						}
                                						else
                                						{
                                							$is_pax_name_posted = 0;
                                						}
                                							
                                						$processedPaxChange[] = $pax_id_received;
                                						if($is_pax_name_posted == 1)
                                						{
                                						    {
                                    						    ?>
                                    							<tr>
                                    								<td colspan="4"><b><?php echo $row_change_payment_pax['salutation']; ?> <?php echo $row_change_payment_pax['fname']; ?> <?php echo $row_change_payment_pax['lname']; ?></b></td>
                                    							</tr>
                                						        <?php
                                						    }
                                						}
                                					}
                            						$updating_value = $row_change_payment_history['meta_key'].$row_change_payment_history['pax_auto_id'].$row_change_payment_history['updated_time'];
                            							
                            						if (in_array($updating_value, $processedOrders)) {
                            							continue; // Skip to the next iteration if the order ID is already processed
                            						}
                            						$processedOrders[] = $updating_value;
                            						?>
                            						<tr>
                            							<td>Ticketing audit: <?php echo $row_change_payment_history['meta_value']; ?></td>
                            							<td><?php echo $row_change_payment_history['updated_time']; ?></td>
                            							<td><?php echo $row_change_payment_history['updated_user']; ?></td>
                            						</tr>
                            						<?php
                                        	    }
                                        	    
                                        	    if($row_change_payment_history['meta_key'] == 'name_audit')
                                        	    {
                                        	        $pax_auto_id = $row_change_payment_history['pax_auto_id'];
                                        	        
                                					$query_change_payment_pax = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' && auto_id = '$pax_auto_id'";
                                					$result_change_payment_pax = mysqli_query($mysqli, $query_change_payment_pax);
                                					$row_change_payment_pax = mysqli_fetch_assoc($result_change_payment_pax);
                                					if(mysqli_num_rows($result_change_payment_pax) > 0)
                                					{
                                					    $pax_id_received = $row_change_payment_pax['auto_id'];
                                						if (!in_array($pax_id_received, $processedPaxChange)) 
                                						{
                                							$is_pax_name_posted = 1;
                                						}
                                						else
                                						{
                                							$is_pax_name_posted = 0;
                                						}
                                							
                                						$processedPaxChange[] = $pax_id_received;
                                						if($is_pax_name_posted == 1)
                                						{
                                						    {
                                    						    ?>
                                    							<tr>
                                    								<td colspan="4"><b><?php echo $row_change_payment_pax['salutation']; ?> <?php echo $row_change_payment_pax['fname']; ?> <?php echo $row_change_payment_pax['lname']; ?></b></td>
                                    							</tr>
                                						        <?php
                                						    }
                                						}
                                					}
                            						$updating_value = $row_change_payment_history['meta_key'].$row_change_payment_history['pax_auto_id'].$row_change_payment_history['updated_time'];
                            							
                            						if (in_array($updating_value, $processedOrders)) {
                            							continue; // Skip to the next iteration if the order ID is already processed
                            						}
                            						$processedOrders[] = $updating_value;
                            						?>
                            						<tr>
                            							<td>Name audit: <?php echo $row_change_payment_history['meta_value']; ?></td>
                            							<td></td>
                            							<td><?php echo $row_change_payment_history['updated_time']; ?></td>
                            							<td><?php echo $row_change_payment_history['updated_user']; ?></td>
                            						</tr>
                            						<?php
                                        	    }
                                        	    
                                        	    if($row_change_payment_history['meta_key'] == 'G360Events' && ($row_change_payment_history['meta_value'] != 'Booking Search' && $row_change_payment_history['meta_value'] != 'Noble Search'))
                                        	    {
                                        	        if($row_change_payment_history['meta_value'] == 'g360paymentattachments')
                                        	        {
                                        	            ?>	
                                							<tr>
                                								<td>Payment attachment : <a target="_blank" href="https://gauratravel.com.au/wp-content/uploads/customized_function_uploads/<?php echo $row_change_payment_history['meta_key_data']; ?>"><?php echo $row_change_payment_history['meta_key_data']; ?></a></td>
                                								<td><?php echo $row_change_payment_history['updated_time']; ?></td>
                                								<td><?php echo $row_change_payment_history['updated_user']; ?></td>
                                							</tr>
                                						<?php
                                        	        }
                                        	        else if($row_change_payment_history['meta_value'] == 'bpay_receipt_awaiting_approval')
                                        	        {
                                        	            ?>	
                                							<tr>
                                								<td>BPAY awaiting approval attachment : <a target="_blank" href="https://gauratravel.com.au/wp-content/uploads/customized_function_uploads/<?php echo $row_change_payment_history['meta_key_data']; ?>"><?php echo $row_change_payment_history['meta_key_data']; ?></a></td>
                                								<td><?php echo $row_change_payment_history['updated_time']; ?></td>
                                								<td><?php echo $row_change_payment_history['updated_user']; ?></td>
                                							</tr>
                                						<?php
                                        	        }
                                        	        else if($row_change_payment_history['meta_value'] == 'bpay_receipt_approved')
                                        	        {
                                        	            ?>	
                                							<tr>
                                								<td>BPAY approved attachment : <a target="_blank" href="https://gauratravel.com.au/wp-content/uploads/customized_function_uploads/<?php echo $row_change_payment_history['meta_key_data']; ?>"><?php echo $row_change_payment_history['meta_key_data']; ?></a></td>
                                								<td><?php echo $row_change_payment_history['updated_time']; ?></td>
                                								<td><?php echo $row_change_payment_history['updated_user']; ?></td>
                                							</tr>
                                						<?php
                                        	        }
                                        	        else if($row_change_payment_history['meta_value'] == 'bpay_receipt_declined')
                                        	        {
                                        	            ?>	
                                							<tr>
                                								<td>BPAY Declined attachment : <a target="_blank" href="https://gauratravel.com.au/wp-content/uploads/customized_function_uploads/<?php echo $row_change_payment_history['meta_key_data']; ?>"><?php echo $row_change_payment_history['meta_key_data']; ?></a></td>
                                								<td><?php echo $row_change_payment_history['updated_time']; ?></td>
                                								<td><?php echo $row_change_payment_history['updated_user']; ?></td>
                                							</tr>
                                						<?php
                                        	        }
                                        	        else
                                        	        {
                            						?>	
                            							<tr>
                            								<td><?php echo $row_change_payment_history['meta_value']; ?> <?php echo $row_change_payment_history['meta_key_data']; ?></td>
                            								<td><?php echo $row_change_payment_history['updated_time']; ?></td>
                            								<td><?php echo $row_change_payment_history['updated_user']; ?></td>
                            							</tr>
                            						<?php
                                        	        }
                                        	    }
                                        	    
                                        	    if($row_change_payment_history['meta_key'] == 'BPAY Receipt Status' )
                                        	    {
                            						?>	
                            							<tr>
                            								<td>BPay Receipt Status: <?php echo $row_change_payment_history['meta_value']; ?> <?php echo $row_change_payment_history['meta_key_data']; ?></td>
                            								<td><?php echo $row_change_payment_history['updated_time']; ?></td>
                            								<td><?php echo $row_change_payment_history['updated_user']; ?></td>
                            							</tr>
                            						<?php
                                        	    }
                                        	    
                                        	}
                                        	?>
                                        	</table>
                                        	<?php
                        				}
                        				else
                        				{
                        				    //echo '<h5>G360 History</h5>';
                        				    //echo 'No record found';
                        				}
										
										$query_change_ticketing_history2 = "SELECT * FROM wpk4_backend_history_of_updates where meta_key = 'deposit_adjustment_during_checkout' and type_id='$order_id_api' order by updated_on DESC";
                                    	$result_change_ticketing_history2 = mysqli_query($mysqli, $query_change_ticketing_history2);
                                    	$count_change_ticketing_history2 = mysqli_num_rows($result_change_ticketing_history2);
                        				if($count_change_ticketing_history2 > 0)
                        				{
											?>
											<h5>Change History</h5>
											<table style="font-size:13px;">
												<tr><th>Type</th><th>on</th><th>By</th></tr>
												<?php
												while($row_change_payment_history = mysqli_fetch_assoc($result_change_ticketing_history2))
												{
													if($row_change_payment_history['meta_key'] == 'deposit_adjustment_during_checkout')
													{
														?>	
															<tr>
																<td>Payment: <?php echo $row_change_payment_history['meta_value']; ?></td>
																<td><?php echo $row_change_payment_history['updated_on']; ?></td>
																<td><?php echo $row_change_payment_history['updated_by']; ?></td>
															</tr>
														<?php
													}
												}
												?>
                                        	</table>
                                        	<?php
										}
                                    	?>
                				    </div>
                				    
                				<div id="attachments_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                                    <?php
                                        $order_id = $order_id_api;
                                    ?>    

                                    <form action="#" name="statusupdate" method="post" enctype="multipart/form-data" >
                        		    <h6>Attachments</h6>
                        		    <?php
                        		    $query_all_refunds_latest_chat = "SELECT * FROM wpk4_backend_travel_booking_update_history where order_id = '$order_id_api' && co_order_id = '$co_order_id_api' && merging_id = '$product_id_api' && meta_key like 'G360Attachments' order by auto_id desc";
                            		$result_all_refunds_latest_chat = mysqli_query($mysqli, $query_all_refunds_latest_chat);
                            		$row_all_refunds_latest_chat_count = mysqli_num_rows($result_all_refunds_latest_chat);
                            		if($row_all_refunds_latest_chat_count > 0)
                            		{
                            		    ?>
                            		    <table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
                        		        <tr><td width="20%">Type</td><td width="40%">Attachment</td><td>Date uploaded</td><td>Updated by</td></tr>
                        		        <?php
                                		while($row_all_refunds_latest_chat = mysqli_fetch_assoc($result_all_refunds_latest_chat))
                                		{
                                		    $payment_file_extension = pathinfo($row_all_refunds_latest_chat['meta_key_data'], PATHINFO_EXTENSION);
                                		    if($payment_file_extension == 'pdf' || $payment_file_extension == 'txt')
                                		    {
                                		        echo '<tr><td>'.$row_all_refunds_latest_chat['meta_value'].'</td><td><a target="_blank" href="https://gauratravel.com.au/wp-content/uploads/customized_function_uploads/'.$row_all_refunds_latest_chat['meta_key_data'].'">
                                        		    Click Here <i class="fa fa-paperclip" aria-hidden="true"></i></a></td>
                                        		    <td>'.$row_all_refunds_latest_chat['updated_time'].'</td><td>'.$row_all_refunds_latest_chat['updated_user'].'</td></tr>';
                                		    }
                                		    else
                                		    {
                                		        echo '<tr><td>'.$row_all_refunds_latest_chat['meta_value'].'</td><td><a target="_blank" href="https://gauratravel.com.au/wp-content/uploads/customized_function_uploads/'.$row_all_refunds_latest_chat['meta_key_data'].'">
                                		            <img src="https://gauratravel.com.au/wp-content/uploads/customized_function_uploads/'.$row_all_refunds_latest_chat['meta_key_data'].'" style="width:200px;"></a></td>
                                		            <td>'.$row_all_refunds_latest_chat['updated_time'].'</td><td>'.$row_all_refunds_latest_chat['updated_user'].'</td></tr>';
                                		    }
                                		}
                                		?>
                                		</table>
                                		<?php
                            		}
                            		else
                            		{
                            		    echo 'No attachment found';
                            		}
                            		?>
                            		<h6>Add Attachments</h6>
                        		    
                            		</br>
                            		<style>
                            		    .myattachmentchat_g360
                            		    {
                            		        display:block;
                            		    }
                            		</style>
                            		Attachment Type
                            		<select name="attachmenttype" id='attachmenttype' style="width:100%; padding:10px;">
                                        <option value="complaint">Complaint</option>
                                        <option value="passport">Passport</option>
                                        <option value="medical">Medical</option>
                                        <option value="mh ppl voucher">MH PPL Voucher</option>
                                        <option value="other">Other</option>
                                    </select>
                            		</br></br>
                            		Attachment
                            		<div id="attachmentContainerc"></div>
                            		<input type="file" accept=".jpg,.jpeg,.png,.pdf" class="myattachmentchat_g360" name="myattachmentchat_1" id="myattachmentchat_1">
                            		</br>
                            		<p style="font-size:11px;">Allowed file types are .jpg, .png, .pdf</p>
                    			    <script>
                    			       
                                        var attachmentTypeSelect = document.getElementById("attachmenttype");
                                        
                
                                        attachmentTypeSelect.addEventListener("change", function () {
                                            var attachmentContainer = document.getElementById("attachmentContainerc");
                                            attachmentContainer.innerHTML = "";
                                            
                                            var selectedValue = attachmentTypeSelect.value;
                                            //
                                            if(selectedValue === "mh ppl voucher")
                                            {
                                                
                                                var paxcount = <?php echo $total_pax; ?>;
                                                for (var i = 2; i <= paxcount; i++) {
                                                    //alert(selectedValue);
                                                    var inputField = document.createElement("input");
                                                    inputField.type = "file";
                                                    inputField.accept = ".jpg,.jpeg,.png,.pdf";
                                                    inputField.className = "myattachmentchat_g360";
                                                    inputField.name = "myattachmentchat_" + i;
                                                    inputField.id = "myattachmentchat_" + i;

                                                    attachmentContainer.appendChild(inputField);
                                                    attachmentContainer.appendChild(document.createElement("br"));
                                                }
                                            }
                                        });
                                    </script>

                    			    </br>
                    			    
                    			    
                    			    <center><input type='submit' name='update_general_attachment' id='update_general_attachment' class='btn btn-success' style='padding:15px; margin:0;font-size:11px;' value='Save'></center>
                            		</form>	  
                            		<?php
                            		    if(isset($_POST['update_general_attachment']))
                        				{
        
                        				    $type = $_POST['attachmenttype']; //type
                                            if($type == 'mh ppl voucher')
                                            {
                                                for ($i = 1; $i <= $total_pax; $i++) 
                                                {
                                                    $fieldName = 'myattachmentchat_' . $i;
        
                                                    $fileName = $_FILES[$fieldName]['name'];
                                            		$temp = explode(".", $_FILES[$fieldName]["name"]);
                                            		$ext = end((explode(".", $_FILES[$fieldName]["name"])));
                                            		$filename_time = date('ymdHis');
                                            		$newfilename =  $i. $filename_time . '.' .$ext;
                                            	
                                
                                                    $currentDirectory = getcwd();
                                            		$uploadDirectory = "wp-content/uploads/customized_function_uploads/";
                                            		$errors = []; // Store errors here
                                            		$fileExtensionsAllowed = ['jpeg','jpg','png','pdf','JPEG','JPG','PNG','PDF','txt','TXT']; // These will be the only file extensions allowed 
                                            						
                                            		$fileSize = $_FILES[$fieldName]['size'];
                                            		$fileTmpName  = $_FILES[$fieldName]['tmp_name'];
                                            		$fileType = $_FILES[$fieldName]['type'];
                                            		$fileExtension = strtolower(end(explode('.',$fileName)));
                                            		$uploadPath = $uploadDirectory . basename($newfilename); 
                                            						
                                            		if (! in_array($fileExtension,$fileExtensionsAllowed)) {
                                            			$errors[] = "This file extension is not allowed. Please upload a JPEG, PNG or PDF file";
                                            			}
                                            		if ($fileSize > 4000000) {
                                            			$errors[] = "File exceeds maximum size (4MB)";
                                            			 }
                                            		if (empty($errors)) {
                                                		    $didUpload = move_uploaded_file($fileTmpName, $uploadPath);
                                                			if ($didUpload) {
                                                		} else {
                                                			echo "An error occurred. Please contact the Admin.";
                                                		}
                                            		} else {
                                            				foreach ($errors as $error) {
                                            				echo $error . "" . "\n";
                                            			}
                                            		}
                                                	add_travel_booking_history_record($order_id_api, $co_order_id_api, $product_id_api, 'G360Attachments', $type, $newfilename, $currnt_userlogn, $current_date_and_time); 
                                                    
                                                }
                                                
                                                
                                                
                                                $today_date = date("Y-m-d H:i:s");
                                    			$email_subject = "MH PPL Voucher - ".$order_id_api;
                                    			include(get_template_directory().'/templates/email/tpl_email_custom_template_mh_ppl_voucher.php');
                                    			
                                    			global $wpdb;
                                    			$wpdb->insert('wpk4_backend_order_email_history', array(
                                                    'email_type' =>'MH PPL Voucher',
                                                    'order_id' =>$order_id,
                                                    'email_address' => $customer_email,
                                                    'initiated_date' => $today_date,
                                    				'initiated_by' => $currnt_userlogn,
                                                    'email_subject' => $email_subject,
                                                ));
                                    			
                        			    	}
                                            
                                            if($type != 'mh ppl voucher')
                                            {
                                                $fileName = $_FILES['myattachmentchat_1']['name'];
                                        		$temp = explode(".", $_FILES["myattachmentchat_1"]["name"]);
                                        		$ext = end((explode(".", $_FILES["myattachmentchat_1"]["name"])));
                                        		$filename_time = date('ymdHis');
                                        		$newfilename =  'g360attachments_'. $filename_time . '.' .$ext;
                                        	
                            
                                                $currentDirectory = getcwd();
                                        		$uploadDirectory = "wp-content/uploads/customized_function_uploads/";
                                        		$errors = []; // Store errors here
                                        		$fileExtensionsAllowed = ['jpeg','jpg','png','pdf','JPEG','JPG','PNG','PDF','txt','TXT']; // These will be the only file extensions allowed 
                                        						
                                        		$fileSize = $_FILES['myattachmentchat_1']['size'];
                                        		$fileTmpName  = $_FILES['myattachmentchat_1']['tmp_name'];
                                        		$fileType = $_FILES['myattachmentchat_1']['type'];
                                        		$fileExtension = strtolower(end(explode('.',$fileName)));
                                        		$uploadPath = $uploadDirectory . basename($newfilename); 
                                        						
                                        		if (! in_array($fileExtension,$fileExtensionsAllowed)) {
                                        			$errors[] = "This file extension is not allowed. Please upload a JPEG, PNG or PDF file";
                                        			}
                                        		if ($fileSize > 4000000) {
                                        			$errors[] = "File exceeds maximum size (4MB)";
                                        			 }
                                        		if (empty($errors)) {
                                            		    $didUpload = move_uploaded_file($fileTmpName, $uploadPath);
                                            			if ($didUpload) {
                                            			//echo "The file has been uploaded";
                                            		} else {
                                            			echo "An error occurred. Please contact the Admin.";
                                            		}
                                        		} else {
                                        				foreach ($errors as $error) {
                                        				echo $error . "" . "\n";
                                        			}
                                        		}
                                            	add_travel_booking_history_record($order_id_api, $co_order_id_api, $product_id_api, 'G360Attachments', $type, $newfilename, $currnt_userlogn, $current_date_and_time); 
                                                                
                                            }
                                                       
                                            $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                            //echo '<script>window.location.href="'.$current_url.'";</script>';
                        				}
                        				?>  
                                     
                				    </div>
                				    
                				<div id="attachmentlink_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                                    <?php
                                        $order_id = $order_id_api;
                                    ?>    

                                    <form action="#" name="statusupdate" method="post" enctype="multipart/form-data" >
                        		    <h6>URLs</h6>
                        		    <?php
                        		    $query_all_refunds_latest_chat = "SELECT * FROM wpk4_backend_travel_booking_update_history where order_id = '$order_id_api' && co_order_id = '$co_order_id_api' && merging_id = '$product_id_api' && meta_key like 'G360AttachmentLinks' order by auto_id desc";
                            		$result_all_refunds_latest_chat = mysqli_query($mysqli, $query_all_refunds_latest_chat);
                            		$row_all_refunds_latest_chat_count = mysqli_num_rows($result_all_refunds_latest_chat);
                            		if($row_all_refunds_latest_chat_count > 0)
                            		{
                            		    ?>
                            		    <table class="table table-striped" style="width:100%; margin:auto;font-size:14px;">
                        		        <tr><td width="20%">Type</td><td width="40%">URL</td><td>Date added</td><td>Added by</td></tr>
                        		        <?php
                                		while($row_all_refunds_latest_chat = mysqli_fetch_assoc($result_all_refunds_latest_chat))
                                		{
                                		    echo '<tr><td>'.$row_all_refunds_latest_chat['meta_value'].'</td><td><a target="_blank" href="'.$row_all_refunds_latest_chat['meta_key_data'].'">
                                		    '.$row_all_refunds_latest_chat['meta_key_data'].'</a></td><td>'.$row_all_refunds_latest_chat['updated_time'].'</td><td>'.$row_all_refunds_latest_chat['updated_user'].'</td></tr>';
                                		}
                                		?>
                                		</table>
                                		<?php
                            		}
                            		else
                            		{
                            		    echo 'No attachment found';
                            		}
                            		?>
                            		<h6>Add URL</h6>
                        		    
                            		</br>
                            		<style>
                            		    .myattachmentchat_g360
                            		    {
                            		        display:block;
                            		    }
                            		</style>
                            		URL Type
                            		<select name="attachmenttype" id='attachmenttype' style="width:100%; padding:10px;">
                                        <option value="complaint">Complaint</option>
                                        <option value="passport">Passport</option>
                                        <option value="medical">Medical</option>
                                        <option value="other">Other</option>
                                    </select>
                            		</br></br>
                            		URL
                            		<input type="text" class='myattachmentchat_g360' name="myattachmentchat" id="myattachmentchat"></br>
                            		<p style="font-size:11px;">Allowed to add any URLs</p>
                    			    </br>
                    			    <center><input type='submit' name='update_url_attachment' id='update_url_attachment' class='btn btn-success' style='padding:15px; margin:0;font-size:11px;' value='Save'></center>
                            		</form>	  
                            		<?php
                            		    if(isset($_POST['update_url_attachment']))
                        				{
                        				    $type = $_POST['attachmenttype']; //type
                                            $fileName = $_POST['myattachmentchat'];
                                        	add_travel_booking_history_record($order_id_api, $co_order_id_api, $product_id_api, 'G360AttachmentLinks', $type, $fileName, $currnt_userlogn, $current_date_and_time); 
                                                            
                                            $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                            echo '<script>window.location.href="'.$current_url.'";</script>';
                        				}
                        				?>  
                                        
                                        
                                        
                                        
            
                				    </div>
                				    
                				<div id="changelog_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                                    <?php
                                        $order_id = $order_id_api;
                                        
                                        $query_gds_change_history_count = "SELECT * FROM wpk4_backend_history_of_meta_changes where type_id='$order_id_api' order by auto_id DESC limit 1";
                                    	$result_gds_change_history_count = mysqli_query($mysqli, $query_gds_change_history_count);
                                    	$count_gds_change_history_count = mysqli_num_rows($result_gds_change_history_count);
                                    	$row_gds_change_history_count = mysqli_fetch_assoc($result_gds_change_history_count);
                        				if($count_gds_change_history_count > 0)
                        				{
                        				    ?>
                                    	    <h5>History</h5>
                                    	    <table style="font-size:13px;">
                                            <tr><th>on</th><th>By</th><th></th></tr>
                                    	    <?php
                        				    $lastdivider_id = (int)$row_gds_change_history_count['divider_id'];
                        				    
                        				    for($his_counter = $lastdivider_id; $his_counter >= 1; $his_counter--)
                        				    {
                        				        $query_gds_change_history = "SELECT * FROM wpk4_backend_history_of_meta_changes where type_id='$order_id_api' AND divider_id=$his_counter";
                                            	$result_gds_change_history = mysqli_query($mysqli, $query_gds_change_history);
                                            	$row_gds_change_history = mysqli_fetch_assoc($result_gds_change_history);
                                            	$row_gds_change_history_count_2 = mysqli_num_rows($result_gds_change_history);
                                            	if($row_gds_change_history_count_2 > 0)
                                            	{
                        				        ?>	
                            						<tr>
                            							<td><?php echo $row_gds_change_history['updated_on']; ?></td>
                            							<td><?php echo $row_gds_change_history['updated_by']; ?></td>
                            							<td><a href="?option=view-changelog&order=<?php echo $order_id_api; ?>&log=<?php echo $his_counter; ?>" target="_blank">View</a></td>
                            						</tr>
                            					<?php 
                                            	}
                        				    }
                        				}
                        				else
                        				{
                        				    echo '<h5>History</h5>';
                        				    echo 'No record found';
                        				}
                                    	?>
                                        </table>
                				    </div>
                				
                				<div id="sms_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                                    <?php
                                        $order_id = $order_id_api;
                                        
                                        $query_sms_history = "SELECT * FROM wpk4_backend_order_sms_history where order_id='$order_id_api' order by added_on DESC";
                                    	$result_sms_history = mysqli_query($mysqli, $query_sms_history);
                                    	$count_sms_history = mysqli_num_rows($result_sms_history);
                        				if($count_sms_history > 0)
                        				{
                        				    ?>
                        				    <h5>History</h5>
                                    	    <table style="font-size:13px;">
                                            <tr><th>Message</th><th>To</th><th>On</th><th>By</th></tr>
                        				    <?php
                        				    while($row_sms_history = mysqli_fetch_assoc($result_sms_history))
                        				    {
                        				        ?>	
                            					<tr>
                            						<td width="70%"><?php echo $row_sms_history['message']; ?></td>
                            						<td width="10%"><?php echo $row_sms_history['phone']; ?></td>
                            						<td width="10%"><?php echo $row_sms_history['added_on']; ?></td>
                            						<td width="10%"><?php echo $row_sms_history['added_by']; ?></td>
                            					</tr>
                            					<?php 
                        				    }
                        				    ?>
                        				    </table>
                        				    <?php
                        				}
                        				else
                        				{
                        				    echo '<h5>SMS History</h5>';
                        				    echo 'No record found';
                        				}
                                    	?>
                                    	</br>
                                    	<h5>Send New SMS</h5>
                                    	<form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                            <table>
                                                <tr>
                                                    <td>
                                                        Number (Country code + Phone number - Eg: 913335076444 / 611300359463)
                                                        <input type="text" name="sms_phonenumber" id="sms_phonenumber" value="<?php echo str_replace(' ', '', $phone_pax); ?>">
                                                        <span id="phone_error" style="color: red; display: none;">Invalid number</span>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        Type
                                                        <select name="sms_type" id="sms_type" style="width:100%; padding:10px;">
                                                            <option value="0" data-message="" selected disabled>Select Template</option>
                                                            <?php
                                                            $query_sms_template_types = "SELECT * FROM wpk4_backend_order_sms_templates";
                                                            $result_sms_template_types = mysqli_query($mysqli, $query_sms_template_types);
                                                            while($row_sms_template_types = mysqli_fetch_assoc($result_sms_template_types))
                                                            {
                                                                ?>
                                                                <option value="<?php echo $row_sms_template_types['auto_id']; ?>" data-message="<?php echo htmlspecialchars($row_sms_template_types['templates']); ?>"><?php echo $row_sms_template_types['tem_type']; ?></option>
                                                                <?php
                                                            }
                                                            ?>
                                                        </select>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        Message
                                                        <textarea name="sms_message" id="sms_message"></textarea>
                                                        <span id="char_count">0</span> characters
                                                    </td>
                                                </tr>
                                                <script>
                                                $(document).ready(function() {
                                                    // Handle sms_type changes
                                                    $('#sms_type').change(function() {
                                                        var selectedMessage = $(this).find('option:selected').data('message');
                                                        $('#sms_message').val(selectedMessage).trigger('input'); // Update and trigger input event
                                                    });
                                                
                                                    // Update character count on input
                                                    $('#sms_message').on('input', function() {
                                                        var charCount = $(this).val().length;
                                                        $('#char_count').text(charCount);
                                                        // Update color based on character count
                                                        if (charCount < 130) {
                                                            $('#char_count').css("color", "green");
                                                            $('#sms_trigger').prop('disabled', false); // Enable submit button if within limit
                                                        } else if (charCount > 130 && charCount <= 160) {
                                                            $('#char_count').css("color", "orange");
                                                            $('#sms_trigger').prop('disabled', false); // Enable submit button if within limit
                                                        } else if (charCount > 160) {
                                                            $('#char_count').css("color", "red");
                                                            $('#sms_trigger').prop('disabled', true); // Disable submit if over limit
                                                        }
                                                    });
                                                
                                                    // Validate phone number on input
                                                    $('#sms_phonenumber').on('input', function() {
                                                        var phoneNumber = $(this).val();
                                                        if (phoneNumber.length > 14 || phoneNumber.length < 9) {
                                                            $('#sms_trigger').prop('disabled', true);
                                                            $('#phone_error').show();
                                                        } else {
                                                            $('#sms_trigger').prop('disabled', false);
                                                            $('#phone_error').hide();
                                                        }
                                                    });
                                                
                                                    // Initial triggers
                                                    $('#sms_type').change();        // To set initial message if any option is preselected
                                                    $('#sms_phonenumber').trigger('input');  // Trigger the validation on page load
                                                });
                                                </script>
                                                <tr>
                                    			    <td colspan='2'><center><input type='submit' style='padding:15px; margin:0;font-size:11px;' name="sms_trigger" id="sms_trigger" value='Send Message'></center></td>
                                    			</tr>
                                            </table>
                                        </form>
                                        <?php
                                        if(isset($_POST['sms_trigger']))
                                        {
                                            $sms_phonenumber = $_POST['sms_phonenumber'];
                                            $sms_message = $_POST['sms_message'];
                                            
                                            if($sms_message != '' && $sms_phonenumber != '')
                                            {
                                                $jsonResponse = generateTransmitSMS($sms_message, $sms_phonenumber);
    
                                                // Decode the JSON string into an associative array
                                                $responseData = json_decode($jsonResponse, true);
                                                
                                                // Extracting necessary information
                                                $messageId = $responseData['message_id'];
                                                $sendAt = $responseData['send_at'];
                                                $errorCode = $responseData['error']['code'];
                                                $errorDescription = $responseData['error']['description'];
                                                
                                                // Determine if the response is a success
                                                if ($errorCode === 'SUCCESS' && $errorDescription === 'OK') {
                                                    echo '<script>alert("SMS sending was successful.");</script>';

                                                    mysqli_query($mysqli,"insert into wpk4_backend_order_sms_history (order_id, message, phone, source, message_id, added_on, added_by ) 
    						                        values ('$order_id_api', '$sms_message', '$sms_phonenumber', 'TransmitSMS', '$messageId', '$current_date_and_time', '$currnt_userlogn' )") or die(mysqli_error($mysqli));
    						                        
    						                        $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
    						                        echo '<script>window.location.href="'.$current_url.'";</script>';
                                                }
                                                else 
                                                {
                                                    echo '<script>alert("SMS sending failed.");</script>';
                                                }
                                            }
                                            else
                                            {
                                                echo '<script>alert("Kindly add proper message and phone number to send this message.");</script>';
                                            }
                                        }
                                        ?>
                				    </div>  
                				    
                				<div id="payment_request_history_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                                    <?php
                                        $order_id = $order_id_api;
                                        
                                        $query_paymentrequest_history = "SELECT * FROM wpk4_backend_travel_booking_custom_payments where order_id='$order_id_api' order by requested_on DESC";
                                    	$result_paymentrequest_history = mysqli_query($mysqli, $query_paymentrequest_history);
                                    	$count_paymentrequest_count = mysqli_num_rows($result_paymentrequest_history);
                        				if($count_paymentrequest_count > 0)
                        				{
                        				    ?>
                        				    <h5>Payment Request history</h5>
                                    	    <table style="font-size:13px;">
                                            <tr><th>Type</th><th>Requested on</th><th>Request by</th><th>Amount requested</th><th>Paid amount</th><th></th></tr>
                        				    <?php
                        				    while($row_paymentrequest_history = mysqli_fetch_assoc($result_paymentrequest_history))
                        				    {
                        				        ?>	
                            					<tr>
                            						<td width="20%"><?php echo $row_paymentrequest_history['type_of_payment']; ?></td>
                            						<td width="10%"><?php 
                            						if($row_paymentrequest_history['resent_on'] == NULL)
                            						{
                            						    echo $row_paymentrequest_history['requested_on']; 
                            						}
                            						else
                            						{
                            						    echo $row_paymentrequest_history['resent_on']; 
                            						}
                            						?></td>
                            						<td width="10%"><?php echo $row_paymentrequest_history['requested_by']; ?></td>
                            						<td width="10%"><?php echo $row_paymentrequest_history['amount']; ?></td>
                            						<td width="10%"><?php echo $row_paymentrequest_history['amount_paid']; ?></td>
                            						<td width="20%">
                            						    <?php 
                            						    if($row_paymentrequest_history['status'] != 'paid' && $row_paymentrequest_history['azupay_link'] != NULL && $row_paymentrequest_history['azupay_expiry_date'] >= date("Y-m-d H:i:s", strtotime("+1 days")) && ($currnt_userlogn == 'lee' || current_user_can( 'datechange_manager' ) ) )
                            						    {
                            						        ?>
                            						        <form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                            						        <input type="hidden" name="resend_payment_auto_id" id="resend_payment_auto_id" value="<?php echo $row_paymentrequest_history['auto_id']; ?>">   
                            						        <input type='submit' style='padding:6px 10px; margin:0;font-size:13px;background-color:#f5e878; text-decoration:none;curser:pointer;background-color:#c7950b; padding:4px 8px; color:white; ' name='resend_payment_link' value='Resend payment email'>
                            						        </form>
                            						        <?php
                            						    }
                            						    ?>
                            						    </td>
                            						
                            					</tr>
                            					<?php 
                        				    }
                        				    ?>
                        				    </table>
                        				    <?php
                        				}
                        				else
                        				{
                        				    echo '<h5>Payment request history</h5>';
                        				    echo 'No record found';
                        				}
                                    	?>
                                    	</br>
                                    <?php
                                    if(isset($_POST['resend_payment_link']))
                                    		{
                                    		    $today_date = date("Y-m-d H:i:s");
                                    		    
                                    		    $orderid_added = $order_id_api;
                                    		    $resend_payment_auto_id = $_POST['resend_payment_auto_id'];
                                    		    
                                    		    $sql_update_resent_data ="UPDATE wpk4_backend_travel_booking_custom_payments
                                                    SET resent_on = '$today_date', resent_by = '$currnt_userlogn'
                                                WHERE auto_id='$resend_payment_auto_id'";
                                                $results_update_resent_data = $wpdb->query($sql_update_resent_data);
                                                
                                    		    $query_paymentrequest_history = "SELECT * FROM wpk4_backend_travel_booking_custom_payments where auto_id ='$resend_payment_auto_id'";
                                            	$result_paymentrequest_history = mysqli_query($mysqli, $query_paymentrequest_history);
                                				if(mysqli_num_rows($result_paymentrequest_history) > 0)
                                				{
                                    		        $row_paymentrequest_history = mysqli_fetch_assoc($result_paymentrequest_history);
                                    		        
                                    		        $paymentRequestcheckoutUrl = $row_paymentrequest_history['azupay_link'];
                                    		        
                                    		        $azupayBank = false;
                                    		        $virtualBsb = $row_paymentrequest_history['azupay_bsb'];
                                    		        $virtualAccountNumber = $row_paymentrequest_history['azupay_account_number'];
                                    		        
                                    		        if($virtualBsb != '')
                                    		        {
                                    		            $azupayBank = true;
                                    		        }
                                    		        
                                    		        
                                    		        $current_time_plus_24_hrs = $row_paymentrequest_history['azupay_expiry_date'];
                                    		        
                                    		        $one_day_later = date("Y-m-d H:i:s", strtotime("+1 days"));
                                    		        
                                    		        if( $current_time_plus_24_hrs >= $one_day_later )
                                    		        {
                                                        $current_time_plus_24_hrs = $one_day_later;
                                    		        }
                                    		        
                                    		        $current_time_plus_24_hrs = date("d/m/Y H:i:s", strtotime($current_time_plus_24_hrs));
                                    		        
                                    		        
                                    		        $paylater_link = $row_paymentrequest_history['skypay_link'];
                                    		        
                                    		        $type_of_payment_for_payment_request = $row_paymentrequest_history['type_of_payment'];
                                    		        
                                    		        $paymentRequestAmount = $row_paymentrequest_history['amount'];
                                    		        
                                    		        $limitTimestamp_bpay = date("Y-m-d", strtotime("+10 days", strtotime(date("Y-m-d").' 23:59:59')));
                                    		        
                                    		        $travel_date_for_paylater = date("Y-m-d");
                                    		        $query_order_paxinfo_3 = "SELECT travel_date, trip_code FROM wpk4_backend_travel_bookings where order_id = '$order_id_api' order by travel_date asc limit 1";
                                                    $result_order_paxinfo_3 = mysqli_query($mysqli, $query_order_paxinfo_3) or die(mysqli_error($mysqli));
                                                    if(mysqli_num_rows($result_order_paxinfo_3) > 0)
                                                    {
                                                        $row_order_paxinfo_3 = mysqli_fetch_assoc($result_order_paxinfo_3);
                                                        $travel_date_for_paylater = $row_order_paxinfo_3['travel_date']; 
                                                        $travel_date_for_paylater = date('Y-m-d', strtotime($travel_date_for_paylater));
                                                        $tripcode_for_paylater = $row_order_paxinfo_3['trip_code']; 
                                                    }
                        
                                                    $departureDate = $travel_date_for_paylater;
                                                    
                                                    $crn = $row_paymentrequest_history['bpay_crn'];
                                    		        $bpay = true;
                                    		           
                                    		        $is_bpay_enabled_with_travel_date = false;    
                                    		        if($departureDate > $limitTimestamp_bpay || $currnt_userlogn == 'lee')
                                    		        {
                                    		            $is_bpay_enabled_with_travel_date = true;
                                    		        }
                                    		        
                                    		        $enable_bank_account = false;
                                                    if($departureDate <= $limitTimestamp_bpay)
                                                    {
                                                        $enable_bank_account = true;
                                                    }
                                    		        
                                        			if($order_type_itinerary == 'WPT' || $order_type_itinerary == '')
            				                        {
            				                            $emailsubject = "Payment Request - ".$order_id_api;
                                        			    
            				                        }
            				                        else if($order_type_itinerary == 'gds')
            				                        {
            				                            $query_pax_lead_traveller = "SELECT * FROM wpk4_backend_travel_booking_pax where order_id='$order_id_api' order by auto_id asc limit 1";
                                                		$result_pax_lead_traveller = mysqli_query($mysqli, $query_pax_lead_traveller);
                                                		$row_pax_lead_traveller = mysqli_fetch_assoc($result_pax_lead_traveller);
                                                            $pnr_for_email = $row_pax_lead_traveller['pnr'];
                
            				                            $emailsubject = "Payment Request - ".$pnr_for_email . ' ('.$order_id_api.')';
            				                        }
            				                        

            				                        include(get_template_directory().'/templates/email/tpl_email_get_balance_payment_with_multiple_payment_options.php');
            				                        
            				                        add_g360_event_history($order_id_api, $co_order_id_api, $product_id_api, 'Payment Request Email has been sent to pax', "" , $currnt_userlogn, $current_date_and_time);
            				                        
                                        			global $wpdb;
                                        			$email_subject = 'Payment Request';
                                        			$wpdb->insert('wpk4_backend_order_email_history', array(
                                                        'email_type' =>'Payment request resend',
                                                        'order_id' =>$order_id_api,
                                                        'email_address' => $customer_email,
                                                        'initiated_date' => $today_date,
                                        				'initiated_by' => $currnt_userlogn,
                                                        'email_subject' => $email_subject,
                                                    ));
                                                    $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                        			echo '<script>window.location.href="'.$current_url.'";</script>';
                                				}
                                    		}
                                    ?>
                			</div>
                			    
                			    <div id="schedule_change_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                        			    <?php
                        			    $query_schedulechange_history = "SELECT * FROM wpk4_backend_travel_bookings where order_id='$order_id_api' order by added_on DESC";
                                    	$result_schedulechange_history = mysqli_query($mysqli, $query_schedulechange_history);
                                    	$count_schedulechange_history = mysqli_num_rows($result_schedulechange_history);
                        				if($count_schedulechange_history > 0)
                        				{
                        				    ?>
                        				    <h5>History</h5>
                                    	    <table style="font-size:13px;">
                                            <tr><th>OrderID</th><th>Note</th><th></th></tr>
                        				    <?php
                        				    while($row_schedulechange_history = mysqli_fetch_assoc($result_schedulechange_history))
                        				    {
                        				        ?>	
                            					<tr>
                            						<td width="70%"><?php echo $row_schedulechange_history['order_id']; ?></td>
                            						<td width="10%"><?php echo $row_schedulechange_history['booking_note_for_agents']; ?></td>
                            						<?php
                            						if($currnt_userlogn == 'sriharshans' || $currnt_userlogn == 'lee')
                            						{
                            						?>
                            						<td width="10%"><a href="?option=delete-schedule-change&id=<?php echo $row_schedulechange_history['order_id']; ?>">Delete</a></td>
                            						<?php
                            						}
                            						?>
                            					</tr>
                            					<?php 
                        				    }
                        				    ?>
                        				    </table>
                        				    <?php
                        				}
                        				else
                        				{
                        				    echo '<h5>History</h5>';
                        				    echo 'No record found';
                        				}
                                    	?>
                                    	</br>
                                    	
                            		    <h5>Add Schedule Change</h5>
                                    	<form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                            <table>
                                                <tr>
                                                    <td>
                                                        Note
                                                        <input type="text" name="note_for_schedule_change">
                                                    </td>
                                                </tr>
                                                <tr>
                                    			    <td colspan='2'><center><input type='submit' style='padding:15px; margin:0;font-size:11px;' name="submit_schedulechange" id="submit_schedulechange" value='Submit'></center></td>
                                    			</tr>
                                            </table>
                                        </form>
                                        <?php
                                        if(isset($_POST['submit_schedulechange']))
                                        {
                                            $escalation_type = $_POST['note_for_schedule_change'];

                                            if($escalation_type != '')
                                            {
                                                $sql_update_status_schedule_change = "UPDATE wpk4_backend_travel_bookings SET booking_note_for_agents = '$escalation_type' WHERE order_id = '$order_id_api'";
				                                $result_status_schedule_change = mysqli_query($mysqli,$sql_update_status_schedule_change) or die(mysqli_error());
				                                
				                                add_g360_event_history($order_id_api, $co_order_id_api, $product_id_api, 'added booking_note_for_agents', $escalation_type , $currnt_userlogn, $current_date_and_time);
				
    						                    $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
    						                    echo '<script>window.location.href="'.$current_url.'";</script>';
                                            }
                                            else
                                            {
                                                echo '<script>alert("Kindly add the note");</script>';
                                            }
                                        }
                                            ?>
        				        </div>
        				        
                			    <div id="ticketing_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
									</br>
									<button class="tablinks chatcategory" onclick="openCity(event, 'fullnames_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?>')">View detailed info</button></br></br>
									
									<?php

										$message = "";
										$admin_email = "kajalk@gauratravel.com.au";
										$ticketing_request = "";
										$mailbody = "<html><body>";

										$has_updates = false;
										$pnr_list = [];
										$airline_code = "";
										
										$update_ticketing_in_g360_post_name = 'update_ticketing_in_g360_'.$order_id_api;

										if (isset($_POST[$update_ticketing_in_g360_post_name])) 
										{
											if (isset($_POST['name_replacement']) && is_array($_POST['name_replacement'])) 
											{
												foreach ($_POST['name_replacement'] as $auto_id => $new_name) 
												{
													if($new_name != '')
													{
													$ticketing_request = $_POST['ticketing_request'][$auto_id] ?? '';

													/*if (!empty($new_name) && ($ticketing_request == 'Name Correction' || 
															$ticketing_request == 'Name Replacement' || 
															$ticketing_request == 'Name Removal'||
															$ticketing_request == 'Name Correction Completed' || 
															$ticketing_request == 'Name Replacement Completed' || 
															$ticketing_request == 'Name Removal Completed')) */
															{

														$trip_query = "SELECT b.trip_code, p.pnr, p.fname AS old_fname, p.lname AS old_lname, b.travel_date, p.salutation AS old_salutation
																	FROM wpk4_backend_travel_bookings AS b
																	JOIN wpk4_backend_travel_booking_pax AS p 
																	ON b.order_id = p.order_id AND b.product_id = p.product_id
																	WHERE p.auto_id = '$auto_id'";
														
														$trip_result = mysqli_query($mysqli, $trip_query);
														$trip_row = mysqli_fetch_assoc($trip_result);
														$trip_code = $trip_row['trip_code'];
														
														$pnr = $trip_row['pnr'];
														$old_name = $trip_row['old_lname'] . ' / ' . $trip_row['old_fname'] . ' / ' . $trip_row['old_salutation'];
														$travel_date = date('d/m/Y', strtotime($trip_row['travel_date']));

														$trip_parts = explode('-', $trip_code);
														
														$trip_query2 = "SELECT trip_id
																	FROM wpk4_backend_stock_management_sheet
																	WHERE pnr = '$pnr'";
														$trip_result2 = mysqli_query($mysqli, $trip_query2);
														$trip_row2 = mysqli_fetch_assoc($trip_result2);
														$trip_code = $trip_row2['trip_id'] ?? $trip_code2;
                                                        $trip_parts = explode('-', $trip_code);
                                                        
														$airline = substr($trip_parts[count($trip_parts) - 1], 0, 2);
														
														$status_map = [
															'Name Correction' => 'Name Correction Sent',
															'Name Replacement' => 'Name Replacement Sent',
															'Name Removal' => 'Name Removal Sent',
															'Name Correction Completed' => 'Name Correction Completed',
															'Name Replacement Completed' => 'Name Replacement Completed',
															'Name Removal Completed' => 'Name Removal Completed'
														];
														
														$updated_status = $ticketing_request;

														if (strpos($ticketing_request, 'completed') !== false) {
															$new_name = ''; 
														}

														$update_query = "UPDATE wpk4_backend_travel_booking_pax 
																		SET name_updated = '$updated_status', ticketing_remarks = '$new_name'
																		WHERE auto_id = '$auto_id'";

														if (mysqli_query($mysqli, $update_query)) {
															$message = "SUCCESS UPDATE FOR Unique ID: $auto_id";
															
															$history_query = "INSERT INTO wpk4_edit_history (order_id, airline, name, objective, status, trip_code, pnr, added_by) 
																			VALUES ('$order_id_api', '$airline', '$new_name', '$ticketing_request', '$updated_status', '$trip_code', '$pnr', '$currnt_userlogn')";
															mysqli_query($mysqli, $history_query);
															
															$mailbody .= "Hi Team,<br><br>Could you kindly help us do the $ticketing_request for the below passenger<br><br>";
															$mailbody .= "<table border='1' cellspacing='0' cellpadding='5'>";
															$mailbody .= "<tr><th>Old Name</th><th>PNR</th><th>New Name</th><th>Sector</th><th>Travel Date</th><th>Action Required</th></tr>";
															$mailbody .= "<tr><td>$new_name</td><td>$pnr</td><td>$old_name</td><td>$trip_code</td><td>$travel_date</td><td>$ticketing_request</td></tr>";
															
															$has_updates = true;

															$mail_entries[] = [
																'pnr' => $pnr,
																'action_required' => $ticketing_request,
																'airline_code' => $airline
															];
														}
													}
													}
												}
											} else {
												$message = "No data of name_replacement sent!";
											}
										}

										$mailbody .= "</table></body></html>";

										if ($has_updates) 
										{
											$subject = "";
											foreach ($mail_entries as $entry) {
												$subject = "Gaura Travel - {$entry['pnr']} - {$entry['action_required']} - {$entry['airline_code']}  ";
												if ($entry['airline_code'] == 'MH') 
												{
													$admin_email = "anz.groups@malaysiaairlines.com";
													
												} 
												elseif ($entry['airline_code'] == 'SQ') 
												{
													$admin_email = "sqin_groups@singaporeair.com.sg";
												}
											}
																						
											include_once (ABSPATH . WPINC . '/class-phpmailer.php');
                                            include_once (ABSPATH . WPINC . '/PHPMailer/SMTP.php');
        
											$mail = new PHPMailer(true);
											
											try {
												$mail->isSMTP();
												$mail->Host = 'tls://smtp.office365.com:587';
												$mail->SMTPAuth = true;
												$mail->Username = 'namerequest@gauratravel.com.au';
												$mail->Password = 'Z&254452302485og';
												$mail->SMTPSecure = 'tls';
												$mail->Port = 587;
												
												$mail->setFrom('namerequest@gauratravel.com.au', 'Gaura Travel - Name Request');
												$mail->addAddress($admin_email);
												//$mail->addAddress('leen@gauratravel.com.au');
												$mail->addAddress('kajalk@gauratravel.com.au');
												$mail->addAddress('reemak@gauratravel.com.au');
												$mail->addAddress('amanm@gauratravel.com.au');
												$mail->addAddress('divyag@gauratravel.com.au');
												$mail->addAddress('chiragp@gauratravel.com.au');
												$mail->addAddress('datechange@gauratravel.com.au');
												$mail->isHTML(true);
												$mail->Subject = $subject;
												$mail->Body = $mailbody;
												
												$mail->send();
												echo "MAIL CONTENT:<br>";
												echo "To: " . $mail->getToAddresses()[0][0] . "<br>";
												echo "Subject: " . $mail->Subject . "<br>";
												echo "Body: " . $mail->Body . "<br>";
												echo "AltBody: " . $mail->AltBody . "<br>";
											} 
											catch (Exception $e) 
											{
												error_log("Email could not be sent. Mailer Error: " . $mail->ErrorInfo);
												echo "Mailer Error: " . $mail->ErrorInfo;
											}
											
											$current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
    						                echo '<script>window.location.href="'.$current_url.'";</script>';
										}
										
									?>

									<form method="post" action="">
										<?php wp_nonce_field('update_ticketing_action', 'update_ticketing_nonce'); ?>
										<?php if (!empty($message)) { echo "<div class='alert alert-info'>$message</div>"; } ?>
										<table class='table table-striped'>
											<thead>
												<tr>
													<th>Unique ID</th>
													<th>Order ID</th>
													<th>Pax Details</th>
													<th>Trip Details</th>
													<th>Payment</th>
													<th>PNR</th>
													<th>Ticket</th>
													<th>Name to be Removed</th>
													<th>Ticketing Request</th>
												</tr>
											</thead>
											<tbody>
												<?php
												$query_ticketing_history_g360 = "SELECT * FROM wpk4_backend_travel_bookings bookng JOIN wpk4_backend_travel_booking_pax pax ON 
												        bookng.order_id = pax.order_id AND bookng.co_order_id = pax.co_order_id AND bookng.product_id = pax.product_id 
                                					where bookng.order_id='$order_id_api' order by pax.order_id desc LIMIT 20";
												$result_ticketing_history_g360 = mysqli_query($mysqli, $query_ticketing_history_g360);
												while ($row_ticketing_history_g360 = mysqli_fetch_assoc($result_ticketing_history_g360)) 
												{
													$auto_id = $row_ticketing_history_g360['auto_id'];
													$order_id = $row_ticketing_history_g360['order_id'];
													$name_replacement_value = $row_ticketing_history_g360['ticketing_remarks'] ?? '';
													echo "<tr>";
													echo "<td>{$auto_id}</td>";
													echo "<td>{$order_id}</td>";
													echo "<td>{$row_ticketing_history_g360['salutation']} {$row_ticketing_history_g360['fname']} {$row_ticketing_history_g360['lname']}</td>";
													echo "<td>Trip Code: {$row_ticketing_history_g360['trip_code']}<br>Travel Date: " . date('d-m-Y', strtotime($row_ticketing_history_g360['travel_date'])) . "</td>";
													echo "<td>{$row_ticketing_history_g360['payment_status']}</td>";
													echo "<td>{$row_ticketing_history_g360['pnr']}</td>";
													
													echo "<td>{$row_ticketing_history_g360['ticket_number']}</td>";
												
													echo "<td><input type='text' name='name_replacement[{$auto_id}]' value='{$name_replacement_value}' class='form-control'></td>";
													
													echo "<td>
															<select name='ticketing_request[{$auto_id}]' class='form-control'>
																<option value=''>Select</option>
																<option value='name correction request sent' " . ($row_ticketing_history_g360['name_updated'] == 'name correction request' ? 'selected' : '') . ">Name Correction Request</option>
																<option value='name replacement request sent' " . ($row_ticketing_history_g360['name_updated'] == 'name replacement request' ? 'selected' : '') . ">Name Replacement Request</option>
																<option value='name removal request sent' " . ($row_ticketing_history_g360['name_updated'] == 'name removal request' ? 'selected' : '') . ">Name Removal Request</option>
									
																<option value='name correction sent' " . ($row_ticketing_history_g360['name_updated'] == 'name correction sent' ? 'selected' : '') . ">Name Correction Sent</option>
																<option value='name replacement sent' " . ($row_ticketing_history_g360['name_updated'] == 'name replacement sent' ? 'selected' : '') . ">Name Replacement Sent</option>
																<option value='name removal sent' " . ($row_ticketing_history_g360['name_updated'] == 'name removal sent' ? 'selected' : '') . ">Name Removal Sent</option>
																
																<option value='name correction completed' " . ($row_ticketing_history_g360['name_updated'] == 'name correction completed' ? 'selected' : '') . ">Name Correction Completed</option>
																<option value='name replacement completed' " . ($row_ticketing_history_g360['name_updated'] == 'name replacement completed' ? 'selected' : '') . ">Name Replacement Completed</option>
																<option value='name removal completed' " . ($row_ticketing_history_g360['name_updated'] == 'name removal completed' ? 'selected' : '') . ">Name Removal Completed</option>
																
															</select>
														</td>";
													echo "</tr>";
												}
												?>
											</tbody>
										</table>
										<button type="submit" name="update_ticketing_in_g360_<?php echo $order_id_api; ?>" class="btn btn-primary">Update Request</button>
									</form>
								</div>
            			        
            			        <div id="discount_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
									</br>
									<form method="post">
                                    <label>Coupon Code:</label>
                                    <select name="coupon_code" required style="width:100%; height:40px;">
                                        <option value="" disabled selected>Select Discount</option>
                                        <!--<option value="256812">Coupon5 - Discount 5%</option>-->
                                        <option value="264053">Gaura10 - Discount 10% on Return ending 30th Sep 2025</option>
                                        <option value="271776">GTDiscount50 - Discount $50</option>
										
										<option value="273455">Gaura5 - Discount 5% on Return</option>
										
										<option value="249590">Birthday5 - Birthday Coupon - 5% Discount</option>
                                        
                                    </select><br><br>
                                
                                    <input type="submit" name="apply_coupon" value="Apply Coupon">
                                </form>
                                    <?php
                                    if (isset($_POST['apply_coupon'])) {
                                            $order_id  = intval($order_id_api);
                                            $coupon_id = intval($_POST['coupon_code']); // this is post_id of the coupon
                                        
                                            //  Get coupon meta from DB
                                            $coupon_meta_raw = $wpdb->get_var($wpdb->prepare(
                                                "SELECT meta_value FROM wpk4_postmeta 
                                                 WHERE post_id = %d AND meta_key = 'wp_travel_coupon_metas' 
                                                 ORDER BY meta_id DESC LIMIT 1",
                                                $coupon_id
                                            ));
                                        
                                            if (!$coupon_meta_raw) {
                                                echo "<p style='color:red;'>Coupon meta not found.</p>";
                                                return;
                                            }
                                        print_r($coupon_meta_raw);
                                            $coupon_meta = @unserialize($coupon_meta_raw);
                                        
                                            if (!is_array($coupon_meta) || empty($coupon_meta['general'])) {
                                                echo "<p style='color:red;'>Invalid coupon data.</p>";
                                                return;
                                            }
                                        
                                            //  Extract details
                                            //  Extract coupon data
                                        $general_data = $coupon_meta['general'] ?? [];
                                        
                                        $coupon_code   = $general_data['coupon_code'] ?? '';
                                        $discount_type = $general_data['coupon_type'] ?? 'amount'; // default to fixed amount
                                        $discount_val  = isset($general_data['coupon_value']) 
                                            ? floatval($general_data['coupon_value']) 
                                            : 0;
                                        
                                        if (empty($coupon_code) || $discount_val <= 0) {
                                            echo "<p style='color:red;'>Invalid or incomplete coupon data.</p>";
                                            return;
                                        }
                                        
                                        
                                            //  Check if coupon already applied
                                            $coupon_meta_rows = $wpdb->get_results($wpdb->prepare(
                                                "SELECT meta_id, meta_value FROM wpk4_postmeta 
                                                 WHERE post_id = %d AND meta_key = 'wp_travel_applied_coupon_data'",
                                                $order_id
                                            ));
                                            
                                            $coupon_applied = false;
                                            
                                            foreach ($coupon_meta_rows as $row) {
                                                if (trim($row->meta_value) === serialize([])) {
                                                    // Delete empty meta
                                                    $wpdb->delete(
                                                        'wpk4_postmeta',
                                                        ['meta_id' => $row->meta_id],
                                                        ['%d']
                                                    );
                                                } else {
                                                    $coupon_applied = true;
                                                }
                                            }
                                            
                                            if ($coupon_applied) {
                                                echo "<p style='color:red;'>Error: Coupon already applied.</p>";
                                                return;
                                            }
                                        
                                        
                                            //  Get total amount from bookings
                                            $total_amount = $wpdb->get_var($wpdb->prepare(
                                                "SELECT total_amount FROM wpk4_backend_travel_bookings WHERE order_id = %d",
                                                $order_id
                                            ));
                                        
                                            if ($total_amount === null) {
                                                echo "<p style='color:red;'>Error: Order ID not found.</p>";
                                                return;
                                            }
                                        
                                            //  Calculate discount
                                            if ($discount_type === 'percentage') {
                                                $discounted = $total_amount - ($total_amount * $discount_val / 100);
                                            } else {
                                                $discounted = $total_amount - $discount_val;
                                            }
                                            $discounted = max(0, $discounted);
                                        
                                            //  Update booking total
                                            $wpdb->update(
                                                'wpk4_backend_travel_bookings',
                                                ['total_amount' => $discounted],
                                                ['order_id' => $order_id],
                                                ['%f'],
                                                ['%d']
                                            );
                                        
                                            //  Format discount value
                                            $numeric_discount = (float)$discount_val;
                                        $value_str = (intval($numeric_discount) == $numeric_discount)
                                            ? (string)(intval($numeric_discount))
                                            : (string)$numeric_discount;
                                        
                                        
                                        
                                            //  Serialize and insert coupon application meta
                                            $coupon_applied = serialize([
                                                'type'        => $discount_type,
                                                'value'       => $value_str,
                                                'coupon_id'   => (string)$coupon_id,
                                                'coupon_code' => $coupon_code,
                                            ]);
                                        
                                            $wpdb->insert(
                                                'wpk4_postmeta',
                                                [
                                                    'post_id'    => $order_id,
                                                    'meta_key'   => 'wp_travel_applied_coupon_data',
                                                    'meta_value' => $coupon_applied
                                                ],
                                                ['%d', '%s', '%s']
                                            );
                                        
                                            echo "<p style='color:green;'>Coupon <strong>{$coupon_code}</strong> applied successfully. New total: <strong>$discounted</strong></p>";
                                        }
                                    ?>
								</div>
								
								<!--agent tab to update the sales id start-->
								<?php
                            		 if( current_user_can( 'administrator' ) || current_user_can( 'sales_manager' ) ) 
                            		 {
                            		  ?>
								<div id="agentnameupdate_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                        			
                            		    
                            		 
                            		 
                            		<h5>New Agent Update</h5>
                            		<script src="https://cdn.jsdelivr.net/gh/alumuko/vanilla-datetimerange-picker@latest/dist/vanilla-datetimerange-picker.js"></script>

                                    	<form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                            <table>
                                                <tr>
                                                    <td>
                                                        Order ID: <?php echo $order_id_api; ?> <?php if($co_order_id_api != '') { echo ' '.$co_order_id_api; } ?>
                                                        <input type="hidden" name="order_id" value="<?php echo $order_id_api; ?>">
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        Current Sale ID: <?php echo $agent_info; ?>
                                                        <input type="hidden" name="current_sale_id" value="<?php echo $agent_info; ?>">
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        New Sale ID:
                                                        <select name="new_sale_id" required style="padding: 5px; width: 200px;">
                                                            <option value="">Select Sale ID</option>
                                                            <?php
                                                            // Query to get distinct sales_id where team_name <> 'Others' and status = 'active'
                                                            $sales_query = "SELECT DISTINCT sales_id 
                                                                           FROM wpk4_backend_agent_codes 
                                                                           WHERE team_name <> 'Others' AND status = 'active'
                                                                           ORDER BY sales_id";
                                                            $sales_result = mysqli_query($mysqli, $sales_query);
                                                            
                                                            while ($sales_row = mysqli_fetch_assoc($sales_result)) {
                                                                echo '<option value="' . $sales_row['sales_id'] . '">' . $sales_row['sales_id'] . '</option>';
                                                            }
                                                            ?>
                                                        </select>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        Call File Number: 
                                                        <input type="text" name="call_file_number" required style="padding: 5px; width: 200px;">
                                                        
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td colspan='2'>
                                                        <center>
                                                            <input type='submit' style='padding:15px; margin:0;font-size:11px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;' 
                                                            name="submit_sale_id" id="submit_sale_id" value='Submit'>
                                                        </center>
                                                    </td>
                                                </tr>

                                            </table>
                                        </form>
                                        <?php
                                        $current_user = wp_get_current_user();
                                        $created_by = $current_user->user_login;
                                        
                                        if(isset($_POST['submit_sale_id'])) {
                                            $order_id = $_POST['order_id'];
                                            $new_sale_id = $_POST['new_sale_id'];
                                            $call_file_number = $_POST['call_file_number'];
                                            $current_sale_id = $_POST['current_sale_id'];
                                            
                                            $agent_query = "SELECT team_name, sale_manager 
                                                                FROM wpk4_backend_agent_codes 
                                                                WHERE sales_id = '$new_sale_id' 
                                                                LIMIT 1";
                                                $agent_result = mysqli_query($mysqli, $agent_query);
                                                $agent_data = mysqli_fetch_assoc($agent_result);
                                                
                                                $team_name = $agent_data['team_name'] ?? null;
                                                $sales_manager = $agent_data['sale_manager'] ?? null;
                                                
                                                
                                                mysqli_query($mysqli,"insert into wpk4_saleid_update ( order_id, current_sale_id, new_sale_id, team_name, sales_manager, created_date, created_by, call_file_number ) 
    						                    values ('$order_id', '$current_sale_id', '$new_sale_id', '$team_name', '$sales_manager', '$current_date_and_time', '$currnt_userlogn', $call_file_number)") or die(mysqli_error($mysqli));

                                                
                                                $result = mysqli_query($mysqli, $query);
                                                
                                            if($result) {
                                                echo "<script>alert('Sale ID update request submitted successfully!');</script>";
                                            } else {
                                                echo "<script>alert('Error updating Sale ID: ".mysqli_error($mysqli)."');</script>";
                                            }
                                        }
            		                }
                                ?>
        				        </div>
        				        
        				        <div id="TST_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                				    <div id="loading-message" style="display:none; text-align:center; padding:20px;">
                				        <p>Loading TST information...</p>
                				    </div>
									<div>
										Booked TST
										<table>
										<tr><td>Name</td><td>Price</td><td>Tax</td><td>Total</td></tr>
										<?php
										$tst_conversion_rate = ''; $PriceSell = 0; $TaxAmount = 0;
										$tst_rate_query = "SELECT rate
                                                                FROM wpk4_ypsilon_bookings_table_currency_rates 
                                                                WHERE booking_id = '$order_id_api'";
                                        $tst_rate_result = mysqli_query($mysqli, $tst_rate_query);
										if(mysqli_num_rows($tst_rate_result) > 0)
										{
											$tst_rate_data = mysqli_fetch_assoc($tst_rate_result);
											$tst_conversion_rate = $tst_rate_data['rate'];
										}
										
										$tst_selection_query = "SELECT fname, lname, order_id, pnr, gds_pax_id
                                                                FROM wpk4_backend_travel_booking_pax 
                                                                WHERE order_id = '$order_id_api'";
                                        $tst_selection_result = mysqli_query($mysqli, $tst_selection_query);
                                        while($tst_selection_data = mysqli_fetch_assoc($tst_selection_result))
										{
											$gds_pax_id_tst = $tst_selection_data['gds_pax_id'];
											$gds_pax_name = $tst_selection_data['fname'] . ' ' . $tst_selection_data['lname'];
											
											$tst_selection_query_fares = "SELECT PriceBuy
                                                                FROM wpk4_ypsilon_bookings_table_fare 
                                                                WHERE PaxId = '$gds_pax_id_tst'";
											$tst_selection_result_fares = mysqli_query($mysqli, $tst_selection_query_fares);
											while($tst_selection_data_fares = mysqli_fetch_assoc($tst_selection_result_fares))
											{
												$PriceSell = $tst_selection_data_fares['PriceBuy'];
											}	
											
											$tst_selection_query_tax = "SELECT Amount
                                                                FROM wpk4_ypsilon_bookings_table_tax 
                                                                WHERE PaxId = '$gds_pax_id_tst'";
											$tst_selection_result_tax = mysqli_query($mysqli, $tst_selection_query_tax);
											while($tst_selection_data_tax = mysqli_fetch_assoc($tst_selection_result_tax))
											{
												$TaxAmount = $tst_selection_data_tax['Amount'];
												if($tst_conversion_rate != '')
												{
													$TaxAmount = $TaxAmount / $tst_conversion_rate;

												}
											}
											$total_tst_amount = (float)$PriceSell + (float)$TaxAmount;
											echo '
											<tr>
											<td>'.$gds_pax_name.'</td>
											<td>'.number_format((float)$PriceSell, 2, '.', '').'</td>
											<td>'.number_format((float)$TaxAmount, 2, '.', '').'</td>
											<td>'.number_format((float)$total_tst_amount, 2, '.', '').'</td>
											</tr>';
										}
										?>
										</table>
									</div>
                				    <div id="tst-results" style="margin-top:20px;">
                				        <!-- TST results will be displayed here -->
                				    </div>
                				</div>
                				<div id="SSR_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                				        <div id="result"></div>
                				</div>
								
								<div id="SSR_notavailable_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
									<?php
									echo $smart_ssr_not_available_note;
									?>
                				</div>
								
								
								<div id="paxnameupdate_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                				        <div id="paxNameUpdate"></div>
										
                				</div>
								
								<div id="issues_<?php echo $order_id_api; ?><?php echo $co_order_id_api; ?><?php echo $product_id_api; ?><?php echo $new_product_id_api; ?>" class="tabcontent" style="display:none;">
                                      <h5>Issues</h5>
                                      <?php
                                      $order_id = $order_id_api;
                                        $query_issue_history = "SELECT * FROM wpk4_backend_travel_booking_issue_log where order_id='$order_id_api'  ";
                                    	$result_issue_history = mysqli_query($mysqli, $query_issue_history);
                        				$count_issue_history = mysqli_num_rows($result_issue_history);
                        				if($count_issue_history > 0)
                        				{
                        					?>
                        					<h5>Issues <span class="badge badge-primary"><?php echo $count_issue_history; ?></span></h5>
											<table class="table" style="width:90%; font-size:14px; margin:auto; border:1px solid black;">	
											<tr>
												<th>Category</th>
												<th>Note</th>
												<th>Status</th>
												<th>Added by</th>
												<th>Added on</th>
											</tr>
                        					<?php
                        					while($row_issue_history = mysqli_fetch_assoc($result_issue_history))
                        					{                        					    
                        					    ?>
                                            	    <tr>
														<td><?php echo $row_issue_history['issue_category']; ?></td>
														<td><?php echo $row_issue_history['issue_note']; ?></td>
														<td><?php echo $row_issue_history['status']; ?></td>
														<td><?php echo $row_issue_history['added_by']; ?></td>
														<td><?php echo date("d/m/Y H:i:s", strtotime( $row_issue_history['added_on'] )); ?></td>
													</tr>
                                    	        
                                    	        <?php
                        					}
											?>
											</table>
											<?php
                        				}
                        				else
                        				{
                        					echo 'No task created';
                        				}
                                      ?>
                                      
                                      <h5>Add Issues</h5>
                                      <form action="#" name="statusupdate" method="post" enctype="multipart/form-data">
                                            Issue Category
                                                <select name="issue_category" required style="width:100%; padding:10px;">
                                                    <option value="Name Error">Name Error</option>
                                                    <option value="Price Differenciation">Price Differenciation</option>
                                                    <option value="Wrong details">Wrong details</option>
                                                    <option value="Wrong travel date">Wrong travel date</option>
                                                    <option value="Others">Others</option>
                                                </select>
                                            </br> </br>
                                            Additional Information
                                            <textarea name="issue_description" required></textarea>
                                             </br>
                                            <center><input type='submit' style='padding:15px; margin:0;font-size:11px; ' name='save_issue_request_<?php echo $order_id_api; ?>' value='Save Note'></center>
                                		</form>
                                    <?php
                                    $save_issue_request_in_g360_post_name = 'save_issue_request_'.$order_id_api;

                                    if(isset($_POST[$save_issue_request_in_g360_post_name]))
                                    {
                                        $category_issue = $_POST['issue_category'];
                                        $issue_note_field = $_POST['issue_description'];
                                        
                                        $current_date_time = date("Y-m-d H:i:s");
                                        
                                        mysqli_query($mysqli,"insert into wpk4_backend_travel_booking_issue_log (order_id, issue_category, issue_note, added_by, added_on, status)
                                        values ('$order_id_api', '$category_issue', '$issue_note_field', '$currnt_userlogn', '$current_date_time', 'active' )") or die(mysqli_error($mysqli));

							            $current_url = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                                    	echo '<script>window.location.href="'.$current_url.'";</script>';
                                    }
                                    ?>
                				</div>
                				
                			</div>
            			    
            			    <?php
            			    echo '<hr>';
            			}
				    }
            		else
                	{
                	    if (ctype_digit($_GET['id'])) 
        				{
        					//echo 'No results found!!. please import <a href="https://gauratravel.com.au/gdeals-get-missing-bookings/">here</a>';
            			} 
            			else
            			{
                			//echo 'No results found!!. please import <a href="https://gauratravel.com.au/gds-get-missing-bookings/">here</a>';
            			}
                	}
            	}
            	else
            	{
            		echo 'Kindly search with PNR/Order ID';
            	}
            	?>
				</div><!-- END OF TAB CONTENT -->
				
				<script>
				    function openCity(evt, cityName) {
            		  var i, tabcontent, tablinks;
            		  tabcontent = document.getElementsByClassName("tabcontent");
            		  for (i = 0; i < tabcontent.length; i++) {
            			tabcontent[i].style.display = "none";
            		  }
            		  tablinks = document.getElementsByClassName("tablinks");
            		  for (i = 0; i < tablinks.length; i++) {
            			tablinks[i].className = tablinks[i].className.replace(" active", "");
            		  }
            		  document.getElementById(cityName).style.display = "block";
            		  evt.currentTarget.className += " active";
            		  
            		  if(cityName == 'fullnames' || cityName == 'names')
            		  {
            		      document.getElementById("").currentTarget.className += " active";
            		  }
            		}
            		
            // send request when TST tab is clicked
			async function handleTSTClick(){
                        const pnrs = <?php echo json_encode($pnrs) ?>;
                        console.log('PNRs data:', pnrs);
                        
                        const loadingMessage = document.getElementById('loading-message');
                        const tstResults = document.getElementById('tst-results');
                        
                        // Show loading message
                        loadingMessage.style.display = 'block';
                        tstResults.innerHTML = '';
                        
                        try {
                            let allTstData = [];
                            
                            // Process each PNR (assuming only one PNR)
                            for (let i = 0; i < pnrs.length; i++) {
                                let pnr, gdsId;
                                
                                pnr = pnrs[i].pnr;
                                gdsId = pnrs[i].gds_id || 'MELA828FN';
                     
                                
                                if (!pnr) continue; // Skip if no PNR
                                
                                console.log(`Processing PNR: ${pnr}, GDS ID: ${gdsId}`);
                                
                                try {
                                    // First API call to get session info
                                    const sessionResponse = await fetch(`https://gauratravel.com.au/wp-content/themes/twentytwenty/templates/amadeus_api/pnr_retrieve_fit.php?pnr=${encodeURIComponent(pnr)}&officeId=${encodeURIComponent(gdsId)}`);
                                    
                                    if (!sessionResponse.ok) {
                                        throw new Error(`Session API failed for PNR ${pnr}: ${sessionResponse.status}`);
                                    }
                                    
                                    const response = await sessionResponse.json();
                                    
									window._pnrPassengers = response.passengers || [];
									window._pnrItineraries = response.itineraries || [];

									window._sessionId = response.session && response.session.sessionId;
									window._securityToken = response.session && response.session.securityToken;
                                    console.log(`Session data for PNR ${pnr}:`, response.session);
                                    
                                    if (response.session.sessionId && response.session.securityToken) {
                                        // Second API call to get TST data
                                        const tstResponse = await fetch(`https://gauratravel.com.au/wp-content/themes/twentytwenty/templates/amadeus_api/ticket_display_tst.php?sessionId=${encodeURIComponent(response.session.sessionId)}&securityToken=${encodeURIComponent(response.session.securityToken)}`);
                                        
                                        if (!tstResponse.ok) {
                                            throw new Error(`TST API failed for PNR ${pnr}: ${tstResponse.status}`);
                                        }
                                        
                                        const tstData = await tstResponse.json();
                                        console.log(`TST data for PNR ${pnr}:`, tstData);
                                        
                                        if (tstData.fareList && Array.isArray(tstData.fareList) && tstData.fareList.length > 0) {
                                            allTstData.push({
                                                pnr: pnr,
                                                gdsId: gdsId,
                                                fareList: tstData.fareList
                                            });
                                        }
                                    }
                                } catch (error) {
                                    console.error(`Error processing PNR ${pnr}:`, error);
                                    // Continue with next PNR even if this one fails
                                }
                            }
                            
                            // Hide loading message
                            loadingMessage.style.display = 'none';
                            
                            console.log(allTstData);
                            // Display results
                            if (allTstData.length > 0) {
                                displayTstResults(allTstData);
                            } else {
                                tstResults.innerHTML = '<p style="text-align:center; color:#666;">No TST data found for any PNR.</p>';
                            }
                            
                        } catch (error) {
                            console.error('Error in handleTSTClick:', error);
                            loadingMessage.style.display = 'none';
                            tstResults.innerHTML = '<p style="text-align:center; color:red;">An error occurred while fetching TST data.</p>';
                        }
                    }
                    
                    // Render TST Table
                    function displayTstResults(allTstData) {
                        const tstResults = document.getElementById('tst-results');
                        let html = '';
                        
                            allTstData.forEach((pnrData, index) => {
                            // Collect all tax types across all passengers (using taxIdentifier + isoCountry for unique identification)
                            const allTaxTypes = [];
                            pnrData.fareList.forEach(fare => {
                                fare.tax.forEach(tax => {
                                    const taxType = `${tax.taxIdentifier || 'UNK'}-${tax.isoCountry || 'UNK'}`;
                                    if (!allTaxTypes.includes(taxType)) {
                                        allTaxTypes.push(taxType);
                                    }
                                });
                            });
                            allTaxTypes.sort();
                            
                            html += `
                                <div style="margin-bottom:30px;">
                                    <h4 style="color:#2c3e50; border-bottom:2px solid #3498db; padding-bottom:10px;">
                                        PNR: ${pnrData.pnr} | GDS ID: ${pnrData.gdsId}
                                    </h4>
                                    <table class="table table-striped" style="width:100%; font-size:13px; border-collapse:collapse; margin-top:15px;">
                                        <thead style="background-color:#34495e; color:white;">
                                            <tr>
                                                <th style="padding:10px; border:1px solid #ddd;">Passenger Name</th>
                                                <th style="padding:10px; border:1px solid #ddd;">Base Fare</th>`;
                            
                            // Add individual tax columns
                            allTaxTypes.forEach(taxType => {
                                html += `<th style="padding:10px; border:1px solid #ddd;">${taxType}</th>`;
                            });
                            
                            html += `
                                                <th style="padding:10px; border:1px solid #ddd;">Total Tax</th>
                                                <th style="padding:10px; border:1px solid #ddd;">Full Fare</th>
                                                <th style="padding:10px; border:1px solid #ddd;">Currency</th>
                                            </tr>
                                        </thead>
                                        <tbody>`;
                            
                            pnrData.fareList.forEach((fare, fareIndex) => {
                                // Get passenger name from the passengers data if available
                                let passengerName = fare.uniqueReference;
                                if (window._pnrPassengers && window._pnrPassengers.length ) {
                                    const passenger = window._pnrPassengers.find(p => 
                                        String(p.reference) === String(fare.uniqueReference)
                                    );
                                    if (passenger) {
                                        passengerName = `${passenger.surname} ${passenger.firstName} (${passenger.type})`;
                                    }
                                }
                                
                                // Find base fare and full fare amounts
                                let baseFareAmount = 0;
                                let fullFareAmount = 0;
                                let currency = '';
                                
                                fare.fareAmount.forEach(fareAmount => {
                                    if (fareAmount.fareDataQualifier === 'B') {
                                        baseFareAmount = parseFloat(fareAmount.fareAmount);
                                        // currency = fareAmount.fareCurrency;
                                    } else {
                                        fullFareAmount = parseFloat(fareAmount.fareAmount);
                                        if (!currency) currency = fareAmount.fareCurrency;
                                    }
									if (fareAmount.fareDataQualifier === 'E') {
										baseFareAmount = parseFloat(fareAmount.fareAmount);
									}
                                });
                                
                                // Calculate individual tax amounts
                                const taxAmounts = {};
                                let totalTax = 0;
                                fare.tax.forEach(tax => {
                                    const taxType = `${tax.taxIdentifier || 'UNK'}-${tax.isoCountry || 'UNK'}`;
                                    const taxAmount = parseFloat(tax.fareAmount);
                                    taxAmounts[taxType] = (taxAmounts[taxType] || 0) + taxAmount;
                                    totalTax += taxAmount;
                                });

								fare.uniqueReference.forEach(uniqueReference => {
									const passenger = window._pnrPassengers.find(p => 
										String(p.reference) === String(uniqueReference)
									);
									if (passenger) {
										passengerName = `${passenger.surname} ${passenger.firstName} (${passenger.type})`;
									}

									html += `
                                    <tr>
                                        <td style="padding:8px; border:1px solid #ddd; background-color:#ecf0f1;">${passengerName}</td>
                                        <td style="padding:8px; border:1px solid #ddd; text-align:right; font-weight:bold;">${baseFareAmount.toLocaleString()}</td>`;
                                
                                // Add individual tax amounts
                                allTaxTypes.forEach(taxType => {
                                    const amount = taxAmounts[taxType] || 0;
                                    html += `<td style="padding:8px; border:1px solid #ddd; text-align:right;">${amount.toLocaleString()}</td>`;
                                });
                                
                                html += `
                                        <td style="padding:8px; border:1px solid #ddd; text-align:right; font-weight:bold; background-color:#f8f9fa;">${totalTax.toLocaleString()}</td>
                                        <td style="padding:8px; border:1px solid #ddd; text-align:right; font-weight:bold; color:#27ae60;">${fullFareAmount.toLocaleString()}</td>
                                        <td style="padding:8px; border:1px solid #ddd; text-align:center;">${currency}</td>
                                    </tr>`
								});
                                
                              ;
                            });
                            
                            html += `
                                        </tbody>
                                    </table>
                                </div>
                            `;
                        });
                        
                        tstResults.innerHTML = html;
                    }  
                    
                    
                    
                    // send request when SSR tab is clicked
                    function handleSSRClick(){
                        const pnrs = <?php echo json_encode($pnrs) ?>;
                        const pnr = pnrs[0].pnr;
                        const officeId = pnrs[0].gds_id || "MELA828FN";
						document.getElementById('result').innerHTML = 'Loading...';
                            fetch(`https://gauratravel.com.au/wp-content/themes/twentytwenty/templates/amadeus_api/pnr_retrieve_fit.php?pnr=${encodeURIComponent(pnr)}&officeId=${encodeURIComponent(officeId)}`)
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                document.getElementById('result').innerHTML = `<div class="pnr-error">Error: ${escapeHTML(data.error || 'Unknown error')}</div>`;
                return;
            }
            window._pnrPassengers = data.passengers || [];
            window._pnrItineraries = data.itineraries || [];

            window._sessionId = data.session && data.session.sessionId;
            window._securityToken = data.session && data.session.securityToken;
            let html = '';

            // SSR tabs
            if (true || (data.specialServiceRequests && data.specialServiceRequests.length)) {
                const docsSSRs = data.specialServiceRequests.filter(s => (s.type || '').toUpperCase() === 'DOCS');
                const mealSSRs = data.specialServiceRequests.filter(s => (s.type || '').toUpperCase().slice(-2) === 'ML');
                const seatSSRs = data.specialServiceRequests.filter(s => (s.type || '').toUpperCase() === 'NSST');
                const ffSSRs = data.specialServiceRequests.filter(s => (s.type || '').toUpperCase() === 'FQTV');
                const wcSSRs = data.specialServiceRequests.filter(s => (s.type || '').toUpperCase().startsWith('WC'));
                const otherSSRs = data.specialServiceRequests.filter(s => {
                    const t = (s.type || '').toUpperCase();
                    return t !== 'DOCS' && t.slice(-2) !== 'ML' && t !== 'NSST' && t !== 'FQTV' && !t.startsWith('WC');
                });
                html += `
                <div class="pnr-section">
                  <div class="pnr-section-title">Service Requests & Travel Documents</div>
                  <div class="pnr-tabs">
                    <button class="pnr-tab active" id="pnr-tab-btn-ssr" onclick="showTab('ssr')">Other Special Service Requests</button>
                    <button class="pnr-tab" id="pnr-tab-btn-docs" onclick="showTab('docs')">Travel Documents</button>
                    <button class="pnr-tab" id="pnr-tab-btn-meal" onclick="showTab('meal')">Meal Requests</button>
                    <button class="pnr-tab" id="pnr-tab-btn-seat" onclick="showTab('seat')">Seat Requests</button>
                    <button class="pnr-tab" id="pnr-tab-btn-fq" onclick="showTab('fq')">Frequent Flyer</button>
                    <button class="pnr-tab" id="pnr-tab-btn-wheelchair" onclick="showTab('wheelchair')">Wheelchair</button>
                  </div>
                  <div class="pnr-tab-content active" id="pnr-tab-content-ssr">
                    ${renderSSRWithRefs(otherSSRs, data.passengers, data.itineraries)}
                  </div>
                  <div class="pnr-tab-content" id="pnr-tab-content-docs">
                    ${renderDOCSTable(docsSSRs)}
                  </div>
                  <div class="pnr-tab-content" id="pnr-tab-content-meal">
                    ${renderMealFormAndTable(mealSSRs, data.passengers, data.itineraries)}
                  </div>
                  <div class="pnr-tab-content" id="pnr-tab-content-seat">
                    ${renderSeatSSRTable(seatSSRs, data.passengers, data.itineraries)}
                  </div>
                  <div class="pnr-tab-content" id="pnr-tab-content-fq">
                    ${renderFQTVTable(ffSSRs, data.passengers)}
                  </div>
                  <div class="pnr-tab-content" id="pnr-tab-content-wheelchair">
                    ${renderWheelchairFormAndTable(wcSSRs, data.passengers, data.itineraries)}
                  </div>
                </div>
                `;
            }
            
            document.getElementById('result').innerHTML = html;
            setTimeout(function() {
                var select = document.getElementById('pnr-doc-passenger');
                if (select) {
                    select.innerHTML = '<option value="">Select Passenger</option>';
                    (window._pnrPassengers || []).forEach(function(p) {
                        var opt = document.createElement('option');
                        opt.value = p.reference;
                        opt.text = p.surname + ' ' + p.firstName + ' (' + p.type + ')';
                        select.appendChild(opt);
                    });
                }


                // Populate edit passenger dropdown
                var editPassengerSelect = document.getElementById('editPassengerSelect');
                if (editPassengerSelect) {
                    editPassengerSelect.innerHTML = '<option value="">Select Passenger to Edit</option>';
                    (window._pnrPassengers || []).forEach(function(p) {
                        var opt = document.createElement('option');
                        opt.value = p.reference;
                        opt.text = p.surname + ' ' + p.firstName + ' (Ref: ' + p.reference + ')';
                        editPassengerSelect.appendChild(opt);
                    });
                }

                // dropdown for selecting pax
                var selectPax = document.getElementById('pnr-meal-passenger');
                // if (selectPax) {
                //     selectPax.innerHTML = '<option value="">Select Passenger</option>';
                //     (window._pnrPassengers || []).forEach(function(p) {
                //         var opt = document.createElement('option');
                //         opt.value = p.reference;
                //         opt.text = p.surname + ' ' + p.firstName + ' (' + p.type + ')';
                //         //selectPax.appendChild(opt);
                //     });
                // }
                // dropdown for selecting flight segment
                var selectSeg = document.getElementById('pnr-meal-segment');
                if (selectSeg) {
                    selectSeg.innerHTML = '<option value="">Select Segment</option>';
                    (data.itineraries || []).forEach(function(i) {
                        var opt = document.createElement('option');
                        opt.value = i.segmentReference;
                        opt.text = `${i.airline} ${i.flightNumber} (${i.departureCity}${i.arrivalCity} ${i.departureDate})`;
                        selectSeg.appendChild(opt);
                    });
                }
                // dropdown for seat form
                var selectSeatPax = document.getElementById('pnr-seat-passenger');
                if (selectSeatPax) {
                    selectSeatPax.innerHTML = '<option value="">Select Passenger</option>';
                    (window._pnrPassengers || []).forEach(function(p) {
                        var opt = document.createElement('option');
                        opt.value = p.reference;
                        opt.text = p.surname + ' ' + p.firstName + ' (' + p.type + ')';
                        selectSeatPax.appendChild(opt);
                    });
                }
                var selectSeatSeg = document.getElementById('pnr-seat-segment');
                if (selectSeatSeg) {
                    selectSeatSeg.innerHTML = '<option value="">Select Segment</option>';
                    (data.itineraries || []).forEach(function(i) {
                        var opt = document.createElement('option');
                        opt.value = i.segmentReference;
                        opt.text = `${i.airline} ${i.flightNumber} (${i.departureCity}${i.arrivalCity} ${i.departureDate})`;
                        selectSeatSeg.appendChild(opt);
                    });
                }
                if (window.flatpickr) {
                    flatpickr("input[name='dob']", {dateFormat: "Y-m-d", maxDate: 'today'});
                    flatpickr("input[name='expiry']", {dateFormat: "Y-m-d", minDate: new Date().fp_incr(180)});
                }
                // Populate Frequent Flyer form dropdowns
                var selectFQPax = document.getElementById('pnr-fq-passenger');
                if (selectFQPax) {
                    selectFQPax.innerHTML = '<option value="">Select Passenger</option>';
                    (window._pnrPassengers || []).forEach(function(p) {
                        var opt = document.createElement('option');
                        opt.value = p.reference;
                        opt.text = p.surname + ' ' + p.firstName + ' (' + p.type + ')';
                        selectFQPax.appendChild(opt);
                    });
                }
                var selectFQAir = document.getElementById('pnr-fq-airline');
                if (selectFQAir) {
                    selectFQAir.innerHTML = '<option value="">Select Airline</option>';
                    var airlines = new Set((data.itineraries || []).map(i => i.airline));
                    airlines.forEach(function(a){
                        var opt = document.createElement('option');
                        opt.value = a;
                        opt.text = a;
                        selectFQAir.appendChild(opt);
                    });
                }
                // Populate Wheelchair form dropdowns
                var selectWCPax = document.getElementById('pnr-wheelchair-passenger');
                // if (selectWCPax) {
                //     selectWCPax.innerHTML = '<option value="">Select Passenger</option>';
                //     (window._pnrPassengers || []).forEach(function(p) {
                //         var opt = document.createElement('option');
                //         opt.value = p.reference;
                //         opt.text = p.surname + ' ' + p.firstName + ' (' + p.type + ')';
                //         selectWCPax.appendChild(opt);
                //     });
                // }
                var selectWCSeg = document.getElementById('pnr-wheelchair-segment');
                if (selectWCSeg) {
                    selectWCSeg.innerHTML = '<option value="">Select Segment</option>';
                    (data.itineraries || []).forEach(function(i) {
                        var opt = document.createElement('option');
                        opt.value = i.segmentReference;
                        opt.text = `${i.airline} ${i.flightNumber} (${i.departureCity}${i.arrivalCity} ${i.departureDate})`;
                        selectWCSeg.appendChild(opt);
                    });
                }
            }, 0);

        })
        .catch(e => {
            document.getElementById('result').innerHTML = `<div class="pnr-error">Error fetching PNR: ${escapeHTML(e.message)}</div>`;
        });
                    }
                    
                    function escapeHTML(str) {
						return str.replace(/[&<>"']/g, function(m) {
							return ({
								'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
							})[m];
						});
					}

                    function renderSection(title, content) {
                        return `<div class="pnr-section"><div class="pnr-section-title">${title}</div>${content}</div>`;
                    }
                    function renderTable(headers, rows) {
                        let thead = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
                        let tbody = rows.map(row =>
                            '<tr>' + headers.map(h => `<td>${escapeHTML(String(row[h] ?? ''))}</td>`).join('') + '</tr>'
                        ).join('');
                        return `<div class="pnr-table-scroll"><table class="pnr-table">${thead}${tbody}</table></div>`;
                    }
                    function renderKeyValue(obj) {
                        return '<div class="pnr-table-scroll"><table class="pnr-table">' + Object.entries(obj).map(([k, v]) =>
                            `<tr><th class="pnr-label">${escapeHTML(k)}</th><td>${escapeHTML(String(v ?? ''))}</td></tr>`
                        ).join('') + '</table></div>';
                    }
                    
                    function parseDOCSFreetext(freetext) {
                        // Example: P/CHN/P12213/CHN/18JUL01/M/22JUL30/OU/DDD
                        // type/nationality/number/nationality/dob/gender/expiry/surname/firstname
                        if (!freetext) return {};
                        const parts = freetext.split('/');
                        return {
                            'Type': parts[0] || '',
                            'Number': parts[2] || '',
                            'Nationality': parts[1] || '',
                            'DOB': parts[4] || '',
                            'Gender': parts[5] || '',
                            'Expiry': parts[6] || '',
                            'Surname': parts[7] || '',
                            'First Name': parts[8] || ''
                        };
                    }
                    
                    function renderDOCSTable(docsSSRs) {
                        const headers = ['Passenger', 'Type', 'Passport Number', 'Nationality', 'DOB', 'Gender', 'Expiry', 'Surname', 'First Name'];
                        const rows = docsSSRs.map(ssr => {
                            const pax = window._pnrPassengers?.find(p => String(p.reference) === String(ssr.paxRef));
                            const paxName = pax ? `${pax.surname} ${pax.firstName} (${pax.type})` : ssr.paxRef || '';
                            const doc = parseDOCSFreetext(ssr.freeText);
                            return {
                                'Passenger': paxName,
                                'Type': doc['Type'],
                                'Passport Number': doc['Number'],
                                'Nationality': doc['Nationality'],
                                'DOB': doc['DOB'],
                                'Gender': doc['Gender'],
                                'Expiry': doc['Expiry'],
                                'Surname': doc['Surname'],
                                'First Name': doc['First Name']
                            };
                        });
                        // Add form for new document above the table
                        return `
                                ${renderTable(headers, rows)}
                    
                            <form id="pnr-add-doc-form" onsubmit="submitAddDocForm(event)" style="margin-bottom:24px;">
                                <div id="pnr-doc-form-error" class="pnr-error" style="display:none;"></div>
                                <div id="pnr-doc-form-spinner" style="display:none;text-align:center;margin-bottom:10px;">
                                    <span class="pnr-spinner" style="display:inline-block;width:28px;height:28px;border:4px solid #90caf9;border-top:4px solid #1976d2;border-radius:50%;animation:spin 1s linear infinite;"></span>
                                </div>
                                <div class="pnr-form-row">
                                    <label>Passenger</label>
                                    <select name="passenger" id="pnr-doc-passenger" required>
                                        <option value="">Select Passenger</option>
                                    </select>
                                </div>
                                <div class="pnr-form-row">
                                    <label for="passport">Passport Number</label>
                                    <input type="text" name="passport" id="passport" required />
                                </div>
                                <div class="pnr-form-row">
                                    <label for="nationality">Nationality</label>
                                    <input type="text" name="nationality" id="nationality" required />
                                </div>
                                <div class="pnr-form-row">
                                    <label for="dob">Date of Birth</label>
                                    <input type="date" name="dob" id="dob" required />
                                </div>
                                <div class="pnr-form-row">
                                    <label for='gender'>Gender</label>
                                    <select name="gender" id='gender' required>
                                        <option value="">Select Gender</option>
                                        <option value="M">Male</option>
                                        <option value="F">Female</option>
                                    </select>
                                </div>
                                <div class="pnr-form-row">
                                    <label for='expiry'>Expiry Date</label>
                                    <input type="date" name="expiry" id='expiry' required />
                                </div>
                                <div class="pnr-form-row" style="text-align:right;">
                                    <button type="submit" class="pnr-btn">Add Document</button>
                                </div>
                            </form>
                        `;
                    }
                    
					document.addEventListener('change', function (e) {
					  if (!e.target.matches('#pnr-add-meal-form #pnr-meal-passenger')) return;

					  const form = e.target.closest('form');
					  if (!form) return;

					  // Use the hidden input inside THIS form
					  const hiddenFullname = form.querySelector('input[name="meal_pax_fullname"]');
					  if (!hiddenFullname) return;

					  const opt = e.target.selectedOptions && e.target.selectedOptions[0];
					  const label = opt ? opt.text.trim() : '';

					  hiddenFullname.value = (label === 'Select Passenger') ? '' : label;
					});


                    function renderMealFormAndTable(mealSSRs, passengers, itineraries) {
                       

						const pnrs = <?php echo json_encode($pnrs); ?>;
						console.log(' All PNRs:', pnrs);

						const currentIndex = 0; // Or dynamically choose
						const pnrObj = pnrs[currentIndex] || {};
						const currentPNR = pnrObj.pnr || null;
						console.log(' Current PNR Object:', pnrObj);
						console.log(' Current PNR Code:', currentPNR);

						console.log(' Amadeus Passengers:', passengers);
						console.log(' Meal SSRs:', mealSSRs);
						console.log(' Itineraries:', itineraries);

						const headers = [
							'Type', 'Status', 'Qty', 'Airline', 'Free Text',
							'Passenger', 'Flight Segment'
						];

						// Match Amadeus passengers to local passengers in PNR
						const filteredPassengers = (passengers || []).filter(p => {
							const amadeusFirstName = (p.firstName || '').trim().toLowerCase();
							const amadeusSurname = (p.surname || '').trim().toLowerCase();
							const amadeusDob = (p.dob || '').trim();

							const matched = (pnrObj.pax || []).some(localPax => {
								const localFullName = `${(localPax.fname || '').trim()} ${(localPax.salutation || '').trim()}`.toLowerCase();
								const localSurname = (localPax.lname || '').trim().toLowerCase();
								const localDob = (localPax.dob || '').trim();

								const isMatch = (
									amadeusFirstName === localFullName &&
									amadeusSurname === localSurname
									// && amadeusDob === localDob // Optional check
								);

								if (isMatch) {
									console.log(` Matched Amadeus Pax: ${p.firstName} ${p.surname}`);
								}
								return isMatch;
							});

							return matched;
						});
						console.log(' Filtered Matching Passengers:', filteredPassengers);
					const passengerOptions = filteredPassengers.map(pxv => {
						const label = `${pxv.surname} ${pxv.firstName} (${pxv.type})`;
						return `<option value="${pxv.reference}">${escapeHTML(label)}</option>`;
					}).join('');	
					console.log(' Filtered :', passengerOptions);	
						const rows = mealSSRs
							.filter(ssr => {
								const pax = filteredPassengers.find(p => String(p.reference) === String(ssr.paxRef));
								if (!pax) {
									console.log(` SSR Skipped (no matching passenger):`, ssr);
								}
								return !!pax;
							})
							.map(ssr => {
								const pax = filteredPassengers.find(p => String(p.reference) === String(ssr.paxRef));
								const paxName = pax
									? `${pax.surname} ${pax.firstName} (${pax.type})`
									: ssr.paxRef || '';

								const seg = itineraries.find(i => String(i.segmentReference) === String(ssr.segmentRef));
								const segInfo = seg
									? `${seg.airline} ${seg.flightNumber} (${seg.departureCity}${seg.arrivalCity} ${seg.departureDate})`
									: ssr.segmentRef || '';

								const row = {
									'Type': ssr.type,
									'Status': ssr.status,
									'Qty': ssr.quantity,
									'Airline': ssr.airline,
									'Free Text': ssr.freeText,
									'Passenger': paxName,
									'Flight Segment': segInfo
								};

								console.log(' Meal Row:', row);
								return row;
							});
						console.log(' Final Meal SSR Table Rows:', rows);

				
                       
                        // Add form for new meal request above the table
                        return `
                                ${renderTable(headers, rows)}
                    
                            <form id="pnr-add-meal-form" onsubmit="submitAddMealForm(event)" style="margin-bottom:24px;">
                                    <div id="pnr-meal-form-error" class="pnr-error" style="display:none;"></div>
                                <div id="pnr-meal-form-spinner" style="display:none;text-align:center;margin-bottom:10px;">
                                    <span class="pnr-spinner" style="display:inline-block;width:28px;height:28px;border:4px solid #90caf9;border-top:4px solid #1976d2;border-radius:50%;animation:spin 1s linear infinite;"></span>
                                </div>
                                <div class="pnr-form-row">
                                    <label>Passenger</label>
                                    <select name="passenger" id="pnr-meal-passenger" required>
										<option value="">Select Passenger</option>
										${passengerOptions}
									</select>
									<input type="hidden" name="segment" id="pnr-meal-segment" value="">
									<input type="hidden" name="meal_pax_fullname" id="mealpnr-fullname" value="">
                                </div>
                                
                                <div class="pnr-form-row">
                                    <label>Meal Type</label>
                                    <select name="mealType" required>
                                        <option value="">Select Meal Type</option>
                                        <option value="AVML">AVML - ASIAN VEG.MEAL</option>
                                        <option value="BBML">BBML - INF/BABY FOOD</option>
                                        <option value="BLML">BLML - BLAND MEAL</option>
                                        <option value="CHML">CHML - CHILD MEAL</option>
                                        <option value="DBML">DBML - DIABETIC MEAL</option>
                                        <option value="GFML">GFML - GLUTEN FREE</option>
                                        <option value="HNML">HNML - Hindu Non Veg Meal</option>
                                        <option value="KSML">KSML - KOSHER</option>
                                        <option value="LCML">LCML - LOW CALORIE</option>
                                        <option value="LFML">LFML - LOW CHOLES./FAT</option>
                                        <option value="LSML">LSML - LOW SODIUM</option>
                                        <option value="MOML">MOML - MUSLIM MEAL</option>
                                        <option value="NLML">NLML - NONLACTOSE</option>
                                        <option value="RVML">RVML - RAW VEGETARIAN</option>
                                        <option value="SFML">SFML - SEAFOOD MEAL</option>
                                        <option value="SPML">SPML - SPEC REQUEST</option>
                                        <option value="VGML">VGML - VEGAN Meal</option>
                                        <option value="VLML">VLML - VEG/LACTO-OVO</option>
                                    </select>
                                </div>
                                <div class="pnr-form-row" style="text-align:right;">
                                    <button type="submit" class="pnr-btn">Add Meal Request</button>
                                </div>
                            </form>
                        `;
                    }
					
					
                    document.addEventListener('change', function (e) {
					  if (!e.target.matches('#pnr-add-wheelchair-form #pnr-wheelchair-passenger')) return;

					  const form = e.target.closest('form');
					  if (!form) return;

					  // Use the hidden input inside THIS form
					  const hiddenFullname = form.querySelector('input[name="pax_fullname"]');
					  if (!hiddenFullname) return;

					  const opt = e.target.selectedOptions && e.target.selectedOptions[0];
					  const label = opt ? opt.text.trim() : '';

					  hiddenFullname.value = (label === 'Select Passenger') ? '' : label;
					});


                    function renderWheelchairFormAndTable(wcSSRs, passengers, itineraries) {
                        const headers = [
                            'Type', 'Status', 'Qty', 'Airline', 'Free Text',
                            'Passenger', 'Flight Segment'
                        ];
const pnrs = <?php echo json_encode($pnrs); ?>;
						console.log(' All PNRs:', pnrs);

						const currentIndex = 0; // Or dynamically choose
						const pnrObj = pnrs[currentIndex] || {};
						const currentPNR = pnrObj.pnr || null;
						const filteredPassengers = (passengers || []).filter(p => {
							const amadeusFirstName = (p.firstName || '').trim().toLowerCase();
							const amadeusSurname = (p.surname || '').trim().toLowerCase();
							const amadeusDob = (p.dob || '').trim();

							const matched = (pnrObj.pax || []).some(localPax => {
								const localFullName = `${(localPax.fname || '').trim()} ${(localPax.salutation || '').trim()}`.toLowerCase();
								const localSurname = (localPax.lname || '').trim().toLowerCase();
								const localDob = (localPax.dob || '').trim();

								const isMatch = (
									amadeusFirstName === localFullName &&
									amadeusSurname === localSurname
									// && amadeusDob === localDob // Optional check
								);

								if (isMatch) {
									console.log(` Matched Amadeus Pax: ${p.firstName} ${p.surname}`);
								}
								return isMatch;
							});

							return matched;
						});
						
const passengerOptions = filteredPassengers.map(pxv => {
						const label = `${pxv.surname} ${pxv.firstName} (${pxv.type})`;
						return `<option value="${pxv.reference}">${escapeHTML(label)}</option>`;
					}).join('');	
					
                        const rows = wcSSRs
							.filter(ssr => {
								const pax = filteredPassengers.find(p => String(p.reference) === String(ssr.paxRef));
								if (!pax) {
									console.log(` SSR Skipped (no matching passenger):`, ssr);
								}
								return !!pax;
							})
							.map(ssr => {
								const pax = filteredPassengers.find(p => String(p.reference) === String(ssr.paxRef));
								const paxName = pax
									? `${pax.surname} ${pax.firstName} (${pax.type})`
									: ssr.paxRef || '';

								const seg = itineraries.find(i => String(i.segmentReference) === String(ssr.segmentRef));
								const segInfo = seg
									? `${seg.airline} ${seg.flightNumber} (${seg.departureCity}${seg.arrivalCity} ${seg.departureDate})`
									: ssr.segmentRef || '';

								const row = {
									'Type': ssr.type,
									'Status': ssr.status,
									'Qty': ssr.quantity,
									'Airline': ssr.airline,
									'Free Text': ssr.freeText,
									'Passenger': paxName,
									'Flight Segment': segInfo
								};

								console.log(' Meal Row:', row);
								return row;
							});
							
                        return `
                                ${renderTable(headers, rows)}
                    
                            <form id="pnr-add-wheelchair-form" onsubmit="submitAddWheelchairForm(event)" style="margin-bottom:24px;">
                                <div id="pnr-wheelchair-form-error" class="pnr-error" style="display:none;"></div>
                                <div id="pnr-wheelchair-form-spinner" style="display:none;text-align:center;margin-bottom:10px;">
                                    <span class="pnr-spinner" style="display:inline-block;width:28px;height:28px;border:4px solid #90caf9;border-top:4px solid #1976d2;border-radius:50%;animation:spin 1s linear infinite;"></span>
                                </div>
                                <div class="pnr-form-row">
                                    <label>Passenger</label>
                                    <select name="passenger" id="pnr-wheelchair-passenger" required>
                                        <option value="">Select Passenger</option>
										${passengerOptions}
                                    </select>
									<input type="hidden" name="segment" id="pnr-wheelchair-segment" value="">
									<input type="hidden" name="pax_fullname" id="pnr-fullname" value="">
                                </div>
                                
                                <div class="pnr-form-row">
                                    <label>Wheelchair Type</label>
                                    <select name="wheelchairType" id="pnr-wheelchair-type" required>
                                        <option value="">Select Wheelchair Type</option>
                                        <option value="WCBW" disabled>WCBW - Wheelchair - wet cell battery</option>
                                        <option value="WCHC" disabled>WCHC - Wheelchair - all the way to seat</option>
                                        <option value="WCHR">WCHR - Wheelchair - for ramp</option>
                                        <option value="WCHS" disabled>WCHS - Wheelchair - up and down steps</option>
                                        <option value="WCMP" disabled>WCMP - Wheelchair - on board</option>
                                    </select>
                                </div>
                                <div class="pnr-form-row" style="text-align:right;">
                                    <button type="submit" class="pnr-btn">Add Wheelchair Request</button>
                                </div>
                            </form>
                        `;
                    }


                    
                    function renderSSRWithRefs(ssrs, passengers, itineraries) {
                        if (!ssrs || !ssrs.length) return '';
                        const headers = [
                            'Type', 'Status', 'Qty', 'Airline', 'Free Text',
                            'Passenger', 'Flight Segment'
                        ];
                        const rows = ssrs.map(ssr => {
                            // Find passenger
                            const pax = passengers.find(p => String(p.reference) === String(ssr.paxRef));
                            const paxName = pax ? `${pax.surname} ${pax.firstName} (${pax.type})` : ssr.paxRef || '';
                            // Find segment
                            const seg = itineraries.find(i => String(i.segmentReference) === String(ssr.segmentRef));
                            const segInfo = seg
                                ? `${seg.airline} ${seg.flightNumber} (${seg.departureCity}${seg.arrivalCity} ${seg.departureDate})`
                                : ssr.segmentRef || '';
                            return {
                                'Type': ssr.type,
                                'Status': ssr.status,
                                'Qty': ssr.quantity,
                                'Airline': ssr.airline,
                                'Free Text': ssr.freeText,
                                'Passenger': paxName,
                                'Flight Segment': segInfo
                            };
                        });
                        return renderTable(headers, rows);
                    }
                    
                    function renderSeatSSRTable(seatSSRs, passengers, itineraries) {
                        const headers = [
                            'Type', 'Status', 'Qty', 'Airline', 'Passenger', 'Flight Segment', 'Seat Number', 'Seat Type(s)'
                        ];
                        const rows = seatSSRs.map(ssr => {
                            const pax = passengers.find(p => String(p.reference) === String(ssr.paxRef));
                            const paxName = pax ? `${pax.surname} ${pax.firstName} (${pax.type})` : ssr.paxRef || '';
                            const seg = itineraries.find(i => String(i.segmentReference) === String(ssr.segmentRef));
                            const segInfo = seg
                                ? `${seg.airline} ${seg.flightNumber} (${seg.departureCity}${seg.arrivalCity} ${seg.departureDate})`
                                : ssr.segmentRef || '';
                            let seatNum = '';
                            let seatTypes = '';
                            if (ssr.additionalInfo) {
                                if (Array.isArray(ssr.additionalInfo.seatNum)) {
                                    seatNum = ssr.additionalInfo.seatNum.join(', ');
                                } else if (ssr.additionalInfo.seatNum) {
                                    seatNum = ssr.additionalInfo.seatNum;
                                }
                                if (Array.isArray(ssr.additionalInfo.seatTypes)) {
                                    seatTypes = ssr.additionalInfo.seatTypes.join(', ');
                                } else if (ssr.additionalInfo.seatTypes) {
                                    seatTypes = ssr.additionalInfo.seatTypes;
                                }
                            }
                            return {
                                'Type': ssr.type,
                                'Status': ssr.status,
                                'Qty': ssr.quantity,
                                'Airline': ssr.airline,
                                'Passenger': paxName,
                                'Flight Segment': segInfo,
                                'Seat Number': seatNum,
                                'Seat Type(s)': seatTypes
                            };
                        });
                        return renderTable(headers, rows) + `
                            <form id="pnr-add-seat-form" onsubmit="submitAddSeatForm(event)" style="margin-bottom:24px;">
                                <div id="pnr-seat-form-error" class="pnr-error" style="display:none;"></div>
                                <div id="pnr-seat-form-spinner" style="display:none;text-align:center;margin-bottom:10px;">
                                    <span class="pnr-spinner" style="display:inline-block;width:28px;height:28px;border:4px solid #90caf9;border-top:4px solid #1976d2;border-radius:50%;animation:spin 1s linear infinite;"></span>
                                </div>
                                <div class="pnr-form-row">
                                    <label>Passenger</label>
                                    <select name="passenger" id="pnr-seat-passenger" required>
                                        <option value="">Select Passenger</option>
                                    </select>
                                </div>
                                <div class="pnr-form-row">
                                    <label>Flight Segment</label>
                                    <select name="segment" id="pnr-seat-segment" required>
                                        <option value="">Select Segment</option>
                                    </select>
                                </div>
                                <div class="pnr-form-row">
                                    <label>Seat Type(s)</label>
                                    <input type="text" name="seatTypes" id="seatTypes" placeholder="e.g. W, N" />
                                </div>
                                <div class="pnr-form-row" style="text-align:right;">
                                    <button type="submit" class="pnr-btn">Add Seat Request</button>
                                </div>
                            </form>
                        `;
                    }
                    
                    function renderFQTVTable(ffSSRs, passengers) {
                        const headers = ['Type','Status','Airline','FF Number','Passenger'];
                        const rows = ffSSRs.map(ssr => {
                            const pax = passengers.find(p => String(p.reference) === String(ssr.paxRef));
                            const paxName = pax ? `${pax.surname} ${pax.firstName} (${pax.type})` : ssr.paxRef || '';
                            return {
                                'Type': ssr.type,
                                'Status': ssr.status,
                                'Airline': ssr.airline,
                                'FF Number': ssr.additionalInfo.ffNum || '',
                                'Passenger': paxName
                            };
                        });
                        return renderTable(headers, rows) + `
                            <form id="pnr-add-fq-form" onsubmit="submitAddFQForm(event)" style="margin-bottom:24px;">
                                <div id="pnr-fq-form-error" class="pnr-error" style="display:none;"></div>
                                <div id="pnr-fq-form-spinner" style="display:none;text-align:center;margin-bottom:10px;">
                                    <span class="pnr-spinner" style="display:inline-block;width:28px;height:28px;border:4px solid #90caf9;border-top:4px solid #1976d2;border-radius:50%;animation:spin 1s linear infinite;"></span>
                                </div>
                                <div class="pnr-form-row">
                                    <label>Passenger</label>
                                    <select name="passenger" id="pnr-fq-passenger" required>
                                        <option value="">Select Passenger</option>
                                    </select>
                                </div>
                                <div class="pnr-form-row">
                                    <label>Airline</label>
                                    <select name="airline" id="pnr-fq-airline" required>
                                        <option value="">Select Airline</option>
                                    </select>
                                </div>
                                <div class="pnr-form-row">
                                    <label>Frequent Flyer #</label>
                                    <input type="text" name="ffNumber" id="pnr-fq-number" required />
                                </div>
                                <div class="pnr-form-row" style="text-align:right;">
                                    <button type="submit" class="pnr-btn">Add Frequent Flyer</button>
                                </div>
                            </form>
                        `;
                    }
                    
                    function formatTime(timeStr) {
                        if (!timeStr || typeof timeStr !== 'string' || timeStr.length < 3) return timeStr;
                        let t = timeStr.padStart(4, '0');
                        return t.slice(0,2) + ':' + t.slice(2,4);
                    }
                    
                    function showTab(tab) {
                        document.querySelectorAll('.pnr-tab').forEach(btn => btn.classList.remove('active'));
                        document.querySelectorAll('.pnr-tab-content').forEach(div => div.classList.remove('active'));
                        document.getElementById('pnr-tab-btn-' + tab).classList.add('active');
                        document.getElementById('pnr-tab-content-' + tab).classList.add('active');
                    }
                    function submitAddDocForm(e) {
						const pnrs = <?php echo json_encode($pnrs) ?>;
                        e.preventDefault();
                        var form = e.target;
                        var formData = new FormData(form);
                        var data = {};
                        formData.forEach((value, key) => {
                            data[key] = value;
                        });
                        // Show spinner, hide error
                        var spinner = document.getElementById('pnr-doc-form-spinner');
                        var errorDiv = document.getElementById('pnr-doc-form-error');
                        if (spinner) spinner.style.display = '';
                        if (errorDiv) { errorDiv.style.display = 'none'; errorDiv.textContent = ''; }
                        // Convert date fields to DDMMMYY
                        function toDDMMMYY(dateStr) {
                            if (!dateStr) return '';
                            var d = new Date(dateStr);
                            if (isNaN(d)) return dateStr;
                            var day = String(d.getDate()).padStart(2, '0');
                            var month = d.toLocaleString('en-US', { month: 'short' }).toUpperCase();
                            var year = d.getFullYear();
                            var yy = String(year).slice(-2);
                            return day + month + yy;
                        }
                        data.dob_formatted = toDDMMMYY(data.dob);
                        data.expiry_formatted = toDDMMMYY(data.expiry);
                        // Get passenger surname and firstname
                        var pax = (window._pnrPassengers || []).find(p => String(p.reference) === String(data.passenger));
                        if (pax) {
                            data.surname = pax.surname;
                            data.firstname = pax.firstName;
                        }
                        
                        const params = {
                            sessionId: window._sessionId,
                            securityToken: window._securityToken,
                            nationality: data.nationality,
                            idNum: data.passport,
                            dob: data.dob_formatted,
                            gender: data.gender,
                            expiry: data.expiry_formatted,
                            surname: data.surname,
                            firstname: data.firstname,
                            paxNum: data.passenger,
                            order_id: <?= json_encode($order_id_api) ?>,
							officeID: pnrs[0].gds_id,
                            added_by: <?= json_encode($currnt_userlogn) ?>
                        }
                        
                        const formBody = Object.entries(params)
                        .map(([key, value]) => encodeURIComponent(key) + '=' + encodeURIComponent(value))
                        .join('&');
                    
                        fetch('https://gauratravel.com.au/wp-content/themes/twentytwenty/templates/amadeus_api/pnr_add_passport.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: formBody
                        })
                        .then(response => response.json()
                        )
                        .then(data => {
                            console.log(data)
                            if (spinner) spinner.style.display = 'none';
                            if (!data.success) throw new Error(data.errorMessage);
                            handleSSRClick(); // Refresh the table after successful addition
                            showTab("docs");
                        })
                        .catch(error => {
                            if (spinner) spinner.style.display = 'none';
                            if (errorDiv) {
                                errorDiv.textContent = error.message || 'Error adding document.';
                                errorDiv.style.display = '';
                            }
                            console.error('Error:', error);
                        });
                    }
    
                    function submitAddMealForm(e) {
                        e.preventDefault();
                        var form = e.target;
                        var formData = new FormData(form);
                        var data = {};
                        formData.forEach((value, key) => {
                            data[key] = value;
                        });
                        // Show spinner, hide error
                        var spinner = document.getElementById('pnr-meal-form-spinner');
                        var errorDiv = document.getElementById('pnr-meal-form-error');
                        if (spinner) spinner.style.display = '';
                        if (errorDiv) { errorDiv.style.display = 'none'; errorDiv.textContent = ''; }
                        // Get passenger surname and firstname
                        var pax = (window._pnrPassengers || []).find(p => String(p.reference) === String(data.passenger));
                        if (pax) {
                            data.surname = pax.surname;
                            data.firstname = pax.firstName;
                        }
                        // Get segment info
                        var seg = (window._pnrItineraries || []).find(i => String(i.segmentReference) === String(data.segment));
                        if (seg) {
                            data.segmentInfo = `${seg.airline} ${seg.flightNumber} (${seg.departureCity}${seg.arrivalCity} ${seg.departureDate})`;
                        }
                        
                        /*const params = {
                            sessionId: window._sessionId,
                            securityToken: window._securityToken,
                            paxNum: data.passenger,
                            flightSegmentNum: data.segment,
                            mealType: data.mealType,
                        }*/
						
						
                        const pnrs = <?php echo json_encode($pnrs) ?>;
						
                        const params = {
                            sessionId: window._sessionId,
                            securityToken: window._securityToken,
                            paxNum: data.passenger,
							pax_fullname: data.pax_fullname,
                            flightSegmentNum: data.segment,
                            mealType: data.mealType,
                            order_id: <?= json_encode($order_id_api) ?>,
							officeID: pnrs[0].gds_id,
                            added_by: <?= json_encode($currnt_userlogn) ?>
                        }

                        
                        const formBody = Object.entries(params)
                        .map(([key, value]) => encodeURIComponent(key) + '=' + encodeURIComponent(value))
                        .join('&');
                    
                        fetch('https://gauratravel.com.au/wp-content/themes/twentytwenty/templates/amadeus_api/pnr_add_meal.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: formBody
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (spinner) spinner.style.display = 'none';
                            if (!data.success) throw new Error(data.errorMessage);
                            handleSSRClick();
                            showTab('meal');
                        })
                        .catch(error => {
                            if (spinner) spinner.style.display = 'none';
                            if (errorDiv) {
                                errorDiv.textContent = error.message || 'Error adding meal request.';
                                errorDiv.style.display = '';
                            }
                            console.error('Error:', error);
                        });
                    }
                    
                    function submitAddSeatForm(e) {
                        e.preventDefault();
                        var form = e.target;
                        var formData = new FormData(form);
                        var data = {};
                        formData.forEach((value, key) => {
                            data[key] = value;
                        });
                        // Show spinner, hide error
                        var spinner = document.getElementById('pnr-seat-form-spinner');
                        var errorDiv = document.getElementById('pnr-seat-form-error');
                        if (spinner) spinner.style.display = '';
                        if (errorDiv) { errorDiv.style.display = 'none'; errorDiv.textContent = ''; }
                        // Get passenger surname and firstname
                        var pax = (window._pnrPassengers || []).find(p => String(p.reference) === String(data.passenger));
                        if (pax) {
                            data.surname = pax.surname;
                            data.firstname = pax.firstName;
                        }
                        // Get segment info
                        var seg = (window._pnrItineraries || []).find(i => String(i.segmentReference) === String(data.segment));
                        if (seg) {
                            data.segmentInfo = `${seg.airline} ${seg.flightNumber} (${seg.departureCity}${seg.arrivalCity} ${seg.departureDate})`;
                        }
                        
                        const params = {
                            sessionId: window._sessionId,
                            securityToken: window._securityToken,
                            paxNum: data.passenger,
                            flightSegmentNum: data.segment,
                            // seatNum: data.seatNum,
                            seatInfo: data.seatTypes,
                            order_id: <?= json_encode($order_id_api) ?>,
                            added_by: <?= json_encode($currnt_userlogn) ?>
                        }
                        
                        const formBody = Object.entries(params)
                        .map(([key, value]) => encodeURIComponent(key) + '=' + encodeURIComponent(value))
                        .join('&');
                    
                        fetch('https://gauratravel.com.au/wp-content/themes/twentytwenty/templates/amadeus_api/pnr_add_seat_request.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: formBody
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (spinner) spinner.style.display = 'none';
                            if (!data.success) throw new Error(data.errorMessage);
                            handleSSRClick();
                            showTab('seat');
                        })
                        .catch(error => {
                            if (spinner) spinner.style.display = 'none';
                            if (errorDiv) {
                                errorDiv.textContent = error.message || 'Error adding seat request.';
                                errorDiv.style.display = '';
                            }
                            console.error('Error:', error);
                        });
                    }
                    
                    function submitAddFQForm(e) {
						const pnrs = <?php echo json_encode($pnrs) ?>;
                        e.preventDefault();
                        var form = e.target;
                        var formData = new FormData(form);
                        var data = {};
                        formData.forEach((value,key)=>{data[key]=value;});
                        var spinner = document.getElementById('pnr-fq-form-spinner');
                        var errorDiv = document.getElementById('pnr-fq-form-error');
                        if (spinner) spinner.style.display='';
                        if (errorDiv){errorDiv.style.display='none';errorDiv.textContent='';}
                        const params = {
                            sessionId: window._sessionId,
                            securityToken: window._securityToken,
                            paxNum: data.passenger,
                            airlineCode: data.airline,
                            frequentFlyerNum: data.ffNumber,
                            order_id: <?= json_encode($order_id_api) ?>,
							officeID: pnrs[0].gds_id,
                            added_by: <?= json_encode($currnt_userlogn) ?>
                        };
                        const formBody = Object.entries(params).map(([k,v])=>encodeURIComponent(k)+'='+encodeURIComponent(v)).join('&');
                        fetch('https://gauratravel.com.au/wp-content/themes/twentytwenty/templates/amadeus_api/pnr_add_frequent_flyer_number.php',{
                            method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:formBody
                        }).then(r=>r.json()).then(d=>{
                            if (spinner) spinner.style.display='none';
                            if(!d.success) throw new Error(d.errorMessage);
                            handleSSRClick();
                            showTab('fq');
                        }).catch(err=>{
                            if (spinner) spinner.style.display='none';
                            if (errorDiv){errorDiv.textContent=err.message||'Error adding frequent flyer.';errorDiv.style.display='';}
                            console.error(err);
                        });
                    }

                    function submitAddWheelchairForm(e) {
                        e.preventDefault();
                        var form = e.target;
                        var formData = new FormData(form);
                        var data = {};
                        formData.forEach((value, key) => {
                            data[key] = value;
                        });
                        // Show spinner, hide error
                        var spinner = document.getElementById('pnr-wheelchair-form-spinner');
                        var errorDiv = document.getElementById('pnr-wheelchair-form-error');
                        if (spinner) spinner.style.display = '';
                        if (errorDiv) { errorDiv.style.display = 'none'; errorDiv.textContent = ''; }
                        // Get passenger surname and firstname
                        var pax = (window._pnrPassengers || []).find(p => String(p.reference) === String(data.passenger));
                        if (pax) {
                            data.surname = pax.surname;
                            data.firstname = pax.firstName;
                        }
                        // Get segment info
                        var seg = (window._pnrItineraries || []).find(i => String(i.segmentReference) === String(data.segment));
                        if (seg) {
                            data.segmentInfo = `${seg.airline} ${seg.flightNumber} (${seg.departureCity}${seg.arrivalCity} ${seg.departureDate})`;
                        }
						const pnrs = <?php echo json_encode($pnrs) ?>;
                        const params = {
                            sessionId: window._sessionId,
                            securityToken: window._securityToken,
                            paxNum: data.passenger,
							pax_fullname: data.pax_fullname,
                            flightSegmentNum: data.segment,
                            mealType: data.wheelchairType,
                            order_id: <?= json_encode($order_id_api) ?>,
							officeID: pnrs[0].gds_id,
                            added_by: <?= json_encode($currnt_userlogn) ?>
                        };
                        const formBody = Object.entries(params)
                            .map(([key, value]) => encodeURIComponent(key) + '=' + encodeURIComponent(value))
                            .join('&');
                        fetch('https://gauratravel.com.au/wp-content/themes/twentytwenty/templates/amadeus_api/pnr_add_meal.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: formBody
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (spinner) spinner.style.display = 'none';
                            if (!data.success) throw new Error(data.errorMessage);
                            handleSSRClick();
                            showTab('wheelchair');
                        })
                        .catch(error => {
                            if (spinner) spinner.style.display = 'none';
                            if (errorDiv) {
                                errorDiv.textContent = error.message || 'Error adding wheelchair request.';
                                errorDiv.style.display = '';
                            }
                            console.error('Error:', error);
                        });
                    }
				
				function prefillPaxForm(refId) {
	const select = document.getElementById(`paxSelect-${refId}`);
	const paxData = JSON.parse(document.getElementById(`paxData-${refId}`).value || '[]');
	const selectedOption = select.options[select.selectedIndex];
	const index = selectedOption.getAttribute('data-index');
	if (index === null || !paxData[index]) return;

	const pax = paxData[index];

	document.getElementById(`firstName-${refId}`).value = pax.fname || '';
	document.getElementById(`surname-${refId}`).value = pax.lname || '';
	document.getElementById(`title-${refId}`).value = pax.salutation ? pax.salutation.toUpperCase() : '';
	document.getElementById(`dob-${refId}`).value = pax.dob || '';
	document.getElementById(`pax_auto_id-${refId}`).value = pax.auto_id || '';
}

				
				
				
				
				
				
				
				
				
				// name update / name add start
				// Pax Name Update
				function handlePaxNameUpdateClick() {
						console.log('handlePaxNameUpdateClick');
						const pnrs = <?php echo json_encode($pnrs); ?>;
						document.getElementById('paxNameUpdate').innerHTML = 'Loading all PNRs...';

						let htmlOutput = '';
						let currentIndex = 0;

						const processNextPnr = () => {
							if (currentIndex >= pnrs.length) {
								document.getElementById('paxNameUpdate').innerHTML = htmlOutput;

								setTimeout(() => {
									toggleInfantForm();

									if (window.flatpickr) {
										flatpickr("input[name='dob']", { dateFormat: "Y-m-d", maxDate: 'today' });
										flatpickr("input[name='expiry']", { dateFormat: "Y-m-d", minDate: new Date().fp_incr(180) });
									}
								}, 0);

								return;
							}

							const pnrObj = pnrs[currentIndex];
							const pnr = pnrObj.pnr;
							const officeId = pnrObj.gds_id || "MELA828FN";

							const makeRequest = (currentOfficeId, isRetry = false) => {
								return fetch(`https://gauratravel.com.au/wp-content/themes/twentytwenty/templates/amadeus_api/pnr_retrieve_fit.php?pnr=${encodeURIComponent(pnr)}&officeId=${encodeURIComponent(currentOfficeId)}`)
									.then(r => r.json())
									.then(data => {
										if (!data.success) {
											if (!isRetry && currentOfficeId !== "MELA828FN") {
												return makeRequest("MELA828FN", true);
											} else {
												htmlOutput += `<div class="pnr-error">PNR ${pnr}: Error - ${escapeHTML(data.error || 'Unknown error')}</div>`;
												currentIndex++;
												processNextPnr();
												return;
											}
										}
										return data;
									})
									.catch(e => {
										if (!isRetry && currentOfficeId !== "MELA828FN") {
											return makeRequest("MELA828FN", true);
										} else {
											htmlOutput += `<div class="pnr-error">PNR ${pnr}: Fetch Error - ${escapeHTML(e.message)}</div>`;
											currentIndex++;
											processNextPnr();
											return;
										}
									});
							};

							makeRequest(officeId).then(data => {
								if (!data) return;
								
								const sessionRetrieve = data.session.sessionId;
								const securityTokenRetrieve = data.session.securityToken;

								const passengers = data.passengers || [];
								const refId = `pnr-${pnr}`;

								htmlOutput += `<div class="pnr-block"><h3>PNR: ${pnr}</h3>`;

								if (passengers.length > 0) {
	// Get matching pax array from current pnr object
	const matchingPaxArray = pnrObj.pax || [];

		// Filter Amadeus passengers against matching pax list
	const filteredPassengers = passengers.filter(p => {
		const amadeusFirstName = (p.firstName || '').trim().toLowerCase();
		const amadeusSurname = (p.surname || '').trim().toLowerCase();
		const amadeusDob = (p.dob || '').trim();

		return (pnrObj.pax || []).some(localPax => {
			const localFullName = `${localPax.fname || ''} ${localPax.salutation || ''}`.trim().toLowerCase();
			const localSurname = (localPax.lname || '').trim().toLowerCase();
			const localDob = (localPax.dob || '').trim();

			return (
				amadeusFirstName === localFullName &&
				amadeusSurname === localSurname &&
				amadeusDob === localDob
			);
		});
	});


	if (filteredPassengers.length > 0) {
		htmlOutput += renderSection(
			'Passengers',
			renderTable(
				['Ref', 'Surname', 'First Name', 'Type', 'With Infant?', 'Title'],
				filteredPassengers.map(p => ({
					'Ref': p.reference,
					'Surname': p.surname,
					'First Name': p.firstName,
					'Type': p.type,
					'DOB': p.dob,
					'With Infant?': p.infantIndicator === 0 ? 'No' : 'Yes',
					'Title': p.title,
				}))
			)
		);
	} else {
		htmlOutput += `<p>No matching passengers</p>`;
	}
}



								const paxOptions = (pnrObj.pax || []).map((p, i) => `
						<option data-index="${i}">${p.fname} ${p.lname} (DOB: ${p.dob})</option>
					`).join('');

					const paxDataJSON = escapeHTML(JSON.stringify(pnrObj.pax || []));

					htmlOutput += `
	<button class="pnr-toggle-btn" data-ref="${refId}" onclick="toggleAddPassengerForm('${refId}')">Add New Passenger</button>

	<div id="addPassengerFormContainer-${refId}" class="pnr-toggle-form" style="display:none;">
		<form class="pnr-add-passenger-form" onsubmit="submitAddPassengerForm(event, '${pnr}', '${officeId}', '${refId}')">

			<!-- Dropdown to select existing pax -->
			<div class="pnr-form-row">
				<label for="paxSelect-${refId}">Select Existing Passenger</label>
				<select id="paxSelect-${refId}" onchange="prefillPaxForm('${refId}')">
					<option value="">-- Select Passenger --</option>
					${(pnrObj.pax || []).map((p, i) =>
						`<option data-index="${i}">${p.salutation || ''} ${p.fname} ${p.lname} (DOB: ${p.dob}) - (PaxID: ${p.auto_id})</option>`
					).join('')}
				</select>
			</div>
			<div class="pnr-form-row">
				<label for="paxType-${refId}">Select Passenger Type</label>
				<select id="paxType-${refId}" required>
					<option value="" selected disabled>-- Select Type --</option>
						<option value="ADT">Adult</option>
						<option value="CHD">Child</option>
				</select>
			</div>
			
			<input type="hidden" id="paxData-${refId}" value='${escapeHTML(JSON.stringify(pnrObj.pax || []))}' />
			<input type="hidden" name="session" id="session-${refId}" value="${sessionRetrieve}" required />
			<input type="hidden" name="token" id="token-${refId}" value="${securityTokenRetrieve}" required />

			<table class="pnr-passenger-table" style="width:100%; border-collapse:collapse; margin-bottom:20px;">
	<!-- Surname Row -->
	<tr>
		<td style="padding: 10px;">
			<label for="surname-${refId}">Original Surname</label><br>
			<input type="text" id="surname-${refId}" readonly style="width: 100%;" />
		</td>
		<td style="padding: 10px;">
			<label for="customSurname-${refId}">Modified Surname (optional)</label><br>
			<input type="text" name="customSurname" id="customSurname-${refId}" style="width: 100%;" />
		</td>
	</tr>

	<!-- First Name Row -->
	<tr>
		<td style="padding: 10px;">
			<label for="firstName-${refId}">Original First Name</label><br>
			<input type="text" id="firstName-${refId}" readonly style="width: 100%;" />
		</td>
		<td style="padding: 10px;">
			<label for="customFirstName-${refId}">Modified First Name (optional)</label><br>
			<input type="text" name="customFirstName" id="customFirstName-${refId}" style="width: 100%;" />
		</td>
	</tr>

	<!-- Title Row -->
	<tr>
		<td style="padding: 10px;">
			<label for="title-${refId}">Original Title</label><br>
			<input type="text" id="title-${refId}" readonly style="width: 100%;" />
		</td>
		<td style="padding: 10px;">
			<label for="customTitle-${refId}">Modified Title (optional)</label><br>
			<select name="customTitle" id="customTitle-${refId}" style="width: 100%;">
				<option value="">Select Title</option>
				<option value="MR">Mr</option>
				<option value="MRS">Mrs</option>
				<option value="MS">Ms</option>
				<option value="MSTR">Master</option>
				<option value="MISS">Miss</option>
			</select>
		</td>
	</tr>

	<!-- First Name Row -->
	<tr>
		<td style="padding: 10px;">
			<label for="dob-${refId}">Original DOB</label><br>
			<input type="text" id="dob-${refId}" readonly style="width: 100%;" />
			<input type="hidden" id="pax_auto_id-${refId}" readonly style="width: 100%;" />
		</td>
		<td style="padding: 10px;">
			<label for="customFirstName-${refId}">Modified DOB (optional)</label><br>
			<input type="text" name="customDob" id="customDob-${refId}" style="width: 100%;" />
		
		</td>
	</tr>
</table>


			<div class="pnr-checkbox-row">
				<input type="checkbox" id="hasInfant-${refId}" name="hasInfant" onchange="toggleInfantForm('${refId}')">
				<label for="hasInfant-${refId}">Add Infant</label>
			</div>
			<div id="infantForm-${refId}" class="pnr-infant-form" style="display:nofne;">
				<div class="pnr-form-row">
					<label for="infantSurname-${refId}">Infant Surname</label>
					<input type="text" name="infantSurname" id="infantSurname-${refId}" />
				</div>
				<div class="pnr-form-row">
					<label for="infantFirstName-${refId}">Infant First Name</label>
					<input type="text" name="infantFirstName" id="infantFirstName-${refId}" />
				</div>
				<div class="pnr-form-row">
					<label for="infantDob-${refId}">Infant DOB</label>
					<input type="text" name="infantDob" id="infantDob-${refId}" />
				</div>
				<div class="pnr-form-row">
					<label for="infantSalutation-${refId}">Infant Salutation</label>
					<input type="text" name="infantSalutation" id="infantSalutation-${refId}" />
				</div>
			</div>

			<div class="pnr-form-row" style="text-align:right;">
				<button type="submit" class="pnr-btn">Add Passenger</button>
			</div>
		</form>
	</div>
</div>`;



								currentIndex++;
								processNextPnr();
							});
						};

						processNextPnr();
					}



// Toggle visibility of "Add New Passenger" form for a specific PNR
function toggleAddPassengerForm(refId) {
	const formContainer = document.getElementById(`addPassengerFormContainer-${refId}`);
	const toggleBtn = document.querySelector(`button.pnr-toggle-btn[data-ref="${refId}"]`);

	if (!formContainer || !toggleBtn) return;

	const isVisible = formContainer.style.display === 'block';
	formContainer.style.display = isVisible ? 'none' : 'block';
	toggleBtn.textContent = isVisible ? 'Add New Passenger' : 'Hide Form';
}

// Function to toggle infant form visibility for a specific PNR
function toggleInfantForm(refId) {
	const checkbox = document.getElementById(`hasInfant-${refId}`);
	const infantForm = document.getElementById(`infantForm-${refId}`);
	if (!checkbox || !infantForm) return;

	checkbox.addEventListener('change', function () {
		infantForm.style.display = this.checked ? 'block' : 'none';
	});
}



		// Function to handle add passenger form submission
		function submitAddPassengerForm(e, pnr, officeId, refId) {
	e.preventDefault();

	const form = e.target;
	const spinner = document.getElementById('pnr-add-passenger-spinner');
	const errorDiv = document.getElementById('pnr-add-passenger-error');
	if (spinner) spinner.style.display = 'block';
	if (errorDiv) {
		errorDiv.style.display = 'none';
		errorDiv.textContent = '';
	}

	const formData = new FormData(form);

	// Use override values if provided, else fallback to readonly fields
	const firstName = formData.get('customFirstName')?.trim() || document.getElementById(`firstName-${refId}`).value.trim();
	const surname = formData.get('customSurname')?.trim() || document.getElementById(`surname-${refId}`).value.trim();
	const title = formData.get('customTitle')?.trim() || document.getElementById(`title-${refId}`).value.trim();
	const dob = formData.get('customDob')?.trim() || document.getElementById(`dob-${refId}`).value.trim();
	const pax_id_2 = document.getElementById(`pax_auto_id-${refId}`).value.trim();
	const pax_type_value = document.getElementById(`paxType-${refId}`).value.trim();
	

	const orderIDAPI = <?php echo json_encode($order_id_api); ?>;
	const agentLogin = <?php echo json_encode($currnt_userlogn); ?>;

	const data = {
		sessionId: formData.get('session'),
		securityToken: formData.get('token'),
		firstname: firstName,
		pax_id: pax_id_2,
		orderID: orderIDAPI,
		pnr: pnr,
		passengerType: pax_type_value,
		agent_name: agentLogin,
		surname: surname,
		dob: dob,
		title: title,
		hasInfant: false
	};

	if (formData.get('hasInfant') === 'on') {
		data.hasInfant = true;
		data.infantSurname = formData.get('infantSurname') || '';
		data.infantFirstname = formData.get('infantFirstName') || '';
		data.infantDob = formData.get('infantDob') || '';
		data.infantSalutation = formData.get('infantSalutation') || '';
	}

	const formBody = Object.entries(data)
		.map(([key, value]) => encodeURIComponent(key) + '=' + encodeURIComponent(value))
		.join('&');

	fetch('https://gauratravel.com.au/wp-content/themes/twentytwenty/templates/amadeus_api/pnr_add_passenger.php', {
		method: 'POST',
		headers: {
			'Content-Type': 'application/x-www-form-urlencoded'
		},
		body: formBody
	})
	.then(response => response.json())
	.then(result => {
		if (spinner) spinner.style.display = 'none';

		if (!result.success) throw new Error(result.errorMessage || 'Failed to add passenger');

		// Reset form
		form.reset();

		// Hide infant form manually
		const infantForm = document.getElementById(`infantForm-${refId}`);
		if (infantForm) infantForm.style.display = 'none';

		// Hide add passenger container
		const formContainer = document.getElementById(`addPassengerFormContainer-${refId}`);
		if (formContainer) formContainer.style.display = 'none';

		// Reset toggle button text
		const toggleBtn = document.querySelector(`.pnr-toggle-btn[data-ref="${refId}"]`);
		if (toggleBtn) toggleBtn.textContent = 'Add New Passenger';

		// Refresh PNR view
		handlePaxNameUpdateClick();
	})
	.catch(err => {
		if (spinner) spinner.style.display = 'none';
		if (errorDiv) {
			errorDiv.textContent = err.message || 'Error adding passenger.';
			errorDiv.style.display = 'block';
		}
		console.error(err);
	});
}

		// Function to handle edit name form submission (new version)
		function submitEditNameFormNew(e) {
			e.preventDefault();
			var form = e.target;
			var spinner = document.getElementById('pnr-edit-name-spinner');
			var errorDiv = document.getElementById('pnr-edit-name-error');
			if (spinner) spinner.style.display = '';
			if (errorDiv) { errorDiv.style.display = 'none'; errorDiv.textContent = ''; }
			
			var formData = new FormData(form);
			var paxRef = formData.get('passenger');
			var surname = formData.get('surname');
			var firstName = formData.get('firstName');
			
			// Check if passenger has infant
			const passenger = (window._pnrPassengers || []).find(p => String(p.reference) === String(paxRef));
			const hasInfant = passenger && passenger.infantIndicator && passenger.infantIndicator > 0;
			
			// First update the main passenger
			const params = {
				sessionId: window._sessionId,
				securityToken: window._securityToken,
				paxNum: paxRef,
				surname: surname,
				firstname: firstName,
				hasInfant: hasInfant
			};
			
			// Add infant data if passenger has infant
			if (hasInfant) {
				const infantSurname = formData.get('infantSurname');
				const infantFirstName = formData.get('infantFirstName');
				
				if (infantSurname && infantFirstName) {
					params.infantSurname = infantSurname;
					params.infantFirstname = infantFirstName;
				}
			}
			
			const formBody = Object.entries(params)
				.map(([key, value]) => encodeURIComponent(key) + '=' + encodeURIComponent(value))
				.join('&');
			
			fetch('https://gauratravel.com.au/wp-content/themes/twentytwenty/templates/amadeus_api/pnr_nameupdate.php', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded'
				},
				body: formBody
			})
			.then(r => r.json())
			.then(d => {
				if (spinner) spinner.style.display = 'none';
				if (!d.success) throw new Error(d.errorMessage || 'Failed to update name');
				// Reset form
				form.reset();
				handlePaxNameUpdateClick();
			})
			.catch(err => {
				if (spinner) spinner.style.display = 'none';
				if (errorDiv) {
					errorDiv.textContent = err.message || 'Error updating name.';
					errorDiv.style.display = '';
				}
				console.error(err);
			});
		}

		// Function to populate edit form when passenger is selected
		function populateEditForm() {
			const select = document.getElementById('editPassengerSelect');
			const surnameInput = document.getElementById('editSurname');
			const firstNameInput = document.getElementById('editFirstName');
			const infantSection = document.getElementById('editInfantSection');
			const infantSurnameInput = document.getElementById('editInfantSurname');
			const infantFirstNameInput = document.getElementById('editInfantFirstName');
			
			if (!select || !surnameInput || !firstNameInput) return;
			
			const selectedPaxRef = select.value;
			if (!selectedPaxRef) {
				surnameInput.value = '';
				firstNameInput.value = '';
				if (infantSection) infantSection.style.display = 'none';
				if (infantSurnameInput) infantSurnameInput.value = '';
				if (infantFirstNameInput) infantFirstNameInput.value = '';
				return;
			}
			
			const passenger = (window._pnrPassengers || []).find(p => String(p.reference) === String(selectedPaxRef));
			if (passenger) {
				surnameInput.value = passenger.surname || '';
				firstNameInput.value = passenger.firstName || '';
				
				// Check if passenger has infant (infantIndicator > 0 means has infant)
				const hasInfant = passenger.infantIndicator && passenger.infantIndicator > 0;
				
				if (hasInfant && infantSection) {
					infantSection.style.display = 'block';
					// Find the infant passenger (usually the next passenger with type 'INF')
					const infantPassenger = (window._pnrPassengers || []).find(p => 
						p.type === 'INF' && parseInt(p.reference) === parseInt(selectedPaxRef)
					);
					
					if (infantPassenger) {
						if (infantSurnameInput) infantSurnameInput.value = infantPassenger.surname || '';
						if (infantFirstNameInput) infantFirstNameInput.value = infantPassenger.firstName || '';
					}
				} else {
					if (infantSection) infantSection.style.display = 'none';
					if (infantSurnameInput) infantSurnameInput.value = '';
					if (infantFirstNameInput) infantFirstNameInput.value = '';
				}
			}
		}
				
				</script>
				</br></br>
			
				<?php
				
		//echo '</div>';		

        
    }
    if(isset($_GET['option']) && $_GET['option']=='view-changelog')
    {
        $order_id = $_GET['order'];
        $divider_id = $_GET['log'];
        ?>
        <div class="view_bookings">
        <h5>History</h5>
        <table style="font-size:13px;">
        <?php
        $query_gds_change_history = "SELECT * FROM wpk4_backend_history_of_meta_changes where type_id='$order_id' AND divider_id='$divider_id'";
        $result_gds_change_history = mysqli_query($mysqli, $query_gds_change_history);
        while($row_gds_change_history = mysqli_fetch_assoc($result_gds_change_history))
        {
            if(preg_match('(Billing|Payments|Transaction|agent|conso|customer_id|New Payment ID|transaction_id)', $row_gds_change_history['meta_key']) === 0)
            {
            ?>	
            <tr>
                <td><?php echo $row_gds_change_history['meta_key']; ?></td>
                <td><?php echo $row_gds_change_history['meta_value']; ?></td>
            </tr>
            <?php 
            }
        }
        //if($currnt_userlogn == 'sriharshans')
        {
            
        				                $carrier_changelog = get_meta_from_history_of_updates_meta_changelog($order_id, "Flightlegs MarketingCarrier");
        				                $flight_number_changelog = get_meta_from_history_of_updates_meta_changelog($order_id, "Flightlegs FlNr");
        				                $departure_airport_changelog = get_meta_from_history_of_updates_meta_changelog($order_id, "Flightlegs DepApt");
        				                $destination_airport_changelog = get_meta_from_history_of_updates_meta_changelog($order_id, "Flightlegs DestApt");
        				                $departure_time_changelog = get_meta_from_history_of_updates_meta_changelog($order_id, "Flightlegs DepTime");
        				                $destination_time_changelog = get_meta_from_history_of_updates_meta_changelog($order_id, "Flightlegs DestTime");
        				                $flight_class_changelog = get_meta_from_history_of_updates_meta_changelog($order_id, "Flightlegs CosDescription");
        				                $flight_class_code_changelog = get_meta_from_history_of_updates_meta_changelog($order_id, "Flightlegs Class");
        				                $flight_elapsed_time_changelog = get_meta_from_history_of_updates_meta_changelog($order_id, "Flightlegs Elapsed");
        				                $flight_meals_changelog = get_meta_from_history_of_updates_meta_changelog($order_id, "Flightlegs Meal");
        				                $flight_departure_terminal_changelog = get_meta_from_history_of_updates_meta_changelog($order_id, "Flightlegs DepTerminal");
        				                $flight_destination_terminal_changelog = get_meta_from_history_of_updates_meta_changelog($order_id, "Flightlegs DestTerminal");
        				                
                                        
                                        $carrier_array_changelog = explode(' | ', $carrier_changelog);
                                        $flight_number_array_changelog = explode(' | ', $flight_number_changelog);
                                        $departure_airport_array_changelog = explode(' | ', $departure_airport_changelog);
                                        $destination_airport_array_changelog = explode(' | ', $destination_airport_changelog);
                                        $departure_time_array_changelog = explode(' | ', $departure_time_changelog);
                                        $destination_time_array_changelog = explode(' | ', $destination_time_changelog);
                                        $flight_class_array_changelog = explode(' | ', $flight_class_changelog);
                                        $flight_class_code_array_changelog = explode(' | ', $flight_class_code_changelog);
                                        $flight_elapsed_time_array_changelog = explode(' | ', $flight_elapsed_time_changelog);
                                        $flight_meals_array_changelog = explode(' | ', $flight_meals_changelog);
                                        $flight_departure_terminal_array_changelog = explode(' | ', $flight_departure_terminal_changelog);
                                        $flight_destination_terminal_array_changelog = explode(' | ', $flight_destination_terminal_changelog);
                                        
                                        $combined_array_2 = array();
                                        for ($i = 0; $i < count($carrier_array_changelog); $i++) {
                                            $combined_array_2[] = array(
                                                'carrier' => $carrier_array_changelog[$i],
                                                'flightnumber' => $flight_number_array_changelog[$i],
                                                'departureairport' => $departure_airport_array_changelog[$i],
                                                'destinationairport' => $destination_airport_array_changelog[$i],
                                                'departuretime' => $departure_time_array_changelog[$i],
                                                'destinationtime' => $destination_time_array_changelog[$i],
                                                'flightclass' => $flight_class_array_changelog[$i],
                                                'flightclasscode' => $flight_class_code_array_changelog[$i],
                                                'flightelapedtime' => $flight_elapsed_time_array_changelog[$i],
                                                'flightdepartureterminal' => $flight_departure_terminal_array_changelog[$i],
                                                'flightdestinationterminal' => $flight_destination_terminal_array_changelog[$i],
                                                'flightmeals' => $flight_meals_array_changelog[$i]
                                            );
                                        }
                                        
                                        echo '<table cellpadding="0" cellspacing="0" style="width:100%; text-align:left; border: 1px solid #e1e1e; border-collapse: collapse; margin:10px 0px 10px 0px; font-size:14px;">';
                                        echo '<tr><th width="10%">Dep Airport</th><th width="15%">Dep Date</th><th width="10%">Flight</th><th width="10%">Dest Airport</th><th width="15%">Destination Time</th><th width="10%">Class</th><th width="10%">Meal</th><th width="10%">Duration</th></tr>';
                                        $waitTime = '';
                                        $waitHours = '';
                                        $previousDepTime = null;

                                        foreach ($combined_array_2 as $index => $item_changelog) {
                                            $totalMinutes = (int)$item_changelog['flightelapedtime'] * 60;
                                            $hours = floor($totalMinutes / 60);
                                            $minutes = $totalMinutes % 60;
                                            $timeFormatted = sprintf("%dh %dmin", $hours, $minutes);
                                            if ($index > 0) {
                                                $currentDepTime = strtotime($item_changelog['departuretime']);
                                                $previousDestTime = strtotime($combined_array_2[$index - 1]['destinationtime']);
                                                $waitTimeMinutes = round(($currentDepTime - $previousDestTime) / 60);
                                                $waitHours = floor($waitTimeMinutes / 60);
                                                $waitMinutes = $waitTimeMinutes % 60;
                                                $waitTime = sprintf("%dh %dmin", $waitHours, $waitMinutes);
                                            } else {
                                                $waitTime = '';
                                            }
                                            if ($waitTime !== '' && $waitHours < 24) {
                                                echo '<tr>';
                                                echo '<td colspan="7">WAIT: ' . $waitTime . '</td>';
                                                echo '</tr>';
                                            }
                                            if ($waitHours >= 24 && $waitTime !== '') {
                                                echo '</table></br><table cellpadding="0" cellspacing="0" style="width:100%; text-align:left; border: 1px solid #e1e1e; border-collapse: collapse; margin:10px 0px 10px 0px; font-size:14px;">
                                                <tr><th width="10%">Dep Airport</th><th width="15%">Dep Date</th><th width="10%">Flight</th><th width="10%">Dest Airport</th><th width="15%">Destination Time</th><th width="10%">Class</th><th width="10%">Meal</th><th width="10%">Duration</th></tr>';
                                            }
                                            echo '<tr>';
                                            echo '<td>' . $item_changelog['departureairport'] . '</br>' . $item_changelog['flightdepartureterminal'] . '</td>';
                                            echo '<td>' . $item_changelog['departuretime'] . '</td>';
                                            echo '<td>' . $item_changelog['carrier'] . $item_changelog['flightnumber'] . '</td>';
                                            echo '<td>' . $item_changelog['destinationairport'] . '</br>' . $item_changelog['flightdestinationterminal'] . '</td>';
                                            echo '<td>' . $item_changelog['destinationtime'] . '</td>';
                                            echo '<td>' . $item_changelog['flightclasscode'] . ' - ' . $item_changelog['flightclass'] . '</td>';
                                            echo '<td>' . $item_changelog['flightmeals'] . '</td>';
                                            echo '<td>' . $timeFormatted . '</td>'; // flight time
                                            echo '</tr>';
                                            $previousDepTime = strtotime($item_changelog['departuretime']);
                                        }
                                        echo '</table>';
        				                
        				            
        }
        ?>
        </table>
        </div><!-- END OF TAB CONTENT -->
        <?php
    }
}
else
{
    echo "<center>This page is not accessible for you.</center>";
}
?>
</div>
<?php get_footer(); ?>
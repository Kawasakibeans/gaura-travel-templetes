<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combined API Layer - Endpoint to Table Mapping</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }
        
        .endpoint-card {
            background: white;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .endpoint-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .endpoint-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .endpoint-header h2 {
            font-size: 1.4em;
            margin: 0;
            word-break: break-all;
        }
        
        .endpoint-method {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            white-space: nowrap;
        }
        
        .endpoint-content {
            padding: 30px;
            display: none;
        }
        
        .endpoint-content.active {
            display: block;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            color: #2c3e50;
            font-size: 1.3em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        .table-card {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .table-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2.5em;
            color: #3498db;
            font-weight: bold;
        }
        
        .stat-label {
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .search-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .search-box input {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            border: 2px solid #ecf0f1;
            border-radius: 5px;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 15px;
            background: #ecf0f1;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }
        
        .filter-btn:hover {
            background: #3498db;
            color: white;
        }
        
        .filter-btn.active {
            background: #3498db;
            color: white;
        }
        
        .mapping-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .mapping-table th {
            background: #34495e;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .mapping-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .mapping-table tr:hover {
            background: #f8f9fa;
        }
        
        .mapping-table tr:last-child td {
            border-bottom: none;
        }
        
        .db-column {
            font-family: 'Courier New', monospace;
            color: #e74c3c;
            font-weight: 600;
        }
        
        .json-param {
            font-family: 'Courier New', monospace;
            color: #27ae60;
            font-weight: 600;
        }
        
        .columns-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .column-badge {
            background: #3498db;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.9em;
            font-family: 'Courier New', monospace;
            text-align: center;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .code-snippet {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 5px;
            margin-top: 15px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.6;
            position: relative;
        }
        
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            color: #95a5a6;
            font-size: 0.9em;
        }
        
        .copy-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background 0.3s;
        }
        
        .copy-btn:hover {
            background: #2980b9;
        }
        
        .copy-btn.copied {
            background: #27ae60;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š Combined API Layer - Endpoint to Table Mapping</h1>
            <p>Complete mapping of endpoints to database tables for the current combined API layer</p>
            <p style="font-size: 0.9em; margin-top: 10px; color: #95a5a6;">Generated from routes/api.php</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-endpoints">-</div>
                <div class="stat-label">Total Endpoints</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-tables">-</div>
                <div class="stat-label">Database Tables</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-categories">-</div>
                <div class="stat-label">Categories</div>
            </div>
        </div>

        <div class="search-box">
            <input type="text" id="searchInput" placeholder="ðŸ” Search endpoints, tables, or methods...">
            <div class="filter-buttons" id="filterButtons">
                <button class="filter-btn active" data-filter="all">All</button>
            </div>
        </div>

        <div id="endpoints-container">
            <div class="loading">Loading endpoints data...</div>
        </div>
    </div>

    <script>
        let endpoints = [];
        let categories = {};

        // Base URL - update this to match your actual domain
        const BASE_URL = 'https://gt1.yourbestwayhome.com.au/wp-content/themes/twentytwenty/templates-3/database_api/public';

        // Load endpoints data from external JSON file
        fetch('endpoints_data.json')
            .then(response => response.text())
            .then(data => {
                try {
                    endpoints = JSON.parse(data);
                } catch(e) {
                    // Fallback: evaluate as JavaScript array
                    endpoints = eval('(' + data + ')');
                }
                initializeApp();
            })
            .catch(error => {
                console.error('Error loading endpoints data:', error);
                document.getElementById('endpoints-container').innerHTML = 
                    '<div style="padding: 20px; background: #ffebee; border: 2px solid #f44336; border-radius: 5px; margin: 20px;">' +
                    '<h3 style="color: #c62828;">Error Loading Data</h3>' +
                    '<p>Could not load endpoints_data.json. Please ensure the file exists in the same directory.</p>' +
                    '</div>';
            });

        function generateCurlCode(endpoint) {
            const method = endpoint.method || (endpoint.methods && endpoint.methods[0]) || 'GET';
            let path = endpoint.path;
            
            // Detect path parameters like {orderId}, {id}, etc.
            const pathParams = path.match(/\{(\w+)\}/g);
            let paramDeclarations = '';
            let urlConstruction = '';
            
            if (pathParams) {
                // Extract parameter names
                const paramNames = pathParams.map(p => p.replace(/[{}]/g, ''));
                
                // Add variable declarations at the top
                paramNames.forEach(paramName => {
                    paramDeclarations += `$${paramName} = '123'; // Replace with actual ${paramName} value\n`;
                });
                
                // Build URL with proper PHP string concatenation
                // Split path by parameters and reconstruct with concatenation
                let urlParts = [];
                let remainingPath = path;
                
                paramNames.forEach((paramName, index) => {
                    const paramPattern = `{${paramName}}`;
                    const paramIndex = remainingPath.indexOf(paramPattern);
                    
                    if (paramIndex > 0) {
                        // Add the part before the parameter
                        urlParts.push(`'${remainingPath.substring(0, paramIndex)}'`);
                    } else if (paramIndex === 0) {
                        // Parameter at the start
                        urlParts.push(`''`);
                    }
                    
                    // Add the parameter variable
                    urlParts.push(`$${paramName}`);
                    
                    // Update remaining path
                    remainingPath = remainingPath.substring(paramIndex + paramPattern.length);
                });
                
                // Add any remaining path after the last parameter
                if (remainingPath.length > 0) {
                    urlParts.push(`'${remainingPath}'`);
                }
                
                // Construct the full URL
                urlConstruction = `'${BASE_URL}' . ${urlParts.join(' . ')}`;
            } else {
                urlConstruction = `'${BASE_URL}${path}'`;
            }
            
            let curlCode = `<?php\n`;
            
            // Add parameter declarations if path has parameters
            if (pathParams) {
                curlCode += paramDeclarations + `\n`;
            }
            
            curlCode += `$curl = curl_init();\n`;
            curlCode += `curl_setopt_array($curl, array(\n`;
            curlCode += `  CURLOPT_URL => ${urlConstruction}`;
            
            // Add query parameters for GET requests
            if (method === 'GET' && endpoint.queryParams && endpoint.queryParams.length > 0) {
                const queryString = endpoint.queryParams.map(p => `${p}=value`).join('&');
                curlCode += ` . '?${queryString}'`;
            }
            curlCode += `,\n`;
            
            curlCode += `  CURLOPT_RETURNTRANSFER => true,\n`;
            curlCode += `  CURLOPT_ENCODING => '',\n`;
            curlCode += `  CURLOPT_MAXREDIRS => 10,\n`;
            curlCode += `  CURLOPT_TIMEOUT => 0,\n`;
            curlCode += `  CURLOPT_FOLLOWLOCATION => true,\n`;
            curlCode += `  CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,\n`;
            
            // Add method-specific options
            if (method === 'POST' || method === 'PUT' || method === 'PATCH') {
                curlCode += `  CURLOPT_CUSTOMREQUEST => '${method}',\n`;
                
                // Generate sample POST body as JSON string
                let postBody = {};
                if (endpoint.bodyParams && endpoint.bodyParams.length > 0) {
                    endpoint.bodyParams.forEach(param => {
                        postBody[param] = 'value';
                    });
                } else {
                    // Default sample body
                    postBody = { "example": "value" };
                }
                
                // Format as JSON string for PHP
                const bodyJson = JSON.stringify(postBody);
                curlCode += `  CURLOPT_POSTFIELDS => '${bodyJson.replace(/'/g, "\\'")}',\n`;
            } else if (method === 'DELETE') {
                curlCode += `  CURLOPT_CUSTOMREQUEST => 'DELETE',\n`;
            }
            
            curlCode += `  CURLOPT_HTTPHEADER => array(\n`;
            curlCode += `    'Content-Type: application/json'\n`;
            curlCode += `  ),\n`;
            curlCode += `));\n\n`;
            curlCode += `$response = curl_exec($curl);\n`;
            curlCode += `curl_close($curl);\n`;
            curlCode += `echo $response;`;
            
            return curlCode;
        }
        
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                button.classList.add('copied');
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    button.textContent = 'Copied!';
                    button.classList.add('copied');
                    setTimeout(() => {
                        button.textContent = 'Copy Code';
                        button.classList.remove('copied');
                    }, 2000);
                } catch (err) {
                    console.error('Fallback copy failed:', err);
                }
                document.body.removeChild(textArea);
            });
        }

        function renderQueryParamsDetails(endpoint) {
            const params = endpoint && Array.isArray(endpoint.query_params)
                ? endpoint.query_params
                : null;

            if (params && params.length > 0) {
                const rows = params.map(p => {
                    const name = p.name || '';
                    const type = p.type || '';
                    const desc = p.description || '';
                    const required = p.required === true ? 'Yes' : 'No';
                    return `
                        <tr>
                            <td><span class="json-param">${name}</span></td>
                            <td>${type}</td>
                            <td>${required}</td>
                            <td>${desc}</td>
                        </tr>
                    `;
                }).join('');

                return `
                    <div class="section">
                        <div class="section-title">Query Parameters Detail</div>
                        <p style="margin-bottom: 8px; color: #7f8c8d;">
                            Detailed description of query parameters.
                        </p>
                        <table class="mapping-table">
                            <thead>
                                <tr>
                                    <th>Parameter</th>
                                    <th>Type</th>
                                    <th>Required</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            return '';
        }

        function renderBodyDetails(endpoint, bodyExample) {
            // 1) Preferred: use explicit request_body_params (name, type, description) when available
            const params = endpoint && Array.isArray(endpoint.request_body_params)
                ? endpoint.request_body_params
                : null;

            if (params && params.length > 0) {
                const rows = params.map(p => {
                    const name = p.name || '';
                    const type = p.type || '';
                    const desc = p.description || '';
                    const required = p.required === true ? 'Yes' : 'No';
                    return `
                        <tr>
                            <td><span class="json-param">${name}</span></td>
                            <td>${type}</td>
                            <td>${required}</td>
                            <td>${desc}</td>
                        </tr>
                    `;
                }).join('');

                return `
                    <div class="section">
                        <div class="section-title">Request Body Fields</div>
                        <p style="margin-bottom: 8px; color: #7f8c8d;">
                            Detailed description of each field expected in the JSON request body, including whether it is required.
                        </p>
                        <table class="mapping-table">
                            <thead>
                                <tr>
                                    <th>Field</th>
                                    <th>Type</th>
                                    <th>Required</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // 2) Fallback: infer fields from example JSON body, if present
            if (!bodyExample) {
                return '';
            }

            let parsed;
            try {
                parsed = JSON.parse(bodyExample);
            } catch (e) {
                // If it is not valid JSON, skip detailed field view
                return '';
            }

            if (parsed === null || typeof parsed !== 'object') {
                return '';
            }

            const fields = [];
            Object.keys(parsed).forEach(key => {
                const value = parsed[key];
                let type = typeof value;
                if (Array.isArray(value)) {
                    type = 'array';
                } else if (value === null) {
                    type = 'null';
                }
                fields.push({ key, type });
            });

            if (!fields.length) {
                return '';
            }

            const items = fields.map(f => (
                `<li><span class="json-param">${f.key}</span> <span style="color: #7f8c8d;">(${f.type})</span></li>`
            )).join('');

            return `
                <div class="section">
                    <div class="section-title">Request Body Fields</div>
                    <p style="margin-bottom: 8px; color: #7f8c8d;">
                        Detected top-level JSON fields and their data types. Adjust as needed for your request.
                    </p>
                    <ul style="padding-left: 20px; color: #2c3e50;">
                        ${items}
                    </ul>
                </div>
            `;
        }

        function renderEndpoints(filteredEndpoints = null) {
            const endpointsToRender = filteredEndpoints || endpoints;
            const container = document.getElementById('endpoints-container');
            
            if (endpointsToRender.length === 0) {
                container.innerHTML = '<div style="padding: 20px; background: white; border-radius: 10px; text-align: center; color: #7f8c8d;">No endpoints found matching your search.</div>';
                return;
            }
            
            let html = '';
            endpointsToRender.forEach((endpoint, index) => {
                const methods = Array.isArray(endpoint.methods) ? endpoint.methods : [endpoint.method];
                const methodBadges = methods.map(m => `<span class="endpoint-method">${m}</span>`).join(' ');
                const httpMethod = (endpoint.method || methods[0] || 'GET').toUpperCase();
                const curlCode = generateCurlCode(endpoint);
                const escapedCurlCode = curlCode.replace(/</g, '&lt;').replace(/>/g, '&gt;');

                // Example request body for endpoints (from endpoints_data.json)
                const bodyExample = endpoint.request_body_example || '';
                const bodySource  = endpoint.request_body_source || '';
                const escapedBody = bodyExample
                    ? bodyExample
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                    : '';

                // Example query params (from endpoints_data.json)
                const queryExample = endpoint.query_params_example || '';
                const querySource  = endpoint.query_params_source || '';
                const escapedQuery = queryExample
                    ? queryExample
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                    : '';

                // Pre-fill URL with base + path + query example if present
                const prefilledUrl = `${BASE_URL}${endpoint.path}${queryExample || ''}`;
                
                html += `
                    <div class="endpoint-card">
                        <div class="endpoint-header" onclick="toggleEndpoint(${index})">
                            <h2>${endpoint.path}</h2>
                            <div>${methodBadges}</div>
                        </div>
                        <div class="endpoint-content" id="content-${index}">
                            <div class="section">
                                <div class="section-title">Service Information</div>
                                <p><strong>Handler:</strong> <code>${endpoint.handler}</code></p>
                                <p><strong>Service:</strong> <code>${endpoint.service}</code></p>
                                <p><strong>Category:</strong> <span style="background: #ecf0f1; padding: 5px 10px; border-radius: 5px;">${endpoint.category}</span></p>
                            </div>
                            
                            ${queryExample ? `
                            <div class="section">
                                <div class="section-title">Query Parameters</div>
                                <div class="code-snippet">
                                    <div class="code-header">
                                        <span>Example query string${querySource ? ' &mdash; ' + querySource : ''}</span>
                                        <button class="copy-btn" data-body="${encodeURIComponent(queryExample)}" onclick="copyToClipboard(decodeURIComponent(this.getAttribute('data-body')), this)">Copy Query</button>
                                    </div>
                                    <pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">${escapedQuery}</pre>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${renderQueryParamsDetails(endpoint)}
                            
                            ${bodyExample ? `
                            <div class="section">
                                <div class="section-title">Request Body Example</div>
                                <div class="code-snippet">
                                    <div class="code-header">
                                        <span>Example JSON${bodySource ? ' &mdash; ' + bodySource : ''}</span>
                                        <button class="copy-btn" data-body="${encodeURIComponent(bodyExample)}" onclick="copyToClipboard(decodeURIComponent(this.getAttribute('data-body')), this)">Copy Body</button>
                                    </div>
                                    <pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">${escapedBody}</pre>
                                </div>
                            </div>
                            ${renderBodyDetails(endpoint, bodyExample)}
                            ` : ''}

                            <div class="section">
                                <div class="section-title">Try this endpoint</div>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <div>
                                        <strong>Method:</strong> <code>${httpMethod}</code>
                                    </div>
                                    <div>
                                        <strong>URL:</strong>
                                        <input
                                            type="text"
                                            id="request-url-${index}"
                                            value="${prefilledUrl}"
                                            style="width: 100%; padding: 8px; margin-top: 5px;"
                                        />
                                    </div>
                                    ${httpMethod === 'GET' || httpMethod === 'HEAD' ? '' : `
                                    <div>
                                        <strong>Request Body (JSON):</strong>
                                        <textarea
                                            id="request-body-${index}"
                                            style="width: 100%; min-height: 120px; padding: 8px; margin-top: 5px;"
                                        >${bodyExample}</textarea>
                                    </div>
                                    `}
                                    <div>
                                        <button
                                            class="filter-btn"
                                            onclick="sendApiRequest(${index}, '${httpMethod}')"
                                        >
                                            Send Request
                                        </button>
                                    </div>
                                    <div>
                                        <strong>Response:</strong>
                                        <pre
                                            id="response-${index}"
                                            style="background: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 300px; overflow: auto; margin-top: 5px;"
                                        >(not sent yet)</pre>
                                    </div>
                                </div>
                            </div>
                            

                            
                            <div class="section">
                                <div class="section-title">Database Tables</div>
                                ${endpoint.tables.map(table => `
                                    <div class="table-card">
                                        <div class="table-name">${table.name}</div>
                                        <p><strong>Role:</strong> ${table.role}</p>
                                        ${table.columns && table.columns.length > 0 ? `
                                            <div style="margin-top: 15px;">
                                                <p style="font-weight: bold; margin-bottom: 10px; color: #2c3e50;">ðŸ“‹ Columns Used:</p>
                                                <div class="columns-list">
                                                    ${table.columns.map(col => `<div class="column-badge">${col}</div>`).join('')}
                                                </div>
                                            </div>
                                        ` : ''}
                                        ${table.mappings && table.mappings.length > 0 ? `
                                            <div style="margin-top: 15px;">
                                                <p style="font-weight: bold; margin-bottom: 10px; color: #2c3e50;">Column Mappings:</p>
                                                <table class="mapping-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Database Column</th>
                                                            <th>JSON Parameter</th>
                                                            <th>Notes</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${table.mappings.map(m => `
                                                            <tr>
                                                                <td><span class="db-column">${m.db}</span></td>
                                                                <td><span class="json-param">${m.json}</span></td>
                                                                <td>${m.note || '-'}</td>
                                                            </tr>
                                                        `).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            updateStats(endpointsToRender);
        }
        
        function toggleEndpoint(index) {
            const content = document.getElementById(`content-${index}`);
            const header = content.previousElementSibling;
            
            content.classList.toggle('active');
            header.classList.toggle('active');
        }

        async function sendApiRequest(index, method) {
            const urlInput = document.getElementById(`request-url-${index}`);
            const bodyInput = document.getElementById(`request-body-${index}`);
            const respPre = document.getElementById(`response-${index}`);

            if (!urlInput || !respPre) {
                return;
            }

            const url = urlInput.value.trim();
            const upperMethod = (method || 'GET').toUpperCase();

            const options = {
                method: upperMethod,
                headers: {}
            };

            if (upperMethod !== 'GET' && upperMethod !== 'HEAD') {
                options.headers['Content-Type'] = 'application/json';
                if (bodyInput) {
                    const raw = bodyInput.value.trim();
                    if (raw) {
                        try {
                            JSON.parse(raw); // validate JSON
                            options.body = raw;
                        } catch (e) {
                            respPre.textContent = 'Invalid JSON body: ' + e.message;
                            return;
                        }
                    }
                }
            }

            respPre.textContent = 'Sending request...';

            try {
                const res = await fetch(url, options);
                const text = await res.text();
                let pretty = text;
                try {
                    const json = JSON.parse(text);
                    pretty = JSON.stringify(json, null, 2);
                } catch (_) {
                    // response is not JSON; show raw text
                }
                respPre.textContent = `Status: ${res.status} ${res.statusText}\n\n${pretty}`;
            } catch (err) {
                respPre.textContent = 'Request failed: ' + err;
            }
        }
        
        function updateStats(filteredEndpoints) {
            const totalTables = new Set();
            filteredEndpoints.forEach(endpoint => {
                endpoint.tables.forEach(table => {
                    if (table.name !== 'Multiple/Unknown' && table.name && table.name.trim() !== '' && !table.name.endsWith('_')) {
                        totalTables.add(table.name);
                    }
                });
            });
            
            document.getElementById('total-endpoints').textContent = filteredEndpoints.length;
            document.getElementById('total-tables').textContent = totalTables.size;
            
            // Update categories count
            const catCount = {};
            filteredEndpoints.forEach(e => {
                catCount[e.category] = (catCount[e.category] || 0) + 1;
            });
            document.getElementById('total-categories').textContent = Object.keys(catCount).length;
        }
        
        function initializeApp() {
            // Build categories for filter buttons
            categories = {};
            endpoints.forEach(endpoint => {
                categories[endpoint.category] = (categories[endpoint.category] || 0) + 1;
            });
            
            const filterContainer = document.getElementById('filterButtons');
            const allBtn = filterContainer.querySelector('[data-filter="all"]');

            // Wrapper that will hold individual category buttons
            const categoryWrapper = document.createElement('div');
            categoryWrapper.id = 'category-buttons-wrapper';
            categoryWrapper.style.display = 'flex';
            categoryWrapper.style.flexWrap = 'wrap';
            categoryWrapper.style.gap = '10px';
            filterContainer.appendChild(categoryWrapper);

            // Create the "Show all categories" toggle button
            const showCatsBtn = document.createElement('button');
            showCatsBtn.className = 'filter-btn';
            showCatsBtn.id = 'show-all-categories-btn';
            showCatsBtn.textContent = 'Show all categories';
            filterContainer.appendChild(showCatsBtn);

            // Create one button per category; only first 10 visible initially
            const sortedCats = Object.keys(categories).sort();
            sortedCats.forEach((cat, idx) => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn category-filter-btn';
                btn.dataset.filter = cat;
                btn.textContent = `${cat.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())} (${categories[cat]})`;
                if (idx >= 10) {
                    btn.style.display = 'none';
                    btn.dataset.extra = 'true';
                }
                categoryWrapper.appendChild(btn);
            });
            
            function setActiveFilterButton(btn) {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                if (btn) {
                    btn.classList.add('active');
                }
            }

            // Search input listener
            document.getElementById('searchInput').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filtered = endpoints.filter(endpoint => {
                    return endpoint.path.toLowerCase().includes(searchTerm) ||
                           endpoint.handler.toLowerCase().includes(searchTerm) ||
                           endpoint.service.toLowerCase().includes(searchTerm) ||
                           endpoint.category.toLowerCase().includes(searchTerm) ||
                           endpoint.tables.some(table => table.name.toLowerCase().includes(searchTerm));
                });
                renderEndpoints(filtered);
            });

            // "All" button filters nothing (shows all endpoints)
            if (allBtn) {
                allBtn.addEventListener('click', () => {
                    setActiveFilterButton(allBtn);
                    renderEndpoints(endpoints);
                });
            }

            // Category buttons filter by category
            categoryWrapper.querySelectorAll('.category-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    setActiveFilterButton(btn);
                    const filter = btn.dataset.filter;
                    const filtered = endpoints.filter(e => e.category === filter);
                    renderEndpoints(filtered);
                });
            });

            // Toggle visibility of extra category buttons (beyond first 10)
            showCatsBtn.addEventListener('click', () => {
                const extras = categoryWrapper.querySelectorAll('.category-filter-btn[data-extra="true"]');
                let anyHidden = false;
                extras.forEach(btn => {
                    if (btn.style.display === 'none' || btn.style.display === '') {
                        anyHidden = true;
                    }
                });
                const show = anyHidden;
                extras.forEach(btn => {
                    btn.style.display = show ? 'inline-block' : 'none';
                });
                showCatsBtn.textContent = show ? 'Hide extra categories' : 'Show all categories';
            });
            
            // Initial render
            renderEndpoints();
        }
        
        window.toggleEndpoint = toggleEndpoint;
        window.copyToClipboard = copyToClipboard;
        window.sendApiRequest = sendApiRequest;
    </script>
</body>
</html>

